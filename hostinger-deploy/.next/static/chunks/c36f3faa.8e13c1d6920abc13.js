(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[415],{3901:function(F){F.exports=function(){"use strict";var F,el,eh;function define(ec,ep){if(F){if(el){var e_="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+F+")(sharedChunk); ("+el+")(sharedChunk); self.onerror = null;",eg={};F(eg),eh=ep(eg),"undefined"!=typeof window&&window&&window.URL&&window.URL.createObjectURL&&(eh.workerUrl=window.URL.createObjectURL(new Blob([e_],{type:"text/javascript"})))}else el=ep}else F=ep}return define(["exports"],function(F){let el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO,ek,eF,eB,eN,eV,eU,ej,eG,eq,e$,eH,eZ,eW,eY,eX,eK,eJ,eQ,e0,e1,e2;function e(F){return F&&F.__esModule&&Object.prototype.hasOwnProperty.call(F,"default")?F.default:F}var e3,e4,e5,e6,e8,e9,e7,tn={},th={};function s(){if(e7)return th;e7=1,Object.defineProperty(th,"__esModule",{value:!0}),th.setMatrixArrayType=function(F){th.ARRAY_TYPE=el=F},th.toRadian=function(F){return F*ec},th.equals=function(el,eh){return Math.abs(el-eh)<=F*Math.max(1,Math.abs(el),Math.abs(eh))},th.RANDOM=th.ARRAY_TYPE=th.EPSILON=void 0;var F=1e-6;th.EPSILON=F;var el="undefined"!=typeof Float32Array?Float32Array:Array;th.ARRAY_TYPE=el;var eh=Math.random;th.RANDOM=eh;var ec=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var F=0,el=arguments.length;el--;)F+=arguments[el]*arguments[el];return Math.sqrt(F)}),th}var tc,t_,tg,ty={},tv={},tb={};function d(){if(tg)return tb;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tg=1,Object.defineProperty(tb,"__esModule",{value:!0}),tb.create=function(){var el=new F.ARRAY_TYPE(9);return F.ARRAY_TYPE!=Float32Array&&(el[1]=0,el[2]=0,el[3]=0,el[5]=0,el[6]=0,el[7]=0),el[0]=1,el[4]=1,el[8]=1,el},tb.fromMat4=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[4],F[4]=el[5],F[5]=el[6],F[6]=el[8],F[7]=el[9],F[8]=el[10],F},tb.clone=function(el){var eh=new F.ARRAY_TYPE(9);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh[3]=el[3],eh[4]=el[4],eh[5]=el[5],eh[6]=el[6],eh[7]=el[7],eh[8]=el[8],eh},tb.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F[4]=el[4],F[5]=el[5],F[6]=el[6],F[7]=el[7],F[8]=el[8],F},tb.fromValues=function(el,eh,ec,ep,e_,eg,ey,eb,ew){var eT=new F.ARRAY_TYPE(9);return eT[0]=el,eT[1]=eh,eT[2]=ec,eT[3]=ep,eT[4]=e_,eT[5]=eg,eT[6]=ey,eT[7]=eb,eT[8]=ew,eT},tb.set=function(F,el,eh,ec,ep,e_,eg,ey,eb,ew){return F[0]=el,F[1]=eh,F[2]=ec,F[3]=ep,F[4]=e_,F[5]=eg,F[6]=ey,F[7]=eb,F[8]=ew,F},tb.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},tb.transpose=function(F,el){if(F===el){var eh=el[1],ec=el[2],ep=el[5];F[1]=el[3],F[2]=el[6],F[3]=eh,F[5]=el[7],F[6]=ec,F[7]=ep}else F[0]=el[0],F[1]=el[3],F[2]=el[6],F[3]=el[1],F[4]=el[4],F[5]=el[7],F[6]=el[2],F[7]=el[5],F[8]=el[8];return F},tb.invert=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=el[6],ew=el[7],eT=el[8],eS=eT*eg-ey*ew,eE=-eT*e_+ey*eb,eM=ew*e_-eg*eb,eI=eh*eS+ec*eE+ep*eM;return eI?(F[0]=eS*(eI=1/eI),F[1]=(-eT*ec+ep*ew)*eI,F[2]=(ey*ec-ep*eg)*eI,F[3]=eE*eI,F[4]=(eT*eh-ep*eb)*eI,F[5]=(-ey*eh+ep*e_)*eI,F[6]=eM*eI,F[7]=(-ew*eh+ec*eb)*eI,F[8]=(eg*eh-ec*e_)*eI,F):null},tb.adjoint=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=el[6],ew=el[7],eT=el[8];return F[0]=eg*eT-ey*ew,F[1]=ep*ew-ec*eT,F[2]=ec*ey-ep*eg,F[3]=ey*eb-e_*eT,F[4]=eh*eT-ep*eb,F[5]=ep*e_-eh*ey,F[6]=e_*ew-eg*eb,F[7]=ec*eb-eh*ew,F[8]=eh*eg-ec*e_,F},tb.determinant=function(F){var el=F[3],eh=F[4],ec=F[5],ep=F[6],e_=F[7],eg=F[8];return F[0]*(eg*eh-ec*e_)+F[1]*(-eg*el+ec*ep)+F[2]*(e_*el-eh*ep)},tb.multiply=n,tb.translate=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=eh[0],eM=eh[1];return F[0]=ec,F[1]=ep,F[2]=e_,F[3]=eg,F[4]=ey,F[5]=eb,F[6]=eE*ec+eM*eg+ew,F[7]=eE*ep+eM*ey+eT,F[8]=eE*e_+eM*eb+eS,F},tb.rotate=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=Math.sin(eh),eM=Math.cos(eh);return F[0]=eM*ec+eE*eg,F[1]=eM*ep+eE*ey,F[2]=eM*e_+eE*eb,F[3]=eM*eg-eE*ec,F[4]=eM*ey-eE*ep,F[5]=eM*eb-eE*e_,F[6]=ew,F[7]=eT,F[8]=eS,F},tb.scale=function(F,el,eh){var ec=eh[0],ep=eh[1];return F[0]=ec*el[0],F[1]=ec*el[1],F[2]=ec*el[2],F[3]=ep*el[3],F[4]=ep*el[4],F[5]=ep*el[5],F[6]=el[6],F[7]=el[7],F[8]=el[8],F},tb.fromTranslation=function(F,el){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=1,F[5]=0,F[6]=el[0],F[7]=el[1],F[8]=1,F},tb.fromRotation=function(F,el){var eh=Math.sin(el),ec=Math.cos(el);return F[0]=ec,F[1]=eh,F[2]=0,F[3]=-eh,F[4]=ec,F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},tb.fromScaling=function(F,el){return F[0]=el[0],F[1]=0,F[2]=0,F[3]=0,F[4]=el[1],F[5]=0,F[6]=0,F[7]=0,F[8]=1,F},tb.fromMat2d=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=0,F[3]=el[2],F[4]=el[3],F[5]=0,F[6]=el[4],F[7]=el[5],F[8]=1,F},tb.fromQuat=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=eh+eh,ey=ec+ec,eb=ep+ep,ew=eh*eg,eT=ec*eg,eS=ec*ey,eE=ep*eg,eM=ep*ey,eI=ep*eb,eA=e_*eg,eC=e_*ey,eP=e_*eb;return F[0]=1-eS-eI,F[3]=eT-eP,F[6]=eE+eC,F[1]=eT+eP,F[4]=1-ew-eI,F[7]=eM-eA,F[2]=eE-eC,F[5]=eM+eA,F[8]=1-ew-eS,F},tb.normalFromMat4=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=el[6],ew=el[7],eT=el[8],eS=el[9],eE=el[10],eM=el[11],eI=el[12],eA=el[13],eC=el[14],eP=el[15],ez=eh*ey-ec*eg,eD=eh*eb-ep*eg,eR=eh*ew-e_*eg,eL=ec*eb-ep*ey,eO=ec*ew-e_*ey,ek=ep*ew-e_*eb,eF=eT*eA-eS*eI,eB=eT*eC-eE*eI,eN=eT*eP-eM*eI,eV=eS*eC-eE*eA,eU=eS*eP-eM*eA,ej=eE*eP-eM*eC,eG=ez*ej-eD*eU+eR*eV+eL*eN-eO*eB+ek*eF;return eG?(F[0]=(ey*ej-eb*eU+ew*eV)*(eG=1/eG),F[1]=(eb*eN-eg*ej-ew*eB)*eG,F[2]=(eg*eU-ey*eN+ew*eF)*eG,F[3]=(ep*eU-ec*ej-e_*eV)*eG,F[4]=(eh*ej-ep*eN+e_*eB)*eG,F[5]=(ec*eN-eh*eU-e_*eF)*eG,F[6]=(eA*ek-eC*eO+eP*eL)*eG,F[7]=(eC*eR-eI*ek-eP*eD)*eG,F[8]=(eI*eO-eA*eR+eP*ez)*eG,F):null},tb.projection=function(F,el,eh){return F[0]=2/el,F[1]=0,F[2]=0,F[3]=0,F[4]=-2/eh,F[5]=0,F[6]=-1,F[7]=1,F[8]=1,F},tb.str=function(F){return"mat3("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+")"},tb.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8])},tb.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F[3]=el[3]+eh[3],F[4]=el[4]+eh[4],F[5]=el[5]+eh[5],F[6]=el[6]+eh[6],F[7]=el[7]+eh[7],F[8]=el[8]+eh[8],F},tb.subtract=i,tb.multiplyScalar=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F[3]=el[3]*eh,F[4]=el[4]*eh,F[5]=el[5]*eh,F[6]=el[6]*eh,F[7]=el[7]*eh,F[8]=el[8]*eh,F},tb.multiplyScalarAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F[2]=el[2]+eh[2]*ec,F[3]=el[3]+eh[3]*ec,F[4]=el[4]+eh[4]*ec,F[5]=el[5]+eh[5]*ec,F[6]=el[6]+eh[6]*ec,F[7]=el[7]+eh[7]*ec,F[8]=el[8]+eh[8]*ec,F},tb.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]&&F[3]===el[3]&&F[4]===el[4]&&F[5]===el[5]&&F[6]===el[6]&&F[7]===el[7]&&F[8]===el[8]},tb.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=eh[0],eM=eh[1],eI=eh[2],eA=eh[3],eC=eh[4],eP=eh[5],ez=eh[6],eD=eh[7],eR=eh[8];return Math.abs(ec-eE)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eE))&&Math.abs(ep-eM)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eM))&&Math.abs(e_-eI)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eI))&&Math.abs(eg-eA)<=F.EPSILON*Math.max(1,Math.abs(eg),Math.abs(eA))&&Math.abs(ey-eC)<=F.EPSILON*Math.max(1,Math.abs(ey),Math.abs(eC))&&Math.abs(eb-eP)<=F.EPSILON*Math.max(1,Math.abs(eb),Math.abs(eP))&&Math.abs(ew-ez)<=F.EPSILON*Math.max(1,Math.abs(ew),Math.abs(ez))&&Math.abs(eT-eD)<=F.EPSILON*Math.max(1,Math.abs(eT),Math.abs(eD))&&Math.abs(eS-eR)<=F.EPSILON*Math.max(1,Math.abs(eS),Math.abs(eR))},tb.sub=tb.mul=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=eh[0],eM=eh[1],eI=eh[2],eA=eh[3],eC=eh[4],eP=eh[5],ez=eh[6],eD=eh[7],eR=eh[8];return F[0]=eE*ec+eM*eg+eI*ew,F[1]=eE*ep+eM*ey+eI*eT,F[2]=eE*e_+eM*eb+eI*eS,F[3]=eA*ec+eC*eg+eP*ew,F[4]=eA*ep+eC*ey+eP*eT,F[5]=eA*e_+eC*eb+eP*eS,F[6]=ez*ec+eD*eg+eR*ew,F[7]=ez*ep+eD*ey+eR*eT,F[8]=ez*e_+eD*eb+eR*eS,F}function i(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F[2]=el[2]-eh[2],F[3]=el[3]-eh[3],F[4]=el[4]-eh[4],F[5]=el[5]-eh[5],F[6]=el[6]-eh[6],F[7]=el[7]-eh[7],F[8]=el[8]-eh[8],F}return tb.mul=n,tb.sub=i,tb}var tw,tT={};function g(){if(tw)return tT;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tw=1,Object.defineProperty(tT,"__esModule",{value:!0}),tT.create=function(){var el=new F.ARRAY_TYPE(16);return F.ARRAY_TYPE!=Float32Array&&(el[1]=0,el[2]=0,el[3]=0,el[4]=0,el[6]=0,el[7]=0,el[8]=0,el[9]=0,el[11]=0,el[12]=0,el[13]=0,el[14]=0),el[0]=1,el[5]=1,el[10]=1,el[15]=1,el},tT.clone=function(el){var eh=new F.ARRAY_TYPE(16);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh[3]=el[3],eh[4]=el[4],eh[5]=el[5],eh[6]=el[6],eh[7]=el[7],eh[8]=el[8],eh[9]=el[9],eh[10]=el[10],eh[11]=el[11],eh[12]=el[12],eh[13]=el[13],eh[14]=el[14],eh[15]=el[15],eh},tT.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F[4]=el[4],F[5]=el[5],F[6]=el[6],F[7]=el[7],F[8]=el[8],F[9]=el[9],F[10]=el[10],F[11]=el[11],F[12]=el[12],F[13]=el[13],F[14]=el[14],F[15]=el[15],F},tT.fromValues=function(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC){var eP=new F.ARRAY_TYPE(16);return eP[0]=el,eP[1]=eh,eP[2]=ec,eP[3]=ep,eP[4]=e_,eP[5]=eg,eP[6]=ey,eP[7]=eb,eP[8]=ew,eP[9]=eT,eP[10]=eS,eP[11]=eE,eP[12]=eM,eP[13]=eI,eP[14]=eA,eP[15]=eC,eP},tT.set=function(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC){return F[0]=el,F[1]=eh,F[2]=ec,F[3]=ep,F[4]=e_,F[5]=eg,F[6]=ey,F[7]=eb,F[8]=ew,F[9]=eT,F[10]=eS,F[11]=eE,F[12]=eM,F[13]=eI,F[14]=eA,F[15]=eC,F},tT.identity=n,tT.transpose=function(F,el){if(F===el){var eh=el[1],ec=el[2],ep=el[3],e_=el[6],eg=el[7],ey=el[11];F[1]=el[4],F[2]=el[8],F[3]=el[12],F[4]=eh,F[6]=el[9],F[7]=el[13],F[8]=ec,F[9]=e_,F[11]=el[14],F[12]=ep,F[13]=eg,F[14]=ey}else F[0]=el[0],F[1]=el[4],F[2]=el[8],F[3]=el[12],F[4]=el[1],F[5]=el[5],F[6]=el[9],F[7]=el[13],F[8]=el[2],F[9]=el[6],F[10]=el[10],F[11]=el[14],F[12]=el[3],F[13]=el[7],F[14]=el[11],F[15]=el[15];return F},tT.invert=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=el[6],ew=el[7],eT=el[8],eS=el[9],eE=el[10],eM=el[11],eI=el[12],eA=el[13],eC=el[14],eP=el[15],ez=eh*ey-ec*eg,eD=eh*eb-ep*eg,eR=eh*ew-e_*eg,eL=ec*eb-ep*ey,eO=ec*ew-e_*ey,ek=ep*ew-e_*eb,eF=eT*eA-eS*eI,eB=eT*eC-eE*eI,eN=eT*eP-eM*eI,eV=eS*eC-eE*eA,eU=eS*eP-eM*eA,ej=eE*eP-eM*eC,eG=ez*ej-eD*eU+eR*eV+eL*eN-eO*eB+ek*eF;return eG?(F[0]=(ey*ej-eb*eU+ew*eV)*(eG=1/eG),F[1]=(ep*eU-ec*ej-e_*eV)*eG,F[2]=(eA*ek-eC*eO+eP*eL)*eG,F[3]=(eE*eO-eS*ek-eM*eL)*eG,F[4]=(eb*eN-eg*ej-ew*eB)*eG,F[5]=(eh*ej-ep*eN+e_*eB)*eG,F[6]=(eC*eR-eI*ek-eP*eD)*eG,F[7]=(eT*ek-eE*eR+eM*eD)*eG,F[8]=(eg*eU-ey*eN+ew*eF)*eG,F[9]=(ec*eN-eh*eU-e_*eF)*eG,F[10]=(eI*eO-eA*eR+eP*ez)*eG,F[11]=(eS*eR-eT*eO-eM*ez)*eG,F[12]=(ey*eB-eg*eV-eb*eF)*eG,F[13]=(eh*eV-ec*eB+ep*eF)*eG,F[14]=(eA*eD-eI*eL-eC*ez)*eG,F[15]=(eT*eL-eS*eD+eE*ez)*eG,F):null},tT.adjoint=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=el[6],ew=el[7],eT=el[8],eS=el[9],eE=el[10],eM=el[11],eI=el[12],eA=el[13],eC=el[14],eP=el[15];return F[0]=ey*(eE*eP-eM*eC)-eS*(eb*eP-ew*eC)+eA*(eb*eM-ew*eE),F[1]=-(ec*(eE*eP-eM*eC)-eS*(ep*eP-e_*eC)+eA*(ep*eM-e_*eE)),F[2]=ec*(eb*eP-ew*eC)-ey*(ep*eP-e_*eC)+eA*(ep*ew-e_*eb),F[3]=-(ec*(eb*eM-ew*eE)-ey*(ep*eM-e_*eE)+eS*(ep*ew-e_*eb)),F[4]=-(eg*(eE*eP-eM*eC)-eT*(eb*eP-ew*eC)+eI*(eb*eM-ew*eE)),F[5]=eh*(eE*eP-eM*eC)-eT*(ep*eP-e_*eC)+eI*(ep*eM-e_*eE),F[6]=-(eh*(eb*eP-ew*eC)-eg*(ep*eP-e_*eC)+eI*(ep*ew-e_*eb)),F[7]=eh*(eb*eM-ew*eE)-eg*(ep*eM-e_*eE)+eT*(ep*ew-e_*eb),F[8]=eg*(eS*eP-eM*eA)-eT*(ey*eP-ew*eA)+eI*(ey*eM-ew*eS),F[9]=-(eh*(eS*eP-eM*eA)-eT*(ec*eP-e_*eA)+eI*(ec*eM-e_*eS)),F[10]=eh*(ey*eP-ew*eA)-eg*(ec*eP-e_*eA)+eI*(ec*ew-e_*ey),F[11]=-(eh*(ey*eM-ew*eS)-eg*(ec*eM-e_*eS)+eT*(ec*ew-e_*ey)),F[12]=-(eg*(eS*eC-eE*eA)-eT*(ey*eC-eb*eA)+eI*(ey*eE-eb*eS)),F[13]=eh*(eS*eC-eE*eA)-eT*(ec*eC-ep*eA)+eI*(ec*eE-ep*eS),F[14]=-(eh*(ey*eC-eb*eA)-eg*(ec*eC-ep*eA)+eI*(ec*eb-ep*ey)),F[15]=eh*(ey*eE-eb*eS)-eg*(ec*eE-ep*eS)+eT*(ec*eb-ep*ey),F},tT.determinant=function(F){var el=F[0],eh=F[1],ec=F[2],ep=F[3],e_=F[4],eg=F[5],ey=F[6],eb=F[7],ew=F[8],eT=F[9],eS=F[10],eE=F[11],eM=F[12],eI=F[13],eA=F[14],eC=F[15];return(el*eg-eh*e_)*(eS*eC-eE*eA)-(el*ey-ec*e_)*(eT*eC-eE*eI)+(el*eb-ep*e_)*(eT*eA-eS*eI)+(eh*ey-ec*eg)*(ew*eC-eE*eM)-(eh*eb-ep*eg)*(ew*eA-eS*eM)+(ec*eb-ep*ey)*(ew*eI-eT*eM)},tT.multiply=i,tT.translate=function(F,el,eh){var ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA=eh[0],eC=eh[1],eP=eh[2];return el===F?(F[12]=el[0]*eA+el[4]*eC+el[8]*eP+el[12],F[13]=el[1]*eA+el[5]*eC+el[9]*eP+el[13],F[14]=el[2]*eA+el[6]*eC+el[10]*eP+el[14],F[15]=el[3]*eA+el[7]*eC+el[11]*eP+el[15]):(ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=el[9],eM=el[10],eI=el[11],F[0]=ec=el[0],F[1]=ep,F[2]=e_,F[3]=eg,F[4]=ey,F[5]=eb,F[6]=ew,F[7]=eT,F[8]=eS,F[9]=eE,F[10]=eM,F[11]=eI,F[12]=ec*eA+ey*eC+eS*eP+el[12],F[13]=ep*eA+eb*eC+eE*eP+el[13],F[14]=e_*eA+ew*eC+eM*eP+el[14],F[15]=eg*eA+eT*eC+eI*eP+el[15]),F},tT.scale=function(F,el,eh){var ec=eh[0],ep=eh[1],e_=eh[2];return F[0]=el[0]*ec,F[1]=el[1]*ec,F[2]=el[2]*ec,F[3]=el[3]*ec,F[4]=el[4]*ep,F[5]=el[5]*ep,F[6]=el[6]*ep,F[7]=el[7]*ep,F[8]=el[8]*e_,F[9]=el[9]*e_,F[10]=el[10]*e_,F[11]=el[11]*e_,F[12]=el[12],F[13]=el[13],F[14]=el[14],F[15]=el[15],F},tT.rotate=function(el,eh,ec,ep){var e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO,ek,eF,eB,eN,eV,eU,ej=ep[0],eG=ep[1],eq=ep[2],e$=Math.hypot(ej,eG,eq);return e$<F.EPSILON?null:(ej*=e$=1/e$,eG*=e$,eq*=e$,e_=Math.sin(ec),eg=Math.cos(ec),ew=eh[1],eT=eh[2],eS=eh[3],eM=eh[5],eI=eh[6],eA=eh[7],eP=eh[9],ez=eh[10],eD=eh[11],eR=ej*ej*(ey=1-eg)+eg,ek=ej*eG*ey-eq*e_,eF=eG*eG*ey+eg,eB=eq*eG*ey+ej*e_,eN=ej*eq*ey+eG*e_,eV=eG*eq*ey-ej*e_,eU=eq*eq*ey+eg,el[0]=(eb=eh[0])*eR+(eE=eh[4])*(eL=eG*ej*ey+eq*e_)+(eC=eh[8])*(eO=eq*ej*ey-eG*e_),el[1]=ew*eR+eM*eL+eP*eO,el[2]=eT*eR+eI*eL+ez*eO,el[3]=eS*eR+eA*eL+eD*eO,el[4]=eb*ek+eE*eF+eC*eB,el[5]=ew*ek+eM*eF+eP*eB,el[6]=eT*ek+eI*eF+ez*eB,el[7]=eS*ek+eA*eF+eD*eB,el[8]=eb*eN+eE*eV+eC*eU,el[9]=ew*eN+eM*eV+eP*eU,el[10]=eT*eN+eI*eV+ez*eU,el[11]=eS*eN+eA*eV+eD*eU,eh!==el&&(el[12]=eh[12],el[13]=eh[13],el[14]=eh[14],el[15]=eh[15]),el)},tT.rotateX=function(F,el,eh){var ec=Math.sin(eh),ep=Math.cos(eh),e_=el[4],eg=el[5],ey=el[6],eb=el[7],ew=el[8],eT=el[9],eS=el[10],eE=el[11];return el!==F&&(F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F[12]=el[12],F[13]=el[13],F[14]=el[14],F[15]=el[15]),F[4]=e_*ep+ew*ec,F[5]=eg*ep+eT*ec,F[6]=ey*ep+eS*ec,F[7]=eb*ep+eE*ec,F[8]=ew*ep-e_*ec,F[9]=eT*ep-eg*ec,F[10]=eS*ep-ey*ec,F[11]=eE*ep-eb*ec,F},tT.rotateY=function(F,el,eh){var ec=Math.sin(eh),ep=Math.cos(eh),e_=el[0],eg=el[1],ey=el[2],eb=el[3],ew=el[8],eT=el[9],eS=el[10],eE=el[11];return el!==F&&(F[4]=el[4],F[5]=el[5],F[6]=el[6],F[7]=el[7],F[12]=el[12],F[13]=el[13],F[14]=el[14],F[15]=el[15]),F[0]=e_*ep-ew*ec,F[1]=eg*ep-eT*ec,F[2]=ey*ep-eS*ec,F[3]=eb*ep-eE*ec,F[8]=e_*ec+ew*ep,F[9]=eg*ec+eT*ep,F[10]=ey*ec+eS*ep,F[11]=eb*ec+eE*ep,F},tT.rotateZ=function(F,el,eh){var ec=Math.sin(eh),ep=Math.cos(eh),e_=el[0],eg=el[1],ey=el[2],eb=el[3],ew=el[4],eT=el[5],eS=el[6],eE=el[7];return el!==F&&(F[8]=el[8],F[9]=el[9],F[10]=el[10],F[11]=el[11],F[12]=el[12],F[13]=el[13],F[14]=el[14],F[15]=el[15]),F[0]=e_*ep+ew*ec,F[1]=eg*ep+eT*ec,F[2]=ey*ep+eS*ec,F[3]=eb*ep+eE*ec,F[4]=ew*ep-e_*ec,F[5]=eT*ep-eg*ec,F[6]=eS*ep-ey*ec,F[7]=eE*ep-eb*ec,F},tT.fromTranslation=function(F,el){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=el[0],F[13]=el[1],F[14]=el[2],F[15]=1,F},tT.fromScaling=function(F,el){return F[0]=el[0],F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=el[1],F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=el[2],F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},tT.fromRotation=function(el,eh,ec){var ep,e_,eg,ey=ec[0],eb=ec[1],ew=ec[2],eT=Math.hypot(ey,eb,ew);return eT<F.EPSILON?null:(ey*=eT=1/eT,eb*=eT,ew*=eT,ep=Math.sin(eh),e_=Math.cos(eh),el[0]=ey*ey*(eg=1-e_)+e_,el[1]=eb*ey*eg+ew*ep,el[2]=ew*ey*eg-eb*ep,el[3]=0,el[4]=ey*eb*eg-ew*ep,el[5]=eb*eb*eg+e_,el[6]=ew*eb*eg+ey*ep,el[7]=0,el[8]=ey*ew*eg+eb*ep,el[9]=eb*ew*eg-ey*ep,el[10]=ew*ew*eg+e_,el[11]=0,el[12]=0,el[13]=0,el[14]=0,el[15]=1,el)},tT.fromXRotation=function(F,el){var eh=Math.sin(el),ec=Math.cos(el);return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=ec,F[6]=eh,F[7]=0,F[8]=0,F[9]=-eh,F[10]=ec,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},tT.fromYRotation=function(F,el){var eh=Math.sin(el),ec=Math.cos(el);return F[0]=ec,F[1]=0,F[2]=-eh,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=eh,F[9]=0,F[10]=ec,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},tT.fromZRotation=function(F,el){var eh=Math.sin(el),ec=Math.cos(el);return F[0]=ec,F[1]=eh,F[2]=0,F[3]=0,F[4]=-eh,F[5]=ec,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},tT.fromRotationTranslation=a,tT.fromQuat2=function(el,eh){var ec=new F.ARRAY_TYPE(3),ep=-eh[0],e_=-eh[1],eg=-eh[2],ey=eh[3],eb=eh[4],ew=eh[5],eT=eh[6],eS=eh[7],eE=ep*ep+e_*e_+eg*eg+ey*ey;return eE>0?(ec[0]=2*(eb*ey+eS*ep+ew*eg-eT*e_)/eE,ec[1]=2*(ew*ey+eS*e_+eT*ep-eb*eg)/eE,ec[2]=2*(eT*ey+eS*eg+eb*e_-ew*ep)/eE):(ec[0]=2*(eb*ey+eS*ep+ew*eg-eT*e_),ec[1]=2*(ew*ey+eS*e_+eT*ep-eb*eg),ec[2]=2*(eT*ey+eS*eg+eb*e_-ew*ep)),a(el,eh,ec),el},tT.getTranslation=function(F,el){return F[0]=el[12],F[1]=el[13],F[2]=el[14],F},tT.getScaling=o,tT.getRotation=function(el,eh){var ec=new F.ARRAY_TYPE(3);o(ec,eh);var ep=1/ec[0],e_=1/ec[1],eg=1/ec[2],ey=eh[0]*ep,eb=eh[1]*e_,ew=eh[2]*eg,eT=eh[4]*ep,eS=eh[5]*e_,eE=eh[6]*eg,eM=eh[8]*ep,eI=eh[9]*e_,eA=eh[10]*eg,eC=ey+eS+eA,eP=0;return eC>0?(eP=2*Math.sqrt(eC+1),el[3]=.25*eP,el[0]=(eE-eI)/eP,el[1]=(eM-ew)/eP,el[2]=(eb-eT)/eP):ey>eS&&ey>eA?(eP=2*Math.sqrt(1+ey-eS-eA),el[3]=(eE-eI)/eP,el[0]=.25*eP,el[1]=(eb+eT)/eP,el[2]=(eM+ew)/eP):eS>eA?(eP=2*Math.sqrt(1+eS-ey-eA),el[3]=(eM-ew)/eP,el[0]=(eb+eT)/eP,el[1]=.25*eP,el[2]=(eE+eI)/eP):(eP=2*Math.sqrt(1+eA-ey-eS),el[3]=(eb-eT)/eP,el[0]=(eM+ew)/eP,el[1]=(eE+eI)/eP,el[2]=.25*eP),el},tT.fromRotationTranslationScale=function(F,el,eh,ec){var ep=el[0],e_=el[1],eg=el[2],ey=el[3],eb=ep+ep,ew=e_+e_,eT=eg+eg,eS=ep*eb,eE=ep*ew,eM=ep*eT,eI=e_*ew,eA=e_*eT,eC=eg*eT,eP=ey*eb,ez=ey*ew,eD=ey*eT,eR=ec[0],eL=ec[1],eO=ec[2];return F[0]=(1-(eI+eC))*eR,F[1]=(eE+eD)*eR,F[2]=(eM-ez)*eR,F[3]=0,F[4]=(eE-eD)*eL,F[5]=(1-(eS+eC))*eL,F[6]=(eA+eP)*eL,F[7]=0,F[8]=(eM+ez)*eO,F[9]=(eA-eP)*eO,F[10]=(1-(eS+eI))*eO,F[11]=0,F[12]=eh[0],F[13]=eh[1],F[14]=eh[2],F[15]=1,F},tT.fromRotationTranslationScaleOrigin=function(F,el,eh,ec,ep){var e_=el[0],eg=el[1],ey=el[2],eb=el[3],ew=e_+e_,eT=eg+eg,eS=ey+ey,eE=e_*ew,eM=e_*eT,eI=e_*eS,eA=eg*eT,eC=eg*eS,eP=ey*eS,ez=eb*ew,eD=eb*eT,eR=eb*eS,eL=ec[0],eO=ec[1],ek=ec[2],eF=ep[0],eB=ep[1],eN=ep[2],eV=(1-(eA+eP))*eL,eU=(eM+eR)*eL,ej=(eI-eD)*eL,eG=(eM-eR)*eO,eq=(1-(eE+eP))*eO,e$=(eC+ez)*eO,eH=(eI+eD)*ek,eZ=(eC-ez)*ek,eW=(1-(eE+eA))*ek;return F[0]=eV,F[1]=eU,F[2]=ej,F[3]=0,F[4]=eG,F[5]=eq,F[6]=e$,F[7]=0,F[8]=eH,F[9]=eZ,F[10]=eW,F[11]=0,F[12]=eh[0]+eF-(eV*eF+eG*eB+eH*eN),F[13]=eh[1]+eB-(eU*eF+eq*eB+eZ*eN),F[14]=eh[2]+eN-(ej*eF+e$*eB+eW*eN),F[15]=1,F},tT.fromQuat=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=eh+eh,ey=ec+ec,eb=ep+ep,ew=eh*eg,eT=ec*eg,eS=ec*ey,eE=ep*eg,eM=ep*ey,eI=ep*eb,eA=e_*eg,eC=e_*ey,eP=e_*eb;return F[0]=1-eS-eI,F[1]=eT+eP,F[2]=eE-eC,F[3]=0,F[4]=eT-eP,F[5]=1-ew-eI,F[6]=eM+eA,F[7]=0,F[8]=eE+eC,F[9]=eM-eA,F[10]=1-ew-eS,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F},tT.frustum=function(F,el,eh,ec,ep,e_,eg){var ey=1/(eh-el),eb=1/(ep-ec),ew=1/(e_-eg);return F[0]=2*e_*ey,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=2*e_*eb,F[6]=0,F[7]=0,F[8]=(eh+el)*ey,F[9]=(ep+ec)*eb,F[10]=(eg+e_)*ew,F[11]=-1,F[12]=0,F[13]=0,F[14]=eg*e_*2*ew,F[15]=0,F},tT.perspectiveNO=l,tT.perspectiveZO=function(F,el,eh,ec,ep){var e_,eg=1/Math.tan(el/2);return F[0]=eg/eh,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=eg,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=ep&&ep!==1/0?(F[10]=ep*(e_=1/(ec-ep)),F[14]=ep*ec*e_):(F[10]=-1,F[14]=-ec),F},tT.perspectiveFromFieldOfView=function(F,el,eh,ec){var ep=Math.tan(el.upDegrees*Math.PI/180),e_=Math.tan(el.downDegrees*Math.PI/180),eg=Math.tan(el.leftDegrees*Math.PI/180),ey=Math.tan(el.rightDegrees*Math.PI/180),eb=2/(eg+ey),ew=2/(ep+e_);return F[0]=eb,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=ew,F[6]=0,F[7]=0,F[8]=-(eg-ey)*eb*.5,F[9]=(ep-e_)*ew*.5,F[10]=ec/(eh-ec),F[11]=-1,F[12]=0,F[13]=0,F[14]=ec*eh/(eh-ec),F[15]=0,F},tT.orthoNO=u,tT.orthoZO=function(F,el,eh,ec,ep,e_,eg){var ey=1/(el-eh),eb=1/(ec-ep),ew=1/(e_-eg);return F[0]=-2*ey,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*eb,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=ew,F[11]=0,F[12]=(el+eh)*ey,F[13]=(ep+ec)*eb,F[14]=e_*ew,F[15]=1,F},tT.lookAt=function(el,eh,ec,ep){var e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA=eh[0],eC=eh[1],eP=eh[2],ez=ep[0],eD=ep[1],eR=ep[2],eL=ec[0],eO=ec[1],ek=ec[2];return Math.abs(eA-eL)<F.EPSILON&&Math.abs(eC-eO)<F.EPSILON&&Math.abs(eP-ek)<F.EPSILON?n(el):(eS=eA-eL,eE=eC-eO,eM=eP-ek,(eI=Math.hypot(e_=eD*(eM*=eI=1/Math.hypot(eS,eE,eM))-eR*(eE*=eI),eg=eR*(eS*=eI)-ez*eM,ey=ez*eE-eD*eS))?(e_*=eI=1/eI,eg*=eI,ey*=eI):(e_=0,eg=0,ey=0),(eI=Math.hypot(eb=eE*ey-eM*eg,ew=eM*e_-eS*ey,eT=eS*eg-eE*e_))?(eb*=eI=1/eI,ew*=eI,eT*=eI):(eb=0,ew=0,eT=0),el[0]=e_,el[1]=eb,el[2]=eS,el[3]=0,el[4]=eg,el[5]=ew,el[6]=eE,el[7]=0,el[8]=ey,el[9]=eT,el[10]=eM,el[11]=0,el[12]=-(e_*eA+eg*eC+ey*eP),el[13]=-(eb*eA+ew*eC+eT*eP),el[14]=-(eS*eA+eE*eC+eM*eP),el[15]=1,el)},tT.targetTo=function(F,el,eh,ec){var ep=el[0],e_=el[1],eg=el[2],ey=ec[0],eb=ec[1],ew=ec[2],eT=ep-eh[0],eS=e_-eh[1],eE=eg-eh[2],eM=eT*eT+eS*eS+eE*eE;eM>0&&(eT*=eM=1/Math.sqrt(eM),eS*=eM,eE*=eM);var eI=eb*eE-ew*eS,eA=ew*eT-ey*eE,eC=ey*eS-eb*eT;return(eM=eI*eI+eA*eA+eC*eC)>0&&(eI*=eM=1/Math.sqrt(eM),eA*=eM,eC*=eM),F[0]=eI,F[1]=eA,F[2]=eC,F[3]=0,F[4]=eS*eC-eE*eA,F[5]=eE*eI-eT*eC,F[6]=eT*eA-eS*eI,F[7]=0,F[8]=eT,F[9]=eS,F[10]=eE,F[11]=0,F[12]=ep,F[13]=e_,F[14]=eg,F[15]=1,F},tT.str=function(F){return"mat4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+", "+F[8]+", "+F[9]+", "+F[10]+", "+F[11]+", "+F[12]+", "+F[13]+", "+F[14]+", "+F[15]+")"},tT.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],F[6],F[7],F[8],F[9],F[10],F[11],F[12],F[13],F[14],F[15])},tT.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F[3]=el[3]+eh[3],F[4]=el[4]+eh[4],F[5]=el[5]+eh[5],F[6]=el[6]+eh[6],F[7]=el[7]+eh[7],F[8]=el[8]+eh[8],F[9]=el[9]+eh[9],F[10]=el[10]+eh[10],F[11]=el[11]+eh[11],F[12]=el[12]+eh[12],F[13]=el[13]+eh[13],F[14]=el[14]+eh[14],F[15]=el[15]+eh[15],F},tT.subtract=c,tT.multiplyScalar=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F[3]=el[3]*eh,F[4]=el[4]*eh,F[5]=el[5]*eh,F[6]=el[6]*eh,F[7]=el[7]*eh,F[8]=el[8]*eh,F[9]=el[9]*eh,F[10]=el[10]*eh,F[11]=el[11]*eh,F[12]=el[12]*eh,F[13]=el[13]*eh,F[14]=el[14]*eh,F[15]=el[15]*eh,F},tT.multiplyScalarAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F[2]=el[2]+eh[2]*ec,F[3]=el[3]+eh[3]*ec,F[4]=el[4]+eh[4]*ec,F[5]=el[5]+eh[5]*ec,F[6]=el[6]+eh[6]*ec,F[7]=el[7]+eh[7]*ec,F[8]=el[8]+eh[8]*ec,F[9]=el[9]+eh[9]*ec,F[10]=el[10]+eh[10]*ec,F[11]=el[11]+eh[11]*ec,F[12]=el[12]+eh[12]*ec,F[13]=el[13]+eh[13]*ec,F[14]=el[14]+eh[14]*ec,F[15]=el[15]+eh[15]*ec,F},tT.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]&&F[3]===el[3]&&F[4]===el[4]&&F[5]===el[5]&&F[6]===el[6]&&F[7]===el[7]&&F[8]===el[8]&&F[9]===el[9]&&F[10]===el[10]&&F[11]===el[11]&&F[12]===el[12]&&F[13]===el[13]&&F[14]===el[14]&&F[15]===el[15]},tT.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=el[9],eM=el[10],eI=el[11],eA=el[12],eC=el[13],eP=el[14],ez=el[15],eD=eh[0],eR=eh[1],eL=eh[2],eO=eh[3],ek=eh[4],eF=eh[5],eB=eh[6],eN=eh[7],eV=eh[8],eU=eh[9],ej=eh[10],eG=eh[11],eq=eh[12],e$=eh[13],eH=eh[14],eZ=eh[15];return Math.abs(ec-eD)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eD))&&Math.abs(ep-eR)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eR))&&Math.abs(e_-eL)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eL))&&Math.abs(eg-eO)<=F.EPSILON*Math.max(1,Math.abs(eg),Math.abs(eO))&&Math.abs(ey-ek)<=F.EPSILON*Math.max(1,Math.abs(ey),Math.abs(ek))&&Math.abs(eb-eF)<=F.EPSILON*Math.max(1,Math.abs(eb),Math.abs(eF))&&Math.abs(ew-eB)<=F.EPSILON*Math.max(1,Math.abs(ew),Math.abs(eB))&&Math.abs(eT-eN)<=F.EPSILON*Math.max(1,Math.abs(eT),Math.abs(eN))&&Math.abs(eS-eV)<=F.EPSILON*Math.max(1,Math.abs(eS),Math.abs(eV))&&Math.abs(eE-eU)<=F.EPSILON*Math.max(1,Math.abs(eE),Math.abs(eU))&&Math.abs(eM-ej)<=F.EPSILON*Math.max(1,Math.abs(eM),Math.abs(ej))&&Math.abs(eI-eG)<=F.EPSILON*Math.max(1,Math.abs(eI),Math.abs(eG))&&Math.abs(eA-eq)<=F.EPSILON*Math.max(1,Math.abs(eA),Math.abs(eq))&&Math.abs(eC-e$)<=F.EPSILON*Math.max(1,Math.abs(eC),Math.abs(e$))&&Math.abs(eP-eH)<=F.EPSILON*Math.max(1,Math.abs(eP),Math.abs(eH))&&Math.abs(ez-eZ)<=F.EPSILON*Math.max(1,Math.abs(ez),Math.abs(eZ))},tT.sub=tT.mul=tT.ortho=tT.perspective=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=1,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=1,F[11]=0,F[12]=0,F[13]=0,F[14]=0,F[15]=1,F}function i(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=el[8],eE=el[9],eM=el[10],eI=el[11],eA=el[12],eC=el[13],eP=el[14],ez=el[15],eD=eh[0],eR=eh[1],eL=eh[2],eO=eh[3];return F[0]=eD*ec+eR*ey+eL*eS+eO*eA,F[1]=eD*ep+eR*eb+eL*eE+eO*eC,F[2]=eD*e_+eR*ew+eL*eM+eO*eP,F[3]=eD*eg+eR*eT+eL*eI+eO*ez,F[4]=(eD=eh[4])*ec+(eR=eh[5])*ey+(eL=eh[6])*eS+(eO=eh[7])*eA,F[5]=eD*ep+eR*eb+eL*eE+eO*eC,F[6]=eD*e_+eR*ew+eL*eM+eO*eP,F[7]=eD*eg+eR*eT+eL*eI+eO*ez,F[8]=(eD=eh[8])*ec+(eR=eh[9])*ey+(eL=eh[10])*eS+(eO=eh[11])*eA,F[9]=eD*ep+eR*eb+eL*eE+eO*eC,F[10]=eD*e_+eR*ew+eL*eM+eO*eP,F[11]=eD*eg+eR*eT+eL*eI+eO*ez,F[12]=(eD=eh[12])*ec+(eR=eh[13])*ey+(eL=eh[14])*eS+(eO=eh[15])*eA,F[13]=eD*ep+eR*eb+eL*eE+eO*eC,F[14]=eD*e_+eR*ew+eL*eM+eO*eP,F[15]=eD*eg+eR*eT+eL*eI+eO*ez,F}function a(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=ec+ec,eb=ep+ep,ew=e_+e_,eT=ec*ey,eS=ec*eb,eE=ec*ew,eM=ep*eb,eI=ep*ew,eA=e_*ew,eC=eg*ey,eP=eg*eb,ez=eg*ew;return F[0]=1-(eM+eA),F[1]=eS+ez,F[2]=eE-eP,F[3]=0,F[4]=eS-ez,F[5]=1-(eT+eA),F[6]=eI+eC,F[7]=0,F[8]=eE+eP,F[9]=eI-eC,F[10]=1-(eT+eM),F[11]=0,F[12]=eh[0],F[13]=eh[1],F[14]=eh[2],F[15]=1,F}function o(F,el){var eh=el[4],ec=el[5],ep=el[6],e_=el[8],eg=el[9],ey=el[10];return F[0]=Math.hypot(el[0],el[1],el[2]),F[1]=Math.hypot(eh,ec,ep),F[2]=Math.hypot(e_,eg,ey),F}function l(F,el,eh,ec,ep){var e_,eg=1/Math.tan(el/2);return F[0]=eg/eh,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=eg,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[11]=-1,F[12]=0,F[13]=0,F[15]=0,null!=ep&&ep!==1/0?(F[10]=(ep+ec)*(e_=1/(ec-ep)),F[14]=2*ep*ec*e_):(F[10]=-1,F[14]=-2*ec),F}function u(F,el,eh,ec,ep,e_,eg){var ey=1/(el-eh),eb=1/(ec-ep),ew=1/(e_-eg);return F[0]=-2*ey,F[1]=0,F[2]=0,F[3]=0,F[4]=0,F[5]=-2*eb,F[6]=0,F[7]=0,F[8]=0,F[9]=0,F[10]=2*ew,F[11]=0,F[12]=(el+eh)*ey,F[13]=(ep+ec)*eb,F[14]=(eg+e_)*ew,F[15]=1,F}function c(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F[2]=el[2]-eh[2],F[3]=el[3]-eh[3],F[4]=el[4]-eh[4],F[5]=el[5]-eh[5],F[6]=el[6]-eh[6],F[7]=el[7]-eh[7],F[8]=el[8]-eh[8],F[9]=el[9]-eh[9],F[10]=el[10]-eh[10],F[11]=el[11]-eh[11],F[12]=el[12]-eh[12],F[13]=el[13]-eh[13],F[14]=el[14]-eh[14],F[15]=el[15]-eh[15],F}return tT.perspective=l,tT.ortho=u,tT.mul=i,tT.sub=c,tT}var tS,tE={},tM={};function _(){if(tS)return tM;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tS=1,Object.defineProperty(tM,"__esModule",{value:!0}),tM.create=n,tM.clone=function(el){var eh=new F.ARRAY_TYPE(3);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh},tM.length=i,tM.fromValues=function(el,eh,ec){var ep=new F.ARRAY_TYPE(3);return ep[0]=el,ep[1]=eh,ep[2]=ec,ep},tM.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F},tM.set=function(F,el,eh,ec){return F[0]=el,F[1]=eh,F[2]=ec,F},tM.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F},tM.subtract=a,tM.multiply=o,tM.divide=l,tM.ceil=function(F,el){return F[0]=Math.ceil(el[0]),F[1]=Math.ceil(el[1]),F[2]=Math.ceil(el[2]),F},tM.floor=function(F,el){return F[0]=Math.floor(el[0]),F[1]=Math.floor(el[1]),F[2]=Math.floor(el[2]),F},tM.min=function(F,el,eh){return F[0]=Math.min(el[0],eh[0]),F[1]=Math.min(el[1],eh[1]),F[2]=Math.min(el[2],eh[2]),F},tM.max=function(F,el,eh){return F[0]=Math.max(el[0],eh[0]),F[1]=Math.max(el[1],eh[1]),F[2]=Math.max(el[2],eh[2]),F},tM.round=function(F,el){return F[0]=Math.round(el[0]),F[1]=Math.round(el[1]),F[2]=Math.round(el[2]),F},tM.scale=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F},tM.scaleAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F[2]=el[2]+eh[2]*ec,F},tM.distance=u,tM.squaredDistance=c,tM.squaredLength=h,tM.negate=function(F,el){return F[0]=-el[0],F[1]=-el[1],F[2]=-el[2],F},tM.inverse=function(F,el){return F[0]=1/el[0],F[1]=1/el[1],F[2]=1/el[2],F},tM.normalize=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=eh*eh+ec*ec+ep*ep;return e_>0&&(e_=1/Math.sqrt(e_)),F[0]=el[0]*e_,F[1]=el[1]*e_,F[2]=el[2]*e_,F},tM.dot=p,tM.cross=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=eh[0],ey=eh[1],eb=eh[2];return F[0]=ep*eb-e_*ey,F[1]=e_*eg-ec*eb,F[2]=ec*ey-ep*eg,F},tM.lerp=function(F,el,eh,ec){var ep=el[0],e_=el[1],eg=el[2];return F[0]=ep+ec*(eh[0]-ep),F[1]=e_+ec*(eh[1]-e_),F[2]=eg+ec*(eh[2]-eg),F},tM.hermite=function(F,el,eh,ec,ep,e_){var eg=e_*e_,ey=eg*(2*e_-3)+1,eb=eg*(e_-2)+e_,ew=eg*(e_-1),eT=eg*(3-2*e_);return F[0]=el[0]*ey+eh[0]*eb+ec[0]*ew+ep[0]*eT,F[1]=el[1]*ey+eh[1]*eb+ec[1]*ew+ep[1]*eT,F[2]=el[2]*ey+eh[2]*eb+ec[2]*ew+ep[2]*eT,F},tM.bezier=function(F,el,eh,ec,ep,e_){var eg=1-e_,ey=eg*eg,eb=e_*e_,ew=ey*eg,eT=3*e_*ey,eS=3*eb*eg,eE=eb*e_;return F[0]=el[0]*ew+eh[0]*eT+ec[0]*eS+ep[0]*eE,F[1]=el[1]*ew+eh[1]*eT+ec[1]*eS+ep[1]*eE,F[2]=el[2]*ew+eh[2]*eT+ec[2]*eS+ep[2]*eE,F},tM.random=function(el,eh){eh=eh||1;var ec=2*F.RANDOM()*Math.PI,ep=2*F.RANDOM()-1,e_=Math.sqrt(1-ep*ep)*eh;return el[0]=Math.cos(ec)*e_,el[1]=Math.sin(ec)*e_,el[2]=ep*eh,el},tM.transformMat4=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=eh[3]*ec+eh[7]*ep+eh[11]*e_+eh[15];return F[0]=(eh[0]*ec+eh[4]*ep+eh[8]*e_+eh[12])/(eg=eg||1),F[1]=(eh[1]*ec+eh[5]*ep+eh[9]*e_+eh[13])/eg,F[2]=(eh[2]*ec+eh[6]*ep+eh[10]*e_+eh[14])/eg,F},tM.transformMat3=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2];return F[0]=ec*eh[0]+ep*eh[3]+e_*eh[6],F[1]=ec*eh[1]+ep*eh[4]+e_*eh[7],F[2]=ec*eh[2]+ep*eh[5]+e_*eh[8],F},tM.transformQuat=function(F,el,eh){var ec=eh[0],ep=eh[1],e_=eh[2],eg=el[0],ey=el[1],eb=el[2],ew=ep*eb-e_*ey,eT=e_*eg-ec*eb,eS=ec*ey-ep*eg,eE=ep*eS-e_*eT,eM=e_*ew-ec*eS,eI=ec*eT-ep*ew,eA=2*eh[3];return eT*=eA,eS*=eA,eM*=2,eI*=2,F[0]=eg+(ew*=eA)+(eE*=2),F[1]=ey+eT+eM,F[2]=eb+eS+eI,F},tM.rotateX=function(F,el,eh,ec){var ep=[],e_=[];return ep[0]=el[0]-eh[0],ep[1]=el[1]-eh[1],ep[2]=el[2]-eh[2],e_[0]=ep[0],e_[1]=ep[1]*Math.cos(ec)-ep[2]*Math.sin(ec),e_[2]=ep[1]*Math.sin(ec)+ep[2]*Math.cos(ec),F[0]=e_[0]+eh[0],F[1]=e_[1]+eh[1],F[2]=e_[2]+eh[2],F},tM.rotateY=function(F,el,eh,ec){var ep=[],e_=[];return ep[0]=el[0]-eh[0],ep[1]=el[1]-eh[1],ep[2]=el[2]-eh[2],e_[0]=ep[2]*Math.sin(ec)+ep[0]*Math.cos(ec),e_[1]=ep[1],e_[2]=ep[2]*Math.cos(ec)-ep[0]*Math.sin(ec),F[0]=e_[0]+eh[0],F[1]=e_[1]+eh[1],F[2]=e_[2]+eh[2],F},tM.rotateZ=function(F,el,eh,ec){var ep=[],e_=[];return ep[0]=el[0]-eh[0],ep[1]=el[1]-eh[1],ep[2]=el[2]-eh[2],e_[0]=ep[0]*Math.cos(ec)-ep[1]*Math.sin(ec),e_[1]=ep[0]*Math.sin(ec)+ep[1]*Math.cos(ec),e_[2]=ep[2],F[0]=e_[0]+eh[0],F[1]=e_[1]+eh[1],F[2]=e_[2]+eh[2],F},tM.angle=function(F,el){var eh=F[0],ec=F[1],ep=F[2],e_=el[0],eg=el[1],ey=el[2],eb=Math.sqrt(eh*eh+ec*ec+ep*ep)*Math.sqrt(e_*e_+eg*eg+ey*ey);return Math.acos(Math.min(Math.max(eb&&p(F,el)/eb,-1),1))},tM.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F},tM.str=function(F){return"vec3("+F[0]+", "+F[1]+", "+F[2]+")"},tM.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]},tM.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=eh[0],ey=eh[1],eb=eh[2];return Math.abs(ec-eg)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eg))&&Math.abs(ep-ey)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(ey))&&Math.abs(e_-eb)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eb))},tM.forEach=tM.sqrLen=tM.len=tM.sqrDist=tM.dist=tM.div=tM.mul=tM.sub=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(){var el=new F.ARRAY_TYPE(3);return F.ARRAY_TYPE!=Float32Array&&(el[0]=0,el[1]=0,el[2]=0),el}function i(F){return Math.hypot(F[0],F[1],F[2])}function a(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F[2]=el[2]-eh[2],F}function o(F,el,eh){return F[0]=el[0]*eh[0],F[1]=el[1]*eh[1],F[2]=el[2]*eh[2],F}function l(F,el,eh){return F[0]=el[0]/eh[0],F[1]=el[1]/eh[1],F[2]=el[2]/eh[2],F}function u(F,el){return Math.hypot(el[0]-F[0],el[1]-F[1],el[2]-F[2])}function c(F,el){var eh=el[0]-F[0],ec=el[1]-F[1],ep=el[2]-F[2];return eh*eh+ec*ec+ep*ep}function h(F){var el=F[0],eh=F[1],ec=F[2];return el*el+eh*eh+ec*ec}function p(F,el){return F[0]*el[0]+F[1]*el[1]+F[2]*el[2]}tM.sub=a,tM.mul=o,tM.div=l,tM.dist=u,tM.sqrDist=c,tM.len=i,tM.sqrLen=h;var el,eh=(el=n(),function(F,eh,ec,ep,e_,eg){var ey,eb;for(eh||(eh=3),ec||(ec=0),eb=ep?Math.min(ep*eh+ec,F.length):F.length,ey=ec;ey<eb;ey+=eh)el[0]=F[ey],el[1]=F[ey+1],el[2]=F[ey+2],e_(el,el,eg),F[ey]=el[0],F[ey+1]=el[1],F[ey+2]=el[2];return F});return tM.forEach=eh,tM}var tI,tA,tC={};function I(){if(tI)return tC;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tI=1,Object.defineProperty(tC,"__esModule",{value:!0}),tC.create=n,tC.clone=function(el){var eh=new F.ARRAY_TYPE(4);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh[3]=el[3],eh},tC.fromValues=function(el,eh,ec,ep){var e_=new F.ARRAY_TYPE(4);return e_[0]=el,e_[1]=eh,e_[2]=ec,e_[3]=ep,e_},tC.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F},tC.set=function(F,el,eh,ec,ep){return F[0]=el,F[1]=eh,F[2]=ec,F[3]=ep,F},tC.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F[3]=el[3]+eh[3],F},tC.subtract=i,tC.multiply=a,tC.divide=o,tC.ceil=function(F,el){return F[0]=Math.ceil(el[0]),F[1]=Math.ceil(el[1]),F[2]=Math.ceil(el[2]),F[3]=Math.ceil(el[3]),F},tC.floor=function(F,el){return F[0]=Math.floor(el[0]),F[1]=Math.floor(el[1]),F[2]=Math.floor(el[2]),F[3]=Math.floor(el[3]),F},tC.min=function(F,el,eh){return F[0]=Math.min(el[0],eh[0]),F[1]=Math.min(el[1],eh[1]),F[2]=Math.min(el[2],eh[2]),F[3]=Math.min(el[3],eh[3]),F},tC.max=function(F,el,eh){return F[0]=Math.max(el[0],eh[0]),F[1]=Math.max(el[1],eh[1]),F[2]=Math.max(el[2],eh[2]),F[3]=Math.max(el[3],eh[3]),F},tC.round=function(F,el){return F[0]=Math.round(el[0]),F[1]=Math.round(el[1]),F[2]=Math.round(el[2]),F[3]=Math.round(el[3]),F},tC.scale=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F[3]=el[3]*eh,F},tC.scaleAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F[2]=el[2]+eh[2]*ec,F[3]=el[3]+eh[3]*ec,F},tC.distance=l,tC.squaredDistance=u,tC.length=c,tC.squaredLength=h,tC.negate=function(F,el){return F[0]=-el[0],F[1]=-el[1],F[2]=-el[2],F[3]=-el[3],F},tC.inverse=function(F,el){return F[0]=1/el[0],F[1]=1/el[1],F[2]=1/el[2],F[3]=1/el[3],F},tC.normalize=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=eh*eh+ec*ec+ep*ep+e_*e_;return eg>0&&(eg=1/Math.sqrt(eg)),F[0]=eh*eg,F[1]=ec*eg,F[2]=ep*eg,F[3]=e_*eg,F},tC.dot=function(F,el){return F[0]*el[0]+F[1]*el[1]+F[2]*el[2]+F[3]*el[3]},tC.cross=function(F,el,eh,ec){var ep=eh[0]*ec[1]-eh[1]*ec[0],e_=eh[0]*ec[2]-eh[2]*ec[0],eg=eh[0]*ec[3]-eh[3]*ec[0],ey=eh[1]*ec[2]-eh[2]*ec[1],eb=eh[1]*ec[3]-eh[3]*ec[1],ew=eh[2]*ec[3]-eh[3]*ec[2],eT=el[0],eS=el[1],eE=el[2],eM=el[3];return F[0]=eS*ew-eE*eb+eM*ey,F[1]=-eT*ew+eE*eg-eM*e_,F[2]=eT*eb-eS*eg+eM*ep,F[3]=-eT*ey+eS*e_-eE*ep,F},tC.lerp=function(F,el,eh,ec){var ep=el[0],e_=el[1],eg=el[2],ey=el[3];return F[0]=ep+ec*(eh[0]-ep),F[1]=e_+ec*(eh[1]-e_),F[2]=eg+ec*(eh[2]-eg),F[3]=ey+ec*(eh[3]-ey),F},tC.random=function(el,eh){eh=eh||1;do ey=(ec=2*F.RANDOM()-1)*ec+(ep=2*F.RANDOM()-1)*ep;while(ey>=1);do eb=(e_=2*F.RANDOM()-1)*e_+(eg=2*F.RANDOM()-1)*eg;while(eb>=1);var ec,ep,e_,eg,ey,eb,ew=Math.sqrt((1-ey)/eb);return el[0]=eh*ec,el[1]=eh*ep,el[2]=eh*e_*ew,el[3]=eh*eg*ew,el},tC.transformMat4=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3];return F[0]=eh[0]*ec+eh[4]*ep+eh[8]*e_+eh[12]*eg,F[1]=eh[1]*ec+eh[5]*ep+eh[9]*e_+eh[13]*eg,F[2]=eh[2]*ec+eh[6]*ep+eh[10]*e_+eh[14]*eg,F[3]=eh[3]*ec+eh[7]*ep+eh[11]*e_+eh[15]*eg,F},tC.transformQuat=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=eh[0],ey=eh[1],eb=eh[2],ew=eh[3],eT=ew*ec+ey*e_-eb*ep,eS=ew*ep+eb*ec-eg*e_,eE=ew*e_+eg*ep-ey*ec,eM=-eg*ec-ey*ep-eb*e_;return F[0]=eT*ew+-(eM*eg)+-(eS*eb)- -(eE*ey),F[1]=eS*ew+-(eM*ey)+-(eE*eg)- -(eT*eb),F[2]=eE*ew+-(eM*eb)+-(eT*ey)- -(eS*eg),F[3]=el[3],F},tC.zero=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=0,F},tC.str=function(F){return"vec4("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},tC.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]&&F[3]===el[3]},tC.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=eh[0],eb=eh[1],ew=eh[2],eT=eh[3];return Math.abs(ec-ey)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(ey))&&Math.abs(ep-eb)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eb))&&Math.abs(e_-ew)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(ew))&&Math.abs(eg-eT)<=F.EPSILON*Math.max(1,Math.abs(eg),Math.abs(eT))},tC.forEach=tC.sqrLen=tC.len=tC.sqrDist=tC.dist=tC.div=tC.mul=tC.sub=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(){var el=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(el[0]=0,el[1]=0,el[2]=0,el[3]=0),el}function i(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F[2]=el[2]-eh[2],F[3]=el[3]-eh[3],F}function a(F,el,eh){return F[0]=el[0]*eh[0],F[1]=el[1]*eh[1],F[2]=el[2]*eh[2],F[3]=el[3]*eh[3],F}function o(F,el,eh){return F[0]=el[0]/eh[0],F[1]=el[1]/eh[1],F[2]=el[2]/eh[2],F[3]=el[3]/eh[3],F}function l(F,el){return Math.hypot(el[0]-F[0],el[1]-F[1],el[2]-F[2],el[3]-F[3])}function u(F,el){var eh=el[0]-F[0],ec=el[1]-F[1],ep=el[2]-F[2],e_=el[3]-F[3];return eh*eh+ec*ec+ep*ep+e_*e_}function c(F){return Math.hypot(F[0],F[1],F[2],F[3])}function h(F){var el=F[0],eh=F[1],ec=F[2],ep=F[3];return el*el+eh*eh+ec*ec+ep*ep}tC.sub=i,tC.mul=a,tC.div=o,tC.dist=l,tC.sqrDist=u,tC.len=c,tC.sqrLen=h;var el,eh=(el=n(),function(F,eh,ec,ep,e_,eg){var ey,eb;for(eh||(eh=4),ec||(ec=0),eb=ep?Math.min(ep*eh+ec,F.length):F.length,ey=ec;ey<eb;ey+=eh)el[0]=F[ey],el[1]=F[ey+1],el[2]=F[ey+2],el[3]=F[ey+3],e_(el,el,eg),F[ey]=el[0],F[ey+1]=el[1],F[ey+2]=el[2],F[ey+3]=el[3];return F});return tC.forEach=eh,tC}function S(){if(tA)return tE;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tA=1,Object.defineProperty(tE,"__esModule",{value:!0}),tE.create=l,tE.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F},tE.setAxisAngle=u,tE.getAxisAngle=function(el,eh){var ec=2*Math.acos(eh[3]),ep=Math.sin(ec/2);return ep>F.EPSILON?(el[0]=eh[0]/ep,el[1]=eh[1]/ep,el[2]=eh[2]/ep):(el[0]=1,el[1]=0,el[2]=0),ec},tE.getAngle=function(F,el){var eh=e_(F,el);return Math.acos(2*eh*eh-1)},tE.multiply=c,tE.rotateX=function(F,el,eh){eh*=.5;var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=Math.sin(eh),eb=Math.cos(eh);return F[0]=ec*eb+eg*ey,F[1]=ep*eb+e_*ey,F[2]=e_*eb-ep*ey,F[3]=eg*eb-ec*ey,F},tE.rotateY=function(F,el,eh){eh*=.5;var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=Math.sin(eh),eb=Math.cos(eh);return F[0]=ec*eb-e_*ey,F[1]=ep*eb+eg*ey,F[2]=e_*eb+ec*ey,F[3]=eg*eb-ep*ey,F},tE.rotateZ=function(F,el,eh){eh*=.5;var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=Math.sin(eh),eb=Math.cos(eh);return F[0]=ec*eb+ep*ey,F[1]=ep*eb-ec*ey,F[2]=e_*eb+eg*ey,F[3]=eg*eb-e_*ey,F},tE.calculateW=function(F,el){var eh=el[0],ec=el[1],ep=el[2];return F[0]=eh,F[1]=ec,F[2]=ep,F[3]=Math.sqrt(Math.abs(1-eh*eh-ec*ec-ep*ep)),F},tE.exp=h,tE.ln=p,tE.pow=function(F,el,eh){return p(F,el),ep(F,F,eh),h(F,F),F},tE.slerp=f,tE.random=function(el){var eh=F.RANDOM(),ec=F.RANDOM(),ep=F.RANDOM(),e_=Math.sqrt(1-eh),eg=Math.sqrt(eh);return el[0]=e_*Math.sin(2*Math.PI*ec),el[1]=e_*Math.cos(2*Math.PI*ec),el[2]=eg*Math.sin(2*Math.PI*ep),el[3]=eg*Math.cos(2*Math.PI*ep),el},tE.invert=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=eh*eh+ec*ec+ep*ep+e_*e_,ey=eg?1/eg:0;return F[0]=-eh*ey,F[1]=-ec*ey,F[2]=-ep*ey,F[3]=e_*ey,F},tE.conjugate=function(F,el){return F[0]=-el[0],F[1]=-el[1],F[2]=-el[2],F[3]=el[3],F},tE.fromMat3=m,tE.fromEuler=function(F,el,eh,ec){var ep=.5*Math.PI/180;el*=ep,eh*=ep,ec*=ep;var e_=Math.sin(el),eg=Math.cos(el),ey=Math.sin(eh),eb=Math.cos(eh),ew=Math.sin(ec),eT=Math.cos(ec);return F[0]=e_*eb*eT-eg*ey*ew,F[1]=eg*ey*eT+e_*eb*ew,F[2]=eg*eb*ew-e_*ey*eT,F[3]=eg*eb*eT+e_*ey*ew,F},tE.str=function(F){return"quat("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},tE.setAxes=tE.sqlerp=tE.rotationTo=tE.equals=tE.exactEquals=tE.normalize=tE.sqrLen=tE.squaredLength=tE.len=tE.length=tE.lerp=tE.dot=tE.scale=tE.mul=tE.add=tE.set=tE.copy=tE.fromValues=tE.clone=void 0;var F=o(s()),el=o(d()),eh=o(_()),ec=o(I());function a(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(a=function(F){return F?eh:el})(F)}function o(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=a(el);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}function l(){var el=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(el[0]=0,el[1]=0,el[2]=0),el[3]=1,el}function u(F,el,eh){var ec=Math.sin(eh*=.5);return F[0]=ec*el[0],F[1]=ec*el[1],F[2]=ec*el[2],F[3]=Math.cos(eh),F}function c(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=eh[0],eb=eh[1],ew=eh[2],eT=eh[3];return F[0]=ec*eT+eg*ey+ep*ew-e_*eb,F[1]=ep*eT+eg*eb+e_*ey-ec*ew,F[2]=e_*eT+eg*ew+ec*eb-ep*ey,F[3]=eg*eT-ec*ey-ep*eb-e_*ew,F}function h(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=Math.sqrt(eh*eh+ec*ec+ep*ep),ey=Math.exp(e_),eb=eg>0?ey*Math.sin(eg)/eg:0;return F[0]=eh*eb,F[1]=ec*eb,F[2]=ep*eb,F[3]=ey*Math.cos(eg),F}function p(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=Math.sqrt(eh*eh+ec*ec+ep*ep),ey=eg>0?Math.atan2(eg,e_)/eg:0;return F[0]=eh*ey,F[1]=ec*ey,F[2]=ep*ey,F[3]=.5*Math.log(eh*eh+ec*ec+ep*ep+e_*e_),F}function f(el,eh,ec,ep){var e_,eg,ey,eb,ew,eT=eh[0],eS=eh[1],eE=eh[2],eM=eh[3],eI=ec[0],eA=ec[1],eC=ec[2],eP=ec[3];return(eg=eT*eI+eS*eA+eE*eC+eM*eP)<0&&(eg=-eg,eI=-eI,eA=-eA,eC=-eC,eP=-eP),1-eg>F.EPSILON?(ey=Math.sin(e_=Math.acos(eg)),eb=Math.sin((1-ep)*e_)/ey,ew=Math.sin(ep*e_)/ey):(eb=1-ep,ew=ep),el[0]=eb*eT+ew*eI,el[1]=eb*eS+ew*eA,el[2]=eb*eE+ew*eC,el[3]=eb*eM+ew*eP,el}function m(F,el){var eh,ec=el[0]+el[4]+el[8];if(ec>0)eh=Math.sqrt(ec+1),F[3]=.5*eh,F[0]=(el[5]-el[7])*(eh=.5/eh),F[1]=(el[6]-el[2])*eh,F[2]=(el[1]-el[3])*eh;else{var ep=0;el[4]>el[0]&&(ep=1),el[8]>el[3*ep+ep]&&(ep=2);var e_=(ep+1)%3,eg=(ep+2)%3;eh=Math.sqrt(el[3*ep+ep]-el[3*e_+e_]-el[3*eg+eg]+1),F[ep]=.5*eh,F[3]=(el[3*e_+eg]-el[3*eg+e_])*(eh=.5/eh),F[e_]=(el[3*e_+ep]+el[3*ep+e_])*eh,F[eg]=(el[3*eg+ep]+el[3*ep+eg])*eh}return F}tE.clone=ec.clone,tE.fromValues=ec.fromValues,tE.copy=ec.copy,tE.set=ec.set,tE.add=ec.add,tE.mul=c;var ep=ec.scale;tE.scale=ep;var e_=ec.dot;tE.dot=e_,tE.lerp=ec.lerp;var eg=ec.length;tE.length=eg,tE.len=eg;var ey=ec.squaredLength;tE.squaredLength=ey,tE.sqrLen=ey;var eb=ec.normalize;tE.normalize=eb,tE.exactEquals=ec.exactEquals,tE.equals=ec.equals;var ew,eT,eS,eE=(ew=eh.create(),eT=eh.fromValues(1,0,0),eS=eh.fromValues(0,1,0),function(F,el,ec){var ep=eh.dot(el,ec);return ep<-.999999?(eh.cross(ew,eT,el),1e-6>eh.len(ew)&&eh.cross(ew,eS,el),eh.normalize(ew,ew),u(F,ew,Math.PI),F):ep>.999999?(F[0]=0,F[1]=0,F[2]=0,F[3]=1,F):(eh.cross(ew,el,ec),F[0]=ew[0],F[1]=ew[1],F[2]=ew[2],F[3]=1+ep,eb(F,F))});tE.rotationTo=eE;var eM,eI,eA=(eM=l(),eI=l(),function(F,el,eh,ec,ep,e_){return f(eM,el,ep,e_),f(eI,eh,ec,e_),f(F,eM,eI,2*e_*(1-e_)),F});tE.sqlerp=eA;var eC,eP=(eC=el.create(),function(F,el,eh,ec){return eC[0]=eh[0],eC[3]=eh[1],eC[6]=eh[2],eC[1]=ec[0],eC[4]=ec[1],eC[7]=ec[2],eC[2]=-el[0],eC[5]=-el[1],eC[8]=-el[2],eb(F,m(F,eC))});return tE.setAxes=eP,tE}var tP,tz,tD,tR,tL,tO,tk,tF={},tB={},tN=function(){if(tD)return tn;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tD=1,Object.defineProperty(tn,"__esModule",{value:!0}),tn.vec4=tn.vec3=tn.vec2=tn.quat2=tn.quat=tn.mat4=tn.mat3=tn.mat2d=tn.mat2=tn.glMatrix=void 0;var F=x(s());tn.glMatrix=F;var el=x(function(){if(tc)return ty;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tc=1,Object.defineProperty(ty,"__esModule",{value:!0}),ty.create=function(){var el=new F.ARRAY_TYPE(4);return F.ARRAY_TYPE!=Float32Array&&(el[1]=0,el[2]=0),el[0]=1,el[3]=1,el},ty.clone=function(el){var eh=new F.ARRAY_TYPE(4);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh[3]=el[3],eh},ty.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F},ty.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F},ty.fromValues=function(el,eh,ec,ep){var e_=new F.ARRAY_TYPE(4);return e_[0]=el,e_[1]=eh,e_[2]=ec,e_[3]=ep,e_},ty.set=function(F,el,eh,ec,ep){return F[0]=el,F[1]=eh,F[2]=ec,F[3]=ep,F},ty.transpose=function(F,el){if(F===el){var eh=el[1];F[1]=el[2],F[2]=eh}else F[0]=el[0],F[1]=el[2],F[2]=el[1],F[3]=el[3];return F},ty.invert=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=eh*e_-ep*ec;return eg?(F[0]=e_*(eg=1/eg),F[1]=-ec*eg,F[2]=-ep*eg,F[3]=eh*eg,F):null},ty.adjoint=function(F,el){var eh=el[0];return F[0]=el[3],F[1]=-el[1],F[2]=-el[2],F[3]=eh,F},ty.determinant=function(F){return F[0]*F[3]-F[2]*F[1]},ty.multiply=n,ty.rotate=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=Math.sin(eh),eb=Math.cos(eh);return F[0]=ec*eb+e_*ey,F[1]=ep*eb+eg*ey,F[2]=-(ec*ey)+e_*eb,F[3]=-(ep*ey)+eg*eb,F},ty.scale=function(F,el,eh){var ec=el[1],ep=el[2],e_=el[3],eg=eh[0],ey=eh[1];return F[0]=el[0]*eg,F[1]=ec*eg,F[2]=ep*ey,F[3]=e_*ey,F},ty.fromRotation=function(F,el){var eh=Math.sin(el),ec=Math.cos(el);return F[0]=ec,F[1]=eh,F[2]=-eh,F[3]=ec,F},ty.fromScaling=function(F,el){return F[0]=el[0],F[1]=0,F[2]=0,F[3]=el[1],F},ty.str=function(F){return"mat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+")"},ty.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3])},ty.LDU=function(F,el,eh,ec){return F[2]=ec[2]/ec[0],eh[0]=ec[0],eh[1]=ec[1],eh[3]=ec[3]-F[2]*eh[1],[F,el,eh]},ty.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F[3]=el[3]+eh[3],F},ty.subtract=i,ty.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]&&F[3]===el[3]},ty.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=eh[0],eb=eh[1],ew=eh[2],eT=eh[3];return Math.abs(ec-ey)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(ey))&&Math.abs(ep-eb)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eb))&&Math.abs(e_-ew)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(ew))&&Math.abs(eg-eT)<=F.EPSILON*Math.max(1,Math.abs(eg),Math.abs(eT))},ty.multiplyScalar=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F[3]=el[3]*eh,F},ty.multiplyScalarAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F[2]=el[2]+eh[2]*ec,F[3]=el[3]+eh[3]*ec,F},ty.sub=ty.mul=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=eh[0],eb=eh[1],ew=eh[2],eT=eh[3];return F[0]=ec*ey+e_*eb,F[1]=ep*ey+eg*eb,F[2]=ec*ew+e_*eT,F[3]=ep*ew+eg*eT,F}function i(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F[2]=el[2]-eh[2],F[3]=el[3]-eh[3],F}return ty.mul=n,ty.sub=i,ty}());tn.mat2=el;var eh=x(function(){if(t_)return tv;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}t_=1,Object.defineProperty(tv,"__esModule",{value:!0}),tv.create=function(){var el=new F.ARRAY_TYPE(6);return F.ARRAY_TYPE!=Float32Array&&(el[1]=0,el[2]=0,el[4]=0,el[5]=0),el[0]=1,el[3]=1,el},tv.clone=function(el){var eh=new F.ARRAY_TYPE(6);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh[3]=el[3],eh[4]=el[4],eh[5]=el[5],eh},tv.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F[4]=el[4],F[5]=el[5],F},tv.identity=function(F){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F},tv.fromValues=function(el,eh,ec,ep,e_,eg){var ey=new F.ARRAY_TYPE(6);return ey[0]=el,ey[1]=eh,ey[2]=ec,ey[3]=ep,ey[4]=e_,ey[5]=eg,ey},tv.set=function(F,el,eh,ec,ep,e_,eg){return F[0]=el,F[1]=eh,F[2]=ec,F[3]=ep,F[4]=e_,F[5]=eg,F},tv.invert=function(F,el){var eh=el[0],ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=eh*e_-ec*ep;return eb?(F[0]=e_*(eb=1/eb),F[1]=-ec*eb,F[2]=-ep*eb,F[3]=eh*eb,F[4]=(ep*ey-e_*eg)*eb,F[5]=(ec*eg-eh*ey)*eb,F):null},tv.determinant=function(F){return F[0]*F[3]-F[1]*F[2]},tv.multiply=n,tv.rotate=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=Math.sin(eh),eT=Math.cos(eh);return F[0]=ec*eT+e_*ew,F[1]=ep*eT+eg*ew,F[2]=-(ec*ew)+e_*eT,F[3]=-(ep*ew)+eg*eT,F[4]=ey,F[5]=eb,F},tv.scale=function(F,el,eh){var ec=el[1],ep=el[2],e_=el[3],eg=el[4],ey=el[5],eb=eh[0],ew=eh[1];return F[0]=el[0]*eb,F[1]=ec*eb,F[2]=ep*ew,F[3]=e_*ew,F[4]=eg,F[5]=ey,F},tv.translate=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=eh[0],eT=eh[1];return F[0]=ec,F[1]=ep,F[2]=e_,F[3]=eg,F[4]=ec*ew+e_*eT+ey,F[5]=ep*ew+eg*eT+eb,F},tv.fromRotation=function(F,el){var eh=Math.sin(el),ec=Math.cos(el);return F[0]=ec,F[1]=eh,F[2]=-eh,F[3]=ec,F[4]=0,F[5]=0,F},tv.fromScaling=function(F,el){return F[0]=el[0],F[1]=0,F[2]=0,F[3]=el[1],F[4]=0,F[5]=0,F},tv.fromTranslation=function(F,el){return F[0]=1,F[1]=0,F[2]=0,F[3]=1,F[4]=el[0],F[5]=el[1],F},tv.str=function(F){return"mat2d("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+")"},tv.frob=function(F){return Math.hypot(F[0],F[1],F[2],F[3],F[4],F[5],1)},tv.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F[3]=el[3]+eh[3],F[4]=el[4]+eh[4],F[5]=el[5]+eh[5],F},tv.subtract=i,tv.multiplyScalar=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F[3]=el[3]*eh,F[4]=el[4]*eh,F[5]=el[5]*eh,F},tv.multiplyScalarAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F[2]=el[2]+eh[2]*ec,F[3]=el[3]+eh[3]*ec,F[4]=el[4]+eh[4]*ec,F[5]=el[5]+eh[5]*ec,F},tv.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]&&F[3]===el[3]&&F[4]===el[4]&&F[5]===el[5]},tv.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=eh[0],eT=eh[1],eS=eh[2],eE=eh[3],eM=eh[4],eI=eh[5];return Math.abs(ec-ew)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(ew))&&Math.abs(ep-eT)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eT))&&Math.abs(e_-eS)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eS))&&Math.abs(eg-eE)<=F.EPSILON*Math.max(1,Math.abs(eg),Math.abs(eE))&&Math.abs(ey-eM)<=F.EPSILON*Math.max(1,Math.abs(ey),Math.abs(eM))&&Math.abs(eb-eI)<=F.EPSILON*Math.max(1,Math.abs(eb),Math.abs(eI))},tv.sub=tv.mul=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=eh[0],eT=eh[1],eS=eh[2],eE=eh[3],eM=eh[4],eI=eh[5];return F[0]=ec*ew+e_*eT,F[1]=ep*ew+eg*eT,F[2]=ec*eS+e_*eE,F[3]=ep*eS+eg*eE,F[4]=ec*eM+e_*eI+ey,F[5]=ep*eM+eg*eI+eb,F}function i(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F[2]=el[2]-eh[2],F[3]=el[3]-eh[3],F[4]=el[4]-eh[4],F[5]=el[5]-eh[5],F}return tv.mul=n,tv.sub=i,tv}());tn.mat2d=eh;var ec=x(d());tn.mat3=ec;var ep=x(g());tn.mat4=ep;var e_=x(S());tn.quat=e_;var eg=x(function(){if(tP)return tF;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tP=1,Object.defineProperty(tF,"__esModule",{value:!0}),tF.create=function(){var el=new F.ARRAY_TYPE(8);return F.ARRAY_TYPE!=Float32Array&&(el[0]=0,el[1]=0,el[2]=0,el[4]=0,el[5]=0,el[6]=0,el[7]=0),el[3]=1,el},tF.clone=function(el){var eh=new F.ARRAY_TYPE(8);return eh[0]=el[0],eh[1]=el[1],eh[2]=el[2],eh[3]=el[3],eh[4]=el[4],eh[5]=el[5],eh[6]=el[6],eh[7]=el[7],eh},tF.fromValues=function(el,eh,ec,ep,e_,eg,ey,eb){var ew=new F.ARRAY_TYPE(8);return ew[0]=el,ew[1]=eh,ew[2]=ec,ew[3]=ep,ew[4]=e_,ew[5]=eg,ew[6]=ey,ew[7]=eb,ew},tF.fromRotationTranslationValues=function(el,eh,ec,ep,e_,eg,ey){var eb=new F.ARRAY_TYPE(8);eb[0]=el,eb[1]=eh,eb[2]=ec,eb[3]=ep;var ew=.5*e_,eT=.5*eg,eS=.5*ey;return eb[4]=ew*ep+eT*ec-eS*eh,eb[5]=eT*ep+eS*el-ew*ec,eb[6]=eS*ep+ew*eh-eT*el,eb[7]=-ew*el-eT*eh-eS*ec,eb},tF.fromRotationTranslation=o,tF.fromTranslation=function(F,el){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=.5*el[0],F[5]=.5*el[1],F[6]=.5*el[2],F[7]=0,F},tF.fromRotation=function(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},tF.fromMat4=function(ec,ep){var e_=el.create();eh.getRotation(e_,ep);var eg=new F.ARRAY_TYPE(3);return eh.getTranslation(eg,ep),o(ec,e_,eg),ec},tF.copy=l,tF.identity=function(F){return F[0]=0,F[1]=0,F[2]=0,F[3]=1,F[4]=0,F[5]=0,F[6]=0,F[7]=0,F},tF.set=function(F,el,eh,ec,ep,e_,eg,ey,eb){return F[0]=el,F[1]=eh,F[2]=ec,F[3]=ep,F[4]=e_,F[5]=eg,F[6]=ey,F[7]=eb,F},tF.getDual=function(F,el){return F[0]=el[4],F[1]=el[5],F[2]=el[6],F[3]=el[7],F},tF.setDual=function(F,el){return F[4]=el[0],F[5]=el[1],F[6]=el[2],F[7]=el[3],F},tF.getTranslation=function(F,el){var eh=el[4],ec=el[5],ep=el[6],e_=el[7],eg=-el[0],ey=-el[1],eb=-el[2],ew=el[3];return F[0]=2*(eh*ew+e_*eg+ec*eb-ep*ey),F[1]=2*(ec*ew+e_*ey+ep*eg-eh*eb),F[2]=2*(ep*ew+e_*eb+eh*ey-ec*eg),F},tF.translate=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=.5*eh[0],eb=.5*eh[1],ew=.5*eh[2],eT=el[4],eS=el[5],eE=el[6],eM=el[7];return F[0]=ec,F[1]=ep,F[2]=e_,F[3]=eg,F[4]=eg*ey+ep*ew-e_*eb+eT,F[5]=eg*eb+e_*ey-ec*ew+eS,F[6]=eg*ew+ec*eb-ep*ey+eE,F[7]=-ec*ey-ep*eb-e_*ew+eM,F},tF.rotateX=function(F,eh,ec){var ep=-eh[0],e_=-eh[1],eg=-eh[2],ey=eh[3],eb=eh[4],ew=eh[5],eT=eh[6],eS=eh[7],eE=eb*ey+eS*ep+ew*eg-eT*e_,eM=ew*ey+eS*e_+eT*ep-eb*eg,eI=eT*ey+eS*eg+eb*e_-ew*ep,eA=eS*ey-eb*ep-ew*e_-eT*eg;return el.rotateX(F,eh,ec),F[4]=eE*(ey=F[3])+eA*(ep=F[0])+eM*(eg=F[2])-eI*(e_=F[1]),F[5]=eM*ey+eA*e_+eI*ep-eE*eg,F[6]=eI*ey+eA*eg+eE*e_-eM*ep,F[7]=eA*ey-eE*ep-eM*e_-eI*eg,F},tF.rotateY=function(F,eh,ec){var ep=-eh[0],e_=-eh[1],eg=-eh[2],ey=eh[3],eb=eh[4],ew=eh[5],eT=eh[6],eS=eh[7],eE=eb*ey+eS*ep+ew*eg-eT*e_,eM=ew*ey+eS*e_+eT*ep-eb*eg,eI=eT*ey+eS*eg+eb*e_-ew*ep,eA=eS*ey-eb*ep-ew*e_-eT*eg;return el.rotateY(F,eh,ec),F[4]=eE*(ey=F[3])+eA*(ep=F[0])+eM*(eg=F[2])-eI*(e_=F[1]),F[5]=eM*ey+eA*e_+eI*ep-eE*eg,F[6]=eI*ey+eA*eg+eE*e_-eM*ep,F[7]=eA*ey-eE*ep-eM*e_-eI*eg,F},tF.rotateZ=function(F,eh,ec){var ep=-eh[0],e_=-eh[1],eg=-eh[2],ey=eh[3],eb=eh[4],ew=eh[5],eT=eh[6],eS=eh[7],eE=eb*ey+eS*ep+ew*eg-eT*e_,eM=ew*ey+eS*e_+eT*ep-eb*eg,eI=eT*ey+eS*eg+eb*e_-ew*ep,eA=eS*ey-eb*ep-ew*e_-eT*eg;return el.rotateZ(F,eh,ec),F[4]=eE*(ey=F[3])+eA*(ep=F[0])+eM*(eg=F[2])-eI*(e_=F[1]),F[5]=eM*ey+eA*e_+eI*ep-eE*eg,F[6]=eI*ey+eA*eg+eE*e_-eM*ep,F[7]=eA*ey-eE*ep-eM*e_-eI*eg,F},tF.rotateByQuatAppend=function(F,el,eh){var ec=eh[0],ep=eh[1],e_=eh[2],eg=eh[3],ey=el[0],eb=el[1],ew=el[2],eT=el[3];return F[0]=ey*eg+eT*ec+eb*e_-ew*ep,F[1]=eb*eg+eT*ep+ew*ec-ey*e_,F[2]=ew*eg+eT*e_+ey*ep-eb*ec,F[3]=eT*eg-ey*ec-eb*ep-ew*e_,F[4]=(ey=el[4])*eg+(eT=el[7])*ec+(eb=el[5])*e_-(ew=el[6])*ep,F[5]=eb*eg+eT*ep+ew*ec-ey*e_,F[6]=ew*eg+eT*e_+ey*ep-eb*ec,F[7]=eT*eg-ey*ec-eb*ep-ew*e_,F},tF.rotateByQuatPrepend=function(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=eh[0],eb=eh[1],ew=eh[2],eT=eh[3];return F[0]=ec*eT+eg*ey+ep*ew-e_*eb,F[1]=ep*eT+eg*eb+e_*ey-ec*ew,F[2]=e_*eT+eg*ew+ec*eb-ep*ey,F[3]=eg*eT-ec*ey-ep*eb-e_*ew,F[4]=ec*(eT=eh[7])+eg*(ey=eh[4])+ep*(ew=eh[6])-e_*(eb=eh[5]),F[5]=ep*eT+eg*eb+e_*ey-ec*ew,F[6]=e_*eT+eg*ew+ec*eb-ep*ey,F[7]=eg*eT-ec*ey-ep*eb-e_*ew,F},tF.rotateAroundAxis=function(el,eh,ec,ep){if(Math.abs(ep)<F.EPSILON)return l(el,eh);var e_=Math.hypot(ec[0],ec[1],ec[2]),eg=Math.sin(ep*=.5),ey=eg*ec[0]/e_,eb=eg*ec[1]/e_,ew=eg*ec[2]/e_,eT=Math.cos(ep),eS=eh[0],eE=eh[1],eM=eh[2],eI=eh[3];el[0]=eS*eT+eI*ey+eE*ew-eM*eb,el[1]=eE*eT+eI*eb+eM*ey-eS*ew,el[2]=eM*eT+eI*ew+eS*eb-eE*ey,el[3]=eI*eT-eS*ey-eE*eb-eM*ew;var eA=eh[4],eC=eh[5],eP=eh[6],ez=eh[7];return el[4]=eA*eT+ez*ey+eC*ew-eP*eb,el[5]=eC*eT+ez*eb+eP*ey-eA*ew,el[6]=eP*eT+ez*ew+eA*eb-eC*ey,el[7]=ez*eT-eA*ey-eC*eb-eP*ew,el},tF.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F[2]=el[2]+eh[2],F[3]=el[3]+eh[3],F[4]=el[4]+eh[4],F[5]=el[5]+eh[5],F[6]=el[6]+eh[6],F[7]=el[7]+eh[7],F},tF.multiply=u,tF.scale=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F[2]=el[2]*eh,F[3]=el[3]*eh,F[4]=el[4]*eh,F[5]=el[5]*eh,F[6]=el[6]*eh,F[7]=el[7]*eh,F},tF.lerp=function(F,el,eh,ep){var e_=1-ep;return 0>ec(el,eh)&&(ep=-ep),F[0]=el[0]*e_+eh[0]*ep,F[1]=el[1]*e_+eh[1]*ep,F[2]=el[2]*e_+eh[2]*ep,F[3]=el[3]*e_+eh[3]*ep,F[4]=el[4]*e_+eh[4]*ep,F[5]=el[5]*e_+eh[5]*ep,F[6]=el[6]*e_+eh[6]*ep,F[7]=el[7]*e_+eh[7]*ep,F},tF.invert=function(F,el){var eh=e_(el);return F[0]=-el[0]/eh,F[1]=-el[1]/eh,F[2]=-el[2]/eh,F[3]=el[3]/eh,F[4]=-el[4]/eh,F[5]=-el[5]/eh,F[6]=-el[6]/eh,F[7]=el[7]/eh,F},tF.conjugate=function(F,el){return F[0]=-el[0],F[1]=-el[1],F[2]=-el[2],F[3]=el[3],F[4]=-el[4],F[5]=-el[5],F[6]=-el[6],F[7]=el[7],F},tF.normalize=function(F,el){var eh=e_(el);if(eh>0){eh=Math.sqrt(eh);var ec=el[0]/eh,ep=el[1]/eh,eg=el[2]/eh,ey=el[3]/eh,eb=el[4],ew=el[5],eT=el[6],eS=el[7],eE=ec*eb+ep*ew+eg*eT+ey*eS;F[0]=ec,F[1]=ep,F[2]=eg,F[3]=ey,F[4]=(eb-ec*eE)/eh,F[5]=(ew-ep*eE)/eh,F[6]=(eT-eg*eE)/eh,F[7]=(eS-ey*eE)/eh}return F},tF.str=function(F){return"quat2("+F[0]+", "+F[1]+", "+F[2]+", "+F[3]+", "+F[4]+", "+F[5]+", "+F[6]+", "+F[7]+")"},tF.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]&&F[2]===el[2]&&F[3]===el[3]&&F[4]===el[4]&&F[5]===el[5]&&F[6]===el[6]&&F[7]===el[7]},tF.equals=function(el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=el[4],eb=el[5],ew=el[6],eT=el[7],eS=eh[0],eE=eh[1],eM=eh[2],eI=eh[3],eA=eh[4],eC=eh[5],eP=eh[6],ez=eh[7];return Math.abs(ec-eS)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(eS))&&Math.abs(ep-eE)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eE))&&Math.abs(e_-eM)<=F.EPSILON*Math.max(1,Math.abs(e_),Math.abs(eM))&&Math.abs(eg-eI)<=F.EPSILON*Math.max(1,Math.abs(eg),Math.abs(eI))&&Math.abs(ey-eA)<=F.EPSILON*Math.max(1,Math.abs(ey),Math.abs(eA))&&Math.abs(eb-eC)<=F.EPSILON*Math.max(1,Math.abs(eb),Math.abs(eC))&&Math.abs(ew-eP)<=F.EPSILON*Math.max(1,Math.abs(ew),Math.abs(eP))&&Math.abs(eT-ez)<=F.EPSILON*Math.max(1,Math.abs(eT),Math.abs(ez))},tF.sqrLen=tF.squaredLength=tF.len=tF.length=tF.dot=tF.mul=tF.setReal=tF.getReal=void 0;var F=a(s()),el=a(S()),eh=a(g());function i(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(i=function(F){return F?eh:el})(F)}function a(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=i(el);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}function o(F,el,eh){var ec=.5*eh[0],ep=.5*eh[1],e_=.5*eh[2],eg=el[0],ey=el[1],eb=el[2],ew=el[3];return F[0]=eg,F[1]=ey,F[2]=eb,F[3]=ew,F[4]=ec*ew+ep*eb-e_*ey,F[5]=ep*ew+e_*eg-ec*eb,F[6]=e_*ew+ec*ey-ep*eg,F[7]=-ec*eg-ep*ey-e_*eb,F}function l(F,el){return F[0]=el[0],F[1]=el[1],F[2]=el[2],F[3]=el[3],F[4]=el[4],F[5]=el[5],F[6]=el[6],F[7]=el[7],F}function u(F,el,eh){var ec=el[0],ep=el[1],e_=el[2],eg=el[3],ey=eh[4],eb=eh[5],ew=eh[6],eT=eh[7],eS=el[4],eE=el[5],eM=el[6],eI=el[7],eA=eh[0],eC=eh[1],eP=eh[2],ez=eh[3];return F[0]=ec*ez+eg*eA+ep*eP-e_*eC,F[1]=ep*ez+eg*eC+e_*eA-ec*eP,F[2]=e_*ez+eg*eP+ec*eC-ep*eA,F[3]=eg*ez-ec*eA-ep*eC-e_*eP,F[4]=ec*eT+eg*ey+ep*ew-e_*eb+eS*ez+eI*eA+eE*eP-eM*eC,F[5]=ep*eT+eg*eb+e_*ey-ec*ew+eE*ez+eI*eC+eM*eA-eS*eP,F[6]=e_*eT+eg*ew+ec*eb-ep*ey+eM*ez+eI*eP+eS*eC-eE*eA,F[7]=eg*eT-ec*ey-ep*eb-e_*ew+eI*ez-eS*eA-eE*eC-eM*eP,F}tF.getReal=el.copy,tF.setReal=el.copy,tF.mul=u;var ec=el.dot;tF.dot=ec;var ep=el.length;tF.length=ep,tF.len=ep;var e_=el.squaredLength;return tF.squaredLength=e_,tF.sqrLen=e_,tF}());tn.quat2=eg;var ey=x(function(){if(tz)return tB;function t(F){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(F){return typeof F}:function(F){return F&&"function"==typeof Symbol&&F.constructor===Symbol&&F!==Symbol.prototype?"symbol":typeof F})(F)}tz=1,Object.defineProperty(tB,"__esModule",{value:!0}),tB.create=n,tB.clone=function(el){var eh=new F.ARRAY_TYPE(2);return eh[0]=el[0],eh[1]=el[1],eh},tB.fromValues=function(el,eh){var ec=new F.ARRAY_TYPE(2);return ec[0]=el,ec[1]=eh,ec},tB.copy=function(F,el){return F[0]=el[0],F[1]=el[1],F},tB.set=function(F,el,eh){return F[0]=el,F[1]=eh,F},tB.add=function(F,el,eh){return F[0]=el[0]+eh[0],F[1]=el[1]+eh[1],F},tB.subtract=i,tB.multiply=a,tB.divide=o,tB.ceil=function(F,el){return F[0]=Math.ceil(el[0]),F[1]=Math.ceil(el[1]),F},tB.floor=function(F,el){return F[0]=Math.floor(el[0]),F[1]=Math.floor(el[1]),F},tB.min=function(F,el,eh){return F[0]=Math.min(el[0],eh[0]),F[1]=Math.min(el[1],eh[1]),F},tB.max=function(F,el,eh){return F[0]=Math.max(el[0],eh[0]),F[1]=Math.max(el[1],eh[1]),F},tB.round=function(F,el){return F[0]=Math.round(el[0]),F[1]=Math.round(el[1]),F},tB.scale=function(F,el,eh){return F[0]=el[0]*eh,F[1]=el[1]*eh,F},tB.scaleAndAdd=function(F,el,eh,ec){return F[0]=el[0]+eh[0]*ec,F[1]=el[1]+eh[1]*ec,F},tB.distance=l,tB.squaredDistance=u,tB.length=c,tB.squaredLength=h,tB.negate=function(F,el){return F[0]=-el[0],F[1]=-el[1],F},tB.inverse=function(F,el){return F[0]=1/el[0],F[1]=1/el[1],F},tB.normalize=function(F,el){var eh=el[0],ec=el[1],ep=eh*eh+ec*ec;return ep>0&&(ep=1/Math.sqrt(ep)),F[0]=el[0]*ep,F[1]=el[1]*ep,F},tB.dot=function(F,el){return F[0]*el[0]+F[1]*el[1]},tB.cross=function(F,el,eh){var ec=el[0]*eh[1]-el[1]*eh[0];return F[0]=F[1]=0,F[2]=ec,F},tB.lerp=function(F,el,eh,ec){var ep=el[0],e_=el[1];return F[0]=ep+ec*(eh[0]-ep),F[1]=e_+ec*(eh[1]-e_),F},tB.random=function(el,eh){eh=eh||1;var ec=2*F.RANDOM()*Math.PI;return el[0]=Math.cos(ec)*eh,el[1]=Math.sin(ec)*eh,el},tB.transformMat2=function(F,el,eh){var ec=el[0],ep=el[1];return F[0]=eh[0]*ec+eh[2]*ep,F[1]=eh[1]*ec+eh[3]*ep,F},tB.transformMat2d=function(F,el,eh){var ec=el[0],ep=el[1];return F[0]=eh[0]*ec+eh[2]*ep+eh[4],F[1]=eh[1]*ec+eh[3]*ep+eh[5],F},tB.transformMat3=function(F,el,eh){var ec=el[0],ep=el[1];return F[0]=eh[0]*ec+eh[3]*ep+eh[6],F[1]=eh[1]*ec+eh[4]*ep+eh[7],F},tB.transformMat4=function(F,el,eh){var ec=el[0],ep=el[1];return F[0]=eh[0]*ec+eh[4]*ep+eh[12],F[1]=eh[1]*ec+eh[5]*ep+eh[13],F},tB.rotate=function(F,el,eh,ec){var ep=el[0]-eh[0],e_=el[1]-eh[1],eg=Math.sin(ec),ey=Math.cos(ec);return F[0]=ep*ey-e_*eg+eh[0],F[1]=ep*eg+e_*ey+eh[1],F},tB.angle=function(F,el){var eh=F[0],ec=F[1],ep=el[0],e_=el[1],eg=Math.sqrt(eh*eh+ec*ec)*Math.sqrt(ep*ep+e_*e_);return Math.acos(Math.min(Math.max(eg&&(eh*ep+ec*e_)/eg,-1),1))},tB.zero=function(F){return F[0]=0,F[1]=0,F},tB.str=function(F){return"vec2("+F[0]+", "+F[1]+")"},tB.exactEquals=function(F,el){return F[0]===el[0]&&F[1]===el[1]},tB.equals=function(el,eh){var ec=el[0],ep=el[1],e_=eh[0],eg=eh[1];return Math.abs(ec-e_)<=F.EPSILON*Math.max(1,Math.abs(ec),Math.abs(e_))&&Math.abs(ep-eg)<=F.EPSILON*Math.max(1,Math.abs(ep),Math.abs(eg))},tB.forEach=tB.sqrLen=tB.sqrDist=tB.dist=tB.div=tB.mul=tB.sub=tB.len=void 0;var F=function(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=r(void 0);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}(s());function r(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(r=function(F){return F?eh:el})(F)}function n(){var el=new F.ARRAY_TYPE(2);return F.ARRAY_TYPE!=Float32Array&&(el[0]=0,el[1]=0),el}function i(F,el,eh){return F[0]=el[0]-eh[0],F[1]=el[1]-eh[1],F}function a(F,el,eh){return F[0]=el[0]*eh[0],F[1]=el[1]*eh[1],F}function o(F,el,eh){return F[0]=el[0]/eh[0],F[1]=el[1]/eh[1],F}function l(F,el){return Math.hypot(el[0]-F[0],el[1]-F[1])}function u(F,el){var eh=el[0]-F[0],ec=el[1]-F[1];return eh*eh+ec*ec}function c(F){return Math.hypot(F[0],F[1])}function h(F){var el=F[0],eh=F[1];return el*el+eh*eh}tB.len=c,tB.sub=i,tB.mul=a,tB.div=o,tB.dist=l,tB.sqrDist=u,tB.sqrLen=h;var el,eh=(el=n(),function(F,eh,ec,ep,e_,eg){var ey,eb;for(eh||(eh=2),ec||(ec=0),eb=ep?Math.min(ep*eh+ec,F.length):F.length,ey=ec;ey<eb;ey+=eh)el[0]=F[ey],el[1]=F[ey+1],e_(el,el,eg),F[ey]=el[0],F[ey+1]=el[1];return F});return tB.forEach=eh,tB}());tn.vec2=ey;var eb=x(_());tn.vec3=eb;var ew=x(I());function y(F){if("function"!=typeof WeakMap)return null;var el=new WeakMap,eh=new WeakMap;return(y=function(F){return F?eh:el})(F)}function x(F,el){if(F&&F.__esModule)return F;if(null===F||"object"!==t(F)&&"function"!=typeof F)return{default:F};var eh=y(el);if(eh&&eh.has(F))return eh.get(F);var ec={},ep=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e_ in F)if("default"!==e_&&Object.prototype.hasOwnProperty.call(F,e_)){var eg=ep?Object.getOwnPropertyDescriptor(F,e_):null;eg&&(eg.get||eg.set)?Object.defineProperty(ec,e_,eg):ec[e_]=F[e_]}return ec.default=F,eh&&eh.set(F,ec),ec}return tn.vec4=ew,tn}(),tV=e(function(){if(tL)return tR;function t(F,el,eh,ec){this.cx=3*F,this.bx=3*(eh-F)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*el,this.by=3*(ec-el)-this.cy,this.ay=1-this.cy-this.by,this.p1x=F,this.p1y=el,this.p2x=eh,this.p2y=ec}return tL=1,tR=t,t.prototype={sampleCurveX:function(F){return((this.ax*F+this.bx)*F+this.cx)*F},sampleCurveY:function(F){return((this.ay*F+this.by)*F+this.cy)*F},sampleCurveDerivativeX:function(F){return(3*this.ax*F+2*this.bx)*F+this.cx},solveCurveX:function(F,el){if(void 0===el&&(el=1e-6),F<0)return 0;if(F>1)return 1;for(var eh=F,ec=0;ec<8;ec++){var ep=this.sampleCurveX(eh)-F;if(Math.abs(ep)<el)return eh;var e_=this.sampleCurveDerivativeX(eh);if(1e-6>Math.abs(e_))break;eh-=ep/e_}var eg=0,ey=1;for(eh=F,ec=0;ec<20&&!(Math.abs((ep=this.sampleCurveX(eh))-F)<el);ec++)F>ep?eg=eh:ey=eh,eh=.5*(ey-eg)+eg;return eh},solve:function(F,el){return this.sampleCurveY(this.solveCurveX(F,el))}},tR}());function j(){if(tk)return tO;function t(F,el){this.x=F,this.y=el}return tk=1,tO=t,t.prototype={clone:function(){return new t(this.x,this.y)},add:function(F){return this.clone()._add(F)},sub:function(F){return this.clone()._sub(F)},multByPoint:function(F){return this.clone()._multByPoint(F)},divByPoint:function(F){return this.clone()._divByPoint(F)},mult:function(F){return this.clone()._mult(F)},div:function(F){return this.clone()._div(F)},rotate:function(F){return this.clone()._rotate(F)},rotateAround:function(F,el){return this.clone()._rotateAround(F,el)},matMult:function(F){return this.clone()._matMult(F)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(F){return this.x===F.x&&this.y===F.y},dist:function(F){return Math.sqrt(this.distSqr(F))},distSqr:function(F){var el=F.x-this.x,eh=F.y-this.y;return el*el+eh*eh},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(F){return Math.atan2(this.y-F.y,this.x-F.x)},angleWith:function(F){return this.angleWithSep(F.x,F.y)},angleWithSep:function(F,el){return Math.atan2(this.x*el-this.y*F,this.x*F+this.y*el)},_matMult:function(F){var el=F[2]*this.x+F[3]*this.y;return this.x=F[0]*this.x+F[1]*this.y,this.y=el,this},_add:function(F){return this.x+=F.x,this.y+=F.y,this},_sub:function(F){return this.x-=F.x,this.y-=F.y,this},_mult:function(F){return this.x*=F,this.y*=F,this},_div:function(F){return this.x/=F,this.y/=F,this},_multByPoint:function(F){return this.x*=F.x,this.y*=F.y,this},_divByPoint:function(F){return this.x/=F.x,this.y/=F.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var F=this.y;return this.y=this.x,this.x=-F,this},_rotate:function(F){var el=Math.cos(F),eh=Math.sin(F),ec=eh*this.x+el*this.y;return this.x=el*this.x-eh*this.y,this.y=ec,this},_rotateAround:function(F,el){var eh=Math.cos(F),ec=Math.sin(F),ep=el.y+ec*(this.x-el.x)+eh*(this.y-el.y);return this.x=el.x+eh*(this.x-el.x)-ec*(this.y-el.y),this.y=ep,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},t.convert=function(F){return F instanceof t?F:Array.isArray(F)?new t(F[0],F[1]):F},tO}var tU=e(j());function $(F,el){if(Array.isArray(F)){if(!Array.isArray(el)||F.length!==el.length)return!1;for(let eh=0;eh<F.length;eh++)if(!$(F[eh],el[eh]))return!1;return!0}if("object"==typeof F&&null!==F&&null!==el){if("object"!=typeof el||Object.keys(F).length!==Object.keys(el).length)return!1;for(let eh in F)if(!$(F[eh],el[eh]))return!1;return!0}return F===el}let tj=Math.PI/180,tG=180/Math.PI,tq=[[0,0],[1,0],[1,1],[0,1]];function W(F){if(F<=0)return 0;if(F>=1)return 1;let el=F*F,eh=el*F;return 4*(F<.5?eh:3*(F-el)+eh-.75)}function K(F,el,eh,ec){let ep=new tV(F,el,eh,ec);return function(F){return ep.solve(F)}}let t$=K(.25,.1,.25,1);function Q(F,el,eh){return Math.min(eh,Math.max(el,F))}function tt(F,el,eh){return(eh=Q((eh-F)/(el-F),0,1))*eh*(3-2*eh)}function et(F,el,eh){let ec=eh-el,ep=((F-el)%ec+ec)%ec+el;return ep===el?eh:ep}function rt(F,el,eh){if(!F.length)return eh(null,[]);let ec=F.length,ep=Array(F.length),e_=null;F.forEach((F,eg)=>{el(F,(F,el)=>{F&&(e_=F),ep[eg]=el,0==--ec&&eh(e_,ep)})})}function nt(F,...el){for(let eh of el)for(let el in eh)F[el]=eh[el];return F}let tH=1;function st(){return tH++}function at(F){return F<=1?1:Math.pow(2,Math.ceil(Math.log(F)/Math.LN2))}function ot(F,el){F.forEach(F=>{el[F]&&(el[F]=el[F].bind(el))})}function lt(F,el,eh){let ec={};for(let eh in F)ec[eh]=el.call(this,F[eh],eh,F);return ec}function ut(F,el,eh){let ec={};for(let eh in F)el.call(this,F[eh],eh,F)&&(ec[eh]=F[eh]);return ec}function ct(F){return Array.isArray(F)?F.map(ct):"object"==typeof F&&F?lt(F,ct):F}let tZ={};function pt(F){tZ[F]||("undefined"!=typeof console&&console.warn(F),tZ[F]=!0)}function ft(F,el,eh){return(eh.y-F.y)*(el.x-F.x)>(el.y-F.y)*(eh.x-F.x)}function mt([F,el,eh]){let ec=(el+90)*tj,ep=eh*tj;return{x:F*Math.cos(ec)*Math.sin(ep),y:F*Math.sin(ec)*Math.sin(ep),z:F*Math.cos(ep),azimuthal:el,polar:eh}}function yt(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}function gt(F){let el={};if(F.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(F,eh,ec,ep)=>{let e_=ec||ep;return el[eh]=!e_||e_.toLowerCase(),""}),el["max-age"]){let F=parseInt(el["max-age"],10);isNaN(F)?delete el["max-age"]:el["max-age"]=F}return el}let tW=null;function vt(F,el){return[F[4*el],F[4*el+1],F[4*el+2],F[4*el+3]]}function bt(F,el,eh,ec){for(;el<eh;){let ep=el+eh>>1;F[ep]<ec?el=ep+1:eh=ep}return el}function _t(F,el,eh,ec){for(;el<eh;){let ep=el+eh>>1;F[ep]<=ec?el=ep+1:eh=ep}return el}function wt(F){return F>0?1/(1.001-F):1+F}function Mt(F){return F>0?1-1/(1.001-F):-F}let tY={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!tY.API_URL)return null;try{let F=new URL(tY.API_URL);return"api.mapbox.cn"===F.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===F.hostname?"https://events.mapbox.com/events/v2":null}catch(F){return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function It(F){return tY.API_URL_REGEX.test(F)}function St(F){return tY.API_SPRITE_REGEX.test(F)}function Vt(){return null==el&&(el=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),el}let tX={now:()=>void 0!==ep?ep:performance.now(),setNow(F){ep=F},restoreNow(){ep=void 0},frame(F){let el=requestAnimationFrame(F);return{cancel:()=>cancelAnimationFrame(el)}},getImageData(F,el=0){let{width:eh,height:ec}=F;e_||(e_=document.createElement("canvas"));let ep=e_.getContext("2d",{willReadFrequently:!0});if(!ep)throw Error("failed to create canvas 2d context");return(eh>e_.width||ec>e_.height)&&(e_.width=eh,e_.height=ec),ep.clearRect(-el,-el,eh+2*el,ec+2*el),ep.drawImage(F,0,0,eh,ec),ep.getImageData(-el,-el,eh+2*el,ec+2*el)},resolveURL:F=>(eh||(eh=document.createElement("a")),eh.href=F,eh.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==ec&&(ec=window.matchMedia("(prefers-reduced-motion: reduce)")),ec.matches)},hasCanvasFingerprintNoise(){if(void 0!==eg)return eg;if(!Vt())return eg=!1,!1;let F=new OffscreenCanvas(85,1),el=F.getContext("2d",{willReadFrequently:!0}),eh=0;for(let ec=0;ec<F.width;++ec)el.fillStyle=`rgba(${eh++},${eh++},${eh++}, 255)`,el.fillRect(ec,0,1,1);let ec=el.getImageData(0,0,F.width,F.height);eh=0;for(let F=0;F<ec.data.length;++F)if(F%4!=3&&eh++!==ec.data[F])return eg=!0,!0;return eg=!1,!1}};function Dt(F,el){let eh=F.indexOf("?");if(eh<0)return`${F}?${new URLSearchParams(el).toString()}`;let ec=new URLSearchParams(F.slice(eh));for(let F in el)ec.set(F,el[F]);return`${F.slice(0,eh)}?${ec.toString()}`}function Rt(F,el={persistentParams:[]}){let eh=F.indexOf("?");if(eh<0)return F;let ec=new URLSearchParams,ep=new URLSearchParams(F.slice(eh));for(let F of el.persistentParams){let el=ep.get(F);el&&ec.set(F,el)}let e_=ec.toString();return`${F.slice(0,eh)}${e_.length>0?`?${e_}`:""}`}let tK="mapbox-tiles",tJ=500,tQ=50,t0=["language","worldview","jobid"];function qt(){try{return caches}catch(F){}}function $t(){let F=qt();F&&null==ey&&(ey=F.open(tK))}let t1=1/0,t2={supported:!1,testSupport:function(F){!t5&&t4&&(t6?Jt(F):t3=F)}},t3,t4,t5=!1,t6=!1,t8="undefined"!=typeof self?self:{};function Jt(F){let el=F.createTexture();F.bindTexture(F.TEXTURE_2D,el);try{if(F.texImage2D(F.TEXTURE_2D,0,F.RGBA,F.RGBA,F.UNSIGNED_BYTE,t4),F.isContextLost())return;t2.supported=!0}catch(F){}F.deleteTexture(el),t5=!0}t8.document&&((t4=t8.document.createElement("img")).onload=function(){t3&&Jt(t3),t3=null,t6=!0},t4.onerror=function(){t5=!0,t3=null},t4.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");let t9={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(t9);let te=class te extends Error{constructor(F,el,eh){401===el&&It(eh)&&(F+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(F),this.status=el,this.url=eh}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}};let t7=yt()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href,re=function(F,el){var eh;if(!(/^file:/.test(eh=F.url)||/^file:/.test(t7())&&!/^\w+:/.test(eh))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(F,el){var eh;let ec=new AbortController,ep=new Request(F.url,{method:F.method||"GET",body:F.body,credentials:F.credentials,headers:F.headers,referrer:t7(),referrerPolicy:F.referrerPolicy,signal:ec.signal}),e_=!1,eg=!1,ew=(eh=ep.url).indexOf("sku=")>0&&It(eh);"json"===F.type&&ep.headers.set("Accept","application/json");let l=(eh,ec,e_)=>{if(eg)return;if(eh&&"SecurityError"!==eh.message&&pt(eh.toString()),ec&&e_)return u(ec);let ey=Date.now();fetch(ep).then(eh=>{if(eh.ok){let F=ew?eh.clone():null;return u(eh,F,ey)}return el(new te(eh.statusText,eh.status,F.url))}).catch(eh=>{"AbortError"!==eh.name&&el(Error(`${eh.message} ${F.url}`))})},u=(eh,ec,ew)=>{("arrayBuffer"===F.type?eh.arrayBuffer():"json"===F.type?eh.json():eh.text()).then(F=>{eg||(ec&&ew&&function(F,el,eh){if($t(),null==ey)return;let ec=gt(el.headers.get("Cache-Control")||"");if(ec["no-store"])return;let ep={status:el.status,statusText:el.statusText,headers:new Headers};el.headers.forEach((F,el)=>ep.headers.set(el,F)),ec["max-age"]&&ep.headers.set("Expires",new Date(eh+1e3*ec["max-age"]).toUTCString());let e_=ep.headers.get("Expires");if(!e_||new Date(e_).getTime()-eh<42e4)return;let eg=Rt(F.url,{persistentParams:t0});if(206===el.status){let el=F.headers.get("Range");if(!el)return;ep.status=200,eg=Dt(eg,{range:el})}!function(F,el){if(void 0===eb)try{new Response(new ReadableStream),eb=!0}catch(F){eb=!1}eb?el(F.body):F.blob().then(el)}(el,F=>{var eh;let ec=new Response(200!==(eh=el.status)&&404!==eh&&[101,103,204,205,304].includes(eh)?null:F,ep);$t(),null!=ey&&ey.then(F=>F.put(eg,ec)).catch(F=>pt(F.message))})}(ep,ec,ew),e_=!0,el(null,F,eh.headers.get("Cache-Control"),eh.headers.get("Expires")))}).catch(F=>{eg||el(Error(F.message))})};return ew?function(F,el){if($t(),null==ey)return el(null);ey.then(eh=>{let ec=Rt(F.url,{persistentParams:t0}),ep=F.headers.get("Range");ep&&(ec=Dt(ec,{range:ep})),eh.match(ec).then(F=>{let ep=function(F){if(!F)return!1;let el=new Date(F.headers.get("Expires")||0),eh=gt(F.headers.get("Cache-Control")||"");return el>Date.now()&&!eh["no-cache"]}(F);eh.delete(ec),ep&&eh.put(ec,F.clone()),el(null,F,ep)}).catch(el)}).catch(el)}(ep,l):l(null,null),{cancel:()=>{eg=!0,e_||ec.abort()}}}(F,el);if(yt()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",F,el,void 0,!0)}return function(F,el){let eh=new XMLHttpRequest;for(let el in eh.open(F.method||"GET",F.url,!0),"arrayBuffer"===F.type&&(eh.responseType="arraybuffer"),F.headers)eh.setRequestHeader(el,F.headers[el]);return"json"===F.type&&(eh.responseType="text",eh.setRequestHeader("Accept","application/json")),eh.withCredentials="include"===F.credentials,eh.onerror=()=>{el(Error(eh.statusText))},eh.onload=()=>{if((eh.status>=200&&eh.status<300||0===eh.status)&&null!==eh.response){let ec=eh.response;if("json"===F.type)try{ec=JSON.parse(eh.response)}catch(F){return el(F)}el(null,ec,eh.getResponseHeader("Cache-Control"),eh.getResponseHeader("Expires"))}else el(new te(eh.statusText,eh.status,F.url))},eh.send(F.body),{cancel:()=>eh.abort()}}(F,el)},ne=function(F,el){return re(nt(F,{type:"arrayBuffer"}),el)},iu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";ew=[],eT=0;let le=function(F,el){if(t2.supported&&(F.headers||(F.headers={}),F.headers.accept="image/webp,*/*"),eT>=tY.MAX_PARALLEL_IMAGE_REQUESTS){let eh={requestParameters:F,callback:el,cancelled:!1,cancel(){this.cancelled=!0}};return ew.push(eh),eh}eT++;let eh=!1,n=()=>{if(!eh)for(eh=!0,eT--;ew.length&&eT<tY.MAX_PARALLEL_IMAGE_REQUESTS;){let F=ew.shift(),{requestParameters:el,callback:eh,cancelled:ec}=F;ec||(F.cancel=le(el,eh).cancel)}},ec=ne(F,(F,eh,ec,ep)=>{n(),F?el(F):eh&&(self.createImageBitmap?function(F,el){let eh=new Blob([new Uint8Array(F)],{type:"image/png"});createImageBitmap(eh).then(F=>{el(null,F)}).catch(F=>{el(Error(`Could not load image because of ${F.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(eh,(F,eh)=>el(F,eh,ec,ep)):function(F,el){let eh=new Image;eh.onload=()=>{el(null,eh),URL.revokeObjectURL(eh.src),eh.onload=null,requestAnimationFrame(()=>{eh.src=iu})},eh.onerror=()=>el(Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));let ec=new Blob([new Uint8Array(F)],{type:"image/png"});eh.src=F.byteLength?URL.createObjectURL(ec):iu}(eh,(F,eh)=>el(F,eh,ec,ep)))});return{cancel:()=>{ec.cancel(),n()}}};var ic,id,ip,im={exports:{}},i_={exports:{}},ig={exports:{}},iv=e(function(){if(ip)return im.exports;ip=1;var F=(ic||(ic=1,i_.exports=function(F,el){var eh,ec,ep,e_,eg,ey;for(ec=F.length-(eh=3&F.length),ep=el,ey=0;ey<ec;)eg=255&F.charCodeAt(ey)|(255&F.charCodeAt(++ey))<<8|(255&F.charCodeAt(++ey))<<16|(255&F.charCodeAt(++ey))<<24,++ey,ep=27492+(65535&(e_=5*(65535&(ep=(ep^=eg=(65535&(eg=(eg=(65535&eg)*3432918353+(((eg>>>16)*3432918353&65535)<<16)&4294967295)<<15|eg>>>17))*461845907+(((eg>>>16)*461845907&65535)<<16)&4294967295)<<13|ep>>>19))+((5*(ep>>>16)&65535)<<16)&4294967295))+((58964+(e_>>>16)&65535)<<16);switch(eg=0,eh){case 3:eg^=(255&F.charCodeAt(ey+2))<<16;case 2:eg^=(255&F.charCodeAt(ey+1))<<8;case 1:ep^=eg=(65535&(eg=(eg=(65535&(eg^=255&F.charCodeAt(ey)))*3432918353+(((eg>>>16)*3432918353&65535)<<16)&4294967295)<<15|eg>>>17))*461845907+(((eg>>>16)*461845907&65535)<<16)&4294967295}return ep^=F.length,ep=2246822507*(65535&(ep^=ep>>>16))+((2246822507*(ep>>>16)&65535)<<16)&4294967295,ep=3266489909*(65535&(ep^=ep>>>13))+((3266489909*(ep>>>16)&65535)<<16)&4294967295,(ep^=ep>>>16)>>>0}),i_.exports),el=(id||(id=1,ig.exports=function(F,el){for(var eh,ec=F.length,ep=el^ec,e_=0;ec>=4;)eh=1540483477*(65535&(eh=255&F.charCodeAt(e_)|(255&F.charCodeAt(++e_))<<8|(255&F.charCodeAt(++e_))<<16|(255&F.charCodeAt(++e_))<<24))+((1540483477*(eh>>>16)&65535)<<16),ep=1540483477*(65535&ep)+((1540483477*(ep>>>16)&65535)<<16)^(eh=1540483477*(65535&(eh^=eh>>>24))+((1540483477*(eh>>>16)&65535)<<16)),ec-=4,++e_;switch(ec){case 3:ep^=(255&F.charCodeAt(e_+2))<<16;case 2:ep^=(255&F.charCodeAt(e_+1))<<8;case 1:ep=1540483477*(65535&(ep^=255&F.charCodeAt(e_)))+((1540483477*(ep>>>16)&65535)<<16)}return ep=1540483477*(65535&(ep^=ep>>>13))+((1540483477*(ep>>>16)&65535)<<16),(ep^=ep>>>15)>>>0}),ig.exports);return im.exports=F,im.exports.murmur3=F,im.exports.murmur2=el,im.exports}());let ge=class ge{constructor(F,...el){nt(this,el[0]||{}),this.type=F}};let xe=class xe extends ge{constructor(F,el={}){super("error",nt({error:F},el))}};function ve(F,el,eh){eh[F]&&-1!==eh[F].indexOf(el)||(eh[F]=eh[F]||[],eh[F].push(el))}function be(F,el,eh){if(eh&&eh[F]){let ec=eh[F].indexOf(el);-1!==ec&&eh[F].splice(ec,1)}}let _e=class _e{on(F,el){return this._listeners=this._listeners||{},ve(F,el,this._listeners),this}off(F,el){return be(F,el,this._listeners),be(F,el,this._oneTimeListeners),this}once(F,el){return el?(this._oneTimeListeners=this._oneTimeListeners||{},ve(F,el,this._oneTimeListeners),this):new Promise(el=>{this.once(F,el)})}fire(F,el){let eh="string"==typeof F?new ge(F,el):F,ec=eh.type;if(this.listens(ec)){eh.target=this;let F=this._listeners&&this._listeners[ec]?this._listeners[ec].slice():[];for(let el of F)el.call(this,eh);let el=this._oneTimeListeners&&this._oneTimeListeners[ec]?this._oneTimeListeners[ec].slice():[];for(let F of el)be(ec,F,this._oneTimeListeners),F.call(this,eh);let ep=this._eventedParent;ep&&(nt(eh,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),ep.fire(eh))}else eh instanceof xe&&console.error(eh.error);return this}listens(F){return!!(this._listeners&&this._listeners[F]&&this._listeners[F].length>0||this._oneTimeListeners&&this._oneTimeListeners[F]&&this._oneTimeListeners[F].length>0||this._eventedParent&&this._eventedParent.listens(F))}setEventedParent(F,el){return this._eventedParent=F,this._eventedParentData=el,this}};let we=class we{constructor(F){"string"==typeof F?this.name=F:(this.name=F.name,this.iconsetId=F.iconsetId)}static from(F){return new we(F)}static toString(F){return F.iconsetId?`${F.name}${F.iconsetId}`:F.name}static parse(F){let[el,eh]=F.split("\x1f");return new we({name:el,iconsetId:eh})}static isEqual(F,el){return F.name===el.name&&F.iconsetId===el.iconsetId}toString(){return we.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}};var ib,iw={},iT=function(){if(ib)return iw;ib=1;var F={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(F){return(F=Math.round(F))<0?0:F>255?255:F}function r(F){return e("%"===F[F.length-1]?parseFloat(F)/100*255:parseInt(F))}function n(F){var el;return(el="%"===F[F.length-1]?parseFloat(F)/100:parseFloat(F))<0?0:el>1?1:el}function i(F,el,eh){return eh<0?eh+=1:eh>1&&(eh-=1),6*eh<1?F+(el-F)*eh*6:2*eh<1?el:3*eh<2?F+(el-F)*(2/3-eh)*6:F}try{iw.parseCSSColor=function(el){var eh,ec=el.replace(/ /g,"").toLowerCase();if(ec in F)return F[ec].slice();if("#"===ec[0])return 4===ec.length?(eh=parseInt(ec.substr(1),16))>=0&&eh<=4095?[(3840&eh)>>4|(3840&eh)>>8,240&eh|(240&eh)>>4,15&eh|(15&eh)<<4,1]:null:7===ec.length&&(eh=parseInt(ec.substr(1),16))>=0&&eh<=16777215?[(16711680&eh)>>16,(65280&eh)>>8,255&eh,1]:null;var ep=ec.indexOf("("),e_=ec.indexOf(")");if(-1!==ep&&e_+1===ec.length){var eg=ec.substr(0,ep),ey=ec.substr(ep+1,e_-(ep+1)).split(","),eb=1;switch(eg){case"rgba":if(4!==ey.length)break;eb=n(ey.pop());case"rgb":return 3!==ey.length?null:[r(ey[0]),r(ey[1]),r(ey[2]),eb];case"hsla":if(4!==ey.length)break;eb=n(ey.pop());case"hsl":if(3!==ey.length)break;var ew=(parseFloat(ey[0])%360+360)%360/360,eT=n(ey[1]),eS=n(ey[2]),eE=eS<=.5?eS*(eT+1):eS+eT-eS*eT,eM=2*eS-eE;return[e(255*i(eM,eE,ew+1/3)),e(255*i(eM,eE,ew)),e(255*i(eM,eE,ew-1/3)),eb]}}return null}}catch(F){}return iw}();let Se=class Se{constructor(F,el,eh,ec=1){this.r=F,this.g=el,this.b=eh,this.a=ec}static parse(F){if(!F)return;if(F instanceof Se)return F;if("string"!=typeof F)return;let el=iT.parseCSSColor(F);return el?new Se(el[0]/255*el[3],el[1]/255*el[3],el[2]/255*el[3],el[3]):void 0}toStringPremultipliedAlpha(){let[F,el,eh,ec]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(F)},${Math.round(el)},${Math.round(eh)},${ec})`}toString(){let[F,el,eh,ec]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*F)},${Math.round(255*el)},${Math.round(255*eh)},${ec})`}toRenderColor(F){let{r:el,g:eh,b:ec,a:ep}=this;return new Pe(F,el,eh,ec,ep)}clone(){return new Se(this.r,this.g,this.b,this.a)}};let Pe=class Pe{constructor(F,el,eh,ec,ep){if(F){let e_=F.image.height,eg=e_*e_;el=0===ep?0:el/ep*(e_-1),eh=0===ep?0:eh/ep*(e_-1),ec=0===ep?0:ec/ep*(e_-1);let ey=Math.floor(el),eb=Math.floor(eh),ew=Math.floor(ec),eT=Math.ceil(el),eS=Math.ceil(eh),eE=Math.ceil(ec),eM=el-ey,eI=eh-eb,eA=ec-ew,eC=F.image.data,eP=4*(ey+eb*eg+ew*e_),ez=4*(ey+eb*eg+eE*e_),eD=4*(ey+eS*eg+ew*e_),eR=4*(ey+eS*eg+eE*e_),eL=4*(eT+eb*eg+ew*e_),eO=4*(eT+eb*eg+eE*e_),ek=4*(eT+eS*eg+ew*e_),eF=4*(eT+eS*eg+eE*e_);if(eP<0||eF>=eC.length)throw Error("out of range");this.r=Ee(Ee(Ee(eC[eP],eC[ez],eA),Ee(eC[eD],eC[eR],eA),eI),Ee(Ee(eC[eL],eC[eO],eA),Ee(eC[ek],eC[eF],eA),eI),eM)/255*ep,this.g=Ee(Ee(Ee(eC[eP+1],eC[ez+1],eA),Ee(eC[eD+1],eC[eR+1],eA),eI),Ee(Ee(eC[eL+1],eC[eO+1],eA),Ee(eC[ek+1],eC[eF+1],eA),eI),eM)/255*ep,this.b=Ee(Ee(Ee(eC[eP+2],eC[ez+2],eA),Ee(eC[eD+2],eC[eR+2],eA),eI),Ee(Ee(eC[eL+2],eC[eO+2],eA),Ee(eC[ek+2],eC[eF+2],eA),eI),eM)/255*ep,this.a=ep}else this.r=el,this.g=eh,this.b=ec,this.a=ep}toArray(){let{r:F,g:el,b:eh,a:ec}=this;return 0===ec?[0,0,0,0]:[255*F/ec,255*el/ec,255*eh/ec,ec]}toHslaArray(){if(0===this.a)return[0,0,0,0];let{r:F,g:el,b:eh,a:ec}=this,ep=Math.min(Math.max(F/ec,0),1),e_=Math.min(Math.max(el/ec,0),1),eg=Math.min(Math.max(eh/ec,0),1),ey=Math.min(ep,e_,eg),eb=Math.max(ep,e_,eg),ew=(ey+eb)/2;if(ey===eb)return[0,0,100*ew,ec];let eT=eb-ey,eS=0;return eb===ep?eS=(e_-eg)/eT+(e_<eg?6:0):eb===e_?eS=(eg-ep)/eT+2:eb===eg&&(eS=(ep-e_)/eT+4),[Math.min(Math.max(eS*=60,0),360),Math.min(Math.max(100*(ew>.5?eT/(2-eb-ey):eT/(eb+ey)),0),100),Math.min(Math.max(100*ew,0),100),ec]}toArray01(){let{r:F,g:el,b:eh,a:ec}=this;return 0===ec?[0,0,0,0]:[F/ec,el/ec,eh/ec,ec]}toArray01Scaled(F){let{r:el,g:eh,b:ec,a:ep}=this;return 0===ep?[0,0,0]:[el/ep*F,eh/ep*F,ec/ep*F]}toArray01PremultipliedAlpha(){let{r:F,g:el,b:eh,a:ec}=this;return[F,el,eh,ec]}toArray01Linear(){let{r:F,g:el,b:eh,a:ec}=this;return 0===ec?[0,0,0,0]:[Math.pow(F/ec,2.2),Math.pow(el/ec,2.2),Math.pow(eh/ec,2.2),ec]}};function Ee(F,el,eh){return F*(1-eh)+el*eh}function ze(F,el,eh){return F.map((F,ec)=>Ee(F,el[ec],eh))}function ke(F){return F*F*F*F*F}Se.black=new Se(0,0,0,1),Se.white=new Se(1,1,1,1),Se.transparent=new Se(0,0,0,0),Se.red=new Se(1,0,0,1),Se.blue=new Se(0,0,1,1);var iS=Object.freeze({__proto__:null,array:ze,color:function(F,el,eh){return new Se(Ee(F.r,el.r,eh),Ee(F.g,el.g,eh),Ee(F.b,el.b,eh),Ee(F.a,el.a,eh))},easeIn:ke,number:Ee});function Be(F,...el){for(let eh of el)for(let el in eh)F[el]=eh[el];return F}let Ve=class Ve extends Error{constructor(F,el){super(el),this.message=el,this.key=F}};let Ce=class Ce{constructor(F,el=[]){for(let[eh,ec]of(this.parent=F,this.bindings={},el))this.bindings[eh]=ec}concat(F){return new Ce(this,F)}get(F){if(this.bindings[F])return this.bindings[F];if(this.parent)return this.parent.get(F);throw Error(`${F} not found in scope.`)}has(F){return!!this.bindings[F]||!!this.parent&&this.parent.has(F)}};let iE={kind:"null"},iM={kind:"number"},iI={kind:"string"},iA={kind:"boolean"},iC={kind:"color"},iP={kind:"object"},iz={kind:"value"},iD={kind:"collator"},iR={kind:"formatted"},iL={kind:"resolvedImage"};function Ge(F,el){return{kind:"array",itemType:F,N:el}}function Ye(F){if("array"===F.kind){let el=Ye(F.itemType);return"number"==typeof F.N?`array<${el}, ${F.N}>`:"value"===F.itemType.kind?"array":`array<${el}>`}return F.kind}let iO=[iE,iM,iI,iA,iC,iR,iP,Ge(iz),iL];function Xe(F,el){if("error"===el.kind)return null;if("array"===F.kind){if("array"===el.kind&&(0===el.N&&"value"===el.itemType.kind||!Xe(F.itemType,el.itemType))&&("number"!=typeof F.N||F.N===el.N))return null}else{if(F.kind===el.kind)return null;if("value"===F.kind){for(let F of iO)if(!Xe(F,el))return null}}return`Expected ${Ye(F)} but found ${Ye(el)} instead.`}function Ze(F,el){return el.some(el=>el.kind===F.kind)}function We(F,el){return el.some(el=>"null"===el?null===F:"array"===el?Array.isArray(F):"object"===el?F&&!Array.isArray(F)&&"object"==typeof F:el===typeof F)}let Ke=class Ke{constructor(F,el,eh){this.sensitivity=F?el?"variant":"case":el?"accent":"base",this.locale=eh,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(F,el){return this.collator.compare(F,el)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}};let Je=class Je{constructor(F,el,eh,ec,ep){this.text=F.normalize?F.normalize():F,this.image=el,this.scale=eh,this.fontStack=ec,this.textColor=ep}};let Qe=class Qe{constructor(F){this.sections=F}static fromString(F){return new Qe([new Je(F,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(F=>0!==F.text.length||!!F.image&&F.image.hasPrimary())}static factory(F){return F instanceof Qe?F:Qe.fromString(F)}toString(){return 0===this.sections.length?"":this.sections.map(F=>F.text).join("")}serialize(){let F=["format"];for(let el of this.sections){if(el.image){let eh=el.image.getPrimary().id.toString();F.push(["image",eh]);continue}F.push(el.text);let eh={};el.fontStack&&(eh["text-font"]=["literal",el.fontStack.split(",")]),el.scale&&(eh["font-scale"]=el.scale),el.textColor&&(eh["text-color"]=["rgba"].concat(el.textColor.toRenderColor(null).toArray())),F.push(eh)}return F}};let tr=class tr{constructor(F,el={}){if(this.id=we.from(F),this.options=Object.assign({},el),el.transform){let{a:F,b:eh,c:ec,d:ep,e:e_,f:eg}=el.transform;this.options.transform=new DOMMatrix([F,eh,ec,ep,e_,eg])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){let{a:F,b:el,c:eh,d:ec,e:ep,f:e_}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:F,b:el,c:eh,d:ec,e:ep,f:e_}})}static parse(F){let el,eh,ec,ep;try{({name:el,iconsetId:eh,params:ec,transform:ep}=JSON.parse(F)||{})}catch(F){return null}if(!el)return null;let{a:e_,b:eg,c:ey,d:eb,e:ew,f:eT}=ep||{};return new tr({name:el,iconsetId:eh},{params:ec,transform:new DOMMatrix([e_,eg,ey,eb,ew,eT])})}scaleSelf(F){return this.options.transform.scaleSelf(F),this}};let er=class er{constructor(F,el,eh,ec,ep=!1){this.primaryId=we.from(F),this.primaryOptions=el,eh&&(this.secondaryId=we.from(eh)),this.secondaryOptions=ec,this.available=ep}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new tr(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new tr(this.secondaryId,this.secondaryOptions):null}static from(F){return"string"==typeof F?er.build({name:F}):F}static build(F,el,eh,ec){return F&&("object"!=typeof F||"name"in F)?new er(F,eh,el,ec):null}};function rr(F,el,eh,ec){return"number"==typeof F&&F>=0&&F<=255&&"number"==typeof el&&el>=0&&el<=255&&"number"==typeof eh&&eh>=0&&eh<=255?void 0===ec||"number"==typeof ec&&ec>=0&&ec<=1?null:`Invalid rgba value [${[F,el,eh,ec].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof ec?[F,el,eh,ec]:[F,el,eh]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function nr(F){if(null===F||"string"==typeof F||"boolean"==typeof F||"number"==typeof F||F instanceof Se||F instanceof Ke||F instanceof Qe||F instanceof er)return!0;if(Array.isArray(F)){for(let el of F)if(!nr(el))return!1;return!0}if("object"==typeof F){for(let el in F)if(!nr(F[el]))return!1;return!0}return!1}function ir(F){if(null===F)return iE;if("string"==typeof F)return iI;if("boolean"==typeof F)return iA;if("number"==typeof F)return iM;if(F instanceof Se)return iC;if(F instanceof Ke)return iD;if(F instanceof Qe)return iR;if(F instanceof er)return iL;if(Array.isArray(F)){let el;let eh=F.length;for(let eh of F){let F=ir(eh);if(el){if(el===F)continue;el=iz;break}el=F}return Ge(el||iz,eh)}return iP}function sr(F){let el=typeof F;return null===F?"":"string"===el||"number"===el||"boolean"===el?String(F):F instanceof Se?F.toStringPremultipliedAlpha():F instanceof Qe||F instanceof er?F.toString():JSON.stringify(F)}let ar=class ar{constructor(F,el){this.type=F,this.value=el}static parse(F,el){if(2!==F.length)return el.error(`'literal' expression requires exactly one argument, but found ${F.length-1} instead.`);if(!nr(F[1]))return el.error("invalid value");let eh=F[1],ec=ir(eh),ep=el.expectedType;return"array"===ec.kind&&0===ec.N&&ep&&"array"===ep.kind&&("number"!=typeof ep.N||0===ep.N)&&(ec=ep),new ar(ec,eh)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Se?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof Qe?this.value.serialize():this.value}};let or=class or{constructor(F){this.name="ExpressionEvaluationError",this.message=F}toJSON(){return this.message}};let ik={string:iI,number:iM,boolean:iA,object:iP};let ur=class ur{constructor(F,el){this.type=F,this.args=el}static parse(F,el){if(F.length<2)return el.error("Expected at least one argument.");let eh,ec=1,ep=F[0];if("array"===ep){let ep,e_;if(F.length>2){let eh=F[1];if("string"!=typeof eh||!(eh in ik)||"object"===eh)return el.error('The item type argument of "array" must be one of string, number, boolean',1);ep=ik[eh],ec++}else ep=iz;if(F.length>3){if(null!==F[2]&&("number"!=typeof F[2]||F[2]<0||F[2]!==Math.floor(F[2])))return el.error('The length argument to "array" must be a positive integer literal',2);e_=F[2],ec++}eh=Ge(ep,e_)}else eh=ik[ep];let e_=[];for(;ec<F.length;ec++){let eh=el.parse(F[ec],ec,iz);if(!eh)return null;e_.push(eh)}return new ur(eh,e_)}evaluate(F){for(let el=0;el<this.args.length;el++){let eh=this.args[el].evaluate(F);if(!Xe(this.type,ir(eh)))return eh;if(el===this.args.length-1)throw new or(`The expression ${JSON.stringify(this.args[el].serialize())} evaluated to ${Ye(ir(eh))} but was expected to be of type ${Ye(this.type)}.`)}return null}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every(F=>F.outputDefined())}serialize(){let F=this.type,el=[F.kind];if("array"===F.kind){let eh=F.itemType;if("string"===eh.kind||"number"===eh.kind||"boolean"===eh.kind){el.push(eh.kind);let ec=F.N;("number"==typeof ec||this.args.length>1)&&el.push(ec)}}return el.concat(this.args.map(F=>F.serialize()))}};let cr=class cr{constructor(F){this.type=iR,this.sections=F}static parse(F,el){if(F.length<2)return el.error("Expected at least one argument.");let eh=F[1];if(!Array.isArray(eh)&&"object"==typeof eh)return el.error("First argument must be an image or text section.");let ec=[],ep=!1;for(let eh=1;eh<=F.length-1;++eh){let e_=F[eh];if(ep&&"object"==typeof e_&&!Array.isArray(e_)){ep=!1;let F=null;if(e_["font-scale"]&&!(F=el.parseObjectValue(e_["font-scale"],eh,"font-scale",iM)))return null;let eg=null;if(e_["text-font"]&&!(eg=el.parseObjectValue(e_["text-font"],eh,"text-font",Ge(iI))))return null;let ey=null;if(e_["text-color"]&&!(ey=el.parseObjectValue(e_["text-color"],eh,"text-color",iC)))return null;let eb=ec[ec.length-1];eb.scale=F,eb.font=eg,eb.textColor=ey}else{let e_=el.parse(F[eh],eh,iz);if(!e_)return null;let eg=e_.type.kind;if("string"!==eg&&"value"!==eg&&"null"!==eg&&"resolvedImage"!==eg)return el.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");ep=!0,ec.push({content:e_,scale:null,font:null,textColor:null})}}return new cr(ec)}evaluate(F){return new Qe(this.sections.map(el=>{let eh=el.content.evaluate(F);return ir(eh)===iL?new Je("",eh,null,null,null):new Je(sr(eh),null,el.scale?el.scale.evaluate(F):null,el.font?el.font.evaluate(F).join(","):null,el.textColor?el.textColor.evaluate(F):null)}))}eachChild(F){for(let el of this.sections)F(el.content),el.scale&&F(el.scale),el.font&&F(el.font),el.textColor&&F(el.textColor)}outputDefined(){return!1}serialize(){let F=["format"];for(let el of this.sections){F.push(el.content.serialize());let eh={};el.scale&&(eh["font-scale"]=el.scale.serialize()),el.font&&(eh["text-font"]=el.font.serialize()),el.textColor&&(eh["text-color"]=el.textColor.serialize()),F.push(eh)}return F}};let hr=class hr{constructor(F,el,eh,ec){this._imageWarnHistory={},this.type=iL,this.namePrimary=F,this.nameSecondary=el,eh&&(this.paramsPrimary=eh.params,this.iconsetIdPrimary=eh.iconset?eh.iconset.id:void 0),ec&&(this.paramsSecondary=ec.params,this.iconsetIdSecondary=ec.iconset?ec.iconset.id:void 0)}static parse(F,el){if(F.length<2)return el.error("Expected two or more arguments.");let eh=1,ec=[];for(let ep=0;ep<2;ep++)if(!function(){if(eh<F.length){let ep=el.parse(F[eh],eh++,iI);return ep?(ec.push({image:ep,options:{}}),!0):(el.error(ec.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}()||!function(){if(eh<F.length){let ep=F[eh];if(null===ep||"object"!=typeof ep||Array.isArray(ep))return!0;let e_=ep.params,eg=ep.iconset,ey=el.concat(eh);if(!e_&&!eg)return eh++,!0;if(e_){if("object"!=typeof e_||e_.constructor!==Object)return ey.error('Image options "params" should be an object'),!1;let F={},el=ey.concat(void 0,"params");for(let eh in e_){if(!eh)return el.error("Image parameter name should be non-empty"),!1;let ec=el.concat(void 0,eh).parse(e_[eh],void 0,iC,void 0,{typeAnnotation:"coerce"});if(!ec)return!1;F[eh]=ec}ec[ec.length-1].options.params=F}if(eg){if("object"!=typeof eg||eg.constructor!==Object)return ey.error('Image options "iconset" should be an object'),!1;if(!eg.id)return ey.error('Image options "iconset" should have an "id" property'),!1;ec[ec.length-1].options.iconset=eg}return eh++,!0}return!0}())return;return new hr(ec[0].image,ec[1]?ec[1].image:void 0,ec[0].options,ec[1]?ec[1].options:void 0)}evaluateParams(F,el){let eh={};if(el){for(let ec in el)if(el[ec])try{eh[ec]=el[ec].evaluate(F)}catch(F){continue}if(0!==Object.keys(eh).length)return{params:eh}}}evaluate(F){let el={name:this.namePrimary.evaluate(F),iconsetId:this.iconsetIdPrimary},eh=this.nameSecondary?{name:this.nameSecondary.evaluate(F),iconsetId:this.iconsetIdSecondary}:void 0,ec=er.build(el,eh,this.paramsPrimary?this.evaluateParams(F,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(F,this.paramsSecondary):void 0);if(ec&&F.availableImages){let el=ec.getPrimary().id;if(ec.available=F.availableImages.some(F=>we.isEqual(F,el)),ec.available){let el=ec.getSecondary()?ec.getSecondary().id:null;el&&(ec.available=F.availableImages.some(F=>we.isEqual(F,el)))}}return ec}eachChild(F){if(F(this.namePrimary),this.paramsPrimary)for(let el in this.paramsPrimary)this.paramsPrimary[el]&&F(this.paramsPrimary[el]);if(this.nameSecondary&&(F(this.nameSecondary),this.paramsSecondary))for(let el in this.paramsSecondary)this.paramsSecondary[el]&&F(this.paramsSecondary[el])}outputDefined(){return!1}serializeOptions(F,el){let eh={};if(el&&(eh.iconset={id:el}),F)for(let el in eh.params={},F)F[el]&&(eh.params[el]=F[el].serialize());return Object.keys(eh).length>0?eh:void 0}serialize(){let F=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){let el=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);el&&F.push(el)}if(this.nameSecondary&&(F.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){let el=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);el&&F.push(el)}return F}};function pr(F){return F instanceof Number?"number":F instanceof String?"string":F instanceof Boolean?"boolean":Array.isArray(F)?"array":null===F?"null":typeof F}let iF={"to-boolean":iA,"to-color":iC,"to-number":iM,"to-string":iI};let dr=class dr{constructor(F,el){this.type=F,this.args=el}static parse(F,el){if(F.length<2)return el.error("Expected at least one argument.");let eh=F[0],ec=[],ep=iE;if("to-array"===eh){if(!Array.isArray(F[1]))return null;let eh=F[1].length;if(el.expectedType){if("array"!==el.expectedType.kind)return el.error(`Expected ${el.expectedType.kind} but found array.`);ep=Ge(el.expectedType.itemType,eh)}else{if(!(eh>0&&nr(F[1][0])))return null;ep=Ge(ir(F[1][0]),eh)}for(let e_=0;e_<eh;e_++){let eh;let eg=F[1][e_];if("array"===pr(eg))eh=el.parse(eg,void 0,ep.itemType);else{let F=pr(eg);if(F!==ep.itemType.kind)return el.error(`Expected ${ep.itemType.kind} but found ${F}.`);eh=el.registry.literal.parse(["literal",void 0===eg?null:eg],el)}if(!eh)return null;ec.push(eh)}}else{if(("to-boolean"===eh||"to-string"===eh)&&2!==F.length)return el.error("Expected one argument.");ep=iF[eh];for(let eh=1;eh<F.length;eh++){let ep=el.parse(F[eh],eh,iz);if(!ep)return null;ec.push(ep)}}return new dr(ep,ec)}evaluate(F){if("boolean"===this.type.kind)return!!this.args[0].evaluate(F);if("color"===this.type.kind){let el,eh;for(let ec of this.args){if(el=ec.evaluate(F),eh=null,el instanceof Se)return el;if("string"==typeof el){let eh=F.parseColor(el);if(eh)return eh}else if(Array.isArray(el)&&!(eh=el.length<3||el.length>4?`Invalid rbga value ${JSON.stringify(el)}: expected an array containing either three or four numeric values.`:rr(el[0],el[1],el[2],el[3])))return new Se(el[0]/255,el[1]/255,el[2]/255,el[3])}throw new or(eh||`Could not parse color from value '${"string"==typeof el?el:String(JSON.stringify(el))}'`)}if("number"===this.type.kind){let el=null;for(let eh of this.args){if(null===(el=eh.evaluate(F)))return 0;let ec=Number(el);if(!isNaN(ec))return ec}throw new or(`Could not convert ${JSON.stringify(el)} to number.`)}return"formatted"===this.type.kind?Qe.fromString(sr(this.args[0].evaluate(F))):"resolvedImage"===this.type.kind?er.build(sr(this.args[0].evaluate(F))):"array"===this.type.kind?this.args.map(el=>el.evaluate(F)):sr(this.args[0].evaluate(F))}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every(F=>F.outputDefined())}serialize(){if("formatted"===this.type.kind)return new cr([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new hr(this.args[0]).serialize();let F="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(el=>{F.push(el.serialize())}),F}};let iB=["Unknown","Point","LineString","Polygon"];let yr=class yr{constructor(F,el){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=F,this.options=el}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?iB[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(F){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){let F=this.featureDistanceData.center,el=this.featureDistanceData.scale,{x:eh,y:ec}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(eh*el-F[0])+this.featureDistanceData.bearing[1]*(ec*el-F[1])}return 0}parseColor(F){let el=this._parseColorCache[F];return el||(el=this._parseColorCache[F]=Se.parse(F)),el}getConfig(F){return this.options?this.options.get(F):null}};let gr=class gr{constructor(F,el,eh,ec,ep){this.name=F,this.type=el,this._evaluate=eh,this.args=ec,this._overloadIndex=ep}evaluate(F){if(!this._evaluate){let F=gr.definitions[this.name];this._evaluate=Array.isArray(F)?F[2]:F.overloads[this._overloadIndex][1]}return this._evaluate(F,this.args)}eachChild(F){this.args.forEach(F)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(F=>F.serialize()))}static parse(F,el){let eh=F[0],ec=gr.definitions[eh];if(!ec)return el.error(`Unknown expression "${eh}". If you wanted a literal array, use ["literal", [...]].`,0);let ep=Array.isArray(ec)?ec[0]:ec.type,e_=Array.isArray(ec)?[[ec[1],ec[2]]]:ec.overloads,eg=[],ey=null,eb=-1;for(let[ec,ew]of e_){if(Array.isArray(ec)&&ec.length!==F.length-1)continue;eg.push(ec),eb++,ey=new iG(el.registry,el.path,null,el.scope,void 0,el._scope,el.options);let e_=[],eT=!1;for(let el=1;el<F.length;el++){let eh=F[el],ep=Array.isArray(ec)?ec[el-1]:ec.type,eg=ey.parse(eh,1+e_.length,ep);if(!eg){eT=!0;break}e_.push(eg)}if(!eT){if(Array.isArray(ec)&&ec.length!==e_.length)ey.error(`Expected ${ec.length} arguments, but found ${e_.length} instead.`);else{for(let F=0;F<e_.length;F++){let el=Array.isArray(ec)?ec[F]:ec.type,eh=e_[F];ey.concat(F+1).checkSubtype(el,eh.type)}if(0===ey.errors.length)return new gr(eh,ep,ew,e_,eb)}}}if(1===eg.length)el.errors.push(...ey.errors);else{let eh=(eg.length?eg:e_.map(([F])=>F)).map(xr).join(" | "),ec=[];for(let eh=1;eh<F.length;eh++){let ep=el.parse(F[eh],1+ec.length);if(!ep)return null;ec.push(Ye(ep.type))}el.error(`Expected arguments of type ${eh}, but found (${ec.join(", ")}) instead.`)}return null}static register(F,el){for(let eh in gr.definitions=el,el)F[eh]=gr}};function xr(F){return Array.isArray(F)?`(${F.map(Ye).join(", ")})`:`(${Ye(F.type)}...)`}let vr=class vr{constructor(F,el,eh){this.type=iD,this.locale=eh,this.caseSensitive=F,this.diacriticSensitive=el}static parse(F,el){if(2!==F.length)return el.error("Expected one argument.");let eh=F[1];if("object"!=typeof eh||Array.isArray(eh))return el.error("Collator options argument must be an object.");let ec=void 0===eh["case-sensitive"]?el.parse(!1,1,iA):el.parseObjectValue(eh["case-sensitive"],1,"case-sensitive",iA);if(!ec)return null;let ep=void 0===eh["diacritic-sensitive"]?el.parse(!1,1,iA):el.parseObjectValue(eh["diacritic-sensitive"],1,"diacritic-sensitive",iA);if(!ep)return null;let e_=null;return!eh.locale||(e_=el.parseObjectValue(eh.locale,1,"locale",iI))?new vr(ec,ep,e_):null}evaluate(F){return new Ke(this.caseSensitive.evaluate(F),this.diacriticSensitive.evaluate(F),this.locale?this.locale.evaluate(F):null)}eachChild(F){F(this.caseSensitive),F(this.diacriticSensitive),this.locale&&F(this.locale)}outputDefined(){return!1}serialize(){let F={};return F["case-sensitive"]=this.caseSensitive.serialize(),F["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(F.locale=this.locale.serialize()),["collator",F]}};function _r(F,el,eh){let ec=F[el];F[el]=F[eh],F[eh]=ec}function Ar(F,el){F[0]=Math.min(F[0],el[0]),F[1]=Math.min(F[1],el[1]),F[2]=Math.max(F[2],el[0]),F[3]=Math.max(F[3],el[1])}function Ir(F,el){return!(F[0]<=el[0]||F[2]>=el[2]||F[1]<=el[1]||F[3]>=el[3])}function Pr(F,el,eh=!1){let ec=!1;for(let ep=0,e_=el.length;ep<e_;ep++){let e_=el[ep];for(let el=0,ep=e_.length,eg=ep-1;el<ep;eg=el++){let ep=e_[eg],ey=e_[el];if(function(F,el,eh){let ec=F[0]-el[0],ep=F[1]-el[1],e_=F[0]-eh[0],eg=F[1]-eh[1];return ec*eg-e_*ep==0&&ec*e_<=0&&ep*eg<=0}(F,ep,ey))return eh;ep[1]>F[1]!=ey[1]>F[1]&&F[0]<(ey[0]-ep[0])*(F[1]-ep[1])/(ey[1]-ep[1])+ep[0]&&(ec=!ec)}}return ec}function Er(F,el,eh,ec){let ep=ec[0]-eh[0],e_=ec[1]-eh[1],eg=(F[0]-eh[0])*e_-ep*(F[1]-eh[1]),ey=(el[0]-eh[0])*e_-ep*(el[1]-eh[1]);return eg>0&&ey<0||eg<0&&ey>0}function zr(F,el,eh,ec){var ep,e_;return 0!=(ep=[ec[0]-eh[0],ec[1]-eh[1]])[0]*(e_=[el[0]-F[0],el[1]-F[1]])[1]-ep[1]*e_[0]&&!(!Er(F,el,eh,ec)||!Er(eh,ec,F,el))}function Cr(F,el){for(let eh=0;eh<F.length;++eh)if(!Pr(F[eh],el))return!1;for(let eh=0;eh<F.length-1;++eh)if(function(F,el,eh){for(let ec of eh)for(let eh=0,ep=ec.length,e_=ep-1;eh<ep;e_=eh++)if(zr(F,el,ec[e_],ec[eh]))return!0;return!1}(F[eh],F[eh+1],el))return!1;return!0}function Rr(F,el,eh){let ec=[];for(let ep=0;ep<F.length;ep++){let e_=[];for(let ec=0;ec<F[ep].length;ec++){let eg=function(F,el){let eh=(180+F[0])/360,ec=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F[1]*Math.PI/360)))/360,ep=Math.pow(2,el.z);return[Math.round(eh*ep*8192),Math.round(ec*ep*8192)]}(F[ep][ec],eh);Ar(el,eg),e_.push(eg)}ec.push(e_)}return ec}function Lr(F,el,eh){let ec=[];for(let ep=0;ep<F.length;ep++){let e_=Rr(F[ep],el,eh);ec.push(e_)}return ec}function Fr(F,el,eh,ec){if(F[0]<eh[0]||F[0]>eh[2]){let el=.5*ec,ep=F[0]-eh[0]>el?-ec:eh[0]-F[0]>el?ec:0;0===ep&&(ep=F[0]-eh[2]>el?-ec:eh[2]-F[0]>el?ec:0),F[0]+=ep}Ar(el,F)}function Or(F,el,eh,ec){let ep=8192*Math.pow(2,ec.z),e_=[8192*ec.x,8192*ec.y],eg=[];if(!F)return eg;for(let ec of F)for(let F of ec){let ec=[F.x+e_[0],F.y+e_[1]];Fr(ec,el,eh,ep),eg.push(ec)}return eg}function Nr(F,el,eh,ec){let ep=8192*Math.pow(2,ec.z),e_=[8192*ec.x,8192*ec.y],eg=[];if(!F)return eg;for(let eh of F){let F=[];for(let ec of eh){let eh=[ec.x+e_[0],ec.y+e_[1]];Ar(el,eh),F.push(eh)}eg.push(F)}if(el[2]-el[0]<=ep/2)for(let F of(el[0]=el[1]=1/0,el[2]=el[3]=-1/0,eg))for(let ec of F)Fr(ec,el,eh,ep);return eg}let Ur=class Ur{constructor(F,el){this.type=iA,this.geojson=F,this.geometries=el}static parse(F,el){if(2!==F.length)return el.error(`'within' expression requires exactly one argument, but found ${F.length-1} instead.`);if(nr(F[1])){let el=F[1];if("FeatureCollection"===el.type)for(let F=0;F<el.features.length;++F){let eh=el.features[F].geometry.type;if("Polygon"===eh||"MultiPolygon"===eh)return new Ur(el,el.features[F].geometry)}else if("Feature"===el.type){let F=el.geometry.type;if("Polygon"===F||"MultiPolygon"===F)return new Ur(el,el.geometry)}else if("Polygon"===el.type||"MultiPolygon"===el.type)return new Ur(el,el)}return el.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(F){if(null!=F.geometry()&&null!=F.canonicalID()){if("Point"===F.geometryType())return function(F,el){let eh=[1/0,1/0,-1/0,-1/0],ec=[1/0,1/0,-1/0,-1/0],ep=F.canonicalID();if(!ep)return!1;if("Polygon"===el.type){let e_=Rr(el.coordinates,ec,ep),eg=Or(F.geometry(),eh,ec,ep);if(!Ir(eh,ec))return!1;for(let F of eg)if(!Pr(F,e_))return!1}if("MultiPolygon"===el.type){let e_=Lr(el.coordinates,ec,ep),eg=Or(F.geometry(),eh,ec,ep);if(!Ir(eh,ec))return!1;for(let F of eg)if(!function(F,el){for(let eh=0;eh<el.length;eh++)if(Pr(F,el[eh]))return!0;return!1}(F,e_))return!1}return!0}(F,this.geometries);if("LineString"===F.geometryType())return function(F,el){let eh=[1/0,1/0,-1/0,-1/0],ec=[1/0,1/0,-1/0,-1/0],ep=F.canonicalID();if(!ep)return!1;if("Polygon"===el.type){let e_=Rr(el.coordinates,ec,ep),eg=Nr(F.geometry(),eh,ec,ep);if(!Ir(eh,ec))return!1;for(let F of eg)if(!Cr(F,e_))return!1}if("MultiPolygon"===el.type){let e_=Lr(el.coordinates,ec,ep),eg=Nr(F.geometry(),eh,ec,ep);if(!Ir(eh,ec))return!1;for(let F of eg)if(!function(F,el){for(let eh=0;eh<el.length;eh++)if(Cr(F,el[eh]))return!0;return!1}(F,e_))return!1}return!0}(F,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}};let iN={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},iV=1/298.257223563,iU=iV*(2-iV),ij=Math.PI/180;let Yr=class Yr{static fromTile(F,el,eh){let ec=Math.PI*(1-2*(F+.5)/Math.pow(2,el)),ep=Math.atan(.5*(Math.exp(ec)-Math.exp(-ec)))/ij;return new Yr(ep,eh)}static get units(){return iN}constructor(F,el){if(void 0===F)throw Error("No latitude given.");if(el&&!iN[el])throw Error(`Unknown unit ${el}. Use one of: ${Object.keys(iN).join(", ")}`);let eh=6378.137*ij*(el?iN[el]:1),ec=Math.cos(F*ij),ep=1/(1-iU*(1-ec*ec)),e_=Math.sqrt(ep);this.kx=eh*e_*ec,this.ky=eh*e_*ep*(1-iU)}distance(F,el){let eh=Zr(F[0]-el[0])*this.kx,ec=(F[1]-el[1])*this.ky;return Math.sqrt(eh*eh+ec*ec)}bearing(F,el){let eh=Zr(el[0]-F[0])*this.kx;return Math.atan2(eh,(el[1]-F[1])*this.ky)/ij}destination(F,el,eh){let ec=eh*ij;return this.offset(F,Math.sin(ec)*el,Math.cos(ec)*el)}offset(F,el,eh){return[F[0]+el/this.kx,F[1]+eh/this.ky]}lineDistance(F){let el=0;for(let eh=0;eh<F.length-1;eh++)el+=this.distance(F[eh],F[eh+1]);return el}area(F){let el=0;for(let eh=0;eh<F.length;eh++){let ec=F[eh];for(let F=0,ep=ec.length,e_=ep-1;F<ep;e_=F++)el+=Zr(ec[F][0]-ec[e_][0])*(ec[F][1]+ec[e_][1])*(eh?-1:1)}return Math.abs(el)/2*this.kx*this.ky}along(F,el){let eh=0;if(el<=0)return F[0];for(let ec=0;ec<F.length-1;ec++){let ep=F[ec],e_=F[ec+1],eg=this.distance(ep,e_);if((eh+=eg)>el)return Xr(ep,e_,(el-(eh-eg))/eg)}return F[F.length-1]}pointToSegmentDistance(F,el,eh){let[ec,ep]=el,e_=Zr(eh[0]-ec)*this.kx,eg=(eh[1]-ep)*this.ky;if(0!==e_||0!==eg){let el=(Zr(F[0]-ec)*this.kx*e_+(F[1]-ep)*this.ky*eg)/(e_*e_+eg*eg);el>1?(ec=eh[0],ep=eh[1]):el>0&&(ec+=e_/this.kx*el,ep+=eg/this.ky*el)}return Math.sqrt((e_=Zr(F[0]-ec)*this.kx)*e_+(eg=(F[1]-ep)*this.ky)*eg)}pointOnLine(F,el){let eh=1/0,ec=F[0][0],ep=F[0][1],e_=0,eg=0;for(let ey=0;ey<F.length-1;ey++){let eb=F[ey][0],ew=F[ey][1],eT=Zr(F[ey+1][0]-eb)*this.kx,eS=(F[ey+1][1]-ew)*this.ky,eE=0;0===eT&&0===eS||((eE=(Zr(el[0]-eb)*this.kx*eT+(el[1]-ew)*this.ky*eS)/(eT*eT+eS*eS))>1?(eb=F[ey+1][0],ew=F[ey+1][1]):eE>0&&(eb+=eT/this.kx*eE,ew+=eS/this.ky*eE)),eT=Zr(el[0]-eb)*this.kx,eS=(el[1]-ew)*this.ky;let eM=eT*eT+eS*eS;eM<eh&&(eh=eM,ec=eb,ep=ew,e_=ey,eg=eE)}return{point:[ec,ep],index:e_,t:Math.max(0,Math.min(1,eg))}}lineSlice(F,el,eh){let ec=this.pointOnLine(eh,F),ep=this.pointOnLine(eh,el);if(ec.index>ep.index||ec.index===ep.index&&ec.t>ep.t){let F=ec;ec=ep,ep=F}let e_=[ec.point],eg=ec.index+1,ey=ep.index;!Hr(eh[eg],e_[0])&&eg<=ey&&e_.push(eh[eg]);for(let F=eg+1;F<=ey;F++)e_.push(eh[F]);return Hr(eh[ey],ep.point)||e_.push(ep.point),e_}lineSliceAlong(F,el,eh){let ec=0,ep=[];for(let e_=0;e_<eh.length-1;e_++){let eg=eh[e_],ey=eh[e_+1],eb=this.distance(eg,ey);if((ec+=eb)>F&&0===ep.length&&ep.push(Xr(eg,ey,(F-(ec-eb))/eb)),ec>=el)return ep.push(Xr(eg,ey,(el-(ec-eb))/eb)),ep;ec>F&&ep.push(ey)}return ep}bufferPoint(F,el){let eh=el/this.ky,ec=el/this.kx;return[F[0]-ec,F[1]-eh,F[0]+ec,F[1]+eh]}bufferBBox(F,el){let eh=el/this.ky,ec=el/this.kx;return[F[0]-ec,F[1]-eh,F[2]+ec,F[3]+eh]}insideBBox(F,el){return Zr(F[0]-el[0])>=0&&0>=Zr(F[0]-el[2])&&F[1]>=el[1]&&F[1]<=el[3]}};function Hr(F,el){return F[0]===el[0]&&F[1]===el[1]}function Xr(F,el,eh){let ec=Zr(el[0]-F[0]);return[F[0]+ec*eh,F[1]+(el[1]-F[1])*eh]}function Zr(F){for(;F<-180;)F+=360;for(;F>180;)F-=360;return F}let Wr=class Wr{constructor(F=[],el=(F,el)=>F<el?-1:F>el?1:0){if(this.data=F,this.length=this.data.length,this.compare=el,this.length>0)for(let F=(this.length>>1)-1;F>=0;F--)this._down(F)}push(F){this.data.push(F),this._up(this.length++)}pop(){if(0===this.length)return;let F=this.data[0],el=this.data.pop();return--this.length>0&&(this.data[0]=el,this._down(0)),F}peek(){return this.data[0]}_up(F){let{data:el,compare:eh}=this,ec=el[F];for(;F>0;){let ep=F-1>>1,e_=el[ep];if(eh(ec,e_)>=0)break;el[F]=e_,F=ep}el[F]=ec}_down(F){let{data:el,compare:eh}=this,ec=this.length>>1,ep=el[F];for(;F<ec;){let ec=1+(F<<1),e_=ec+1;if(e_<this.length&&0>eh(el[e_],el[ec])&&(ec=e_),eh(el[ec],ep)>=0)break;el[F]=el[ec],F=ec}el[F]=ep}};function Jr(F,el){return el.dist-F.dist}function en(F){let el=[1/0,1/0,-1/0,-1/0];if(el.length!==F.length)return!1;for(let eh=0;eh<el.length;eh++)if(el[eh]!==F[eh])return!1;return!0}function rn(F){return F[1]-F[0]+1}function nn(F,el){let eh=F[1]>=F[0]&&F[1]<el;return eh||console.warn("Distance Expression: Index is out of range"),eh}function sn(F,el){if(F[0]>F[1])return[null,null];let eh=rn(F);if(el){if(2===eh)return[F,null];let el=Math.floor(eh/2);return[[F[0],F[0]+el],[F[0]+el,F[1]]]}{if(1===eh)return[F,null];let el=Math.floor(eh/2)-1;return[[F[0],F[0]+el],[F[0]+el+1,F[1]]]}}function an(F,el){let eh=[1/0,1/0,-1/0,-1/0];if(!nn(el,F.length))return eh;for(let ec=el[0];ec<=el[1];++ec)Ar(eh,F[ec]);return eh}function on(F){let el=[1/0,1/0,-1/0,-1/0];for(let eh=0;eh<F.length;++eh)for(let ec=0;ec<F[eh].length;++ec)Ar(el,F[eh][ec]);return el}function ln(F,el,eh){if(en(F)||en(el))return NaN;let ec=0,ep=0;return F[2]<el[0]&&(ec=el[0]-F[2]),F[0]>el[2]&&(ec=F[0]-el[2]),F[1]>el[3]&&(ep=F[1]-el[3]),F[3]<el[1]&&(ep=el[1]-F[3]),eh.distance([0,0],[ec,ep])}function hn(F,el){let eh=Math.pow(2,el.z),ec=(F.y/8192+el.y)/eh;return[360*((F.x/8192+el.x)/eh)-180,360/Math.PI*Math.atan(Math.exp((180-360*ec)*Math.PI/180))-90]}function fn(F,el,eh){let ec=eh.pointOnLine(el,F).point;return eh.distance(F,ec)}function dn(F,el,eh,ec,ep){let e_=eh.slice(ec[0],ec[1]+1),eg=1/0;for(let eh=el[0];eh<=el[1];++eh)if(0===(eg=Math.min(eg,fn(F[eh],e_,ep))))return 0;return eg}function mn(F,el,eh,ec,ep){let e_=Math.min(ep.pointToSegmentDistance(F,eh,ec),ep.pointToSegmentDistance(el,eh,ec)),eg=Math.min(ep.pointToSegmentDistance(eh,F,el),ep.pointToSegmentDistance(ec,F,el));return Math.min(e_,eg)}function bn(F,el){for(let eh of F)for(let F=0;F<=eh.length-1;++F)if(Pr(eh[F],el,!0))return!0;return!1}function wn(F,el,eh,ec,ep,e_,eg){if(null===e_||null===eg)return;let ey=ln(an(ec,e_),an(ep,eg),eh);ey<el&&F.push({dist:ey,range1:e_,range2:eg})}function An(F,el,eh,ec,ep,e_=1/0){let eg=Math.min(e_,ep.distance(F[0],eh[0]));if(0===eg)return eg;let ey=new Wr([{dist:0,range1:[0,F.length-1],range2:[0,eh.length-1]}],Jr),eb=el?50:100,ew=ec?50:100;for(;ey.length;){let e_=ey.pop();if(e_.dist>=eg)continue;let eT=e_.range1,eS=e_.range2;if(rn(eT)<=eb&&rn(eS)<=ew){if(!nn(eT,F.length)||!nn(eS,eh.length))return NaN;if(el&&ec?eg=Math.min(eg,function(F,el,eh,ec,ep){if(!nn(el,F.length)||!nn(ec,eh.length))return NaN;let e_=1/0;for(let eg=el[0];eg<el[1];++eg)for(let el=ec[0];el<ec[1];++el){if(zr(F[eg],F[eg+1],eh[el],eh[el+1]))return 0;e_=Math.min(e_,mn(F[eg],F[eg+1],eh[el],eh[el+1],ep))}return e_}(F,eT,eh,eS,ep)):el||ec?el&&!ec?eg=Math.min(eg,dn(eh,eS,F,eT,ep)):!el&&ec&&(eg=Math.min(eg,dn(F,eT,eh,eS,ep))):eg=Math.min(eg,function(F,el,eh,ec,ep){if(!nn(el,F.length)||!nn(ec,eh.length))return NaN;let e_=1/0;for(let eg=el[0];eg<=el[1];++eg)for(let el=ec[0];el<=ec[1];++el)if(0===(e_=Math.min(e_,ep.distance(F[eg],eh[el]))))return e_;return e_}(F,eT,eh,eS,ep)),0===eg)break}else{let e_=sn(eT,el),eb=sn(eS,ec);wn(ey,eg,ep,F,eh,e_[0],eb[0]),wn(ey,eg,ep,F,eh,e_[0],eb[1]),wn(ey,eg,ep,F,eh,e_[1],eb[0]),wn(ey,eg,ep,F,eh,e_[1],eb[1])}}return eg}function In(F,el,eh,ec,ep=1/0){let e_=ep,eg=an(F,[0,F.length-1]);for(let ep of eh)if(!(e_!==1/0&&ln(eg,an(ep,[0,ep.length-1]),ec)>=e_)&&0===(e_=Math.min(e_,An(F,el,ep,!0,ec,e_))))break;return e_}function Sn(F,el,eh,ec,ep=1/0){let e_=ep,eg=an(F,[0,F.length-1]);for(let ep of eh){if(e_!==1/0&&ln(eg,on(ep),ec)>=e_)continue;let eh=function(F,el,eh,ec,ep=1/0){let e_=Math.min(ec.distance(F[0],eh[0][0]),ep);if(0===e_)return e_;let eg=new Wr([{dist:0,range1:[0,F.length-1],range2:[0,0]}],Jr),ey=el?50:100,eb=on(eh);for(;eg.length;){let ep=eg.pop();if(ep.dist>=e_)continue;let ew=ep.range1;if(rn(ew)<=ey){if(!nn(ew,F.length))return NaN;if(el){let el=function(F,el,eh,ec){if(!nn(el,F.length))return NaN;for(let ec=el[0];ec<=el[1];++ec)if(Pr(F[ec],eh,!0))return 0;let ep=1/0;for(let e_=el[0];e_<el[1];++e_)for(let el of eh)for(let eh=0,eg=el.length,ey=eg-1;eh<eg;ey=eh++){if(zr(F[e_],F[e_+1],el[ey],el[eh]))return 0;ep=Math.min(ep,mn(F[e_],F[e_+1],el[ey],el[eh],ec))}return ep}(F,ew,eh,ec);if(0===(e_=Math.min(e_,el)))break}else for(let el=ew[0];el<=ew[1];++el){let ep=function(F,el,eh){if(Pr(F,el,!0))return 0;let ec=1/0;for(let ep of el){let el=ep.length;if(el<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(ep[0]!==ep[el-1]&&0===(ec=Math.min(ec,eh.pointToSegmentDistance(F,ep[el-1],ep[0])))||0===(ec=Math.min(ec,fn(F,ep,eh))))break}return ec}(F[el],eh,ec);if(0===(e_=Math.min(e_,ep)))return e_}}else{let eh=sn(ew,el);if(null!==eh[0]){let el=ln(an(F,eh[0]),eb,ec);el<e_&&eg.push({dist:el,range1:eh[0],range2:[0,0]})}if(null!==eh[1]){let el=ln(an(F,eh[1]),eb,ec);el<e_&&eg.push({dist:el,range1:eh[1],range2:[0,0]})}}}return e_}(F,el,ep,ec,e_);if(isNaN(eh))return eh;if(0===(e_=Math.min(e_,eh)))break}return e_}function Pn(F){return"Point"===F||"MultiPoint"===F||"LineString"===F||"MultiLineString"===F||"Polygon"===F||"MultiPolygon"===F}let En=class En{constructor(F,el){this.type=iM,this.geojson=F,this.geometries=el}static parse(F,el){if(2!==F.length)return el.error(`'distance' expression requires either one argument, but found ' ${F.length-1} instead.`);if(nr(F[1])){let el=F[1];if("FeatureCollection"===el.type){for(let F=0;F<el.features.length;++F)if(Pn(el.features[F].geometry.type))return new En(el,el.features[F].geometry)}else if("Feature"===el.type){if(Pn(el.geometry.type))return new En(el,el.geometry)}else if(Pn(el.type))return new En(el,el)}return el.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(F){let el=F.geometry(),eh=F.canonicalID();if(null!=el&&null!=eh){if("Point"===F.geometryType())return function(F,el,eh){let ec=[];for(let eh of F)for(let F of eh)ec.push(hn(F,el));let ep=new Yr(ec[0][1],"meters");return"Point"===eh.type||"MultiPoint"===eh.type||"LineString"===eh.type?An(ec,!1,"Point"===eh.type?[eh.coordinates]:eh.coordinates,"LineString"===eh.type,ep):"MultiLineString"===eh.type?In(ec,!1,eh.coordinates,ep):"Polygon"===eh.type||"MultiPolygon"===eh.type?Sn(ec,!1,"Polygon"===eh.type?[eh.coordinates]:eh.coordinates,ep):null}(el,eh,this.geometries);if("LineString"===F.geometryType())return function(F,el,eh){let ec=[];for(let eh of F){let F=[];for(let ec of eh)F.push(hn(ec,el));ec.push(F)}let ep=new Yr(ec[0][0][1],"meters");if("Point"===eh.type||"MultiPoint"===eh.type||"LineString"===eh.type)return In("Point"===eh.type?[eh.coordinates]:eh.coordinates,"LineString"===eh.type,ec,ep);if("MultiLineString"===eh.type){let F=1/0;for(let el=0;el<eh.coordinates.length;el++){let e_=In(eh.coordinates[el],!0,ec,ep,F);if(isNaN(e_))return e_;if(0===(F=Math.min(F,e_)))break}return F}if("Polygon"===eh.type||"MultiPolygon"===eh.type){let F=1/0;for(let el=0;el<ec.length;el++){let e_=Sn(ec[el],!0,"Polygon"===eh.type?[eh.coordinates]:eh.coordinates,ep,F);if(isNaN(e_))return e_;if(0===(F=Math.min(F,e_)))break}return F}return null}(el,eh,this.geometries);if("Polygon"===F.geometryType())return function(F,el,eh){let ec=[];for(let eh of function(F,el){let eh,ec;let ep=F.length;if(ep<=1)return[F];let e_=[];for(let el=0;el<ep;el++){let ep=function(F){let el=0;for(let eh,ec,ep=0,e_=F.length,eg=e_-1;ep<e_;eg=ep++)eh=F[ep],el+=((ec=F[eg]).x-eh.x)*(eh.y+ec.y);return el}(F[el]);0!==ep&&(F[el].area=Math.abs(ep),void 0===ec&&(ec=ep<0),ec===ep<0?(eh&&e_.push(eh),eh=[F[el]]):eh.push(F[el]))}return eh&&e_.push(eh),e_}(F)){let F=[];for(let ec=0;ec<eh.length;++ec)F.push(function(F,el){let eh=[];for(let ec=0;ec<F.length;++ec)eh.push(hn(F[ec],el));return eh}(eh[ec],el));ec.push(F)}let ep=new Yr(ec[0][0][0][1],"meters");if("Point"===eh.type||"MultiPoint"===eh.type||"LineString"===eh.type)return Sn("Point"===eh.type?[eh.coordinates]:eh.coordinates,"LineString"===eh.type,ec,ep);if("MultiLineString"===eh.type){let F=1/0;for(let el=0;el<eh.coordinates.length;el++){let e_=Sn(eh.coordinates[el],!0,ec,ep,F);if(isNaN(e_))return e_;if(0===(F=Math.min(F,e_)))break}return F}return"Polygon"===eh.type||"MultiPolygon"===eh.type?function(F,el,eh){let ec=1/0;for(let ep of F)for(let F of el){let el=function(F,el,eh,ec=1/0){let ep=on(F),e_=on(el);if(ec!==1/0&&ln(ep,e_,eh)>=ec)return ec;if(Ir(ep,e_)){if(bn(F,el))return 0}else if(bn(el,F))return 0;let eg=ec;for(let ec of F)for(let F=0,ep=ec.length,e_=ep-1;F<ep;e_=F++)for(let ep of el)for(let el=0,ey=ep.length,eb=ey-1;el<ey;eb=el++){if(zr(ec[e_],ec[F],ep[eb],ep[el]))return 0;eg=Math.min(eg,mn(ec[e_],ec[F],ep[eb],ep[el],eh))}return eg}(ep,F,eh,ec);if(isNaN(el))return el;if(0===(ec=Math.min(ec,el)))return ec}return ec}("Polygon"===eh.type?[eh.coordinates]:eh.coordinates,ec,ep):null}(el,eh,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}};function zn(F,el){switch(F){case"string":return sr(el);case"number":return+el;case"boolean":return!!el;case"color":return Se.parse(el);case"formatted":return Qe.fromString(sr(el));case"resolvedImage":return er.build(sr(el))}return el}function kn(F,el,eh,ec){return void 0!==ec&&(F=ec*Math.round(F/ec)),void 0!==el&&F<el&&(F=el),void 0!==eh&&F>eh&&(F=eh),F}let Tn=class Tn{constructor(F,el,eh){this.type=F,this.key=el,this.scope=eh}static parse(F,el){let eh=el.expectedType;if(null==eh&&(eh=iz),F.length<2||F.length>3)return el.error("Invalid number of arguments for 'config' expression.");let ec=el.parse(F[1],1);if(!(ec instanceof ar))return el.error("Key name of 'config' expression must be a string literal.");if(F.length>=3){let ep=el.parse(F[2],2);return ep instanceof ar?new Tn(eh,sr(ec.value),sr(ep.value)):el.error("Scope of 'config' expression must be a string literal.")}return new Tn(eh,sr(ec.value))}evaluate(F){let el=[this.key,this.scope,F.scope].filter(Boolean).join("\x1f"),eh=F.getConfig(el);if(!eh)return null;let{type:ec,value:ep,values:e_,minValue:eg,maxValue:ey,stepValue:eb}=eh,ew=eh.default.evaluate(F),eT=ew;if(ep){let el=F.scope;F.scope=(el||"").split("\x1f").slice(1).join("\x1f"),eT=ep.evaluate(F),F.scope=el}return ec&&(eT=zn(ec,eT)),void 0===eT||void 0===eg&&void 0===ey&&void 0===eb||("number"==typeof eT?eT=kn(eT,eg,ey,eb):Array.isArray(eT)&&(eT=eT.map(F=>"number"==typeof F?kn(F,eg,ey,eb):F))),void 0!==ep&&void 0!==eT&&e_&&!e_.includes(eT)&&(eT=ew,ec&&(eT=zn(ec,eT))),(ec&&ec!==this.type||void 0!==eT&&ir(eT)!==this.type)&&(eT=zn(this.type.kind,eT)),eT}eachChild(){}outputDefined(){return!1}serialize(){let F=["config",this.key];return this.scope&&F.concat(this.key),F}};function Bn(F){if(F instanceof gr&&("get"===F.name&&1===F.args.length||"feature-state"===F.name||"has"===F.name&&1===F.args.length||"properties"===F.name||"geometry-type"===F.name||"id"===F.name||/^filter-/.test(F.name))||F instanceof Ur||F instanceof En)return!1;let el=!0;return F.eachChild(F=>{el&&!Bn(F)&&(el=!1)}),el}function Vn(F){if(F instanceof gr&&"feature-state"===F.name)return!1;let el=!0;return F.eachChild(F=>{el&&!Vn(F)&&(el=!1)}),el}function Cn(F){if(F instanceof Tn)return new Set([F.key]);let el=new Set;return F.eachChild(F=>{el=new Set([...el,...Cn(F)])}),el}function Dn(F,el){if(F instanceof gr&&el.indexOf(F.name)>=0)return!1;let eh=!0;return F.eachChild(F=>{eh&&!Dn(F,el)&&(eh=!1)}),eh}let Rn=class Rn{constructor(F,el){this.type=el.type,this.name=F,this.boundExpression=el}static parse(F,el){if(2!==F.length||"string"!=typeof F[1])return el.error("'var' expression requires exactly one string literal argument.");let eh=F[1];return el.scope.has(eh)?new Rn(eh,el.scope.get(eh)):el.error(`Unknown variable "${eh}". Make sure "${eh}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(F){return this.boundExpression.evaluate(F)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}};let Ln=class Ln{constructor(F,el=[],eh,ec=new Ce,ep=[],e_,eg){this.registry=F,this.path=el,this.key=el.map(F=>"string"==typeof F?`['${F}']`:`[${F}]`).join(""),this.scope=ec,this.errors=ep,this.expectedType=eh,this._scope=e_,this.options=eg}parse(F,el,eh,ec,ep={}){return el||eh?this.concat(el,null,eh,ec)._parse(F,ep):this._parse(F,ep)}parseObjectValue(F,el,eh,ec,ep,e_={}){return this.concat(el,eh,ec,ep)._parse(F,e_)}_parse(F,el){function r(F,el,eh){return"assert"===eh?new ur(el,[F]):"coerce"===eh?new dr(el,[F]):F}if(null!==F&&"string"!=typeof F&&"boolean"!=typeof F&&"number"!=typeof F||(F=["literal",F]),Array.isArray(F)){if(0===F.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');let eh="string"==typeof F[0]?this.registry[F[0]]:void 0;if(eh){let ec=eh.parse(F,this);if(!ec)return null;if(this.expectedType){let F=this.expectedType,eh=ec.type;if("string"!==F.kind&&"number"!==F.kind&&"boolean"!==F.kind&&"object"!==F.kind&&"array"!==F.kind||"value"!==eh.kind){if("color"!==F.kind&&"formatted"!==F.kind&&"resolvedImage"!==F.kind||"value"!==eh.kind&&"string"!==eh.kind){if(this.checkSubtype(F,eh))return null}else ec=r(ec,F,el.typeAnnotation||"coerce")}else ec=r(ec,F,el.typeAnnotation||"assert")}if(!(ec instanceof ar)&&"resolvedImage"!==ec.type.kind&&function On(F){if(F instanceof Rn)return On(F.boundExpression);if(F instanceof gr&&"error"===F.name||F instanceof vr||F instanceof Ur||F instanceof En||F instanceof Tn)return!1;let el=F instanceof dr||F instanceof ur,eh=!0;return F.eachChild(F=>{eh=el?eh&&On(F):eh&&F instanceof ar}),!!eh&&Bn(F)&&Dn(F,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}(ec)){let F=new yr(this._scope,this.options);try{ec=new ar(ec.type,ec.evaluate(F))}catch(F){return this.error(F.message),null}}return ec}return dr.parse(["to-array",F],this)}return this.error(void 0===F?"'undefined' value invalid. Use null instead.":"object"==typeof F?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof F} instead.`)}concat(F,el,eh,ec){let ep="number"==typeof F?this.path.concat(F):this.path;ep="string"==typeof el?ep.concat(el):ep;let e_=ec?this.scope.concat(ec):this.scope;return new Ln(this.registry,ep,eh||null,e_,this.errors,this._scope,this.options)}error(F,...el){let eh=`${this.key}${el.map(F=>`[${F}]`).join("")}`;this.errors.push(new Ve(eh,F))}checkSubtype(F,el){let eh=Xe(F,el);return eh&&this.error(eh),eh}};var iG=Ln;function Nn(F,el){let eh=F.length-1,ec,ep,e_=0,eg=eh,ey=0;for(;e_<=eg;)if(ec=F[ey=Math.floor((e_+eg)/2)],ep=F[ey+1],ec<=el){if(ey===eh||el<ep)return ey;e_=ey+1}else{if(!(ec>el))throw new or("Input is not a number.");eg=ey-1}return 0}let Un=class Un{constructor(F,el,eh){for(let[ec,ep]of(this.type=F,this.input=el,this.labels=[],this.outputs=[],eh))this.labels.push(ec),this.outputs.push(ep)}static parse(F,el){if(F.length-1<4)return el.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if((F.length-1)%2!=0)return el.error("Expected an even number of arguments.");let eh=el.parse(F[1],1,iM);if(!eh)return null;let ec=[],ep=null;el.expectedType&&"value"!==el.expectedType.kind&&(ep=el.expectedType);for(let eh=1;eh<F.length;eh+=2){let e_=1===eh?-1/0:F[eh],eg=F[eh+1],ey=eh,eb=eh+1;if("number"!=typeof e_)return el.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ey);if(ec.length&&ec[ec.length-1][0]>=e_)return el.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',ey);let ew=el.parse(eg,eb,ep);if(!ew)return null;ep=ep||ew.type,ec.push([e_,ew])}return new Un(ep,eh,ec)}evaluate(F){let el=this.labels,eh=this.outputs;if(1===el.length)return eh[0].evaluate(F);let ec=this.input.evaluate(F);if(ec<=el[0])return eh[0].evaluate(F);let ep=el.length;return ec>=el[ep-1]?eh[ep-1].evaluate(F):eh[Nn(el,ec)].evaluate(F)}eachChild(F){for(let el of(F(this.input),this.outputs))F(el)}outputDefined(){return this.outputs.every(F=>F.outputDefined())}serialize(){let F=["step",this.input.serialize()];for(let el=0;el<this.labels.length;el++)el>0&&F.push(this.labels[el]),F.push(this.outputs[el].serialize());return F}};let iq=4/29,i$=6/29,iH=3*i$*i$,iZ=i$*i$*i$,iW=Math.PI/180,iY=180/Math.PI;function Wn(F){return F>iZ?Math.pow(F,1/3):F/iH+iq}function Kn(F){return F>i$?F*F*F:iH*(F-iq)}function Jn(F){return 255*(F<=.0031308?12.92*F:1.055*Math.pow(F,1/2.4)-.055)}function Qn(F){return(F/=255)<=.04045?F/12.92:Math.pow((F+.055)/1.055,2.4)}function ti(F){let el=Qn(F.r),eh=Qn(F.g),ec=Qn(F.b),ep=Wn((.4124564*el+.3575761*eh+.1804375*ec)/.95047),e_=Wn((.2126729*el+.7151522*eh+.072175*ec)/1);return{l:116*e_-16,a:500*(ep-e_),b:200*(e_-Wn((.0193339*el+.119192*eh+.9503041*ec)/1.08883)),alpha:F.a}}function ei(F){let el=(F.l+16)/116,eh=isNaN(F.a)?el:el+F.a/500,ec=isNaN(F.b)?el:el-F.b/200;return el=1*Kn(el),eh=.95047*Kn(eh),ec=1.08883*Kn(ec),new Se(Jn(3.2404542*eh-1.5371385*el-.4985314*ec),Jn(-.969266*eh+1.8760108*el+.041556*ec),Jn(.0556434*eh-.2040259*el+1.0572252*ec),F.alpha)}let iX={forward:ti,reverse:ei,interpolate:function(F,el,eh){return{l:Ee(F.l,el.l,eh),a:Ee(F.a,el.a,eh),b:Ee(F.b,el.b,eh),alpha:Ee(F.alpha,el.alpha,eh)}}},iK={forward:function(F){let{l:el,a:eh,b:ec}=ti(F),ep=Math.atan2(ec,eh)*iY;return{h:ep<0?ep+360:ep,c:Math.sqrt(eh*eh+ec*ec),l:el,alpha:F.a}},reverse:function(F){let el=F.h*iW,eh=F.c;return ei({l:F.l,a:Math.cos(el)*eh,b:Math.sin(el)*eh,alpha:F.alpha})},interpolate:function(F,el,eh){return{h:function(F,el,eh){let ec=el-F;return F+eh*(ec>180||ec<-180?ec-360*Math.round(ec/360):ec)}(F.h,el.h,eh),c:Ee(F.c,el.c,eh),l:Ee(F.l,el.l,eh),alpha:Ee(F.alpha,el.alpha,eh)}}};var iJ=Object.freeze({__proto__:null,hcl:iK,lab:iX});let ai=class ai{constructor(F,el,eh,ec,ep){for(let[e_,eg]of(this.type=F,this.operator=el,this.interpolation=eh,this.input=ec,this.labels=[],this.outputs=[],ep))this.labels.push(e_),this.outputs.push(eg)}static interpolationFactor(F,el,eh,ec){let ep=0;if("exponential"===F.name)ep=oi(el,F.base,eh,ec);else if("linear"===F.name)ep=oi(el,1,eh,ec);else if("cubic-bezier"===F.name){let e_=F.controlPoints;ep=new tV(e_[0],e_[1],e_[2],e_[3]).solve(oi(el,1,eh,ec))}return ep}static parse(F,el){let[eh,ec,ep,...e_]=F;if(!Array.isArray(ec)||0===ec.length)return el.error("Expected an interpolation type expression.",1);if("linear"===ec[0])ec={name:"linear"};else if("exponential"===ec[0]){let F=ec[1];if("number"!=typeof F)return el.error("Exponential interpolation requires a numeric base.",1,1);ec={name:"exponential",base:F}}else{if("cubic-bezier"!==ec[0])return el.error(`Unknown interpolation type ${String(ec[0])}`,1,0);{let F=ec.slice(1);if(4!==F.length||F.some(F=>"number"!=typeof F||F<0||F>1))return el.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);ec={name:"cubic-bezier",controlPoints:F}}}if(F.length-1<4)return el.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length-1>3&&(F.length-1)%2!=0)return el.error("Expected an even number of arguments.");if(!(ep=el.parse(ep,2,iM)))return null;let eg=[],ey=null;"interpolate-hcl"===eh||"interpolate-lab"===eh?ey=iC:el.expectedType&&"value"!==el.expectedType.kind&&(ey=el.expectedType);for(let F=0;F<e_.length;F+=2){let eh=e_[F],ec=e_[F+1],ep=F+3,eb=F+4;if("number"!=typeof eh)return el.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',ep);if(eg.length&&eg[eg.length-1][0]>=eh)return el.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',ep);let ew=el.parse(ec,eb,ey);if(!ew)return null;ey=ey||ew.type,eg.push([eh,ew])}return"number"===ey.kind||"color"===ey.kind||"array"===ey.kind&&"number"===ey.itemType.kind&&"number"==typeof ey.N?new ai(ey,eh,ec,ep,eg):el.error(`Type ${Ye(ey)} is not interpolatable.`)}evaluate(F){let el=this.labels,eh=this.outputs;if(1===el.length)return eh[0].evaluate(F);let ec=this.input.evaluate(F);if(ec<=el[0])return eh[0].evaluate(F);let ep=el.length;if(ec>=el[ep-1])return eh[ep-1].evaluate(F);let e_=Nn(el,ec),eg=ai.interpolationFactor(this.interpolation,ec,el[e_],el[e_+1]),ey=eh[e_].evaluate(F),eb=eh[e_+1].evaluate(F);return"interpolate"===this.operator?iS[this.type.kind.toLowerCase()](ey,eb,eg):"interpolate-hcl"===this.operator?iK.reverse(iK.interpolate(iK.forward(ey),iK.forward(eb),eg)):iX.reverse(iX.interpolate(iX.forward(ey),iX.forward(eb),eg))}eachChild(F){for(let el of(F(this.input),this.outputs))F(el)}outputDefined(){return this.outputs.every(F=>F.outputDefined())}serialize(){let F;F="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];let el=[this.operator,F,this.input.serialize()];for(let F=0;F<this.labels.length;F++)el.push(this.labels[F],this.outputs[F].serialize());return el}};function oi(F,el,eh,ec){let ep=ec-eh,e_=F-eh;return 0===ep?0:1===el?e_/ep:(Math.pow(el,e_)-1)/(Math.pow(el,ep)-1)}let li=class li{constructor(F,el){this.type=F,this.args=el}static parse(F,el){if(F.length<2)return el.error("Expectected at least one argument.");let eh=null,ec=el.expectedType;ec&&"value"!==ec.kind&&(eh=ec);let ep=[];for(let ec of F.slice(1)){let F=el.parse(ec,1+ep.length,eh,void 0,{typeAnnotation:"omit"});if(!F)return null;eh=eh||F.type,ep.push(F)}let e_=ec&&ep.some(F=>Xe(ec,F.type));return new li(e_?iz:eh,ep)}evaluate(F){let el,eh=null,ec=0;for(let ep of this.args){if(ec++,(eh=ep.evaluate(F))&&eh instanceof er&&!eh.available&&(el||(el=eh),eh=null,ec===this.args.length))return el;if(null!==eh)break}return eh}eachChild(F){this.args.forEach(F)}outputDefined(){return this.args.every(F=>F.outputDefined())}serialize(){let F=["coalesce"];return this.eachChild(el=>{F.push(el.serialize())}),F}};let ui=class ui{constructor(F,el){this.type=el.type,this.bindings=[].concat(F),this.result=el}evaluate(F){return this.result.evaluate(F)}eachChild(F){for(let el of this.bindings)F(el[1]);F(this.result)}static parse(F,el){if(F.length<4)return el.error(`Expected at least 3 arguments, but found ${F.length-1} instead.`);let eh=[];for(let ec=1;ec<F.length-1;ec+=2){let ep=F[ec];if("string"!=typeof ep)return el.error(`Expected string, but found ${typeof ep} instead.`,ec);if(/[^a-zA-Z0-9_]/.test(ep))return el.error("Variable names must contain only alphanumeric characters or '_'.",ec);let e_=el.parse(F[ec+1],ec+1);if(!e_)return null;eh.push([ep,e_])}let ec=el.parse(F[F.length-1],F.length-1,el.expectedType,eh);return ec?new ui(eh,ec):null}outputDefined(){return this.result.outputDefined()}serialize(){let F=["let"];for(let[el,eh]of this.bindings)F.push(el,eh.serialize());return F.push(this.result.serialize()),F}};let ci=class ci{constructor(F,el,eh){this.type=F,this.index=el,this.input=eh}static parse(F,el){if(3!==F.length)return el.error(`Expected 2 arguments, but found ${F.length-1} instead.`);let eh=el.parse(F[1],1,iM),ec=el.parse(F[2],2,Ge(el.expectedType||iz));return eh&&ec?new ci(ec.type.itemType,eh,ec):null}evaluate(F){let el=this.index.evaluate(F),eh=this.input.evaluate(F);if(el<0)throw new or(`Array index out of bounds: ${el} < 0.`);if(el>=eh.length)throw new or(`Array index out of bounds: ${el} > ${eh.length-1}.`);if(el!==Math.floor(el))throw new or(`Array index must be an integer, but found ${el} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return eh[el]}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}};let hi=class hi{constructor(F,el,eh){this.type=F,this.index=el,this.input=eh}static parse(F,el){if(3!==F.length)return el.error(`Expected 2 arguments, but found ${F.length-1} instead.`);let eh=el.parse(F[1],1,iM),ec=el.parse(F[2],2,Ge(el.expectedType||iz));return eh&&ec?new hi(ec.type.itemType,eh,ec):null}evaluate(F){let el=this.index.evaluate(F),eh=this.input.evaluate(F);if(el<0)throw new or(`Array index out of bounds: ${el} < 0.`);if(el>eh.length-1)throw new or(`Array index out of bounds: ${el} > ${eh.length-1}.`);if(el===Math.floor(el))return eh[el];let ec=Math.floor(el),ep=Math.ceil(el),e_=eh[ec],eg=eh[ep];if("number"!=typeof e_||"number"!=typeof eg)throw new or(`Cannot interpolate between non-number values at index ${el}.`);let ey=el-ec;return e_*(1-ey)+eg*ey}eachChild(F){F(this.index),F(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}};let pi=class pi{constructor(F,el){this.type=iA,this.needle=F,this.haystack=el}static parse(F,el){if(3!==F.length)return el.error(`Expected 2 arguments, but found ${F.length-1} instead.`);let eh=el.parse(F[1],1,iz),ec=el.parse(F[2],2,iz);return eh&&ec?Ze(eh.type,[iA,iI,iM,iE,iz])?new pi(eh,ec):el.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(eh.type)} instead`):null}evaluate(F){let el=this.needle.evaluate(F),eh=this.haystack.evaluate(F);if(null==eh)return!1;if(!We(el,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(ir(el))} instead.`);if(!We(eh,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${Ye(ir(eh))} instead.`);return eh.indexOf(el)>=0}eachChild(F){F(this.needle),F(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}};let fi=class fi{constructor(F,el,eh){this.type=iM,this.needle=F,this.haystack=el,this.fromIndex=eh}static parse(F,el){if(F.length<=2||F.length>=5)return el.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);let eh=el.parse(F[1],1,iz),ec=el.parse(F[2],2,iz);if(!eh||!ec)return null;if(!Ze(eh.type,[iA,iI,iM,iE,iz]))return el.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(eh.type)} instead`);if(4===F.length){let ep=el.parse(F[3],3,iM);return ep?new fi(eh,ec,ep):null}return new fi(eh,ec)}evaluate(F){let el=this.needle.evaluate(F),eh=this.haystack.evaluate(F);if(!We(el,["boolean","string","number","null"]))throw new or(`Expected first argument to be of type boolean, string, number or null, but found ${Ye(ir(el))} instead.`);if(!We(eh,["string","array"]))throw new or(`Expected second argument to be of type array or string, but found ${Ye(ir(eh))} instead.`);if(this.fromIndex){let ec=this.fromIndex.evaluate(F);return eh.indexOf(el,ec)}return eh.indexOf(el)}eachChild(F){F(this.needle),F(this.haystack),this.fromIndex&&F(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){let F=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),F]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}};let di=class di{constructor(F,el,eh,ec,ep,e_){this.inputType=F,this.type=el,this.input=eh,this.cases=ec,this.outputs=ep,this.otherwise=e_}static parse(F,el){let eh,ec;if(F.length<5)return el.error(`Expected at least 4 arguments, but found only ${F.length-1}.`);if(F.length%2!=1)return el.error("Expected an even number of arguments.");el.expectedType&&"value"!==el.expectedType.kind&&(ec=el.expectedType);let ep={},e_=[];for(let eg=2;eg<F.length-1;eg+=2){let ey=F[eg],eb=F[eg+1];Array.isArray(ey)||(ey=[ey]);let ew=el.concat(eg);if(0===ey.length)return ew.error("Expected at least one branch label.");for(let F of ey){if("number"!=typeof F&&"string"!=typeof F)return ew.error("Branch labels must be numbers or strings.");if("number"==typeof F&&Math.abs(F)>Number.MAX_SAFE_INTEGER)return ew.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof F&&Math.floor(F)!==F)return ew.error("Numeric branch labels must be integer values.");if(eh){if(ew.checkSubtype(eh,ir(F)))return null}else eh=ir(F);if(void 0!==ep[String(F)])return ew.error("Branch labels must be unique.");ep[String(F)]=e_.length}let eT=el.parse(eb,eg,ec);if(!eT)return null;ec=ec||eT.type,e_.push(eT)}let eg=el.parse(F[1],1,iz);if(!eg)return null;let ey=el.parse(F[F.length-1],F.length-1,ec);return ey?"value"!==eg.type.kind&&el.concat(1).checkSubtype(eh,eg.type)?null:new di(eh,ec,eg,ep,e_,ey):null}evaluate(F){let el=this.input.evaluate(F);return(ir(el)===this.inputType&&this.outputs[this.cases[el]]||this.otherwise).evaluate(F)}eachChild(F){F(this.input),this.outputs.forEach(F),F(this.otherwise)}outputDefined(){return this.outputs.every(F=>F.outputDefined())&&this.otherwise.outputDefined()}serialize(){let F=["match",this.input.serialize()],el=Object.keys(this.cases).sort(),eh=[],ec={};for(let F of el){let el=ec[this.cases[F]];void 0===el?(ec[this.cases[F]]=eh.length,eh.push([this.cases[F],[F]])):eh[el][1].push(F)}let i=F=>"number"===this.inputType.kind?Number(F):F;for(let[el,ec]of eh)F.push(1===ec.length?i(ec[0]):ec.map(i)),F.push(this.outputs[el].serialize());return F.push(this.otherwise.serialize()),F}};let mi=class mi{constructor(F,el,eh){this.type=F,this.branches=el,this.otherwise=eh}static parse(F,el){let eh;if(F.length<4)return el.error(`Expected at least 3 arguments, but found only ${F.length-1}.`);if(F.length%2!=0)return el.error("Expected an odd number of arguments.");el.expectedType&&"value"!==el.expectedType.kind&&(eh=el.expectedType);let ec=[];for(let ep=1;ep<F.length-1;ep+=2){let e_=el.parse(F[ep],ep,iA);if(!e_)return null;let eg=el.parse(F[ep+1],ep+1,eh);if(!eg)return null;ec.push([e_,eg]),eh=eh||eg.type}let ep=el.parse(F[F.length-1],F.length-1,eh);return ep?new mi(eh,ec,ep):null}evaluate(F){for(let[el,eh]of this.branches)if(el.evaluate(F))return eh.evaluate(F);return this.otherwise.evaluate(F)}eachChild(F){for(let[el,eh]of this.branches)F(el),F(eh);F(this.otherwise)}outputDefined(){return this.branches.every(([F,el])=>el.outputDefined())&&this.otherwise.outputDefined()}serialize(){let F=["case"];return this.eachChild(el=>{F.push(el.serialize())}),F}};let yi=class yi{constructor(F,el,eh,ec){this.type=F,this.input=el,this.beginIndex=eh,this.endIndex=ec}static parse(F,el){if(F.length<=2||F.length>=5)return el.error(`Expected 3 or 4 arguments, but found ${F.length-1} instead.`);let eh=el.parse(F[1],1,iz),ec=el.parse(F[2],2,iM);if(!eh||!ec)return null;if(!Ze(eh.type,[Ge(iz),iI,iz]))return el.error(`Expected first argument to be of type array or string, but found ${Ye(eh.type)} instead`);if(4===F.length){let ep=el.parse(F[3],3,iM);return ep?new yi(eh.type,eh,ec,ep):null}return new yi(eh.type,eh,ec)}evaluate(F){let el=this.input.evaluate(F),eh=this.beginIndex.evaluate(F);if(!We(el,["string","array"]))throw new or(`Expected first argument to be of type array or string, but found ${Ye(ir(el))} instead.`);if(this.endIndex){let ec=this.endIndex.evaluate(F);return el.slice(eh,ec)}return el.slice(eh)}eachChild(F){F(this.input),F(this.beginIndex),this.endIndex&&F(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){let F=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),F]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}};function gi(F,el){return"=="===F||"!="===F?"boolean"===el.kind||"string"===el.kind||"number"===el.kind||"null"===el.kind||"value"===el.kind:"string"===el.kind||"number"===el.kind||"value"===el.kind}function xi(F,el,eh,ec){return 0===ec.compare(el,eh)}function vi(F,el,eh){let ec="=="!==F&&"!="!==F;return class i{constructor(F,el,eh){this.type=iA,this.lhs=F,this.rhs=el,this.collator=eh,this.hasUntypedArgument="value"===F.type.kind||"value"===el.type.kind}static parse(F,el){if(3!==F.length&&4!==F.length)return el.error("Expected two or three arguments.");let eh=F[0],ep=el.parse(F[1],1,iz);if(!ep)return null;if(!gi(eh,ep.type))return el.concat(1).error(`"${eh}" comparisons are not supported for type '${Ye(ep.type)}'.`);let e_=el.parse(F[2],2,iz);if(!e_)return null;if(!gi(eh,e_.type))return el.concat(2).error(`"${eh}" comparisons are not supported for type '${Ye(e_.type)}'.`);if(ep.type.kind!==e_.type.kind&&"value"!==ep.type.kind&&"value"!==e_.type.kind)return el.error(`Cannot compare types '${Ye(ep.type)}' and '${Ye(e_.type)}'.`);ec&&("value"===ep.type.kind&&"value"!==e_.type.kind?ep=new ur(e_.type,[ep]):"value"!==ep.type.kind&&"value"===e_.type.kind&&(e_=new ur(ep.type,[e_])));let eg=null;if(4===F.length){if("string"!==ep.type.kind&&"string"!==e_.type.kind&&"value"!==ep.type.kind&&"value"!==e_.type.kind)return el.error("Cannot use collator to compare non-string types.");if(!(eg=el.parse(F[3],3,iD)))return null}return new i(ep,e_,eg)}evaluate(ep){let e_=this.lhs.evaluate(ep),eg=this.rhs.evaluate(ep);if(ec&&this.hasUntypedArgument){let el=ir(e_),eh=ir(eg);if(el.kind!==eh.kind||"string"!==el.kind&&"number"!==el.kind)throw new or(`Expected arguments for "${F}" to be (string, string) or (number, number), but found (${el.kind}, ${eh.kind}) instead.`)}if(this.collator&&!ec&&this.hasUntypedArgument){let F=ir(e_),eh=ir(eg);if("string"!==F.kind||"string"!==eh.kind)return el(ep,e_,eg)}return this.collator?eh(ep,e_,eg,this.collator.evaluate(ep)):el(ep,e_,eg)}eachChild(F){F(this.lhs),F(this.rhs),this.collator&&F(this.collator)}outputDefined(){return!0}serialize(){let el=[F];return this.eachChild(F=>{el.push(F.serialize())}),el}}}let iQ=vi("==",function(F,el,eh){return el===eh},xi),i0=vi("!=",function(F,el,eh){return el!==eh},function(F,el,eh,ec){return!xi(0,el,eh,ec)}),i1=vi("<",function(F,el,eh){return el<eh},function(F,el,eh,ec){return 0>ec.compare(el,eh)}),i2=vi(">",function(F,el,eh){return el>eh},function(F,el,eh,ec){return ec.compare(el,eh)>0}),i3=vi("<=",function(F,el,eh){return el<=eh},function(F,el,eh,ec){return 0>=ec.compare(el,eh)}),i4=vi(">=",function(F,el,eh){return el>=eh},function(F,el,eh,ec){return ec.compare(el,eh)>=0});let Si=class Si{constructor(F,el,eh,ec,ep,e_){this.type=iI,this.number=F,this.locale=el,this.currency=eh,this.unit=ec,this.minFractionDigits=ep,this.maxFractionDigits=e_}static parse(F,el){if(3!==F.length)return el.error("Expected two arguments.");let eh=el.parse(F[1],1,iM);if(!eh)return null;let ec=F[2];if("object"!=typeof ec||Array.isArray(ec))return el.error("NumberFormat options argument must be an object.");let ep=null;if(ec.locale&&!(ep=el.parseObjectValue(ec.locale,2,"locale",iI)))return null;let e_=null;if(ec.currency&&!(e_=el.parseObjectValue(ec.currency,2,"currency",iI)))return null;let eg=null;if(ec.unit&&!(eg=el.parseObjectValue(ec.unit,2,"unit",iI)))return null;let ey=null;if(ec["min-fraction-digits"]&&!(ey=el.parseObjectValue(ec["min-fraction-digits"],2,"min-fraction-digits",iM)))return null;let eb=null;return!ec["max-fraction-digits"]||(eb=el.parseObjectValue(ec["max-fraction-digits"],2,"max-fraction-digits",iM))?new Si(eh,ep,e_,eg,ey,eb):null}evaluate(F){return new Intl.NumberFormat(this.locale?this.locale.evaluate(F):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(F):void 0,unit:this.unit?this.unit.evaluate(F):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(F):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(F):void 0}).format(this.number.evaluate(F))}eachChild(F){F(this.number),this.locale&&F(this.locale),this.currency&&F(this.currency),this.unit&&F(this.unit),this.minFractionDigits&&F(this.minFractionDigits),this.maxFractionDigits&&F(this.maxFractionDigits)}outputDefined(){return!1}serialize(){let F={};return this.locale&&(F.locale=this.locale.serialize()),this.currency&&(F.currency=this.currency.serialize()),this.unit&&(F.unit=this.unit.serialize()),this.minFractionDigits&&(F["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(F["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),F]}};let Pi=class Pi{constructor(F){this.type=iM,this.input=F}static parse(F,el){if(2!==F.length)return el.error(`Expected 1 argument, but found ${F.length-1} instead.`);let eh=el.parse(F[1],1);return eh?"array"!==eh.type.kind&&"string"!==eh.type.kind&&"value"!==eh.type.kind?el.error(`Expected argument of type string or array, but found ${Ye(eh.type)} instead.`):new Pi(eh):null}evaluate(F){let el=this.input.evaluate(F);if("string"==typeof el||Array.isArray(el))return el.length;throw new or(`Expected value to be of type string or array, but found ${Ye(ir(el))} instead.`)}eachChild(F){F(this.input)}outputDefined(){return!1}serialize(){let F=["length"];return this.eachChild(el=>{F.push(el.serialize())}),F}};function Ei(F){return function(){let el=Math.imul((F=1831565813+(F|=0)|0)^F>>>15,1|F);return(((el=el+Math.imul(el^el>>>7,61|el)^el)^el>>>14)>>>0)/4294967296}}let i5={"==":iQ,"!=":i0,">":i2,"<":i1,">=":i4,"<=":i3,array:ur,at:ci,"at-interpolated":hi,boolean:ur,case:mi,coalesce:li,collator:vr,format:cr,image:hr,in:pi,"index-of":fi,interpolate:ai,"interpolate-hcl":ai,"interpolate-lab":ai,length:Pi,let:ui,literal:ar,match:di,number:ur,"number-format":Si,object:ur,slice:yi,step:Un,string:ur,"to-boolean":dr,"to-color":dr,"to-number":dr,"to-string":dr,var:Rn,within:Ur,distance:En,config:Tn};function ki(F,[el,eh,ec,ep]){el=el.evaluate(F),eh=eh.evaluate(F),ec=ec.evaluate(F);let e_=ep?ep.evaluate(F):1,eg=rr(el,eh,ec,e_);if(eg)throw new or(eg);return new Se(el/255*e_,eh/255*e_,ec/255*e_,e_)}function Ti(F,[el,eh,ec,ep]){var e_,eg,ey;el=el.evaluate(F),eh=eh.evaluate(F),ec=ec.evaluate(F);let eb=ep?ep.evaluate(F):1,ew=(e_=el,eg=eh,ey=ec,"number"==typeof e_&&e_>=0&&e_<=360?"number"==typeof eg&&eg>=0&&eg<=100&&"number"==typeof ey&&ey>=0&&ey<=100?void 0===eb||"number"==typeof eb&&eb>=0&&eb<=1?null:`Invalid hsla value [${[e_,eg,ey,eb].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof eb?[e_,eg,ey,eb]:[e_,eg,ey]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof eb?[e_,eg,ey,eb]:[e_,eg,ey]).join(", ")}]: 'h' must be between 0 and 360.`);if(ew)throw new or(ew);let eT=`hsla(${el}, ${eh}%, ${ec}%, ${eb})`,eS=Se.parse(eT);if(!eS)throw new or(`Failed to parse HSLA color: ${eT}`);return eS}function Vi(F,el){let eh=el[F];return void 0===eh?null:eh}function Ci(F){return{type:F}}function Di(F){return{result:"success",value:F}}function Ri(F){return{result:"error",value:F}}function Li(F,el){return!!F&&!!F.parameters&&F.parameters.indexOf(el)>-1}function Fi(F){return"data-driven"===F["property-type"]}function Oi(F){return Li(F.expression,"measure-light")}function Ni(F){return Li(F.expression,"zoom")}function Ui(F){return!!F.expression&&F.expression.interpolated}function ji(F){return"object"==typeof F&&null!==F&&!Array.isArray(F)}function qi(F){return F}function Gi(F,el,eh){return void 0!==F?F:void 0!==el?el:void 0!==eh?eh:void 0}function Yi(F,el,eh,ec,ep){return Gi(typeof eh===ep?ec[eh]:void 0,F.default,el.default)}function Hi(F,el,eh){if("number"!==pr(eh))return Gi(F.default,el.default);let ec=F.stops.length;if(1===ec||eh<=F.stops[0][0])return F.stops[0][1];if(eh>=F.stops[ec-1][0])return F.stops[ec-1][1];let ep=Nn(F.stops.map(F=>F[0]),eh);return F.stops[ep][1]}function Xi(F,el,eh){let ec=void 0!==F.base?F.base:1;if("number"!==pr(eh))return Gi(F.default,el.default);let ep=F.stops.length;if(1===ep||eh<=F.stops[0][0])return F.stops[0][1];if(eh>=F.stops[ep-1][0])return F.stops[ep-1][1];let e_=Nn(F.stops.map(F=>F[0]),eh),eg=function(F,el,eh,ec){let ep=ec-eh,e_=F-eh;return 0===ep?0:1===el?e_/ep:(Math.pow(el,e_)-1)/(Math.pow(el,ep)-1)}(eh,ec,F.stops[e_][0],F.stops[e_+1][0]),ey=F.stops[e_][1],eb=F.stops[e_+1][1],ew=iS[el.type]||qi;if(F.colorSpace&&"rgb"!==F.colorSpace){let el=iJ[F.colorSpace];ew=(F,eh)=>el.reverse(el.interpolate(el.forward(F),el.forward(eh),eg))}return"function"==typeof ey.evaluate?{evaluate(...F){let el=ey.evaluate.apply(void 0,F),eh=eb.evaluate.apply(void 0,F);if(void 0!==el&&void 0!==eh)return ew(el,eh,eg)}}:ew(ey,eb,eg)}function Zi(F,el,eh){return"color"===el.type?eh=Se.parse(eh):"formatted"===el.type?eh=Qe.fromString(eh.toString()):"resolvedImage"===el.type?eh=er.build(eh.toString()):pr(eh)===el.type||"enum"===el.type&&el.values[eh]||(eh=void 0),Gi(eh,F.default,el.default)}gr.register(i5,{error:[{kind:"error"},[iI],(F,[el])=>{throw new or(el.evaluate(F))}],typeof:[iI,[iz],(F,[el])=>Ye(ir(el.evaluate(F)))],"to-rgba":[Ge(iM,4),[iC],(F,[el])=>el.evaluate(F).toRenderColor(null).toArray()],"to-hsla":[Ge(iM,4),[iC],(F,[el])=>el.evaluate(F).toRenderColor(null).toHslaArray()],rgb:[iC,[iM,iM,iM],ki],rgba:[iC,[iM,iM,iM,iM],ki],hsl:[iC,[iM,iM,iM],Ti],hsla:[iC,[iM,iM,iM,iM],Ti],has:{type:iA,overloads:[[[iI],(F,[el])=>el.evaluate(F) in F.properties()],[[iI,iP],(F,[el,eh])=>el.evaluate(F) in eh.evaluate(F)]]},get:{type:iz,overloads:[[[iI],(F,[el])=>Vi(el.evaluate(F),F.properties())],[[iI,iP],(F,[el,eh])=>Vi(el.evaluate(F),eh.evaluate(F))]]},"feature-state":[iz,[iI],(F,[el])=>Vi(el.evaluate(F),F.featureState||{})],properties:[iP,[],F=>F.properties()],"geometry-type":[iI,[],F=>F.geometryType()],id:[iz,[],F=>F.id()],zoom:[iM,[],F=>F.globals.zoom],pitch:[iM,[],F=>F.globals.pitch||0],"distance-from-center":[iM,[],F=>F.distanceFromCenter()],"measure-light":[iM,[iI],(F,[el])=>F.measureLight(el.evaluate(F))],"heatmap-density":[iM,[],F=>F.globals.heatmapDensity||0],"line-progress":[iM,[],F=>F.globals.lineProgress||0],"raster-value":[iM,[],F=>F.globals.rasterValue||0],"raster-particle-speed":[iM,[],F=>F.globals.rasterParticleSpeed||0],"sky-radial-progress":[iM,[],F=>F.globals.skyRadialProgress||0],accumulated:[iz,[],F=>void 0===F.globals.accumulated?null:F.globals.accumulated],"+":[iM,Ci(iM),(F,el)=>{let eh=0;for(let ec of el)eh+=ec.evaluate(F);return eh}],"*":[iM,Ci(iM),(F,el)=>{let eh=1;for(let ec of el)eh*=ec.evaluate(F);return eh}],"-":{type:iM,overloads:[[[iM,iM],(F,[el,eh])=>el.evaluate(F)-eh.evaluate(F)],[[iM],(F,[el])=>-el.evaluate(F)]]},"/":[iM,[iM,iM],(F,[el,eh])=>el.evaluate(F)/eh.evaluate(F)],"%":[iM,[iM,iM],(F,[el,eh])=>el.evaluate(F)%eh.evaluate(F)],ln2:[iM,[],()=>Math.LN2],pi:[iM,[],()=>Math.PI],e:[iM,[],()=>Math.E],"^":[iM,[iM,iM],(F,[el,eh])=>Math.pow(el.evaluate(F),eh.evaluate(F))],sqrt:[iM,[iM],(F,[el])=>Math.sqrt(el.evaluate(F))],log10:[iM,[iM],(F,[el])=>Math.log(el.evaluate(F))/Math.LN10],ln:[iM,[iM],(F,[el])=>Math.log(el.evaluate(F))],log2:[iM,[iM],(F,[el])=>Math.log(el.evaluate(F))/Math.LN2],sin:[iM,[iM],(F,[el])=>Math.sin(el.evaluate(F))],cos:[iM,[iM],(F,[el])=>Math.cos(el.evaluate(F))],tan:[iM,[iM],(F,[el])=>Math.tan(el.evaluate(F))],asin:[iM,[iM],(F,[el])=>Math.asin(el.evaluate(F))],acos:[iM,[iM],(F,[el])=>Math.acos(el.evaluate(F))],atan:[iM,[iM],(F,[el])=>Math.atan(el.evaluate(F))],min:[iM,Ci(iM),(F,el)=>Math.min(...el.map(el=>el.evaluate(F)))],max:[iM,Ci(iM),(F,el)=>Math.max(...el.map(el=>el.evaluate(F)))],abs:[iM,[iM],(F,[el])=>Math.abs(el.evaluate(F))],round:[iM,[iM],(F,[el])=>{let eh=el.evaluate(F);return eh<0?-Math.round(-eh):Math.round(eh)}],floor:[iM,[iM],(F,[el])=>Math.floor(el.evaluate(F))],ceil:[iM,[iM],(F,[el])=>Math.ceil(el.evaluate(F))],"filter-==":[iA,[iI,iz],(F,[el,eh])=>F.properties()[el.value]===eh.value],"filter-id-==":[iA,[iz],(F,[el])=>F.id()===el.value],"filter-type-==":[iA,[iI],(F,[el])=>F.geometryType()===el.value],"filter-<":[iA,[iI,iz],(F,[el,eh])=>{let ec=F.properties()[el.value],ep=eh.value;return typeof ec==typeof ep&&ec<ep}],"filter-id-<":[iA,[iz],(F,[el])=>{let eh=F.id(),ec=el.value;return typeof eh==typeof ec&&eh<ec}],"filter->":[iA,[iI,iz],(F,[el,eh])=>{let ec=F.properties()[el.value],ep=eh.value;return typeof ec==typeof ep&&ec>ep}],"filter-id->":[iA,[iz],(F,[el])=>{let eh=F.id(),ec=el.value;return typeof eh==typeof ec&&eh>ec}],"filter-<=":[iA,[iI,iz],(F,[el,eh])=>{let ec=F.properties()[el.value],ep=eh.value;return typeof ec==typeof ep&&ec<=ep}],"filter-id-<=":[iA,[iz],(F,[el])=>{let eh=F.id(),ec=el.value;return typeof eh==typeof ec&&eh<=ec}],"filter->=":[iA,[iI,iz],(F,[el,eh])=>{let ec=F.properties()[el.value],ep=eh.value;return typeof ec==typeof ep&&ec>=ep}],"filter-id->=":[iA,[iz],(F,[el])=>{let eh=F.id(),ec=el.value;return typeof eh==typeof ec&&eh>=ec}],"filter-has":[iA,[iz],(F,[el])=>el.value in F.properties()],"filter-has-id":[iA,[],F=>null!==F.id()&&void 0!==F.id()],"filter-type-in":[iA,[Ge(iI)],(F,[el])=>el.value.indexOf(F.geometryType())>=0],"filter-id-in":[iA,[Ge(iz)],(F,[el])=>el.value.indexOf(F.id())>=0],"filter-in-small":[iA,[iI,Ge(iz)],(F,[el,eh])=>eh.value.indexOf(F.properties()[el.value])>=0],"filter-in-large":[iA,[iI,Ge(iz)],(F,[el,eh])=>(function(F,el,eh,ec){for(;eh<=ec;){let ep=eh+ec>>1;if(el[ep]===F)return!0;el[ep]>F?ec=ep-1:eh=ep+1}return!1})(F.properties()[el.value],eh.value,0,eh.value.length-1)],all:{type:iA,overloads:[[[iA,iA],(F,[el,eh])=>el.evaluate(F)&&eh.evaluate(F)],[Ci(iA),(F,el)=>{for(let eh of el)if(!eh.evaluate(F))return!1;return!0}]]},any:{type:iA,overloads:[[[iA,iA],(F,[el,eh])=>el.evaluate(F)||eh.evaluate(F)],[Ci(iA),(F,el)=>{for(let eh of el)if(eh.evaluate(F))return!0;return!1}]]},"!":[iA,[iA],(F,[el])=>!el.evaluate(F)],"is-supported-script":[iA,[iI],(F,[el])=>{let eh=F.globals&&F.globals.isSupportedScript;return!eh||eh(el.evaluate(F))}],upcase:[iI,[iI],(F,[el])=>el.evaluate(F).toUpperCase()],downcase:[iI,[iI],(F,[el])=>el.evaluate(F).toLowerCase()],concat:[iI,Ci(iz),(F,el)=>el.map(el=>sr(el.evaluate(F))).join("")],"resolved-locale":[iI,[iD],(F,[el])=>el.evaluate(F).resolvedLocale()],random:[iM,[iM,iM,iz],(F,el)=>{let eh;let[ec,ep,e_]=el.map(el=>el.evaluate(F));if(ec>ep||ec===ep)return ec;if("string"==typeof e_)eh=function(F){let el=0;if(0===F.length)return el;for(let eh=0;eh<F.length;eh++)el=(el<<5)-el+F.charCodeAt(eh)|0;return el}(e_);else{if("number"!=typeof e_)throw new or(`Invalid seed input: ${e_}`);eh=e_}return ec+Ei(eh)()*(ep-ec)}]});let Wi=class Wi{constructor(F,el,eh,ec){this.expression=F,this._warningHistory={},this._evaluator=new yr(eh,ec),this._defaultValue=el?"color"===el.type&&(ji(el.default)||Array.isArray(el.default))?new Se(0,0,0,0):"color"===el.type?Se.parse(el.default)||null:void 0===el.default?null:el.default:null,this._enumValues=el&&"enum"===el.type?el.values:null,this.configDependencies=Cn(F)}evaluateWithoutErrorHandling(F,el,eh,ec,ep,e_,eg,ey){return this._evaluator.globals=F,this._evaluator.feature=el,this._evaluator.featureState=eh,this._evaluator.canonical=ec||null,this._evaluator.availableImages=ep||null,this._evaluator.formattedSection=e_,this._evaluator.featureTileCoord=eg||null,this._evaluator.featureDistanceData=ey||null,this.expression.evaluate(this._evaluator)}evaluate(F,el,eh,ec,ep,e_,eg,ey){this._evaluator.globals=F,this._evaluator.feature=el||null,this._evaluator.featureState=eh||null,this._evaluator.canonical=ec||null,this._evaluator.availableImages=ep||null,this._evaluator.formattedSection=e_||null,this._evaluator.featureTileCoord=eg||null,this._evaluator.featureDistanceData=ey||null;try{let F=this.expression.evaluate(this._evaluator);if(null==F||"number"==typeof F&&F!=F)return this._defaultValue;if(this._enumValues&&!(F in this._enumValues))throw new or(`Expected value to be one of ${Object.keys(this._enumValues).map(F=>JSON.stringify(F)).join(", ")}, but found ${JSON.stringify(F)} instead.`);return F}catch(F){return this._warningHistory[F.message]||(this._warningHistory[F.message]=!0,"undefined"!=typeof console&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${F.message}`)),this._defaultValue}}};function Ki(F){return Array.isArray(F)&&F.length>0&&"string"==typeof F[0]&&F[0]in i5}function Ji(F,el,eh,ec){let ep=new iG(i5,[],el?function(F){let el={color:iC,string:iI,number:iM,enum:iI,boolean:iA,formatted:iR,resolvedImage:iL};return"array"===F.type?Ge(el[F.value]||iz,F.length):el[F.type]}(el):void 0,void 0,void 0,eh,ec),e_=ep.parse(F,void 0,void 0,void 0,el&&"string"===el.type?{typeAnnotation:"coerce"}:void 0);return e_?Di(new Wi(e_,el,eh,ec)):Ri(ep.errors)}let Qi=class Qi{constructor(F,el,eh,ec){this.kind=F,this._styleExpression=el,this.isLightConstant=eh,this.isLineProgressConstant=ec,this.isStateDependent="constant"!==F&&!Vn(el.expression),this.configDependencies=Cn(el.expression)}evaluateWithoutErrorHandling(F,el,eh,ec,ep,e_){return this._styleExpression.evaluateWithoutErrorHandling(F,el,eh,ec,ep,e_)}evaluate(F,el,eh,ec,ep,e_){return this._styleExpression.evaluate(F,el,eh,ec,ep,e_)}};let ts=class ts{constructor(F,el,eh,ec,ep,e_){this.kind=F,this.zoomStops=eh,this._styleExpression=el,this.isStateDependent="camera"!==F&&!Vn(el.expression),this.isLightConstant=ep,this.isLineProgressConstant=e_,this.configDependencies=Cn(el.expression),this.interpolationType=ec}evaluateWithoutErrorHandling(F,el,eh,ec,ep,e_){return this._styleExpression.evaluateWithoutErrorHandling(F,el,eh,ec,ep,e_)}evaluate(F,el,eh,ec,ep,e_){return this._styleExpression.evaluate(F,el,eh,ec,ep,e_)}interpolationFactor(F,el,eh){return this.interpolationType?ai.interpolationFactor(this.interpolationType,F,el,eh):0}};function es(F,el,eh,ec){if("error"===(F=Ji(F,el,eh,ec)).result)return F;let ep=F.value.expression,e_=Bn(ep);if(!e_&&!Fi(el))return Ri([new Ve("","data expressions not supported")]);let eg=Dn(ep,["zoom","pitch","distance-from-center"]);if(!eg&&!Ni(el))return Ri([new Ve("","zoom expressions not supported")]);let ey=Dn(ep,["measure-light"]);if(!ey&&!Oi(el))return Ri([new Ve("","measure-light expression not supported")]);let eb=Dn(ep,["line-progress"]);if(!eb&&!Li(el.expression,"line-progress"))return Ri([new Ve("","line-progress expression not supported")]);let ew=el.expression&&el.expression.relaxZoomRestriction,eT=function ns(F){let el=null;if(F instanceof ui)el=ns(F.result);else if(F instanceof li){for(let eh of F.args)if(el=ns(eh))break}else(F instanceof Un||F instanceof ai)&&F.input instanceof gr&&"zoom"===F.input.name&&(el=F);return el instanceof Ve||F.eachChild(F=>{let eh=ns(F);eh instanceof Ve?el=eh:el&&eh&&el!==eh&&(el=new Ve("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),el}(ep);return eT||eg||ew?eT instanceof Ve?Ri([eT]):eT instanceof ai&&!Ui(el)?Ri([new Ve("",'"interpolate" expressions cannot be used with this property')]):Di(eT?new ts(e_&&eb?"camera":"composite",F.value,eT.labels,eT instanceof ai?eT.interpolation:void 0,ey,eb):new Qi(e_&&eb?"constant":"source",F.value,ey,eb)):Ri([new Ve("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}let rs=class rs{constructor(F,el){this._parameters=F,this._specification=el,Be(this,function $i(F,el){let eh,ec,ep;let e_="color"===el.type,eg=F.stops&&"object"==typeof F.stops[0][0],ey=eg||!(eg||void 0!==F.property),eb=F.type||(Ui(el)?"exponential":"interval");if(e_&&((F=Be({},F)).stops&&(F.stops=F.stops.map(F=>[F[0],Se.parse(F[1])])),F.default=Se.parse(F.default?F.default:el.default)),F.colorSpace&&"rgb"!==F.colorSpace&&!iJ[F.colorSpace])throw Error(`Unknown color space: ${F.colorSpace}`);if("exponential"===eb)eh=Xi;else if("interval"===eb)eh=Hi;else if("categorical"===eb){for(let el of(eh=Yi,ec=Object.create(null),F.stops))ec[el[0]]=el[1];ep=typeof F.stops[0][0]}else{if("identity"!==eb)throw Error(`Unknown function type "${eb}"`);eh=Zi}if(eg){let eh={},ec=[];for(let el=0;el<F.stops.length;el++){let ep=F.stops[el],e_=ep[0].zoom;void 0===eh[e_]&&(eh[e_]={zoom:e_,type:F.type,property:F.property,default:F.default,stops:[]},ec.push(e_)),eh[e_].stops.push([ep[0].value,ep[1]])}let ep=[];for(let F of ec)ep.push([eh[F].zoom,$i(eh[F],el)]);let e_={name:"linear"};return{kind:"composite",interpolationType:e_,interpolationFactor:ai.interpolationFactor.bind(void 0,e_),zoomStops:ep.map(F=>F[0]),evaluate:({zoom:eh},ec)=>Xi({stops:ep,base:F.base},el,eh).evaluate(eh,ec)}}if(ey){let e_="exponential"===eb?{name:"exponential",base:void 0!==F.base?F.base:1}:null;return{kind:"camera",interpolationType:e_,interpolationFactor:ai.interpolationFactor.bind(void 0,e_),zoomStops:F.stops.map(F=>F[0]),evaluate:({zoom:e_})=>eh(F,el,e_,ec,ep)}}return{kind:"source",evaluate(e_,eg){let ey=eg&&eg.properties?eg.properties[F.property]:void 0;return void 0===ey?Gi(F.default,el.default):eh(F,el,ey,ec,ep)}}}(this._parameters,this._specification))}static deserialize(F){return new rs(F._parameters,F._specification)}static serialize(F){return{_parameters:F._parameters,_specification:F._specification}}};var i6,i8,i9=e(function(){if(i8)return i6;function e(F,el,eh){var ec=this.cells=[];if(F instanceof ArrayBuffer){this.arrayBuffer=F;var ep=new Int32Array(this.arrayBuffer);F=ep[0],this.d=(el=ep[1])+2*(eh=ep[2]);for(var e_=0;e_<this.d*this.d;e_++){var eg=ep[3+e_],ey=ep[3+e_+1];ec.push(eg===ey?null:ep.subarray(eg,ey))}var eb=ep[3+ec.length+1];this.keys=ep.subarray(ep[3+ec.length],eb),this.bboxes=ep.subarray(eb),this.insert=this._insertReadonly}else{this.d=el+2*eh;for(var ew=0;ew<this.d*this.d;ew++)ec.push([]);this.keys=[],this.bboxes=[]}this.n=el,this.extent=F,this.padding=eh,this.scale=el/F,this.uid=0;var eT=eh/el*F;this.min=-eT,this.max=F+eT}return i8=1,i6=e,e.prototype.insert=function(F,el,eh,ec,ep){this._forEachCell(el,eh,ec,ep,this._insertCell,this.uid++),this.keys.push(F),this.bboxes.push(el),this.bboxes.push(eh),this.bboxes.push(ec),this.bboxes.push(ep)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(F,el,eh,ec,ep,e_){this.cells[ep].push(e_)},e.prototype.query=function(F,el,eh,ec,ep){var e_=this.min,eg=this.max;if(F<=e_&&el<=e_&&eg<=eh&&eg<=ec&&!ep)return Array.prototype.slice.call(this.keys);var ey=[];return this._forEachCell(F,el,eh,ec,this._queryCell,ey,{},ep),ey},e.prototype._queryCell=function(F,el,eh,ec,ep,e_,eg,ey){var eb=this.cells[ep];if(null!==eb)for(var ew=this.keys,eT=this.bboxes,eS=0;eS<eb.length;eS++){var eE=eb[eS];if(void 0===eg[eE]){var eM=4*eE;(ey?ey(eT[eM+0],eT[eM+1],eT[eM+2],eT[eM+3]):F<=eT[eM+2]&&el<=eT[eM+3]&&eh>=eT[eM+0]&&ec>=eT[eM+1])?(eg[eE]=!0,e_.push(ew[eE])):eg[eE]=!1}}},e.prototype._forEachCell=function(F,el,eh,ec,ep,e_,eg,ey){for(var eb=this._convertToCellCoord(F),ew=this._convertToCellCoord(el),eT=this._convertToCellCoord(eh),eS=this._convertToCellCoord(ec),eE=eb;eE<=eT;eE++)for(var eM=ew;eM<=eS;eM++){var eI=this.d*eM+eE;if((!ey||ey(this._convertFromCellCoord(eE),this._convertFromCellCoord(eM),this._convertFromCellCoord(eE+1),this._convertFromCellCoord(eM+1)))&&ep.call(this,F,el,eh,ec,eI,e_,eg,ey))return}},e.prototype._convertFromCellCoord=function(F){return(F-this.padding)/this.scale},e.prototype._convertToCellCoord=function(F){return Math.max(0,Math.min(this.d-1,Math.floor(F*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var F=this.cells,el=3+this.cells.length+1+1,eh=0,ec=0;ec<this.cells.length;ec++)eh+=this.cells[ec].length;var ep=new Int32Array(el+eh+this.keys.length+this.bboxes.length);ep[0]=this.extent,ep[1]=this.n,ep[2]=this.padding;for(var e_=el,eg=0;eg<F.length;eg++){var ey=F[eg];ep[3+eg]=e_,ep.set(ey,e_),e_+=ey.length}return ep[3+F.length]=e_,ep.set(this.keys,e_),ep[3+F.length+1]=e_+=this.keys.length,ep.set(this.bboxes,e_),e_+=this.bboxes.length,ep.buffer},i6}());let i7={};function us(F,el,eh={}){Object.defineProperty(F,"_classRegistryKey",{value:el,writable:!1}),i7[el]={klass:F,omit:eh.omit||[]}}for(let F in us(Object,"Object"),i9.serialize=function(F,el){let eh=F.toArrayBuffer();return el&&el.add(eh),{buffer:eh}},i9.deserialize=function(F){return new i9(F.buffer)},Object.defineProperty(i9,"name",{value:"Grid"}),us(i9,"Grid"),"undefined"!=typeof DOMMatrix&&us(DOMMatrix,"DOMMatrix"),us(Se,"Color"),us(Error,"Error"),us(Qe,"Formatted"),us(Je,"FormattedSection"),us(te,"AJAXError"),us(er,"ResolvedImage"),us(rs,"StylePropertyFunction"),us(Wi,"StyleExpression",{omit:["_evaluator"]}),us(we,"ImageId"),us(tr,"ImageVariant"),us(ts,"ZoomDependentExpression"),us(Qi,"ZoomConstantExpression"),us(gr,"CompoundExpression",{omit:["_evaluate"]}),i5)i7[i5[F]._classRegistryKey]||us(i5[F],`Expression${F}`);function cs(F){return F&&"undefined"!=typeof ArrayBuffer&&(F instanceof ArrayBuffer||F.constructor&&"ArrayBuffer"===F.constructor.name)}function hs(F){return self.ImageBitmap&&F instanceof ImageBitmap}function ps(F,el){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp)return F;if(cs(F)||hs(F))return el&&el.add(F),F;if(ArrayBuffer.isView(F))return el&&el.add(F.buffer),F;if(F instanceof ImageData)return el&&el.add(F.data.buffer),F;if(Array.isArray(F)){let eh=[];for(let ec of F)eh.push(ps(ec,el));return eh}if(F instanceof Map){let el={$name:"Map",entries:[]};for(let[eh,ec]of F.entries())el.entries.push(ps(eh),ps(ec));return el}if(F instanceof Set){let el={$name:"Set"},eh=0;for(let ec of F.values())el[++eh]=ps(ec);return el}if(F instanceof DOMMatrix){let el={$name:"DOMMatrix"};for(let eh of["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"])el[eh]=F[eh];return el}if("bigint"==typeof F)return{$name:"BigInt",value:F.toString()};if("object"==typeof F){let eh=F.constructor,ec=eh._classRegistryKey;if(!ec)throw Error(`Can't serialize object of unregistered class "${eh.name}".`);let ep=eh.serialize?eh.serialize(F,el):{};if(!eh.serialize){for(let eh in F)F.hasOwnProperty(eh)&&(i7[ec].omit.indexOf(eh)>=0||(ep[eh]=ps(F[eh],el)));F instanceof Error&&(ep.message=F.message)}if(ep.$name)throw Error("$name property is reserved for worker serialization logic.");return"Object"!==ec&&(ep.$name=ec),ep}throw Error("can't serialize object of type "+typeof F)}function fs(F){if(null==F||"boolean"==typeof F||"number"==typeof F||"string"==typeof F||F instanceof Boolean||F instanceof Number||F instanceof String||F instanceof Date||F instanceof RegExp||cs(F)||hs(F)||ArrayBuffer.isView(F)||F instanceof ImageData)return F;if(Array.isArray(F))return F.map(fs);if("object"==typeof F){let el=F.$name||"Object";if("Map"===el){let el=F.entries||[],eh=new Map;for(let F=0;F<el.length;F+=2)eh.set(fs(el[F]),fs(el[F+1]));return eh}if("Set"===el){let el=new Set;for(let eh of Object.keys(F))"$name"!==eh&&el.add(fs(F[eh]));return el}if("DOMMatrix"===el){let el;return el=F.is2D?[F.a,F.b,F.c,F.d,F.e,F.f]:[F.m11,F.m12,F.m13,F.m14,F.m21,F.m22,F.m23,F.m24,F.m31,F.m32,F.m33,F.m34,F.m41,F.m42,F.m43,F.m44],new DOMMatrix(el)}if("BigInt"===el)return BigInt(F.value);let{klass:eh}=i7[el];if(!eh)throw Error(`Can't deserialize unregistered class "${el}".`);if(eh.deserialize)return eh.deserialize(F);let ec=Object.create(eh.prototype);for(let el of Object.keys(F))"$name"!==el&&(ec[el]=fs(F[el]));return ec}throw Error("can't deserialize object of type "+typeof F)}let ri={"Latin-1 Supplement":F=>F>=128&&F<=255,Arabic:F=>F>=1536&&F<=1791,"Arabic Supplement":F=>F>=1872&&F<=1919,"Arabic Extended-A":F=>F>=2208&&F<=2303,"Hangul Jamo":F=>F>=4352&&F<=4607,"Unified Canadian Aboriginal Syllabics":F=>F>=5120&&F<=5759,Khmer:F=>F>=6016&&F<=6143,"Unified Canadian Aboriginal Syllabics Extended":F=>F>=6320&&F<=6399,"General Punctuation":F=>F>=8192&&F<=8303,"Letterlike Symbols":F=>F>=8448&&F<=8527,"Number Forms":F=>F>=8528&&F<=8591,"Miscellaneous Technical":F=>F>=8960&&F<=9215,"Control Pictures":F=>F>=9216&&F<=9279,"Optical Character Recognition":F=>F>=9280&&F<=9311,"Enclosed Alphanumerics":F=>F>=9312&&F<=9471,"Geometric Shapes":F=>F>=9632&&F<=9727,"Miscellaneous Symbols":F=>F>=9728&&F<=9983,"Miscellaneous Symbols and Arrows":F=>F>=11008&&F<=11263,"CJK Radicals Supplement":F=>F>=11904&&F<=12031,"Kangxi Radicals":F=>F>=12032&&F<=12255,"Ideographic Description Characters":F=>F>=12272&&F<=12287,"CJK Symbols and Punctuation":F=>F>=12288&&F<=12351,Hiragana:F=>F>=12352&&F<=12447,Katakana:F=>F>=12448&&F<=12543,Bopomofo:F=>F>=12544&&F<=12591,"Hangul Compatibility Jamo":F=>F>=12592&&F<=12687,Kanbun:F=>F>=12688&&F<=12703,"Bopomofo Extended":F=>F>=12704&&F<=12735,"CJK Strokes":F=>F>=12736&&F<=12783,"Katakana Phonetic Extensions":F=>F>=12784&&F<=12799,"Enclosed CJK Letters and Months":F=>F>=12800&&F<=13055,"CJK Compatibility":F=>F>=13056&&F<=13311,"CJK Unified Ideographs Extension A":F=>F>=13312&&F<=19903,"Yijing Hexagram Symbols":F=>F>=19904&&F<=19967,"CJK Unified Ideographs":F=>F>=19968&&F<=40959,"Yi Syllables":F=>F>=40960&&F<=42127,"Yi Radicals":F=>F>=42128&&F<=42191,"Hangul Jamo Extended-A":F=>F>=43360&&F<=43391,"Hangul Syllables":F=>F>=44032&&F<=55215,"Hangul Jamo Extended-B":F=>F>=55216&&F<=55295,"Private Use Area":F=>F>=57344&&F<=63743,"CJK Compatibility Ideographs":F=>F>=63744&&F<=64255,"Arabic Presentation Forms-A":F=>F>=64336&&F<=65023,"Vertical Forms":F=>F>=65040&&F<=65055,"CJK Compatibility Forms":F=>F>=65072&&F<=65103,"Small Form Variants":F=>F>=65104&&F<=65135,"Arabic Presentation Forms-B":F=>F>=65136&&F<=65279,"Halfwidth and Fullwidth Forms":F=>F>=65280&&F<=65519,Osage:F=>F>=66736&&F<=66815,"CJK Unified Ideographs Extension B":F=>F>=131072&&F<=173791};function ms(F){for(let el of F)if(xs(el.charCodeAt(0)))return!0;return!1}function xs(F){return!(746!==F&&747!==F&&(F<4352||!(ri["Bopomofo Extended"](F)||ri.Bopomofo(F)||ri["CJK Compatibility Forms"](F)&&!(F>=65097&&F<=65103)||ri["CJK Compatibility Ideographs"](F)||ri["CJK Compatibility"](F)||ri["CJK Radicals Supplement"](F)||ri["CJK Strokes"](F)||!(!ri["CJK Symbols and Punctuation"](F)||F>=12296&&F<=12305||F>=12308&&F<=12319||12336===F)||ri["CJK Unified Ideographs Extension A"](F)||ri["CJK Unified Ideographs"](F)||ri["Enclosed CJK Letters and Months"](F)||ri["Hangul Compatibility Jamo"](F)||ri["Hangul Jamo Extended-A"](F)||ri["Hangul Jamo Extended-B"](F)||ri["Hangul Jamo"](F)||ri["Hangul Syllables"](F)||ri.Hiragana(F)||ri["Ideographic Description Characters"](F)||ri.Kanbun(F)||ri["Kangxi Radicals"](F)||ri["Katakana Phonetic Extensions"](F)||ri.Katakana(F)&&12540!==F||!(!ri["Halfwidth and Fullwidth Forms"](F)||65288===F||65289===F||65293===F||F>=65306&&F<=65310||65339===F||65341===F||65343===F||F>=65371&&F<=65503||65507===F||F>=65512&&F<=65519)||!(!ri["Small Form Variants"](F)||F>=65112&&F<=65118||F>=65123&&F<=65126)||ri["Unified Canadian Aboriginal Syllabics"](F)||ri["Unified Canadian Aboriginal Syllabics Extended"](F)||ri["Vertical Forms"](F)||ri["Yijing Hexagram Symbols"](F)||ri["Yi Syllables"](F)||ri["Yi Radicals"](F))))}function vs(F){return!(xs(F)||ri["Latin-1 Supplement"](F)&&(167===F||169===F||174===F||177===F||188===F||189===F||190===F||215===F||247===F)||ri["General Punctuation"](F)&&(8214===F||8224===F||8225===F||8240===F||8241===F||8251===F||8252===F||8258===F||8263===F||8264===F||8265===F||8273===F)||ri["Letterlike Symbols"](F)||ri["Number Forms"](F)||ri["Miscellaneous Technical"](F)&&(F>=8960&&F<=8967||F>=8972&&F<=8991||F>=8996&&F<=9e3||9003===F||F>=9085&&F<=9114||F>=9150&&F<=9165||9167===F||F>=9169&&F<=9179||F>=9186&&F<=9215)||ri["Control Pictures"](F)&&9251!==F||ri["Optical Character Recognition"](F)||ri["Enclosed Alphanumerics"](F)||ri["Geometric Shapes"](F)||ri["Miscellaneous Symbols"](F)&&!(F>=9754&&F<=9759)||ri["Miscellaneous Symbols and Arrows"](F)&&(F>=11026&&F<=11055||F>=11088&&F<=11097||F>=11192&&F<=11243)||ri["CJK Symbols and Punctuation"](F)||ri.Katakana(F)||ri["Private Use Area"](F)||ri["CJK Compatibility Forms"](F)||ri["Small Form Variants"](F)||ri["Halfwidth and Fullwidth Forms"](F)||8734===F||8756===F||8757===F||F>=9984&&F<=10087||F>=10102&&F<=10131||65532===F||65533===F)}function _s(F){return F>=1424&&F<=2303||ri["Arabic Presentation Forms-A"](F)||ri["Arabic Presentation Forms-B"](F)}let rh="deferred",ru="loading",rc="loaded",rp=null,rf="unavailable",rm=null,ks=function(F){F&&"string"==typeof F&&F.indexOf("NetworkError")>-1&&(rf="error"),rp&&rp(F)};function Ts(){r_.fire(new ge("pluginStateChange",{pluginStatus:rf,pluginURL:rm}))}let r_=new _e,Vs=function(){return rf},Cs=function(){if(rf!==rh||!rm)throw Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");rf=ru,Ts(),rm&&ne({url:rm},F=>{F?ks(F):(rf=rc,Ts())})},rb={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>rf===rc||null!=rb.applyArabicShaping,isLoading:()=>rf===ru,setState(F){rf=F.pluginStatus,rm=F.pluginURL},isParsed:()=>null!=rb.applyArabicShaping&&null!=rb.processBidirectionalText&&null!=rb.processStyledBidirectionalText,getPluginURL:()=>rm};let Rs=class Rs{constructor(F,el){this.zoom=F,el?(this.now=el.now,this.fadeDuration=el.fadeDuration,this.transition=el.transition,this.pitch=el.pitch,this.brightness=el.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(F){return function(F,el){for(let ec of F){var eh;if(eh=ec.charCodeAt(0),!el&&_s(eh)||eh>=2304&&eh<=3583||eh>=3840&&eh<=4255||ri.Khmer(eh))return!1}return!0}(F,rb.isLoaded())}};let Ls=class Ls{constructor(F,el,eh,ec){this.property=F,this.value=el,this.expression=function(F,el,eh,ec){if(ji(F))return new rs(F,el);if(Ki(F)||Array.isArray(F)&&F.length>0){let ep=es(F,el,eh,ec);if("error"===ep.result)throw Error(ep.value.map(F=>`${F.key}: ${F.message}`).join(", "));return ep.value}{let eh=F;return"string"==typeof F&&"color"===el.type&&(eh=Se.parse(F)),{kind:"constant",configDependencies:new Set,evaluate:()=>eh}}}(void 0===el?F.specification.default:el,F.specification,eh,ec)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(F,el,eh){return this.property.possiblyEvaluate(this,F,el,eh)}};let Fs=class Fs{constructor(F,el,eh){this.property=F,this.value=new Ls(F,void 0,el,eh)}transitioned(F,el){return new Ns(this.property,this.value,el,nt({},F.transition,this.transition),F.now)}untransitioned(){return new Ns(this.property,this.value,null,{},0)}};let Os=class Os{constructor(F,el,eh){this._properties=F,this._values=Object.create(F.defaultTransitionablePropertyValues),this._scope=el,this._options=eh,this.configDependencies=new Set}getValue(F){return ct(this._values[F].value.value)}setValue(F,el){this._values.hasOwnProperty(F)||(this._values[F]=new Fs(this._values[F].property,this._scope,this._options)),this._values[F].value=new Ls(this._values[F].property,null===el?void 0:ct(el),this._scope,this._options),this._values[F].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].value.expression.configDependencies]))}setTransitionOrValue(F,el){el&&(this._options=el);let eh=this._properties.properties;if(F)for(let el in F){let ec=F[el];if(el.endsWith("-transition")){let F=el.slice(0,-11);eh[F]&&this.setTransition(F,ec)}else eh.hasOwnProperty(el)&&this.setValue(el,ec)}}getTransition(F){return ct(this._values[F].transition)}setTransition(F,el){this._values.hasOwnProperty(F)||(this._values[F]=new Fs(this._values[F].property)),this._values[F].transition=ct(el)||void 0}serialize(){let F={};for(let el of Object.keys(this._values)){let eh=this.getValue(el);void 0!==eh&&(F[el]=eh);let ec=this.getTransition(el);void 0!==ec&&(F[`${el}-transition`]=ec)}return F}transitioned(F,el){let eh=new Us(this._properties);for(let ec of Object.keys(this._values))eh._values[ec]=this._values[ec].transitioned(F,el._values[ec]);return eh}untransitioned(){let F=new Us(this._properties);for(let el of Object.keys(this._values))F._values[el]=this._values[el].untransitioned();return F}};let Ns=class Ns{constructor(F,el,eh,ec,ep){let e_=ec.delay||0,eg=ec.duration||0;ep=ep||0,this.property=F,this.value=el,this.begin=ep+e_,this.end=this.begin+eg,F.specification.transition&&(ec.delay||ec.duration)&&(this.prior=eh)}possiblyEvaluate(F,el,eh){let ec=F.now||0,ep=this.value.possiblyEvaluate(F,el,eh),e_=this.prior;if(e_){if(ec>this.end||this.value.isDataDriven())return this.prior=null,ep;if(ec<this.begin)return e_.possiblyEvaluate(F,el,eh);{let eg=(ec-this.begin)/(this.end-this.begin);return this.property.interpolate(e_.possiblyEvaluate(F,el,eh),ep,W(eg))}}return ep}};let Us=class Us{constructor(F){this._properties=F,this._values=Object.create(F.defaultTransitioningPropertyValues)}possiblyEvaluate(F,el,eh){let ec=new $s(this._properties);for(let ep of Object.keys(this._values))ec._values[ep]=this._values[ep].possiblyEvaluate(F,el,eh);return ec}hasTransition(){for(let F of Object.keys(this._values))if(this._values[F].prior)return!0;return!1}};let js=class js{constructor(F,el,eh){this._properties=F,this._values=Object.create(F.defaultPropertyValues),this._scope=el,this._options=eh,this.configDependencies=new Set}getValue(F){return ct(this._values[F].value)}setValue(F,el){this._values[F]=new Ls(this._values[F].property,null===el?void 0:ct(el),this._scope,this._options),this._values[F].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[F].expression.configDependencies]))}serialize(){let F={};for(let el of Object.keys(this._values)){let eh=this.getValue(el);void 0!==eh&&(F[el]=eh)}return F}possiblyEvaluate(F,el,eh){let ec=new $s(this._properties);for(let ep of Object.keys(this._values))ec._values[ep]=this._values[ep].possiblyEvaluate(F,el,eh);return ec}};let qs=class qs{constructor(F,el,eh){this.property=F,this.value=el,this.parameters=eh}isConstant(){return"constant"===this.value.kind}constantOr(F){return"constant"===this.value.kind?this.value.value:F}evaluate(F,el,eh,ec){return this.property.evaluate(this.value,this.parameters,F,el,eh,ec)}};let $s=class $s{constructor(F){this._properties=F,this._values=Object.create(F.defaultPossiblyEvaluatedValues)}get(F){return this._values[F]}};let Gs=class Gs{constructor(F){this.specification=F}possiblyEvaluate(F,el){return F.expression.evaluate(el)}interpolate(F,el,eh){let ec=iS[this.specification.type];return ec?ec(F,el,eh):F}};let Ys=class Ys{constructor(F,el){this.specification=F,this.overrides=el}possiblyEvaluate(F,el,eh,ec){return new qs(this,"constant"===F.expression.kind||"camera"===F.expression.kind?{kind:"constant",value:F.expression.evaluate(el,null,{},eh,ec)}:F.expression,el)}interpolate(F,el,eh){if("constant"!==F.value.kind||"constant"!==el.value.kind)return F;if(void 0===F.value.value||void 0===el.value.value)return new qs(this,{kind:"constant",value:void 0},F.parameters);let ec=iS[this.specification.type];return ec?new qs(this,{kind:"constant",value:ec(F.value.value,el.value.value,eh)},F.parameters):F}evaluate(F,el,eh,ec,ep,e_){return"constant"===F.kind?F.value:F.evaluate(el,eh,ec,ep,e_)}};let Hs=class Hs{constructor(F){this.specification=F}possiblyEvaluate(F,el,eh,ec){return!!F.expression.evaluate(el,null,{},eh,ec)}interpolate(){return!1}};let Xs=class Xs{constructor(F){this.properties=F,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];let el=new Rs(0,{});for(let eh in F){let ec=F[eh];ec.specification.overridable&&this.overridableProperties.push(eh);let ep=this.defaultPropertyValues[eh]=new Ls(ec,void 0),e_=this.defaultTransitionablePropertyValues[eh]=new Fs(ec);this.defaultTransitioningPropertyValues[eh]=e_.untransitioned(),this.defaultPossiblyEvaluatedValues[eh]=ep.possiblyEvaluate(el)}}};us(Ys,"DataDrivenProperty"),us(Gs,"DataConstantProperty"),us(Hs,"ColorRampProperty");var rw=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"iconsets":{"experimental":true,"type":"iconsets"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"required":true,"type":"enum","values":{"sprite":1}},"url":{"required":true,"type":"string"}},"iconset_source":{"type":{"required":true,"type":"enum","values":{"source":1}},"source":{"required":true,"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","experimental":true,"private":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","experimental":true,"private":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","transition":true,"experimental":true,"private":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Ws(F){return F instanceof Number||F instanceof String||F instanceof Boolean?F.valueOf():F}function Ks(F){if(Array.isArray(F))return F.map(Ks);if(F instanceof Object&&!(F instanceof Number||F instanceof String||F instanceof Boolean)){let el={};for(let eh in F)el[eh]=Ks(F[eh]);return el}return Ws(F)}function Js(F){if(!0===F||!1===F)return!0;if(!Array.isArray(F)||0===F.length)return!1;switch(F[0]){case"has":return F.length>=2&&"$id"!==F[1]&&"$type"!==F[1];case"in":return F.length>=3&&("string"!=typeof F[1]||Array.isArray(F[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==F.length||Array.isArray(F[1])||Array.isArray(F[2]);case"any":case"all":for(let el of F.slice(1))if(!Js(el)&&"boolean"!=typeof el)return!1;return!0;default:return!0}}function Qs(F,el="",eh=null,ec="fill"){if(null==F)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Js(F)||(F=function aa(F){if(!F)return!0;let el=F[0];return F.length<=1?"any"!==el:"=="===el?oa(F[1],F[2],"=="):"!="===el?ca(oa(F[1],F[2],"==")):"<"===el||">"===el||"<="===el||">="===el?oa(F[1],F[2],el):"any"===el?["any"].concat(F.slice(1).map(aa)):"all"===el?["all"].concat(F.slice(1).map(aa)):"none"===el?["all"].concat(F.slice(1).map(aa).map(ca)):"in"===el?la(F[1],F.slice(2)):"!in"===el?ca(la(F[1],F.slice(2))):"has"===el?ua(F[1]):"!has"!==el||ca(ua(F[1]))}(F));let ep=F,e_=!0;try{e_=function(F){if(!ra(F))return F;let el=Ks(F);return function ea(F){let el=!1,eh=[];if("case"===F[0]){for(let ec=1;ec<F.length-1;ec+=2)el=el||ra(F[ec]),eh.push(F[ec+1]);eh.push(F[F.length-1])}else if("match"===F[0]){el=el||ra(F[1]);for(let el=2;el<F.length-1;el+=2)eh.push(F[el+1]);eh.push(F[F.length-1])}else if("step"===F[0]){el=el||ra(F[1]);for(let el=1;el<F.length-1;el+=2)eh.push(F[el+1])}el&&(F.length=0,F.push("any",...eh));for(let el=1;el<F.length;el++)ea(F[el])}(el),el=function ta(F){if(!Array.isArray(F))return F;let el=function(F){if(rT.has(F[0])){for(let el=1;el<F.length;el++)if(ra(F[el]))return!0}return F}(F);return!0===el?el:el.map(F=>ta(F))}(el)}(ep)}catch(F){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(ep,null,2)}
        `)}let eg=null,ey=null;if("background"!==ec&&"sky"!==ec&&"slot"!==ec){ey=rw[`filter_${ec}`];let F=Ji(e_,ey,el,eh);if("error"===F.result)throw Error(F.value.map(F=>`${F.key}: ${F.message}`).join(", "));eg=(el,eh,ec)=>F.value.evaluate(el,eh,{},ec)}let eb=null,ew=null;if(e_!==ep){let F=Ji(ep,ey,el,eh);if("error"===F.result)throw Error(F.value.map(F=>`${F.key}: ${F.message}`).join(", "));eb=(el,eh,ec,ep,e_)=>F.value.evaluate(el,eh,{},ec,void 0,void 0,ep,e_),ew=!Bn(F.value.expression)}return{filter:eg,dynamicFilter:eb||void 0,needGeometry:function sa(F){if(!Array.isArray(F))return!1;if("within"===F[0]||"distance"===F[0])return!0;for(let el=1;el<F.length;el++)if(sa(F[el]))return!0;return!1}(e_),needFeature:!!ew}}function ra(F){var el;if(!Array.isArray(F))return!1;if("pitch"===(el=F[0])||"distance-from-center"===el)return!0;for(let el=1;el<F.length;el++)if(ra(F[el]))return!0;return!1}let rT=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function ia(F,el){return F<el?-1:F>el?1:0}function oa(F,el,eh){switch(F){case"$type":return[`filter-type-${eh}`,el];case"$id":return[`filter-id-${eh}`,el];default:return[`filter-${eh}`,F,el]}}function la(F,el){if(0===el.length)return!1;switch(F){case"$type":return["filter-type-in",["literal",el]];case"$id":return["filter-id-in",["literal",el]];default:return el.length>200&&!el.some(F=>typeof F!=typeof el[0])?["filter-in-large",F,["literal",el.sort(ia)]]:["filter-in-small",F,["literal",el]]}}function ua(F){switch(F){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",F]}}function ca(F){return["!",F]}function pa(F,el){return el?`${F}${el}`:F}let rS="-transition",rE=new Set(["fill","line","background","hillshade","raster"]);let ma=class ma extends _e{constructor(F,el,eh,ec,ep){if(super(),this.id=F.id,this.fqid=pa(this.id,eh),this.type=F.type,this.scope=eh,this.lut=ec,this.options=ep,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==F.type){if(this.metadata=F.metadata,this.minzoom=F.minzoom,this.maxzoom=F.maxzoom,F.type&&"background"!==F.type&&"sky"!==F.type&&"slot"!==F.type){this.source=F.source,this.sourceLayer=F["source-layer"],this.filter=F.filter;let el=Ji(this.filter,rw[`filter_${F.type}`]);"error"!==el.result&&(this.configDependencies=new Set([...this.configDependencies,...el.value.configDependencies]))}if(F.slot&&(this.slot=F.slot),el.layout&&(this._unevaluatedLayout=new js(el.layout,this.scope,ep),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),el.paint){for(let eh in this._transitionablePaint=new Os(el.paint,this.scope,ep),F.paint)this.setPaintProperty(eh,F.paint[eh]);for(let el in F.layout)this.setLayoutProperty(el,F.layout[el]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new $s(el.paint)}}}onAdd(F){}onRemove(F){}isDraped(F){return!this.is3D(!0)&&rE.has(this.type)}getLayoutProperty(F){return"visibility"===F?this.visibility:this._unevaluatedLayout.getValue(F)}setLayoutProperty(F,el){if("custom"===this.type&&"visibility"===F)return void(this.visibility=el);let eh=this._unevaluatedLayout;eh._properties.properties[F]&&(eh.setValue(F,el),this.configDependencies=new Set([...this.configDependencies,...eh.configDependencies]),"visibility"===F&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(F){return F.endsWith(rS)?this._transitionablePaint.getTransition(F.slice(0,-11)):this._transitionablePaint.getValue(F)}setPaintProperty(F,el){let eh=this._transitionablePaint,ec=eh._properties.properties;if(F.endsWith(rS)){let ep=F.slice(0,-11);return ec[ep]&&eh.setTransition(ep,el||void 0),!1}if(!ec[F])return!1;let ep=eh._values[F],e_=ep.value.isDataDriven(),eg=ep.value;eh.setValue(F,el),this.configDependencies=new Set([...this.configDependencies,...eh.configDependencies]),this._handleSpecialPaintPropertyUpdate(F);let ey=eh._values[F].value,eb=ey.isDataDriven(),ew=F.endsWith("pattern")||"line-dasharray"===F;return eb||e_||ew||this._handleOverridablePaintPropertyUpdate(F,eg,ey)}_handleSpecialPaintPropertyUpdate(F){}getProgramIds(){return null}getDefaultProgramParams(F,el,eh){return null}_handleOverridablePaintPropertyUpdate(F,el,eh){return!1}isHidden(F){return!!(this.minzoom&&F<this.minzoom)||!!(this.maxzoom&&F>=this.maxzoom)||"none"===this.visibility}updateTransitions(F){this._transitioningPaint=this._transitionablePaint.transitioned(F,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(F,el){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(F,void 0,el)),this.paint=this._transitioningPaint.possiblyEvaluate(F,void 0,el)}serialize(){return ut({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(F,el)=>!(void 0===F||"layout"===el&&!Object.keys(F).length||"paint"===el&&!Object.keys(F).length))}is3D(F){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(let F in this.paint._values){let el=this.paint.get(F);if(el instanceof qs&&Fi(el.property.specification)&&("source"===el.value.kind||"composite"===el.value.kind)&&el.value.isStateDependent)return!0}return!1}compileFilter(F){this._filterCompiled||(this._featureFilter=Qs(this.filter,this.scope,F),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(F){this._stats&&("shadow"===F.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(F){}queryIntersectsFeature(F,el,eh,ec,ep,e_,eg,ey,eb){}};let rM={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};let ga=class ga{constructor(F,el){this._structArray=F,this._pos1=el*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}};let xa=class xa{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(F,el){return F._trim(),el&&(F.isTransferred=!0,el.add(F.arrayBuffer)),{length:F.length,arrayBuffer:F.arrayBuffer}}static deserialize(F){let el=Object.create(this.prototype);return el.arrayBuffer=F.arrayBuffer,el.length=F.length,el.capacity=F.arrayBuffer.byteLength/el.bytesPerElement,el._refreshViews(),el}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(F){this.reserve(F),this.length=F}reserve(F){if(F>this.capacity){this.capacity=Math.max(F,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);let el=this.uint8;this._refreshViews(),el&&this.uint8.set(el)}}_refreshViews(){throw Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...F){throw Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...F){throw Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}};function va(F,el=1){let eh=0,ec=0;return{members:F.map(F=>{let ep=rM[F.type].BYTES_PER_ELEMENT,e_=eh=ba(eh,Math.max(el,ep)),eg=F.components||1;return ec=Math.max(ec,ep),eh+=ep*eg,{name:F.name,type:F.type,components:eg,offset:e_}}),size:ba(eh,Math.max(ec,el)),alignment:el}}function ba(F,el){return Math.ceil(F/el)*el}let _a=class _a extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el){let eh=this.length;return this.resize(eh+1),this.emplace(eh,F,el)}emplace(F,el,eh){let ec=2*F;return this.int16[ec+0]=el,this.int16[ec+1]=eh,F}};_a.prototype.bytesPerElement=4,us(_a,"StructArrayLayout2i4");let wa=class wa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh){let ec=this.length;return this.resize(ec+1),this.emplace(ec,F,el,eh)}emplace(F,el,eh,ec){let ep=3*F;return this.int16[ep+0]=el,this.int16[ep+1]=eh,this.int16[ep+2]=ec,F}};wa.prototype.bytesPerElement=6,us(wa,"StructArrayLayout3i6");let Ma=class Ma extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec){let ep=this.length;return this.resize(ep+1),this.emplace(ep,F,el,eh,ec)}emplace(F,el,eh,ec,ep){let e_=4*F;return this.int16[e_+0]=el,this.int16[e_+1]=eh,this.int16[e_+2]=ec,this.int16[e_+3]=ep,F}};Ma.prototype.bytesPerElement=8,us(Ma,"StructArrayLayout4i8");let Aa=class Aa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F){let el=this.length;return this.resize(el+1),this.emplace(el,F)}emplace(F,el){return this.float32[1*F+0]=el,F}};Aa.prototype.bytesPerElement=4,us(Aa,"StructArrayLayout1f4");let Ia=class Ia extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh){let ec=this.length;return this.resize(ec+1),this.emplace(ec,F,el,eh)}emplace(F,el,eh,ec){let ep=4*F;return this.int16[ep+0]=el,this.int16[ep+1]=eh,this.float32[2*F+1]=ec,F}};Ia.prototype.bytesPerElement=8,us(Ia,"StructArrayLayout2i1f8");let Sa=class Sa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh){let ec=this.length;return this.resize(ec+1),this.emplace(ec,F,el,eh)}emplace(F,el,eh,ec){let ep=4*F;return this.int16[ep+0]=el,this.int16[ep+1]=eh,this.int16[ep+2]=ec,F}};Sa.prototype.bytesPerElement=8,us(Sa,"StructArrayLayout3i8");let Pa=class Pa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep){let e_=this.length;return this.resize(e_+1),this.emplace(e_,F,el,eh,ec,ep)}emplace(F,el,eh,ec,ep,e_){let eg=5*F;return this.int16[eg+0]=el,this.int16[eg+1]=eh,this.int16[eg+2]=ec,this.int16[eg+3]=ep,this.int16[eg+4]=e_,F}};Pa.prototype.bytesPerElement=10,us(Pa,"StructArrayLayout5i10");let Ea=class Ea extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg){let ey=this.length;return this.resize(ey+1),this.emplace(ey,F,el,eh,ec,ep,e_,eg)}emplace(F,el,eh,ec,ep,e_,eg,ey){let eb=6*F,ew=12*F;return this.int16[eb+0]=el,this.int16[eb+1]=eh,this.uint8[ew+4]=ec,this.uint8[ew+5]=ep,this.uint8[ew+6]=e_,this.uint8[ew+7]=eg,this.float32[3*F+2]=ey,F}};Ea.prototype.bytesPerElement=12,us(Ea,"StructArrayLayout2i4ub1f12");let za=class za extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh){let ec=this.length;return this.resize(ec+1),this.emplace(ec,F,el,eh)}emplace(F,el,eh,ec){let ep=3*F;return this.float32[ep+0]=el,this.float32[ep+1]=eh,this.float32[ep+2]=ec,F}};za.prototype.bytesPerElement=12,us(za,"StructArrayLayout3f12");let ka=class ka extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep){let e_=this.length;return this.resize(e_+1),this.emplace(e_,F,el,eh,ec,ep)}emplace(F,el,eh,ec,ep,e_){let eg=6*F;return this.uint16[eg+0]=el,this.uint16[eg+1]=eh,this.uint16[eg+2]=ec,this.uint16[eg+3]=ep,this.float32[3*F+2]=e_,F}};ka.prototype.bytesPerElement=12,us(ka,"StructArrayLayout4ui1f12");let Ta=class Ta extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec){let ep=this.length;return this.resize(ep+1),this.emplace(ep,F,el,eh,ec)}emplace(F,el,eh,ec,ep){let e_=4*F;return this.uint16[e_+0]=el,this.uint16[e_+1]=eh,this.uint16[e_+2]=ec,this.uint16[e_+3]=ep,F}};Ta.prototype.bytesPerElement=8,us(Ta,"StructArrayLayout4ui8");let Ba=class Ba extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_){let eg=this.length;return this.resize(eg+1),this.emplace(eg,F,el,eh,ec,ep,e_)}emplace(F,el,eh,ec,ep,e_,eg){let ey=6*F;return this.int16[ey+0]=el,this.int16[ey+1]=eh,this.int16[ey+2]=ec,this.int16[ey+3]=ep,this.int16[ey+4]=e_,this.int16[ey+5]=eg,F}};Ba.prototype.bytesPerElement=12,us(Ba,"StructArrayLayout6i12");let Va=class Va extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS){let eE=this.length;return this.resize(eE+1),this.emplace(eE,F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE){let eM=12*F;return this.int16[eM+0]=el,this.int16[eM+1]=eh,this.int16[eM+2]=ec,this.int16[eM+3]=ep,this.uint16[eM+4]=e_,this.uint16[eM+5]=eg,this.uint16[eM+6]=ey,this.uint16[eM+7]=eb,this.int16[eM+8]=ew,this.int16[eM+9]=eT,this.int16[eM+10]=eS,this.int16[eM+11]=eE,F}};Va.prototype.bytesPerElement=24,us(Va,"StructArrayLayout4i4ui4i24");let Ca=class Ca extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_){let eg=this.length;return this.resize(eg+1),this.emplace(eg,F,el,eh,ec,ep,e_)}emplace(F,el,eh,ec,ep,e_,eg){let ey=10*F,eb=5*F;return this.int16[ey+0]=el,this.int16[ey+1]=eh,this.int16[ey+2]=ec,this.float32[eb+2]=ep,this.float32[eb+3]=e_,this.float32[eb+4]=eg,F}};Ca.prototype.bytesPerElement=20,us(Ca,"StructArrayLayout3i3f20");let Da=class Da extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec){let ep=this.length;return this.resize(ep+1),this.emplace(ep,F,el,eh,ec)}emplace(F,el,eh,ec,ep){let e_=4*F;return this.float32[e_+0]=el,this.float32[e_+1]=eh,this.float32[e_+2]=ec,this.float32[e_+3]=ep,F}};Da.prototype.bytesPerElement=16,us(Da,"StructArrayLayout4f16");let Ra=class Ra extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F){let el=this.length;return this.resize(el+1),this.emplace(el,F)}emplace(F,el){return this.uint32[1*F+0]=el,F}};Ra.prototype.bytesPerElement=4,us(Ra,"StructArrayLayout1ul4");let La=class La extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,el){let eh=this.length;return this.resize(eh+1),this.emplace(eh,F,el)}emplace(F,el,eh){let ec=2*F;return this.uint16[ec+0]=el,this.uint16[ec+1]=eh,F}};La.prototype.bytesPerElement=4,us(La,"StructArrayLayout2ui4");let Fa=class Fa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE){let eM=this.length;return this.resize(eM+1),this.emplace(eM,F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM){let eI=20*F,eA=10*F;return this.int16[eI+0]=el,this.int16[eI+1]=eh,this.int16[eI+2]=ec,this.int16[eI+3]=ep,this.int16[eI+4]=e_,this.float32[eA+3]=eg,this.float32[eA+4]=ey,this.float32[eA+5]=eb,this.float32[eA+6]=ew,this.int16[eI+14]=eT,this.uint32[eA+8]=eS,this.uint16[eI+18]=eE,this.uint16[eI+19]=eM,F}};Fa.prototype.bytesPerElement=40,us(Fa,"StructArrayLayout5i4f1i1ul2ui40");let Oa=class Oa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg){let ey=this.length;return this.resize(ey+1),this.emplace(ey,F,el,eh,ec,ep,e_,eg)}emplace(F,el,eh,ec,ep,e_,eg,ey){let eb=8*F;return this.int16[eb+0]=el,this.int16[eb+1]=eh,this.int16[eb+2]=ec,this.int16[eb+4]=ep,this.int16[eb+5]=e_,this.int16[eb+6]=eg,this.int16[eb+7]=ey,F}};Oa.prototype.bytesPerElement=16,us(Oa,"StructArrayLayout3i2i2i16");let Na=class Na extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep){let e_=this.length;return this.resize(e_+1),this.emplace(e_,F,el,eh,ec,ep)}emplace(F,el,eh,ec,ep,e_){let eg=4*F,ey=8*F;return this.float32[eg+0]=el,this.float32[eg+1]=eh,this.float32[eg+2]=ec,this.int16[ey+6]=ep,this.int16[ey+7]=e_,F}};Na.prototype.bytesPerElement=16,us(Na,"StructArrayLayout2f1f2i16");let Ua=class Ua extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_){let eg=this.length;return this.resize(eg+1),this.emplace(eg,F,el,eh,ec,ep,e_)}emplace(F,el,eh,ec,ep,e_,eg){let ey=20*F,eb=5*F;return this.uint8[ey+0]=el,this.uint8[ey+1]=eh,this.float32[eb+1]=ec,this.float32[eb+2]=ep,this.float32[eb+3]=e_,this.float32[eb+4]=eg,F}};Ua.prototype.bytesPerElement=20,us(Ua,"StructArrayLayout2ub4f20");let ja=class ja extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,el,eh){let ec=this.length;return this.resize(ec+1),this.emplace(ec,F,el,eh)}emplace(F,el,eh,ec){let ep=3*F;return this.uint16[ep+0]=el,this.uint16[ep+1]=eh,this.uint16[ep+2]=ec,F}};ja.prototype.bytesPerElement=6,us(ja,"StructArrayLayout3ui6");let qa=class qa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR){let eL=this.length;return this.resize(eL+1),this.emplace(eL,F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL){let eO=30*F,ek=15*F,eF=60*F;return this.int16[eO+0]=el,this.int16[eO+1]=eh,this.int16[eO+2]=ec,this.float32[ek+2]=ep,this.float32[ek+3]=e_,this.uint16[eO+8]=eg,this.uint16[eO+9]=ey,this.uint32[ek+5]=eb,this.uint32[ek+6]=ew,this.uint32[ek+7]=eT,this.uint16[eO+16]=eS,this.uint16[eO+17]=eE,this.uint16[eO+18]=eM,this.float32[ek+10]=eI,this.float32[ek+11]=eA,this.uint8[eF+48]=eC,this.uint8[eF+49]=eP,this.uint8[eF+50]=ez,this.uint32[ek+13]=eD,this.int16[eO+28]=eR,this.uint8[eF+58]=eL,F}};qa.prototype.bytesPerElement=60,us(qa,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");let $a=class $a extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO,ek,eF,eB,eN,eV,eU,ej,eG,eq,e$){let eH=this.length;return this.resize(eH+1),this.emplace(eH,F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO,ek,eF,eB,eN,eV,eU,ej,eG,eq,e$)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO,ek,eF,eB,eN,eV,eU,ej,eG,eq,e$,eH){let eZ=20*F,eW=40*F;return this.float32[eZ+0]=el,this.float32[eZ+1]=eh,this.int16[eW+4]=ec,this.int16[eW+5]=ep,this.int16[eW+6]=e_,this.int16[eW+7]=eg,this.int16[eW+8]=ey,this.int16[eW+9]=eb,this.int16[eW+10]=ew,this.int16[eW+11]=eT,this.int16[eW+12]=eS,this.uint16[eW+13]=eE,this.uint16[eW+14]=eM,this.uint16[eW+15]=eI,this.uint16[eW+16]=eA,this.uint16[eW+17]=eC,this.uint16[eW+18]=eP,this.uint16[eW+19]=ez,this.uint16[eW+20]=eD,this.uint16[eW+21]=eR,this.uint16[eW+22]=eL,this.uint16[eW+23]=eO,this.uint16[eW+24]=ek,this.uint16[eW+25]=eF,this.uint16[eW+26]=eB,this.uint16[eW+27]=eN,this.uint32[eZ+14]=eV,this.float32[eZ+15]=eU,this.float32[eZ+16]=ej,this.float32[eZ+17]=eG,this.float32[eZ+18]=eq,this.uint8[80*F+76]=e$,this.uint16[eW+39]=eH,F}};$a.prototype.bytesPerElement=80,us($a,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");let Ga=class Ga extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep){let e_=this.length;return this.resize(e_+1),this.emplace(e_,F,el,eh,ec,ep)}emplace(F,el,eh,ec,ep,e_){let eg=5*F;return this.float32[eg+0]=el,this.float32[eg+1]=eh,this.float32[eg+2]=ec,this.float32[eg+3]=ep,this.float32[eg+4]=e_,F}};Ga.prototype.bytesPerElement=20,us(Ga,"StructArrayLayout5f20");let Ya=class Ya extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg){let ey=this.length;return this.resize(ey+1),this.emplace(ey,F,el,eh,ec,ep,e_,eg)}emplace(F,el,eh,ec,ep,e_,eg,ey){let eb=7*F;return this.float32[eb+0]=el,this.float32[eb+1]=eh,this.float32[eb+2]=ec,this.float32[eb+3]=ep,this.float32[eb+4]=e_,this.float32[eb+5]=eg,this.float32[eb+6]=ey,F}};Ya.prototype.bytesPerElement=28,us(Ya,"StructArrayLayout7f28");let Ha=class Ha extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT){let eS=this.length;return this.resize(eS+1),this.emplace(eS,F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS){let eE=11*F;return this.float32[eE+0]=el,this.float32[eE+1]=eh,this.float32[eE+2]=ec,this.float32[eE+3]=ep,this.float32[eE+4]=e_,this.float32[eE+5]=eg,this.float32[eE+6]=ey,this.float32[eE+7]=eb,this.float32[eE+8]=ew,this.float32[eE+9]=eT,this.float32[eE+10]=eS,F}};Ha.prototype.bytesPerElement=44,us(Ha,"StructArrayLayout11f44");let Xa=class Xa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=this.length;return this.resize(ew+1),this.emplace(ew,F,el,eh,ec,ep,e_,eg,ey,eb)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew){let eT=9*F;return this.float32[eT+0]=el,this.float32[eT+1]=eh,this.float32[eT+2]=ec,this.float32[eT+3]=ep,this.float32[eT+4]=e_,this.float32[eT+5]=eg,this.float32[eT+6]=ey,this.float32[eT+7]=eb,this.float32[eT+8]=ew,F}};Xa.prototype.bytesPerElement=36,us(Xa,"StructArrayLayout9f36");let Za=class Za extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el){let eh=this.length;return this.resize(eh+1),this.emplace(eh,F,el)}emplace(F,el,eh){let ec=2*F;return this.float32[ec+0]=el,this.float32[ec+1]=eh,F}};Za.prototype.bytesPerElement=8,us(Za,"StructArrayLayout2f8");let Wa=class Wa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec){let ep=this.length;return this.resize(ep+1),this.emplace(ep,F,el,eh,ec)}emplace(F,el,eh,ec,ep){let e_=6*F;return this.uint32[3*F+0]=el,this.uint16[e_+2]=eh,this.uint16[e_+3]=ec,this.uint16[e_+4]=ep,F}};Wa.prototype.bytesPerElement=12,us(Wa,"StructArrayLayout1ul3ui12");let Ka=class Ka extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(F){let el=this.length;return this.resize(el+1),this.emplace(el,F)}emplace(F,el){return this.uint16[1*F+0]=el,F}};Ka.prototype.bytesPerElement=2,us(Ka,"StructArrayLayout1ui2");let Ja=class Ja extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA){let eC=this.length;return this.resize(eC+1),this.emplace(eC,F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA)}emplace(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC){let eP=16*F;return this.float32[eP+0]=el,this.float32[eP+1]=eh,this.float32[eP+2]=ec,this.float32[eP+3]=ep,this.float32[eP+4]=e_,this.float32[eP+5]=eg,this.float32[eP+6]=ey,this.float32[eP+7]=eb,this.float32[eP+8]=ew,this.float32[eP+9]=eT,this.float32[eP+10]=eS,this.float32[eP+11]=eE,this.float32[eP+12]=eM,this.float32[eP+13]=eI,this.float32[eP+14]=eA,this.float32[eP+15]=eC,F}};Ja.prototype.bytesPerElement=64,us(Ja,"StructArrayLayout16f64");let Qa=class Qa extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(F,el,eh,ec,ep,e_,eg){let ey=this.length;return this.resize(ey+1),this.emplace(ey,F,el,eh,ec,ep,e_,eg)}emplace(F,el,eh,ec,ep,e_,eg,ey){let eb=10*F,ew=5*F;return this.uint16[eb+0]=el,this.uint16[eb+1]=eh,this.uint16[eb+2]=ec,this.uint16[eb+3]=ep,this.float32[ew+2]=e_,this.float32[ew+3]=eg,this.float32[ew+4]=ey,F}};Qa.prototype.bytesPerElement=20,us(Qa,"StructArrayLayout4ui3f20");let to=class to extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(F){let el=this.length;return this.resize(el+1),this.emplace(el,F)}emplace(F,el){return this.int16[1*F+0]=el,F}};to.prototype.bytesPerElement=2,us(to,"StructArrayLayout1i2");let eo=class eo extends xa{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(F){let el=this.length;return this.resize(el+1),this.emplace(el,F)}emplace(F,el){return this.uint8[1*F+0]=el,F}};eo.prototype.bytesPerElement=1,us(eo,"StructArrayLayout1ub1");let ro=class ro extends ga{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}};ro.prototype.size=40;let no=class no extends Fa{get(F){return new ro(this,F)}};us(no,"CollisionBoxArray");let io=class io extends ga{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(F){this._structArray.uint8[this._pos1+49]=F}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(F){this._structArray.uint8[this._pos1+50]=F}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(F){this._structArray.uint32[this._pos4+13]=F}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(F){this._structArray.uint8[this._pos1+58]=F}};io.prototype.size=60;let so=class so extends qa{get(F){return new io(this,F)}};us(so,"PlacedSymbolArray");let ao=class ao extends ga{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(F){this._structArray.uint32[this._pos4+14]=F}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(F){this._structArray.float32[this._pos4+18]=F}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}};ao.prototype.size=80;let oo=class oo extends $a{get(F){return new ao(this,F)}};us(oo,"SymbolInstanceArray");let lo=class lo extends Aa{getoffsetX(F){return this.float32[1*F+0]}};us(lo,"GlyphOffsetArray");let uo=class uo extends _a{getx(F){return this.int16[2*F+0]}gety(F){return this.int16[2*F+1]}};us(uo,"SymbolLineVertexArray");let co=class co extends ga{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}};co.prototype.size=12;let ho=class ho extends Wa{get(F){return new co(this,F)}};us(ho,"FeatureIndexArray");let po=class po extends La{geta_centroid_pos0(F){return this.uint16[2*F+0]}geta_centroid_pos1(F){return this.uint16[2*F+1]}};us(po,"FillExtrusionCentroidArray");let fo=class fo extends ga{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}};fo.prototype.size=6;let mo=class mo extends wa{get(F){return new fo(this,F)}};us(mo,"FillExtrusionWallArray");let rI=va([{name:"a_pos",components:2,type:"Int16"}],4),rA=va([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);let xo=class xo{constructor(F=[]){this.segments=F}_prepareSegment(F,el,eh,ec){let ep=this.segments[this.segments.length-1];return F>xo.MAX_VERTEX_ARRAY_LENGTH&&pt(`Max vertices per segment is ${xo.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${F}`),(!ep||ep.vertexLength+F>xo.MAX_VERTEX_ARRAY_LENGTH||ep.sortKey!==ec)&&(ep={vertexOffset:el,primitiveOffset:eh,vertexLength:0,primitiveLength:0},void 0!==ec&&(ep.sortKey=ec),this.segments.push(ep)),ep}prepareSegment(F,el,eh,ec){return this._prepareSegment(F,el.length,eh.length,ec)}get(){return this.segments}destroy(){for(let F of this.segments)for(let el in F.vaos)F.vaos[el].destroy()}static simpleSegment(F,el,eh,ec){return new xo([{vertexOffset:F,primitiveOffset:el,vertexLength:eh,primitiveLength:ec,vaos:{},sortKey:0}])}};function vo(F,el){return 256*(F=Q(Math.floor(F),0,255))+Q(Math.floor(el),0,255)}xo.MAX_VERTEX_ARRAY_LENGTH=65535,us(xo,"SegmentVector");let rC=va([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),rP=va([{name:"a_dash",components:4,type:"Uint16"}]);let wo=class wo{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(F,el,eh,ec){this.ids.push(Mo(F)),this.positions.push(el,eh,ec)}eachPosition(F,el){let eh=Mo(F),ec=0,ep=this.ids.length-1;for(;ec<ep;){let F=ec+ep>>1;this.ids[F]>=eh?ep=F:ec=F+1}for(;this.ids[ec]===eh;)el(this.positions[3*ec],this.positions[3*ec+1],this.positions[3*ec+2]),ec++}static serialize(F,el){let eh=new Float64Array(F.ids),ec=new Uint32Array(F.positions);return function Ao(F,el,eh,ec){for(;eh<ec;){let ep=F[eh+ec>>1],e_=eh-1,eg=ec+1;for(;;){do e_++;while(F[e_]<ep);do eg--;while(F[eg]>ep);if(e_>=eg)break;Io(F,e_,eg),Io(el,3*e_,3*eg),Io(el,3*e_+1,3*eg+1),Io(el,3*e_+2,3*eg+2)}eg-eh<ec-eg?(Ao(F,el,eh,eg),eh=eg+1):(Ao(F,el,eg+1,ec),ec=eg)}}(eh,ec,0,eh.length-1),el&&(el.add(eh.buffer),el.add(ec.buffer)),{ids:eh,positions:ec}}static deserialize(F){let el;let eh=new wo;for(let ec of(eh.ids=F.ids,eh.positions=F.positions,eh.ids))ec!==el&&eh.uniqueIds.push(ec),el=ec;return eh.indexed=!0,eh}};function Mo(F){let el=+F;return!isNaN(el)&&Number.MIN_SAFE_INTEGER<=el&&el<=Number.MAX_SAFE_INTEGER?el:iv(String(F))}function Io(F,el,eh){let ec=F[el];F[el]=F[eh],F[eh]=ec}us(wo,"FeaturePositionMap");let So=class So{constructor(F){this.gl=F.gl,this.initialized=!1}fetchUniformLocation(F,el){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(F,el),this.initialized=!0),!!this.location}set(F,el,eh){throw Error("Uniform#set() must be implemented by each concrete Uniform")}};let Po=class Po extends So{constructor(F){super(F),this.current=0}set(F,el,eh){this.fetchUniformLocation(F,el)&&this.current!==eh&&(this.current=eh,this.gl.uniform1i(this.location,eh))}};let Eo=class Eo extends So{constructor(F){super(F),this.current=0}set(F,el,eh){this.fetchUniformLocation(F,el)&&this.current!==eh&&(this.current=eh,this.gl.uniform1f(this.location,eh))}};let zo=class zo extends So{constructor(F){super(F),this.current=[0,0]}set(F,el,eh){this.fetchUniformLocation(F,el)&&(eh[0]===this.current[0]&&eh[1]===this.current[1]||(this.current=eh,this.gl.uniform2f(this.location,eh[0],eh[1])))}};let ko=class ko extends So{constructor(F){super(F),this.current=[0,0,0]}set(F,el,eh){this.fetchUniformLocation(F,el)&&(eh[0]===this.current[0]&&eh[1]===this.current[1]&&eh[2]===this.current[2]||(this.current=eh,this.gl.uniform3f(this.location,eh[0],eh[1],eh[2])))}};let To=class To extends So{constructor(F){super(F),this.current=[0,0,0,0]}set(F,el,eh){this.fetchUniformLocation(F,el)&&(eh[0]===this.current[0]&&eh[1]===this.current[1]&&eh[2]===this.current[2]&&eh[3]===this.current[3]||(this.current=eh,this.gl.uniform4f(this.location,eh[0],eh[1],eh[2],eh[3])))}};let Bo=class Bo extends So{constructor(F){super(F),this.current=Se.transparent.toRenderColor(null)}set(F,el,eh){this.fetchUniformLocation(F,el)&&(eh.r===this.current.r&&eh.g===this.current.g&&eh.b===this.current.b&&eh.a===this.current.a||(this.current=eh,this.gl.uniform4f(this.location,eh.r,eh.g,eh.b,eh.a)))}};let rz=new Float32Array(16);let Co=class Co extends So{constructor(F){super(F),this.current=rz}set(F,el,eh){if(this.fetchUniformLocation(F,el)){if(eh[12]!==this.current[12]||eh[0]!==this.current[0])return this.current=eh,void this.gl.uniformMatrix4fv(this.location,!1,eh);for(let F=1;F<16;F++)if(eh[F]!==this.current[F]){this.current=eh,this.gl.uniformMatrix4fv(this.location,!1,eh);break}}}};let rD=new Float32Array(9),rR=new Float32Array(4);let Lo=class Lo extends So{constructor(F){super(F),this.current=rR}set(F,el,eh){if(this.fetchUniformLocation(F,el)){for(let F=0;F<4;F++)if(eh[F]!==this.current[F]){this.current=eh,this.gl.uniformMatrix2fv(this.location,!1,eh);break}}}};function Fo(F){return[vo(255*F.r,255*F.g),vo(255*F.b,255*F.a)]}let Oo=class Oo{constructor(F,el,eh,ec){this.value=F,this.uniformNames=el.map(F=>`u_${F}`),this.type=eh,this.context=ec}setUniform(F,el,eh,ec,ep){let e_=ec.constantOr(this.value);el.set(F,ep,e_ instanceof Se?e_.toRenderColor(this.lutExpression&&"none"===this.lutExpression.value?null:this.context.lut):e_)}getBinding(F,el){return"color"===this.type?new Bo(F):new Eo(F)}};let No=class No{constructor(F,el){this.uniformNames=el.map(F=>`u_${F}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(F){this.pixelRatio=F.pixelRatio||1,this.pattern=F.tl.concat(F.br)}setUniform(F,el,eh,ec,ep){let e_="u_pattern"===ep||"u_dash"===ep?this.pattern:"u_pixel_ratio"===ep?this.pixelRatio:null;e_&&el.set(F,ep,e_)}getBinding(F,el){return"u_pattern"===el||"u_dash"===el?new To(F):new Eo(F)}};let Uo=class Uo{constructor(F,el,eh,ec){this.expression=F,this.type=eh,this.maxValue=0,this.paintVertexAttributes=el.map(F=>({name:`a_${F}`,type:"Float32",components:"color"===eh?2:1,offset:0})),this.paintVertexArray=new ec}populatePaintArray(F,el,eh,ec,ep,e_,eg){let ey=this.paintVertexArray.length,eb="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Rs(0,{brightness:e_}),el,{},ep,ec,eg):"constant"===this.expression.kind&&this.expression.value,ew=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:e_}),el,{},ep,ec,eg):this.lutExpression.value);this.paintVertexArray.resize(F),this._setPaintValue(ey,F,eb,ew?null:this.context.lut)}updatePaintArray(F,el,eh,ec,ep,e_,eg){let ey="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:eg},eh,ec,void 0,ep):"constant"===this.expression.kind&&this.expression.value,eb=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:eg}),eh,ec,void 0,ep):this.lutExpression.value);this._setPaintValue(F,el,ey,eb?null:this.context.lut)}_setPaintValue(F,el,eh,ec){if("color"===this.type){let ep=Fo(eh.toRenderColor(ec));for(let eh=F;eh<el;eh++)this.paintVertexArray.emplace(eh,ep[0],ep[1])}else{for(let ec=F;ec<el;ec++)this.paintVertexArray.emplace(ec,eh);this.maxValue=Math.max(this.maxValue,Math.abs(eh))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}};let jo=class jo{constructor(F,el,eh,ec,ep,e_){this.expression=F,this.uniformNames=el.map(F=>`u_${F}_t`),this.type=eh,this.useIntegerZoom=ec,this.context=ep,this.maxValue=0,this.paintVertexAttributes=el.map(F=>({name:`a_${F}`,type:"Float32",components:"color"===eh?4:2,offset:0})),this.paintVertexArray=new e_}populatePaintArray(F,el,eh,ec,ep,e_,eg){let ey=this.expression.evaluate(new Rs(this.context.zoom,{brightness:e_}),el,{},ep,ec,eg),eb=this.expression.evaluate(new Rs(this.context.zoom+1,{brightness:e_}),el,{},ep,ec,eg),ew=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:e_}),el,{},ep,ec,eg):this.lutExpression.value),eT=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValue(eT,F,ey,eb,ew?null:this.context.lut)}updatePaintArray(F,el,eh,ec,ep,e_,eg){let ey=this.expression.evaluate({zoom:this.context.zoom,brightness:eg},eh,ec,void 0,ep),eb=this.expression.evaluate({zoom:this.context.zoom+1,brightness:eg},eh,ec,void 0,ep),ew=!!this.lutExpression&&"none"===("composite"===this.lutExpression.kind||"source"===this.lutExpression.kind?this.lutExpression.evaluate(new Rs(0,{brightness:eg}),eh,ec,void 0,ep):this.lutExpression.value);this._setPaintValue(F,el,ey,eb,ew?null:this.context.lut)}_setPaintValue(F,el,eh,ec,ep){if("color"===this.type){let ec=Fo(eh.toRenderColor(ep)),e_=Fo(eh.toRenderColor(ep));for(let eh=F;eh<el;eh++)this.paintVertexArray.emplace(eh,ec[0],ec[1],e_[0],e_[1])}else{for(let ep=F;ep<el;ep++)this.paintVertexArray.emplace(ep,eh,ec);this.maxValue=Math.max(this.maxValue,Math.abs(eh),Math.abs(ec))}}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(F,el,eh,ec,ep){let e_=this.useIntegerZoom?Math.floor(eh.zoom):eh.zoom,eg=Q(this.expression.interpolationFactor(e_,this.context.zoom,this.context.zoom+1),0,1);el.set(F,ep,eg)}getBinding(F,el){return new Eo(F)}};let qo=class qo{constructor(F,el,eh,ec,ep){this.expression=F,this.layerId=ep,this.paintVertexAttributes=("array"===eh?rP:rC).members;for(let F=0;F<el.length;++F);this.paintVertexArray=new ec}populatePaintArray(F,el,eh,ec){let ep=this.paintVertexArray.length;this.paintVertexArray.resize(F),this._setPaintValues(ep,F,el.patterns&&el.patterns[this.layerId],eh)}updatePaintArray(F,el,eh,ec,ep,e_,eg){this._setPaintValues(F,el,eh.patterns&&eh.patterns[this.layerId],e_)}_setPaintValues(F,el,eh,ec){if(!ec||!eh)return;let ep=ec[eh];if(!ep)return;let{tl:e_,br:eg,pixelRatio:ey}=ep;for(let eh=F;eh<el;eh++)this.paintVertexArray.emplace(eh,e_[0],e_[1],eg[0],eg[1],ey)}upload(F){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=F.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}};let $o=class $o{constructor(F,el,eh=()=>!0){this.binders={},this._buffers=[],this.context=el;let ec=[];for(let e_ in F.paint._values){var ep;let eg=F.paint.get(e_);if(e_.endsWith("-use-theme")||!eh(e_)||!(eg instanceof qs&&Fi(eg.property.specification)))continue;let ey=(ep=F.type,rL[e_]||[e_.replace(`${ep}-`,"").replace(/-/g,"_")]),eb=eg.value,ew=eg.property.specification.type,eT=!!eg.property.useIntegerZoom,eS="line-dasharray"===e_||e_.endsWith("pattern"),eE=F.paint.get(`${e_}-use-theme`),eM="line-dasharray"===e_&&"constant"!==F.layout.get("line-cap").value.kind||eE&&"constant"!==eE.value.kind;if("constant"!==eb.kind||eM){if("source"===eb.kind||eM||eS){let el=Wo(e_,ew,"source");this.binders[e_]=eS?new qo(eb,ey,ew,el,F.id):new Uo(eb,ey,ew,el),ec.push(`/a_${e_}`)}else{let F=Wo(e_,ew,"composite");this.binders[e_]=new jo(eb,ey,ew,eT,el,F),ec.push(`/z_${e_}`)}}else this.binders[e_]=eS?new No(eb.value,ey):new Oo(eb.value,ey,ew,el),ec.push(`/u_${e_}`);eE&&(this.binders[e_].lutExpression=eE.value)}this.cacheKey=ec.sort().join("")}getMaxValue(F){let el=this.binders[F];return el instanceof Uo||el instanceof jo?el.maxValue:0}populatePaintArrays(F,el,eh,ec,ep,e_,eg){for(let ey in this.binders){let eb=this.binders[ey];eb.context=this.context,(eb instanceof Uo||eb instanceof jo||eb instanceof qo)&&eb.populatePaintArray(F,el,eh,ec,ep,e_,eg)}}setConstantPatternPositions(F){for(let el in this.binders){let eh=this.binders[el];eh instanceof No&&eh.setConstantPatternPositions(F)}}updatePaintArrays(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=!1,eT=Object.keys(F),eS=0!==eT.length&&!ey,eE=eS?eT:el.uniqueIds;for(let ey in this.context.lut=ep.lut,this.binders){let eT=this.binders[ey];if(eT.context=this.context,(eT instanceof Uo||eT instanceof jo||eT instanceof qo)&&eT.expression&&eT.expression.kind&&"constant"!==eT.expression.kind&&(!0===eT.expression.isStateDependent||!1===eT.expression.isLightConstant)){let eM=ep.paint.get(ey);for(let eh of(eT.expression=eM.value,eE)){let ep=F[eh.toString()];el.eachPosition(eh,(F,el,eh)=>{let ey=ec.feature(F);eT.updatePaintArray(el,eh,ey,ep,e_,eg,eb)})}if(!eS)for(let el of eh.uniqueIds){let ep=F[el.toString()];eh.eachPosition(el,(F,el,eh)=>{let ey=ec.feature(F);eT.updatePaintArray(el,eh,ey,ep,e_,eg,eb)})}ew=!0}}return ew}defines(){let F=[];for(let el in this.binders){let eh=this.binders[el];(eh instanceof Oo||eh instanceof No)&&F.push(...eh.uniformNames.map(F=>`#define HAS_UNIFORM_${F}`))}return F}getBinderAttributes(){let F=[];for(let el in this.binders){let eh=this.binders[el];if(eh instanceof Uo||eh instanceof jo||eh instanceof qo)for(let el=0;el<eh.paintVertexAttributes.length;el++)F.push(eh.paintVertexAttributes[el].name)}return F}getBinderUniforms(){let F=[];for(let el in this.binders){let eh=this.binders[el];if(eh instanceof Oo||eh instanceof No||eh instanceof jo)for(let el of eh.uniformNames)F.push(el)}return F}getPaintVertexBuffers(){return this._buffers}getUniforms(F){let el=[];for(let eh in this.binders){let ec=this.binders[eh];if(ec instanceof Oo||ec instanceof No||ec instanceof jo)for(let ep of ec.uniformNames)el.push({name:ep,property:eh,binding:ec.getBinding(F,ep)})}return el}setUniforms(F,el,eh,ec,ep){for(let{name:el,property:e_,binding:eg}of eh)this.binders[e_].setUniform(F,eg,ep,ec.get(e_),el)}updatePaintBuffers(){for(let F in this._buffers=[],this.binders){let el=this.binders[F];(el instanceof Uo||el instanceof jo||el instanceof qo)&&el.paintVertexBuffer&&this._buffers.push(el.paintVertexBuffer)}}upload(F){for(let el in this.binders){let eh=this.binders[el];(eh instanceof Uo||eh instanceof jo||eh instanceof qo)&&eh.upload(F)}this.updatePaintBuffers()}destroy(){for(let F in this.binders){let el=this.binders[F];(el instanceof Uo||el instanceof jo||el instanceof qo)&&el.destroy()}}};let Go=class Go{constructor(F,el,eh=()=>!0){for(let ec of(this.programConfigurations={},F))this.programConfigurations[ec.id]=new $o(ec,el,eh);this.needsUpload=!1,this._featureMap=new wo,this._featureMapWithoutIds=new wo,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(F,el,eh,ec,ep,e_,eg,ey){for(let eh in this.programConfigurations)this.programConfigurations[eh].populatePaintArrays(F,el,ec,ep,e_,eg,ey);void 0!==el.id?this._featureMap.add(el.id,eh,this._bufferOffset,F):(this._featureMapWithoutIds.add(this._idlessCounter,eh,this._bufferOffset,F),this._idlessCounter+=1),this._bufferOffset=F,this.needsUpload=!0}updatePaintArrays(F,el,eh,ec,ep,e_,eg){for(let ey of eh)this.needsUpload=this.programConfigurations[ey.id].updatePaintArrays(F,this._featureMap,this._featureMapWithoutIds,el,ey,ec,ep,e_,eg||0)||this.needsUpload}get(F){return this.programConfigurations[F]}upload(F){if(this.needsUpload){for(let el in this.programConfigurations)this.programConfigurations[el].upload(F);this.needsUpload=!1}}destroy(){for(let F in this.programConfigurations)this.programConfigurations[F].destroy()}};let rL={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]},rO={"line-pattern":{source:ka,composite:ka},"fill-pattern":{source:ka,composite:ka},"fill-extrusion-pattern":{source:ka,composite:ka},"line-dasharray":{source:Ta,composite:Ta}},rk={color:{source:Za,composite:Da},number:{source:Aa,composite:Za}};function Wo(F,el,eh){let ec=rO[F];return ec&&ec[eh]||rk[el][eh]}us(Oo,"ConstantBinder"),us(No,"PatternConstantBinder"),us(Uo,"SourceExpressionBinder"),us(qo,"PatternCompositeBinder"),us(jo,"CompositeExpressionBinder"),us($o,"ProgramConfiguration",{omit:["_buffers"]}),us(Go,"ProgramConfigurationSet");let rF=8192/Math.PI/2,rB=[64,32,16],rN=-rF;function sl(F,el,eh,ec=rF){return[F*Math.sin(eh*=tj)*ec,-el*ec,F*Math.cos(eh)*ec]}function al(F,el,eh){return sl(Math.cos(F*tj),Math.sin(F*tj),el,eh)}let rV=2*Math.PI*6371008.8;let ul=class ul{constructor(F,el){if(isNaN(F)||isNaN(el))throw Error(`Invalid LngLat object: (${F}, ${el})`);if(this.lng=+F,this.lat=+el,this.lat>90||this.lat<-90)throw Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new ul(et(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(F){let el=Math.PI/180,eh=this.lat*el,ec=F.lat*el,ep=Math.sin(eh)*Math.sin(ec)+Math.cos(eh)*Math.cos(ec)*Math.cos((F.lng-this.lng)*el);return 6371008.8*Math.acos(Math.min(ep,1))}toBounds(F=0){let el=360*F/40075017,eh=el/Math.cos(Math.PI/180*this.lat);return new cl({lng:this.lng-eh,lat:this.lat-el},{lng:this.lng+eh,lat:this.lat+el})}toEcef(F){return al(this.lat,this.lng,rF+F*rF/6371008.8)}static convert(F){if(F instanceof ul)return F;if(Array.isArray(F)&&(2===F.length||3===F.length))return new ul(Number(F[0]),Number(F[1]));if(!Array.isArray(F)&&"object"==typeof F&&null!==F)return new ul(Number("lng"in F?F.lng:F.lon),Number(F.lat));throw Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}};let cl=class cl{constructor(F,el){F&&(el?this.setSouthWest(F).setNorthEast(el):4===F.length?this.setSouthWest([F[0],F[1]]).setNorthEast([F[2],F[3]]):this.setSouthWest(F[0]).setNorthEast(F[1]))}setNorthEast(F){return this._ne=F instanceof ul?new ul(F.lng,F.lat):ul.convert(F),this}setSouthWest(F){return this._sw=F instanceof ul?new ul(F.lng,F.lat):ul.convert(F),this}extend(F){let el,eh;let ec=this._sw,ep=this._ne;if(F instanceof ul)el=F,eh=F;else{if(!(F instanceof cl))return Array.isArray(F)?4===F.length||F.every(Array.isArray)?this.extend(cl.convert(F)):this.extend(ul.convert(F)):"object"==typeof F&&null!==F&&F.hasOwnProperty("lat")&&(F.hasOwnProperty("lon")||F.hasOwnProperty("lng"))?this.extend(ul.convert(F)):this;if(el=F._sw,eh=F._ne,!el||!eh)return this}return ec||ep?(ec.lng=Math.min(el.lng,ec.lng),ec.lat=Math.min(el.lat,ec.lat),ep.lng=Math.max(eh.lng,ep.lng),ep.lat=Math.max(eh.lat,ep.lat)):(this._sw=new ul(el.lng,el.lat),this._ne=new ul(eh.lng,eh.lat)),this}getCenter(){return new ul((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new ul(this.getWest(),this.getNorth())}getSouthEast(){return new ul(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(F){let{lng:el,lat:eh}=ul.convert(F),ec=this._sw.lng<=el&&el<=this._ne.lng;return this._sw.lng>this._ne.lng&&(ec=this._sw.lng>=el&&el>=this._ne.lng),this._sw.lat<=eh&&eh<=this._ne.lat&&ec}static convert(F){if(F)return F instanceof cl?F:new cl(F)}};function fl(F){return rV*Math.cos(F*Math.PI/180)}function dl(F){return(180+F)/360}function ml(F){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+F*Math.PI/360)))/360}function gl(F){return 360*F-180}function xl(F){return 360/Math.PI*Math.atan(Math.exp((180-360*F)*Math.PI/180))-90}function vl(F,el){return F*fl(xl(el))}function _l(F){return Math.cos(Q(F,-85.051129,85.051129)*tj)}function wl(F,el){let eh=Q(el,0,25.5),ec=Math.pow(2,eh);return _l(F)*rV/(512*ec)}function Ml(F){return 1/Math.cos(F*Math.PI/180)}function Al(F,el=0){let eh=Math.exp(Math.PI*(1-(F.y+el/8192)/(1<<F.z)*2));return 80150034*eh/(eh*eh+1)/8192/(1<<F.z)}let Il=class Il{constructor(F,el,eh=0){this.x=+F,this.y=+el,this.z=+eh}static fromLngLat(F,el=0){let eh=ul.convert(F);return new Il(dl(eh.lng),ml(eh.lat),el/fl(eh.lat))}toLngLat(){return new ul(gl(this.x),xl(this.y))}toAltitude(){return vl(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/rV*Ml(xl(this.y))}};function Pl(F,el,eh){let ec=F[0],ep=ec.x,e_=ec.y;el(ec);let eg=[ec];for(let ey=1;ey<F.length;ey++){let eb=F[ey],{x:ew,y:eT}=eb;el(eb),function Sl(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=(el+ec)/2,eT=(eh+ep)/2,eS=new tU(ew,eT);ey(eS),function(F,el,eh,ec,ep,e_){let eg=eh-ep,ey=ec-e_;return Math.abs((ec-el)*eg-(eh-F)*ey)/Math.hypot(eg,ey)}(eS.x,eS.y,e_.x,e_.y,eg.x,eg.y)>=eb?(Sl(F,el,eh,ew,eT,e_,eS,ey,eb),Sl(F,ew,eT,ec,ep,eS,eg,ey,eb)):F.push(eg)}(eg,ep,e_,ew,eT,ec,eb,el,eh),ep=ew,e_=eT,ec=eb}return eg}let rU=-16383-1;function Vl(F,el,eh){let ec=F.loadGeometry(),ep=F.extent,e_=8192/ep;if(el&&eh&&eh.projection.isReprojectedInTileSpace){let e_=1<<el.z,{scale:eg,x:ey,y:eb,projection:ew}=eh,c=F=>{let eh=gl((el.x+F.x/ep)/e_),ec=xl((el.y+F.y/ep)/e_),eT=ew.project(eh,ec);F.x=(eT.x*eg-ey)*ep,F.y=(eT.y*eg-eb)*ep};for(let el=0;el<ec.length;el++)if(1!==F.type)ec[el]=Pl(ec[el],c,1);else{let F=[];for(let eh of ec[el])eh.x<0||eh.x>=ep||eh.y<0||eh.y>=ep||(c(eh),F.push(eh));ec[el]=F}}for(let F of ec)for(let el of F)!function(F,el){let eh=Math.round(F.x*el),ec=Math.round(F.y*el);F.x=Q(eh,rU,16383),F.y=Q(ec,rU,16383),(eh<F.x||eh>F.x+1||ec<F.y||ec>F.y+1)&&pt("Geometry exceeds allowed extent, reduce your vector tile buffer size")}(el,e_);return ec}function Cl(F,el){return{type:F.type,id:F.id,properties:F.properties,geometry:el?Vl(F):[]}}function Dl(F,el,eh,ec,ep){F.emplaceBack(2*el+(ec+1)/2,2*eh+(ep+1)/2)}function Rl(F,el,eh){F.emplaceBack(el.x,el.y,el.z,16384*eh[0],16384*eh[1],16384*eh[2])}let Ll=class Ll{constructor(F){this.zoom=F.zoom,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map(F=>F.fqid),this.index=F.index,this.hasPattern=!1,this.projection=F.projection,this.layoutVertexArray=new _a,this.indexArray=new ja,this.segments=new xo,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id)}updateFootprints(F,el){}populate(F,el,eh,ec){let ep=this.layers[0],e_=[],eg=null;for(let{feature:el,id:ey,index:eb,sourceLayerIndex:ew}of("circle"===ep.type&&(eg=ep.layout.get("circle-sort-key")),F)){let F=this.layers[0]._featureFilter.needGeometry,ep=Cl(el,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),ep,eh))continue;let eT=eg?eg.evaluate(ep,{},eh):void 0,eS={id:ey,properties:el.properties,type:el.type,sourceLayerIndex:ew,index:eb,geometry:F?ep.geometry:Vl(el,eh,ec),patterns:{},sortKey:eT};e_.push(eS)}eg&&e_.sort((F,el)=>F.sortKey-el.sortKey);let ey=null;for(let ep of("globe"===ec.projection.name&&(this.globeExtVertexArray=new Ba,ey=ec.projection),e_)){let{geometry:ec,index:e_,sourceLayerIndex:eg}=ep,eb=F[e_].feature;this.addFeature(ep,ec,e_,el.availableImages,eh,ey,el.brightness),el.featureIndex.insert(eb,ec,e_,eg,this.index)}}update(F,el,eh,ec,ep,e_,eg){this.programConfigurations.updatePaintArrays(F,el,ep,eh,ec,e_,eg)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,rI.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,rA.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(F,el,eh,ec,ep,e_,eg){for(let eh of el)for(let el of eh){let eh=el.x,ec=el.y;if(eh<0||eh>=8192||ec<0||ec>=8192)continue;if(e_){let F=e_.projectTilePoint(eh,ec,ep),el=e_.upVector(ep,eh,ec),eg=this.globeExtVertexArray;Rl(eg,F,el),Rl(eg,F,el),Rl(eg,F,el),Rl(eg,F,el)}let eg=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,F.sortKey),ey=eg.vertexLength;Dl(this.layoutVertexArray,eh,ec,-1,-1),Dl(this.layoutVertexArray,eh,ec,1,-1),Dl(this.layoutVertexArray,eh,ec,1,1),Dl(this.layoutVertexArray,eh,ec,-1,1),this.indexArray.emplaceBack(ey,ey+1,ey+2),this.indexArray.emplaceBack(ey,ey+2,ey+3),eg.vertexLength+=4,eg.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,eh,{},ec,ep,eg)}};function Fl(F,el){for(let eh=0;eh<F.length;eh++)if(Hl(el,F[eh]))return!0;for(let eh=0;eh<el.length;eh++)if(Hl(F,el[eh]))return!0;return!!jl(F,el)}function Nl(F,el){if(1===F.length)return Yl(el,F[0]);for(let eh=0;eh<el.length;eh++){let ec=el[eh];for(let el=0;el<ec.length;el++)if(Hl(F,ec[el]))return!0}for(let eh=0;eh<F.length;eh++)if(Yl(el,F[eh]))return!0;for(let eh=0;eh<el.length;eh++)if(jl(F,el[eh]))return!0;return!1}function jl(F,el){if(0===F.length||0===el.length)return!1;for(let ep=0;ep<F.length-1;ep++){let e_=F[ep],eg=F[ep+1];for(let F=0;F<el.length-1;F++){var eh,ec;if(ft(e_,eh=el[F],ec=el[F+1])!==ft(eg,eh,ec)&&ft(e_,eg,eh)!==ft(e_,eg,ec))return!0}}return!1}function $l(F,el,eh){let ec=eh*eh;if(1===el.length)return F.distSqr(el[0])<ec;for(let eh=1;eh<el.length;eh++)if(Gl(F,el[eh-1],el[eh])<ec)return!0;return!1}function Gl(F,el,eh){let ec=el.distSqr(eh);if(0===ec)return F.distSqr(el);let ep=((F.x-el.x)*(eh.x-el.x)+(F.y-el.y)*(eh.y-el.y))/ec;return F.distSqr(ep<0?el:ep>1?eh:eh.sub(el)._mult(ep)._add(el))}function Yl(F,el){let eh,ec,ep,e_=!1;for(let eg=0;eg<F.length;eg++){eh=F[eg];for(let F=0,eg=eh.length-1;F<eh.length;eg=F++)ec=eh[F],ep=eh[eg],ec.y>el.y!=ep.y>el.y&&el.x<(ep.x-ec.x)*(el.y-ec.y)/(ep.y-ec.y)+ec.x&&(e_=!e_)}return e_}function Hl(F,el){let eh=!1;for(let ec=0,ep=F.length-1;ec<F.length;ep=ec++){let e_=F[ec],eg=F[ep];e_.y>el.y!=eg.y>el.y&&el.x<(eg.x-e_.x)*(el.y-e_.y)/(eg.y-e_.y)+e_.x&&(eh=!eh)}return eh}function Xl(F,el,eh,ec,ep){for(let e_ of F)if(el<=e_.x&&eh<=e_.y&&ec>=e_.x&&ep>=e_.y)return!0;let e_=[new tU(el,eh),new tU(el,ep),new tU(ec,ep),new tU(ec,eh)];if(F.length>2){for(let el of e_)if(Hl(F,el))return!0}for(let el=0;el<F.length-1;el++)if(Zl(F[el],F[el+1],e_))return!0;return!1}function Zl(F,el,eh){let ec=eh[0],ep=eh[2];if(F.x<ec.x&&el.x<ec.x||F.x>ep.x&&el.x>ep.x||F.y<ec.y&&el.y<ec.y||F.y>ep.y&&el.y>ep.y)return!1;let e_=ft(F,el,eh[0]);return e_!==ft(F,el,eh[1])||e_!==ft(F,el,eh[2])||e_!==ft(F,el,eh[3])}function Wl(F,el,eh,ec,ep,e_){let eg=el.y-F.y,ey=F.x-el.x;if(e_=e_||0){let F=eg*eg+ey*ey;if(0===F)return!0;let el=Math.sqrt(F);eg/=el,ey/=el}return!((eh.x-F.x)*eg+(eh.y-F.y)*ey-e_<0||(ec.x-F.x)*eg+(ec.y-F.y)*ey-e_<0||(ep.x-F.x)*eg+(ep.y-F.y)*ey-e_<0)}function Kl(F,el,eh,ec,ep,e_,eg){return!(Wl(F,el,ec,ep,e_,eg)||Wl(el,eh,ec,ep,e_,eg)||Wl(eh,F,ec,ep,e_,eg)||Wl(ec,ep,F,el,eh,eg)||Wl(ep,e_,F,el,eh,eg)||Wl(e_,ec,F,el,eh,eg))}function Jl(F,el,eh){let ec=el.paint.get(F).value;return"constant"===ec.kind?ec.value:eh.programConfigurations.get(el.id).getMaxValue(F)}function Ql(F){return Math.sqrt(F[0]*F[0]+F[1]*F[1])}function tu(F,el,eh,ec,ep){if(!el[0]&&!el[1])return F;let e_=tU.convert(el)._mult(ep);"viewport"===eh&&e_._rotate(-ec);let eg=[];for(let el=0;el<F.length;el++)eg.push(F[el].sub(e_));return eg}function eu(F,el,eh,ec){let ep=tU.convert(F)._mult(ec);return"viewport"===el&&ep._rotate(-eh),ep}us(Ll,"CircleBucket",{omit:["layers"]});var rj,rG={exports:{}},rq=(rj||(rj=1,function(F){function e(F,el,eh){var ec=r(256*F,256*(el=Math.pow(2,eh)-el-1),eh),ep=r(256*(F+1),256*(el+1),eh);return ec[0]+","+ec[1]+","+ep[0]+","+ep[1]}function r(F,el,eh){var ec=2*Math.PI*6378137/256/Math.pow(2,eh);return[F*ec-2*Math.PI*6378137/2,el*ec-2*Math.PI*6378137/2]}F.getURL=function(F,el,eh,ec,ep,e_){return e_=e_||{},F+"?"+["bbox="+e(eh,ec,ep),"format="+(e_.format||"image/png"),"service="+(e_.service||"WMS"),"version="+(e_.version||"1.1.1"),"request="+(e_.request||"GetMap"),"srs="+(e_.srs||"EPSG:3857"),"width="+(e_.width||256),"height="+(e_.height||256),"layers="+el].join("&")},F.getTileBBox=e,F.getMercCoords=r,Object.defineProperty(F,"__esModule",{value:!0})}(rG.exports)),rG.exports);let ou=class ou{constructor(F,el,eh){this.z=F,this.x=el,this.y=eh,this.key=cu(0,F,F,el,eh)}equals(F){return this.z===F.z&&this.x===F.x&&this.y===F.y}url(F,el){let eh=rq.getTileBBox(this.x,this.y,this.z),ec=function(F,el,eh){let ec,ep="";for(let e_=F;e_>0;e_--)ep+=(el&(ec=1<<e_-1)?1:0)+(eh&ec?2:0);return ep}(this.z,this.x,this.y);return F[(this.x+this.y)%F.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===el?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",ec).replace("{bbox-epsg-3857}",eh)}toString(){return`${this.z}/${this.x}/${this.y}`}};let lu=class lu{constructor(F,el){this.wrap=F,this.canonical=el,this.key=cu(F,el.z,el.z,el.x,el.y)}};let uu=class uu{constructor(F,el,eh,ec,ep){this.overscaledZ=F,this.wrap=el,this.canonical=new ou(eh,+ec,+ep),this.key=0===el&&F===eh?this.canonical.key:cu(el,F,eh,ec,ep)}equals(F){return this.overscaledZ===F.overscaledZ&&this.wrap===F.wrap&&this.canonical.equals(F.canonical)}scaledTo(F){let el=this.canonical.z-F;return F>this.canonical.z?new uu(F,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new uu(F,this.wrap,F,this.canonical.x>>el,this.canonical.y>>el)}calculateScaledKey(F,el=!0){if(this.overscaledZ===F&&el)return this.key;if(F>this.canonical.z)return cu(this.wrap*+el,F,this.canonical.z,this.canonical.x,this.canonical.y);{let eh=this.canonical.z-F;return cu(this.wrap*+el,F,F,this.canonical.x>>eh,this.canonical.y>>eh)}}isChildOf(F){if(F.wrap!==this.wrap)return!1;let el=this.canonical.z-F.canonical.z;return 0===F.overscaledZ||F.overscaledZ<this.overscaledZ&&F.canonical.z<this.canonical.z&&F.canonical.x===this.canonical.x>>el&&F.canonical.y===this.canonical.y>>el}children(F){if(this.overscaledZ>=F)return[new uu(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];let el=this.canonical.z+1,eh=2*this.canonical.x,ec=2*this.canonical.y;return[new uu(el,this.wrap,el,eh,ec),new uu(el,this.wrap,el,eh+1,ec),new uu(el,this.wrap,el,eh,ec+1),new uu(el,this.wrap,el,eh+1,ec+1)]}isLessThan(F){return this.wrap<F.wrap||!(this.wrap>F.wrap)&&(this.overscaledZ<F.overscaledZ||!(this.overscaledZ>F.overscaledZ)&&(this.canonical.x<F.canonical.x||!(this.canonical.x>F.canonical.x)&&this.canonical.y<F.canonical.y))}wrapped(){return new uu(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(F){return new uu(this.overscaledZ,F,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new lu(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}};function cu(F,el,eh,ec,ep){let e_=1<<Math.min(eh,22),eg=e_*(ep%e_)+ec%e_;return F&&eh<22&&(eg+=e_*e_*((F<0?-2*F-1:2*F)%(1<<2*(22-eh)))),16*(32*eg+eh)+(el-eh)}let r$=[F=>{let el=F.canonical.x-1,eh=F.wrap;return el<0&&(el=(1<<F.canonical.z)-1,eh--),new uu(F.overscaledZ,eh,F.canonical.z,el,F.canonical.y)},F=>{let el=F.canonical.x+1,eh=F.wrap;return el===1<<F.canonical.z&&(el=0,eh++),new uu(F.overscaledZ,eh,F.canonical.z,el,F.canonical.y)},F=>new uu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,(0===F.canonical.y?1<<F.canonical.z:F.canonical.y)-1),F=>new uu(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y===(1<<F.canonical.z)-1?0:F.canonical.y+1)];us(ou,"CanonicalTileID"),us(uu,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});let rH=va([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:rZ}=rH,rW=va([{name:"a_pos_3",components:3,type:"Int16"}]);var rY=va([{name:"a_pos",type:"Int16",components:2}]);let yu=class yu{constructor(F,el){this.pos=F,this.dir=el}intersectsPlane(F,el,eh){let ec=tN.vec2.dot(el,this.dir);if(1e-6>Math.abs(ec))return!1;let ep=((F[0]-this.pos[0])*el[0]+(F[1]-this.pos[1])*el[1])/ec;return eh[0]=this.pos[0]+this.dir[0]*ep,eh[1]=this.pos[1]+this.dir[1]*ep,!0}};let gu=class gu{constructor(F,el){this.pos=F,this.dir=el}intersectsPlane(F,el,eh){let ec=tN.vec3.dot(el,this.dir);if(1e-6>Math.abs(ec))return!1;let ep=((F[0]-this.pos[0])*el[0]+(F[1]-this.pos[1])*el[1]+(F[2]-this.pos[2])*el[2])/ec;return eh[0]=this.pos[0]+this.dir[0]*ep,eh[1]=this.pos[1]+this.dir[1]*ep,eh[2]=this.pos[2]+this.dir[2]*ep,!0}closestPointOnSphere(F,el,eh){if(tN.vec3.equals(this.pos,F)||0===el)return eh[0]=eh[1]=eh[2]=0,!1;let[ec,ep,e_]=this.dir,eg=this.pos[0]-F[0],ey=this.pos[1]-F[1],eb=this.pos[2]-F[2],ew=ec*ec+ep*ep+e_*e_,eT=2*(eg*ec+ey*ep+eb*e_),eS=eT*eT-4*ew*(eg*eg+ey*ey+eb*eb-el*el);if(eS<0){let F=Math.max(-eT/2,0),ew=eg+ec*F,eS=ey+ep*F,eE=eb+e_*F,eM=Math.hypot(ew,eS,eE);return eh[0]=ew*el/eM,eh[1]=eS*el/eM,eh[2]=eE*el/eM,!1}{let F=(-eT-Math.sqrt(eS))/(2*ew);if(F<0){let F=Math.hypot(eg,ey,eb);return eh[0]=eg*el/F,eh[1]=ey*el/F,eh[2]=eb*el/F,!1}return eh[0]=eg+ec*F,eh[1]=ey+ep*F,eh[2]=eb+e_*F,!0}}};let xu=class xu{constructor(F,el,eh,ec,ep){this.TL=F,this.TR=el,this.BR=eh,this.BL=ec,this.horizon=ep}static fromInvProjectionMatrix(F,el,eh){let ec=[-1,1,1],ep=[1,1,1],e_=[1,-1,1],eg=[-1,-1,1],ey=tN.vec3.transformMat4(ec,ec,F),eb=tN.vec3.transformMat4(ep,ep,F),ew=tN.vec3.transformMat4(e_,e_,F),eT=tN.vec3.transformMat4(eg,eg,F);return new xu(ey,eb,ew,eT,el/eh)}};function vu(F,el,eh){let ec=1/0,ep=-1/0,e_=[];for(let eg of F){tN.vec3.sub(e_,eg,el);let F=tN.vec3.dot(e_,eh);ec=Math.min(ec,F),ep=Math.max(ep,F)}return[ec,ep]}function bu(F,el){let eh=!0;for(let ec=0;ec<F.planes.length;ec++){let ep=F.planes[ec],e_=0;for(let F=0;F<el.length;F++)e_+=tN.vec3.dot(ep,el[F])+ep[3]>=0;if(0===e_)return 0;e_!==el.length&&(eh=!1)}return eh?2:1}function _u(F,el){for(let eh of F.projections){let ec=vu(el,F.points[0],eh.axis);if(eh.projection[1]<ec[0]||eh.projection[0]>ec[1])return 0}return 1}function wu(F,el){let eh=0,ec=[0,0,0,0];for(let ep=0;ep<F.length;ep++)ec[0]=F[ep][0],ec[1]=F[ep][1],ec[2]=F[ep][2],ec[3]=1,tN.vec4.dot(ec,el)>=0&&eh++;return eh}let Mu=class Mu{constructor(F,el){for(let eh of(this.points=F||Array(8).fill([0,0,0]),this.planes=el||Array(6).fill([0,0,0,0]),this.bounds=Au.fromPoints(this.points),this.projections=[],this.frustumEdges=[tN.vec3.sub([],this.points[2],this.points[3]),tN.vec3.sub([],this.points[0],this.points[3]),tN.vec3.sub([],this.points[4],this.points[0]),tN.vec3.sub([],this.points[5],this.points[1]),tN.vec3.sub([],this.points[6],this.points[2]),tN.vec3.sub([],this.points[7],this.points[3])],this.frustumEdges)){let F=[0,-eh[2],eh[1]],el=[eh[2],0,-eh[0]];this.projections.push({axis:F,projection:vu(this.points,this.points[0],F)}),this.projections.push({axis:el,projection:vu(this.points,this.points[0],el)})}}static fromInvProjectionMatrix(F,el,eh,ec){let ep=Math.pow(2,eh),e_=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(eh=>{let e_=tN.vec4.transformMat4([],eh,F),eg=1/e_[3]/el*ep;return tN.vec4.mul(e_,e_,[eg,eg,ec?1/e_[3]:eg,eg])}),eg=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(F=>{let el=tN.vec3.sub([],e_[F[0]],e_[F[1]]),eh=tN.vec3.sub([],e_[F[2]],e_[F[1]]),ec=tN.vec3.normalize([],tN.vec3.cross([],el,eh)),ep=-tN.vec3.dot(ec,e_[F[1]]);return ec.concat(ep)}),ey=[];for(let F=0;F<e_.length;F++)ey.push([e_[F][0],e_[F][1],e_[F][2]]);return new Mu(ey,eg)}intersectsPrecise(F,el,eh){for(let eh=0;eh<el.length;eh++)if(!wu(F,el[eh]))return 0;for(let el=0;el<this.planes.length;el++)if(!wu(F,this.planes[el]))return 0;for(let el of eh)for(let eh of this.frustumEdges){let ec=tN.vec3.cross([],el,eh),ep=tN.vec3.length(ec);if(0===ep)continue;tN.vec3.scale(ec,ec,1/ep);let e_=vu(this.points,this.points[0],ec),eg=vu(F,this.points[0],ec);if(e_[0]>eg[1]||eg[0]>e_[1])return 0}return 1}containsPoint(F){for(let el of this.planes){let eh=el[3];if(tN.vec3.dot([el[0],el[1],el[2]],F)+eh<0)return!1}return!0}};let Au=class Au{static fromPoints(F){let el=[1/0,1/0,1/0],eh=[-1/0,-1/0,-1/0];for(let ec of F)tN.vec3.min(el,el,ec),tN.vec3.max(eh,eh,ec);return new Au(el,eh)}static fromTileIdAndHeight(F,el,eh){let ec=1<<F.canonical.z,ep=F.canonical.x,e_=F.canonical.y;return new Au([ep/ec,e_/ec,el],[(ep+1)/ec,(e_+1)/ec,eh])}static applyTransform(F,el){let eh=F.getCorners();for(let F=0;F<eh.length;++F)tN.vec3.transformMat4(eh[F],eh[F],el);return Au.fromPoints(eh)}static applyTransformFast(F,el){let eh=[el[12],el[13],el[14]],ec=[...eh];for(let ep=0;ep<3;ep++)for(let e_=0;e_<3;e_++){let eg=el[4*e_+ep],ey=eg*F.min[e_],eb=eg*F.max[e_];eh[ep]+=Math.min(ey,eb),ec[ep]+=Math.max(ey,eb)}return new Au(eh,ec)}static projectAabbCorners(F,el){let eh=F.getCorners();for(let F=0;F<eh.length;++F)tN.vec3.transformMat4(eh[F],eh[F],el);return eh}constructor(F,el){this.min=F,this.max=el,this.center=tN.vec3.scale([],tN.vec3.add([],this.min,this.max),.5)}quadrant(F){let el=[F%2==0,F<2],eh=tN.vec3.clone(this.min),ec=tN.vec3.clone(this.max);for(let F=0;F<el.length;F++)eh[F]=el[F]?this.min[F]:this.center[F],ec[F]=el[F]?this.center[F]:this.max[F];return ec[2]=this.max[2],new Au(eh,ec)}distanceX(F){return Math.max(Math.min(this.max[0],F[0]),this.min[0])-F[0]}distanceY(F){return Math.max(Math.min(this.max[1],F[1]),this.min[1])-F[1]}distanceZ(F){return Math.max(Math.min(this.max[2],F[2]),this.min[2])-F[2]}getCorners(){let F=this.min,el=this.max;return[[F[0],F[1],F[2]],[el[0],F[1],F[2]],[el[0],el[1],F[2]],[F[0],el[1],F[2]],[F[0],F[1],el[2]],[el[0],F[1],el[2]],[el[0],el[1],el[2]],[F[0],el[1],el[2]]]}intersects(F){return this.intersectsAabb(F.bounds)?bu(F,this.getCorners()):0}intersectsFlat(F){return this.intersectsAabb(F.bounds)?bu(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(F,el){return el||this.intersects(F)?_u(F,this.getCorners()):0}intersectsPreciseFlat(F,el){return el||this.intersectsFlat(F)?_u(F,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(F){for(let el=0;el<3;++el)if(this.min[el]>F.max[el]||F.min[el]>this.max[el])return!1;return!0}intersectsAabbXY(F){return!(this.min[0]>F.max[0]||F.min[0]>this.max[0]||this.min[1]>F.max[1]||F.min[1]>this.max[1])}encapsulate(F){for(let el=0;el<3;el++)this.min[el]=Math.min(this.min[el],F.min[el]),this.max[el]=Math.max(this.max[el],F.max[el])}encapsulatePoint(F){for(let el=0;el<3;el++)this.min[el]=Math.min(this.min[el],F[el]),this.max[el]=Math.max(this.max[el],F[el])}closestPoint(F){return[Math.max(Math.min(this.max[0],F[0]),this.min[0]),Math.max(Math.min(this.max[1],F[1]),this.min[1]),Math.max(Math.min(this.max[2],F[2]),this.min[2])]}};function Iu(F){return F*rF/6371008.8}us(Au,"Aabb");let rX=[new Au([rN,rN,rN],[rF,rF,rF]),new Au([rN,rN,rN],[0,0,rF]),new Au([0,rN,rN],[rF,0,rF]),new Au([rN,0,rN],[0,rF,rF]),new Au([0,0,rN],[rF,rF,rF])];function Pu(F,el,eh,ec=!0){let ep=tN.vec3.scale([],F._camera.position,F.worldSize),e_=[el,eh,1,1];tN.vec4.transformMat4(e_,e_,F.pixelMatrixInverse),tN.vec4.scale(e_,e_,1/e_[3]);let eg=tN.vec3.sub([],e_,ep),ey=tN.vec3.normalize([],eg),eb=F.globeMatrix,ew=[eb[12],eb[13],eb[14]],eT=tN.vec3.sub([],ew,ep),eS=tN.vec3.length(eT),eE=tN.vec3.normalize([],eT),eM=F.worldSize/(2*Math.PI),eI=tN.vec3.dot(eE,ey),eA=Math.asin(eM/eS);if(eA<Math.acos(eI)){if(!ec)return null;let F=[],el=[];tN.vec3.scale(F,ey,eS/eI),tN.vec3.normalize(el,tN.vec3.sub(el,F,eT)),tN.vec3.normalize(ey,tN.vec3.add(ey,eT,tN.vec3.scale(ey,el,Math.tan(eA)*eS)))}let eC=[];new gu(ep,ey).closestPointOnSphere(ew,eM,eC);let eP=tN.vec3.normalize([],vt(eb,0)),ez=tN.vec3.normalize([],vt(eb,1)),eD=tN.vec3.normalize([],vt(eb,2)),eR=tN.vec3.dot(eP,eC),eL=tN.vec3.dot(ez,eC),eO=tN.vec3.dot(eD,eC),ek=Math.asin(-eL/eM)*tG,eF=Math.atan2(eR,eO)*tG;eF=F.center.lng+function(F,el){let eh=(el-F+180)%360-180;return eh<-180?eh+360:eh}(F.center.lng,eF);let eB=dl(eF),eN=Q(ml(ek),0,1);return new Il(eB,eN)}let Eu=class Eu{constructor(F,el,eh){this.a=tN.vec3.sub([],F,eh),this.b=tN.vec3.sub([],el,eh),this.center=eh;let ec=tN.vec3.normalize([],this.a),ep=tN.vec3.normalize([],this.b);this.angle=Math.acos(tN.vec3.dot(ec,ep))}};function zu(F,el){let eh;return 0===F.angle?null:(eh=0===F.a[el]?1/F.angle*.5*Math.PI:1/F.angle*Math.atan(F.b[el]/F.a[el]/Math.sin(F.angle)-1/Math.tan(F.angle)))<0||eh>1?null:function(F,el,eh,ec){let ep=Math.sin(eh);return F*(Math.sin((1-ec)*eh)/ep)+el*(Math.sin(ec*eh)/ep)}(F.a[el],F.b[el],F.angle,Q(eh,0,1))+F.center[el]}function ku(F){if(F.z<=1)return rX[F.z+2*F.y+F.x];let el=Du(Cu(F));return Au.fromPoints(el)}function Tu(F,el,eh){return tN.vec3.scale(F,F,1-eh),tN.vec3.scaleAndAdd(F,F,el,eh)}function Bu(F,el,eh){for(let ec of F)tN.vec3.transformMat4(ec,ec,el),tN.vec3.scale(ec,ec,eh)}function Vu(F,el,eh,ec){let ep=el/F.worldSize,e_=F.globeMatrix;if(eh.z<=1){let F=ku(eh).getCorners();return Bu(F,e_,ep),Au.fromPoints(F)}let eg=Cu(eh,ec),ey=Du(eg,rF+Iu(F._tileCoverLift));Bu(ey,e_,ep);let eb=Number.MAX_VALUE,ew=[-eb,-eb,-eb],eT=[eb,eb,eb];if(eg.contains(F.center)){for(let F of ey)tN.vec3.min(eT,eT,F),tN.vec3.max(ew,ew,F);ew[2]=0;let el=F.point,eh=[el.x*ep,el.y*ep,0];return tN.vec3.min(eT,eT,eh),tN.vec3.max(ew,ew,eh),new Au(eT,ew)}if(F._tileCoverLift>0){for(let F of ey)tN.vec3.min(eT,eT,F),tN.vec3.max(ew,ew,F);return new Au(eT,ew)}let eS=[e_[12]*ep,e_[13]*ep,e_[14]*ep],eE=eg.getCenter(),eM=Q(F.center.lat,-85.051129,85.051129),eI=Q(eE.lat,-85.051129,85.051129),eA=dl(F.center.lng),eC=ml(eM),eP=eA-dl(eE.lng),ez=eC-ml(eI);eP>.5?eP-=1:eP<-.5&&(eP+=1);let eD=0;if(Math.abs(eP)>Math.abs(ez))eD=eP>=0?1:3;else{eD=ez>=0?0:2;let F=[e_[4]*ep,e_[5]*ep,e_[6]*ep],el=-Math.sin((ez>=0?eg.getSouth():eg.getNorth())*tj)*rF;tN.vec3.scaleAndAdd(eS,eS,F,el)}let eR=ey[eD],eL=ey[(eD+1)%4],eO=new Eu(eR,eL,eS),ek=[zu(eO,0)||eR[0],zu(eO,1)||eR[1],zu(eO,2)||eR[2]],eF=$u(F.zoom);if(eF>0){let ec=function({x:F,y:el,z:eh},ec,ep,e_,eg){let ey=1/(1<<eh),eb=F*ey,ew=eb+ey,eT=el*ey,eS=eT+ey,eE=0,eM=(eb+ew)/2-e_;return eM>.5?eE=-1:eM<-.5&&(eE=1),eb=((eb+eE)*ec-(e_*=ec))*ep+e_,ew=((ew+eE)*ec-e_)*ep+e_,eT=(eT*ec-(eg*=ec))*ep+eg,[[eb,eS=(eS*ec-eg)*ep+eg,0],[ew,eS,0],[ew,eT,0],[eb,eT,0]]}(eh,el,F._pixelsPerMercatorPixel,eA,eC);for(let F=0;F<ey.length;F++)Tu(ey[F],ec[F],eF);let ep=tN.vec3.add([],ec[eD],ec[(eD+1)%4]);tN.vec3.scale(ep,ep,.5),Tu(ek,ep,eF)}for(let F of ey)tN.vec3.min(eT,eT,F),tN.vec3.max(ew,ew,F);return eT[2]=Math.min(eR[2],eL[2]),tN.vec3.min(eT,eT,ek),tN.vec3.max(ew,ew,ek),new Au(eT,ew)}function Cu({x:F,y:el,z:eh},ec=!1){let ep=1/(1<<eh),e_=new ul(gl(F*ep),el===(1<<eh)-1&&ec?-90:xl((el+1)*ep)),eg=new ul(gl((F+1)*ep),0===el&&ec?90:xl(el*ep));return new cl(e_,eg)}function Du(F,el=rF){let eh=F.getNorth()*tj,ec=F.getSouth()*tj,ep=Math.cos(eh),e_=Math.cos(ec),eg=Math.sin(eh),ey=Math.sin(ec),eb=F.getWest(),ew=F.getEast();return[sl(e_,ey,eb,el),sl(e_,ey,ew,el),sl(ep,eg,ew,el),sl(ep,eg,eb,el)]}function Ru(F,el,eh,ec){let ep=1<<eh.z,e_=(F/8192+eh.x)/ep;return al(xl((el/8192+eh.y)/ep),gl(e_),ec)}function Lu({min:F,max:el}){return 16383/Math.max(el[0]-F[0],el[1]-F[1],el[2]-F[2])}let rK=new Float64Array(16);function Ou(F){let el=Lu(F),eh=tN.mat4.fromScaling(rK,[el,el,el]);return tN.mat4.translate(eh,eh,tN.vec3.negate([],F.min))}function Nu(F){let el=tN.mat4.fromTranslation(rK,F.min),eh=1/Lu(F);return tN.mat4.scale(el,el,[eh,eh,eh])}function Uu(F){let el=8192/(2*Math.PI);return F/(2*Math.PI)/el}function ju(F,el){return 8192/(512*Math.pow(2,F))*Lu(ku(el))}function qu(F,el,eh,ec,ep){let e_=Uu(eh),eg=[F,el,-eh/(2*Math.PI)],ey=tN.mat4.identity(new Float64Array(16));return tN.mat4.translate(ey,ey,eg),tN.mat4.scale(ey,ey,[e_,e_,e_]),tN.mat4.rotateX(ey,ey,-ep*tj),tN.mat4.rotateY(ey,ey,-ec*tj),ey}function $u(F){return tt(5,6,F)}function Gu(F,el){let eh=al(el.lat,el.lng),ec=function(F){let el=al(F._center.lat,F._center.lng),eh=tN.vec3.fromValues(0,1,0),ec=tN.vec3.cross([],eh,el),ep=tN.mat4.fromRotation([],-F.angle,el);ec=tN.vec3.transformMat4(ec,ec,ep),tN.mat4.fromRotation(ep,-F._pitch,ec);let e_=tN.vec3.normalize([],el);return tN.vec3.scale(e_,e_,Iu(F.cameraToCenterDistance/F.pixelsPerMeter)),tN.vec3.transformMat4(e_,e_,ep),tN.vec3.add([],el,e_)}(F),ep=tN.vec3.subtract([],ec,eh);return tN.vec3.angle(ep,eh)}function Yu(F,el){return Gu(F,el)>Math.PI/2*1.01}let rJ=85*tj,rQ=Math.cos(rJ),r0=Math.sin(rJ),r1=tN.mat4.create(),Ku=F=>{let el=[];return"map"===F.paint.get("circle-pitch-alignment")&&el.push("PITCH_WITH_MAP"),"map"===F.paint.get("circle-pitch-scale")&&el.push("SCALE_WITH_MAP"),el};function Ju(F,el,eh,ec,ep,e_,eg,ey,eb){if(e_&&F.queryGeometry.isAboveHorizon)return!1;e_&&(eb*=F.pixelToTileUnitsFactor);let ew=F.tileID.canonical,eT=eh.projection.upVectorScale(ew,eh.center.lat,eh.worldSize).metersToTile;for(let eE of el)for(let el of eE){var eS;let eE=el.add(ey),eM=ep&&eh.elevation?eh.elevation.exaggeration()*ep.getElevationAt(eE.x,eE.y,!0):0,eI=eh.projection.projectTilePoint(eE.x,eE.y,ew);if(eM>0){let F=eh.projection.upVector(ew,eE.x,eE.y);eI.x+=F[0]*eT*eM,eI.y+=F[1]*eT*eM,eI.z+=F[2]*eT*eM}let eA=e_?eE:function(F,el,eh,ec){let ep=tN.vec4.transformMat4([],[F,el,eh,1],ec);return new tU(ep[0]/ep[3],ep[1]/ep[3])}(eI.x,eI.y,eI.z,ec),eC=e_?F.tilespaceRays.map(F=>(function(F,el){let eh=tN.vec3.create();return r2[2]=el,F.intersectsPlane(r2,r3,eh),new tU(eh[0],eh[1])})(F,eM)):F.queryGeometry.screenGeometry,eP=tN.vec4.transformMat4([],[eI.x,eI.y,eI.z,1],ec);if(!eg&&e_?eb*=eP[3]/eh.cameraToCenterDistance:eg&&!e_&&(eb*=eh.cameraToCenterDistance/eP[3]),e_){let F=xl((el.y/8192+ew.y)/(1<<ew.z));eb/=eh.projection.pixelsPerMeter(F,1)/(1/fl(F))}if(eS=eb,Hl(eC,eA)||$l(eA,eC,eS))return!0}return!1}let r2=tN.vec3.fromValues(0,0,0),r3=tN.vec3.fromValues(0,0,1);let nc=class nc extends Ll{};function lc(F,{width:el,height:eh},ec,ep){if(ep){if(ep instanceof Uint8ClampedArray)ep=new Uint8Array(ep.buffer);else if(ep.length!==el*eh*ec)throw RangeError("mismatched image size")}else ep=new Uint8Array(el*eh*ec);return F.width=el,F.height=eh,F.data=ep,F}function uc(F,el,eh){let{width:ec,height:ep}=el;ec===F.width&&ep===F.height||(cc(F,el,{x:0,y:0},{x:0,y:0},{width:Math.min(F.width,ec),height:Math.min(F.height,ep)},eh,null),F.width=ec,F.height=ep,F.data=el.data)}function cc(F,el,eh,ec,ep,e_,eg,ey){if(0===ep.width||0===ep.height)return el;if(ep.width>F.width||ep.height>F.height||eh.x>F.width-ep.width||eh.y>F.height-ep.height)throw RangeError("out of range source coordinates for image copy");if(ep.width>el.width||ep.height>el.height||ec.x>el.width-ep.width||ec.y>el.height-ep.height)throw RangeError("out of range destination coordinates for image copy");let eb=F.data,ew=el.data,eT=4===e_&&ey;for(let ey=0;ey<ep.height;ey++){let eS=((eh.y+ey)*F.width+eh.x)*e_,eE=((ec.y+ey)*el.width+ec.x)*e_;if(eT)for(let F=0;F<ep.width;F++){let el=eS+F*e_+3,eh=eE+F*e_;ew[eh+0]=255,ew[eh+1]=255,ew[eh+2]=255,ew[eh+3]=eb[el]}else if(eg)for(let F=0;F<ep.width;F++){let el=eS+F*e_,eh=eE+F*e_,ec=eb[el+3],ep=new Se(eb[el+0]/255*ec,eb[el+1]/255*ec,eb[el+2]/255*ec,ec).toRenderColor(eg).toArray();ew[eh+0]=ep[0],ew[eh+1]=ep[1],ew[eh+2]=ep[2],ew[eh+3]=ep[3]}else for(let F=0;F<ep.width*e_;F++)ew[eE+F]=eb[eS+F]}return el}us(nc,"HeatmapBucket",{omit:["layers"]});let hc=class hc{constructor(F,el){lc(this,F,1,el)}resize(F){uc(this,new hc(F),1)}clone(){return new hc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,el,eh,ec,ep){cc(F,el,eh,ec,ep,1,null)}};let pc=class pc{constructor(F,el){lc(this,F,4,el)}resize(F){uc(this,new pc(F),4)}replace(F,el){el?this.data.set(F):this.data=F instanceof Uint8ClampedArray?new Uint8Array(F.buffer):F}clone(){return new pc({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(F,el,eh,ec,ep,e_,eg){cc(F,el,eh,ec,ep,4,e_,eg)}};let fc=class fc{constructor(F,el){this.width=F.width,this.height=F.height,this.data=el instanceof Uint8Array?new Float32Array(el.buffer):el}};function dc(F){let el={},eh=F.resolution||256,ec=F.clips?F.clips.length:1,ep=F.image||new pc({width:eh,height:ec}),s=(eh,ec,e_)=>{el[F.evaluationKey]=e_;let eg=F.expression.evaluate(el);eg&&(ep.data[eh+ec+0]=Math.floor(255*eg.r/eg.a),ep.data[eh+ec+1]=Math.floor(255*eg.g/eg.a),ep.data[eh+ec+2]=Math.floor(255*eg.b/eg.a),ep.data[eh+ec+3]=Math.floor(255*eg.a))};if(F.clips)for(let el=0,ep=0;el<ec;++el,ep+=4*eh)for(let ec=0,e_=0;ec<eh;ec++,e_+=4){let eg=ec/(eh-1),{start:ey,end:eb}=F.clips[el];s(ep,e_,ey*(1-eg)+eb*eg)}else for(let F=0,el=0;F<eh;F++,el+=4)s(0,el,F/(eh-1));return ep}us(hc,"AlphaImage"),us(pc,"RGBAImage");let r4=va([{name:"a_pos",components:2,type:"Int16"}],4),r5=va([{name:"a_road_z_offset",components:1,type:"Float32"}],4),r6=va([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),r8=va([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function vc(F,el,eh=2){let ec,ep,e_;let eg=el&&el.length,ey=eg?el[0]*eh:F.length,eb=bc(F,0,ey,eh,!0),ew=[];if(!eb||eb.next===eb.prev)return ew;if(eg&&(eb=function(F,el,eh,ec){let ep=[];for(let eh=0,e_=el.length;eh<e_;eh++){let eg=bc(F,el[eh]*ec,eh<e_-1?el[eh+1]*ec:F.length,ec,!1);eg===eg.next&&(eg.steiner=!0),ep.push(function(F){let el=F,eh=F;do(el.x<eh.x||el.x===eh.x&&el.y<eh.y)&&(eh=el),el=el.next;while(el!==F);return eh}(eg))}ep.sort(Pc);for(let F=0;F<ep.length;F++)eh=function(F,el){let eh=function(F,el){let eh=el,ec=F.x,ep=F.y,e_,eg=-1/0;do{if(ep<=eh.y&&ep>=eh.next.y&&eh.next.y!==eh.y){let F=eh.x+(ep-eh.y)*(eh.next.x-eh.x)/(eh.next.y-eh.y);if(F<=ec&&F>eg&&(eg=F,e_=eh.x<eh.next.x?eh:eh.next,F===ec))return e_}eh=eh.next}while(eh!==el);if(!e_)return null;let ey=e_,eb=e_.x,ew=e_.y,eT=1/0;eh=e_;do{if(ec>=eh.x&&eh.x>=eb&&ec!==eh.x&&Bc(ep<ew?ec:eg,ep,eb,ew,ep<ew?eg:ec,ep,eh.x,eh.y)){var eS,eE;let el=Math.abs(ep-eh.y)/(ec-eh.x);Oc(eh,F)&&(el<eT||el===eT&&(eh.x>e_.x||eh.x===e_.x&&(eS=e_,eE=eh,0>Cc(eS.prev,eS,eE.prev)&&0>Cc(eE.next,eS,eS.next))))&&(e_=eh,eT=el)}eh=eh.next}while(eh!==ey);return e_}(F,el);if(!eh)return el;let ec=Nc(eh,F);return _c(ec,ec.next),_c(eh,eh.next)}(ep[F],eh);return eh}(F,el,eb,eh)),F.length>80*eh){ec=1/0,ep=1/0;let el=-1/0,eg=-1/0;for(let e_=eh;e_<ey;e_+=eh){let eh=F[e_],ey=F[e_+1];eh<ec&&(ec=eh),ey<ep&&(ep=ey),eh>el&&(el=eh),ey>eg&&(eg=ey)}e_=0!==(e_=Math.max(el-ec,eg-ep))?32767/e_:0}return function wc(F,el,eh,ec,ep,e_,eg){if(!F)return;!eg&&e_&&function(F,el,eh,ec){let ep=F;do 0===ep.z&&(ep.z=kc(ep.x,ep.y,el,eh,ec)),ep.prevZ=ep.prev,ep.nextZ=ep.next,ep=ep.next;while(ep!==F);ep.prevZ.nextZ=null,ep.prevZ=null,function(F){let el,eh=1;do{let ec,ep=F;F=null;let e_=null;for(el=0;ep;){el++;let eg=ep,ey=0;for(let F=0;F<eh&&(ey++,eg=eg.nextZ);F++);let eb=eh;for(;ey>0||eb>0&&eg;)0!==ey&&(0===eb||!eg||ep.z<=eg.z)?(ec=ep,ep=ep.nextZ,ey--):(ec=eg,eg=eg.nextZ,eb--),e_?e_.nextZ=ec:F=ec,ec.prevZ=e_,e_=ec;ep=eg}e_.nextZ=null,eh*=2}while(el>1)}(ep)}(F,ec,ep,e_);let ey=F;for(;F.prev!==F.next;){let eb=F.prev,ew=F.next;if(e_?function(F,el,eh,ec){let ep=F.prev,e_=F.next;if(Cc(ep,F,e_)>=0)return!1;let eg=ep.x,ey=F.x,eb=e_.x,ew=ep.y,eT=F.y,eS=e_.y,eE=eg<ey?eg<eb?eg:eb:ey<eb?ey:eb,eM=ew<eT?ew<eS?ew:eS:eT<eS?eT:eS,eI=eg>ey?eg>eb?eg:eb:ey>eb?ey:eb,eA=ew>eT?ew>eS?ew:eS:eT>eS?eT:eS,eC=kc(eE,eM,el,eh,ec),eP=kc(eI,eA,el,eh,ec),ez=F.prevZ,eD=F.nextZ;for(;ez&&ez.z>=eC&&eD&&eD.z<=eP;){if(ez.x>=eE&&ez.x<=eI&&ez.y>=eM&&ez.y<=eA&&ez!==ep&&ez!==e_&&Bc(eg,ew,ey,eT,eb,eS,ez.x,ez.y)&&Cc(ez.prev,ez,ez.next)>=0||(ez=ez.prevZ,eD.x>=eE&&eD.x<=eI&&eD.y>=eM&&eD.y<=eA&&eD!==ep&&eD!==e_&&Bc(eg,ew,ey,eT,eb,eS,eD.x,eD.y)&&Cc(eD.prev,eD,eD.next)>=0))return!1;eD=eD.nextZ}for(;ez&&ez.z>=eC;){if(ez.x>=eE&&ez.x<=eI&&ez.y>=eM&&ez.y<=eA&&ez!==ep&&ez!==e_&&Bc(eg,ew,ey,eT,eb,eS,ez.x,ez.y)&&Cc(ez.prev,ez,ez.next)>=0)return!1;ez=ez.prevZ}for(;eD&&eD.z<=eP;){if(eD.x>=eE&&eD.x<=eI&&eD.y>=eM&&eD.y<=eA&&eD!==ep&&eD!==e_&&Bc(eg,ew,ey,eT,eb,eS,eD.x,eD.y)&&Cc(eD.prev,eD,eD.next)>=0)return!1;eD=eD.nextZ}return!0}(F,ec,ep,e_):function(F){let el=F.prev,eh=F.next;if(Cc(el,F,eh)>=0)return!1;let ec=el.x,ep=F.x,e_=eh.x,eg=el.y,ey=F.y,eb=eh.y,ew=ec<ep?ec<e_?ec:e_:ep<e_?ep:e_,eT=eg<ey?eg<eb?eg:eb:ey<eb?ey:eb,eS=ec>ep?ec>e_?ec:e_:ep>e_?ep:e_,eE=eg>ey?eg>eb?eg:eb:ey>eb?ey:eb,eM=eh.next;for(;eM!==el;){if(eM.x>=ew&&eM.x<=eS&&eM.y>=eT&&eM.y<=eE&&Bc(ec,eg,ep,ey,e_,eb,eM.x,eM.y)&&Cc(eM.prev,eM,eM.next)>=0)return!1;eM=eM.next}return!0}(F))el.push(eb.i,F.i,ew.i),jc(F),F=ew.next,ey=ew.next;else if((F=ew)===ey){eg?1===eg?wc(F=function(F,el){let eh=F;do{let ec=eh.prev,ep=eh.next.next;!Dc(ec,ep)&&Rc(ec,eh,eh.next,ep)&&Oc(ec,ep)&&Oc(ep,ec)&&(el.push(ec.i,eh.i,ep.i),jc(eh),jc(eh.next),eh=F=ep),eh=eh.next}while(eh!==F);return _c(eh)}(_c(F),el),el,eh,ec,ep,e_,2):2===eg&&function(F,el,eh,ec,ep,e_){let eg=F;do{let F=eg.next.next;for(;F!==eg.prev;){var ey,eb;if(eg.i!==F.i&&(ey=eg,eb=F,ey.next.i!==eb.i&&ey.prev.i!==eb.i&&!function(F,el){let eh=F;do{if(eh.i!==F.i&&eh.next.i!==F.i&&eh.i!==el.i&&eh.next.i!==el.i&&Rc(eh,eh.next,F,el))return!0;eh=eh.next}while(eh!==F);return!1}(ey,eb)&&(Oc(ey,eb)&&Oc(eb,ey)&&function(F,el){let eh=F,ec=!1,ep=(F.x+el.x)/2,e_=(F.y+el.y)/2;do eh.y>e_!=eh.next.y>e_&&eh.next.y!==eh.y&&ep<(eh.next.x-eh.x)*(e_-eh.y)/(eh.next.y-eh.y)+eh.x&&(ec=!ec),eh=eh.next;while(eh!==F);return ec}(ey,eb)&&(Cc(ey.prev,ey,eb.prev)||Cc(ey,eb.prev,eb))||Dc(ey,eb)&&Cc(ey.prev,ey,ey.next)>0&&Cc(eb.prev,eb,eb.next)>0))){let ey=Nc(eg,F);return eg=_c(eg,eg.next),ey=_c(ey,ey.next),wc(eg,el,eh,ec,ep,e_,0),void wc(ey,el,eh,ec,ep,e_,0)}F=F.next}eg=eg.next}while(eg!==F)}(F,el,eh,ec,ep,e_):wc(_c(F),el,eh,ec,ep,e_,1);break}}}(eb,ew,eh,ec,ep,e_,0),ew}function bc(F,el,eh,ec,ep){let e_;if(ep===function(F,el,eh,ec){let ep=0;for(let e_=el,eg=eh-ec;e_<eh;e_+=ec)ep+=(F[eg]-F[e_])*(F[e_+1]+F[eg+1]),eg=e_;return ep}(F,el,eh,ec)>0)for(let ep=el;ep<eh;ep+=ec)e_=Uc(ep/ec|0,F[ep],F[ep+1],e_);else for(let ep=eh-ec;ep>=el;ep-=ec)e_=Uc(ep/ec|0,F[ep],F[ep+1],e_);return e_&&Dc(e_,e_.next)&&(jc(e_),e_=e_.next),e_}function _c(F,el){if(!F)return F;el||(el=F);let eh,ec=F;do if(eh=!1,ec.steiner||!Dc(ec,ec.next)&&0!==Cc(ec.prev,ec,ec.next))ec=ec.next;else{if(jc(ec),(ec=el=ec.prev)===ec.next)break;eh=!0}while(eh||ec!==el);return el}function Pc(F,el){return F.x-el.x}function kc(F,el,eh,ec,ep){return(F=1431655765&((F=858993459&((F=252645135&((F=16711935&((F=(F-eh)*ep|0)|F<<8))|F<<4))|F<<2))|F<<1))|(el=1431655765&((el=858993459&((el=252645135&((el=16711935&((el=(el-ec)*ep|0)|el<<8))|el<<4))|el<<2))|el<<1))<<1}function Bc(F,el,eh,ec,ep,e_,eg,ey){return(ep-eg)*(el-ey)>=(F-eg)*(e_-ey)&&(F-eg)*(ec-ey)>=(eh-eg)*(el-ey)&&(eh-eg)*(e_-ey)>=(ep-eg)*(ec-ey)}function Cc(F,el,eh){return(el.y-F.y)*(eh.x-el.x)-(el.x-F.x)*(eh.y-el.y)}function Dc(F,el){return F.x===el.x&&F.y===el.y}function Rc(F,el,eh,ec){let ep=Fc(Cc(F,el,eh)),e_=Fc(Cc(F,el,ec)),eg=Fc(Cc(eh,ec,F)),ey=Fc(Cc(eh,ec,el));return ep!==e_&&eg!==ey||!(0!==ep||!Lc(F,eh,el))||!(0!==e_||!Lc(F,ec,el))||!(0!==eg||!Lc(eh,F,ec))||!(0!==ey||!Lc(eh,el,ec))}function Lc(F,el,eh){return el.x<=Math.max(F.x,eh.x)&&el.x>=Math.min(F.x,eh.x)&&el.y<=Math.max(F.y,eh.y)&&el.y>=Math.min(F.y,eh.y)}function Fc(F){return F>0?1:F<0?-1:0}function Oc(F,el){return 0>Cc(F.prev,F,F.next)?Cc(F,el,F.next)>=0&&Cc(F,F.prev,el)>=0:0>Cc(F,el,F.prev)||0>Cc(F,F.next,el)}function Nc(F,el){let eh=qc(F.i,F.x,F.y),ec=qc(el.i,el.x,el.y),ep=F.next,e_=el.prev;return F.next=el,el.prev=F,eh.next=ep,ep.prev=eh,ec.next=eh,eh.prev=ec,e_.next=ec,ec.prev=e_,ec}function Uc(F,el,eh,ec){let ep=qc(F,el,eh);return ec?(ep.next=ec.next,ep.prev=ec,ec.next.prev=ep,ec.next=ep):(ep.prev=ep,ep.next=ep),ep}function jc(F){F.next.prev=F.prev,F.prev.next=F.next,F.prevZ&&(F.prevZ.nextZ=F.nextZ),F.nextZ&&(F.nextZ.prevZ=F.prevZ)}function qc(F,el,eh){return{i:F,x:el,y:eh,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function $c(F,el){let eh,ec;let ep=F.length;if(ep<=1)return[F];let e_=[];for(let el=0;el<ep;el++){let ep=function(F){let el=0;for(let eh,ec,ep=0,e_=F.length,eg=e_-1;ep<e_;eg=ep++)eh=F[ep],el+=((ec=F[eg]).x-eh.x)*(eh.y+ec.y);return el}(F[el]);0!==ep&&(F[el].area=Math.abs(ep),void 0===ec&&(ec=ep<0),ec===ep<0?(eh&&e_.push(eh),eh=[F[el]]):eh.push(F[el]))}if(eh&&e_.push(eh),el>1)for(let F=0;F<e_.length;F++)e_[F].length<=el||(function br(F,el,eh=0,ec=F.length-1,ep=function(F,el){return F<el?-1:F>el?1:0}){for(;ec>eh;){if(ec-eh>600){let e_=ec-eh+1,eg=el-eh+1,ey=Math.log(e_),eb=.5*Math.exp(2*ey/3),ew=.5*Math.sqrt(ey*eb*(e_-eb)/e_)*(eg-e_/2<0?-1:1);br(F,el,Math.max(eh,Math.floor(el-eg*eb/e_+ew)),Math.min(ec,Math.floor(el+(e_-eg)*eb/e_+ew)),ep)}let e_=F[el],eg=eh,ey=ec;for(_r(F,eh,el),ep(F[ec],e_)>0&&_r(F,eh,ec);eg<ey;){for(_r(F,eg,ey),eg++,ey--;0>ep(F[eg],e_);)eg++;for(;ep(F[ey],e_)>0;)ey--}0===ep(F[eh],e_)?_r(F,eh,ey):_r(F,++ey,ec),ey<=el&&(eh=ey+1),el<=ey&&(ec=ey-1)}}(e_[F],el,1,e_[F].length-1,Gc),e_[F]=e_[F].slice(0,el));return e_}function Gc(F,el){return el.area-F.area}function Yc(F,el,eh=1){if(!F)return null;let ec="string"==typeof F?er.from(F).getPrimary():F.getPrimary(),ep=ec.id.toString();return el.has(ep)||el.set(ep,[]),ec.scaleSelf(eh),el.get(ep).push(ec),ec.toString()}function Hc(F,el,eh,ec){let ep=ec.patternDependencies,e_=!1;for(let ec of el){let el=ec.paint.get(`${F}-pattern`);el.isConstant()||(e_=!0),Yc(el.constantOr(null),ep,eh)&&(e_=!0)}return e_}function Xc(F,el,eh,ec,ep,e_){let eg=e_.patternDependencies;for(let ey of el){let el=ey.paint.get(`${F}-pattern`).value;if("constant"!==el.kind){let F=el.evaluate({zoom:ec},eh,{},e_.availableImages);F=F&&F.name?F.name:F;let eb=Yc(F,eg,ep);eb&&(eh.patterns[ey.id]=eb)}}return eh}var r9,r7,ah,au,ac,ad,ap,af={};function nh(){if(r7)return r9;r7=1;var F=j();function e(F,el,eh,ec,ep){this.properties={},this.extent=eh,this.type=0,this._pbf=F,this._geometry=-1,this._keys=ec,this._values=ep,F.readFields(r,this,el)}function r(F,el,eh){1==F?el.id=eh.readVarint():2==F?function(F,el){for(var eh=F.readVarint()+F.pos;F.pos<eh;){var ec=el._keys[F.readVarint()],ep=el._values[F.readVarint()];el.properties[ec]=ep}}(eh,el):3==F?el.type=eh.readVarint():4==F&&(el._geometry=eh.pos)}return r9=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var el=this._pbf;el.pos=this._geometry;for(var eh,ec=el.readVarint()+el.pos,ep=1,e_=0,eg=0,ey=0,eb=[];el.pos<ec;){if(e_<=0){var ew=el.readVarint();ep=7&ew,e_=ew>>3}if(e_--,1===ep||2===ep)eg+=el.readSVarint(),ey+=el.readSVarint(),1===ep&&(eh&&eb.push(eh),eh=[]),eh.push(new F(eg,ey));else{if(7!==ep)throw Error("unknown command "+ep);eh&&eh.push(eh[0].clone())}}return eh&&eb.push(eh),eb},e.prototype.bbox=function(){var F=this._pbf;F.pos=this._geometry;for(var el=F.readVarint()+F.pos,eh=1,ec=0,ep=0,e_=0,eg=1/0,ey=-1/0,eb=1/0,ew=-1/0;F.pos<el;){if(ec<=0){var eT=F.readVarint();eh=7&eT,ec=eT>>3}if(ec--,1===eh||2===eh)(ep+=F.readSVarint())<eg&&(eg=ep),ep>ey&&(ey=ep),(e_+=F.readSVarint())<eb&&(eb=e_),e_>ew&&(ew=e_);else if(7!==eh)throw Error("unknown command "+eh)}return[eg,eb,ey,ew]},e.prototype.toGeoJSON=function(F,el,eh){var ec,ep,e_=this.extent*Math.pow(2,eh),eg=this.extent*F,ey=this.extent*el,eb=this.loadGeometry(),ew=e.types[this.type];function p(F){for(var el=0;el<F.length;el++){var eh=F[el];F[el]=[360*(eh.x+eg)/e_-180,360/Math.PI*Math.atan(Math.exp((180-360*(eh.y+ey)/e_)*Math.PI/180))-90]}}switch(this.type){case 1:var eT=[];for(ec=0;ec<eb.length;ec++)eT[ec]=eb[ec][0];p(eb=eT);break;case 2:for(ec=0;ec<eb.length;ec++)p(eb[ec]);break;case 3:for(eb=function(F){var el=F.length;if(el<=1)return[F];for(var eh,ec,ep=[],e_=0;e_<el;e_++){var eg=function(F){for(var el,eh,ec=0,ep=0,e_=F.length,eg=e_-1;ep<e_;eg=ep++)ec+=((eh=F[eg]).x-(el=F[ep]).x)*(el.y+eh.y);return ec}(F[e_]);0!==eg&&(void 0===ec&&(ec=eg<0),ec===eg<0?(eh&&ep.push(eh),eh=[F[e_]]):eh.push(F[e_]))}return eh&&ep.push(eh),ep}(eb),ec=0;ec<eb.length;ec++)for(ep=0;ep<eb[ec].length;ep++)p(eb[ec][ep])}1===eb.length?eb=eb[0]:ew="Multi"+ew;var eS={type:"Feature",geometry:{type:ew,coordinates:eb},properties:this.properties};return"id"in this&&(eS.id=this.id),eS},r9}function ih(){if(au)return ah;au=1;var F=nh();function e(F,el){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=F,this._keys=[],this._values=[],this._features=[],F.readFields(r,this,el),this.length=this._features.length}function r(F,el,eh){15===F?el.version=eh.readVarint():1===F?el.name=eh.readString():5===F?el.extent=eh.readVarint():2===F?el._features.push(eh.pos):3===F?el._keys.push(eh.readString()):4===F&&el._values.push(function(F){for(var el=null,eh=F.readVarint()+F.pos;F.pos<eh;){var ec=F.readVarint()>>3;el=1===ec?F.readString():2===ec?F.readFloat():3===ec?F.readDouble():4===ec?F.readVarint64():5===ec?F.readVarint():6===ec?F.readSVarint():7===ec?F.readBoolean():null}return el}(eh))}return ah=e,e.prototype.feature=function(el){if(el<0||el>=this._features.length)throw Error("feature index out of bounds");this._pbf.pos=this._features[el];var eh=this._pbf.readVarint()+this._pbf.pos;return new F(this._pbf,eh,this.extent,this._keys,this._values)},ah}function sh(){return ap||(ap=1,af.VectorTile=function(){if(ad)return ac;ad=1;var F=ih();function e(el,eh,ec){if(3===el){var ep=new F(ec,ec.readVarint()+ec.pos);ep.length&&(eh[ep.name]=ep)}}return ac=function(F,el){this.layers=F.readFields(e,{},el)}}(),af.VectorTileFeature=nh(),af.VectorTileLayer=ih()),af}var am=sh();let a_="3d_elevation_id",av="level";let uh=class uh{constructor(){this._valid=!1}reset(F){return this.feature=F,this._valid=!0,this._geometry=F.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry(F,el){return this._valid&&F(el(this._geometry)),this}require(F,el,eh){return this.get(F,!0,el,eh)}optional(F,el,eh){return this.get(F,!1,el,eh)}success(){return this._valid}get(F,el,eh,ec){let ep=this.feature.properties.hasOwnProperty(F)?+this.feature.properties[F]:void 0;return this._valid&&void 0!==ep?eh(ec?ec(ep):ep):el&&(this._valid=!1),this}};let ch=class ch{constructor(F,el){this.featureFunc=F,this.vertexFunc=el}parseFeature(F,el,eh){return this.featureFunc(F,el,eh)}parseVertex(F,el,eh){return this.vertexFunc(F,el,eh)}};let ab=new ch((F,el,eh)=>F.reset(el).require(a_,F=>{eh.id=F}).optional("fixed_height_relative",F=>{eh.constantHeight=F},fh.decodeRelativeHeight).geometry(F=>{eh.bounds=F},fh.computeBounds).success(),(F,el,eh)=>F.reset(el).require(a_,F=>{eh.id=F}).require("elevation_idx",F=>{eh.idx=F}).require("extent",F=>{eh.extent=F}).require("height_relative",F=>{eh.height=F},fh.decodeRelativeHeight).geometry(F=>{eh.position=F},fh.getPoint).success()),aw=new ch((F,el,eh)=>F.reset(el).require(a_,F=>{eh.id=F}).optional("fixed_height",F=>{eh.constantHeight=F},fh.decodeMetricHeight).geometry(F=>{eh.bounds=F},fh.computeBounds).success(),(F,el,eh)=>F.reset(el).require(a_,F=>{eh.id=F}).require("elevation_idx",F=>{eh.idx=F}).require("extent",F=>{eh.extent=F}).require("height",F=>{eh.height=F},fh.decodeMetricHeight).geometry(F=>{eh.position=F},fh.getPoint).success());let fh=class fh{static computeBounds(F){let el=new tU(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),eh=new tU(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let ec of F[0])el.x>ec.x&&(el.x=ec.x),el.y>ec.y&&(el.y=ec.y),eh.x<ec.x&&(eh.x=ec.x),eh.y<ec.y&&(eh.y=ec.y);return{min:el,max:eh}}static getPoint(F){return tN.vec2.fromValues(F[0][0].x,F[0][0].y)}static decodeRelativeHeight(F){return 1e-4*F*5}static decodeMetricHeight(F){return 1e-4*F}static parse(F){let el=[],eh=[],ec=F.length,ep=new uh;for(let e_=0;e_<ec;e_++){let ec=F.feature(e_),eg=ec.properties.hasOwnProperty("version")?String(ec.properties.version):void 0,ey=eg?"1.0.1"===eg?aw:void 0:ab;if(void 0===ey){pt(`Unknown elevation feature version number ${eg||"(unknown)"}`);continue}let eb=ec.properties.hasOwnProperty("type")?ec.properties.type:void 0;if(eb){if("Point"===am.VectorTileFeature.types[ec.type]&&"curve_point"===eb){let F={};ey.parseVertex(ep,ec,F)&&el.push(F)}else if("Polygon"===am.VectorTileFeature.types[ec.type]&&"curve_meta"===eb){let F={};ey.parseFeature(ep,ec,F)&&eh.push(F)}}}return{vertices:el,features:eh}}};let dh=class dh{constructor(F,el,eh,ec,ep,e_){if(this.vertices=[],this.vertexProps=[],this.edges=[],this.edgeProps=[],this.id=F,this.heightRange={min:eh,max:eh},this.safeArea=el,this.constantHeight=eh,null==this.constantHeight&&(null!=this.constantHeight||0!==ec.length)){for(let F of(this.vertices=ec,this.edges=ep,this.edges=this.edges.filter(F=>F.a<this.vertices.length&&F.b<this.vertices.length&&!tN.vec2.exactEquals(this.vertices[F.a].position,this.vertices[F.b].position)),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},this.vertices))this.vertexProps.push({dir:tN.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,F.height),this.heightRange.max=Math.max(this.heightRange.max,F.height);for(let F of this.edges){let el=this.vertices[F.a].position,eh=this.vertices[F.b].position,ec=tN.vec2.subtract(tN.vec2.create(),eh,el),ep=tN.vec2.length(ec),e_=tN.vec2.scale(tN.vec2.create(),ec,1/ep);this.edgeProps.push({vec:ec,dir:e_,len:ep});let eg=this.vertexProps[F.a].dir,ey=this.vertexProps[F.b].dir;tN.vec2.add(eg,eg,e_),tN.vec2.add(ey,ey,e_)}for(let F of this.vertexProps)0===F.dir[0]&&0===F.dir[1]||tN.vec2.normalize(F.dir,F.dir);this.tessellate(e_)}}pointElevation(F){if(null!=this.constantHeight)return this.constantHeight;let el=this.getClosestEdge(F);if(null==el)return 0;let[eh,ec]=el;return(1-ec)*this.vertices[this.edges[eh].a].height+ec*this.vertices[this.edges[eh].b].height}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(F){if(0===this.edges.length)return;let el=0,eh=Number.POSITIVE_INFINITY,ec=0,ep=tN.vec2.fromValues(F.x,F.y);for(let F=0;F<this.edges.length;F++){let e_=this.edges[F],eg=this.edgeProps[F].dir,ey=new yu(ep,this.edgeProps[F].dir),eb=this.vertices[e_.a].position,ew=this.vertices[e_.b].position,eT=tN.vec2.create(),eS=tN.vec2.create(),eE=ey.intersectsPlane(eb,this.vertexProps[e_.a].dir,eT),eM=ey.intersectsPlane(ew,this.vertexProps[e_.b].dir,eS);if(!eE||!eM)continue;let eI=tN.vec2.subtract(tN.vec2.create(),eS,eT),eA=tN.vec2.subtract(tN.vec2.create(),ep,eT),eC=tN.vec2.dot(eI,eI),eP=eC>0?tN.vec2.dot(eA,eI)/eC:0,ez=Q(eP,0,1),eD=Math.abs((eP-ez)*this.edgeProps[F].len),eR=tN.vec2.subtract(tN.vec2.create(),ep,eb),eL=eD+Math.abs(tN.vec2.dot(eR,tN.vec2.fromValues(eg[1],-eg[0])));eL<eh&&(el=F,eh=eL,ec=ez)}return[el,ec]}tessellate(F){for(let el=this.edges.length-1;el>=0;--el){let eh=this.edges[el].a,ec=this.edges[el].b,{position:ep,height:e_,extent:eg}=this.vertices[eh],{position:ey,height:eb,extent:ew}=this.vertices[ec],eT=this.vertexProps[eh].dir,eS=this.vertexProps[ec].dir,eE=tN.vec3.fromValues(ep[0]/F,ep[1]/F,e_),eM=tN.vec3.fromValues(ey[0]/F,ey[1]/F,eb),eI=tN.vec3.fromValues(eT[1],-eT[0],0);tN.vec3.scale(eI,eI,eg);let eA=tN.vec3.fromValues(eS[1],-eS[0],0);if(tN.vec3.scale(eA,eA,ew),this.distSqLines(tN.vec3.fromValues(eE[0]+.5*eI[0],eE[1]+.5*eI[1],eE[2]+.5*eI[2]),tN.vec3.fromValues(eM[0]-.5*eA[0],eM[1]-.5*eA[1],eM[2]-.5*eA[2]),tN.vec3.fromValues(eE[0]-.5*eI[0],eE[1]-.5*eI[1],eE[2]-.5*eI[2]),tN.vec3.fromValues(eM[0]+.5*eA[0],eM[1]+.5*eA[1],eM[2]+.5*eA[2]))<=.05*.05)continue;let eC=this.vertices.length,eP=tN.vec2.add(tN.vec2.create(),ep,ey);this.vertices.push({position:tN.vec2.scale(eP,eP,.5),height:.5*(e_+eb),extent:.5*(eg+ew)});let ez=tN.vec2.add(tN.vec2.create(),eT,eS);this.vertexProps.push({dir:tN.vec2.normalize(ez,ez)}),this.edges.splice(el,1),this.edgeProps.splice(el,1),this.edges.push({a:eh,b:eC}),this.edges.push({a:eC,b:ec});let eD=tN.vec2.subtract(tN.vec2.create(),this.vertices[eC].position,ep),eR=tN.vec2.length(eD),eL={vec:eD,dir:tN.vec2.scale(tN.vec2.create(),eD,1/eR),len:eR};this.edgeProps.push(eL),this.edgeProps.push(eL)}}distSqLines(F,el,eh,ec){let ep=tN.vec3.subtract(tN.vec3.create(),el,F),e_=tN.vec3.subtract(tN.vec3.create(),ec,eh),eg=tN.vec3.subtract(tN.vec3.create(),F,eh),ey=tN.vec3.dot(ep,ep),eb=tN.vec3.dot(ep,e_),ew=tN.vec3.dot(ep,eg),eT=tN.vec3.dot(e_,e_),eS=tN.vec3.dot(e_,eg),eE=ey*eT-eb*eb;if(0===eE){let el=tN.vec3.dot(eg,e_)/tN.vec3.dot(e_,e_),ep=tN.vec3.lerp(tN.vec3.create(),eh,ec,el);return tN.vec3.squaredDistance(ep,F)}let eM=tN.vec3.lerp(tN.vec3.create(),F,el,(eb*eS-ew*eT)/eE),eI=tN.vec3.lerp(tN.vec3.create(),eh,ec,(ey*eS-eb*ew)/eE);return tN.vec3.squaredDistance(eM,eI)}};let mh=class mh{constructor(F,el){this.zScale=1,this.xOffset=0,this.yOffset=0,F.equals(el)||(this.zScale=Math.pow(2,el.z-F.z),this.xOffset=(F.x*this.zScale-el.x)*8192,this.yOffset=(F.y*this.zScale-el.y)*8192)}constantElevation(F,el){if(null!=F.constantHeight)return this.computeBiasedHeight(F.constantHeight,el)}pointElevation(F,el,eh){let ec=this.constantElevation(el,eh);return null!=ec?ec:(F.x=F.x*this.zScale+this.xOffset,F.y=F.y*this.zScale+this.yOffset,this.computeBiasedHeight(el.pointElevation(F),eh))}computeBiasedHeight(F,el){return el<=0?F:F+el*tt(0,el,F>=0?F:Math.abs(.5*F))}};us(dh,"ElevationFeature");let yh=class yh{constructor(){this.polygons=new Map}add(F,...el){this.polygons.has(F)?this.polygons.get(F).push(...el):this.polygons.set(F,el)}merge(F){for(let[el,eh]of F.polygons)this.add(el,...eh)}};let gh=class gh{constructor(){this.portals=[]}static evaluate(F){if(0===F.length)return new gh;let el=[];for(let eh of F)el.push(...eh.portals);if(0===el.length)return new gh;let r=(F,el)=>F<=0&&el<=0||F>=8192&&el>=8192;for(let F of el){let el=F.va,eh=F.vb;(r(el.x,eh.x)||r(el.y,eh.y))&&(F.type="border")}let eh=el.filter(F=>"unevaluated"!==F.type),ec=el.filter(F=>"unevaluated"===F.type);if(0===ec.length)return new gh;ec.sort((F,el)=>F.hash===el.hash?F.isTunnel===el.isTunnel?0:F.isTunnel?-1:1:F.hash<el.hash?1:-1),el=eh.concat(ec);let ep=eh.length,e_=ep,eg=ep;do if(++e_===el.length||el[ep].hash!==el[e_].hash){if(e_-ep==2){eg<ep&&(el[eg]=el[ep],el[ep]=null);let F=el[eg],eh=el[e_-1];F.type=F.isTunnel!==eh.isTunnel?"tunnel":"polygon",F.connection={a:F.connection.a,b:eh.connection.a},eg++}ep=e_}while(ep!==el.length);return el.splice(eg),el.sort((F,el)=>F.hash<el.hash?1:-1),{portals:el}}};us(gh,"ElevationPortalGraph"),us(yh,"ElevationPolygons");let xh=class xh{constructor(F,el,eh){this.outPositions=F,this.outNormals=el,this.outIndices=eh,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(F,el,eh){let ec=F[2];null!=eh&&(ec*=eh);let ep=this.getVec3Bits(F)<<96n|this.getVec3Bits(el),e_=this.vertexLookup.get(ep);if(null!=e_)return e_;let eg=this.outPositions.length;this.vertexLookup.set(ep,eg);let ey=Math.trunc(16384*el[0]),eb=Math.trunc(16384*el[1]),ew=Math.trunc(16384*el[2]);return this.outPositions.emplaceBack(F[0],F[1],ec),this.outNormals.emplaceBack(ey,eb,ew),eg}addVertices(F,el,...eh){let ec=[];for(let ep of eh){let eh=this.addVertex(ep,F,el);ec.push(eh)}return ec}addTriangles(F,el,eh){if(el&&eh){let ec=1===eh.length,ep=tN.vec3.fromValues(0,0,0);for(let e_=0;e_<F.length;e_+=3){let eg=el[F[e_+0]],ey=el[F[e_+1]],eb=el[F[e_+2]],ew=ec?eh[0]:eh[F[e_+1]],eT=ec?eh[0]:eh[F[e_+2]],eS=this.addVertex(tN.vec3.fromValues(eg.x,eg.y,ec?eh[0]:eh[F[e_+0]]),ep),eE=this.addVertex(tN.vec3.fromValues(ey.x,ey.y,ew),ep),eM=this.addVertex(tN.vec3.fromValues(eb.x,eb.y,eT),ep);this.outIndices.emplaceBack(eS,eE,eM)}}else for(let el=0;el<F.length;el+=3)this.outIndices.emplaceBack(F[el+0],F[el+1],F[el+2])}addQuad(F,el){let eh=this.addVertices(el,void 0,...F.map(F=>tN.vec3.fromValues(F.coord.x,F.coord.y,F.height))),[ec,ep,e_,eg]=eh;this.addTriangles([ec,ep,e_,e_,eg,ec])}getBits(F){return this.view.setFloat32(0,F),BigInt(this.view.getUint32(0))}getVec3Bits(F){return this.getBits(F[0])<<64n|this.getBits(F[1])<<32n|this.getBits(F[2])}};let vh=class vh{constructor(F){this.unevaluatedPortals=new gh,this.portalPolygons=new yh,this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new Ia,this.vertexNormals=new Sa,this.indexArray=new ja,this.tileToMeters=Al(F)}addVertices(F,el){let eh=this.unevalVertices.length;for(let eh=0;eh<F.length;eh++)this.unevalVertices.push(F[eh]),this.unevalHeights.push(el[eh]);return eh}addTriangles(F,el,eh){let ec=eh?this.unevalTunnelTriangles:this.unevalTriangles;for(let eh of F)ec.push(eh+el)}addRenderableRing(F,el,eh,ec,ep){let e_=[new tU(ep.min.x,ep.min.y),new tU(ep.max.x,ep.min.y),new tU(ep.max.x,ep.max.y),new tU(ep.min.x,ep.max.y)];for(let eg=0;eg<eh-1;eg++){let eh=el+eg,ey=eh+1,eb=this.unevalVertices[eh],ew=this.unevalVertices[ey];if(!(eb.x>=ep.min.x&&eb.x<=ep.max.x&&eb.y>=ep.min.y&&eb.y<=ep.max.y||ew.x>=ep.min.x&&ew.x<=ep.max.x&&ew.y>=ep.min.y&&ew.y<=ep.max.y||Zl(eb,ew,e_))||this.isOnBorder(eb.x,ew.x)||this.isOnBorder(eb.y,ew.y))continue;let eT=vh.computeEdgeHash(this.unevalVertices[eh],this.unevalVertices[ey]),eS,eE=this.vertexHashLookup.get(vh.computePosHash(eb));eS=null!=eE?eE.next:null!=(eE=this.vertexHashLookup.get(vh.computePosHash(ew)))?eE.prev:eT,this.unevalEdges.push({polygonIdx:F,a:eh,b:ey,hash:eT,portalHash:eS,isTunnel:ec,type:"unevaluated"})}}addPortalCandidates(F,el,eh,ec,ep){if(0===el.length)return;this.portalPolygons.add(F,{geometry:el,zLevel:ep});let e_=el[0];this.vertexHashLookup.clear();let eg=vh.computeEdgeHash(e_[e_.length-2],e_[e_.length-1]);for(let el=0;el<e_.length-1;el++){let ep=e_[el+0],ey=e_[el+1],eb=tN.vec2.fromValues(ey.x-ep.x,ey.y-ep.y),ew=tN.vec2.length(eb);if(0===ew)continue;let eT="unevaluated",eS=ec.pointElevation(ep),eE=ec.pointElevation(ey);.01>Math.abs(eS)&&.01>Math.abs(eE)?eT="entrance":(this.isOnBorder(ep.x,ey.x)||this.isOnBorder(ep.y,ey.y))&&(eT="border");let eM=vh.computeEdgeHash(ep,ey);this.unevaluatedPortals.portals.push({connection:{a:F,b:void 0},va:ep,vb:ey,vab:eb,length:ew,hash:eM,isTunnel:eh,type:eT});let eI=vh.computePosHash(ep);this.vertexHashLookup.set(eI,{prev:eg,next:eM}),eg=eM}}construct(F){if(0===this.unevalVertices.length)return;let e=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),r=F=>{F.primitiveLength=this.indexArray.length-F.primitiveOffset},el=new xh(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(F.portals,this.unevalEdges);let eh=e(),ec=e(),ep=e(),o=(F,el)=>{F.sort((F,eh)=>F.type===el&&eh.type!==el?-1:F.type!==el&&eh.type===el?1:0);let eh=F.findIndex(F=>F.type!==el);return eh>=0?eh:F.length},e_=0;this.unevalEdges.length>0&&(e_=o(this.unevalEdges,"none"),this.constructBridgeStructures(el,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:e_},this.tileToMeters));let eg=e();if(this.unevalEdges.length>0){let F=this.unevalEdges.splice(e_),eh=o(F,"tunnel")+e_;this.unevalEdges.push(...F),this.constructTunnelStructures(el,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:e_},{min:e_,max:eh})}r(ep),el.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),r(eg),el.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),r(ec),el.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),r(eh),this.maskSegments=xo.simpleSegment(0,eg.primitiveOffset,0,eg.primitiveLength),this.depthSegments=xo.simpleSegment(0,ec.primitiveOffset,0,ec.primitiveLength),this.renderableSegments=xo.simpleSegment(0,ep.primitiveOffset,0,ep.primitiveLength),this.shadowCasterSegments=xo.simpleSegment(0,eh.primitiveOffset,0,eh.primitiveLength)}upload(F){this.vertexBuffer||0===this.vertexPositions.length||0===this.vertexNormals.length||0===this.indexArray.length||(this.vertexBuffer=F.createVertexBuffer(this.vertexPositions,r6.members),this.vertexBufferNormal=F.createVertexBuffer(this.vertexNormals,r8.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableSegments.destroy(),this.shadowCasterSegments.destroy())}computeVertexConnections(F,el,eh,ec){let ep=new Map;for(let e_=eh;e_<ec;e_++){let eh=el[e_],ec=eh.a,eg=eh.b;ep.has(ec)||ep.set(ec,{}),ep.has(eg)||ep.set(eg,{});let ey=ep.get(ec),eb=ep.get(eg);F[eg]>0&&(ey.to=eg),F[ec]>0&&(eb.from=ec)}return ep}constructBridgeStructures(F,el,eh,ec,ep,e_){let eg=this.computeVertexConnections(eh,ec,ep.min,ep.max),ey=1/e_,eb=.5*ey,u=F=>tN.vec3.fromValues(el[F].x,el[F].y,eh[F]*ey),c=F=>{let el=eg.get(F),eh=el.from,ec=el.to;if(!eh||!ec)return;let ep=u(eh),e_=u(F),ey=u(ec),eb=tN.vec3.fromValues(0,0,0);if(!tN.vec3.exactEquals(ep,e_)){let F=tN.vec3.sub(tN.vec3.create(),e_,ep);tN.vec3.add(eb,eb,tN.vec3.normalize(F,F))}if(!tN.vec3.exactEquals(ey,e_)){let F=tN.vec3.sub(tN.vec3.create(),ey,e_);tN.vec3.add(eb,eb,tN.vec3.normalize(F,F))}let ew=tN.vec3.len(eb);return ew>0?tN.vec3.scale(eb,eb,1/ew):void 0};for(let eg=ep.min;eg<ep.max;eg++){let ep=ec[eg],ew=this.prepareEdgePoints(el,eh,ep,(F,el)=>F>=el);if(null==ew)continue;let eT=ew[0],eS=ew[1],eE=tN.vec3.fromValues(eT.coord.x,eT.coord.y,ey*eT.height),eM=tN.vec3.fromValues(eS.coord.x,eS.coord.y,ey*eS.height);if(tN.vec3.exactEquals(eE,eM))continue;let eI=tN.vec3.sub(tN.vec3.create(),eM,eE);tN.vec3.normalize(eI,eI);let y=F=>tN.vec3.normalize(F,F),eA=c(ep.a)||eI,eC=c(ep.b)||eI,eP=y(tN.vec3.fromValues(eA[1],-eA[0],0)),ez=y(tN.vec3.fromValues(eC[1],-eC[0],0)),eD=y(tN.vec3.cross(tN.vec3.create(),eP,eA)),eR=y(tN.vec3.cross(tN.vec3.create(),ez,eC)),eL=tN.vec3.create(),eO=[tN.vec3.add(tN.vec3.create(),eE,tN.vec3.scale(eL,tN.vec3.sub(eL,eP,eD),eb)),tN.vec3.add(tN.vec3.create(),eE,tN.vec3.scale(eL,tN.vec3.add(eL,eP,eD),eb)),tN.vec3.add(tN.vec3.create(),eE,tN.vec3.scale(eL,eD,eb)),eE],ek=[tN.vec3.add(tN.vec3.create(),eM,tN.vec3.scale(eL,tN.vec3.sub(eL,ez,eR),eb)),tN.vec3.add(tN.vec3.create(),eM,tN.vec3.scale(eL,tN.vec3.add(eL,ez,eR),eb)),tN.vec3.add(tN.vec3.create(),eM,tN.vec3.scale(eL,eR,eb)),eM],[eF,eB]=F.addVertices(eP,e_,eO[0],eO[1]),[eN,eV]=F.addVertices(ez,e_,ek[0],ek[1]);F.addTriangles([eF,eB,eN,eB,eV,eN]);let[eU,ej]=F.addVertices(eD,e_,eO[1],eO[2]),[eG,eq]=F.addVertices(eR,e_,ek[1],ek[2]);F.addTriangles([eU,ej,eG,ej,eq,eG]);let[e$,eH]=F.addVertices(tN.vec3.negate(eP,eP),e_,eO[2],eO[3]),[eZ,eW]=F.addVertices(tN.vec3.negate(ez,ez),e_,ek[2],ek[3]);F.addTriangles([e$,eH,eZ,eH,eW,eZ])}}constructTunnelStructures(F,el,eh,ec,ep,e_){let a=F=>tN.vec3.normalize(F,F);for(let e_=ep.min;e_<ep.max;e_++){let ep=this.prepareEdgePoints(el,eh,ec[e_],(F,el)=>F<=el);if(null==ep)continue;let[eg,ey]=ep,eb=a(tN.vec3.fromValues(ey.coord.y-eg.coord.y,-(ey.coord.x-eg.coord.x),0));F.addQuad([eg,ey,{coord:ey.coord,height:ec[e_].isTunnel?-.1:0},{coord:eg.coord,height:ec[e_].isTunnel?-.1:0}],eb)}for(let ep=e_.min;ep<e_.max;ep++){let e_=ec[ep],eg=el[e_.a],ey=el[e_.b],eb=a(tN.vec3.fromValues(ey.y-eg.y,-(ey.x-eg.x),0));F.addQuad([{coord:ey,height:0},{coord:eg,height:0},{coord:eg,height:eh[e_.a]+4},{coord:ey,height:eh[e_.b]+4}],eb),F.addQuad([{coord:eg,height:0},{coord:ey,height:0},{coord:ey,height:eh[e_.b]+4},{coord:eg,height:eh[e_.a]+4}],eb)}}prepareEdgePoints(F,el,eh,ec){let ep=F[eh.a],e_=F[eh.b],eg=el[eh.a],ey=el[eh.b];if(!(0!==eg&&ec(eg,0)||0!==ey&&ec(ey,0)))return;let eb=ep.clone(),ew=e_.clone();if(ec(eg,0)){if(!ec(ey,0)){let F=ey/(ey-eg);ew.x=Ee(ew.x,eb.x,F),ew.y=Ee(ew.y,eb.y,F),ey=Ee(ey,eg,F)}}else{let F=eg/(eg-ey);eb.x=Ee(eb.x,ew.x,F),eb.y=Ee(eb.y,ew.y,F),eg=Ee(eg,ey,F)}return[{coord:eb,height:eg},{coord:ew,height:ey}]}prepareEdges(F,el){if(0===el.length)return;el.sort((F,el)=>F.hash===el.hash?el.polygonIdx-F.polygonIdx:el.hash>F.hash?1:-1);let eh=0,ec=0,ep=0,e_=el[0].polygonIdx;do(++ec===el.length||el[eh].hash!==el[ec].hash)&&((1==ec-eh||el[ec-1].polygonIdx!==e_)&&(ep<eh&&(el[ep]=el[eh],el[eh]=null),el[ep].type="none",ep++),(eh=ec)!==el.length&&(e_=el[eh].polygonIdx));while(eh!==el.length);if(el.splice(ep),0!==el.length&&0!==F.length){el.sort((F,el)=>F.hash<el.hash?1:-1);let eh=0,ec=0;for(;eh!==el.length&&ec!==F.length;){let ep=el[eh],e_=F[ec];ep.portalHash>e_.hash?eh++:e_.hash>ep.portalHash?ec++:(ep.type=e_.type,eh++)}}}isOnBorder(F,el){return F<=0&&el<=0||F>=8192&&el>=8192}static computeEdgeHash(F,el){return(F.y===el.y&&F.x>el.x||F.y>el.y)&&([F,el]=[el,F]),BigInt(vh.computePosHash(F))<<32n|BigInt(vh.computePosHash(el))}static computePosHash(F){return((65535&F.x)<<16|65535&F.y)>>>0}};let bh=class bh{constructor(F,el){this.layoutVertexArray=new _a,this.indexArray=new ja,this.lineIndexArray=new La,this.triangleSegments=new xo,this.lineSegments=new xo,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.uploaded=!1,el&&(this.elevatedLayoutVertexArray=new Aa)}update(F,el,eh,ec,ep,e_,eg){this.programConfigurations.updatePaintArrays(F,el,ep,eh,ec,e_,eg)}isEmpty(){return 0===this.layoutVertexArray.length}needsUpload(){return this.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,r4.members),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.lineIndexBuffer=F.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=F.createVertexBuffer(this.elevatedLayoutVertexArray,r5.members))),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(F,el,eh,ec,ep,e_){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,el,eh,ec,ep,e_)}};let _h=class _h{constructor(F){this.zoom=F.zoom,this.pixelRatio=F.pixelRatio,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map(F=>F.fqid),this.index=F.index,this.hasPattern=!1,this.patternFeatures=[],this.bufferData=new bh(F,!1),this.elevationBufferData=new bh(F,!0),this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.projection=F.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference")}updateFootprints(F,el){}populate(F,el,eh,ec){this.hasPattern=Hc("fill",this.layers,this.pixelRatio,el);let ep=this.layers[0].layout.get("fill-sort-key"),e_=[];for(let{feature:eg,id:ey,index:eb,sourceLayerIndex:ew}of F){let F=this.layers[0]._featureFilter.needGeometry,eT=Cl(eg,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),eT,eh))continue;let eS=ep?ep.evaluate(eT,{},eh,el.availableImages):void 0,eE={id:ey,properties:eg.properties,type:eg.type,sourceLayerIndex:ew,index:eb,geometry:F?eT.geometry:Vl(eg,eh,ec),patterns:{},sortKey:eS};e_.push(eE)}for(let ec of(ep&&e_.sort((F,el)=>F.sortKey-el.sortKey),e_)){let{geometry:ep,index:e_,sourceLayerIndex:eg}=ec;if(this.hasPattern){let F=Xc("fill",this.layers,ec,this.zoom,this.pixelRatio,el);this.patternFeatures.push(F)}else this.addFeature(ec,ep,e_,eh,{},el.availableImages,el.brightness,el.elevationFeatures);el.featureIndex.insert(F[e_].feature,ep,e_,eg,this.index)}}update(F,el,eh,ec,ep,e_,eg){this.bufferData.update(F,el,eh,ec,ep,e_,eg),this.elevationBufferData.update(F,el,eh,ec,ep,e_,eg)}addFeatures(F,el,eh,ec,ep,e_){for(let ep of this.patternFeatures)this.addFeature(ep,ep.geometry,ep.index,el,eh,ec,e_,F.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(F){this.bufferData.upload(F),this.elevationBufferData.upload(F),this.elevatedStructures&&this.elevatedStructures.upload(F)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(F,el,eh,ec,ep,e_=[],eg,ey){let eb=$c(el,500);"none"!==this.elevationMode?this.addElevatedRoadFeature(F,eb,ec,eh,ey):this.addGeometry(eb,this.bufferData),this.bufferData.populatePaintArrays(F,eh,ep,e_,ec,eg),this.elevationBufferData.populatePaintArrays(F,eh,ep,e_,ec,eg)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(F){this.elevatedStructures&&this.elevatedStructures.construct(F)}addElevatedRoadFeature(F,el,eh,ec,ep){let e_=[],eg=this.getElevationFeature(F,ep);if(eg){for(let ep of(e_.push({polygons:el,elevationFeature:eg,elevationTileID:eh}),e_))if(ep.elevationFeature){if("hd-road-base"===this.elevationMode){this.elevatedStructures||(this.elevatedStructures=new vh(ep.elevationTileID));let el=ep.elevationFeature.isTunnel(),eh=0;for(let ec of(F.properties.hasOwnProperty(av)&&(eh=+F.properties[av]),ep.polygons))this.elevatedStructures.addPortalCandidates(ep.elevationFeature.id,ec,el,ep.elevationFeature,eh)}let el=new mh(eh,ep.elevationTileID);this.addElevatedGeometry(ep.polygons,el,ep.elevationFeature,"hd-road-base"===this.elevationMode?0:.05,ec)}}else this.addGeometry(el,this.bufferData)}addElevatedGeometry(F,el,eh,ec,ep){let[e_,eg]=this.addGeometry(F,this.elevationBufferData,{elevation:eh,elevationSampler:el,bias:ec,index:ep});null==this.elevationBufferData.heightRange?this.elevationBufferData.heightRange={min:e_,max:eg}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,e_),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,eg))}addGeometry(F,el,eh){let ec=Number.POSITIVE_INFINITY,ep=Number.NEGATIVE_INFINITY,e_=null;eh&&null!=(e_=eh.elevationSampler.constantElevation(eh.elevation,eh.bias))&&(ec=e_,ep=e_);let a=(F,eg,ey)=>{if(null!=eh){if(eg.push(F),null!=e_)el.elevatedLayoutVertexArray.emplaceBack(e_),ey.push(e_);else{let e_=eh.elevationSampler.pointElevation(F,eh.elevation,eh.bias);el.elevatedLayoutVertexArray.emplaceBack(e_),ey.push(e_),ec=Math.min(ec,e_),ep=Math.max(ep,e_)}}};for(let ec of F){let F=0;for(let el of ec)F+=el.length;let ep=el.triangleSegments.prepareSegment(F,el.layoutVertexArray,el.indexArray),e_=ep.vertexLength,eg=[],ey=[],eb=[],ew=[],eT=[],eS=el.layoutVertexArray.length;for(let F of ec){if(0===F.length)continue;F!==ec[0]&&ey.push(eg.length/2);let ep=el.lineSegments.prepareSegment(F.length,el.layoutVertexArray,el.lineIndexArray),e_=ep.vertexLength;eh&&eT.push(el.layoutVertexArray.length-eS),a(F[0],eb,ew),el.layoutVertexArray.emplaceBack(F[0].x,F[0].y),el.lineIndexArray.emplaceBack(e_+F.length-1,e_),eg.push(F[0].x),eg.push(F[0].y);for(let eh=1;eh<F.length;eh++)a(F[eh],eb,ew),el.layoutVertexArray.emplaceBack(F[eh].x,F[eh].y),el.lineIndexArray.emplaceBack(e_+eh-1,e_+eh),eg.push(F[eh].x),eg.push(F[eh].y);ep.vertexLength+=F.length,ep.primitiveLength+=F.length}let eE=vc(eg,ey);for(let F=0;F<eE.length;F+=3)el.indexArray.emplaceBack(e_+eE[F],e_+eE[F+1],e_+eE[F+2]);if(eh&&"hd-road-base"===this.elevationMode){let F=eh.elevation.isTunnel(),el=eh.elevation.safeArea,ec=this.elevatedStructures.addVertices(eb,ew);this.elevatedStructures.addTriangles(eE,ec,F);let ep=eT.length;if(ep>0){for(let e_=0;e_<ep-1;e_++)this.elevatedStructures.addRenderableRing(eh.index,eT[e_]+ec,eT[e_+1]-eT[e_],F,el);this.elevatedStructures.addRenderableRing(eh.index,eT[ep-1]+ec,eb.length-eT[ep-1],F,el)}}ep.vertexLength+=F,ep.primitiveLength+=eE.length/3}return[ec,ep]}getElevationFeature(F,el){if(!el)return;let eh=+F.properties[a_];return null!=eh?el.find(F=>F.id===eh):void 0}};us(_h,"FillBucket",{omit:["layers","patternFeatures"]}),us(bh,"FillBufferData"),us(vh,"ElevatedStructures");let Sh=class Sh{constructor(F,el,eh,ec){if(this.triangleCount=el.length/3,this.min=new tU(0,0),this.max=new tU(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===F.length)return;let[ep,e_]=[F[0].clone(),F[0].clone()];for(let el=1;el<F.length;++el){let eh=F[el];ep.x=Math.min(ep.x,eh.x),ep.y=Math.min(ep.y,eh.y),e_.x=Math.max(e_.x,eh.x),e_.y=Math.max(e_.y,eh.y)}if(ec){let F=Math.ceil(Math.max(e_.x-ep.x,e_.y-ep.y)/ec);eh=Math.max(eh,F)}if(0===eh)return;this.min=ep,this.max=e_;let eg=this.max.sub(this.min);eg.x=Math.max(eg.x,1),eg.y=Math.max(eg.y,1);let ey=Math.max(eg.x,eg.y)/eh;this.cellsX=Math.max(1,Math.ceil(eg.x/ey)),this.cellsY=Math.max(1,Math.ceil(eg.y/ey)),this.xScale=1/ey,this.yScale=1/ey;let eb=[];for(let eh=0;eh<this.triangleCount;eh++){let ec=F[el[3*eh+0]].sub(this.min),ep=F[el[3*eh+1]].sub(this.min),e_=F[el[3*eh+2]].sub(this.min),eg=Ph(Math.floor(Math.min(ec.x,ep.x,e_.x)),this.xScale,this.cellsX),ew=Ph(Math.floor(Math.max(ec.x,ep.x,e_.x)),this.xScale,this.cellsX),eT=Ph(Math.floor(Math.min(ec.y,ep.y,e_.y)),this.yScale,this.cellsY),eS=Ph(Math.floor(Math.max(ec.y,ep.y,e_.y)),this.yScale,this.cellsY),eE=new tU(0,0),eM=new tU(0,0),eI=new tU(0,0),eA=new tU(0,0);for(let F=eT;F<=eS;++F){eE.y=eM.y=F*ey,eI.y=eA.y=(F+1)*ey;for(let el=eg;el<=ew;++el)eE.x=eI.x=el*ey,eM.x=eA.x=(el+1)*ey,(Kl(ec,ep,e_,eE,eM,eA)||Kl(ec,ep,e_,eE,eA,eI))&&eb.push({cellIdx:F*this.cellsX+el,triIdx:eh})}}if(0===eb.length)return;eb.sort((F,el)=>F.cellIdx-el.cellIdx||F.triIdx-el.triIdx);let ew=0;for(;ew<eb.length;){let F=eb[ew].cellIdx,el={start:this.payload.length,len:0};for(;ew<eb.length&&eb[ew].cellIdx===F;)++el.len,this.payload.push(eb[ew++].triIdx);this.cells[F]=el}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(F,el){if(0===this.triangleCount||0===this.cells.length||F.x>this.max.x||this.min.x>F.x||F.y>this.max.y||this.min.y>F.y)return;let eh=Ph(F.x-this.min.x,this.xScale,this.cellsX),ec=Ph(F.y-this.min.y,this.yScale,this.cellsY),ep=this.cells[ec*this.cellsX+eh];if(ep){this._lazyInitLookup();for(let F=0;F<ep.len;F++){let eh=this.payload[ep.start+F],ec=Math.floor(eh/8),e_=1<<eh%8;if(!(this.lookup[ec]&e_)&&(this.lookup[ec]|=e_,el.push(eh),el.length===this.triangleCount))return}}}query(F,el,eh){if(0===this.triangleCount||0===this.cells.length||F.x>this.max.x||this.min.x>el.x||F.y>this.max.y||this.min.y>el.y)return;this._lazyInitLookup();let ec=Ph(F.x-this.min.x,this.xScale,this.cellsX),ep=Ph(el.x-this.min.x,this.xScale,this.cellsX),e_=Ph(F.y-this.min.y,this.yScale,this.cellsY),eg=Ph(el.y-this.min.y,this.yScale,this.cellsY);for(let F=e_;F<=eg;F++)for(let el=ec;el<=ep;el++){let ec=this.cells[F*this.cellsX+el];if(ec)for(let F=0;F<ec.len;F++){let el=this.payload[ec.start+F],ep=Math.floor(el/8),e_=1<<el%8;if(!(this.lookup[ep]&e_)&&(this.lookup[ep]|=e_,eh.push(el),eh.length===this.triangleCount))return}}}};function Ph(F,el,eh){return Math.max(0,Math.min(eh-1,Math.floor(F*el)))}us(Sh,"TriangleGridIndex");let Eh=class Eh{constructor(F){this.zoom=F.zoom,this.layers=F.layers,this.layerIds=this.layers.map(F=>F.fqid),this.index=F.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.footprints=[]}updateFootprints(F,el){for(let eh of this.footprints)el.push({footprint:eh,id:F})}populate(F,el,eh,ec){let ep=[];for(let{feature:el,id:e_,index:eg,sourceLayerIndex:ey}of F){let F=this.layers[0]._featureFilter.needGeometry,eb=Cl(el,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),eb,eh))continue;let ew={id:e_,properties:el.properties,type:el.type,sourceLayerIndex:ey,index:eg,geometry:F?eb.geometry:Vl(el,eh,ec),patterns:{}};ep.push(ew)}for(let ec of ep){let{geometry:ep,index:e_,sourceLayerIndex:eg}=ec;this.addFeature(ec,ep,e_,eh,{},el.availableImages,el.brightness),el.featureIndex.insert(F[e_].feature,ep,e_,eg,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(F){}update(F,el,eh,ec,ep,e_,eg){}destroy(){}addFeature(F,el,eh,ec,ep,e_=[],eg){for(let F of $c(el,2)){let el=[],eh=[],ec=[],ep=new tU(1/0,1/0),e_=new tU(-1/0,-1/0);for(let eg of F)if(0!==eg.length){eg!==F[0]&&ec.push(eh.length/2);for(let F=0;F<eg.length;F++)eh.push(eg[F].x),eh.push(eg[F].y),el.push(eg[F]),ep.x=Math.min(ep.x,eg[F].x),ep.y=Math.min(ep.y,eg[F].y),e_.x=Math.max(e_.x,eg[F].x),e_.y=Math.max(e_.y,eg[F].y)}let eg=vc(eh,ec),ey=new Sh(el,eg,8,256);this.footprints.push({vertices:el,indices:eg,grid:ey,min:ep,max:e_})}}};us(Eh,"ClipBucket",{omit:["layers"]});let aT=va([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),aS=va([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),aE=va([{name:"a_centroid_pos",components:2,type:"Uint16"}]),aM=va([{name:"a_join_normal_inside",components:3,type:"Int16"}]),aI=va([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),aA=va([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:aC}=aT;let Rh=class Rh extends tU{constructor(F,el,eh){super(F,el),this.z=eh}};let Lh=class Lh extends Rh{constructor(F,el,eh,ec){super(F,el,eh),this.w=ec}};function Fh(F,el,eh,ec){let ep=[],e_=0===ec?(F,el,eh,ec,ep,e_)=>{F.push(new tU(e_,eh+(e_-el)/(ec-el)*(ep-eh)))}:(F,el,eh,ec,ep,e_)=>{F.push(new tU(el+(e_-eh)/(ep-eh)*(ec-el),e_))};for(let eg of F){let F=[];for(let ep of eg){if(ep.length<=2)continue;let eg=[];for(let F=0;F<ep.length-1;F++){let ey=ep[F].x,eb=ep[F].y,ew=ep[F+1].x,eT=ep[F+1].y,eS=0===ec?ey:eb,eE=0===ec?ew:eT;eS<el?eE>el&&e_(eg,ey,eb,ew,eT,el):eS>eh?eE<eh&&e_(eg,ey,eb,ew,eT,eh):eg.push(ep[F]),eE<el&&eS>=el&&e_(eg,ey,eb,ew,eT,el),eE>eh&&eS<=eh&&e_(eg,ey,eb,ew,eT,eh)}let ey=ep[ep.length-1],eb=0===ec?ey.x:ey.y;eb>=el&&eb<=eh&&eg.push(ey),eg.length&&(ey=eg[eg.length-1],eg[0].x===ey.x&&eg[0].y===ey.y||eg.push(eg[0]),F.push(eg))}F.length&&ep.push(F)}return ep}function Oh(F,el,eh,ec){let ep="x"===eh?"y":"x",e_=(ec-F[eh])/(el[eh]-F[eh]);F[ep]=F[ep]+(el[ep]-F[ep])*e_,F[eh]=ec,F.hasOwnProperty("z")&&(F.z=Ee(F.z,el.z,e_)),F.hasOwnProperty("w")&&(F.w=Ee(F.w,el.w,e_))}function Nh(F,el,eh,ec){for(let ep of["x","y"]){let e_=F,eg=el;e_[ep]>=eg[ep]&&(e_=el,eg=F),e_[ep]<eh&&eg[ep]>eh&&Oh(e_,eg,ep,eh),e_[ep]<ec&&eg[ep]>ec&&Oh(eg,e_,ep,ec)}}let aP=Number.MAX_SAFE_INTEGER;function jh(F,el,eh,ec){var ep;return F.order<el||F.order===aP||!(F.clipMask&eh)||0!==(ep=F.clipScope).length&&void 0===ep.find(F=>F===ec)}function qh(F,el){return F.x-el.x||F.y-el.y}function $h(F,el){return 0===qh(F.min,el.min)&&0===qh(F.max,el.max)}function Gh(F,el){return!(F.min.x>el.max.x||F.max.x<el.min.x||F.min.y>el.max.y||F.max.y<el.min.y)}function Yh(F,el){if(F.length!==el.length)return!1;for(let eh=0;eh<F.length;eh++)if(F[eh].sourceId!==el[eh].sourceId||!$h(F[eh],el[eh])||F[eh].order!==el[eh].order||F[eh].clipMask!==el[eh].clipMask||!$(F[eh].clipScope,el[eh].clipScope))return!1;return!0}function Hh(F,el,eh){let ec=1/(1<<eh.canonical.z),ep=(1220703125e-13*el.x+eh.canonical.x)*ec+eh.wrap,e_=(1220703125e-13*el.y+eh.canonical.y)*ec;return{min:new tU((1220703125e-13*F.x+eh.canonical.x)*ec+eh.wrap,(1220703125e-13*F.y+eh.canonical.y)*ec),max:new tU(ep,e_)}}function Zh(F,el,eh,ec,ep,e_,eg){let ey=F.indices,eb=F.vertices,ew=[];for(let eT=ec;eT<ec+ep;eT+=3){let ec=el[eh[eT+0]+e_],ep=el[eh[eT+1]+e_],eS=el[eh[eT+2]+e_],eE=Math.min(ec.x,ep.x,eS.x),eM=Math.max(ec.x,ep.x,eS.x),eI=Math.min(ec.y,ep.y,eS.y),eA=Math.max(ec.y,ep.y,eS.y);ew.length=0,F.grid.query(new tU(eE,eI),new tU(eM,eA),ew);for(let F=0;F<ew.length;F++){let el=ew[F];if(Kl(eb[ey[3*el+0]],eb[ey[3*el+1]],eb[ey[3*el+2]],ec,ep,eS,eg))return!0}}return!1}function Kh(F,el,eh,ec){let ep=Math.pow(2,ec.z-eh.z);return new tU((F+8192*eh.x)*ep-8192*ec.x,(el+8192*eh.y)*ep-8192*ec.y)}function Jh(F,el){let eh=[];el.grid.queryPoint(F,eh);let ec=el.indices,ep=el.vertices;for(let el=0;el<eh.length;el++){let e_=eh[el];if(Hl([ep[ec[3*e_+0]],ep[ec[3*e_+1]],ep[ec[3*e_+2]]],F))return!0}return!1}let az=[new tU(0,0),new tU(8192,0),new tU(8192,8192),new tU(0,8192)];function tp(F,el){let eh=[],ec=[];if(!el||F.length<2)return[F];if(2===F.length)return Zl(F[0],F[1],az)?[F]:[];for(let el=0;el<F.length+2;el++){let ep=F[el%F.length],e_=F[(el+1)%F.length],eg=Zl(0===el?F[F.length-1]:F[(el-1)%F.length],ep,az),ey=Zl(ep,e_,az),eb=eg||ey;eb&&ec.push(ep),eb&&ey||ec.length>0&&(ec.length>1&&eh.push(ec),ec=[])}return ec.length>1&&eh.push(ec),eh}let aD=am.VectorTileFeature.types,aR=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],aL=["fill-extrusion-flood-light-ground-radius"],aO=new tU(0,1);function lp(F,el,eh,ec,ep,e_,eg,ey){F.emplaceBack((el<<1)+eg,(eh<<1)+e_,(Math.floor(8192*ec)<<1)+ep,Math.round(ey))}function up(F,el,eh){F.emplaceBack(8192*el.x,8192*el.y,eh?1:0)}function cp(F,el,eh,ec,ep,e_){F.emplaceBack(el.x,el.y,(eh.x<<1)+ec,(eh.y<<1)+ep,e_)}function hp(F,el,eh){F.emplaceBack(el.x,el.y,el.z,16384*eh[0],16384*eh[1],16384*eh[2])}let pp=class pp{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}};let fp=class fp{constructor(){this.centroidXY=new tU(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new tU(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new tU(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new tU(this.max.x-this.min.x,this.max.y-this.min.y)}};let dp=class dp{constructor(){this.acc=new tU(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(F,el){F.min.x===Number.MAX_VALUE&&(F.min.x=F.max.x=el.x,F.min.y=F.max.y=el.y)}appendEdge(F,el,eh){this.accCount++,this.acc._add(el);let ec=!!this.borders;el.x<F.min.x?(F.min.x=el.x,ec=!0):el.x>F.max.x&&(F.max.x=el.x,ec=!0),el.y<F.min.y?(F.min.y=el.y,ec=!0):el.y>F.max.y&&(F.max.y=el.y,ec=!0),((0===el.x||8192===el.x)&&el.x===eh.x)!=((0===el.y||8192===el.y)&&el.y===eh.y)&&this.processBorderOverlap(el,eh),ec&&this.checkBorderIntersection(el,eh)}checkBorderIntersection(F,el){el.x<0!=F.x<0&&this.addBorderIntersection(0,Ee(el.y,F.y,(0-el.x)/(F.x-el.x))),el.x>8192!=F.x>8192&&this.addBorderIntersection(1,Ee(el.y,F.y,(8192-el.x)/(F.x-el.x))),el.y<0!=F.y<0&&this.addBorderIntersection(2,Ee(el.x,F.x,(0-el.y)/(F.y-el.y))),el.y>8192!=F.y>8192&&this.addBorderIntersection(3,Ee(el.x,F.x,(8192-el.y)/(F.y-el.y)))}addBorderIntersection(F,el){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);let eh=this.borders[F];el<eh[0]&&(eh[0]=el),el>eh[1]&&(eh[1]=el)}processBorderOverlap(F,el){if(F.x===el.x){if(F.y===el.y)return;let eh=0===F.x?0:1;this.addBorderIntersection(eh,el.y),this.addBorderIntersection(eh,F.y)}else{let eh=0===F.y?2:3;this.addBorderIntersection(eh,el.x),this.addBorderIntersection(eh,F.x)}}centroid(){return 0===this.accCount?new tU(0,0):new tU(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((F,el)=>F+ +(el[0]!==Number.MAX_VALUE),0):0}};function mp(F,el){let eh=F.add(el)._unit(),ec=Q(F.x*eh.x+F.y*eh.y,-1,1);return Math.min(4,Math.max(-4,Math.tan(Math.acos(ec))))/4*32767*(F.x*el.y-F.y*el.x<0?-1:1)}let ak=[F=>F.x<0,F=>F.x>8192,F=>F.y<0,F=>F.y>8192];let xp=class xp{constructor(F){this.vertexArray=new Pa,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut},F=>aL.includes(F)),this._segments=new xo,this.hiddenByLandmarkVertexArray=new eo,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new xo}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(F,el,eh,ec=!1){let ep=F.length;if(ep>2){let e_,eg=Math.max(0,this._segments.get().length-1),ey=this._segments._prepareSegment(4*ep,this.vertexArray.length,2*this._segmentToGroundQuads[eg].length);eg!==this._segments.get().length-1&&(eg++,this._segmentToGroundQuads[eg]=[],this._segmentToRegionTriCounts[eg]=[0,0,0,0,0]);{let el=F[0],eh=F[1];e_=mp(el.sub(F[ep-1])._perp()._unit(),eh.sub(el)._perp()._unit())}for(let eb=0;eb<ep;eb++){let ew=eb===ep-1?0:eb+1,eT=F[eb],eS=F[ew],eE=F[ew===ep-1?0:ew+1],eM=eS.sub(eT)._perp()._unit(),eI=mp(eM,eE.sub(eS)._perp()._unit()),eA=e_;if(Mp(eT,eS,el)||ec&&Ap(eT,el)&&Ap(eS,el)){e_=eI;continue}let eC=ey.vertexLength;cp(this.vertexArray,eT,eS,1,1,eA),cp(this.vertexArray,eT,eS,1,0,eA),cp(this.vertexArray,eT,eS,0,1,eI),cp(this.vertexArray,eT,eS,0,0,eI),ey.vertexLength+=4;let eP=function(F,el,eh,ec){let ep=[4];if(0===ec)return ep;eh._mult(ec);let e_=F.sub(eh),eg=el.sub(eh),ey=[F,el,e_,eg];for(let F=0;F<4;F++)for(let el of ey)if(ak[F](el)){ep.push(F);break}return ep}(eT,eS,eM,eh);for(let F of eP)this._segmentToGroundQuads[eg].push({id:eC,region:F}),this._segmentToRegionTriCounts[eg][F]+=2,ey.primitiveLength+=2;e_=eI}}}prepareBorderSegments(){if(!this.hasData())return;let F=this._segments.get(),el=F.length;for(let F=0;F<el;F++)this._segmentToGroundQuads[F].sort((F,el)=>F.region-el.region);for(let eh=0;eh<el;eh++){let el=this._segmentToGroundQuads[eh],ec=F[eh],ep=this._segmentToRegionTriCounts[eh];ep.reduce((F,el)=>F+el,0);let e_=0;for(let F=0;F<=4;F++){let el=ep[F];if(0!==el){let eh=this.regionSegments[F];eh||(eh=this.regionSegments[F]=new xo);let ep={vertexOffset:ec.vertexOffset,primitiveOffset:ec.primitiveOffset+e_,vertexLength:ec.vertexLength,primitiveLength:el};eh.get().push(ep)}e_+=el}for(let F=0;F<el.length;F++){let eh=el[F].id;this.indexArray.emplaceBack(eh,eh+1,eh+3),this.indexArray.emplaceBack(eh,eh+3,eh+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(F,el,eh,ec,ep,e_){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,F,el,eh,ec,ep,e_)}upload(F){this.hasData()&&(this.vertexBuffer=F.createVertexBuffer(this.vertexArray,aS.members),this.indexBuffer=F.createIndexBuffer(this.indexArray))}uploadPaintProperties(F){this.hasData()&&this.programConfigurations.upload(F)}update(F,el,eh,ec,ep,e_,eg){this.hasData()&&this.programConfigurations.updatePaintArrays(F,el,eh,ec,ep,e_,eg)}updateHiddenByLandmark(F){if(!this.hasData())return;let el=F.groundVertexCount+F.groundVertexArrayOffset;if(0===F.groundVertexCount)return;let eh=2147483648&F.flags?1:0;for(let ec=F.groundVertexArrayOffset;ec<el;++ec)this.hiddenByLandmarkVertexArray.emplace(ec,eh);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(F){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=F.createVertexBuffer(this.hiddenByLandmarkVertexArray,aI.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let F=0;F<=4;F++){let el=this.regionSegments[F];el&&el.destroy()}}}};let vp=class vp{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.overscaling=F.overscaling,this.layers=F.layers,this.pixelRatio=F.pixelRatio,this.layerIds=this.layers.map(F=>F.fqid),this.index=F.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=F.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new ja,this.footprintVertices=new _a,this.footprintSegments=[],this.layoutVertexArray=new Ma,this.centroidVertexArray=new po,this.wallVertexArray=new mo,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut},F=>aR.includes(F)),this.segments=new xo,this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.groundEffect=new xp(F),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(F,el){}populate(F,el,eh,ec){for(let{feature:ep,id:e_,index:eg,sourceLayerIndex:ey}of(this.features=[],this.hasPattern=Hc("fill-extrusion",this.layers,this.pixelRatio,el),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=Al(eh),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1),F)){let F=this.layers[0]._featureFilter.needGeometry,eb=Cl(ep,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),eb,eh))continue;let ew={id:e_,sourceLayerIndex:ey,index:eg,geometry:F?eb.geometry:Vl(ep,eh,ec),properties:ep.properties,type:ep.type,patterns:{}},eT=this.layoutVertexArray.length,eS="Polygon"===aD[ew.type];if(this.hasPattern)this.features.push(Xc("fill-extrusion",this.layers,ew,this.zoom,this.pixelRatio,el));else if(this.wallMode)for(let F of ew.geometry)for(let ep of tp(F,eS))this.addFeature(ew,[ep],eg,eh,{},el.availableImages,ec,el.brightness);else this.addFeature(ew,ew.geometry,eg,eh,{},el.availableImages,ec,el.brightness);el.featureIndex.insert(ep,ew.geometry,eg,ey,this.index,eT)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(F,el,eh,ec,ep,e_){for(let F of this.features){let eg="Polygon"===aD[F.type],{geometry:ey}=F;if(this.wallMode)for(let eb of ey)for(let ey of tp(eb,eg))this.addFeature(F,[ey],F.index,el,eh,ec,ep,e_);else this.addFeature(F,ey,F.index,el,eh,ec,ep,e_)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(F,el,eh,ec,ep,e_,eg){this.programConfigurations.updatePaintArrays(F,el,ep,eh,ec,e_,eg),this.groundEffect.update(F,el,ep,eh,ec,e_,eg)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(F){this.uploaded||(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,aC),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.wallVertexBuffer=F.createVertexBuffer(this.wallVertexArray,aM.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=F.createVertexBuffer(this.layoutVertexExtArray,aA.members,!0)),this.groundEffect.upload(F)),this.groundEffect.uploadPaintProperties(F),this.programConfigurations.upload(F),this.uploaded=!0}uploadCentroid(F){this.groundEffect.uploadHiddenByLandmark(F),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=F.createVertexBuffer(this.centroidVertexArray,aE.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(F,el,eh,ec,ep,e_,eg,ey){var eb;let ew,eT;let eS=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(F,{})/this.tileToMeter,eE=[new tU(0,0),new tU(8192,8192)],eM=eg.projection,eI="globe"===eM.name,eA=this.wallMode||"Polygon"===aD[F.type],eC=new dp;eC.centroidDataIndex=this.centroidData.length;let eP=new fp,ez=0>=this.layers[0].paint.get("fill-extrusion-base").evaluate(F,{},ec),eD=this.layers[0].paint.get("fill-extrusion-height").evaluate(F,{},ec);if(eP.height=eD,eP.vertexArrayOffset=this.layoutVertexArray.length,eP.groundVertexArrayOffset=this.groundEffect.vertexArray.length,eI&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Ba),this.wallMode){if(eI)return void pt("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==el.length)return;el=[(ew=function(F){let el=F[0].x===F[F.length-1].x&&F[0].y===F[F.length-1].y,eh=function(F){let el=0,eh=F.length;for(let ec=0;ec<eh;ec++)el+=(F[(ec+1)%eh].x-F[ec].x)*(F[(ec+1)%eh].y+F[ec].y);return el>=0}(F);eh||(F=F.reverse());let ec={geometry:[],joinNormals:[],indices:[]},ep=[],e_=[],eg=[],ey=F.length;for(;ey>=2&&F[ey-1].equals(F[ey-2]);)ey--;if(ey<(el?3:2))return ec;let eb,ew,eT,eS,eE,eM=0;for(;eM<ey-1&&F[eM].equals(F[eM+1]);)eM++;el&&(eb=F[ey-2],eE=F[eM].sub(eb)._unit()._perp());for(let eh=eM;eh<ey;eh++){if((eT=eh===ey-1?el?F[eM+1]:void 0:F[eh+1])&&F[eh].equals(eT))continue;eE&&(eS=eE),eb&&(ew=eb),eb=F[eh],eE=eT?eT.sub(eb)._unit()._perp():eS;let ec=(eS=eS||eE).add(eE);0===ec.x&&0===ec.y||ec._unit();let eI=ec.x*eE.x+ec.y*eE.y,eA=0!==eI?1/eI:1/0,eC=eS.x*eE.y-eS.y*eE.x>0,eP="miter";"miter"===eP&&eA>2&&(eP="bevel"),"bevel"===eP&&(eA>100&&(eP="flipbevel"),eA<2&&(eP="miter"));let v=(F,el,eh,ec)=>{let ey=new tU(F.x,F.y),eb=new tU(F.x,F.y);ey.x+=el.x*ec,ey.y+=el.y*ec,eb.x-=el.x*Math.max(eh,1),eb.y-=el.y*Math.max(eh,1),eg.push(el),ep.push(ey),e_.push(eb)};if("miter"===eP)ec._mult(eA),v(eb,ec,0,0);else if("flipbevel"===eP)v(eb,ec=eE.mult(-1),0,0),v(eb,ec.mult(-1),0,0);else{let F=-Math.sqrt(eA*eA-1),el=eC?F:0,eh=eC?0:F;ew&&v(eb,eS,el,eh),eT&&v(eb,eE,el,eh)}}ec.geometry=[...ep,...e_.reverse(),ep[0]],ec.joinNormals=[...eg,...eg.reverse(),eg[eg.length-1]];let eI=ec.geometry.length-1;for(let F=0;F<eI/2;F++)if(F+1<eI/2){let el=F,eh=F+1,ep=eI-1-F,e_=eI-2-F;el=0===el?eI-1:el-1,eh=0===eh?eI-1:eh-1,ep=0===ep?eI-1:ep-1,e_=0===e_?eI-1:e_-1,ec.indices.push(ep),ec.indices.push(eh),ec.indices.push(el),ec.indices.push(ep),ec.indices.push(e_),ec.indices.push(eh)}return ec}(el[0])).geometry]}let x=(F,el)=>F<(el.length-1)/2||F===el.length-1,eR=this.wallMode?[el]:$c(el,500);for(let F=eR.length-1;F>=0;F--){let el=eR[F];(0===el.length||(eb=el[0]).every(F=>F.x<=0)||eb.every(F=>F.x>=8192)||eb.every(F=>F.y<=0)||eb.every(F=>F.y>=8192))&&eR.splice(F,1)}if(eI)eT=Ep(eR,eE,ec);else for(let F of(eT=[],eR))eT.push({polygon:F,bounds:eE});let eL=eA?this.edgeRadius:0,eO=eL>0&&this.zoom<17,A=(F,el)=>{if(0===F.length)return!1;let eh=F[F.length-1];return el.x===eh.x&&el.y===eh.y};for(let{polygon:F,bounds:el}of eT){let eh=0,ep=0;for(let el of F)eA&&!el[0].equals(el[el.length-1])&&el.push(el[0]),ep+=eA?el.length-1:el.length;let e_=this.segments.prepareSegment((eA?5:4)*ep,this.layoutVertexArray,this.indexArray);eP.footprintSegIdx<0&&(eP.footprintSegIdx=this.footprintSegments.length),eP.polygonSegIdx<0&&(eP.polygonSegIdx=this.polygonSegments.length);let eg={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},ey=new pp;if(ey.vertexOffset=this.footprintVertices.length,ey.indexOffset=3*this.footprintIndices.length,ey.ringIndices=[],eA){let ep=[],eg=[];eh=e_.vertexLength;for(let eh=0;eh<F.length;eh++){let eb,eT;let eE=F[eh];eE.length&&0!==eh&&eg.push(ep.length/2);let eA=[];eb=eE[1].sub(eE[0])._perp()._unit(),ey.ringIndices.push(eE.length-1);for(let F=1;F<eE.length;F++){let el=eE[F],eh=eE[F===eE.length-1?1:F+1],eg=el.clone();if(eL){eT=eh.sub(el)._perp()._unit();let F=eb.add(eT)._unit(),ec=eL*Math.min(4,1/(eb.x*F.x+eb.y*F.y));eg.x+=ec*F.x,eg.y+=ec*F.y,eg.x=Math.round(eg.x),eg.y=Math.round(eg.y),eb=eT}if(!ez||0!==eL&&!eO||A(eA,eg)||eA.push(eg),lp(this.layoutVertexArray,eg.x,eg.y,0,0,1,1,0),this.wallMode){let el=x(F,eE);up(this.wallVertexArray,ew.joinNormals[F],!el)}e_.vertexLength++,this.footprintVertices.emplaceBack(el.x,el.y),ep.push(el.x,el.y),eI&&hp(this.layoutVertexExtArray,eM.projectTilePoint(eg.x,eg.y,ec),eM.upVector(ec,eg.x,eg.y))}ez&&(0===eL||eO)&&(0!==eA.length&&A(eA,eA[0])&&eA.pop(),this.groundEffect.addData(eA,el,eS))}let eb=this.wallMode?ew.indices:vc(ep,eg);for(let F=0;F<eb.length;F+=3)this.footprintIndices.emplaceBack(ey.vertexOffset+eb[F+0],ey.vertexOffset+eb[F+1],ey.vertexOffset+eb[F+2]),this.indexArray.emplaceBack(eh+eb[F],eh+eb[F+2],eh+eb[F+1]),e_.primitiveLength++;ey.indexCount+=eb.length,ey.vertexCount+=this.footprintVertices.length-ey.vertexOffset}for(let ep=0;ep<F.length;ep++){let eg,ey,eb;let eT=F[ep];eC.startRing(eP,eT[0]);let eE=eT.length>4&&Ip(eT[eT.length-2],eT[0],eT[1]),eD=eL?function(F,el,eh,ec){let ep=el.sub(F)._perp()._unit(),e_=eh.sub(el)._perp()._unit();return wp(F,el,eh,bp(ep,e_),ec)}(eT[eT.length-2],eT[0],eT[1],eL):0,eR=[];ey=eT[1].sub(eT[0])._perp()._unit();let eO=!0;for(let F=1,ep=0;F<eT.length;F++){let eS=eT[F-1],eA=eT[F],ek=eT[F===eT.length-1?1:F+1];if(eC.appendEdge(eP,eA,eS),Mp(eA,eS,el)){eL&&(ey=ek.sub(eA)._perp()._unit(),eO=!eO);continue}let eF=eA.sub(eS)._perp(),eB=eF.x/(Math.abs(eF.x)+Math.abs(eF.y)),eN=eF.y>0?1:0,eV=eS.dist(eA);if(ep+eV>32768&&(ep=0),eL){eb=ek.sub(eA)._perp()._unit();let F=wp(eS,eA,ek,bp(ey,eb),eL);isNaN(F)&&(F=0);let el=eA.sub(eS)._unit();eS=eS.add(el.mult(eD))._round(),eA=eA.add(el.mult(-F))._round(),eD=F,ey=eb,ez&&this.zoom>=17&&(A(eR,eS)||eR.push(eS),A(eR,eA)||eR.push(eA))}let eU=e_.vertexLength,ej=eT.length>4&&Ip(eS,eA,ek),eG=Sp(ep,eE,eO);if(lp(this.layoutVertexArray,eS.x,eS.y,eB,eN,0,0,eG),lp(this.layoutVertexArray,eS.x,eS.y,eB,eN,0,1,eG),this.wallMode){let el=x(F-1,eT),eh=ew.joinNormals[F-1];up(this.wallVertexArray,eh,el),up(this.wallVertexArray,eh,el)}if(ep+=eV,eG=Sp(ep,ej,!eO),eE=ej,lp(this.layoutVertexArray,eA.x,eA.y,eB,eN,0,0,eG),lp(this.layoutVertexArray,eA.x,eA.y,eB,eN,0,1,eG),this.wallMode){let el=x(F,eT),eh=ew.joinNormals[F];up(this.wallVertexArray,eh,el),up(this.wallVertexArray,eh,el)}if(e_.vertexLength+=4,this.indexArray.emplaceBack(eU+0,eU+1,eU+2),this.indexArray.emplaceBack(eU+1,eU+3,eU+2),e_.primitiveLength+=2,eL){let ec=eh+(1===F?eT.length-2:F-2),ep=1===F?eh:ec+1;if(this.indexArray.emplaceBack(eU+1,ec,eU+3),this.indexArray.emplaceBack(ec,ep,eU+3),e_.primitiveLength+=2,void 0===eg&&(eg=eU),!Mp(ek,eT[F],el)){let el=F===eT.length-1?eg:e_.vertexLength;this.indexArray.emplaceBack(eU+2,eU+3,el),this.indexArray.emplaceBack(eU+3,el+1,el),this.indexArray.emplaceBack(eU+3,ep,el+1),e_.primitiveLength+=3}eO=!eO}if(eI){let F=this.layoutVertexExtArray,el=eM.projectTilePoint(eS.x,eS.y,ec),eh=eM.projectTilePoint(eA.x,eA.y,ec),ep=eM.upVector(ec,eS.x,eS.y),e_=eM.upVector(ec,eA.x,eA.y);hp(F,el,ep),hp(F,el,ep),hp(F,eh,e_),hp(F,eh,e_)}}eA&&(eh+=eT.length-1),ez&&eL&&this.zoom>=17&&(0!==eR.length&&A(eR,eR[0])&&eR.pop(),this.groundEffect.addData(eR,el,eS,eL>0))}this.footprintSegments.push(ey),eg.triangleCount=this.indexArray.length-eg.triangleArrayOffset,this.polygonSegments.push(eg),++eP.footprintSegLen,++eP.polygonSegLen}if(eP.vertexCount=this.layoutVertexArray.length-eP.vertexArrayOffset,eP.groundVertexCount=this.groundEffect.vertexArray.length-eP.groundVertexArrayOffset,0!==eP.vertexCount){if(eP.centroidXY=eC.borders?aO:this.encodeCentroid(eC,eP),this.centroidData.push(eP),eC.borders){this.featuresOnBorder.push(eC);let F=this.featuresOnBorder.length-1;for(let el=0;el<eC.borders.length;el++)eC.borders[el][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[el].push(F)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,eh,ep,e_,ec,ey),this.groundEffect.addPaintPropertiesData(F,eh,ep,e_,ec,ey),this.maxHeight=Math.max(this.maxHeight,eD)}}sortBorders(){for(let F=0;F<this.borderFeatureIndices.length;F++)this.borderFeatureIndices[F].sort((el,eh)=>this.featuresOnBorder[el].borders[F][0]-this.featuresOnBorder[eh].borders[F][0])}splitToSubtiles(){let F=[];for(let el=0;el<this.centroidData.length;el++){let eh=this.centroidData[el],ec=+(eh.min.y+eh.max.y>8192),ep=2*ec+(+(eh.min.x+eh.max.x>8192)^ec);for(let ec=0;ec<eh.polygonSegLen;ec++){let e_=eh.polygonSegIdx+ec;F.push({centroidIdx:el,subtile:ep,polygonSegmentIdx:e_,triangleSegmentIdx:this.polygonSegments[e_].triangleSegIdx})}}let el=new ja;F.sort((F,el)=>F.triangleSegmentIdx===el.triangleSegmentIdx?F.subtile-el.subtile:F.triangleSegmentIdx-el.triangleSegmentIdx);let eh=0,ec=0,ep=0;for(let el of F){if(el.triangleSegmentIdx!==eh)break;ep++}let e_=F.length;for(;ec!==F.length;){eh=F[ec].triangleSegmentIdx;let eg=0,ey=ec,eb=ec;for(let el=ey;el<ep&&F[el].subtile===eg;el++)eb++;for(;ey!==ep;){let ec=F[ey];eg=ec.subtile;let e_=this.centroidData[ec.centroidIdx].min.clone(),ew=this.centroidData[ec.centroidIdx].max.clone(),eT={vertexOffset:this.segments.segments[eh].vertexOffset,primitiveOffset:el.length,vertexLength:this.segments.segments[eh].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let eh=ey;eh<eb;eh++){let ec=F[eh],ep=this.polygonSegments[ec.polygonSegmentIdx],eg=this.centroidData[ec.centroidIdx].min,ey=this.centroidData[ec.centroidIdx].max,eb=this.indexArray.uint16;for(let F=ep.triangleArrayOffset;F<ep.triangleArrayOffset+ep.triangleCount;F++)el.emplaceBack(eb[3*F],eb[3*F+1],eb[3*F+2]);eT.primitiveLength+=ep.triangleCount,e_.x=Math.min(e_.x,eg.x),e_.y=Math.min(e_.y,eg.y),ew.x=Math.max(ew.x,ey.x),ew.y=Math.max(ew.y,ey.y)}eT.primitiveLength>0&&this.triangleSubSegments.push({segment:eT,min:e_,max:ew}),ey=eb;for(let el=ey;el<ep&&F[el].subtile===F[ey].subtile;el++)eb++}ec=ep;for(let el=ec;el<e_&&F[el].triangleSegmentIdx===F[ec].triangleSegmentIdx;el++)ep++}el._trim(),this.indexArray=el}getVisibleSegments(F,el,eh){let ec;let ep=new xo;if(this.wallMode){for(let F of this.triangleSubSegments)ep.segments.push(F.segment);return ep}let e_=0,eg=0,ey=1<<F.canonical.z;if(el){let eh=el.getMinMaxForTile(F);eh&&(e_=eh.min,eg=eh.max)}eg+=this.maxHeight;let eb=F.toUnwrapped(),ew=[eb.canonical.x/ey+eb.wrap,eb.canonical.y/ey],eT=[(eb.canonical.x+1)/ey+eb.wrap,(eb.canonical.y+1)/ey],h=(F,el,eh)=>[F[0]*(1-eh[0])+el[0]*eh[0],F[1]*(1-eh[1])+el[1]*eh[1]],eS=[],eE=[];for(let F of this.triangleSubSegments){eS[0]=F.min.x/8192,eS[1]=F.min.y/8192,eE[0]=F.max.x/8192,eE[1]=F.max.y/8192;let el=h(ew,eT,eS),ey=h(ew,eT,eE);if(0===new Au([el[0],el[1],e_],[ey[0],ey[1],eg]).intersectsPrecise(eh)){ec&&(ep.segments.push(ec),ec=void 0);continue}let eb=F.segment;ec&&ec.vertexOffset!==eb.vertexOffset&&(ep.segments.push(ec),ec=void 0),ec?(ec.vertexLength+=eb.vertexLength,ec.primitiveLength+=eb.primitiveLength):ec={vertexOffset:eb.vertexOffset,primitiveLength:eb.primitiveLength,vertexLength:eb.vertexLength,primitiveOffset:eb.primitiveOffset,sortKey:void 0,vaos:{}}}return ec&&ep.segments.push(ec),ep}encodeCentroid(F,el){let eh=F.centroid(),ec=el.span(),ep=Math.min(7,Math.round(ec.x*this.tileToMeter/10)),e_=Math.min(7,Math.round(ec.y*this.tileToMeter/10));return new tU(Q(eh.x,1,8191)<<3|ep,Q(eh.y,1,8191)<<3|e_)}encodeBorderCentroid(F){if(!F.borders)return new tU(0,0);let el=F.borders,eh=Number.MAX_VALUE;if(el[0][0]!==eh||el[1][0]!==eh){let F=el[0][0]!==eh?0:1;return new tU(6|(el[0][0]!==eh?0:65528),(el[F][0]+el[F][1])/2<<3|6)}{let F=el[2][0]!==eh?2:3;return new tU((el[F][0]+el[F][1])/2<<3|6,6|(el[2][0]!==eh?0:65528))}}showCentroid(F){let el=this.centroidData[F.centroidDataIndex];el.flags&=2147483648,el.centroidXY.x=0,el.centroidXY.y=0,this.writeCentroidToBuffer(el)}writeCentroidToBuffer(F){this.groundEffect.updateHiddenByLandmark(F);let el=F.vertexArrayOffset,eh=F.vertexCount+F.vertexArrayOffset,ec=2147483648&F.flags?aO:F.centroidXY,ep=this.centroidVertexArray.geta_centroid_pos0(el);if(this.centroidVertexArray.geta_centroid_pos1(el)!==ec.y||ep!==ec.x){for(let F=el;F<eh;++F)this.centroidVertexArray.emplace(F,ec.x,ec.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){for(let F of(this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length),this.centroidData))this.writeCentroidToBuffer(F)}updateReplacement(F,el,eh){if(el.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=el.updateTime;let ec=el.getReplacementRegionsForTile(F.toUnwrapped());if(Yh(this.activeReplacements,ec))return;if(this.activeReplacements=ec,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(let F of this.centroidData)F.flags&=2147483647;let ep=[];for(let el of this.activeReplacements){if(el.order<eh)continue;let ec=Math.max(1,Math.pow(2,el.footprintTileId.canonical.z-F.canonical.z));for(let eh of this.centroidData)if(!(2147483648&eh.flags||el.min.x>eh.max.x||eh.min.x>el.max.x||el.min.y>eh.max.y||eh.min.y>el.max.y))for(let e_=0;e_<eh.footprintSegLen;e_++){let eg=this.footprintSegments[eh.footprintSegIdx+e_];if(ep.length=0,function(F,el,eh,ec,ep,e_){let eg=Math.pow(2,ec.z-ep.z);for(let ey=0;ey<eh;ey++){let eh=F.int16[2*(ey+el)+0],eb=F.int16[2*(ey+el)+1];eh=(eh+8192*ep.x)*eg-8192*ec.x,eb=(eb+8192*ep.y)*eg-8192*ec.y,e_.push(new tU(eh,eb))}}(this.footprintVertices,eg.vertexOffset,eg.vertexCount,el.footprintTileId.canonical,F.canonical,ep),Zh(el.footprint,ep,this.footprintIndices.uint16,eg.indexOffset,eg.indexCount,-eg.vertexOffset,-ec)){eh.flags|=2147483648;break}}}for(let F of this.centroidData)this.writeCentroidToBuffer(F);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(F,el,eh){let ec=!1;for(let ep=0;ep<eh.footprintSegLen;ep++){let e_=this.footprintSegments[eh.footprintSegIdx+ep],eg=0;for(let eh of e_.ringIndices){for(let ep=eg,ey=eh+eg-1;ep<eh+eg;ey=ep++){let eh=this.footprintVertices.int16[2*(ep+e_.vertexOffset)+0],eg=this.footprintVertices.int16[2*(ep+e_.vertexOffset)+1],eb=this.footprintVertices.int16[2*(ey+e_.vertexOffset)+1];eg>el!=eb>el&&F<(this.footprintVertices.int16[2*(ey+e_.vertexOffset)+0]-eh)*(el-eg)/(eb-eg)+eh&&(ec=!ec)}eg=eh}}return ec}getHeightAtTileCoord(F,el){let eh=Number.NEGATIVE_INFINITY,ec=!0,ep=4*(F+8192)*8192+(el+8192);if(this.partLookup.hasOwnProperty(ep)){let F=this.partLookup[ep];return F?{height:F.height,hidden:!!(2147483648&F.flags)}:void 0}for(let e_ of this.centroidData)F>e_.max.x||e_.min.x>F||el>e_.max.y||e_.min.y>el||this.footprintContainsPoint(F,el,e_)&&e_&&e_.height>eh&&(eh=e_.height,this.partLookup[ep]=e_,ec=!!(2147483648&e_.flags));if(eh!==Number.NEGATIVE_INFINITY)return{height:eh,hidden:ec};this.partLookup[ep]=void 0}};function bp(F,el){let eh=F.add(el)._unit();return F.x*eh.x+F.y*eh.y}function wp(F,el,eh,ec,ep){let e_=Math.sqrt(1-ec*ec);return Math.min(F.dist(el)/3,el.dist(eh)/3,ep*e_/ec)}function Mp(F,el,eh){return F.x<eh[0].x&&el.x<eh[0].x||F.x>eh[1].x&&el.x>eh[1].x||F.y<eh[0].y&&el.y<eh[0].y||F.y>eh[1].y&&el.y>eh[1].y}function Ap(F,el){return F.x<el[0].x||F.x>el[1].x||F.y<el[0].y||F.y>el[1].y}function Ip(F,el,eh){if(F.x<0||F.x>=8192||el.x<0||el.x>=8192||eh.x<0||eh.x>=8192)return!1;let ec=eh.sub(el),ep=ec.perp(),e_=F.sub(el);return(ec.x*e_.x+ec.y*e_.y)/Math.sqrt((ec.x*ec.x+ec.y*ec.y)*(e_.x*e_.x+e_.y*e_.y))>-.866&&ep.x*e_.x+ep.y*e_.y<0}function Sp(F,el,eh){let ec=el?2|F:-3&F;return eh?1|ec:-2&ec}function Pp(){let F=Math.PI/32,el=Math.tan(F);return 6371008.8*Math.sqrt(1+2*el*el)-6371008.8}function Ep(F,el,eh){let ec=1<<eh.z,ep=gl(eh.x/ec),e_=gl((eh.x+1)/ec),eg=xl(eh.y/ec),ey=xl((eh.y+1)/ec);return function(F,el,eh,ec,ep=0,e_){let eg=[];if(!F.length||!eh||!ec)return eg;let o=(F,el)=>{for(let eh of F)eg.push({polygon:eh,bounds:el})},ey=Math.ceil(Math.log2(eh)),eb=Math.ceil(Math.log2(ec)),ew=ey-eb,eT=[];for(let F=0;F<Math.abs(ew);F++)eT.push(ew>0?0:1);for(let F=0;F<Math.min(ey,eb);F++)eT.push(0),eT.push(1);let eS=F;if(eS=Fh(eS,el[0].y-ep,el[1].y+ep,1),!(eS=Fh(eS,el[0].x-ep,el[1].x+ep,0)).length)return eg;let eE=[];for(eT.length?eE.push({polygons:eS,bounds:el,depth:0}):o(eS,el);eE.length;){let F=eE.pop(),el=F.depth,eh=eT[el],ec=F.bounds[0],eg=F.bounds[1],ey=0===eh?ec.x:ec.y,eb=0===eh?eg.x:eg.y,ew=e_?e_(eh,ey,eb):.5*(ey+eb),eS=Fh(F.polygons,ey-ep,ew+ep,eh),eM=Fh(F.polygons,ew-ep,eb+ep,eh);if(eS.length){let F=[ec,new tU(0===eh?ew:eg.x,1===eh?ew:eg.y)];eT.length>el+1?eE.push({polygons:eS,bounds:F,depth:el+1}):o(eS,F)}if(eM.length){let F=[new tU(0===eh?ew:ec.x,1===eh?ew:ec.y),eg];eT.length>el+1?eE.push({polygons:eM,bounds:F,depth:el+1}):o(eM,F)}}return eg}(F,el,Math.ceil((e_-ep)/11.25),Math.ceil((eg-ey)/11.25),1,(F,el,ep)=>{if(0===F)return .5*(el+ep);{let F=xl((eh.y+el/8192)/ec);return(ml(.5*(xl((eh.y+ep/8192)/ec)+F))*ec-eh.y)*8192}})}function Bp(F,el){return F.x*el.x+F.y*el.y}function Vp(F,el){if(1===F.length){let eh,ec=0,ep=el[ec++];for(;!eh||ep.equals(eh);)if(!(eh=el[ec++]))return 1/0;for(;ec<el.length;ec++){let e_=el[ec],eg=F[0],ey=eh.sub(ep),eb=e_.sub(ep),ew=eg.sub(ep),eT=Bp(ey,ey),eS=Bp(ey,eb),eE=Bp(eb,eb),eM=Bp(ew,ey),eI=Bp(ew,eb),eA=eT*eE-eS*eS,eC=(eE*eM-eS*eI)/eA,eP=(eT*eI-eS*eM)/eA,ez=ep.z*(1-eC-eP)+eh.z*eC+e_.z*eP;if(isFinite(ez))return ez}return 1/0}{let F=1/0;for(let eh of el)F=Math.min(F,eh.z);return F}}function Cp(F,el,eh,ec,ep,e_,eg,ey){let eb=eg*ep.getElevationAt(F,el,!0,!0),ew=0!==e_[0],eT=ew?0===e_[1]?eg*(e_[0]/7-450):eg*function(F,el,eh){var ec,ep;let e_=Math.floor(el[0]/8),eg=Math.floor(el[1]/8),ey=10*(el[0]-8*e_),eb=10*(el[1]-8*eg),ew=F.getElevationAt(e_,eg,!0,!0),eT=F.getMeterToDEM(eh),eS=Math.floor(.5*(ey*eT-1)),eE=Math.floor(.5*(eb*eT-1)),eM=F.tileCoordToPixel(e_,eg),eI=2*eS+1,eA=2*eE+1,eC=(ec=eM.x-eS,ep=eM.y-eE,[F.getElevationAtPixel(ec,ep,!0),F.getElevationAtPixel(ec+eA,ep,!0),F.getElevationAtPixel(ec,ep+eA,!0),F.getElevationAtPixel(ec+eI,ep+eA,!0)]),eP=Math.abs(eC[0]-eC[1]),ez=Math.abs(eC[2]-eC[3]),eD=Math.abs(eC[0]-eC[2])+Math.abs(eC[1]-eC[3]),eR=Math.min(.25,.5*eT*(eP+ez)/eI),eL=Math.min(.25,.5*eT*eD/eA);return ew+Math.max(eR*ey,eL*eb)}(ep,e_,ey):eb;return{base:eb+(0===eh?-1:eh),top:ew?Math.max(eT+ec,eb+eh+2):eb+ec}}us(vp,"FillExtrusionBucket",{omit:["layers","features"]}),us(fp,"PartData"),us(pp,"FootprintSegment"),us(dp,"BorderCentroidData"),us(xp,"GroundEffect");let aF=va([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),aB=va([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:aN}=aF,aV=va([{name:"a_packed",components:3,type:"Float32"}]),{members:aU}=aV,aj=va([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:aG}=aj;let jp=class jp{constructor(F,el){this.width=F,this.height=el,this.nextRow=0,this.image=new hc({width:F,height:el}),this.positions={},this.uploaded=!1}getDash(F,el){let eh=this.getKey(F,el);return this.positions[eh]}trim(){let F=this.width,el=this.height=at(this.nextRow);this.image.resize({width:F,height:el})}getKey(F,el){return F.join(",")+el}getDashRanges(F,el,eh){let ec=[],ep=F.length%2==1?-F[F.length-1]*eh:0,e_=F[0]*eh,eg=!0;ec.push({left:ep,right:e_,isDash:eg,zeroLength:0===F[0]});let ey=F[0];for(let el=1;el<F.length;el++){eg=!eg;let eb=F[el];ep=ey*eh,ey+=eb,e_=ey*eh,ec.push({left:ep,right:e_,isDash:eg,zeroLength:0===eb})}return ec}addRoundDash(F,el,eh){let ec=el/2;for(let el=-eh;el<=eh;el++){let ep=this.width*(this.nextRow+eh+el),e_=0,eg=F[0];for(let ey=0;ey<this.width;ey++){let eb;ey/eg.right>1&&(eg=F[++e_]);let ew=Math.abs(ey-eg.left),eT=Math.abs(ey-eg.right),eS=Math.min(ew,eT),eE=el/eh*(ec+1);if(eg.isDash){let F=ec-Math.abs(eE);eb=Math.sqrt(eS*eS+F*F)}else eb=ec-Math.sqrt(eS*eS+eE*eE);this.image.data[ep+ey]=Math.max(0,Math.min(255,eb+128))}}}addRegularDash(F,el){for(let el=F.length-1;el>=0;--el){let eh=F[el],ec=F[el+1];eh.zeroLength?F.splice(el,1):ec&&ec.isDash===eh.isDash&&(ec.left=eh.left,F.splice(el,1))}let eh=F[0],ec=F[F.length-1];eh.isDash===ec.isDash&&(eh.left=ec.left-this.width,ec.right=eh.right+this.width);let ep=this.width*this.nextRow,e_=0,eg=F[0];for(let eh=0;eh<this.width;eh++){eh/eg.right>1&&(eg=F[++e_]);let ec=Math.abs(eh-eg.left),ey=Math.abs(eh-eg.right),eb=Math.min(ec,ey);this.image.data[ep+eh]=Math.max(0,Math.min(255,(eg.isDash?eb:-eb)+el+128))}}addDash(F,el){let eh=this.getKey(F,el);if(this.positions[eh])return this.positions[eh];let ec="round"===el,ep=ec?7:0,e_=2*ep+1;if(this.nextRow+e_>this.height)return pt("LineAtlas out of space"),null;0===F.length&&F.push(1);let eg=0;for(let el=0;el<F.length;el++)F[el]<0&&(pt("Negative value is found in line dasharray, replacing values with 0"),F[el]=0),eg+=F[el];if(0!==eg){let eh=this.width/eg,e_=this.getDashRanges(F,this.width,eh);ec?this.addRoundDash(e_,eh,ep):this.addRegularDash(e_,"square"===el?.5*eh:0)}let ey=this.nextRow+ep;this.nextRow+=e_;let eb={tl:[ey,ep],br:[eg,0]};return this.positions[eh]=eb,eb}};us(jp,"LineAtlas");let aq=am.VectorTileFeature.types,a$=Math.cos(Math.PI/180*37.5),aH=Math.cos(Math.PI/180*5);let Yp=class Yp{constructor(F){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=F.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=F.overscaling,this.pixelRatio=F.pixelRatio,this.layers=F.layers,this.layerIds=this.layers.map(F=>F.fqid),this.index=F.index,this.projection=F.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(F=>{this.gradients[F.id]={}}),this.layoutVertexArray=new Ea,this.layoutVertexArray2=new za,this.patternVertexArray=new za,this.indexArray=new ja,this.programConfigurations=new Go(F.layers,{zoom:F.zoom,lut:F.lut}),this.segments=new xo,this.maxLineLength=0,this.zOffsetVertexArray=new za,this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.tessellationStep=F.tessellationStep?F.tessellationStep:128}updateFootprints(F,el){}populate(F,el,eh,ec){this.hasPattern=Hc("line",this.layers,this.pixelRatio,el);let ep=this.layers[0].layout.get("line-sort-key");this.tileToMeter=Al(eh);let e_=this.layers[0].layout.get("line-z-offset"),eg=e_.isConstant()&&!e_.constantOr(0),ey=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset="sea"===ey||"ground"===ey||!eg&&"none"===ey,this.hasZOffset&&"none"===ey&&pt(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);let eb=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&void 0!==eb;let ew=[];for(let{feature:el,id:e_,index:eg,sourceLayerIndex:ey}of F){let F=this.layers[0]._featureFilter.needGeometry,eb=Cl(el,F);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),eb,eh))continue;let eT=ep?ep.evaluate(eb,{},eh):void 0,eS={id:e_,properties:el.properties,type:el.type,sourceLayerIndex:ey,index:eg,geometry:F?eb.geometry:Vl(el,eh,ec),patterns:{},sortKey:eT};ew.push(eS)}ep&&ew.sort((F,el)=>F.sortKey-el.sortKey);let{lineAtlas:eT,featureIndex:eS}=el,eE=this.addConstantDashes(eT);for(let ec of ew){let{geometry:ep,index:e_,sourceLayerIndex:eg}=ec;if(eE&&this.addFeatureDashes(ec,eT),this.hasPattern){let F=Xc("line",this.layers,ec,this.zoom,this.pixelRatio,el);this.patternFeatures.push(F)}else this.addFeature(ec,ep,e_,eh,eT.positions,el.availableImages,el.brightness);eS.insert(F[e_].feature,ep,e_,eg,this.index)}}addConstantDashes(F){let el=!1;for(let eh of this.layers){let ec=eh.paint.get("line-dasharray").value,ep=eh.layout.get("line-cap").value;if("constant"!==ec.kind||"constant"!==ep.kind)el=!0;else{let el=ep.value,eh=ec.value;if(!eh)continue;F.addDash(eh,el)}}return el}addFeatureDashes(F,el){let eh=this.zoom;for(let ec of this.layers){let ep,e_;let eg=ec.paint.get("line-dasharray").value,ey=ec.layout.get("line-cap").value;if("constant"!==eg.kind||"constant"!==ey.kind){if("constant"===eg.kind){if(!(ep=eg.value))continue}else ep=eg.evaluate({zoom:eh},F);e_="constant"===ey.kind?ey.value:ey.evaluate({zoom:eh},F),el.addDash(ep,e_),F.patterns[ec.id]=el.getKey(ep,e_)}}}update(F,el,eh,ec,ep,e_,eg){this.programConfigurations.updatePaintArrays(F,el,ep,eh,ec,e_,eg)}addFeatures(F,el,eh,ec,ep,e_){for(let F of this.patternFeatures)this.addFeature(F,F.geometry,F.index,el,eh,ec,e_)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(F){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=F.createVertexBuffer(this.layoutVertexArray2,aU)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=F.createVertexBuffer(this.patternVertexArray,aG)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,aB.members,!0)),this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,aN),this.indexBuffer=F.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(F),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(F){if(F.properties&&F.properties.hasOwnProperty("mapbox_clip_start")&&F.properties.hasOwnProperty("mapbox_clip_end"))return{start:+F.properties.mapbox_clip_start,end:+F.properties.mapbox_clip_end}}addFeature(F,el,eh,ec,ep,e_,eg){let ey=this.layers[0].layout,eb=ey.get("line-join").evaluate(F,{}),ew=ey.get("line-cap").evaluate(F,{}),eT=ey.get("line-miter-limit"),eS=ey.get("line-round-limit");this.lineClips=this.lineFeatureClips(F),this.lineFeature=F,this.zOffsetValue=ey.get("line-z-offset").value;let eE=this.layers[0].paint.get("line-width").value;for(let eh of("constant"!==eE.kind&&!1===eE.isLineProgressConstant&&(this.variableWidthValue=eE),el))this.addLine(eh,F,ec,eb,ew,eT,eS);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,F,eh,ep,e_,ec,eg)}addLine(F,el,eh,ec,ep,e_,eg){let ey,eb,ew,eT,eS,eE;this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;let eM="none"===ec;if(this.patternJoinNone=this.hasPattern&&eM,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let el=0;el<F.length-1;el++)this.totalDistance+=F[el].dist(F[el+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}let eI="Polygon"===aq[el.type],eA=F.length;for(;eA>=2&&F[eA-1].equals(F[eA-2]);)eA--;let eC=0;for(;eC<eA-1&&F[eC].equals(F[eC+1]);)eC++;if(eA<(eI?3:2))return;"bevel"===ec&&(e_=1.05);let eP=this.segments.prepareSegment(10*eA,this.layoutVertexArray,this.indexArray);this.e1=this.e2=-1,eI&&(ey=F[eA-2],eS=F[eC].sub(ey)._unit()._perp());for(let el=eC;el<eA;el++){if((ew=el===eA-1?eI?F[eC+1]:void 0:F[el+1])&&F[el].equals(ew))continue;eS&&(eT=eS),ey&&(eb=ey),ey=F[el],eE=this.evaluateLineProgressFeatures(eb?eb.dist(ey):0),eS=ew?ew.sub(ey)._unit()._perp():eT,eT=eT||eS;let eh=eb&&ew,ez=eh?ec:eI||eM?"butt":ep,eD=eT.x*eS.x+eT.y*eS.y;if(eM){let t=function(F){if(F.patternJoinNone){let el=F.segmentPoints.length/2,eh=F.lineSoFar-F.segmentStart;for(let ec=0;ec<el;++ec){let el=F.segmentPoints[2*ec+1],ep=Math.round(F.segmentPoints[2*ec])+.5+.25*el;F.patternVertexArray.emplaceBack(ep,eh,F.segmentStart),F.patternVertexArray.emplaceBack(ep,eh,F.segmentStart)}F.segmentPoints.length=0}F.e1=F.e2=-1};if(eh&&eD<aH){this.updateDistance(eb,ey),this.addCurrentVertex(ey,eT,1,1,eP,eE),t(this),this.addCurrentVertex(ey,eS,-1,-1,eP,eE);continue}if(eb){if(!ew){this.updateDistance(eb,ey),this.addCurrentVertex(ey,eT,1,1,eP,eE),t(this);continue}ez="miter"}}let eR=eT.add(eS);0===eR.x&&0===eR.y||eR._unit();let eL=eR.x*eS.x+eR.y*eS.y,eO=0!==eL?1/eL:1/0,ek=2*Math.sqrt(2-2*eL),eF=eL<a$&&eb&&ew,eB=eT.x*eS.y-eT.y*eS.x>0,eN=this.overscaling<=16?122880/(512*this.overscaling):0;if(eh&&"round"===ez){if(eO<eg)ez="miter";else if(eO<=2){let F=Hp(ey,-10,8202);ez=this.hasZOffset&&(F||this.hasCrossSlope)?"miter":"fakeround"}}if("miter"===ez&&eO>e_&&(ez="bevel"),"bevel"===ez&&(eO>2&&(ez="flipbevel"),eO<e_&&(ez="miter")),eb&&!("miter"===ez&&eF)&&this.updateDistance(eb,ey),"miter"===ez){if(eF){let F=ey.dist(eb);if(F>2*eN){let el=ey.sub(ey.sub(eb)._mult(eN/F)._round());this.updateDistance(eb,el),this.addCurrentVertex(el,eT,0,0,eP,eE),eb=el}this.updateDistance(eb,ey),eR._mult(eO),this.addCurrentVertex(ey,eR,0,0,eP,eE);let el=ey.dist(ew);if(el>2*eN){let F=ey.add(ew.sub(ey)._mult(eN/el)._round());this.updateDistance(ey,F),this.addCurrentVertex(F,eS,0,0,eP,eE),ey=F}}else eR._mult(eO),this.addCurrentVertex(ey,eR,0,0,eP,eE)}else if("flipbevel"===ez){if(eO>100)eR=eS.mult(-1);else{let F=eO*eT.add(eS).mag()/eT.sub(eS).mag();eR._perp()._mult(F*(eB?-1:1))}this.addCurrentVertex(ey,eR,0,0,eP,eE),this.addCurrentVertex(ey,eR.mult(-1),0,0,eP,eE)}else if("bevel"===ez||"fakeround"===ez){null!=eE&&eb&&this.addCurrentVertex(ey,eT,-1,-1,eP,eE);let F=ey.dist(eb)<=2*eN&&"bevel"!==ez,el=eR.mult(eB?1:-1);el._mult(eO);let eh=eS.mult(eB?-1:1),ec=eT.mult(eB?-1:1),ep=this.evaluateLineProgressFeatures(this.distance);if(null==eE&&(this.addHalfVertex(ey,el.x,el.y,!1,!eB,0,eP,ep),F||this.addHalfVertex(ey,el.x+2*ec.x,el.y+2*ec.y,!1,eB,0,eP,ep)),"fakeround"===ez){let F=Math.round(180*ek/Math.PI/20);this.addHalfVertex(ey,ec.x,ec.y,!1,eB,0,eP,ep);for(let el=0;el<F;el++){let e_=el/F;if(.5!==e_){let F=e_-.5;e_+=e_*F*(e_-1)*((1.0904+eD*(eD*(3.55645-1.43519*eD)-3.2452))*F*F+(.848013+eD*(.215638*eD-1.06021)))}let eg=eh.sub(ec)._mult(e_)._add(ec)._unit();this.addHalfVertex(ey,eg.x,eg.y,!1,eB,0,eP,ep)}this.addHalfVertex(ey,eh.x,eh.y,!1,eB,0,eP,ep)}F||null!=eE||this.addHalfVertex(ey,el.x+2*eh.x,el.y+2*eh.y,!1,eB,0,eP,ep),null!=eE&&ew&&this.addCurrentVertex(ey,eS,1,1,eP,eE)}else"butt"===ez?this.addCurrentVertex(ey,eR,0,0,eP,eE):"square"===ez?(eb||this.addCurrentVertex(ey,eR,-1,-1,eP,eE),this.addCurrentVertex(ey,eR,0,0,eP,eE),eb&&this.addCurrentVertex(ey,eR,1,1,eP,eE)):"round"===ez&&(eb&&(this.addCurrentVertex(ey,eT,0,0,eP,eE),this.addCurrentVertex(ey,eT,1,1,eP,eE,!0)),ew&&(this.addCurrentVertex(ey,eS,-1,-1,eP,eE,!0),this.addCurrentVertex(ey,eS,0,0,eP,eE)))}}addVerticesTo(F,el,eh,ec,ep,e_,eg,ey,eb,ew){let eT=(el.w-F.w)/this.tessellationStep|0,eS=0,eE=this.scaledDistance;if(eT>1){this.lineSoFar=F.w;let eE=(el.x-F.x)/eT,eM=(el.y-F.y)/eT,eI=(el.z-F.z)/eT,eA=(el.w-F.w)/eT;for(let el=1;el<eT;++el){F.x+=eE,F.y+=eM,F.z+=eI,this.lineSoFar+=eA,eS+=eA;let el=this.evaluateLineProgressFeatures(this.prevDistance+eS);this.scaledDistance=(this.prevDistance+eS)/this.totalDistance,this.addHalfVertex(F,eh,ec,ew,!1,eg,eb,el),this.addHalfVertex(F,ep,e_,ew,!0,-ey,eb,el)}}this.lineSoFar=el.w,this.scaledDistance=eE;let eM=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(el,eh,ec,ew,!1,eg,eb,eM),this.addHalfVertex(el,ep,e_,ew,!0,-ey,eb,eM)}evaluateLineProgressFeatures(F){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+F)/this.totalFeatureLength):pt(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let el=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(el=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:el}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:el}:{zOffset:0,variableWidth:el}}addCurrentVertex(F,el,eh,ec,ep,e_,eg=!1){let ey=el.x+el.y*eh,eb=el.y-el.x*eh,ew=el.y*ec-el.x,eT=-el.y-el.x*ec;if(null!=e_){let el=this.hasZOffset,eS=e_.zOffset,eE=new Lh(F.x,F.y,eS,this.lineSoFar),eM=!!el&&Hp(F,-10,8202),eI=this.lineSoFar,eA=this.distance;if(this.currentVertex){if(eM){let el=this.currentVertexIsOutside,e_=this.currentVertex,eM=new Lh(F.x,F.y,eS,this.lineSoFar);if(Nh(e_,eM,-10,8202),!Hp(eM,-10,8202)){if(el){this.e1=this.e2=-1,this.distance-=e_.dist(eE),this.lineSoFar=e_.w;let F=this.evaluateLineProgressFeatures(e_.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(e_,ey,eb,eg,!1,eh,ep,F),this.addHalfVertex(e_,ew,eT,eg,!0,-ec,ep,F),this.prevDistance=this.distance}this.distance=this.prevDistance+e_.dist(eM),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(e_,eM,ey,eb,ew,eT,eh,ec,ep,eg),this.distance=eA,this.scaledDistance=this.distance/this.totalDistance}}else{let F=this.currentVertex;if(this.currentVertexIsOutside){Nh(F,eE,-10,8202),this.e1=this.e2=-1,this.distance-=F.dist(eE),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=F.w;let el=this.evaluateLineProgressFeatures(F.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(F,ey,eb,eg,!1,eh,ep,el),this.addHalfVertex(F,ew,eT,eg,!0,-ec,ep,el),this.prevDistance=this.distance,this.distance=eA,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(F,eE,ey,eb,ew,eT,eh,ec,ep,eg)}}else eM||(this.addHalfVertex(F,ey,eb,eg,!1,eh,ep,e_),this.addHalfVertex(F,ew,eT,eg,!0,-ec,ep,e_));this.currentVertex=eE,this.currentVertexIsOutside=eM,this.lineSoFar=eI}else this.addHalfVertex(F,ey,eb,eg,!1,eh,ep,e_),this.addHalfVertex(F,ew,eT,eg,!0,-ec,ep,e_)}addHalfVertex({x:F,y:el},eh,ec,ep,e_,eg,ey,eb){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),e_||this.segmentPoints.push(this.lineSoFar-this.segmentStart,eg)),this.layoutVertexArray.emplaceBack((F<<1)+(ep?1:0),(el<<1)+(e_?1:0),Math.round(63*eh)+128,Math.round(63*ec)+128,1+(0===eg?0:eg<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){let F=Ee(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,F)}let ew=ey.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,ew),ey.primitiveLength++),e_?this.e2=ew:this.e1=ew,null!=eb&&this.zOffsetVertexArray.emplaceBack(eb.zOffset,eb.variableWidth,eb.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(F,el){this.prevDistance=this.distance,this.distance+=F.dist(el),this.updateScaledDistance()}};function Hp(F,el,eh){return F.x<el||F.x>eh||F.y<el||F.y>eh}function Wp(F,el,eh){return el*(8192/(F.tileSize*Math.pow(2,eh-F.tileID.overscaledZ)))}us(Yp,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});let Kp=(F,el,eh)=>(1-eh)*F+eh*el;function Jp(F,el){return 1/Wp(F,1,el.tileZoom)}function Qp(F,el,eh,ec){return F.translatePosMatrix(ec||el.tileID.projMatrix,el,eh.paint.get("line-translate"),eh.paint.get("line-translate-anchor"))}let tf=F=>{let el=[];ef(F)&&el.push("RENDER_LINE_DASH"),F.paint.get("line-gradient")&&el.push("RENDER_LINE_GRADIENT");let eh=F.paint.get("line-trim-offset");0===eh[0]&&0===eh[1]||el.push("RENDER_LINE_TRIM_OFFSET"),0!==F.paint.get("line-border-width").constantOr(1)&&el.push("RENDER_LINE_BORDER");let ec="none"===F.layout.get("line-join").constantOr("miter"),ep=!!F.paint.get("line-pattern").constantOr(1);return ec&&ep&&el.push("LINE_JOIN_NONE"),el};function ef(F){let el=F.paint.get("line-dasharray").value;return el.value||"constant"!==el.kind}let nf=()=>eB||(eB={layout:ek||(ek=new Xs({"line-cap":new Ys(rw.layout_line["line-cap"]),"line-join":new Ys(rw.layout_line["line-join"]),"line-miter-limit":new Gs(rw.layout_line["line-miter-limit"]),"line-round-limit":new Gs(rw.layout_line["line-round-limit"]),"line-sort-key":new Ys(rw.layout_line["line-sort-key"]),"line-z-offset":new Ys(rw.layout_line["line-z-offset"]),"line-elevation-reference":new Gs(rw.layout_line["line-elevation-reference"]),"line-cross-slope":new Gs(rw.layout_line["line-cross-slope"]),visibility:new Gs(rw.layout_line.visibility),"line-width-unit":new Gs(rw.layout_line["line-width-unit"])})),paint:eF||(eF=new Xs({"line-opacity":new Ys(rw.paint_line["line-opacity"]),"line-color":new Ys(rw.paint_line["line-color"]),"line-translate":new Gs(rw.paint_line["line-translate"]),"line-translate-anchor":new Gs(rw.paint_line["line-translate-anchor"]),"line-width":new Ys(rw.paint_line["line-width"]),"line-gap-width":new Ys(rw.paint_line["line-gap-width"]),"line-offset":new Ys(rw.paint_line["line-offset"]),"line-blur":new Ys(rw.paint_line["line-blur"]),"line-dasharray":new Ys(rw.paint_line["line-dasharray"]),"line-pattern":new Ys(rw.paint_line["line-pattern"]),"line-gradient":new Hs(rw.paint_line["line-gradient"]),"line-trim-offset":new Gs(rw.paint_line["line-trim-offset"]),"line-trim-fade-range":new Gs(rw.paint_line["line-trim-fade-range"]),"line-trim-color":new Gs(rw.paint_line["line-trim-color"]),"line-emissive-strength":new Gs(rw.paint_line["line-emissive-strength"]),"line-border-width":new Ys(rw.paint_line["line-border-width"]),"line-border-color":new Ys(rw.paint_line["line-border-color"]),"line-occlusion-opacity":new Gs(rw.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))});let sf=class sf extends Ys{possiblyEvaluate(F,el){return el=new Rs(Math.floor(el.zoom),{now:el.now,fadeDuration:el.fadeDuration,transition:el.transition}),super.possiblyEvaluate(F,el)}evaluate(F,el,eh,ec){return el=nt({},el,{zoom:Math.floor(el.zoom)}),super.evaluate(F,el,eh,ec)}};let aZ=va([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),aW=va([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),aY=va([{name:"a_projected_pos",components:4,type:"Float32"}],4);va([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);let aX=va([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),aK=va([{name:"a_texb",components:2,type:"Uint16"}]),aJ=va([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),aQ=va([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);va([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);let a0=va([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),a1=va([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function vf(F,el,eh,ec,ep){if("camera"===F.kind)return F.maxSize;if("composite"===F.kind){let ec=el.possiblyEvaluate(new Rs(F.maxZoom),eh).evaluate(ep,{},eh),e_=el.possiblyEvaluate(new Rs(F.minZoom),eh).evaluate(ep,{},eh);return Math.max(ec,e_)}return el.possiblyEvaluate(new Rs(ec)).evaluate(ep,{},eh)}function bf(F,el){let{expression:eh}=el;if("constant"===eh.kind)return{kind:"constant",layoutSize:eh.evaluate(new Rs(F+1))};if("source"===eh.kind)return{kind:"source"};{let{zoomStops:el,interpolationType:ec}=eh,ep=0;for(;ep<el.length&&el[ep]<=F;)ep++;let e_=ep=Math.max(0,ep-1);for(;e_<el.length&&el[e_]<F+1;)e_++;e_=Math.min(el.length-1,e_);let eg=el[ep],ey=el[e_];return"composite"===eh.kind?{kind:"composite",minZoom:eg,maxZoom:ey,interpolationType:ec}:{kind:"camera",minZoom:eg,maxZoom:ey,minSize:eh.evaluate(new Rs(eg)),maxSize:eh.evaluate(new Rs(ey)),interpolationType:ec}}}function _f(F,{uSize:el,uSizeT:eh},{lowerSize:ec,upperSize:ep}){return"source"===F.kind?ec/128:"composite"===F.kind?Ee(ec/128,ep/128,eh):el}function wf(F,el,eh=1){let ec=0,ep=0;if("constant"===F.kind)ep=F.layoutSize*eh;else if("source"!==F.kind){let{interpolationType:e_,minZoom:eg,maxZoom:ey}=F,eb=e_?Q(ai.interpolationFactor(e_,el,eg,ey),0,1):0;"camera"===F.kind?ep=Ee(F.minSize,F.maxSize,eb)*eh:ec=eb*eh}return{uSizeT:ec,uSize:ep}}va([{name:"triangle",components:3,type:"Uint16"}]),va([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),va([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),va([{type:"Float32",name:"offsetX"}]),va([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var a2=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:128,evaluateSizeForFeature:_f,evaluateSizeForZoom:wf,getRasterizedIconSize:vf,getSizeData:bf});let a3={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","\xa2":"","\xa3":"","\xa5":"","\xa6":"","\xac":"","\xaf":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};var a4,a5,a6,a8={};function Vf(){if(a6)return a5;a6=1,a5=e;var F=(a4||(a4=1,a8.read=function(F,el,eh,ec,ep){var e_,eg,ey=8*ep-ec-1,eb=(1<<ey)-1,ew=eb>>1,eT=-7,eS=eh?ep-1:0,eE=eh?-1:1,eM=F[el+eS];for(eS+=eE,e_=eM&(1<<-eT)-1,eM>>=-eT,eT+=ey;eT>0;e_=256*e_+F[el+eS],eS+=eE,eT-=8);for(eg=e_&(1<<-eT)-1,e_>>=-eT,eT+=ec;eT>0;eg=256*eg+F[el+eS],eS+=eE,eT-=8);if(0===e_)e_=1-ew;else{if(e_===eb)return eg?NaN:1/0*(eM?-1:1);eg+=Math.pow(2,ec),e_-=ew}return(eM?-1:1)*eg*Math.pow(2,e_-ec)},a8.write=function(F,el,eh,ec,ep,e_){var eg,ey,eb,ew=8*e_-ep-1,eT=(1<<ew)-1,eS=eT>>1,eE=23===ep?5960464477539062e-23:0,eM=ec?0:e_-1,eI=ec?1:-1,eA=el<0||0===el&&1/el<0?1:0;for(isNaN(el=Math.abs(el))||el===1/0?(ey=isNaN(el)?1:0,eg=eT):(eg=Math.floor(Math.log(el)/Math.LN2),el*(eb=Math.pow(2,-eg))<1&&(eg--,eb*=2),(el+=eg+eS>=1?eE/eb:eE*Math.pow(2,1-eS))*eb>=2&&(eg++,eb/=2),eg+eS>=eT?(ey=0,eg=eT):eg+eS>=1?(ey=(el*eb-1)*Math.pow(2,ep),eg+=eS):(ey=el*Math.pow(2,eS-1)*Math.pow(2,ep),eg=0));ep>=8;F[eh+eM]=255&ey,eM+=eI,ey/=256,ep-=8);for(eg=eg<<ep|ey,ew+=ep;ew>0;F[eh+eM]=255&eg,eM+=eI,eg/=256,ew-=8);F[eh+eM-eI]|=128*eA}),a8);function e(F){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(F)?F:new Uint8Array(F||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var el="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function s(F){return F.type===e.Bytes?F.readVarint()+F.pos:F.pos+1}function o(F,el,eh){var ec=el<=16383?1:el<=2097151?2:el<=268435455?3:Math.floor(Math.log(el)/(7*Math.LN2));eh.realloc(ec);for(var ep=eh.pos-1;ep>=F;ep--)eh.buf[ep+ec]=eh.buf[ep]}function l(F,el){for(var eh=0;eh<F.length;eh++)el.writeVarint(F[eh])}function u(F,el){for(var eh=0;eh<F.length;eh++)el.writeSVarint(F[eh])}function c(F,el){for(var eh=0;eh<F.length;eh++)el.writeFloat(F[eh])}function h(F,el){for(var eh=0;eh<F.length;eh++)el.writeDouble(F[eh])}function p(F,el){for(var eh=0;eh<F.length;eh++)el.writeBoolean(F[eh])}function f(F,el){for(var eh=0;eh<F.length;eh++)el.writeFixed32(F[eh])}function d(F,el){for(var eh=0;eh<F.length;eh++)el.writeSFixed32(F[eh])}function m(F,el){for(var eh=0;eh<F.length;eh++)el.writeFixed64(F[eh])}function y(F,el){for(var eh=0;eh<F.length;eh++)el.writeSFixed64(F[eh])}function g(F,el){return(F[el]|F[el+1]<<8|F[el+2]<<16)+16777216*F[el+3]}function x(F,el,eh){F[eh]=el,F[eh+1]=el>>>8,F[eh+2]=el>>>16,F[eh+3]=el>>>24}function v(F,el){return(F[el]|F[el+1]<<8|F[el+2]<<16)+(F[el+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(F,el,eh){for(eh=eh||this.length;this.pos<eh;){var ec=this.readVarint(),ep=ec>>3,e_=this.pos;this.type=7&ec,F(ep,el,this),this.pos===e_&&this.skip(ec)}return el},readMessage:function(F,el){return this.readFields(F,el,this.readVarint()+this.pos)},readFixed32:function(){var F=g(this.buf,this.pos);return this.pos+=4,F},readSFixed32:function(){var F=v(this.buf,this.pos);return this.pos+=4,F},readFixed64:function(){var F=g(this.buf,this.pos)+4294967296*g(this.buf,this.pos+4);return this.pos+=8,F},readSFixed64:function(){var F=g(this.buf,this.pos)+4294967296*v(this.buf,this.pos+4);return this.pos+=8,F},readFloat:function(){var el=F.read(this.buf,this.pos,!0,23,4);return this.pos+=4,el},readDouble:function(){var el=F.read(this.buf,this.pos,!0,52,8);return this.pos+=8,el},readVarint:function(F){var el,eh,ec=this.buf;return el=127&(eh=ec[this.pos++]),eh<128?el:(el|=(127&(eh=ec[this.pos++]))<<7,eh<128?el:(el|=(127&(eh=ec[this.pos++]))<<14,eh<128?el:(el|=(127&(eh=ec[this.pos++]))<<21,eh<128?el:function(F,el,eh){var ec,ep,e_,eg=eh.buf;if(ep=(112&(e_=eg[eh.pos++]))>>4,e_<128||(ep|=(127&(e_=eg[eh.pos++]))<<3,e_<128)||(ep|=(127&(e_=eg[eh.pos++]))<<10,e_<128)||(ep|=(127&(e_=eg[eh.pos++]))<<17,e_<128)||(ep|=(127&(e_=eg[eh.pos++]))<<24,e_<128)||(ep|=(1&(e_=eg[eh.pos++]))<<31,e_<128))return ec=ep,el?4294967296*ec+(F>>>0):4294967296*(ec>>>0)+(F>>>0);throw Error("Expected varint not more than 10 bytes")}(el|=(15&(eh=ec[this.pos]))<<28,F,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var F=this.readVarint();return F%2==1?-((F+1)/2):F/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var F,eh=this.readVarint()+this.pos,ec=this.pos;return this.pos=eh,eh-ec>=12&&el?(F=this.buf,el.decode(F.subarray(ec,eh))):function(F,el,eh){for(var ec="",ep=el;ep<eh;){var e_,eg,ey,eb=F[ep],ew=null,eT=eb>239?4:eb>223?3:eb>191?2:1;if(ep+eT>eh)break;1===eT?eb<128&&(ew=eb):2===eT?128==(192&(e_=F[ep+1]))&&(ew=(31&eb)<<6|63&e_)<=127&&(ew=null):3===eT?(eg=F[ep+2],128==(192&(e_=F[ep+1]))&&128==(192&eg)&&((ew=(15&eb)<<12|(63&e_)<<6|63&eg)<=2047||ew>=55296&&ew<=57343)&&(ew=null)):4===eT&&(eg=F[ep+2],ey=F[ep+3],128==(192&(e_=F[ep+1]))&&128==(192&eg)&&128==(192&ey)&&((ew=(15&eb)<<18|(63&e_)<<12|(63&eg)<<6|63&ey)<=65535||ew>=1114112)&&(ew=null)),null===ew?(ew=65533,eT=1):ew>65535&&(ew-=65536,ec+=String.fromCharCode(ew>>>10&1023|55296),ew=56320|1023&ew),ec+=String.fromCharCode(ew),ep+=eT}return ec}(this.buf,ec,eh)},readBytes:function(){var F=this.readVarint()+this.pos,el=this.buf.subarray(this.pos,F);return this.pos=F,el},readPackedVarint:function(F,el){if(this.type!==e.Bytes)return F.push(this.readVarint(el));var eh=s(this);for(F=F||[];this.pos<eh;)F.push(this.readVarint(el));return F},readPackedSVarint:function(F){if(this.type!==e.Bytes)return F.push(this.readSVarint());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readSVarint());return F},readPackedBoolean:function(F){if(this.type!==e.Bytes)return F.push(this.readBoolean());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readBoolean());return F},readPackedFloat:function(F){if(this.type!==e.Bytes)return F.push(this.readFloat());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readFloat());return F},readPackedDouble:function(F){if(this.type!==e.Bytes)return F.push(this.readDouble());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readDouble());return F},readPackedFixed32:function(F){if(this.type!==e.Bytes)return F.push(this.readFixed32());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readFixed32());return F},readPackedSFixed32:function(F){if(this.type!==e.Bytes)return F.push(this.readSFixed32());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readSFixed32());return F},readPackedFixed64:function(F){if(this.type!==e.Bytes)return F.push(this.readFixed64());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readFixed64());return F},readPackedSFixed64:function(F){if(this.type!==e.Bytes)return F.push(this.readSFixed64());var el=s(this);for(F=F||[];this.pos<el;)F.push(this.readSFixed64());return F},skip:function(F){var el=7&F;if(el===e.Varint)for(;this.buf[this.pos++]>127;);else if(el===e.Bytes)this.pos=this.readVarint()+this.pos;else if(el===e.Fixed32)this.pos+=4;else{if(el!==e.Fixed64)throw Error("Unimplemented type: "+el);this.pos+=8}},writeTag:function(F,el){this.writeVarint(F<<3|el)},realloc:function(F){for(var el=this.length||16;el<this.pos+F;)el*=2;if(el!==this.length){var eh=new Uint8Array(el);eh.set(this.buf),this.buf=eh,this.length=el}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(F){this.realloc(4),x(this.buf,F,this.pos),this.pos+=4},writeSFixed32:function(F){this.realloc(4),x(this.buf,F,this.pos),this.pos+=4},writeFixed64:function(F){this.realloc(8),x(this.buf,-1&F,this.pos),x(this.buf,Math.floor(23283064365386963e-26*F),this.pos+4),this.pos+=8},writeSFixed64:function(F){this.realloc(8),x(this.buf,-1&F,this.pos),x(this.buf,Math.floor(23283064365386963e-26*F),this.pos+4),this.pos+=8},writeVarint:function(F){(F=+F||0)>268435455||F<0?function(F,el){var eh,ec,ep,e_,eg;if(F>=0?(eh=F%4294967296|0,ec=F/4294967296|0):(ec=~(-F/4294967296),4294967295^(eh=~(-F%4294967296))?eh=eh+1|0:(eh=0,ec=ec+1|0)),F>=18446744073709552e3||F<-18446744073709552e3)throw Error("Given varint doesn't fit into 10 bytes");el.realloc(10),ep=eh,el.buf[el.pos++]=127&ep|128,ep>>>=7,el.buf[el.pos++]=127&ep|128,ep>>>=7,el.buf[el.pos++]=127&ep|128,ep>>>=7,el.buf[el.pos++]=127&ep|128,el.buf[el.pos]=127&(ep>>>=7),eg=(7&(e_=ec))<<4,el.buf[el.pos++]|=eg|((e_>>>=3)?128:0),e_&&(el.buf[el.pos++]=127&e_|((e_>>>=7)?128:0),e_&&(el.buf[el.pos++]=127&e_|((e_>>>=7)?128:0),e_&&(el.buf[el.pos++]=127&e_|((e_>>>=7)?128:0),e_&&(el.buf[el.pos++]=127&e_|((e_>>>=7)?128:0),e_&&(el.buf[el.pos++]=127&e_)))))}(F,this):(this.realloc(4),this.buf[this.pos++]=127&F|(F>127?128:0),F<=127||(this.buf[this.pos++]=127&(F>>>=7)|(F>127?128:0),F<=127||(this.buf[this.pos++]=127&(F>>>=7)|(F>127?128:0),F<=127||(this.buf[this.pos++]=F>>>7&127))))},writeSVarint:function(F){this.writeVarint(F<0?-(2*F)-1:2*F)},writeBoolean:function(F){this.writeVarint(!!F)},writeString:function(F){F=String(F),this.realloc(4*F.length),this.pos++;var el=this.pos;this.pos=function(F,el,eh){for(var ec,ep,e_=0;e_<el.length;e_++){if((ec=el.charCodeAt(e_))>55295&&ec<57344){if(!ep){ec>56319||e_+1===el.length?(F[eh++]=239,F[eh++]=191,F[eh++]=189):ep=ec;continue}if(ec<56320){F[eh++]=239,F[eh++]=191,F[eh++]=189,ep=ec;continue}ec=ep-55296<<10|ec-56320|65536,ep=null}else ep&&(F[eh++]=239,F[eh++]=191,F[eh++]=189,ep=null);ec<128?F[eh++]=ec:(ec<2048?F[eh++]=ec>>6|192:(ec<65536?F[eh++]=ec>>12|224:(F[eh++]=ec>>18|240,F[eh++]=ec>>12&63|128),F[eh++]=ec>>6&63|128),F[eh++]=63&ec|128)}return eh}(this.buf,F,this.pos);var eh=this.pos-el;eh>=128&&o(el,eh,this),this.pos=el-1,this.writeVarint(eh),this.pos+=eh},writeFloat:function(el){this.realloc(4),F.write(this.buf,el,this.pos,!0,23,4),this.pos+=4},writeDouble:function(el){this.realloc(8),F.write(this.buf,el,this.pos,!0,52,8),this.pos+=8},writeBytes:function(F){var el=F.length;this.writeVarint(el),this.realloc(el);for(var eh=0;eh<el;eh++)this.buf[this.pos++]=F[eh]},writeRawMessage:function(F,el){this.pos++;var eh=this.pos;F(el,this);var ec=this.pos-eh;ec>=128&&o(eh,ec,this),this.pos=eh-1,this.writeVarint(ec),this.pos+=ec},writeMessage:function(F,el,eh){this.writeTag(F,e.Bytes),this.writeRawMessage(el,eh)},writePackedVarint:function(F,el){el.length&&this.writeMessage(F,l,el)},writePackedSVarint:function(F,el){el.length&&this.writeMessage(F,u,el)},writePackedBoolean:function(F,el){el.length&&this.writeMessage(F,p,el)},writePackedFloat:function(F,el){el.length&&this.writeMessage(F,c,el)},writePackedDouble:function(F,el){el.length&&this.writeMessage(F,h,el)},writePackedFixed32:function(F,el){el.length&&this.writeMessage(F,f,el)},writePackedSFixed32:function(F,el){el.length&&this.writeMessage(F,d,el)},writePackedFixed64:function(F,el){el.length&&this.writeMessage(F,m,el)},writePackedSFixed64:function(F,el){el.length&&this.writeMessage(F,y,el)},writeBytesField:function(F,el){this.writeTag(F,e.Bytes),this.writeBytes(el)},writeFixed32Field:function(F,el){this.writeTag(F,e.Fixed32),this.writeFixed32(el)},writeSFixed32Field:function(F,el){this.writeTag(F,e.Fixed32),this.writeSFixed32(el)},writeFixed64Field:function(F,el){this.writeTag(F,e.Fixed64),this.writeFixed64(el)},writeSFixed64Field:function(F,el){this.writeTag(F,e.Fixed64),this.writeSFixed64(el)},writeVarintField:function(F,el){this.writeTag(F,e.Varint),this.writeVarint(el)},writeSVarintField:function(F,el){this.writeTag(F,e.Varint),this.writeSVarint(el)},writeStringField:function(F,el){this.writeTag(F,e.Bytes),this.writeString(el)},writeFloatField:function(F,el){this.writeTag(F,e.Fixed32),this.writeFloat(el)},writeDoubleField:function(F,el){this.writeTag(F,e.Fixed64),this.writeDouble(el)},writeBooleanField:function(F,el){this.writeVarintField(F,!!el)}},a5}var a9=e(Vf());function Rf(F,el,eh){el.glyphs=[],1===F&&eh.readMessage(Lf,el)}function Lf(F,el,eh){if(3===F){let{id:F,bitmap:ec,width:ep,height:e_,left:eg,top:ey,advance:eb}=eh.readMessage(Ff,{});el.glyphs.push({id:F,bitmap:new hc({width:ep+6,height:e_+6},ec),metrics:{width:ep,height:e_,left:eg,top:ey,advance:eb}})}else 4===F?el.ascender=eh.readSVarint():5===F&&(el.descender=eh.readSVarint())}function Ff(F,el,eh){1===F?el.id=eh.readVarint():2===F?el.bitmap=eh.readBytes():3===F?el.width=eh.readVarint():4===F?el.height=eh.readVarint():5===F?el.left=eh.readSVarint():6===F?el.top=eh.readSVarint():7===F&&(el.advance=eh.readVarint())}let a7={horizontal:1,vertical:2,horizontalOnly:3};let Uf=class Uf{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(F,el){let eh=new Uf;return eh.scale=F||1,eh.fontStack=el,eh}static forImage(F){let el=new Uf;return el.image=F,el}};let jf=class jf{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(F,el,eh){let ec=new jf;for(let ep=0;ep<F.sections.length;ep++){let e_=F.sections[ep];e_.image?ec.addImageSection(e_,eh):ec.addTextSection(e_,el)}return ec}length(){return this.text.length}getSection(F){return this.sections[this.sectionIndex[F]]}getSections(){return this.sections}getSectionIndex(F){return this.sectionIndex[F]}getCodePoint(F){return this.text.codePointAt(F)}verticalizePunctuation(F){this.text=function(F,el){let eh="";for(let ec=0;ec<F.length;ec++){let ep=F.charCodeAt(ec+1)||null,e_=F.charCodeAt(ec-1)||null;eh+=!el&&(ep&&vs(ep)&&!a3[F[ec+1]]||e_&&vs(e_)&&!a3[F[ec-1]])||!a3[F[ec]]?F[ec]:a3[F[ec]]}return eh}(this.text,F)}trim(){let F=0;for(let el=0;el<this.text.length&&na[this.text.charCodeAt(el)];el++)F++;let el=this.text.length;for(let eh=this.text.length-1;eh>=0&&eh>=F&&na[this.text.charCodeAt(eh)];eh--)el--;this.text=this.text.substring(F,el),this.sectionIndex=this.sectionIndex.slice(F,el)}substring(F,el){let eh=new jf;return eh.text=this.text.substring(F,el),eh.sectionIndex=this.sectionIndex.slice(F,el),eh.sections=this.sections,eh}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((F,el)=>Math.max(F,this.sections[el].scale),0)}addTextSection(F,el){this.text+=F.text,this.sections.push(Uf.forText(F.scale,F.fontStack||el));let eh=this.sections.length-1;for(let el=0;el<F.text.length;++el)this.sectionIndex.push(eh)}addImageSection(F,el){let eh=F.image?F.image.getPrimary():null;if(!eh)return void pt("Can't add FormattedSection with an empty image.");eh.scaleSelf(el);let ec=this.getNextImageSectionCharCode();ec?(this.text+=String.fromCodePoint(ec),this.sections.push(Uf.forImage(eh)),this.sectionIndex.push(this.sections.length-1)):pt("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}};function qf(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA=1){let eC=jf.fromFeature(F,ep,eA);eS===a7.vertical&&eC.verticalizePunctuation(eE);let eP=[],ez=function(F,el,eh,ec,ep,e_){if(!F)return[];let eg=[],ey=function(F,el,eh,ec,ep,e_){let eg=0;for(let eh=0;eh<F.length();eh++){let ey=F.getSection(eh);eg+=Yf(F.getCodePoint(eh),ey,ec,ep,el,e_)}return eg/Math.max(1,Math.ceil(eg/eh))}(F,el,eh,ec,ep,e_),eb=F.text.indexOf("")>=0,ew=0;for(let eh=0;eh<F.length();eh++){let eT=F.getSection(eh),eS=F.getCodePoint(eh);if(na[eS]||(ew+=Yf(eS,eT,ec,ep,el,e_)),eh<F.length()-1){let el=!(eS<11904||!(ri["Bopomofo Extended"](eS)||ri.Bopomofo(eS)||ri["CJK Compatibility Forms"](eS)||ri["CJK Compatibility Ideographs"](eS)||ri["CJK Compatibility"](eS)||ri["CJK Radicals Supplement"](eS)||ri["CJK Strokes"](eS)||ri["CJK Symbols and Punctuation"](eS)||ri["CJK Unified Ideographs Extension A"](eS)||ri["CJK Unified Ideographs"](eS)||ri["Enclosed CJK Letters and Months"](eS)||ri["Halfwidth and Fullwidth Forms"](eS)||ri.Hiragana(eS)||ri["Ideographic Description Characters"](eS)||ri["Kangxi Radicals"](eS)||ri["Katakana Phonetic Extensions"](eS)||ri.Katakana(eS)||ri["Vertical Forms"](eS)||ri["Yi Radicals"](eS)||ri["Yi Syllables"](eS)));(nl[eS]||el||eT.image)&&eg.push(Zf(eh+1,ew,ey,eg,function(F,el,eh){let ec=0;return 10===F&&(ec-=1e4),eh&&(ec+=150),40!==F&&65288!==F||(ec+=50),41!==el&&65289!==el||(ec+=50),ec}(eS,F.getCodePoint(eh+1),el&&eb),!1))}}return function Wf(F){return F?Wf(F.priorBreak).concat(F.index):[]}(Zf(F.length(),ew,ey,eg,0,!0))}(eC,ew,e_,el,ec,eM),{processBidirectionalText:eD,processStyledBidirectionalText:eR}=rb;if(eD&&1===eC.sections.length){let F=eD(eC.toString(),ez);for(let el of F){let F=new jf;F.text=el,F.sections=eC.sections;for(let eh=0;eh<el.length;eh++)F.sectionIndex.push(0);eP.push(F)}}else if(eR){let F=eR(eC.text,eC.sectionIndex,ez);for(let el of F){let F=new jf;F.text=el[0],F.sectionIndex=el[1],F.sections=eC.sections,eP.push(F)}}else eP=function(F,el){let eh=[],ec=F.text,ep=0;for(let ec of el)eh.push(F.substring(ep,ec)),ep=ec;return ep<ec.length&&eh.push(F.substring(ep,ec.length)),eh}(eC,ez);let eL=[],eO={positionedLines:eL,text:eC.toString(),top:eT[1],bottom:eT[1],left:eT[0],right:eT[0],writingMode:eS,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if(function(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS){let eE=0,eM=0,eI=0,eA="right"===ey?1:"left"===ey?0:.5,eC=!1;for(let F of ep){let eh=F.getSections();for(let F of eh){if(F.image)continue;let eh=el[F.fontStack];if(eh&&!(eC=void 0!==eh.ascender&&void 0!==eh.descender))break}if(!eC)break}let eP=0;for(let eg of ep){eg.trim();let ep=eg.getMaxScale(),ey=(ep-1)*24,ez={positionedGlyphs:[],lineOffset:0};F.positionedLines[eP]=ez;let eD=ez.positionedGlyphs,eR=0;if(!eg.length()){eM+=e_,++eP;continue}let eL=0,eO=0;for(let e_=0;e_<eg.length();e_++){let ey=eg.getSection(e_),eI=eg.getSectionIndex(e_),eA=eg.getCodePoint(e_),eP=ey.scale,ez=null,ek=null,eF=null,eB=24,eN=0;eb===a7.vertical&&(12312===eA||12313===eA||12316===eA||12540===eA||12448===eA)&&(eb=a7.horizontal);let eV=!(eb===a7.horizontal||!eT&&!xs(eA)||eT&&(na[eA]||ri.Arabic(eA)||ri["Arabic Supplement"](eA)||ri["Arabic Extended-A"](eA)||ri["Arabic Presentation Forms-A"](eA)||ri["Arabic Presentation Forms-B"](eA)));if(ey.image){let el=ec.get(ey.image.toString());if(!el)continue;eF=ey.image,F.iconsInText=F.iconsInText||!0,ek=el.paddedRect;let eh=el.displaySize;eP=24*eP/eS,ez={width:eh[0],height:eh[1],left:0,top:-3,advance:eV?eh[1]:eh[0],localGlyph:!1},eN=eC?-ez.height*eP:24*ep-17-eh[1]*eP,eB=ez.advance;let e_=(eV?eh[0]:eh[1])*eP-24*ep;e_>0&&e_>eR&&(eR=e_)}else{let F=eh[ey.fontStack];if(!F)continue;F[eA]&&(ek=F[eA]);let ec=el[ey.fontStack];if(!ec)continue;let e_=ec.glyphs[eA];if(!e_)continue;if(ez=e_.metrics,eB=8203!==eA?24:0,eC){let F=void 0!==ec.ascender?Math.abs(ec.ascender):0,el=void 0!==ec.descender?Math.abs(ec.descender):0,eh=(F+el)*eP;eL<eh&&(eL=eh,eO=(F-el)/2*eP),eN=-F*eP}else eN=(ep-eP)*24-17}eV?(F.verticalizable=!0,eD.push({glyph:eA,image:eF,x:eE,y:eM+eN,vertical:eV,scale:eP,localGlyph:ez.localGlyph,fontStack:ey.fontStack,sectionIndex:eI,metrics:ez,rect:ek}),eE+=eB*eP+ew):(eD.push({glyph:eA,image:eF,x:eE,y:eM+eN,vertical:eV,scale:eP,localGlyph:ez.localGlyph,fontStack:ey.fontStack,sectionIndex:eI,metrics:ez,rect:ek}),eE+=ez.advance*eP+ew)}0!==eD.length&&(eI=Math.max(eE-ew,eI),eC?Jf(eD,eA,eR,eO,e_*ep/2):Jf(eD,eA,eR,0,e_/2)),eE=0;let ek=e_*ep+eR;ez.lineOffset=Math.max(eR,ey),eM+=ek,++eP}let ez=eM,{horizontalAlign:eD,verticalAlign:eR}=Kf(eg);(function(F,el,eh,ec,ep,e_){let eg=(el-eh)*ep,ey=-e_*ec;for(let el of F)for(let F of el.positionedGlyphs)F.x+=eg,F.y+=ey})(F.positionedLines,eA,eD,eR,eI,ez),F.top+=-eR*ez,F.bottom=F.top+ez,F.left+=-eD*eI,F.right=F.left+eI,F.hasBaseline=eC}(eO,el,eh,ec,eP,eg,ey,eb,eS,ew,eE,eI),!function(F){for(let el of F)if(0!==el.positionedGlyphs.length)return!1;return!0}(eL))return eO}let na={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},nl={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Yf(F,el,eh,ec,ep,e_){if(el.image){let F=ec.get(el.image.toString());return F?F.displaySize[0]*el.scale*24/e_+ep:0}{let ec=eh[el.fontStack],e_=ec&&ec.glyphs[F];return e_?e_.metrics.advance*el.scale+ep:0}}function Hf(F,el,eh,ec){let ep=Math.pow(F-el,2);return ec?F<el?ep/2:2*ep:ep+Math.abs(eh)*eh}function Zf(F,el,eh,ec,ep,e_){let eg=null,ey=Hf(el,eh,ep,e_);for(let F of ec){let ec=Hf(el-F.x,eh,ep,e_)+F.badness;ec<=ey&&(eg=F,ey=ec)}return{index:F,x:el,priorBreak:eg,badness:ey}}function Kf(F){let el=.5,eh=.5;switch(F){case"right":case"top-right":case"bottom-right":el=1;break;case"left":case"top-left":case"bottom-left":el=0}switch(F){case"bottom":case"bottom-right":case"bottom-left":eh=1;break;case"top":case"top-right":case"top-left":eh=0}return{horizontalAlign:el,verticalAlign:eh}}function Jf(F,el,eh,ec,ep){if(!(el||eh||ec||ep))return;let e_=F.length-1,eg=F[e_],ey=(eg.x+eg.metrics.advance*eg.scale)*el;for(let el=0;el<=e_;el++)F[el].x-=ey,F[el].y+=eh+ec+ep}function td(F,el,eh,ec,ep,e_){let eg,ey,eb,ew,eT;let eS=F.imagePrimary;if(eS.content){let F=eS.content,el=eS.pixelRatio||1;eg=[F[0]/el,F[1]/el,eS.displaySize[0]-F[2]/el,eS.displaySize[1]-F[3]/el]}let eE=el.left*e_,eM=el.right*e_;"width"===eh||"both"===eh?(eT=ep[0]+eE-ec[3],eb=ep[0]+eM+ec[1]):eb=(eT=ep[0]+(eE+eM-eS.displaySize[0])/2)+eS.displaySize[0];let eI=el.top*e_,eA=el.bottom*e_;return"height"===eh||"both"===eh?(ey=ep[1]+eI-ec[0],ew=ep[1]+eA+ec[2]):ew=(ey=ep[1]+(eI+eA-eS.displaySize[1])/2)+eS.displaySize[1],{imagePrimary:eS,imageSecondary:void 0,top:ey,right:eb,bottom:ew,left:eT,collisionPadding:eg}}let ed=class ed extends tU{constructor(F,el,eh,ec,ep){super(F,el),this.angle=ec,this.z=eh,void 0!==ep&&(this.segment=ep)}clone(){return new ed(this.x,this.y,this.z,this.angle,this.segment)}};function rd(F,el,eh,ec,ep){if(void 0===el.segment)return!0;let e_=el,eg=el.segment+1,ey=0;for(;ey>-eh/2;){if(--eg<0)return!1;ey-=F[eg].dist(e_),e_=F[eg]}ey+=F[eg].dist(F[eg+1]),eg++;let eb=[],ew=0;for(;ey<eh/2;){let el=F[eg],eh=F[eg+1];if(!eh)return!1;let e_=F[eg-1].angleTo(el)-el.angleTo(eh);for(e_=Math.abs((e_+3*Math.PI)%(2*Math.PI)-Math.PI),eb.push({distance:ey,angleDelta:e_}),ew+=e_;ey-eb[0].distance>ec;)ew-=eb.shift().angleDelta;if(ew>ep)return!1;eg++,ey+=el.dist(eh)}return!0}function nd(F){let el=0;for(let eh=0;eh<F.length-1;eh++)el+=F[eh].dist(F[eh+1]);return el}function sd(F,el){return Math.max(F?F.right-F.left:0,el?el.right-el.left:0)}function ud(F,el,eh,ec,ep){let e_=[];for(let eg=0;eg<F.length;eg++){let ey;let eb=F[eg];for(let F=0;F<eb.length-1;F++){let eg=eb[F],ew=eb[F+1];eg.x<el&&ew.x<el||(eg.x<el?eg=new tU(el,eg.y+(el-eg.x)/(ew.x-eg.x)*(ew.y-eg.y))._round():ew.x<el&&(ew=new tU(el,eg.y+(el-eg.x)/(ew.x-eg.x)*(ew.y-eg.y))._round()),eg.y<eh&&ew.y<eh||(eg.y<eh?eg=new tU(eg.x+(eh-eg.y)/(ew.y-eg.y)*(ew.x-eg.x),eh)._round():ew.y<eh&&(ew=new tU(eg.x+(eh-eg.y)/(ew.y-eg.y)*(ew.x-eg.x),eh)._round()),eg.x>=ec&&ew.x>=ec||(eg.x>=ec?eg=new tU(ec,eg.y+(ec-eg.x)/(ew.x-eg.x)*(ew.y-eg.y))._round():ew.x>=ec&&(ew=new tU(ec,eg.y+(ec-eg.x)/(ew.x-eg.x)*(ew.y-eg.y))._round()),eg.y>=ep&&ew.y>=ep||(eg.y>=ep?eg=new tU(eg.x+(ep-eg.y)/(ew.y-eg.y)*(ew.x-eg.x),ep)._round():ew.y>=ep&&(ew=new tU(eg.x+(ep-eg.y)/(ew.y-eg.y)*(ew.x-eg.x),ep)._round()),ey&&eg.equals(ey[ey.length-1])||(ey=[eg],e_.push(ey)),ey.push(ew)))))}}return e_}function cd(F){let el=0,eh=0;for(let ec of F)el+=ec.w*ec.h,eh=Math.max(eh,ec.w);F.sort((F,el)=>el.h-F.h);let ec=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(el/.95)),eh),h:1/0}],ep=0,e_=0;for(let el of F)for(let F=ec.length-1;F>=0;F--){let eh=ec[F];if(!(el.w>eh.w||el.h>eh.h)){if(el.x=eh.x,el.y=eh.y,e_=Math.max(e_,el.y+el.h),ep=Math.max(ep,el.x+el.w),el.w===eh.w&&el.h===eh.h){let el=ec.pop();F<ec.length&&(ec[F]=el)}else el.h===eh.h?(eh.x+=el.w,eh.w-=el.w):(el.w===eh.w||ec.push({x:eh.x+el.w,y:eh.y,w:eh.w-el.w,h:el.h}),eh.y+=el.h,eh.h-=el.h);break}}return{w:ep,h:e_,fill:el/(ep*e_)||0}}us(ed,"Anchor");let pd=class pd{static getImagePositionScale(F,el,eh){if(el&&F&&F.options&&F.options.transform){let el=F.options.transform;return{x:el.a,y:el.d}}return{x:eh,y:eh}}constructor(F,el,eh,ec){this.paddedRect=F;let{pixelRatio:ep,version:e_,stretchX:eg,stretchY:ey,content:eb,sdf:ew,usvg:eT}=el;this.pixelRatio=ep,this.stretchX=eg,this.stretchY=ey,this.content=eb,this.version=e_,this.padding=eh,this.sdf=ew,this.scale=pd.getImagePositionScale(ec,eT,ep)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}};function fd(F,el,eh){let ec=tr.parse(F),ep=function(F,el,eh=[1,1]){return{x:0,y:0,w:(F.data?F.data.width:F.width*eh[0])+2*el,h:(F.data?F.data.height:F.height*eh[1])+2*el}}(el,eh,[ec.options.transform.a,ec.options.transform.d]);return{bin:ep,imagePosition:new pd(ep,el,eh,ec),imageVariant:ec}}let dd=class dd{constructor(F,el,eh){let ec=new Map,ep=new Map;this.haveRenderCallbacks=[];let e_=[];this.addImages(F,ec,1,e_),this.addImages(el,ep,2,e_);let{w:eg,h:ey}=cd(e_),eb=new pc({width:eg||1,height:ey||1});for(let[el,ep]of F.entries()){let F=ec.get(el).paddedRect;pc.copy(ep.data,eb,{x:0,y:0},{x:F.x+1,y:F.y+1},ep.data,eh,ep.sdf)}for(let[F,ec]of el.entries()){let el=ep.get(F),e_=el.paddedRect,eg=el.padding,ey=e_.x+eg,ew=e_.y+eg,eT=ec.data.width,eS=ec.data.height;eg=eg>1?eg-1:eg,pc.copy(ec.data,eb,{x:0,y:0},{x:ey,y:ew},ec.data,eh),pc.copy(ec.data,eb,{x:0,y:eS-eg},{x:ey,y:ew-eg},{width:eT,height:eg},eh),pc.copy(ec.data,eb,{x:0,y:0},{x:ey,y:ew+eS},{width:eT,height:eg},eh),pc.copy(ec.data,eb,{x:eT-eg,y:0},{x:ey-eg,y:ew},{width:eg,height:eS},eh),pc.copy(ec.data,eb,{x:0,y:0},{x:ey+eT,y:ew},{width:eg,height:eS},eh),pc.copy(ec.data,eb,{x:eT-eg,y:eS-eg},{x:ey-eg,y:ew-eg},{width:eg,height:eg},eh),pc.copy(ec.data,eb,{x:0,y:eS-eg},{x:ey+eT,y:ew-eg},{width:eg,height:eg},eh),pc.copy(ec.data,eb,{x:0,y:0},{x:ey+eT,y:ew+eS},{width:eg,height:eg},eh),pc.copy(ec.data,eb,{x:eT-eg,y:0},{x:ey-eg,y:ew+eS},{width:eg,height:eg},eh)}this.lut=eh,this.image=eb,this.iconPositions=ec,this.patternPositions=ep}addImages(F,el,eh,ec){for(let[ep,e_]of F.entries()){let{bin:F,imagePosition:eg,imageVariant:ey}=fd(ep,e_,eh);el.set(ep,eg),ec.push(F),e_.hasRenderCallback&&this.haveRenderCallbacks.push(ey.id)}}patchUpdatedImages(F,el,eh){for(let ec of(this.haveRenderCallbacks=this.haveRenderCallbacks.filter(el=>F.hasImage(el,eh)),F.dispatchRenderCallbacks(this.haveRenderCallbacks,eh),F.getUpdatedImages(eh))){for(let ep of this.iconPositions.keys()){let e_=tr.parse(ep);if(we.isEqual(e_.id,ec)){let e_=F.getImage(ec,eh);this.patchUpdatedImage(this.iconPositions.get(ep),e_,el)}}for(let ep of this.patternPositions.keys()){let e_=tr.parse(ep);if(we.isEqual(e_.id,ec)){let e_=F.getImage(ec,eh);this.patchUpdatedImage(this.patternPositions.get(ep),e_,el)}}}}patchUpdatedImage(F,el,eh){if(!F||!el||F.version===el.version)return;F.version=el.version;let[ec,ep]=F.tl,e_=F.sdf;if(this.lut||e_){let F={width:el.data.width,height:el.data.height},eg=new pc(F);pc.copy(el.data,eg,{x:0,y:0},{x:0,y:0},F,this.lut,e_),eh.update(eg,{position:{x:ec,y:ep}})}else eh.update(el.data,{position:{x:ec,y:ep}})}};function yd(F,el,eh,ec,ep,e_,eg,ey,eb){for(let ew=el;ew<el+ec;ew++)gd(F,eh*e_+ew,e_,ep,eg,ey,eb);for(let ew=eh;ew<eh+ep;ew++)gd(F,ew*e_+el,1,ec,eg,ey,eb)}function gd(F,el,eh,ec,ep,e_,eg){e_[0]=0,eg[0]=-1e20,eg[1]=1e20,ep[0]=F[el];for(let ey=1,eb=0,ew=0;ey<ec;ey++){ep[ey]=F[el+ey*eh];let ec=ey*ey;do{let F=e_[eb];ew=(ep[ey]-ep[F]+ec-F*F)/(ey-F)/2}while(ew<=eg[eb]&&--eb>-1);e_[++eb]=ey,eg[eb]=ew,eg[eb+1]=1e20}for(let ey=0,eb=0;ey<ec;ey++){for(;eg[eb+1]<ey;)eb++;let ec=e_[eb],ew=ey-ec;F[el+ey*eh]=ep[ec]+ew*ew}}us(pd,"ImagePosition"),us(dd,"ImageAtlas");let nu={none:0,ideographs:1,all:2};let bd=class bd{constructor(F,el,eh){this.requestManager=F,this.localGlyphMode=el,this.localFontFamily=eh,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(F,el){this.urls[el]=F}getGlyphs(F,el,eh){let ec=[],ep=this.urls[el]||tY.GLYPHS_URL;for(let el in F)for(let eh of F[el])ec.push({stack:el,id:eh});rt(ec,({stack:F,id:el},eh)=>{let ec=this.entries[F];ec||(ec=this.entries[F]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let e_=ec.glyphs[el];if(void 0!==e_)return void eh(null,{stack:F,id:el,glyph:e_});if(e_=this._tinySDF(ec,F,el))return ec.glyphs[el]=e_,void eh(null,{stack:F,id:el,glyph:e_});let eg=Math.floor(el/256);if(256*eg>65535)return pt("glyphs > 65535 not supported"),void eh(null,{stack:F,id:el,glyph:e_});if(ec.ranges[eg])return void eh(null,{stack:F,id:el,glyph:e_});let ey=ec.requests[eg];ey||(ey=ec.requests[eg]=[],bd.loadGlyphRange(F,eg,ep,this.requestManager,(F,el)=>{if(el){for(let F in ec.ascender=el.ascender,ec.descender=el.descender,el.glyphs)this._doesCharSupportLocalGlyph(+F)||(ec.glyphs[+F]=el.glyphs[+F]);ec.ranges[eg]=!0}for(let eh of ey)eh(F,el);delete ec.requests[eg]})),ey.push((ec,ep)=>{ec?eh(ec):ep&&eh(null,{stack:F,id:el,glyph:ep.glyphs[el]||null})})},(F,el)=>{if(F)eh(F);else if(el){let F={};for(let{stack:eh,id:ec,glyph:ep}of el)void 0===F[eh]&&(F[eh]={}),void 0===F[eh].glyphs&&(F[eh].glyphs={}),F[eh].glyphs[ec]=ep&&{id:ep.id,bitmap:ep.bitmap.clone(),metrics:ep.metrics},F[eh].ascender=this.entries[eh].ascender,F[eh].descender=this.entries[eh].descender;eh(null,F)}})}_doesCharSupportLocalGlyph(F){return this.localGlyphMode!==nu.none&&(this.localGlyphMode===nu.all?!!this.localFontFamily:!!this.localFontFamily&&(ri["CJK Unified Ideographs"](F)||ri["Hangul Syllables"](F)||ri.Hiragana(F)||ri.Katakana(F)||ri["CJK Symbols and Punctuation"](F)||ri["CJK Unified Ideographs Extension A"](F)||ri["CJK Unified Ideographs Extension B"](F)||ri.Osage(F)))}_tinySDF(F,el,eh){let ec=this.localFontFamily;if(!ec||!this._doesCharSupportLocalGlyph(eh))return;let ep=F.tinySDF;if(!ep){let eh="400";/bold/i.test(el)?eh="900":/medium/i.test(el)?eh="500":/light/i.test(el)&&(eh="200"),(ep=F.tinySDF=new bd.TinySDF({fontFamily:ec,fontWeight:eh,fontSize:48,buffer:6,radius:16})).fontWeight=eh}if(this.localGlyphs[ep.fontWeight][eh])return this.localGlyphs[ep.fontWeight][eh];let e_=String.fromCodePoint(eh),{data:eg,width:ey,height:eb,glyphWidth:ew,glyphHeight:eT,glyphLeft:eS,glyphTop:eE,glyphAdvance:eM}=ep.draw(e_);return this.localGlyphs[ep.fontWeight][eh]={id:eh,bitmap:new hc({width:ey,height:eb},eg),metrics:{width:ew/2,height:eT/2,left:eS/2,top:eE/2-27,advance:eM/2,localGlyph:!0}}}};function wd(F,el){return F+el[1]-el[0]}function Md(F,el,eh,ec,ep=1){let e_=[],eg=F.imagePrimary,ey=eg.pixelRatio,eb=eg.paddedRect.w-2,ew=eg.paddedRect.h-2,eT=(F.right-F.left)*ep,eS=(F.bottom-F.top)*ep,eE=eg.stretchX||[[0,eb]],eM=eg.stretchY||[[0,ew]],eI=eE.reduce(wd,0),eA=eM.reduce(wd,0),eC=eb-eI,eP=ew-eA,ez=0,eD=eI,eR=0,eL=eA,eO=0,ek=eC,eF=0,eB=eP;if(eg.content&&ec){let F=eg.content;ez=Ad(eE,0,F[0]),eR=Ad(eM,0,F[1]),eD=Ad(eE,F[0],F[2]),eL=Ad(eM,F[1],F[3]),eO=F[0]-ez,eF=F[1]-eR,ek=F[2]-F[0]-eD,eB=F[3]-F[1]-eL}let S=(ec,e_,eb,ew)=>{var eE,eM,eC,eP,eN,eV,eU,ej,eG,eq,e$,eH;let eZ=(ec.stretch-ez)/eD*eT+F.left*ep,eW=(eC=ec.fixed-eO,eC-ek*ec.stretch/eI),eY=(e_.stretch-eR)/eL*eS+F.top*ep,eX=(eV=e_.fixed-eF,eV-eB*e_.stretch/eA),eK=(eb.stretch-ez)/eD*eT+F.left*ep,eJ=(eG=eb.fixed-eO,eG-ek*eb.stretch/eI),eQ=(ew.stretch-eR)/eL*eS+F.top*ep,e0=(eH=ew.fixed-eF,eH-eB*ew.stretch/eA),e1=new tU(eZ,eY),e2=new tU(eK,eY),e3=new tU(eK,eQ),e4=new tU(eZ,eQ),e5=new tU(eW/ey,eX/ey),e6=new tU(eJ/ey,e0/ey),e8=el*Math.PI/180;if(e8){let F=Math.sin(e8),el=Math.cos(e8),eh=[el,-F,F,el];e1._matMult(eh),e2._matMult(eh),e4._matMult(eh),e3._matMult(eh)}let e9=ec.stretch+ec.fixed,e7=eb.stretch+eb.fixed,tn=e_.stretch+e_.fixed,th=ew.stretch+ew.fixed,tc=F.imageSecondary;return{tl:e1,tr:e2,bl:e4,br:e3,texPrimary:{x:eg.paddedRect.x+1+e9,y:eg.paddedRect.y+1+tn,w:e7-e9,h:th-tn},texSecondary:tc?{x:tc.paddedRect.x+1+e9,y:tc.paddedRect.y+1+tn,w:e7-e9,h:th-tn}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:e5,pixelOffsetBR:e6,minFontScaleX:ek/ey/eT,minFontScaleY:eB/ey/eS,isSDF:eh}};if(ec&&(eg.stretchX||eg.stretchY)){let F=Id(eE,eC,eI),el=Id(eM,eP,eA);for(let eh=0;eh<F.length-1;eh++){let ec=F[eh],ep=F[eh+1];for(let F=0;F<el.length-1;F++)e_.push(S(ec,el[F],ep,el[F+1]))}}else e_.push(S({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:eb+1},{fixed:0,stretch:ew+1}));return e_}function Ad(F,el,eh){let ec=0;for(let ep of F)ec+=Math.max(el,Math.min(eh,ep[1]))-Math.max(el,Math.min(eh,ep[0]));return ec}function Id(F,el,eh){let ec=[{fixed:-1,stretch:0}];for(let[el,eh]of F){let F=ec[ec.length-1];ec.push({fixed:el-F.stretch,stretch:F.stretch}),ec.push({fixed:el-F.stretch,stretch:F.stretch+(eh-el)})}return ec.push({fixed:el+1,stretch:eh}),ec}function kd(F,el){return el.max-F.max}bd.loadGlyphRange=function(F,el,eh,ec,ep){let e_=256*el,eg=e_+255,ey=ec.transformRequest(ec.normalizeGlyphsURL(eh).replace("{fontstack}",F).replace("{range}",`${e_}-${eg}`),t9.Glyphs);ne(ey,(F,el)=>{if(F)ep(F);else if(el){let F={},eh=new a9(el).readFields(Rf,{});for(let el of eh.glyphs)F[el.id]=el;ep(null,{glyphs:F,ascender:eh.ascender,descender:eh.descender})}})},bd.TinySDF=class{constructor({fontSize:F=24,buffer:el=3,radius:eh=8,cutoff:ec=.25,fontFamily:ep="sans-serif",fontWeight:e_="normal",fontStyle:eg="normal"}={}){this.buffer=el,this.cutoff=ec,this.radius=eh;let ey=this.size=F+4*el,eb=this._createCanvas(ey),ew=this.ctx=eb.getContext("2d",{willReadFrequently:!0});ew.font=`${eg} ${e_} ${F}px ${ep}`,ew.textBaseline="alphabetic",ew.textAlign="left",ew.fillStyle="black",this.gridOuter=new Float64Array(ey*ey),this.gridInner=new Float64Array(ey*ey),this.f=new Float64Array(ey),this.z=new Float64Array(ey+1),this.v=new Uint16Array(ey)}_createCanvas(F){let el=document.createElement("canvas");return el.width=el.height=F,el}draw(F){let{width:el,actualBoundingBoxAscent:eh,actualBoundingBoxDescent:ec,actualBoundingBoxLeft:ep,actualBoundingBoxRight:e_}=this.ctx.measureText(F),eg=Math.ceil(eh),ey=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(e_-ep))),eb=Math.min(this.size-this.buffer,eg+Math.ceil(ec)),ew=ey+2*this.buffer,eT=eb+2*this.buffer,eS=Math.max(ew*eT,0),eE=new Uint8ClampedArray(eS),eM={data:eE,width:ew,height:eT,glyphWidth:ey,glyphHeight:eb,glyphTop:eg,glyphLeft:0,glyphAdvance:el};if(0===ey||0===eb)return eM;let{ctx:eI,buffer:eA,gridInner:eC,gridOuter:eP}=this;eI.clearRect(eA,eA,ey,eb),eI.fillText(F,eA,eA+eg);let ez=eI.getImageData(eA,eA,ey,eb);eP.fill(1e20,0,eS),eC.fill(0,0,eS);for(let F=0;F<eb;F++)for(let el=0;el<ey;el++){let eh=ez.data[4*(F*ey+el)+3]/255;if(0===eh)continue;let ec=(F+eA)*ew+el+eA;if(1===eh)eP[ec]=0,eC[ec]=1e20;else{let F=.5-eh;eP[ec]=F>0?F*F:0,eC[ec]=F<0?F*F:0}}yd(eP,0,0,ew,eT,ew,this.f,this.v,this.z),yd(eC,eA,eA,ey,eb,ew,this.f,this.v,this.z);for(let F=0;F<eS;F++){let el=Math.sqrt(eP[F])-Math.sqrt(eC[F]);eE[F]=Math.round(255-255*(el/this.radius+this.cutoff))}return eM}};let Td=class Td{constructor(F,el,eh,ec){this.p=new tU(F,el),this.h=eh,this.d=function(F,el){let eh=!1,ec=1/0;for(let ep=0;ep<el.length;ep++){let e_=el[ep];for(let el=0,ep=e_.length,eg=ep-1;el<ep;eg=el++){let ep=e_[el],ey=e_[eg];ep.y>F.y!=ey.y>F.y&&F.x<(ey.x-ep.x)*(F.y-ep.y)/(ey.y-ep.y)+ep.x&&(eh=!eh),ec=Math.min(ec,Gl(F,ep,ey))}}return(eh?1:-1)*Math.sqrt(ec)}(this.p,ec),this.max=this.d+this.h*Math.SQRT2}};let np=Number.POSITIVE_INFINITY,nm=Math.sqrt(2);function Cd(F,[el,eh]){let ec=0,ep=0;if(eh===np){el<0&&(el=0);let eh=el/nm;switch(F){case"top-right":case"top-left":ep=eh-7;break;case"bottom-right":case"bottom-left":ep=7-eh;break;case"bottom":ep=7-el;break;case"top":ep=el-7}switch(F){case"top-right":case"bottom-right":ec=-eh;break;case"top-left":case"bottom-left":ec=eh;break;case"left":ec=el;break;case"right":ec=-el}}else{switch(el=Math.abs(el),eh=Math.abs(eh),F){case"top-right":case"top-left":case"top":ep=eh-7;break;case"bottom-right":case"bottom-left":case"bottom":ep=7-eh}switch(F){case"top-right":case"bottom-right":case"right":ec=-el;break;case"top-left":case"bottom-left":case"left":ec=el}}return[ec,ep]}function Dd(F,el,eh,ec,ep,e_,eg,ey){if(!F)return;let eb=vf(el,eh,ec,ep,e_);return F.scaleSelf(eb*ey*eg)}function Rd(F,el,eh,ec,ep,e_,eg,ey){return{iconPrimary:Dd(F.getPrimary(),el,eh,ec,ep,e_,eg,ey),iconSecondary:Dd(F.getSecondary(),el,eh,ec,ep,e_,eg,ey)}}function Ld(F,el,eh,ec){if(!F)return;let ep=el.get(eh.toString());if(F.imagePrimary=ep,ec){let eh=el.get(ec.toString());F.imageSecondary=eh}}function Od(F,el){if(F){for(let eh of F.positionedLines)for(let F of eh.positionedGlyphs)if(null!==F.image){let eh=F.image.toString();F.rect=el.get(eh).paddedRect}}}function Nd(F){switch(F){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function Gd(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP){let ez=function(F,el,eh,ec,ep,e_,eg,ey){let eb=[];if(0===el.positionedLines.length)return eb;let ew=ec.layout.get("text-rotate").evaluate(e_,{})*Math.PI/180,eT=function(F){let el=F[0],eh=F[1],ec=el*eh;return ec>0?[el,-eh]:ec<0?[-el,eh]:0===el?[eh,el]:[eh,-el]}(eh),eS=Math.abs(el.top-el.bottom);for(let F of el.positionedLines)eS-=F.lineOffset;let eE=el.positionedLines.length,eM=eS/eE,eI=el.top-eh[1];for(let F=0;F<eE;++F){let ec=el.positionedLines[F];for(let e_ of(eI=function(F,el,eh,ec){let ep=el+F.positionedLines[ec].lineOffset;return 0===ec?eh+ep/2:eh+(ep+(el+F.positionedLines[ec-1].lineOffset))/2}(el,eM,eI,F),ec.positionedGlyphs)){let F,ec,eS,eE;if(!e_.rect)continue;let eM=e_.rect||{},eA=4,eC=!0,eP=1,ez=0;if(e_.image){let F=eg.get(e_.image.toString());if(!F)continue;if(F.sdf){pt("SDF images are not supported in formatted text and will be ignored.");continue}eC=!1,eA=1/(eP=F.pixelRatio)}let eD=(ep||ey)&&e_.vertical,eR=e_.metrics.advance*e_.scale/2,eL=e_.metrics,eO=e_.rect;if(null===eO)continue;ey&&el.verticalizable&&(ez=e_.image?eR-e_.metrics.width*e_.scale/2:0);let ek=ep?[e_.x+eR,e_.y]:[0,0],eF=[0,0],eB=[0,0],eN=!1;ep||(eD?(eB=[e_.x+eR+eT[0],e_.y+eT[1]-ez],eN=!0):eF=[e_.x+eR+eh[0],e_.y+eh[1]-ez]);let eV=eO.w*e_.scale/(eP*(e_.localGlyph?2:1)),eU=eO.h*e_.scale/(eP*(e_.localGlyph?2:1));if(eD){let el=e_.y-eI,eh=new tU(-eR,eR-el),ep=-Math.PI/2,eg=new tU(...eB);(F=new tU(-eR+eF[0],eF[1]))._rotateAround(ep,eh)._add(eg),F.x+=-el+eR,F.y-=(eL.left-eA)*e_.scale;let ey=e_.image?eL.advance*e_.scale:24*e_.scale,eb=String.fromCodePoint(e_.glyph);""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb?F.x+=(1-eA)*e_.scale:""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb||""===eb?F.x+=ey-eL.height*e_.scale+(-eA-1)*e_.scale:F.x+=e_.image||eL.width+2*eA===eO.w&&eL.height+2*eA===eO.h?(ey-eU)/2:(ey-(eL.height+2*eA)*e_.scale)/2,ec=new tU(F.x,F.y-eV),eS=new tU(F.x+eU,F.y),eE=new tU(F.x+eU,F.y-eV)}else{let el=(eL.left-eA)*e_.scale-eR+eF[0],eh=(-eL.top-eA)*e_.scale+eF[1],ep=el+eV,eg=eh+eU;F=new tU(el,eh),ec=new tU(ep,eh),eS=new tU(el,eg),eE=new tU(ep,eg)}if(ew){let el;el=ep?new tU(0,0):eN?new tU(eT[0],eT[1]):new tU(eh[0],eh[1]),F._rotateAround(ew,el),ec._rotateAround(ew,el),eS._rotateAround(ew,el),eE._rotateAround(ew,el)}let ej=new tU(0,0),eG=new tU(0,0);eb.push({tl:F,tr:ec,bl:eS,br:eE,texPrimary:eM,texSecondary:void 0,writingMode:el.writingMode,glyphOffset:ek,sectionIndex:e_.sectionIndex,isSDF:eC,pixelOffsetTL:ej,pixelOffsetBR:eG,minFontScaleX:0,minFontScaleY:0})}}return eb}(0,ec,eb,e_,eg,ey,ep,F.allowVerticalPlacement),eD=F.textSizeData,eR=null;for(let ec of("source"===eD.kind?(eR=[128*e_.layout.get("text-size").evaluate(ey,{},eC)*eI.textScaleFactor])[0]>32640&&pt(`${F.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`):"composite"===eD.kind&&((eR=[128*eI.compositeTextSizes[0].evaluate(ey,{},eC)*eI.textScaleFactor,128*eI.compositeTextSizes[1].evaluate(ey,{},eC)*eI.textScaleFactor])[0]>32640||eR[1]>32640)&&pt(`${F.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`),F.addSymbols(F.text,ez,eR,eb,eg,ey,eT,el,eh,ew.lineStartIndex,ew.lineLength,eM,eA,eC,eP,!1),eS))eE[ec]=F.text.placedSymbolArray.length-1;return 4*ez.length}function Yd(F){for(let el in F)return F[el];return null}function Hd(F,el,eh,ec,ep,e_,eg,ey,eb,ew){let eT=eg.top,eS=eg.bottom,eE=eg.left,eM=eg.right,eI=eg.collisionPadding;if(eI&&(eE-=eI[0],eT-=eI[1],eM+=eI[2],eS+=eI[3]),eb){let F=new tU(eE,eT),el=new tU(eM,eT),eh=new tU(eE,eS),ec=new tU(eM,eS),ep=eb*tj,e_=new tU(0,0);ew&&(e_=new tU(ew[0],ew[1])),F._rotateAround(ep,e_),el._rotateAround(ep,e_),eh._rotateAround(ep,e_),ec._rotateAround(ep,e_),eE=Math.min(F.x,el.x,eh.x,ec.x),eM=Math.max(F.x,el.x,eh.x,ec.x),eT=Math.min(F.y,el.y,eh.y,ec.y),eS=Math.max(F.y,el.y,eh.y,ec.y)}return F.emplaceBack(el.x,el.y,el.z,eh.x,eh.y,eE,eT,eM,eS,ey,ec,ep,e_),F.length-1}function Xd(F){F.collisionPadding&&(F.top-=F.collisionPadding[1],F.bottom+=F.collisionPadding[3]);let el=F.bottom-F.top;return el>0?Math.max(10,el):null}function Wd(F,el){let eh=F.fovAboveCenter,ec=F.elevation?F.elevation.getMinElevationBelowMSL()*el:0,ep=(F._camera.position[2]*F.worldSize-ec)/Math.cos(F._pitch),e_=Math.sin(eh)*ep/Math.sin(Math.max(Math.PI/2-F._pitch-eh,.01)),eg=Math.sin(F._pitch)*e_+ep,ey=ep*(1/F._horizonShift);if(!F.elevation||0===F.elevation.exaggeration()){let el=Math.max(F.zoom-17,0);F.isOrthographic&&(el/=10),eg*=1+el}return Math.min(1.01*eg,ey)}function Kd(F,el){if(!el.isReprojectedInTileSpace)return{scale:1<<F.z,x:F.x,y:F.y,x2:F.x+1,y2:F.y+1,projection:el};let eh=Math.pow(2,-F.z),ec=F.x*eh,ep=(F.x+1)*eh,e_=F.y*eh,eg=(F.y+1)*eh,ey=gl(ec),eb=gl(ep),ew=xl(e_),eT=xl(eg),eS=el.project(ey,ew),eE=el.project(eb,ew),eM=el.project(eb,eT),eI=el.project(ey,eT),eA=Math.min(eS.x,eE.x,eM.x,eI.x),eC=Math.min(eS.y,eE.y,eM.y,eI.y),eP=Math.max(eS.x,eE.x,eM.x,eI.x),ez=Math.max(eS.y,eE.y,eM.y,eI.y),eD=eh/16;function b(F,eh,ec,ep,e_,eg){let ey=(ec+e_)/2,eb=(ep+eg)/2,ew=el.project(gl(ey),xl(eb)),eT=Math.max(0,eA-ew.x,eC-ew.y,ew.x-eP,ew.y-ez);eA=Math.min(eA,ew.x),eP=Math.max(eP,ew.x),eC=Math.min(eC,ew.y),ez=Math.max(ez,ew.y),eT>eD&&(b(F,ew,ec,ep,ey,eb),b(ew,eh,ey,eb,e_,eg))}b(eS,eE,ec,e_,ep,e_),b(eE,eM,ep,e_,ep,eg),b(eM,eI,ep,eg,ec,eg),b(eI,eS,ec,eg,ec,e_),eA-=eD,eC-=eD,eP+=eD,ez+=eD;let eR=1/Math.max(eP-eA,ez-eC);return{scale:eR,x:eA*eR,y:eC*eR,x2:eP*eR,y2:ez*eR,projection:el}}function Jd(F,{x:el,y:eh},ec=0){return new tU(((el-ec)*F.scale-F.x)*8192,(eh*F.scale-F.y)*8192)}let n_=tN.mat4.identity(new Float32Array(16));let tm=class tm{constructor(F){this.spec=F,this.name=F.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(F,el){return{x:0,y:0,z:0}}unproject(F,el){return new ul(0,0)}projectTilePoint(F,el,eh){return{x:F,y:el,z:0}}locationPoint(F,el,eh,ec=!0){return F._coordinatePoint(F.locationCoordinate(el,eh),ec)}pixelsPerMeter(F,el){return 1/fl(F)*el}pixelSpaceConversion(F,el,eh){return 1}farthestPixelDistance(F){return Wd(F,F.pixelsPerMeter)}pointCoordinate(F,el,eh,ec){let ep=F.horizonLineFromTop(!1),e_=new tU(el,Math.max(ep,eh));return F.rayIntersectionCoordinate(F.pointRayIntersection(e_,ec))}pointCoordinate3D(F,el,eh){let ec=new tU(el,eh);if(F.elevation)return F.elevation.pointCoordinate(ec);{let el=this.pointCoordinate(F,ec.x,ec.y,0);return[el.x,el.y,el.z]}}isPointAboveHorizon(F,el){if(F.elevation&&F.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(F,el.x,el.y);let eh=F.horizonLineFromTop();return el.y<eh}createInversionMatrix(F,el){return n_}createTileMatrix(F,el,eh){let ec,ep,e_;let eg=eh.canonical,ey=tN.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){let eb=Kd(eg,this);ec=1,ep=eb.x+eh.wrap*eb.scale,e_=eb.y,tN.mat4.scale(ey,ey,[ec/eb.scale,ec/eb.scale,F.pixelsPerMeter/el])}else ec=el/F.zoomScale(eg.z),ep=(eg.x+Math.pow(2,eg.z)*eh.wrap)*ec,e_=eg.y*ec;return tN.mat4.translate(ey,ey,[ep,e_,0]),tN.mat4.scale(ey,ey,[ec/8192,ec/8192,1]),ey}upVector(F,el,eh){return[0,0,1]}upVectorScale(F,el,eh){return{metersToTile:1}}};let em=class em extends tm{constructor(F){super(F),this.range=[4,7],this.center=F.center||[-96,37.5];let[el,eh]=this.parallels=F.parallels||[29.5,45.5],ec=Math.sin(el*tj);this.n=(ec+Math.sin(eh*tj))/2,this.c=1+ec*(2*this.n-ec),this.r0=Math.sqrt(this.c)/this.n}project(F,el){let{n:eh,c:ec,r0:ep}=this,e_=(F-this.center[0])*tj,eg=el*tj,ey=Math.sqrt(ec-2*eh*Math.sin(eg))/eh;return{x:ey*Math.sin(e_*eh),y:ey*Math.cos(e_*eh)-ep,z:0}}unproject(F,el){let{n:eh,c:ec,r0:ep}=this,e_=ep+el,eg=Math.atan2(F,Math.abs(e_))*Math.sign(e_);e_*eh<0&&(eg-=Math.PI*Math.sign(F)*Math.sign(e_));let ey=this.center[0]*tj*eh;eg=et(eg,-Math.PI-ey,Math.PI-ey);let eb=Q(eg/eh*tG+this.center[0],-180,180),ew=Math.asin(Q((ec-(F*F+e_*e_)*eh*eh)/(2*eh),-1,1)),eT=Q(ew*tG,-85.051129,85.051129);return new ul(eb,eT)}};let nx=Math.sqrt(3)/2;let om=class om extends tm{project(F,el){el=el/180*Math.PI,F=F/180*Math.PI;let eh=Math.asin(nx*Math.sin(el)),ec=eh*eh,ep=ec*ec*ec;return{x:.5*(F*Math.cos(eh)/(nx*(1.340264+-.24331799999999998*ec+ep*(.0062510000000000005+.034164*ec)))/Math.PI+.5),y:1-.5*(eh*(1.340264+-.081106*ec+ep*(893e-6+.003796*ec))/Math.PI+1),z:0}}unproject(F,el){F=(2*F-.5)*Math.PI;let eh=el=(2*(1-el)-1)*Math.PI,ec=eh*eh,ep=ec*ec*ec;for(let F,e_,eg=0;eg<12&&(e_=eh*(1.340264+-.081106*ec+ep*(893e-6+.003796*ec))-el,ep=(ec=(eh=Q(eh-(F=e_/(1.340264+-.24331799999999998*ec+ep*(.0062510000000000005+.034164*ec))),-Math.PI/3,Math.PI/3))*eh)*ec*ec,!(1e-12>Math.abs(F)));++eg);let e_=nx*F*(1.340264+-.24331799999999998*ec+ep*(.0062510000000000005+.034164*ec))/Math.cos(eh),eg=Math.asin(Math.sin(eh)/nx),ey=Q(180*e_/Math.PI,-180,180),eb=Q(180*eg/Math.PI,-85.051129,85.051129);return new ul(ey,eb)}};let lm=class lm extends tm{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0}project(F,el){return{x:.5+F/360,y:.5-el/360,z:0}}unproject(F,el){let eh=Q(360*(.5-el),-85.051129,85.051129);return new ul(360*(F-.5),eh)}};let nb=Math.PI/2;function cm(F){return Math.tan((nb+F)/2)}let hm=class hm extends tm{constructor(F){super(F),this.center=F.center||[0,30];let[el,eh]=this.parallels=F.parallels||[30,30],ec=el*tj,ep=eh*tj;this.southernCenter=ec+ep<0,this.southernCenter&&(ec=-ec,ep=-ep);let e_=Math.cos(ec),eg=cm(ec);this.n=ec===ep?Math.sin(ec):Math.log(e_/Math.cos(ep))/Math.log(cm(ep)/eg),this.f=e_*Math.pow(cm(ec),this.n)/this.n}project(F,el){el*=tj,this.southernCenter&&(el=-el),F=(F-this.center[0])*tj;let{n:eh,f:ec}=this;ec>0?el<-nb+1e-6&&(el=-nb+1e-6):el>nb-1e-6&&(el=nb-1e-6);let ep=ec/Math.pow(cm(el),eh),e_=ep*Math.sin(eh*F),eg=ec-ep*Math.cos(eh*F);return e_=.5*(e_/Math.PI+.5),eg=.5*(eg/Math.PI+.5),{x:e_,y:this.southernCenter?eg:1-eg,z:0}}unproject(F,el){F=(2*F-.5)*Math.PI,this.southernCenter&&(el=1-el),el=(2*(1-el)-.5)*Math.PI;let{n:eh,f:ec}=this,ep=ec-el,e_=Math.sign(ep),eg=Math.sign(eh)*Math.sqrt(F*F+ep*ep),ey=Math.atan2(F,Math.abs(ep))*e_;ep*eh<0&&(ey-=Math.PI*Math.sign(F)*e_);let eb=Q(ey/eh*tG+this.center[0],-180,180),ew=Q((2*Math.atan(Math.pow(ec/eg,1/eh))-nb)*tG,-85.051129,85.051129);return new ul(eb,this.southernCenter?-ew:ew)}};let pm=class pm extends tm{constructor(F){super(F),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(F,el){return{x:dl(F),y:ml(el),z:0}}unproject(F,el){let eh=gl(F),ec=xl(el);return new ul(eh,ec)}};let nw=85.051129*tj;let dm=class dm extends tm{project(F,el){let eh=(el*=tj)*el,ec=eh*eh;return{x:.5*((F*=tj)*(.8707-.131979*eh+ec*(ec*(.003971*eh-.001529*ec)-.013791))/Math.PI+.5),y:1-.5*(el*(1.007226+eh*(.015085+ec*(.028874*eh-.044475-.005916*ec)))/Math.PI+1),z:0}}unproject(F,el){F=(2*F-.5)*Math.PI;let eh=el=(2*(1-el)-1)*Math.PI,ec=25,ep=0,e_=eh*eh;do{e_=eh*eh;let F=e_*e_;ep=(eh*(1.007226+e_*(.015085+F*(.028874*e_-.044475-.005916*F)))-el)/(1.007226+e_*(.045255+F*(.259866*e_-.311325-.005916*11*F))),eh=Q(eh-ep,-nw,nw)}while(Math.abs(ep)>1e-6&&--ec>0);e_=eh*eh;let eg=Q(F/(.8707+e_*(e_*(e_*e_*e_*(.003971-.001529*e_)-.013791)-.131979))*tG,-180,180),ey=eh*tG;return new ul(eg,ey)}};let nT=85.051129*tj;let ym=class ym extends tm{project(F,el){el*=tj,F*=tj;let eh=Math.cos(el),ec=2/Math.PI,ep=Math.acos(eh*Math.cos(F/2)),e_=Math.sin(ep)/ep,eg=.5*(F*ec+2*eh*Math.sin(F/2)/e_)||0,ey=.5*(el+Math.sin(el)/e_)||0;return{x:.5*(eg/Math.PI+.5),y:1-.5*(ey/Math.PI+1),z:0}}unproject(F,el){let eh=F=(2*F-.5)*Math.PI,ec=el=(2*(1-el)-1)*Math.PI,ep=25,e_=0,eg=0;do{let ep=Math.cos(ec),ey=Math.sin(ec),eb=2*ey*ep,ew=ey*ey,eT=ep*ep,eS=Math.cos(eh/2),eE=Math.sin(eh/2),eM=2*eS*eE,eI=eE*eE,eA=1-eT*eS*eS,eC=eA?1/eA:0,eP=eA?Math.acos(ep*eS)*Math.sqrt(1/eA):0,ez=.5*(2*eP*ep*eE+2*eh/Math.PI)-F,eD=.5*(eP*ey+ec)-el,eR=.5*eC*(eT*eI+eP*ep*eS*ew)+1/Math.PI,eL=eC*(eM*eb/4-eP*ey*eE),eO=.125*eC*(eb*eE-eP*ey*eT*eM),ek=.5*eC*(ew*eS+eP*eI*ep)+.5,eF=eL*eO-ek*eR;e_=(eD*eL-ez*ek)/eF,eg=(ez*eO-eD*eR)/eF,eh=Q(eh-e_,-Math.PI,Math.PI),ec=Q(ec-eg,-nT,nT)}while((Math.abs(e_)>1e-6||Math.abs(eg)>1e-6)&&--ep>0);return new ul(eh*tG,ec*tG)}};let gm=class gm extends tm{constructor(F){super(F),this.center=F.center||[0,0],this.parallels=F.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(this.parallels[0]*tj)),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(F,el){let{scale:eh,cosPhi:ec}=this;return{x:F*tj*ec*eh+.5,y:-Math.sin(el*tj)/ec*eh+.5,z:0}}unproject(F,el){let{scale:eh,cosPhi:ec}=this,ep=-(el-.5)/eh,e_=Q((F-.5)/eh*tG/ec,-180,180),eg=Math.asin(Q(ep*ec,-1,1)),ey=Q(eg*tG,-85.051129,85.051129);return new ul(e_,ey)}};let xm=class xm extends pm{constructor(F){super(F),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(F,el,eh){let ec=Ru(F,el,eh),ep=Ou(ku(eh));return tN.vec3.transformMat4(ec,ec,ep),{x:ec[0],y:ec[1],z:ec[2]}}locationPoint(F,el,eh){let ec=al(el.lat,el.lng),ep=tN.vec3.normalize([],ec),e_=eh?F._centerAltitude+eh:F.elevation?F.elevation.getAtPointOrZero(F.locationCoordinate(el),F._centerAltitude):F._centerAltitude,eg=1/fl(0)*8192*e_;tN.vec3.scaleAndAdd(ec,ec,ep,eg);let ey=tN.mat4.identity(new Float64Array(16));return tN.mat4.multiply(ey,F.pixelMatrix,F.globeMatrix),tN.vec3.transformMat4(ec,ec,ey),new tU(ec[0],ec[1])}pixelsPerMeter(F,el){return 1/fl(0)*el}pixelSpaceConversion(F,el,eh){let ec=1/fl(F)*el,ep=Ee(1/fl(45)*el,ec,eh);return this.pixelsPerMeter(F,el)/ep}createTileMatrix(F,el,eh){let ec=Nu(ku(eh.canonical));return tN.mat4.multiply(new Float64Array(16),F.globeMatrix,ec)}createInversionMatrix(F,el){let{center:eh}=F,ec=Ou(ku(el));return tN.mat4.rotateY(ec,ec,eh.lng*tj),tN.mat4.rotateX(ec,ec,eh.lat*tj),tN.mat4.scale(ec,ec,[F._pixelsPerMercatorPixel,F._pixelsPerMercatorPixel,1]),Float32Array.from(ec)}pointCoordinate(F,el,eh,ec){return Pu(F,el,eh,!0)||new Il(0,0)}pointCoordinate3D(F,el,eh){let ec=this.pointCoordinate(F,el,eh,0);return[ec.x,ec.y,ec.z]}isPointAboveHorizon(F,el){return!Pu(F,el.x,el.y,!1)}farthestPixelDistance(F){let el=function(F,el){let eh;let ec=F.cameraToCenterDistance,ep=F._centerAltitude*el,e_=F._camera,eg=F._camera.forward(),ey=tN.vec3.add([],tN.vec3.scale([],eg,-ec),[0,0,ep]),eb=F.worldSize/(2*Math.PI),ew=[0,0,-eb],eT=F.width/F.height,eS=Math.tan(F.fovAboveCenter),eE=tN.vec3.scale([],e_.up(),eS),eM=tN.vec3.scale([],e_.right(),eS*eT),eI=tN.vec3.normalize([],tN.vec3.add([],tN.vec3.add([],eg,eE),eM)),eA=[];if(new gu(ey,eI).closestPointOnSphere(ew,eb,eA)){let el=tN.vec3.add([],eA,ew),ec=tN.vec3.sub([],el,ey);eh=Math.cos(F.fovAboveCenter)*tN.vec3.length(ec)}else{let F=tN.vec3.sub([],ey,ew),el=tN.vec3.sub([],ew,ey);tN.vec3.normalize(el,el);let ec=tN.vec3.length(F)-eb;eh=Math.sqrt(ec*(ec+2*eb));let ep=Math.acos(eh/(eb+ec))-Math.acos(tN.vec3.dot(eg,el));eh*=Math.cos(ep)}return 1.01*eh}(F,this.pixelsPerMeter(F.center.lat,F.worldSize)),eh=$u(F.zoom);if(eh>0){let ec=Wd(F,1/fl(F.center.lat)*F.worldSize),ep=F.worldSize/(2*Math.PI),e_=Math.max(F.width,F.height)/F.worldSize*Math.PI;return Ee(el,ec+ep*(1-Math.cos(e_)),Math.pow(eh,10))}return el}upVector(F,el,eh){return Ru(el,eh,F,1)}upVectorScale(F){return{metersToTile:Iu(Lu(ku(F)))}}};function vm(F){let el=F.parallels,eh=!!el&&.01>Math.abs(el[0]+el[1]);switch(F.name){case"mercator":return new pm(F);case"equirectangular":return new lm(F);case"naturalEarth":return new dm(F);case"equalEarth":return new om(F);case"winkelTripel":return new ym(F);case"albers":return eh?new gm(F):new em(F);case"lambertConformalConic":return eh?new gm(F):new hm(F);case"globe":return new xm(F)}throw Error(`Invalid projection name: ${F.name}`)}let nS=am.VectorTileFeature.types,nE=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function wm(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE){let eM=ey?Math.min(32640,Math.round(ey[0])):0,eI=ey?Math.min(32640,Math.round(ey[1])):0;F.emplaceBack(el,eh,Math.round(32*ec),Math.round(32*ep),e_,eg,(eM<<1)+(eb?1:0),eI,16*ew,16*eT,256*eS,256*eE)}function Mm(F,el,eh){F.emplaceBack(el,eh)}function Am(F,el,eh,ec,ep,e_,eg){F.emplaceBack(el,eh,ec,ep,e_,eg)}function Im(F,el,eh,ec,ep){F.emplaceBack(el,eh,ec,ep),F.emplaceBack(el,eh,ec,ep),F.emplaceBack(el,eh,ec,ep),F.emplaceBack(el,eh,ec,ep)}let Pm=class Pm{constructor(F){this.layoutVertexArray=new Va,this.indexArray=new ja,this.programConfigurations=F,this.segments=new xo,this.dynamicLayoutVertexArray=new Da,this.opacityVertexArray=new Ra,this.placedSymbolArray=new so,this.iconTransitioningVertexArray=new La,this.globeExtVertexArray=new Ca,this.zOffsetVertexArray=new Aa}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(F,el,eh,ec,ep){this.isEmpty()||(eh&&(this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,aZ.members),this.indexBuffer=F.createIndexBuffer(this.indexArray,el),this.dynamicLayoutVertexBuffer=F.createVertexBuffer(this.dynamicLayoutVertexArray,aY.members,!0),this.opacityVertexBuffer=F.createVertexBuffer(this.opacityVertexArray,nE,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=F.createVertexBuffer(this.iconTransitioningVertexArray,aK.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=F.createVertexBuffer(this.globeExtVertexArray,aW.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||ep)&&(this.zOffsetVertexBuffer=F.createVertexBuffer(this.zOffsetVertexArray,aX.members,!0)),this.opacityVertexBuffer.itemSize=1),(eh||ec)&&this.programConfigurations.upload(F))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}};us(Pm,"SymbolBuffers");let Em=class Em{constructor(F,el,eh){this.layoutVertexArray=new F,this.layoutAttributes=el,this.indexArray=new eh,this.segments=new xo,this.collisionVertexArray=new Ua,this.collisionVertexArrayExt=new Da}upload(F){this.layoutVertexBuffer=F.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=F.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=F.createVertexBuffer(this.collisionVertexArray,aJ.members,!0),this.collisionVertexBufferExt=F.createVertexBuffer(this.collisionVertexArrayExt,aQ.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}};us(Em,"CollisionBuffers");let zm=class zm{constructor(F){this.collisionBoxArray=F.collisionBoxArray,this.zoom=F.zoom,this.lut=F.lut,this.overscaling=F.overscaling,this.layers=F.layers,this.layerIds=this.layers.map(F=>F.fqid),this.index=F.index,this.pixelRatio=F.pixelRatio,this.sourceLayerIndex=F.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=tN.mat4.identity([]),this.placementViewportMatrix=tN.mat4.identity([]);let el=this.layers[0]._unevaluatedLayout._values;this.textSizeData=bf(this.zoom,el["text-size"]),this.iconSizeData=bf(this.zoom,el["icon-size"]);let eh=this.layers[0].layout,ec=eh.get("symbol-sort-key"),ep=eh.get("symbol-z-order");this.canOverlap=eh.get("text-allow-overlap")||eh.get("icon-allow-overlap")||eh.get("text-ignore-placement")||eh.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==ep&&void 0!==ec.constantOr(1),this.sortFeaturesByY=("viewport-y"===ep||"auto"===ep&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=eh.get("text-writing-mode").map(F=>a7[F]),this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.sourceID=F.sourceID,this.projection=F.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new Pm(new Go(this.layers,{zoom:this.zoom,lut:this.lut},F=>F.startsWith("text")||F.startsWith("symbol"))),this.icon=new Pm(new Go(this.layers,{zoom:this.zoom,lut:this.lut},F=>F.startsWith("icon")||F.startsWith("symbol"))),this.glyphOffsetArray=new lo,this.lineVertexArray=new uo,this.symbolInstances=new oo}calculateGlyphDependencies(F,el,eh,ec,ep){for(let eh of F){let F=eh.codePointAt(0);if(void 0===F)break;if(el[F]=!0,ec&&ep&&F<=65535){let F=a3[eh];F&&(el[F.charCodeAt(0)]=!0)}}}updateFootprints(F,el){}updateReplacement(F,el){if(el.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=el.updateTime;let eh=el.getReplacementRegionsForTile(F.toUnwrapped(),!0);return!Yh(this.activeReplacements,eh)&&(this.activeReplacements=eh,!0)}populate(F,el,eh,ec){let ep=this.layers[0],e_=ep.layout,eg="globe"===this.projection.name,ey=e_.get("text-font"),eb=e_.get("text-field"),ew=e_.get("icon-image"),[eT,eS]=e_.get("icon-size-scale-range"),eE=Q(el.scaleFactor||1,eT,eS),eM=("constant"!==eb.value.kind||eb.value.value instanceof Qe&&!eb.value.value.isEmpty()||eb.value.value.toString().length>0)&&("constant"!==ey.value.kind||ey.value.value.length>0),eI="constant"!==ew.value.kind||!!ew.value.value||Object.keys(ew.parameters).length>0,eA=e_.get("symbol-sort-key");if(this.features=[],!eM&&!eI)return;let eC=el.iconDependencies,eP=el.glyphDependencies,ez=el.availableImages,eD=new Rs(this.zoom);for(let{feature:el,id:eb,index:ew,sourceLayerIndex:eT}of F){let F,eS;let eR=ep._featureFilter.needGeometry,eL=Cl(el,eR);if(!ep._featureFilter.filter(eD,eL,eh))continue;if(eR||(eL.geometry=Vl(el,eh,ec)),eg&&1!==el.type&&eh.z<=5){let F=eL.geometry,n=(F,el)=>{let ec=Ru(F.x,F.y,eh,1),ep=Ru(el.x,el.y,eh,1);return .98078528056>tN.vec3.dot(ec,ep)};for(let el=0;el<F.length;el++)F[el]=function(F,el){let eh=F[0],ec=[eh];for(let ep=1;ep<F.length;ep++){let e_=F[ep];(function El(F,el,eh,ec){if(ec(el,eh)){let ep=el.add(eh)._mult(.5);El(F,el,ep,ec),El(F,ep,eh,ec)}else F.push(eh)})(ec,eh,e_,el),eh=e_}return ec}(F[el],n)}if(eM){let el=ep.getValueAndResolveTokens("text-field",eL,eh,ez),ec=Qe.factory(el);(function(F){for(let el of F.sections)if(function(F){for(let el of F)if(_s(el.charCodeAt(0)))return!0;return!1}(el.text))return!0;return!1})(ec)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Vs()||this.hasRTLText&&rb.isParsed())&&(F=function(F,el,eh){return F.sections.forEach(F=>{F.text=function(F,el,eh){let ec=el.layout.get("text-transform").evaluate(eh,{});return"uppercase"===ec?F=F.toLocaleUpperCase():"lowercase"===ec&&(F=F.toLocaleLowerCase()),rb.applyArabicShaping&&(F=rb.applyArabicShaping(F)),F}(F.text,el,eh)}),F}(ec,ep,eL))}if(eI){let F=ep.getValueAndResolveTokens("icon-image",eL,eh,ez);eS=F instanceof er?F:er.build(F)}if(!F&&!eS)continue;let eO=this.sortFeaturesByKey?eA.evaluate(eL,{},eh):void 0,ek={id:eb,text:F,icon:eS,index:ew,sourceLayerIndex:eT,geometry:eL.geometry,properties:el.properties,type:nS[el.type],sortKey:eO};if(this.features.push(ek),eS){let F=this.layers[0]._unevaluatedLayout._values,{iconPrimary:el,iconSecondary:ec}=Rd(eS,this.iconSizeData,F["icon-size"],eh,this.zoom,ek,this.pixelRatio,eE),ep=el.id.toString();if(eC.has(ep)?eC.get(ep).push(el):eC.set(ep,[el]),ec){let F=ec.id.toString();eC.has(F)?eC.get(F).push(ec):eC.set(F,[ec])}}if(F){let el=ey.evaluate(eL,{},eh).join(","),ec="map"===e_.get("text-rotation-alignment")&&"point"!==e_.get("symbol-placement");for(let eh of(this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(a7.vertical)>=0,F.sections))if(eh.image){let F=eh.image.getPrimary().scaleSelf(this.pixelRatio),el=F.id.toString(),ec=eC.get(el)||[];ec.push(F),eC.set(el,ec)}else{let ep=ms(F.toString()),e_=eh.fontStack||el,eg=eP[e_]=eP[e_]||{};this.calculateGlyphDependencies(eh.text,eg,ec,this.allowVerticalPlacement,ep)}}}if("line"===e_.get("symbol-placement")&&(this.features=function(F){let el={},eh={},ec=[],ep=0;function s(el){ec.push(F[el]),ep++}function a(F,el,ep){let e_=eh[F];return delete eh[F],eh[el]=e_,ec[e_].geometry[0].pop(),ec[e_].geometry[0]=ec[e_].geometry[0].concat(ep[0]),e_}function o(F,eh,ep){let e_=el[eh];return delete el[eh],el[F]=e_,ec[e_].geometry[0].shift(),ec[e_].geometry[0]=ep[0].concat(ec[e_].geometry[0]),e_}function l(F,el,eh){let ec=eh?el[0][el[0].length-1]:el[0][0];return`${F}:${ec.x}:${ec.y}`}for(let e_=0;e_<F.length;e_++){let eg=F[e_],ey=eg.geometry,eb=eg.text?eg.text.toString():null;if(!eb){s(e_);continue}let ew=l(eb,ey),eT=l(eb,ey,!0);if(ew in eh&&eT in el&&eh[ew]!==el[eT]){let F=o(ew,eT,ey),ep=a(ew,eT,ec[F].geometry);delete el[ew],delete eh[eT],eh[l(eb,ec[ep].geometry,!0)]=ep,ec[F].geometry=null}else ew in eh?a(ew,eT,ey):eT in el?o(ew,eT,ey):(s(e_),el[ew]=ep-1,eh[eT]=ep-1)}return ec.filter(F=>F.geometry)}(this.features)),"hd-road-markup"===e_.get("symbol-elevation-reference")){if(this.elevationType="road",el.elevationFeatures)for(let F of(!this.elevationFeatures&&el.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map),el.elevationFeatures))this.elevationFeatureIdToIndex.set(F.id,this.elevationFeatures.length),this.elevationFeatures.push(F)}else e_.get("symbol-z-elevate")&&(this.elevationType="offset");"none"!==this.elevationType&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort((F,el)=>F.sortKey-el.sortKey)}update(F,el,eh,ec,ep,e_,eg){this.text.programConfigurations.updatePaintArrays(F,el,ep,eh,ec,e_,eg),this.icon.programConfigurations.updatePaintArrays(F,el,ep,eh,ec,e_,eg)}updateRoadElevation(){if("road"!==this.elevationType||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let F=!1;for(let el=0;el<this.symbolInstances.length;el++){let eh=this.symbolInstances.get(el);if(65535===eh.elevationFeatureIndex)continue;let ec=this.elevationFeatures[eh.elevationFeatureIndex];if(ec){let el=.05+ec.pointElevation(new tU(eh.tileAnchorX,eh.tileAnchorY));eh.zOffset!==el&&(F=!0,eh.zOffset=el)}}F&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){let t=(el,eh,ec)=>{(F+=eh)>el.length&&el.resize(F);for(let ep=-eh;ep<0;ep++)el.emplace(ep+F,ec)},e=(F,eh,ec)=>{(el+=eh)>F.length&&F.resize(el);for(let ep=-eh;ep<0;ep++)F.emplace(ep+el,ec)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let F=0,el=0;for(let F=0;F<this.symbolInstances.length;F++){let el=this.symbolInstances.get(F),{numHorizontalGlyphVertices:eh,numVerticalGlyphVertices:ec,numIconVertices:ep}=el,e_=el.zOffset,eg=ep>0;if((eh>0||ec>0)&&(t(this.text.zOffsetVertexArray,eh,e_),t(this.text.zOffsetVertexArray,ec,e_)),eg){let{placedIconSymbolIndex:F,verticalPlacedIconSymbolIndex:eh}=el;F>=0&&e(this.icon.zOffsetVertexArray,ep,e_),eh>=0&&e(this.icon.zOffsetVertexArray,el.numVerticalIconVertices,e_)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(F){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(F),this.iconCollisionBox.upload(F)),this.text.upload(F,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(F,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=vm(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(F,el){let eh=this.lineVertexArray.length;if(void 0!==F.segment)for(let{x:F,y:eh}of el)this.lineVertexArray.emplaceBack(F,eh);return{lineStartIndex:eh,lineLength:this.lineVertexArray.length-eh}}addSymbols(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA){let eC=F.indexArray,eP=F.layoutVertexArray,ez=F.globeExtVertexArray,eD=F.segments.prepareSegment(4*el.length,eP,eC,this.canOverlap?e_.sortKey:void 0),eR=this.glyphOffsetArray.length,eL=eD.vertexLength,eO=this.allowVerticalPlacement&&eg===a7.vertical?Math.PI/2:0,ek=e_.text&&e_.text.sections;for(let ec=0;ec<el.length;ec++){let{tl:ep,tr:eg,bl:ew,br:eT,texPrimary:eS,texSecondary:eR,pixelOffsetTL:eL,pixelOffsetBR:eF,minFontScaleX:eB,minFontScaleY:eN,glyphOffset:eV,isSDF:eU,sectionIndex:ej}=el[ec],eG=eD.vertexLength,eq=eV[1];if(wm(eP,eb.x,eb.y,ep.x,eq+ep.y,eS.x,eS.y,eh,eU,eL.x,eL.y,eB,eN),wm(eP,eb.x,eb.y,eg.x,eq+eg.y,eS.x+eS.w,eS.y,eh,eU,eF.x,eL.y,eB,eN),wm(eP,eb.x,eb.y,ew.x,eq+ew.y,eS.x,eS.y+eS.h,eh,eU,eL.x,eF.y,eB,eN),wm(eP,eb.x,eb.y,eT.x,eq+eT.y,eS.x+eS.w,eS.y+eS.h,eh,eU,eF.x,eF.y,eB,eN),ey){let{x:el,y:eh,z:ec}=ey.anchor,[ep,e_,eg]=ey.up;Am(ez,el,eh,ec,ep,e_,eg),Am(ez,el,eh,ec,ep,e_,eg),Am(ez,el,eh,ec,ep,e_,eg),Am(ez,el,eh,ec,ep,e_,eg),Im(F.dynamicLayoutVertexArray,el,eh,ec,eO)}else Im(F.dynamicLayoutVertexArray,eb.x,eb.y,eb.z,eO);if(eA){let el=eR||eS;Mm(F.iconTransitioningVertexArray,el.x,el.y),Mm(F.iconTransitioningVertexArray,el.x+el.w,el.y),Mm(F.iconTransitioningVertexArray,el.x,el.y+el.h),Mm(F.iconTransitioningVertexArray,el.x+el.w,el.y+el.h)}eC.emplaceBack(eG,eG+1,eG+2),eC.emplaceBack(eG+1,eG+2,eG+3),eD.vertexLength+=4,eD.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(eV[0]),ec!==el.length-1&&ej===el[ec+1].sectionIndex||F.programConfigurations.populatePaintArrays(eP.length,e_,e_.index,{},eE,eM,eI,ek&&ek[ej])}let eF=ey?ey.anchor:eb;F.placedSymbolArray.emplaceBack(eF.x,eF.y,eF.z,eb.x,eb.y,eR,this.glyphOffsetArray.length-eR,eL,ew,eT,eb.segment,eh?eh[0]:0,eh?eh[1]:0,ec[0],ec[1],eg,0,!1,0,eS,0)}_commitLayoutVertex(F,el,eh,ec,ep,e_,eg){F.emplaceBack(el,eh,ec,ep,e_,Math.round(eg.x),Math.round(eg.y))}_addCollisionDebugVertices(F,el,eh,ec,ep,e_,eg){let ey=eh.segments.prepareSegment(4,eh.layoutVertexArray,eh.indexArray),eb=ey.vertexLength,ew=eg.tileAnchorX,eT=eg.tileAnchorY;for(let F=0;F<4;F++)eh.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(eh.collisionVertexArrayExt,el,F.padding,eg.zOffset),this._commitLayoutVertex(eh.layoutVertexArray,ec,ep,e_,ew,eT,new tU(F.x1,F.y1)),this._commitLayoutVertex(eh.layoutVertexArray,ec,ep,e_,ew,eT,new tU(F.x2,F.y1)),this._commitLayoutVertex(eh.layoutVertexArray,ec,ep,e_,ew,eT,new tU(F.x2,F.y2)),this._commitLayoutVertex(eh.layoutVertexArray,ec,ep,e_,ew,eT,new tU(F.x1,F.y2)),ey.vertexLength+=4;let eS=eh.indexArray;eS.emplaceBack(eb,eb+1),eS.emplaceBack(eb+1,eb+2),eS.emplaceBack(eb+2,eb+3),eS.emplaceBack(eb+3,eb),ey.primitiveLength+=4}_addTextDebugCollisionBoxes(F,el,eh,ec,ep,e_){for(let eg=ec;eg<ep;eg++){let ec=eh.get(eg),ep=this.getSymbolInstanceTextSize(F,e_,el,eg);this._addCollisionDebugVertices(ec,ep,this.textCollisionBox,ec.projectedAnchorX,ec.projectedAnchorY,ec.projectedAnchorZ,e_)}}_addIconDebugCollisionBoxes(F,el,eh,ec,ep,e_){for(let eg=ec;eg<ep;eg++){let ec=eh.get(eg),ep=this.getSymbolInstanceIconSize(F,el,e_.placedIconSymbolIndex);this._addCollisionDebugVertices(ec,ep,this.iconCollisionBox,ec.projectedAnchorX,ec.projectedAnchorY,ec.projectedAnchorZ,e_)}}generateCollisionDebugBuffers(F,el,eh){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Em(Oa,a0.members,La),this.iconCollisionBox=new Em(Oa,a0.members,La);let ec=wf(this.iconSizeData,F),ep=wf(this.textSizeData,F,eh);for(let eh=0;eh<this.symbolInstances.length;eh++){let e_=this.symbolInstances.get(eh);this._addTextDebugCollisionBoxes(ep,F,el,e_.textBoxStartIndex,e_.textBoxEndIndex,e_),this._addTextDebugCollisionBoxes(ep,F,el,e_.verticalTextBoxStartIndex,e_.verticalTextBoxEndIndex,e_),this._addIconDebugCollisionBoxes(ec,F,el,e_.iconBoxStartIndex,e_.iconBoxEndIndex,e_),this._addIconDebugCollisionBoxes(ec,F,el,e_.verticalIconBoxStartIndex,e_.verticalIconBoxEndIndex,e_)}}getSymbolInstanceTextSize(F,el,eh,ec){let ep=this.text.placedSymbolArray.get(el.rightJustifiedTextSymbolIndex>=0?el.rightJustifiedTextSymbolIndex:el.centerJustifiedTextSymbolIndex>=0?el.centerJustifiedTextSymbolIndex:el.leftJustifiedTextSymbolIndex>=0?el.leftJustifiedTextSymbolIndex:el.verticalPlacedTextSymbolIndex>=0?el.verticalPlacedTextSymbolIndex:ec),e_=_f(this.textSizeData,F,ep)/24;return this.tilePixelRatio*e_}getSymbolInstanceIconSize(F,el,eh){let ec=this.icon.placedSymbolArray.get(eh),ep=_f(this.iconSizeData,F,ec);return this.tilePixelRatio*ep}_commitDebugCollisionVertexUpdate(F,el,eh,ec){F.emplaceBack(el,-eh,-eh,ec),F.emplaceBack(el,eh,-eh,ec),F.emplaceBack(el,eh,eh,ec),F.emplaceBack(el,-eh,eh,ec)}_updateTextDebugCollisionBoxes(F,el,eh,ec,ep,e_,eg){for(let eg=ec;eg<ep;eg++){let ec=eh.get(eg),ep=this.getSymbolInstanceTextSize(F,e_,el,eg);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,ep,ec.padding,e_.zOffset)}}_updateIconDebugCollisionBoxes(F,el,eh,ec,ep,e_,eg){for(let eg=ec;eg<ep;eg++){let ec=eh.get(eg),ep=this.getSymbolInstanceIconSize(F,el,e_.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,ep,ec.padding,e_.zOffset)}}updateCollisionDebugBuffers(F,el,eh,ec){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();let ep=wf(this.iconSizeData,F,ec),e_=wf(this.textSizeData,F,eh);for(let eg=0;eg<this.symbolInstances.length;eg++){let ey=this.symbolInstances.get(eg);this._updateTextDebugCollisionBoxes(e_,F,el,ey.textBoxStartIndex,ey.textBoxEndIndex,ey,eh),this._updateTextDebugCollisionBoxes(e_,F,el,ey.verticalTextBoxStartIndex,ey.verticalTextBoxEndIndex,ey,eh),this._updateIconDebugCollisionBoxes(ep,F,el,ey.iconBoxStartIndex,ey.iconBoxEndIndex,ey,ec),this._updateIconDebugCollisionBoxes(ep,F,el,ey.verticalIconBoxStartIndex,ey.verticalIconBoxEndIndex,ey,ec)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(F,el,eh,ec,ep,e_,eg,ey,eb){let ew={};if(el<eh){let{x1:eh,y1:ec,x2:ep,y2:e_,padding:eg,projectedAnchorX:ey,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE,featureIndex:eM}=F.get(el);ew.textBox={x1:eh,y1:ec,x2:ep,y2:e_,padding:eg,projectedAnchorX:ey,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE},ew.textFeatureIndex=eM}if(ec<ep){let{x1:el,y1:eh,x2:ep,y2:e_,padding:eg,projectedAnchorX:ey,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE,featureIndex:eM}=F.get(ec);ew.verticalTextBox={x1:el,y1:eh,x2:ep,y2:e_,padding:eg,projectedAnchorX:ey,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE},ew.verticalTextFeatureIndex=eM}if(e_<eg){let{x1:el,y1:eh,x2:ec,y2:ep,padding:eg,projectedAnchorX:ey,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE,featureIndex:eM}=F.get(e_);ew.iconBox={x1:el,y1:eh,x2:ec,y2:ep,padding:eg,projectedAnchorX:ey,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE},ew.iconFeatureIndex=eM}if(ey<eb){let{x1:el,y1:eh,x2:ec,y2:ep,padding:e_,projectedAnchorX:eg,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE,featureIndex:eM}=F.get(ey);ew.verticalIconBox={x1:el,y1:eh,x2:ec,y2:ep,padding:e_,projectedAnchorX:eg,projectedAnchorY:eb,projectedAnchorZ:eT,tileAnchorX:eS,tileAnchorY:eE},ew.verticalIconFeatureIndex=eM}return ew}deserializeCollisionBoxes(F){this.collisionArrays=[];for(let el=0;el<this.symbolInstances.length;el++){let eh=this.symbolInstances.get(el);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(F,eh.textBoxStartIndex,eh.textBoxEndIndex,eh.verticalTextBoxStartIndex,eh.verticalTextBoxEndIndex,eh.iconBoxStartIndex,eh.iconBoxEndIndex,eh.verticalIconBoxStartIndex,eh.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(F,el){let eh=F.placedSymbolArray.get(el),ec=eh.vertexStartIndex+4*eh.numGlyphs;for(let el=eh.vertexStartIndex;el<ec;el+=4)F.indexArray.emplaceBack(el,el+1,el+2),F.indexArray.emplaceBack(el+1,el+2,el+3)}getSortedSymbolIndexes(F){if(this.sortedAngle===F&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;let el=Math.sin(F),eh=Math.cos(F),ec=[],ep=[],e_=[];for(let F=0;F<this.symbolInstances.length;++F){e_.push(F);let eg=this.symbolInstances.get(F);ec.push(0|Math.round(el*eg.tileAnchorX+eh*eg.tileAnchorY)),ep.push(eg.featureIndex)}return e_.sort((F,el)=>ec[F]-ec[el]||ep[el]-ep[F]),e_}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let F=0;F<this.symbolInstances.length;++F)this.symbolInstanceIndexesSortedZOffset.push(F)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((F,el)=>this.symbolInstances.get(el).zOffset-this.symbolInstances.get(F).zOffset)}addToSortKeyRanges(F,el){let eh=this.sortKeyRanges[this.sortKeyRanges.length-1];eh&&eh.sortKey===el?eh.symbolInstanceEnd=F+1:this.sortKeyRanges.push({sortKey:el,symbolInstanceStart:F,symbolInstanceEnd:F+1})}sortFeatures(F){if(this.sortFeaturesByY&&this.sortedAngle!==F&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){for(let el of(this.symbolInstanceIndexes=this.getSortedSymbolIndexes(F),this.sortedAngle=F,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[],this.symbolInstanceIndexes)){let F=this.symbolInstances.get(el);this.featureSortOrder.push(F.featureIndex);let{rightJustifiedTextSymbolIndex:eh,centerJustifiedTextSymbolIndex:ec,leftJustifiedTextSymbolIndex:ep,verticalPlacedTextSymbolIndex:e_,placedIconSymbolIndex:eg,verticalPlacedIconSymbolIndex:ey}=F;eh>=0&&this.addIndicesForPlacedSymbol(this.text,eh),ec>=0&&ec!==eh&&this.addIndicesForPlacedSymbol(this.text,ec),ep>=0&&ep!==ec&&ep!==eh&&this.addIndicesForPlacedSymbol(this.text,ep),e_>=0&&this.addIndicesForPlacedSymbol(this.text,e_),eg>=0&&this.addIndicesForPlacedSymbol(this.icon,eg),ey>=0&&this.addIndicesForPlacedSymbol(this.icon,ey)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}};us(zm,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),zm.addDynamicAttributes=Im;let Vm=class Vm{constructor(F){this.type=F.property.overrides?F.property.overrides.runtimeType:iE,this.defaultValue=F}evaluate(F){if(F.formattedSection){let el=this.defaultValue.property.overrides;if(el&&el.hasOverride(F.formattedSection))return el.getOverride(F.formattedSection)}return F.feature&&F.featureState?this.defaultValue.evaluate(F.feature,F.featureState):this.defaultValue.property.specification.default}eachChild(F){this.defaultValue.isConstant()||F(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}};us(Vm,"FormatSectionOverride",{omit:["defaultValue"]});let Cm=()=>ej||(ej={layout:eV||(eV=new Xs({"symbol-placement":new Gs(rw.layout_symbol["symbol-placement"]),"symbol-spacing":new Gs(rw.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new Gs(rw.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Ys(rw.layout_symbol["symbol-sort-key"]),"symbol-z-order":new Gs(rw.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new Gs(rw.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new Gs(rw.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new Gs(rw.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new Gs(rw.layout_symbol["icon-ignore-placement"]),"icon-optional":new Gs(rw.layout_symbol["icon-optional"]),"icon-rotation-alignment":new Gs(rw.layout_symbol["icon-rotation-alignment"]),"icon-size":new Ys(rw.layout_symbol["icon-size"]),"icon-size-scale-range":new Gs(rw.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Ys(rw.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Ys(rw.layout_symbol["icon-text-fit-padding"]),"icon-image":new Ys(rw.layout_symbol["icon-image"]),"icon-rotate":new Ys(rw.layout_symbol["icon-rotate"]),"icon-padding":new Gs(rw.layout_symbol["icon-padding"]),"icon-keep-upright":new Gs(rw.layout_symbol["icon-keep-upright"]),"icon-offset":new Ys(rw.layout_symbol["icon-offset"]),"icon-anchor":new Ys(rw.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new Gs(rw.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new Gs(rw.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new Gs(rw.layout_symbol["text-rotation-alignment"]),"text-field":new Ys(rw.layout_symbol["text-field"]),"text-font":new Ys(rw.layout_symbol["text-font"]),"text-size":new Ys(rw.layout_symbol["text-size"]),"text-size-scale-range":new Gs(rw.layout_symbol["text-size-scale-range"]),"text-max-width":new Ys(rw.layout_symbol["text-max-width"]),"text-line-height":new Ys(rw.layout_symbol["text-line-height"]),"text-letter-spacing":new Ys(rw.layout_symbol["text-letter-spacing"]),"text-justify":new Ys(rw.layout_symbol["text-justify"]),"text-radial-offset":new Ys(rw.layout_symbol["text-radial-offset"]),"text-variable-anchor":new Gs(rw.layout_symbol["text-variable-anchor"]),"text-anchor":new Ys(rw.layout_symbol["text-anchor"]),"text-max-angle":new Gs(rw.layout_symbol["text-max-angle"]),"text-writing-mode":new Gs(rw.layout_symbol["text-writing-mode"]),"text-rotate":new Ys(rw.layout_symbol["text-rotate"]),"text-padding":new Gs(rw.layout_symbol["text-padding"]),"text-keep-upright":new Gs(rw.layout_symbol["text-keep-upright"]),"text-transform":new Ys(rw.layout_symbol["text-transform"]),"text-offset":new Ys(rw.layout_symbol["text-offset"]),"text-allow-overlap":new Gs(rw.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new Gs(rw.layout_symbol["text-ignore-placement"]),"text-optional":new Gs(rw.layout_symbol["text-optional"]),visibility:new Gs(rw.layout_symbol.visibility)})),paint:eU||(eU=new Xs({"icon-opacity":new Ys(rw.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Ys(rw.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Ys(rw.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Ys(rw.paint_symbol["text-emissive-strength"]),"icon-color":new Ys(rw.paint_symbol["icon-color"]),"icon-halo-color":new Ys(rw.paint_symbol["icon-halo-color"]),"icon-halo-width":new Ys(rw.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Ys(rw.paint_symbol["icon-halo-blur"]),"icon-translate":new Gs(rw.paint_symbol["icon-translate"]),"icon-translate-anchor":new Gs(rw.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new Ys(rw.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Ys(rw.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Ys(rw.paint_symbol["text-occlusion-opacity"]),"text-color":new Ys(rw.paint_symbol["text-color"],{runtimeType:iC,getOverride:F=>F.textColor,hasOverride:F=>!!F.textColor}),"text-halo-color":new Ys(rw.paint_symbol["text-halo-color"]),"text-halo-width":new Ys(rw.paint_symbol["text-halo-width"]),"text-halo-blur":new Ys(rw.paint_symbol["text-halo-blur"]),"text-translate":new Gs(rw.paint_symbol["text-translate"]),"text-translate-anchor":new Gs(rw.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new Gs(rw.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new Gs(rw.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new Gs(rw.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new Gs(rw.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Ys(rw.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))});let Dm=class Dm extends ma{constructor(F,el,eh,ec){super(F,Cm(),el,eh,ec),this._colorAdjustmentMatrix=tN.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==F.paint&&("icon-occlusion-opacity"in F.paint||"text-occlusion-opacity"in F.paint)}recalculate(F,el){super.recalculate(F,el),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));let eh=this.layout.get("text-writing-mode");if(eh){let F=[];for(let el of eh)0>F.indexOf(el)&&F.push(el);this.layout._values["text-writing-mode"]=F}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(F,el,eh,ec){return this._saturation===F&&this._contrast===el&&this._brightnessMin===eh&&this._brightnessMax===ec||(this._colorAdjustmentMatrix=function(F,el,eh,ec){F=Mt(F),el=wt(el);let ep=tN.mat4.create(),e_=F/3,eg=1-2*e_,ey=[eg,e_,e_,0,e_,eg,e_,0,e_,e_,eg,0,0,0,0,1],eb=.5-.5*el,ew=ec-eh;return tN.mat4.multiply(ep,[ew,0,0,0,0,ew,0,0,0,0,ew,0,eh,eh,eh,1],[el,0,0,0,0,el,0,0,0,0,el,0,eb,eb,eb,1]),tN.mat4.multiply(ep,ep,ey),ep}(F,el,eh,ec),this._saturation=F,this._contrast=el,this._brightnessMin=eh,this._brightnessMax=ec),this._colorAdjustmentMatrix}getValueAndResolveTokens(F,el,eh,ec){var ep;let e_=this.layout.get(F).evaluate(el,{},eh,ec),eg=this._unevaluatedLayout._values[F];return eg.isDataDriven()||Ki(eg.value)||!e_?e_:(ep=el.properties,e_.replace(/{([^{}]+)}/g,(F,el)=>el in ep?String(ep[el]):""))}createBucket(F){return new zm(F)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(let F of Cm().paint.overridableProperties){if(!Dm.hasPaintOverride(this.layout,F))continue;let el=this.paint.get(F),eh=new Vm(el),ec=new Wi(eh,el.property.specification,this.scope,this.options),ep=null;ep="constant"===el.value.kind||"source"===el.value.kind?new Qi("source",ec):new ts("composite",ec,el.value.zoomStops,el.value._interpolationType),this.paint._values[F]=new qs(el.property,ep,el.parameters)}}_handleOverridablePaintPropertyUpdate(F,el,eh){return!(!this.layout||el.isDataDriven()||eh.isDataDriven())&&Dm.hasPaintOverride(this.layout,F)}static hasPaintOverride(F,el){let eh=F.get("text-field"),ec=Cm().paint.properties[el],ep=!1,s=F=>{for(let el of F)if(ec.overrides&&ec.overrides.hasOverride(el))return void(ep=!0)};if("constant"===eh.value.kind&&eh.value.value instanceof Qe)s(eh.value.value.sections);else if("source"===eh.value.kind){let t=F=>{ep||(F instanceof ar&&ir(F.value)===iR?s(F.value.sections):F instanceof cr?s(F.sections):F.eachChild(t))},F=eh.value;F._styleExpression&&t(F._styleExpression.expression)}return ep}getProgramIds(){return["symbol"]}getDefaultProgramParams(F,el,eh){return{config:new $o(this,{zoom:el,lut:eh}),overrideFog:!1}}};var nM=va([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function Um(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function jm(F){switch(F){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}let qm=class qm{constructor(F,el,eh,ec){this.context=F,this.format=eh,this.useMipmap=ec&&ec.useMipmap,this.texture=F.gl.createTexture(),this.update(el,{premultiply:ec&&ec.premultiply})}update(F,el){let eh=F&&F instanceof HTMLVideoElement&&0===F.width?F.videoWidth:F.width,ec=F&&F instanceof HTMLVideoElement&&0===F.height?F.videoHeight:F.height,{context:ep}=this,{gl:e_}=ep,{x:eg,y:ey}=el&&el.position?el.position:{x:0,y:0},eb=eg+eh,ew=ey+ec;this.size&&(this.size[0]!==eb||this.size[1]!==ew)&&(e_.bindTexture(e_.TEXTURE_2D,null),e_.deleteTexture(this.texture),this.texture=e_.createTexture(),this.size=null),e_.bindTexture(e_.TEXTURE_2D,this.texture),ep.pixelStoreUnpackFlipY.set(!1),ep.pixelStoreUnpack.set(1),ep.pixelStoreUnpackPremultiplyAlpha.set(this.format===e_.RGBA8&&(!el||!1!==el.premultiply));let eT=F instanceof HTMLImageElement||F instanceof HTMLCanvasElement||F instanceof HTMLVideoElement||F instanceof ImageData||ImageBitmap&&F instanceof ImageBitmap;if(!this.size&&eb>0&&ew>0){let F=this.useMipmap?Math.floor(Math.log2(Math.max(eb,ew)))+1:1;e_.texStorage2D(e_.TEXTURE_2D,F,this.format,eb,ew),this.size=[eb,ew]}if(this.size){if(eT)e_.texSubImage2D(e_.TEXTURE_2D,0,eg,ey,Um(this.format),jm(this.format),F);else{let el=F.data;el&&e_.texSubImage2D(e_.TEXTURE_2D,0,eg,ey,eh,ec,Um(this.format),jm(this.format),el)}}this.useMipmap&&e_.generateMipmap(e_.TEXTURE_2D)}bind(F,el,eh=!1){let{context:ec}=this,{gl:ep}=ec;ep.bindTexture(ep.TEXTURE_2D,this.texture),F!==this.minFilter&&(ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_MAG_FILTER,F),ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_MIN_FILTER,this.useMipmap&&!eh?F===ep.NEAREST?ep.NEAREST_MIPMAP_NEAREST:ep.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),el!==this.wrapS&&(ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_WRAP_S,el),ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_WRAP_T,el),this.wrapS=el)}bindExtraParam(F,el,eh,ec){let{context:ep}=this,{gl:e_}=ep;e_.bindTexture(e_.TEXTURE_2D,this.texture),el!==this.magFilter&&(e_.texParameteri(e_.TEXTURE_2D,e_.TEXTURE_MAG_FILTER,el),this.magFilter=el),F!==this.minFilter&&(e_.texParameteri(e_.TEXTURE_2D,e_.TEXTURE_MIN_FILTER,this.useMipmap?F===e_.NEAREST?e_.NEAREST_MIPMAP_NEAREST:e_.LINEAR_MIPMAP_LINEAR:F),this.minFilter=F),eh!==this.wrapS&&(e_.texParameteri(e_.TEXTURE_2D,e_.TEXTURE_WRAP_S,eh),this.wrapS=eh),ec!==this.wrapT&&(e_.texParameteri(e_.TEXTURE_2D,e_.TEXTURE_WRAP_T,ec),this.wrapT=ec)}destroy(){let{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}};let $m=class $m{constructor(F,el){this.context=F,this.texture=el}bind(F,el){let{context:eh}=this,{gl:ec}=eh;ec.bindTexture(ec.TEXTURE_2D,this.texture),F!==this.minFilter&&(ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_MAG_FILTER,F),ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_MIN_FILTER,F),this.minFilter=F),el!==this.wrapS&&(ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_WRAP_S,el),ec.texParameteri(ec.TEXTURE_2D,ec.TEXTURE_WRAP_T,el),this.wrapS=el)}};function Gm(F,el,eh,ec,ep,e_,eg,ey){let eb=[F,el,1,eh,ec,1,ep,e_,1],ew=[eg,ey,1],eT=tN.mat3.adjoint([],eb),[eS,eE,eM]=tN.vec3.transformMat3(ew,ew,eT);return tN.mat3.multiply(eb,eb,[eS,0,0,0,eE,0,0,0,eM])}function Ym(F,el,eh,ec,ep,e_,eg,ey){let eb=function(F,el,eh,ec,ep,e_,eg,ey){let eb=Gm(0,0,1,0,1,1,0,1),ew=Gm(F,el,eh,ec,ep,e_,eg,ey),eT=tN.mat3.adjoint([],eb);return tN.mat3.multiply(ew,ew,eT)}(F,el,eh,ec,ep,e_,eg,ey);return[eb[2]/eb[8]/8192,eb[5]/eb[8]/8192]}function Hm(F){return[F[0],Math.min(Math.max(F[1],-85.051129),85.051129)]}let Xm=class Xm extends _e{constructor(F,el,eh,ec){super(),this.id=F,this.dispatcher=eh,this.coordinates=el.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(ec),this.options=el,this._dirty=!1}load(F,el){if(this._loaded=el||!1,this.fire(new ge("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return F&&(this.coordinates=F),this._loaded=!0,void this._finishLoading();this._imageRequest=le(this.map._requestManager.transformRequest(this.url,t9.Image),(el,eh)=>{this._imageRequest=null,this._loaded=!0,el?this.fire(new xe(el)):eh&&(this.image=eh instanceof HTMLImageElement?tX.getImageData(eh):eh,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,F&&(this.coordinates=F),this._finishLoading())})}loaded(){return this._loaded}updateImage(F){return F.url&&(this._imageRequest&&F.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=F.url,this.load(F.coordinates,this._loaded)),this}setTexture(F){if(!(F.handle instanceof WebGLTexture))throw Error("The provided handle is not a WebGLTexture instance");return this.texture=new $m(this.map.painter.context,F.handle),this.width=F.dimensions[0],this.height=F.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ge("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(F){this.map=F,this.load()}onRemove(F){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof $m||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(F){if(this.coordinates=F,this._boundsArray=void 0,this._unsupportedCoords=!1,!F.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let el=F[0][1],eh=F[0][1];for(let ec of F)ec[1]>eh&&(eh=ec[1]),ec[1]<el&&(el=ec[1]);let ec=(eh+el)/2;if(ec>85.051129?this.onNorthPole=!0:ec<-85.051129&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){let el=F.map(Il.fromLngLat);this.tileID=function(F){let el=1/0,eh=1/0,ec=-1/0,ep=-1/0;for(let e_ of F)el=Math.min(el,e_.x),eh=Math.min(eh,e_.y),ec=Math.max(ec,e_.x),ep=Math.max(ep,e_.y);let e_=Math.max(ec-el,ep-eh),eg=Math.max(0,Math.floor(-Math.log(e_)/Math.LN2)),ey=Math.pow(2,eg),eb=Math.floor((el+ec)/2*ey);return eb>1&&(eb-=1),new ou(eg,eb,Math.floor((eh+ep)/2*ey))}(el),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ge("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(F){var el;for(let F in this.tiles){let el=this.tiles[F];"loaded"!==el.state&&(el.state="loaded",el.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;let eh=Kd(new ou(0,0,0),this.map.transform.projection),ec=[eh.projection.project(this.coordinates[0][0],this.coordinates[0][1]),eh.projection.project(this.coordinates[1][0],this.coordinates[1][1]),eh.projection.project(this.coordinates[2][0],this.coordinates[2][1]),eh.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(F){let el=F[1].x-F[0].x,eh=F[1].y-F[0].y,ec=F[2].x-F[1].x,ep=F[2].y-F[1].y,e_=F[3].x-F[2].x,eg=F[3].y-F[2].y,ey=F[0].x-F[3].x,eb=F[0].y-F[3].y,ew=el*ep-ec*eh,eT=ec*eg-e_*ep,eS=e_*eb-ey*eg,eE=ey*eh-el*eb;return ew>0&&eT>0&&eS>0&&eE>0||ew<0&&eT<0&&eS<0&&eE<0}(ec))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);let ep=Kd(this.tileID,this.map.transform.projection),[e_,eg,ey,eb]=this.coordinates.map(F=>{let el=ep.projection.project(F[0],F[1]);return Jd(ep,el)._round()});this.perspectiveTransform=Ym(e_.x,e_.y,eg.x,eg.y,ey.x,ey.y,eb.x,eb.y);let ew=this._boundsArray=new Ma;ew.emplaceBack(e_.x,e_.y,0,0),ew.emplaceBack(eg.x,eg.y,8192,0),ew.emplaceBack(eb.x,eb.y,0,8192),ew.emplaceBack(ey.x,ey.y,8192,8192),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=F.createVertexBuffer(ew,nM.members),this.boundsSegments=xo.simpleSegment(0,0,4,2);let eT=[],eS=[Hm((el=this.coordinates)[0]),Hm(el[1]),Hm(el[2]),Hm(el[3])],[eE,eM,eI,eA]=function(F){let el=F[0][0],eh=el,ec=F[0][1],ep=ec;for(let e_=1;e_<F.length;e_++)F[e_][0]<el?el=F[e_][0]:F[e_][0]>eh&&(eh=F[e_][0]),F[e_][1]<ec?ec=F[e_][1]:F[e_][1]>ep&&(ep=F[e_][1]);return[el,ec,eh-el,ep-ec]}(eS);{let el=new Ma,[ep,e_,eg,ey]=function(F){let el=F[0].x,eh=el,ec=F[0].y,ep=ec;for(let e_=1;e_<F.length;e_++)F[e_].x<el?el=F[e_].x:F[e_].x>eh&&(eh=F[e_].x),F[e_].y<ec?ec=F[e_].y:F[e_].y>ep&&(ep=F[e_].y);return[el,ec,eh-el,ep-ec]}(ec),l=F=>[(F.x-ep)/eg,(F.y-e_)/ey],[eb,ew,eS,eC]=ec.map(l),eP=function(F,el,eh,ec,ep,e_,eg,ey){let eb=Gm(0,0,1,0,1,1,0,1),ew=Gm(F,el,eh,ec,ep,e_,eg,ey),eT=tN.mat3.adjoint([],ew);return tN.mat3.multiply(eb,eb,eT)}(eb[0],eb[1],ew[0],ew[1],eS[0],eS[1],eC[0],eC[1]);this.elevatedGlobePerspectiveTransform=Ym(eb[0],eb[1],ew[0],ew[1],eS[0],eS[1],eC[0],eC[1]);let v=(F,eh)=>{eT.push(F.lng);let ec=Math.round((F.lng-eE)/eI*8192),ep=Math.round((F.lat-eM)/eA*8192),e_=l(eh),eg=tN.vec3.transformMat3([],[e_[0],e_[1],1],eP),ey=Math.round(eg[0]/eg[2]*8192),eb=Math.round(eg[1]/eg[2]*8192);el.emplaceBack(ec,ep,ey,eb)},ez=ec[3].x-ec[0].x,eD=ec[3].y-ec[0].y,eR=ec[2].x-ec[1].x,eL=ec[2].y-ec[1].y;for(let F=0;F<65;F++){let el=F/64,ep=[ec[0].x+el*ez,ec[0].y+el*eD],e_=[ec[1].x+el*eR,ec[1].y+el*eL],eg=e_[0]-ep[0],ey=e_[1]-ep[1];for(let F=0;F<65;F++){let el=F/64,ec={x:ep[0]+eg*el,y:ep[1]+ey*el,z:0};v(eh.projection.unproject(ec.x,ec.y),ec)}}this.elevatedGlobeVertexBuffer=F.createVertexBuffer(el,nM.members)}{this.maxLongitudeTriangleSize=0;let el=[],eh=new ja,n=(F,ec,ep)=>{eh.emplaceBack(F,ec,ep);let e_=eT[F],eg=eT[ec],ey=eT[ep],eb=Math.min(Math.min(e_,eg),ey),ew=Math.max(Math.max(e_,eg),ey)-eb;ew>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=ew),el.push(eb+ew/2)};for(let F=0;F<64;F++)for(let el=0;el<64;el++){let eh=65*F+el,ec=eh+1,ep=eh+65,e_=ep+1;n(eh,ep,ec),n(ec,ep,e_)}[el,eh]=function(F,el){let eh=Array.from({length:F.length},(F,el)=>el);eh.sort((el,eh)=>F[el]-F[eh]);let ec=[],ep=new ja;for(let e_=0;e_<eh.length;e_++){let eg=eh[e_];ec.push(F[eg]);let ey=3*eg,eb=ey+1;ep.emplaceBack(el.uint16[ey],el.uint16[eb],el.uint16[eb+1])}return[ec,ep]}(el,eh),this.elevatedGlobeTrianglesCenterLongitudes=el,this.elevatedGlobeIndexBuffer=F.createIndexBuffer(eh)}this.elevatedGlobeSegments=xo.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,eI/8192,0,eA/8192,0,0,eM,eE,0])}prepare(){let F=0!==Object.keys(this.tiles).length;if(this.tileID&&!F)return;let el=this.map.painter.context,eh=el.gl;!this._dirty||this.texture instanceof $m||(this.texture?this.texture.update(this.image):(this.texture=new qm(el,this.image,eh.RGBA8),this.texture.bind(eh.LINEAR,eh.CLAMP_TO_EDGE)),this._dirty=!1),F&&this._prepareData(el)}loadTile(F,el){this.tileID&&this.tileID.equals(F.tileID.canonical)?(this.tiles[String(F.tileID.wrap)]=F,F.buckets={}):F.state="errored",el(null)}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(F){var el;let eh=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!eh)return null;let ec=this.elevatedGlobeTrianglesCenterLongitudes,ep=(el=F+180)+360*Math.round((ec[0]-el)/360),e_=new xo,a=(F,el)=>{e_.segments.push({vertexOffset:0,primitiveOffset:F,vertexLength:eh.segments[0].vertexLength,primitiveLength:el,sortKey:void 0,vaos:{}})},eg=.51*this.maxLongitudeTriangleSize;if(Math.abs(ec[0]-ep)<=eg){let F=_t(ec,0,ec.length,ep+eg);return F===ec.length||a(F,bt(ec,F+1,ec.length,ep+360-eg)-F),e_}ep<ec[0]&&(ep+=360);let ey=bt(ec,0,ec.length,ep-eg);if(ey===ec.length)return a(0,ec.length),e_;a(0,ey-0);let eb=_t(ec,ey+1,ec.length,ep+eg);return eb!==ec.length&&a(eb,ec.length-eb),e_}};let Wm=class Wm extends ma{constructor(F,el,eh,ec){super(F,{layout:e$||(e$=new Xs({visibility:new Gs(rw.layout_raster.visibility)})),paint:eH||(eH=new Xs({"raster-opacity":new Gs(rw.paint_raster["raster-opacity"]),"raster-color":new Hs(rw.paint_raster["raster-color"]),"raster-color-mix":new Gs(rw.paint_raster["raster-color-mix"]),"raster-color-range":new Gs(rw.paint_raster["raster-color-range"]),"raster-hue-rotate":new Gs(rw.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new Gs(rw.paint_raster["raster-brightness-min"]),"raster-brightness-max":new Gs(rw.paint_raster["raster-brightness-max"]),"raster-saturation":new Gs(rw.paint_raster["raster-saturation"]),"raster-contrast":new Gs(rw.paint_raster["raster-contrast"]),"raster-resampling":new Gs(rw.paint_raster["raster-resampling"]),"raster-fade-duration":new Gs(rw.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new Gs(rw.paint_raster["raster-emissive-strength"]),"raster-array-band":new Gs(rw.paint_raster["raster-array-band"]),"raster-elevation":new Gs(rw.paint_raster["raster-elevation"]),"raster-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(F){return!(F&&F._source instanceof Xm&&(F._source.onNorthPole||F._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(F){"raster-color"!==F&&"raster-color-range"!==F||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(F){if(!this.hasColorMap()||!this._curRampRange)return;let el=this._transitionablePaint._values["raster-color"].value.expression,[eh,ec]=F||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(eh)&&isNaN(ec)||eh===this._curRampRange[0]&&ec===this._curRampRange[1]||(this.colorRamp=dc({expression:el,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:eh,end:ec}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[eh,ec])}};let ry=class ry extends ma{constructor(F,el,eh,ec){super(F,{layout:eZ||(eZ=new Xs({visibility:new Gs(rw["layout_raster-particle"].visibility)})),paint:eW||(eW=new Xs({"raster-particle-array-band":new Gs(rw["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new Gs(rw["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new Hs(rw["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new Gs(rw["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new Gs(rw["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new Gs(rw["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new Gs(rw["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new Gs(rw["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec),this._updateColorRamp(),this.lastInvalidatedAt=tX.now()}onRemove(F){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(F){return!1}_handleSpecialPaintPropertyUpdate(F){"raster-particle-color"!==F&&"raster-particle-max-speed"!==F||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===F&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;let F=this._transitionablePaint._values["raster-particle-color"].value.expression,el=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=dc({expression:F,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:el}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=tX.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}};let ny=class ny extends ma{constructor(F,el){super(F,{},el,null),this.implementation=F,F.slot&&(this.slot=F.slot)}is3D(F){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(F){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(F){this.implementation.onAdd&&this.implementation.onAdd(F,F.painter.context.gl)}onRemove(F){this.implementation.onRemove&&this.implementation.onRemove(F,F.painter.context.gl)}};function iy(F,el,eh){let ec=[0,0,1],ep=tN.quat.identity([]);return tN.quat.rotateY(ep,ep,eh?-(F*tj)+Math.PI:F*tj),tN.quat.rotateX(ep,ep,-(el*tj)),tN.vec3.transformQuat(ec,ec,ep),tN.vec3.normalize(ec,ec)}function sy(F,el){let eh=oy(F.projection,F.zoom,F.width,F.height),ec=function(F,el,eh,ec,ep){let e_=new ul(eh.lng-180*nI,eh.lat),eg=new ul(eh.lng+180*nI,eh.lat),ey=F.project(e_.lng,e_.lat),eb=F.project(eg.lng,eg.lat),ew=-Math.atan2(eb.y-ey.y,eb.x-ey.x),eT=Il.fromLngLat(eh);eT.y=Q(eT.y,-1+nI,1-nI);let eS=eT.toLngLat(),eE=F.project(eS.lng,eS.lat),eM=Il.fromLngLat(eS);eM.x+=nI;let eI=eM.toLngLat(),eA=F.project(eI.lng,eI.lat),eC=cy(eA.x-eE.x,eA.y-eE.y,ew),eP=Il.fromLngLat(eS);eP.y+=nI;let ez=eP.toLngLat(),eD=F.project(ez.lng,ez.lat),eR=cy(eD.x-eE.x,eD.y-eE.y,ew),eL=Math.abs(eC.x)/Math.abs(eR.y),eO=tN.mat4.identity([]);tN.mat4.rotateZ(eO,eO,-ew*(1-(ep?0:ec)));let ek=tN.mat4.identity([]);return tN.mat4.scale(ek,ek,[1,1-(1-eL)*ec,1]),ek[4]=-eR.x/eR.y*ec,tN.mat4.rotateZ(ek,ek,ew),tN.mat4.multiply(ek,eO,ek),ek}(F.projection,0,F.center,eh,el),ep=ay(F);return tN.mat4.scale(ec,ec,[ep,ep,1]),ec}function ay(F){let el=F.projection,eh=oy(F.projection,F.zoom,F.width,F.height),ec=uy(el,F.center),ep=uy(el,ul.convert(el.center));return Math.pow(2,ec*eh+(1-eh)*ep)}function oy(F,el,eh,ec,ep=1/0){let e_=F.range;if(!e_)return 0;let eg=Math.min(ep,Math.max(eh,ec)),ey=Math.log(eg/1024)/Math.LN2;return tt(e_[0]+ey,e_[1]+ey,el)}let nI=1/4e4;function uy(F,el){let eh=Q(el.lat,-85.051129,85.051129),ec=new ul(el.lng-180*nI,eh),ep=new ul(el.lng+180*nI,eh),e_=F.project(ec.lng,eh),eg=F.project(ep.lng,eh),ey=Il.fromLngLat(ec),eb=Il.fromLngLat(ep),ew=eg.x-e_.x,eT=eg.y-e_.y,eS=eb.x-ey.x,eE=eb.y-ey.y,eM=Math.sqrt((eS*eS+eE*eE)/(ew*ew+eT*eT));return Math.log(eM)/Math.LN2}function cy(F,el,eh){let ec=Math.cos(eh),ep=Math.sin(eh);return{x:F*ec-el*ep,y:F*ep+el*ec}}function hy(F,el,eh){tN.mat4.identity(F),tN.mat4.rotateZ(F,F,el[2]*tj),tN.mat4.rotateX(F,F,el[0]*tj),tN.mat4.rotateY(F,F,el[1]*tj),tN.mat4.scale(F,F,eh),tN.mat4.multiply(F,F,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function py(F,el,eh,ec,ep,e_,eg,ey){let eb=[eh[0]-el[0],eh[1]-el[1],0],ew=[ec[0]-el[0],ec[1]-el[1],0];if(1e-12>tN.vec3.length(eb)||1e-12>tN.vec3.length(ew))return tN.quat.identity(F);let eT=tN.vec3.cross([],eb,ew);return tN.vec3.normalize(eT,eT),tN.vec3.subtract(ew,ec,el),eb[2]=(e_-ep)*ey,ew[2]=(eg-ep)*ey,tN.vec3.cross(eb,eb,ew),tN.vec3.normalize(eb,eb),tN.quat.rotationTo(F,eT,eb)}function fy(F,el,eh=!1){let ec=$u(el.zoom),ep=function(F,el,eh){let ec=el.worldSize,ep=[F[12],F[13],F[14]],e_=xl(ep[1]/ec),eg=gl(ep[0]/ec),ey=tN.mat4.identity([]),eb=1/fl(e_)*ec,ew=1/fl(0)*ec*wl(e_,el.zoom),eT=1/Uu(ec),eS=ew*eT;if(eh){let F=oy(el.projection,el.zoom,el.width,el.height,1024);eS=eT*el.projection.pixelSpaceConversion(el.center.lat,ec,F)}let eE=al(e_,eg);tN.vec3.add(eE,eE,tN.vec3.scale([],tN.vec3.normalize([],eE),eb*eS*ep[2]));let eM=function(F){let el=[F[0],F[1],F[2]],eh=[0,1,0],ec=tN.vec3.cross([],eh,el);return tN.vec3.cross(eh,el,ec),0===tN.vec3.squaredLength(eh)&&(eh=[0,1,0],tN.vec3.cross(ec,el,eh)),tN.vec3.normalize(ec,ec),tN.vec3.normalize(eh,eh),tN.vec3.normalize(el,el),[ec[0],ec[1],ec[2],0,eh[0],eh[1],eh[2],0,el[0],el[1],el[2],0,F[0],F[1],F[2],1]}(eE);tN.mat4.scale(ey,ey,[eS,eS,eS*eb]),tN.mat4.translate(ey,ey,[-ep[0],-ep[1],-ep[2]]);let eI=tN.mat4.multiply([],el.globeMatrix,eM);return tN.mat4.multiply(eI,eI,ey),tN.mat4.multiply(eI,eI,F),eI}(F,el,eh);if(ec>0){let eh=function(F,el){let eh=el.worldSize,ec=1/fl(0)*eh*wl(el.center.lat,el.zoom)/Uu(eh),ep=1/fl(el.center.lat)*eh,e_=tN.mat4.identity([]);return tN.mat4.rotateY(e_,e_,el.center.lng*tj),tN.mat4.rotateX(e_,e_,el.center.lat*tj),tN.mat4.translate(e_,e_,[0,0,rF]),tN.mat4.scale(e_,e_,[ec,ec,ec*ep]),tN.mat4.translate(e_,e_,[el.point.x-.5*eh,el.point.y-.5*eh,0]),tN.mat4.multiply(e_,e_,F),tN.mat4.multiply(e_,el.globeMatrix,e_)}(F,el);return function(F,el,eh){let n=(F,el,eh)=>{let ec=tN.vec3.length(F),ep=tN.vec3.length(el),e_=Tu(F,el,eh);return tN.vec3.scale(e_,e_,1/tN.vec3.length(e_)*Ee(ec,ep,eh))},ec=n([F[0],F[1],F[2]],[el[0],el[1],el[2]],eh),ep=n([F[4],F[5],F[6]],[el[4],el[5],el[6]],eh),e_=n([F[8],F[9],F[10]],[el[8],el[9],el[10]],eh),eg=Tu([F[12],F[13],F[14]],[el[12],el[13],el[14]],eh);return[ec[0],ec[1],ec[2],0,ep[0],ep[1],ep[2],0,e_[0],e_[1],e_[2],0,eg[0],eg[1],eg[2],1]}(ep,eh,ec)}return ep}function dy(F,el,eh,ec){let ep;let e_=Au.projectAabbCorners(ec,eh),eg=Number.MAX_VALUE,ey=-1;for(let F=0;F<e_.length;++F){let eh=e_[F];eh[0]=(.5*eh[0]+.5)*el.width,eh[1]=(.5-.5*eh[1])*el.height,eh[2]<eg&&(ey=F,eg=eh[2])}let o=F=>new tU(e_[F][0],e_[F][1]);switch(ey){case 0:case 6:ep=[o(1),o(5),o(4),o(7),o(3),o(2),o(1)];break;case 1:case 7:ep=[o(0),o(4),o(5),o(6),o(2),o(3),o(0)];break;case 3:case 5:ep=[o(1),o(0),o(4),o(7),o(6),o(2),o(1)];break;default:ep=[o(1),o(5),o(6),o(7),o(3),o(0),o(1)]}if(Fl(F,ep))return eg}let nA=va([{name:"a_pos_3f",components:3,type:"Float32"}]),nC=va([{name:"a_color_3f",components:3,type:"Float32"}]),nP=va([{name:"a_color_4f",components:4,type:"Float32"}]),nz=va([{name:"a_uv_2f",components:2,type:"Float32"}]),nD=va([{name:"a_normal_3f",components:3,type:"Float32"}]),nR=va([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),nL=va([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),nO={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};let My=class My{constructor(F,el,eh,ec){this.message=(F?`${F}: `:"")+eh,ec&&(this.identifier=ec),null!=el&&el.__line__&&(this.line=el.__line__)}};function Ay(F,el){let eh=-1===F.indexOf("://");try{return new URL(F,eh&&el?"http://example.com":void 0),!0}catch(F){return!1}}let Iy=class Iy{constructor(F,el){this.feature=F,this.instancedDataOffset=el,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}};let Sy=class Sy{constructor(){this.instancedDataArray=new Ja,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}};let Py=class Py{constructor(F){this.zoom=F.zoom,this.canonical=F.canonical,this.layers=F.layers,this.layerIds=this.layers.map(F=>F.fqid),this.projection=F.projection,this.index=F.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(F,el){}populate(F,el,eh,ec){this.tileToMeter=Al(eh);let ep=this.layers[0]._featureFilter.needGeometry;for(let{feature:e_,id:eg,index:ey,sourceLayerIndex:eb}of(this.lookup=new Uint8Array(this.lookupDim*this.lookupDim),F)){let F=null!=eg?eg:e_.properties&&e_.properties.hasOwnProperty("id")?e_.properties.id:void 0,ew=Cl(e_,ep);if(!this.layers[0]._featureFilter.filter(new Rs(this.zoom),ew,eh))continue;let eT={id:F,sourceLayerIndex:eb,index:ey,geometry:ep?ew.geometry:Vl(e_,eh,ec),properties:e_.properties,type:e_.type,patterns:{}},eS=this.addFeature(eT,eT.geometry,ew);eS&&el.featureIndex.insert(e_,eT.geometry,ey,eb,this.index,this.instancesPerModel[eS].instancedDataArray.length,256)}this.lookup=null}update(F,el,eh,ec){for(let el in this.instancesPerModel){let eh=this.instancesPerModel[el];for(let el in F)eh.idToFeaturesIndex.hasOwnProperty(el)&&(this.evaluate(eh.features[eh.idToFeaturesIndex[el]],F[el],eh,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let F=!1;for(let el in this.instancesPerModel){let eh=this.instancesPerModel[el];for(let el of eh.features){let ec=this.layers[0],ep=el.feature,e_=this.canonical,eg=ec.paint.get("model-rotation").evaluate(ep,{},e_),ey=ec.paint.get("model-scale").evaluate(ep,{},e_),eb=ec.paint.get("model-translation").evaluate(ep,{},e_);tN.vec3.exactEquals(el.rotation,eg)&&tN.vec3.exactEquals(el.scale,ey)&&tN.vec3.exactEquals(el.translation,eb)||(this.evaluate(el,el.featureStates,eh,!0),F=!0)}}return F}updateReplacement(F,el,eh,ec){if(el.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=el.updateTime;let ep=el.getReplacementRegionsForTile(F.toUnwrapped(),!0);if(Yh(this.activeReplacements,ep))return!1;this.activeReplacements=ep;let e_=!1;for(let el in this.instancesPerModel){let ep=this.instancesPerModel[el],eg=ep.instancedDataArray;for(let el of ep.features){let ep=el.instancedDataOffset,ey=el.instancedDataCount;for(let el=0;el<ey;el++){let ey=16*(el+ep),eb=eg.float32[ey+0],ew=eb>8192;eb=ew?eb-8192:eb;let eT=Math.floor(eb),eS=eg.float32[ey+1],eE=!1;for(let el of this.activeReplacements)if(!jh(el,eh,nO.Model,ec)&&!(el.min.x>eT||eT>el.max.x||el.min.y>eS||eS>el.max.y)&&(eE=Jh(Kh(eT,eS,F.canonical,el.footprintTileId.canonical),el.footprint)))break;eg.float32[ey]=eE?eb+8192:eb,e_=e_||eE!==ew}}}return e_}isEmpty(){for(let F in this.instancesPerModel)if(0!==this.instancesPerModel[F].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(F){if(!this.uploaded)for(let el in this.instancesPerModel){let eh=this.instancesPerModel[el];eh.instancedDataArray.length<0||0===eh.instancedDataArray.length||(eh.instancedDataBuffer?eh.instancedDataBuffer.updateData(eh.instancedDataArray):eh.instancedDataBuffer=F.createVertexBuffer(eh.instancedDataArray,nR.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(let F in this.instancesPerModel){let el=this.instancesPerModel[F];0!==el.instancedDataArray.length&&el.instancedDataBuffer&&el.instancedDataBuffer.destroy()}let F=this.layers[0].modelManager;if(F&&this.modelUris)for(let el of this.modelUris)F.removeModel(el,"")}addFeature(F,el,eh){let ec=this.layers[0],ep=ec.layout.get("model-id").evaluate(eh,{},this.canonical);if(!ep)return pt(`modelId is not evaluated for layer ${ec.id} and it is not going to get rendered.`),ep;Ay(ep,!1)&&(this.modelUris.includes(ep)||this.modelUris.push(ep)),this.instancesPerModel[ep]||(this.instancesPerModel[ep]=new Sy);let e_=this.instancesPerModel[ep],eg=e_.instancedDataArray,ey=new Iy(eh,eg.length);for(let F of el)for(let el of F){if(el.x<0||el.x>=8192||el.y<0||el.y>=8192)continue;let F=(this.lookupDim-1)/8192,eh=this.lookupDim*(el.y*F|0)+el.x*F|0;if(this.lookup){if(0!==this.lookup[eh])continue;this.lookup[eh]=1}this.instanceCount++;let ec=eg.length;eg.resize(ec+1),e_.instancesEvaluatedElevation.push(0),eg.float32[16*ec]=el.x,eg.float32[16*ec+1]=el.y}return ey.instancedDataCount=e_.instancedDataArray.length-ey.instancedDataOffset,ey.instancedDataCount>0&&(F.id&&(e_.idToFeaturesIndex[F.id]=e_.features.length),e_.features.push(ey),this.evaluate(ey,{},e_,!1)),ep}getModelUris(){return this.modelUris}evaluate(F,el,eh,ec){let ep=this.layers[0],e_=F.feature,eg=this.canonical,ey=F.rotation=ep.paint.get("model-rotation").evaluate(e_,el,eg),eb=F.scale=ep.paint.get("model-scale").evaluate(e_,el,eg),ew=F.translation=ep.paint.get("model-translation").evaluate(e_,el,eg),eT=ep.paint.get("model-color").evaluate(e_,el,eg);eT.a=ep.paint.get("model-color-mix-intensity").evaluate(e_,el,eg);let eS=[];this.maxVerticalOffset<ew[2]&&(this.maxVerticalOffset=ew[2]),this.maxScale=Math.max(Math.max(this.maxScale,eb[0]),Math.max(eb[1],eb[2])),hy(eS,ey,eb);let eE=Math.round(100*eT.a)+eT.b/1.05;for(let el=0;el<F.instancedDataCount;++el){let ep=F.instancedDataOffset+el,e_=16*ep,ey=eh.instancedDataArray.float32,eb=0;ec&&(eb=ey[e_+6]-eh.instancesEvaluatedElevation[ep]);let eM=0|ey[e_+1];ey[e_]=(0|ey[e_])+eT.r/1.05,ey[e_+1]=eM+eT.g/1.05,ey[e_+2]=eE,ey[e_+3]=1/(eg.z>10?this.tileToMeter:Al(eg,eM)),ey[e_+4]=ew[0],ey[e_+5]=ew[1],ey[e_+6]=ew[2]+eb,ey[e_+7]=eS[0],ey[e_+8]=eS[1],ey[e_+9]=eS[2],ey[e_+10]=eS[4],ey[e_+11]=eS[5],ey[e_+12]=eS[6],ey[e_+13]=eS[8],ey[e_+14]=eS[9],ey[e_+15]=eS[10],eh.instancesEvaluatedElevation[ep]=ew[2]}}};us(Py,"ModelBucket",{omit:["layers"]}),us(Sy,"PerModelAttributes"),us(Iy,"ModelFeature");let nk={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function By(F,el,eh,ec,ep,e_,eg,ey,eb,ew=!1){let eT=eh.zoom,eS=eh.project(ec),eE=wl(ec.lat,eT),eM=1/eE;tN.mat4.identity(F),tN.mat4.translate(F,F,[eS.x+eg[0]*eM,eS.y+eg[1]*eM,eg[2]]);let eI=1,eA=1,eC=eh.worldSize;if(ew){if("mercator"===eh.projection.name){let F=0;eh.elevation&&(F=eh.elevation.getAtPointOrZero(new Il(eS.x/eC,eS.y/eC),0));let el=tN.vec4.transformMat4([],[eS.x,eS.y,F,1],eh.projMatrix)[3]/eh.cameraToCenterDistance;eI=el,eA=el*wl(eh.center.lat,eT)}else if("globe"===eh.projection.name){let el=fy(F,eh),ep=tN.mat4.multiply([],eh.projMatrix,el),e_=[0,0,0,1];tN.vec4.transformMat4(e_,e_,ep);let eg=e_[3]/eh.cameraToCenterDistance,ey=$u(eT),eb=eh.projection.pixelsPerMeter(ec.lat,eC)*wl(ec.lat,eT),ew=eh.projection.pixelsPerMeter(eh.center.lat,eC)*wl(eh.center.lat,eT);eI=eg/Ee(eb,_l(eh.center.lat),ey),eA=eg*eE/eb,eI*=ew,eA*=ew}}else eI=eM;tN.mat4.scale(F,F,[eI,eI,eA]);let eP=[...F],ez=el.orientation,eD=[];if(hy(eD,[ez[0]+ep[0],ez[1]+ep[1],ez[2]+ep[2]],e_),tN.mat4.multiply(F,eP,eD),ey&&eh.elevation){let ep=0,e_=[];if(eb&&eh.elevation){ep=function(F,el,eh,ec,ep){let e_=el.elevation;if(!e_)return 0;let eg=Au.projectAabbCorners(eh,ec),ey=1/fl(ep.lat)*el.worldSize,eb=function(F,el){let eh=[0,0,1],ec=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(let ep of ec){let ec=F[ep.corners[0]],e_=F[ep.corners[1]],eg=F[ep.corners[2]],ey=[e_[0]-ec[0],e_[1]-ec[1],el*(e_[2]-ec[2])],eb=tN.vec3.cross(ey,ey,[eg[0]-ec[0],eg[1]-ec[1],el*(eg[2]-ec[2])]);tN.vec3.normalize(eb,eb),ep.dotProductWithUp=tN.vec3.dot(eb,eh)}return ec.sort((F,el)=>F.dotProductWithUp-el.dotProductWithUp),ec[0].corners}(eg,ey),ew=eg[eb[0]],eT=eg[eb[1]],eS=eg[eb[2]],eE=eg[eb[3]],eM=e_.getAtPointOrZero(new Il(ew[0]/el.worldSize,ew[1]/el.worldSize),0),eI=e_.getAtPointOrZero(new Il(eT[0]/el.worldSize,eT[1]/el.worldSize),0),eA=e_.getAtPointOrZero(new Il(eS[0]/el.worldSize,eS[1]/el.worldSize),0),eC=e_.getAtPointOrZero(new Il(eE[0]/el.worldSize,eE[1]/el.worldSize),0),eP=(eM+eC)/2,ez=(eI+eA)/2;return eP>ez?eI<eA?py(F,eT,eE,ew,eI,eC,eM,ey):py(F,eS,ew,eE,eA,eM,eC,ey):eM<eC?py(F,ew,eT,eS,eM,eI,eA,ey):py(F,eE,eS,eT,eC,eA,eI,ey),Math.max(eP,ez)}(e_,eh,el.aabb,F,ec);let eg=tN.mat4.fromQuat([],e_),ey=tN.mat4.multiply([],eg,eD);tN.mat4.multiply(F,eP,ey)}else ep=eh.elevation.getAtPointOrZero(new Il(eS.x/eC,eS.y/eC),0);0!==ep&&(F[14]+=ep)}}function Vy(F,el,eh=!1){F.uploaded||(F.gfxTexture=new qm(el,F.image,eh?el.gl.R8:el.gl.RGBA8,{useMipmap:F.sampler.minFilter>=el.gl.NEAREST_MIPMAP_NEAREST}),F.uploaded=!0,F.image=null)}function Dy(F,el,eh){if(F.meshes)for(let ec of F.meshes)!function(F,el,eh){F.indexBuffer=el.createIndexBuffer(F.indexArray,!1,!0),F.vertexBuffer=el.createVertexBuffer(F.vertexArray,nA.members,!1,!0),F.normalArray&&(F.normalBuffer=el.createVertexBuffer(F.normalArray,nD.members,!1,!0)),F.texcoordArray&&(F.texcoordBuffer=el.createVertexBuffer(F.texcoordArray,nz.members,!1,!0)),F.colorArray&&(F.colorBuffer=el.createVertexBuffer(F.colorArray,(12===F.colorArray.bytesPerElement?nC:nP).members,!1,!0)),F.featureArray&&(F.pbrBuffer=el.createVertexBuffer(F.featureArray,nL.members,!0)),F.segments=xo.simpleSegment(0,0,F.vertexArray.length,F.indexArray.length);let ec=F.material;ec.pbrMetallicRoughness.baseColorTexture&&Vy(ec.pbrMetallicRoughness.baseColorTexture,el),ec.pbrMetallicRoughness.metallicRoughnessTexture&&Vy(ec.pbrMetallicRoughness.metallicRoughnessTexture,el),ec.normalTexture&&Vy(ec.normalTexture,el),ec.occlusionTexture&&Vy(ec.occlusionTexture,el,eh),ec.emissionTexture&&Vy(ec.emissionTexture,el)}(ec,el,eh);if(F.children)for(let ec of F.children)Dy(ec,el,eh)}function Ry(F){if(F.meshes)for(let el of F.meshes)el.indexArray.destroy(),el.vertexArray.destroy(),el.colorArray&&el.colorArray.destroy(),el.normalArray&&el.normalArray.destroy(),el.texcoordArray&&el.texcoordArray.destroy(),el.featureArray&&el.featureArray.destroy();if(F.children)for(let el of F.children)Ry(el)}function Ly(F){var el;if(F.meshes)for(let eh of F.meshes)eh.vertexBuffer&&(eh.vertexBuffer.destroy(),eh.indexBuffer.destroy(),eh.normalBuffer&&eh.normalBuffer.destroy(),eh.texcoordBuffer&&eh.texcoordBuffer.destroy(),eh.colorBuffer&&eh.colorBuffer.destroy(),eh.pbrBuffer&&eh.pbrBuffer.destroy(),eh.segments.destroy(),eh.material&&((el=eh.material).pbrMetallicRoughness.baseColorTexture&&el.pbrMetallicRoughness.baseColorTexture.gfxTexture&&el.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),el.pbrMetallicRoughness.metallicRoughnessTexture&&el.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&el.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),el.normalTexture&&el.normalTexture.gfxTexture&&el.normalTexture.gfxTexture.destroy(),el.emissionTexture&&el.emissionTexture.gfxTexture&&el.emissionTexture.gfxTexture.destroy(),el.occlusionTexture&&el.occlusionTexture.gfxTexture&&el.occlusionTexture.gfxTexture.destroy()));if(F.children)for(let el of F.children)Ly(el)}let Fy=class Fy{constructor(F,el,eh){this._demTile=F,this._dem=this._demTile.dem,this._scale=el,this._offset=eh}static create(F,el,eh){let ec=eh||F.findDEMTileFor(el);if(!ec||!ec.dem)return;let ep=ec.dem,e_=ec.tileID,eg=1<<el.canonical.z-e_.canonical.z;return new Fy(ec,ep.dim/8192/eg,[(el.canonical.x/eg-e_.canonical.x)*ep.dim,(el.canonical.y/eg-e_.canonical.y)*ep.dim])}tileCoordToPixel(F,el){let eh=el*this._scale+this._offset[1],ec=Math.floor(F*this._scale+this._offset[0]),ep=Math.floor(eh);return new tU(ec,ep)}getElevationAt(F,el,eh,ec){let ep=F*this._scale+this._offset[0],e_=el*this._scale+this._offset[1],eg=Math.floor(ep),ey=Math.floor(e_),eb=this._dem;return ec=!!ec,eh?Ee(Ee(eb.get(eg,ey,ec),eb.get(eg,ey+1,ec),e_-ey),Ee(eb.get(eg+1,ey,ec),eb.get(eg+1,ey+1,ec),e_-ey),ep-eg):eb.get(eg,ey,ec)}getElevationAtPixel(F,el,eh){return this._dem.get(F,el,!!eh)}getMeterToDEM(F){return(1<<this._demTile.tileID.canonical.z)*(1/fl(F))*this._dem.stride}};let nF=new Float32Array(262144),nB=new Uint8Array(262144),nN=["","wall","door","roof","window","lamp","logo"];let $y=class $y{constructor(F){this.node=F,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:F.id,geometry:[],properties:{height:function Uy(F){let el=0;if(F.meshes)for(let eh of F.meshes)el=Math.max(el,eh.aabb.max[2]);if(F.children)for(let eh of F.children)el=Math.max(el,Uy(eh));return el}(F)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let F=0,el=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(let eh of this.node.meshes)this.node.lightMeshIndex!==F&&(eh.transformedAabb=Au.applyTransformFast(eh.aabb,this.node.matrix),el.encapsulate(eh.transformedAabb)),F++;this.aabb=el}return this.aabb}};let Gy=class Gy{constructor(F,el,eh,ec,ep,e_,eg){for(let ey of(this.id=eh,this.layers=F,this.layerIds=this.layers.map(F=>F.fqid),this.stateDependentLayerIds=this.layers.filter(F=>F.isStateDependent()).map(F=>F.id),this.modelTraits|=nk.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,ec&&(this.modelTraits|=nk.HasMapboxMeshFeatures),ep&&(this.modelTraits|=nk.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=e_,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[],el))this.nodesInfo.push(new $y(ey)),function jy(F,el,eh){if(F.meshes)for(let ec of F.meshes){if(ec.aabb.min[0]===1/0)continue;let ep=Au.applyTransform(ec.aabb,F.matrix);eh.insert(el,ep.min[0],ep.min[1],ep.max[0],ep.max[1])}if(F.children)for(let ec of F.children)jy(ec,el,eh)}(ey,eg.featureIndexArray.length,eg.grid),eg.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,eg.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(F,el){for(let eh of this.getNodesInfo()){let ec=eh.node;ec.footprint&&el.push({footprint:ec.footprint,id:F})}}update(F){let el=0!==Object.keys(F).length;if(el&&!this.stateDependentLayers.length)return;let eh=el?this.stateDependentLayers:this.layers;if(!$(F,this.states))for(let el of eh)this.evaluate(el,F);this.states=structuredClone(F)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(F){if(!this.needsUpload)return;let el=this.getNodesInfo();for(let eh of el){let el=eh.node;this.uploaded?this.updatePbrBuffer(el):Dy(el,F,!0)}for(let F of el)Ry(F.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(F){let el=!1;if(!F.meshes)return el;for(let eh of F.meshes)eh.pbrBuffer&&(eh.pbrBuffer.updateData(eh.featureArray),el=!0);return el}needsReEvaluation(F,el,eh){let ec=F.transform.projectionOptions,ep=F.style.getBrightness(),e_=this.brightness!==ep;if(!this.uploaded||this.dirty||ec.name!==this.projection.name||Yy(eh.paint.get("model-color").value,e_)||Yy(eh.paint.get("model-color-mix-intensity").value,e_)||Yy(eh.paint.get("model-roughness").value,e_)||Yy(eh.paint.get("model-emissive-strength").value,e_)||Yy(eh.paint.get("model-height-based-emissive-strength-multiplier").value,e_)){this.projection=ec,this.brightness=ep;let F=this.getNodesInfo();for(let el of F)el.state=null;return!0}return!1}evaluateScale(F,el){if(F.transform.zoom===this.zoom)return;this.zoom=F.transform.zoom;let eh=this.getNodesInfo(),ec=this.id.canonical;for(let F of eh){let eh=F.feature;F.evaluatedScale=el.paint.get("model-scale").evaluate(eh,{},ec)}}evaluate(F,el){let eh=this.getNodesInfo();for(let ec of eh){if(!ec.node.meshes)continue;let eh=ec.feature,ep=el&&el[eh.id];if($(ep,ec.state))continue;ec.state=structuredClone(ep);let e_=ec.node.meshes&&ec.node.meshes[0].featureData,eg=ec.evaluatedColor[2],ey=ec.evaluatedRMEA[2],eb=this.id.canonical;if(ec.hasTranslucentParts=!1,e_){for(let el=0;el<nN.length;el++){let e_=nN[el];e_.length&&(eh.properties.part=e_);let eg=F.paint.get("model-color").evaluate(eh,ep,eb).toRenderColor(null),ey=F.paint.get("model-color-mix-intensity").evaluate(eh,ep,eb);ec.evaluatedColor[el]=[eg.r,eg.g,eg.b,ey],ec.evaluatedRMEA[el][0]=F.paint.get("model-roughness").evaluate(eh,ep,eb),ec.evaluatedRMEA[el][2]=F.paint.get("model-emissive-strength").evaluate(eh,ep,eb),ec.evaluatedRMEA[el][3]=eg.a,ec.emissionHeightBasedParams[el]=F.paint.get("model-height-based-emissive-strength-multiplier").evaluate(eh,ep,eb),!ec.hasTranslucentParts&&eg.a<1&&(ec.hasTranslucentParts=!0)}delete eh.properties.part,function(F,el,eh){let ec=F.node,ep=0,e_=eh&nk.HasMeshoptCompression;for(let eh of ec.meshes){if(ec.lights&&ec.lightMeshIndex===ep||!eh.featureData)continue;eh.featureArray=new Qa,eh.featureArray.reserve(eh.featureData.length);let eg=el;for(let el of eh.featureData){let ep;let ey=e_?65535&el:el>>16&65535,eb=e_?el>>16&65535:65535&el,ew=(15&eb)<8?15&eb:0,eT=F.evaluatedRMEA[ew],eS=F.evaluatedColor[ew],eE=F.emissionHeightBasedParams[ew];if(eg&&2===ew&&ec.lights&&(ep=new Qa).resize(10*ec.lights.length),function(F,el,eh,ec,ep,e_,eg,ey){let eb,ew,eT,eS,eE=(61440&el|(61440&el)>>4)>>8,eM=(3840&el|(3840&el)>>4)>>4,eI=240&el|(240&el)>>4;eh[3]>0&&(eE=Ee(eE,255*eh[0],eh[3]),eM=Ee(eM,255*eh[1],eh[3]),eI=Ee(eI,255*eh[2],eh[3]));let eA=eE<<8|eM,eC=eI<<8|Math.floor(255*ec[3]),eP=function(F){let el=Q(F,0,2);return Math.min(Math.round(.5*el*255),255)}(ec[2])<<8|15*ec[0]<<4|15*ec[1],ez=Q(ep[0],0,1),eD=Q(ep[1],0,1),eR=Q(ep[2],0,1),eL=Q(ep[3],0,1);if(ez!==eD&&eg!==e_&&eD!==ez){let F=eg-e_;ew=1/(F*(eD-ez)),eT=-(e_+F*ez)/(F*(eD-ez));let el=Q(ep[4],-1,1);eS=Math.pow(10,el),eb=255*eR<<8|255*eL}else eb=65535,ew=0,eT=1,eS=1;if(F.emplaceBack(eA,eC,eP,eb,ew,eT,eS),ey){let F=ey.length;ey.clear();for(let el=0;el<F;el++)ey.emplaceBack(eA,eC,eP,eb,ew,eT,eS)}}(eh.featureArray,ey,eS,eT,eE,eh.aabb.min[2],eh.aabb.max[2],ep),ep&&eg){eg=!1;let F=ec.meshes[ec.lightMeshIndex];F.featureArray=ep,F.featureArray._trim()}}eh.featureArray._trim(),ep++}}(ec,eg!==ec.evaluatedColor[2]||ey!==ec.evaluatedRMEA[2],this.modelTraits)}else ec.evaluatedRMEA[0][2]=F.paint.get("model-emissive-strength").evaluate(eh,ep,eb);ec.evaluatedScale=F.paint.get("model-scale").evaluate(eh,ep,eb),this.updatePbrBuffer(ec.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(F,el,eh,ec){let ep=F.findDEMTileFor(eh);if(ep&&(ep.tileID.canonical!==this.terrainTile||el!==this.terrainExaggeration)){if(ep.dem&&ep.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=ep.tileID.overscaledZ;let el=Fy.create(F,eh,ep);if(!el)return;for(let ep of(this.modelTraits&nk.HasMapboxMeshFeatures&&this.updateDEM(F,el,eh,ec),this.getNodesInfo())){let F=ep.node;if(!F.footprint||!F.footprint.vertices||!F.footprint.vertices.length)continue;let eh=F.footprint.vertices,ec=el.getElevationAt(eh[0].x,eh[0].y,!0,!0);for(let F=1;F<eh.length;F++)ec=Math.min(ec,el.getElevationAt(eh[F].x,eh[F].y,!0,!0));F.elevation=ec}}this.terrainTile=ep.tileID.canonical,this.terrainExaggeration=el}}updateDEM(F,el,eh,ec){let ep=el._dem._modifiedForSources[ec];if(void 0===ep&&(el._dem._modifiedForSources[ec]=[],ep=el._dem._modifiedForSources[ec]),ep.includes(eh.canonical))return;let e_=el._dem.dim;ep.push(eh.canonical);let eg=!1;for(let F of this.getNodesInfo()){let eh=F.node;if(!eh.footprint||!eh.footprint.grid)continue;let ec=eh.footprint.grid,ep=el.tileCoordToPixel(ec.min.x,ec.min.y),ey=el.tileCoordToPixel(ec.max.x,ec.max.y),eb=Math.min(Math.min(e_-ey.y,ep.x),Math.min(ep.y,e_-ey.x));if(eb<0)continue;let ew=Q(eb,2,5),eT=Math.max(0,ep.x-ew),eS=Math.max(0,ep.y-ew),eE=Math.min(ey.x+ew,e_-1),eM=Math.min(ey.y+ew,e_-1);for(let F=eS;F<=eM;++F)for(let el=eT;el<=eE;++el)nB[F*e_+el]=255;let eI=0,eA=0;for(let F=0;F<ec.cellsY;++F)for(let eh=0;eh<ec.cellsX;++eh){if(!ec.cells[F*ec.cellsX+eh])continue;let ep=el.tileCoordToPixel(ec.min.x+eh/ec.xScale,ec.min.y+F/ec.yScale),eg=el.tileCoordToPixel(ec.min.x+(eh+1)/ec.xScale,ec.min.y+(F+1)/ec.yScale);for(let F=ep.y;F<=Math.min(eg.y+1,e_-1);++F)for(let eh=ep.x;eh<=Math.min(eg.x+1,e_-1);++eh)255===nB[F*e_+eh]&&(nB[F*e_+eh]=0,eI+=el.getElevationAtPixel(eh,F),eA++)}let eC=eI/eA;eT=Math.max(1,ep.x-ew),eS=Math.max(1,ep.y-ew),eE=Math.min(ey.x+ew,e_-2),eM=Math.min(ey.y+ew,e_-2),eg=!0;for(let F=eS;F<=eM;++F)for(let eh=eT;eh<=eE;++eh)0===nB[F*e_+eh]&&(nF[F*e_+eh]=el._dem.set(eh,F,eC));for(let F=1;F<ew;++F){eT=Math.max(1,ep.x-F),eS=Math.max(1,ep.y-F),eE=Math.min(ey.x+F,e_-2),eM=Math.min(ey.y+F,e_-2);for(let eh=eS;eh<=eM;++eh)for(let ec=eT;ec<=eE;++ec){let ep=eh*e_+ec;if(255===nB[ep]){let eg=0,ey=0,eb=-1,eT=-1;for(let el=-1;el<=1;++el)for(let ep=-1;ep<=1;++ep){let ew=(eh+el)*e_+ec+ep;if(nB[ew]>=F)continue;let eS=nF[ew],eE=Math.abs(eS);eE>ey&&(eg=eS,ey=eE,eb=ep,eT=el)}if(ey>.1){let e_=1-(F+.5*Math.abs(eb*eT))/ew,ey=el._dem.get(ec,eh)+eg*e_,eS=el._dem.get(ec+eb,eh+eT),eE=el._dem.get(ec-eb,eh-eT,!0);(ey-eS)*(ey-eE)>0&&(ey=(eS+eE)/2),nF[ep]=el._dem.set(ec,eh,ey),nB[ep]=F}}}}}eg&&(el._demTile.needsDEMTextureUpload=!0,el._dem._timestamp=tX.now())}setFilter(F){this.filter=F?Qs(F):null}getNodesInfo(){return this.filter?this.nodesInfo.filter(F=>this.filter.filter(new Rs(this.id.overscaledZ),F.feature,this.id.canonical)):this.nodesInfo}destroy(){let F=this.getNodesInfo();for(let el of F)Ry(el.node),Ly(el.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(F,el){if(el.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=el.updateTime;let eh=el.getReplacementRegionsForTile(F.toUnwrapped()),ec=this.getNodesInfo();for(let F=0;F<this.nodesInfo.length;F++){let el=ec[F].node;ec[F].hiddenByReplacement=!!el.footprint&&!eh.find(F=>F.footprint===el.footprint)}}getHeightAtTileCoord(F,el){let eh=this.getNodesInfo(),ec=[],ep=[0,0,0],e_=tN.mat4.identity([]);for(let eg=0;eg<this.nodesInfo.length;eg++){let ey=eh[eg],eb=ey.node.meshes[0],ew=eb.transformedAabb;if(F<ew.min[0]||el<ew.min[1]||F>ew.max[0]||el>ew.max[1])continue;if(!0===ey.node.hidden)return{height:1/0,maxHeight:ey.feature.properties.height,hidden:!1,verticalScale:ey.evaluatedScale[2]};tN.mat4.invert(e_,ey.node.matrix),ep[0]=F,ep[1]=el,tN.vec3.transformMat4(ep,ep,e_);let eT=(ep[0]-eb.aabb.min[0])/(eb.aabb.max[0]-eb.aabb.min[0])*64|0,eS=64*Math.min(63,(ep[1]-eb.aabb.min[1])/(eb.aabb.max[1]-eb.aabb.min[1])*64|0)+Math.min(63,eT),eE=eb.heightmap[eS];if(!(eE<0&&ey.node.footprint)){if(ey.hiddenByReplacement)return;return{height:eE,maxHeight:ey.feature.properties.height,hidden:!1,verticalScale:ey.evaluatedScale[2]}}if(ey.node.footprint.grid.query(new tU(F,el),new tU(F,el),ec),ec.length>0)return{height:void 0,maxHeight:ey.feature.properties.height,hidden:ey.hiddenByReplacement,verticalScale:ey.evaluatedScale[2]}}}};function Yy(F,el){return!F.isLightConstant&&el}function Zy(F,el,eh,ec){let ep=1<<F.z;el.lat=xl((ec/8192+F.y)/ep),el.lng=gl((eh/8192+F.x)/ep)}us(Gy,"Tiled3dModelBucket",{omit:["layers"]}),us($y,"Tiled3dModelFeature");let nV={circle:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eS||(eS=new Xs({"circle-sort-key":new Ys(rw.layout_circle["circle-sort-key"]),"circle-elevation-reference":new Gs(rw.layout_circle["circle-elevation-reference"]),visibility:new Gs(rw.layout_circle.visibility)})),paint:eE||(eE=new Xs({"circle-radius":new Ys(rw.paint_circle["circle-radius"]),"circle-color":new Ys(rw.paint_circle["circle-color"]),"circle-blur":new Ys(rw.paint_circle["circle-blur"]),"circle-opacity":new Ys(rw.paint_circle["circle-opacity"]),"circle-translate":new Gs(rw.paint_circle["circle-translate"]),"circle-translate-anchor":new Gs(rw.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new Gs(rw.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new Gs(rw.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Ys(rw.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Ys(rw.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Ys(rw.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new Gs(rw.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec)}createBucket(F){return new Ll(F)}queryRadius(F){return Jl("circle-radius",this,F)+Jl("circle-stroke-width",this,F)+Ql(this.paint.get("circle-translate"))}queryIntersectsFeature(F,el,eh,ec,ep,e_,eg,ey){let eb=eu(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),e_.angle,F.pixelToTileUnitsFactor),ew=this.paint.get("circle-radius").evaluate(el,eh)+this.paint.get("circle-stroke-width").evaluate(el,eh);return Ju(F,ec,e_,eg,ey,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),eb,ew)}getProgramIds(){return["circle"]}getDefaultProgramParams(F,el,eh){let ec=Ku(this);return{config:new $o(this,{zoom:el,lut:eh}),defines:ec,overrideFog:!1}}},heatmap:class extends ma{createBucket(F){return new nc(F)}constructor(F,el,eh,ec){super(F,{layout:eM||(eM=new Xs({visibility:new Gs(rw.layout_heatmap.visibility)})),paint:eI||(eI=new Xs({"heatmap-radius":new Ys(rw.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Ys(rw.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new Gs(rw.paint_heatmap["heatmap-intensity"]),"heatmap-color":new Hs(rw.paint_heatmap["heatmap-color"]),"heatmap-opacity":new Gs(rw.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"heatmap-color"===F&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(F){return Jl("heatmap-radius",this,F)}queryIntersectsFeature(F,el,eh,ec,ep,e_,eg,ey){let eb=this.paint.get("heatmap-radius").evaluate(el,eh);return Ju(F,ec,e_,eg,ey,!0,!0,new tU(0,0),eb)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(F,el,eh){return"heatmap"===F?{config:new $o(this,{zoom:el,lut:eh}),overrideFog:!1}:{}}},hillshade:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eA||(eA=new Xs({visibility:new Gs(rw.layout_hillshade.visibility)})),paint:eC||(eC=new Xs({"hillshade-illumination-direction":new Gs(rw.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new Gs(rw.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new Gs(rw.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new Gs(rw.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new Gs(rw.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new Gs(rw.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new Gs(rw.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(F,el,eh){return{overrideFog:!1}}},fill:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eP||(eP=new Xs({"fill-sort-key":new Ys(rw.layout_fill["fill-sort-key"]),visibility:new Gs(rw.layout_fill.visibility),"fill-elevation-reference":new Gs(rw.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Ys(rw.layout_fill["fill-construct-bridge-guard-rail"])})),paint:ez||(ez=new Xs({"fill-antialias":new Gs(rw.paint_fill["fill-antialias"]),"fill-opacity":new Ys(rw.paint_fill["fill-opacity"]),"fill-color":new Ys(rw.paint_fill["fill-color"]),"fill-outline-color":new Ys(rw.paint_fill["fill-outline-color"]),"fill-translate":new Gs(rw.paint_fill["fill-translate"]),"fill-translate-anchor":new Gs(rw.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ys(rw.paint_fill["fill-pattern"]),"fill-emissive-strength":new Gs(rw.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Ys(rw.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Ys(rw.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Ys(rw.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec)}getProgramIds(){let F=this.paint.get("fill-pattern"),el=F&&F.constantOr(1),eh=[el?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&eh.push(el&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),eh}getDefaultProgramParams(F,el,eh){return{config:new $o(this,{zoom:el,lut:eh}),overrideFog:!1}}recalculate(F,el){super.recalculate(F,el);let eh=this.paint._values["fill-outline-color"];"constant"===eh.value.kind&&void 0===eh.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(F){return new _h(F)}queryRadius(){return Ql(this.paint.get("fill-translate"))}queryIntersectsFeature(F,el,eh,ec,ep,e_){return!F.queryGeometry.isAboveHorizon&&Nl(tu(F.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),e_.angle,F.pixelToTileUnitsFactor),ec)}isTileClipped(){return 0===this.paint.get("fill-z-offset").constantOr(1)}is3D(F){if(0!==this.paint.get("fill-z-offset").constantOr(1))return!0;let el=this.layout&&"none"!==this.layout.get("fill-elevation-reference");return null!=F?el&&!F:el}},"fill-extrusion":class extends ma{constructor(F,el,eh,ec){super(F,{layout:eL||(eL=new Xs({visibility:new Gs(rw["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new Gs(rw["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:eO||(eO=new Xs({"fill-extrusion-opacity":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Ys(rw["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new Gs(rw["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new vp(F)}queryRadius(){return Ql(this.paint.get("fill-extrusion-translate"))}is3D(F){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(F,el,eh,ec,ep,e_,eg,ey,eb){var ew,eT,eS,eE;let eM=eu(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),e_.angle,F.pixelToTileUnitsFactor),eI=this.paint.get("fill-extrusion-height").evaluate(el,eh),eA=this.paint.get("fill-extrusion-base").evaluate(el,eh),eC=[0,0],eP=ey&&e_.elevation,ez=e_.elevation?e_.elevation.exaggeration():1,eD=F.tile.getBucket(this);if(eP&&eD instanceof vp){let F=eD.centroidVertexArray,el=eb+1;el<F.length&&(eC[0]=F.geta_centroid_pos0(el),eC[1]=F.geta_centroid_pos1(el))}if(0===eC[0]&&1===eC[1])return!1;"globe"===e_.projection.name&&(ec=Ep([ec],[new tU(0,0),new tU(8192,8192)],F.tileID.canonical).map(F=>F.polygon).flat());let[eR,eL]=(ew=ec,eT=eP?ey:null,eS=e_.center.lat,eE=F.tileID.canonical,"globe"===e_.projection.name?function(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT){let eS=[],eE=[],eM=F.projection.upVectorScale(eT,F.center.lat,F.worldSize).metersToTile,eI=[0,0,0,1],eA=[0,0,0,1],y=(F,el,eh,ec)=>{F[0]=el,F[1]=eh,F[2]=ec,F[3]=1},eC=Pp();for(let eP of(eh>0&&(eh+=eC),ec+=eC,el)){let el=[],eC=[];for(let eS of eP){let eE=eS.x+ep.x,eP=eS.y+ep.y,ez=F.projection.projectTilePoint(eE,eP,eT),eD=F.projection.upVector(eT,eS.x,eS.y),eR=eh,eL=ec;if(eg){let F=Cp(eE,eP,eh,ec,eg,ey,eb,ew);eR+=F.base,eL+=F.top}0!==eh?y(eI,ez.x+eD[0]*eM*eR,ez.y+eD[1]*eM*eR,ez.z+eD[2]*eM*eR):y(eI,ez.x,ez.y,ez.z),y(eA,ez.x+eD[0]*eM*eL,ez.y+eD[1]*eM*eL,ez.z+eD[2]*eM*eL),tN.vec3.transformMat4(eI,eI,e_),tN.vec3.transformMat4(eA,eA,e_),el.push(new Rh(eI[0],eI[1],eI[2])),eC.push(new Rh(eA[0],eA[1],eA[2]))}eS.push(el),eE.push(eC)}return[eS,eE]}(e_,ew,eA,eI,eM,eg,eT,eC,ez,eS,eE):eT?function(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=[],eT=[],eS=[0,0,0,1];for(let eE of F){let F=[],eM=[];for(let ew of eE){let eT=ew.x+ec.x,eE=ew.y+ec.y,eI=Cp(eT,eE,el,eh,e_,eg,ey,eb);eS[0]=eT,eS[1]=eE,eS[2]=eI.base,eS[3]=1,tN.vec4.transformMat4(eS,eS,ep),eS[3]=Math.max(eS[3],1e-5);let eA=new Rh(eS[0]/eS[3],eS[1]/eS[3],eS[2]/eS[3]);eS[0]=eT,eS[1]=eE,eS[2]=eI.top,eS[3]=1,tN.vec4.transformMat4(eS,eS,ep),eS[3]=Math.max(eS[3],1e-5);let eC=new Rh(eS[0]/eS[3],eS[1]/eS[3],eS[2]/eS[3]);F.push(eA),eM.push(eC)}ew.push(F),eT.push(eM)}return[ew,eT]}(ew,eA,eI,eM,eg,eT,eC,ez,eS):function(F,el,eh,ec,ep){let e_=[],eg=[],ey=ep[8]*el,eb=ep[9]*el,ew=ep[10]*el,eT=ep[11]*el,eS=ep[8]*eh,eE=ep[9]*eh,eM=ep[10]*eh,eI=ep[11]*eh;for(let el of F){let F=[],eh=[];for(let e_ of el){let el=e_.x+ec.x,eg=e_.y+ec.y,eA=ep[0]*el+ep[4]*eg+ep[12],eC=ep[1]*el+ep[5]*eg+ep[13],eP=ep[2]*el+ep[6]*eg+ep[14],ez=ep[3]*el+ep[7]*eg+ep[15],eD=eA+ey,eR=eC+eb,eL=eP+ew,eO=Math.max(ez+eT,1e-5),ek=eA+eS,eF=eC+eE,eB=eP+eM,eN=Math.max(ez+eI,1e-5);F.push(new Rh(eD/eO,eR/eO,eL/eO)),eh.push(new Rh(ek/eN,eF/eN,eB/eN))}e_.push(F),eg.push(eh)}return[e_,eg]}(ew,eA,eI,eM,eg)),eO=F.queryGeometry;return function(F,el,eh){let ec=1/0;Nl(eh,el)&&(ec=Vp(eh,el[0]));for(let ep=0;ep<el.length;ep++){let e_=el[ep],eg=F[ep];for(let F=0;F<e_.length-1;F++){let el=e_[F],ep=[el,e_[F+1],eg[F+1],eg[F],el];Fl(eh,ep)&&(ec=Math.min(ec,Vp(eh,ep)))}}return ec!==1/0&&ec}(eR,eL,eO.isPointQuery()?eO.screenBounds:eO.screenGeometry)}},line:class extends ma{constructor(F,el,eh,ec){let ep=nf();super(F,ep,el,eh,ec),ep.layout&&(this.layout=new $s(ep.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(F){if("line-gradient"===F){let F=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=F._styleExpression&&F._styleExpression.expression instanceof Un,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(F,el){super.recalculate(F,el),this.paint._values["line-floorwidth"]=(()=>{if(eN)return eN;let F=nf();return(eN=new sf(F.paint.properties["line-width"].specification)).useIntegerZoom=!0,eN})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,F)}createBucket(F){return new Yp(F)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(F,el,eh){let ec=tf(this);return{config:new $o(this,{zoom:el,lut:eh}),defines:ec,overrideFog:!1}}queryRadius(F){var el,eh;let ec=(el=Jl("line-width",this,F),(eh=Jl("line-gap-width",this,F))>0?eh+2*el:el),ep=Jl("line-offset",this,F);return ec/2+Math.abs(ep)+Ql(this.paint.get("line-translate"))}queryIntersectsFeature(F,el,eh,ec,ep,e_){var eg,ey;if(F.queryGeometry.isAboveHorizon)return!1;let eb=tu(F.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),e_.angle,F.pixelToTileUnitsFactor),ew=F.pixelToTileUnitsFactor/2*(eg=this.paint.get("line-width").evaluate(el,eh),(ey=this.paint.get("line-gap-width").evaluate(el,eh))>0?ey+2*eg:eg),eT=this.paint.get("line-offset").evaluate(el,eh);return eT&&(ec=function(F,el){let eh=[],ec=new tU(0,0);for(let ep=0;ep<F.length;ep++){let e_=F[ep],eg=[];for(let F=0;F<e_.length;F++){let eh=e_[F],ep=e_[F+1],ey=0===F?ec:eh.sub(e_[F-1])._unit()._perp(),eb=F===e_.length-1?ec:ep.sub(eh)._unit()._perp(),ew=ey._add(eb)._unit();ew._mult(1/(ew.x*eb.x+ew.y*eb.y)),eg.push(ew._mult(el)._add(eh))}eh.push(eg)}return eh}(ec,eT*F.pixelToTileUnitsFactor)),function(F,el,eh){for(let ec=0;ec<el.length;ec++){let ep=el[ec];if(F.length>=3){for(let el=0;el<ep.length;el++)if(Hl(F,ep[el]))return!0}if(function(F,el,eh){if(F.length>1){if(jl(F,el))return!0;for(let ec=0;ec<el.length;ec++)if($l(el[ec],F,eh))return!0}for(let ec=0;ec<F.length;ec++)if($l(F[ec],el,eh))return!0;return!1}(F,ep,eh))return!0}return!1}(eb,ec,ew)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(F){return!this.hasElevatedBuckets}},symbol:Dm,background:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eG||(eG=new Xs({visibility:new Gs(rw.layout_background.visibility)})),paint:eq||(eq=new Xs({"background-pitch-alignment":new Gs(rw.paint_background["background-pitch-alignment"]),"background-color":new Gs(rw.paint_background["background-color"]),"background-pattern":new Gs(rw.paint_background["background-pattern"]),"background-opacity":new Gs(rw.paint_background["background-opacity"]),"background-emissive-strength":new Gs(rw.paint_background["background-emissive-strength"]),"background-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(F,el,eh){return{overrideFog:!1}}is3D(F){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:Wm,"raster-particle":ry,sky:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eY||(eY=new Xs({visibility:new Gs(rw.layout_sky.visibility)})),paint:eX||(eX=new Xs({"sky-type":new Gs(rw.paint_sky["sky-type"]),"sky-atmosphere-sun":new Gs(rw.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new Gs(rw.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new Gs(rw.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new Gs(rw.paint_sky["sky-gradient-radius"]),"sky-gradient":new Hs(rw.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new Gs(rw.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new Gs(rw.paint_sky["sky-atmosphere-color"]),"sky-opacity":new Gs(rw.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(F){"sky-gradient"===F?this._updateColorRamp():"sky-atmosphere-sun"!==F&&"sky-atmosphere-halo-color"!==F&&"sky-atmosphere-color"!==F&&"sky-atmosphere-sun-intensity"!==F||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=dc({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(F){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){let el=F.style.light.properties.get("position");return this._lightPosition.azimuthal!==el.azimuthal||this._lightPosition.polar!==el.polar}return!1}getCenter(F,el){if("atmosphere"===this.paint.get("sky-type")){let eh=this.paint.get("sky-atmosphere-sun"),ec=!eh,ep=F.style.light,e_=ep.properties.get("position");return ec&&"viewport"===ep.properties.get("anchor")&&pt("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),ec?iy(e_.azimuthal,90-e_.polar,el):iy(eh[0],90-eh[1],el)}let eh=this.paint.get("sky-gradient-center");return iy(eh[0],90-eh[1],el)}isSky(){return!0}markSkyboxValid(F){this._skyboxInvalidated=!1,this._lightPosition=F.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){let F=this.paint.get("sky-type");return"atmosphere"===F?["skyboxCapture","skybox"]:"gradient"===F?["skyboxGradient"]:null}},slot:class extends ma{constructor(F,el,eh,ec){super(F,{paint:eK||(eK=new Xs({}))},el,null)}},model:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eJ||(eJ=new Xs({visibility:new Gs(rw.layout_model.visibility),"model-id":new Ys(rw.layout_model["model-id"])})),paint:eQ||(eQ=new Xs({"model-opacity":new Ys(rw.paint_model["model-opacity"]),"model-rotation":new Ys(rw.paint_model["model-rotation"]),"model-scale":new Ys(rw.paint_model["model-scale"]),"model-translation":new Ys(rw.paint_model["model-translation"]),"model-color":new Ys(rw.paint_model["model-color"]),"model-color-mix-intensity":new Ys(rw.paint_model["model-color-mix-intensity"]),"model-type":new Gs(rw.paint_model["model-type"]),"model-cast-shadows":new Gs(rw.paint_model["model-cast-shadows"]),"model-receive-shadows":new Gs(rw.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new Gs(rw.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Ys(rw.paint_model["model-emissive-strength"]),"model-roughness":new Ys(rw.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Ys(rw.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new Gs(rw.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new Gs(rw.paint_model["model-front-cutoff"]),"model-color-use-theme":new Ys({type:"string",default:"default","property-type":"data-driven"})}))},el,eh,ec),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(F){return new Py(F)}getProgramIds(){return["model"]}is3D(F){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(F){return F instanceof Gy?8191:0}queryIntersectsFeature(F,el,eh,ec,ep,e_){if(!this.modelManager)return!1;let eg=this.modelManager,ey=F.tile.getBucket(this);if(!(ey&&ey instanceof Py))return!1;for(let eh in ey.instancesPerModel){let ec=ey.instancesPerModel[eh],ep=void 0!==el.id?el.id:el.properties&&el.properties.hasOwnProperty("id")?el.properties.id:void 0;if(ec.idToFeaturesIndex.hasOwnProperty(ep)){let el=ec.features[ec.idToFeaturesIndex[ep]],eb=eg.getModel(eh,this.scope);if(!eb)return!1;let ew=tN.mat4.create(),eT=new ul(0,0),eS=ey.canonical,eE=Number.MAX_VALUE;for(let eh=0;eh<el.instancedDataCount;++eh){let ep=16*(el.instancedDataOffset+eh),eg=ec.instancedDataArray.float32,ey=[eg[ep+4],eg[ep+5],eg[ep+6]];Zy(eS,eT,eg[ep],0|eg[ep+1]),By(ew,eb,e_,eT,el.rotation,el.scale,ey,!1,!1,!1),"globe"===e_.projection.name&&(ew=fy(ew,e_));let eM=tN.mat4.multiply([],e_.projMatrix,ew),eI=F.queryGeometry,eA=dy(eI.isPointQuery()?eI.screenBounds:eI.screenGeometry,e_,eM,eb.aabb);null!=eA&&(eE=Math.min(eA,eE))}return eE!==Number.MAX_VALUE&&eE}}return!1}_handleOverridablePaintPropertyUpdate(F,el,eh){return!(!this.layout||el.isDataDriven()||eh.isDataDriven()||"model-color"!==F&&"model-color-mix-intensity"!==F&&"model-rotation"!==F&&"model-scale"!==F&&"model-translation"!==F&&"model-emissive-strength"!==F)}_isPropertyZoomDependent(F){let el=this._transitionablePaint._values[F];return null!=el&&null!=el.value&&null!=el.value.expression&&el.value.expression instanceof ts}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ma{constructor(F,el,eh,ec){super(F,{layout:eD||(eD=new Xs({"clip-layer-types":new Gs(rw.layout_clip["clip-layer-types"]),"clip-layer-scope":new Gs(rw.layout_clip["clip-layer-scope"])})),paint:eR||(eR=new Xs({}))},el,eh,ec)}recalculate(F,el){super.recalculate(F,el)}createBucket(F){return new Eh(F)}is3D(F){return!0}}};let Ky=class Ky{constructor(F){this._callback=F,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}};let Jy=class Jy{constructor(){this.tasks={},this.taskQueue=[],ot(["process"],this),this.invoker=new Ky(this.process),this.nextId=0}add(F,el){let eh=this.nextId++,ec=function({type:F,isSymbolTile:el,zoom:eh}){return eh=eh||0,"message"===F?0:"maybePrepare"!==F||el?"parseTile"!==F||el?"parseTile"===F&&el?300-eh:"maybePrepare"===F&&el?400-eh:500:200-eh:100-eh}(el);return 0===ec?(F(),null):(this.tasks[eh]={fn:F,metadata:el,priority:ec,id:eh},this.taskQueue.push(eh),this.invoker.trigger(),{cancel:()=>{delete this.tasks[eh]}})}process(){{if(this.taskQueue=this.taskQueue.filter(F=>!!this.tasks[F]),!this.taskQueue.length)return;let F=this.pick();if(null===F)return;let el=this.tasks[F];if(delete this.tasks[F],this.taskQueue.length&&this.invoker.trigger(),!el)return;el.fn()}}pick(){let F=null,el=1/0;for(let eh=0;eh<this.taskQueue.length;eh++){let ec=this.tasks[this.taskQueue[eh]];ec.priority<el&&(el=ec.priority,F=eh)}if(null===F)return null;let eh=this.taskQueue[F];return this.taskQueue.splice(F,1),eh}remove(){this.invoker.remove()}};let Qy=class Qy{constructor(F,el,eh){this.target=F,this.parent=el,this.mapId=eh,this.callbacks={},this.cancelCallbacks={},ot(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new Jy}send(F,el,eh,ec,ep=!1,e_){let eg=Math.round(1e18*Math.random()).toString(36).substring(0,10);eh&&(eh.metadata=e_,this.callbacks[eg]=eh);let ey=new Set;return this.target.postMessage({id:eg,type:F,hasCallback:!!eh,targetMapId:ec,mustQueue:ep,sourceMapId:this.mapId,data:ps(el,ey)},ey),{cancel:()=>{eh&&delete this.callbacks[eg],this.target.postMessage({id:eg,type:"<cancel>",targetMapId:ec,sourceMapId:this.mapId})}}}receive(F){let el=F.data;if(!el)return;let eh=el.id;if(eh&&(!el.targetMapId||this.mapId===el.targetMapId)){if("<cancel>"===el.type){let F=this.cancelCallbacks[eh];delete this.cancelCallbacks[eh],F&&F.cancel()}else if(el.mustQueue||yt()){let F=this.callbacks[eh],ec=this.scheduler.add(()=>this.processTask(eh,el),F&&F.metadata||{type:"message"});ec&&(this.cancelCallbacks[eh]=ec)}else this.processTask(eh,el)}}processTask(F,el){if(delete this.cancelCallbacks[F],"<response>"===el.type){let eh=this.callbacks[F];delete this.callbacks[F],eh&&(el.error?eh(fs(el.error)):eh(null,fs(el.data)))}else{let eh=new Set,ec=el.hasCallback?(el,ec)=>{this.target.postMessage({id:F,type:"<response>",sourceMapId:this.mapId,error:el?ps(el):null,data:ps(ec,eh)},eh)}:()=>{},ep=fs(el.data);if(this.parent[el.type])this.parent[el.type](el.sourceMapId,ep,ec);else if(this.parent.getWorkerSource){let F=el.type.split(".");this.parent.getWorkerSource(el.sourceMapId,F[0],ep.source,ep.scope)[F[1]](ep,ec)}else ec(Error(`Could not find function ${el.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}};var nU={workerUrl:"",workerClass:null,workerParams:void 0};let nj="mapboxgl_preloaded_worker_pool";let rg=class rg{constructor(){this.active={}}acquire(F,el=rg.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<el;)this.workers.push(null!=nU.workerClass?new nU.workerClass:new self.Worker(nU.workerUrl,nU.workerParams));return this.active[F]=!0,this.workers.slice()}release(F){delete this.active[F],this.workers&&0===this.numActive()&&(this.workers.forEach(F=>{F.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[nj]}numActive(){return Object.keys(this.active).length}};rg.workerCount=2;let ng=class ng{constructor(F,el,eh="Worker",ec=rg.workerCount){this.workerPool=F,this.actors=[],this.currentActor=0,this.id=st();let ep=this.workerPool.acquire(this.id,ec);for(let F=0;F<ep.length;F++){let ec=new ng.Actor(ep[F],el,this.id);ec.name=`${eh} ${F}`,this.actors.push(ec)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(F,el,eh){rt(this.actors,(eh,ec)=>{eh.send(F,el,ec)},eh=eh||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(F=>{F.remove()}),this.actors=[],this.workerPool.release(this.id)}};function ag(){return e0||(e0=new rg),e0}ng.Actor=Qy;let nG=new Se(0,0,0);var nq=((e3=nq||{})[e3.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",e3[e3.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",e3[e3.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",e3),n$=((e4=n$||{})[e4.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",e4[e4.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",e4[e4.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",e4[e4.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",e4),nH=((e5=nH||{})[e5.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",e5[e5.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",e5[e5.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",e5[e5.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",e5[e5.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",e5),nZ=((e6=nZ||{})[e6.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",e6[e6.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",e6[e6.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",e6),nW=((e8=nW||{})[e8.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",e8[e8.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",e8[e8.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",e8[e8.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",e8[e8.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",e8[e8.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",e8),nY=((e9=nY||{})[e9.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",e9[e9.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",e9[e9.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",e9);function dg(F,el,eh){var ec;1===F&&el.icons.push((ec=eh.readVarint()+eh.pos,function(F){if(F.usvg_tree.height||(F.usvg_tree.height=F.usvg_tree.width),!F.metadata)return F;let{metadata:el}=F;if(el.content_area){let{content_area:eh}=el;null==eh.top&&(eh.top=eh.left),null==eh.width&&(eh.width=F.usvg_tree.width),null==eh.height&&(eh.height=eh.width)}return el.stretch_x&&el.stretch_x.length&&mg(el,"x"),el.stretch_y&&el.stretch_y.length&&mg(el,"y"),F}(eh.readFields(yg,{name:void 0},ec))))}function mg(F,el){let eh=[],ec=F[`stretch_${el}`],ep=null;for(let F=0;F<ec.length;F++)null===ep?ep=0===eh.length?ec[0]:eh[eh.length-1][1]+ec[F]:(eh.push([ep,ep+ec[F]]),ep=null);F[`stretch_${el}_areas`]=eh}function yg(F,el,eh){var ec,ep;1===F?el.name=eh.readString():2===F?el.metadata=(ec=eh.readVarint()+eh.pos,eh.readFields(gg,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},ec)):3===F&&(el.usvg_tree=(ep=eh.readVarint()+eh.pos,eh.readFields(bg,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},ep)),el.data="usvg_tree")}function gg(F,el,eh){var ec,ep;1===F?el.stretch_x=eh.readPackedVarint():2===F?el.stretch_y=eh.readPackedVarint():3===F?el.content_area=(ec=eh.readVarint()+eh.pos,eh.readFields(xg,{left:0},ec)):4===F&&el.variables.push((ep=eh.readVarint()+eh.pos,eh.readFields(vg,{name:void 0},ep)))}function xg(F,el,eh){1===F?el.left=eh.readVarint():2===F?el.width=eh.readVarint():3===F?el.top=eh.readVarint():4===F&&(el.height=eh.readVarint())}function vg(F,el,eh){1===F?el.name=eh.readString():2===F&&(el.rgb_color=Eg(eh.readVarint()),el.value="rgb_color")}function bg(F,el,eh){var ec,ep,e_;1===F?el.width=el.height=eh.readVarint():2===F?el.height=eh.readVarint():3===F?el.children.push(_g(eh,eh.readVarint()+eh.pos)):4===F?el.linear_gradients.push((ec=eh.readVarint()+eh.pos,eh.readFields(kg,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},ec))):5===F?el.radial_gradients.push((ep=eh.readVarint()+eh.pos,eh.readFields(Vg,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},ep))):7===F?el.clip_paths.push((e_=eh.readVarint()+eh.pos,eh.readFields(Cg,{children:[]},e_))):8===F&&el.masks.push(function(F,el){let eh=F.readFields(Dg,{left:0,width:20,mask_type:1,children:[]},el);return null==eh.height&&(eh.height=eh.width),null==eh.top&&(eh.top=eh.left),eh}(eh,eh.readVarint()+eh.pos))}function _g(F,el){return F.readFields(wg,{},el)}function wg(F,el,eh){var ec,ep;1===F?(el.group=(ec=eh.readVarint()+eh.pos,eh.readFields(Mg,{opacity:255,children:[]},ec)),el.node="group"):2===F&&(el.path=(ep=eh.readVarint()+eh.pos,eh.readFields(Sg,{paint_order:1,commands:[],step:1,diffs:[],rule:1},ep)),el.node="path")}function Mg(F,el,eh){1===F?el.transform=Ag(eh,eh.readVarint()+eh.pos):2===F?el.opacity=eh.readVarint():5===F?el.clip_path_idx=eh.readVarint():6===F?el.mask_idx=eh.readVarint():7===F&&el.children.push(_g(eh,eh.readVarint()+eh.pos))}function Ag(F,el){return F.readFields(Ig,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},el)}function Ig(F,el,eh){1===F?el.sx=eh.readFloat():2===F?el.ky=eh.readFloat():3===F?el.kx=eh.readFloat():4===F?el.sy=eh.readFloat():5===F?el.tx=eh.readFloat():6===F&&(el.ty=eh.readFloat())}function Sg(F,el,eh){var ec,ep;1===F?el.fill=(ec=eh.readVarint()+eh.pos,eh.readFields(Pg,{rgb_color:nG,paint:"rgb_color",opacity:255},ec)):2===F?el.stroke=(ep=eh.readVarint()+eh.pos,eh.readFields(zg,{rgb_color:nG,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},ep)):3===F?el.paint_order=eh.readVarint():5===F?eh.readPackedVarint(el.commands):6===F?el.step=eh.readFloat():7===F?eh.readPackedSVarint(el.diffs):8===F&&(el.rule=eh.readVarint())}function Pg(F,el,eh){1===F?(el.rgb_color=Eg(eh.readVarint()),el.paint="rgb_color"):2===F?(el.linear_gradient_idx=eh.readVarint(),el.paint="linear_gradient_idx"):3===F?(el.radial_gradient_idx=eh.readVarint(),el.paint="radial_gradient_idx"):5===F&&(el.opacity=eh.readVarint())}function Eg(F){return new Se((F>>16&255)/255,(F>>8&255)/255,(255&F)/255,1)}function zg(F,el,eh){1===F?(el.rgb_color=Eg(eh.readVarint()),el.paint="rgb_color"):2===F?(el.linear_gradient_idx=eh.readVarint(),el.paint="linear_gradient_idx"):3===F?(el.radial_gradient_idx=eh.readVarint(),el.paint="radial_gradient_idx"):5===F?eh.readPackedFloat(el.dasharray):6===F?el.dashoffset=eh.readFloat():7===F?el.miterlimit=eh.readFloat():8===F?el.opacity=eh.readVarint():9===F?el.width=eh.readFloat():10===F?el.linecap=eh.readVarint():11===F&&(el.linejoin=eh.readVarint())}function kg(F,el,eh){1===F?el.transform=Ag(eh,eh.readVarint()+eh.pos):2===F?el.spread_method=eh.readVarint():3===F?el.stops.push(Tg(eh,eh.readVarint()+eh.pos)):4===F?el.x1=eh.readFloat():5===F?el.y1=eh.readFloat():6===F?el.x2=eh.readFloat():7===F&&(el.y2=eh.readFloat())}function Tg(F,el){return F.readFields(Bg,{offset:0,opacity:255,rgb_color:nG},el)}function Bg(F,el,eh){1===F?el.offset=eh.readFloat():2===F?el.opacity=eh.readVarint():3===F&&(el.rgb_color=Eg(eh.readVarint()))}function Vg(F,el,eh){1===F?el.transform=Ag(eh,eh.readVarint()+eh.pos):2===F?el.spread_method=eh.readVarint():3===F?el.stops.push(Tg(eh,eh.readVarint()+eh.pos)):4===F?el.cx=eh.readFloat():5===F?el.cy=eh.readFloat():6===F?el.r=eh.readFloat():7===F?el.fx=eh.readFloat():8===F?el.fy=eh.readFloat():9===F&&(el.fr=eh.readFloat())}function Cg(F,el,eh){1===F?el.transform=Ag(eh,eh.readVarint()+eh.pos):2===F?el.clip_path_idx=eh.readVarint():3===F&&el.children.push(_g(eh,eh.readVarint()+eh.pos))}function Dg(F,el,eh){1===F?el.left=el.top=eh.readFloat():2===F?el.width=el.height=eh.readFloat():3===F?el.top=eh.readFloat():4===F?el.height=eh.readFloat():5===F?el.mask_type=eh.readVarint():6===F?el.mask_idx=eh.readVarint():7===F&&el.children.push(_g(eh,eh.readVarint()+eh.pos))}let Rg=class Rg{static calculate(F={},el=[]){let eh=new Map,ec=new Map;if(0===Object.keys(F).length)return eh;for(let[ep,e_]of(el.forEach(F=>{ec.set(F.name,F.rgb_color||new Se(0,0,0))}),Object.entries(F)))ec.has(ep)?eh.set(ec.get(ep).toStringPremultipliedAlpha(),e_):console.warn(`Ignoring unknown image variable "${ep}"`);return eh}};function Lg(F,el=255,eh){let ec=F.toStringPremultipliedAlpha(),ep=eh.has(ec)?eh.get(ec).clone():F.clone();return ep.a*=el/255,ep.toString()}function Fg(F,el){if(!Vt()){let eh=document.createElement("canvas");return eh.width=F,eh.height=el,eh}return new OffscreenCanvas(F,el)}function Og(F,el){let eh=Rg.calculate(el.params,F.metadata?F.metadata.variables:[]),ec=F.usvg_tree,ep=ec.width,e_=ec.height,eg=el.transform?el.transform:new DOMMatrix,ey=Math.max(1,Math.round(ep*eg.a)),eb=Math.max(1,Math.round(e_*eg.d)),ew=new DOMMatrix([ey/ep,0,0,eb/e_,0,0]),eT=Fg(ey,eb).getContext("2d");return function Ng(F,el,eh,ec,ep){for(let e_ of ec.children)(function Ug(F,el,eh,ec,ep){ec.group?(F.save(),function(F,el,eh,ec,ep){var e_,eg;let ey=null!=ec.mask_idx?eh.masks[ec.mask_idx]:null,eb=null!=ec.clip_path_idx?eh.clip_paths[ec.clip_path_idx]:null;if(ec.transform&&(el=Wg(ec.transform).preMultiplySelf(el)),e_=null!=eb,eg=null!=ey,255===ec.opacity&&!e_&&!eg)return void Ng(F,el,eh,ec,ep);let ew=Fg(F.canvas.width,F.canvas.height),eT=ew.getContext("2d");Ng(eT,el,eh,ec,ep),eb&&function Xg(F,el,eh,ec){let ep=Fg(F.canvas.width,F.canvas.height);(function Hg(F,el,eh,ec){let ep=ec.transform?Wg(ec.transform).preMultiplySelf(el):el,e_=Fg(F.canvas.width,F.canvas.height),eg=e_.getContext("2d");for(let F of ec.children)if(F.group)Hg(eg,ep,eh,F.group);else if(F.path){let el=F.path,eh=new Path2D;eh.addPath(Kg(el),ep),eg.fill(eh,qg(el))}let ey=null!=ec.clip_path_idx?eh.clip_paths[ec.clip_path_idx]:null;ey&&Xg(eg,ep,eh,ey),F.globalCompositeOperation="source-over",F.drawImage(e_,0,0)})(ep.getContext("2d"),el,eh,ec),F.globalCompositeOperation="destination-in",F.drawImage(ep,0,0)}(eT,el,eh,eb),ey&&function Zg(F,el,eh,ec,ep){if(0===ec.children.length)return;let e_=null!=ec.mask_idx?eh.masks[ec.mask_idx]:null;e_&&Zg(F,el,eh,e_,ep);let eg=F.canvas.width,ey=F.canvas.height,eb=Fg(eg,ey),ew=eb.getContext("2d"),eT=ec.width,eS=ec.height,eE=ec.left,eM=ec.top,eI=new Path2D,eA=new Path2D;for(let F of(eA.rect(eE,eM,eT,eS),eI.addPath(eA,el),ew.clip(eI),ec.children))Ug(ew,el,eh,F,ep);let eC=ew.getImageData(0,0,eg,ey),eP=eC.data;if(ec.mask_type===nY.MASK_TYPE_LUMINANCE)for(let F=0;F<eP.length;F+=4)eP[F+3]=eP[F+3]/255*(.2126*eP[F]+.7152*eP[F+1]+.0722*eP[F+2]);ew.putImageData(eC,0,0),F.globalCompositeOperation="destination-in",F.drawImage(eb,0,0)}(eT,el,eh,ey,ep),F.globalAlpha=ec.opacity/255,F.drawImage(ew,0,0)}(F,el,eh,ec.group,ep),F.restore()):ec.path&&(F.save(),function(F,el,eh,ec,ep){let e_=Kg(ec);F.setTransform(el),ec.paint_order===nZ.PAINT_ORDER_FILL_AND_STROKE?(jg(F,eh,ec,e_,ep),$g(F,eh,ec,e_,ep)):($g(F,eh,ec,e_,ep),jg(F,eh,ec,e_,ep))}(F,el,eh,ec.path,ep),F.restore())})(F,el,eh,e_,ep)}(eT,ew,ec,ec,eh),eT.getImageData(0,0,ey,eb)}function jg(F,el,eh,ec,ep){let e_=eh.fill;if(!e_)return;let eg=e_.opacity/255;switch(e_.paint){case"rgb_color":F.fillStyle=Lg(e_.rgb_color,e_.opacity,ep);break;case"linear_gradient_idx":F.fillStyle=Gg(F,el.linear_gradients[e_.linear_gradient_idx],eg,ep);break;case"radial_gradient_idx":F.fillStyle=Yg(F,el.radial_gradients[e_.radial_gradient_idx],eg,ep)}F.fill(ec,qg(eh))}function qg(F){return F.rule===nq.PATH_RULE_NON_ZERO?"nonzero":F.rule===nq.PATH_RULE_EVEN_ODD?"evenodd":void 0}function $g(F,el,eh,ec,ep){let e_=eh.stroke;if(!e_)return;F.lineWidth=e_.width,F.miterLimit=e_.miterlimit,F.setLineDash(e_.dasharray),F.lineDashOffset=e_.dashoffset;let eg=e_.opacity/255;switch(e_.paint){case"rgb_color":F.strokeStyle=Lg(e_.rgb_color,e_.opacity,ep);break;case"linear_gradient_idx":F.strokeStyle=Gg(F,el.linear_gradients[e_.linear_gradient_idx],eg,ep);break;case"radial_gradient_idx":F.strokeStyle=Yg(F,el.radial_gradients[e_.radial_gradient_idx],eg,ep)}switch(e_.linejoin){case nH.LINE_JOIN_MITER_CLIP:case nH.LINE_JOIN_MITER:F.lineJoin="miter";break;case nH.LINE_JOIN_ROUND:F.lineJoin="round";break;case nH.LINE_JOIN_BEVEL:F.lineJoin="bevel"}switch(e_.linecap){case n$.LINE_CAP_BUTT:F.lineCap="butt";break;case n$.LINE_CAP_ROUND:F.lineCap="round";break;case n$.LINE_CAP_SQUARE:F.lineCap="square"}F.stroke(ec)}function Gg(F,el,eh,ec){if(1===el.stops.length){let F=el.stops[0];return Lg(F.rgb_color,F.opacity*eh,ec)}let ep=Wg(el.transform),{x1:e_,y1:eg,x2:ey,y2:eb}=el,ew=ep.transformPoint(new DOMPoint(e_,eg)),eT=ep.transformPoint(new DOMPoint(ey,eb)),eS=F.createLinearGradient(ew.x,ew.y,eT.x,eT.y);for(let F of el.stops)eS.addColorStop(F.offset,Lg(F.rgb_color,F.opacity*eh,ec));return eS}function Yg(F,el,eh,ec){if(1===el.stops.length){let F=el.stops[0];return Lg(F.rgb_color,F.opacity*eh,ec)}let ep=Wg(el.transform),{fx:e_,fy:eg,cx:ey,cy:eb}=el,ew=ep.transformPoint(new DOMPoint(e_,eg)),eT=ep.transformPoint(new DOMPoint(ey,eb)),eS=F.createRadialGradient(ew.x,ew.y,0,eT.x,eT.y,el.r*((ep.a+ep.d)/2));for(let F of el.stops)eS.addColorStop(F.offset,Lg(F.rgb_color,F.opacity*eh,ec));return eS}function Wg(F){return F?new DOMMatrix([F.sx,F.ky,F.kx,F.sy,F.tx,F.ty]):new DOMMatrix}function Kg(F){let el=new Path2D,eh=F.step,ec=F.diffs[0]*eh,ep=F.diffs[1]*eh;el.moveTo(ec,ep);for(let e_=0,eg=2;e_<F.commands.length;e_++)switch(F.commands[e_]){case nW.PATH_COMMAND_MOVE:ec+=F.diffs[eg++]*eh,ep+=F.diffs[eg++]*eh,el.moveTo(ec,ep);break;case nW.PATH_COMMAND_LINE:ec+=F.diffs[eg++]*eh,ep+=F.diffs[eg++]*eh,el.lineTo(ec,ep);break;case nW.PATH_COMMAND_QUAD:{let e_=ec+F.diffs[eg++]*eh,ey=ep+F.diffs[eg++]*eh;ec=e_+F.diffs[eg++]*eh,ep=ey+F.diffs[eg++]*eh,el.quadraticCurveTo(e_,ey,ec,ep);break}case nW.PATH_COMMAND_CUBIC:{let e_=ec+F.diffs[eg++]*eh,ey=ep+F.diffs[eg++]*eh,eb=e_+F.diffs[eg++]*eh,ew=ey+F.diffs[eg++]*eh;ec=eb+F.diffs[eg++]*eh,ep=ew+F.diffs[eg++]*eh,el.bezierCurveTo(e_,ey,eb,ew,ec,ep);break}case nW.PATH_COMMAND_CLOSE:el.closePath()}return el}let Jg=class Jg{constructor(F){this.capacity=F,this.cache=new Map}get(F){if(!this.cache.has(F))return;let el=this.cache.get(F);return this.cache.delete(F),this.cache.set(F,el),el}put(F,el){this.cache.has(F)?this.cache.delete(F):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(F,el)}delete(F){this.cache.delete(F)}};us(Jg,"LRUCache");let Qg=class Qg{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(F){return new pc(F,F.data)}getFromCache(F,el,eh){return this.cacheMap.has(eh)||this.cacheMap.set(eh,new Jg(150)),this.cacheMap.get(eh).get(pa(F.toString(),el))}setInCache(F,el,eh,ec){this.cacheDependenciesMap.has(ec)||this.cacheDependenciesMap.set(ec,new Map),this.cacheMap.has(ec)||this.cacheMap.set(ec,new Jg(150));let ep=this.cacheDependenciesMap.get(ec),e_=pa(F.id.toString(),eh);ep.get(e_)||ep.set(e_,new Set);let eg=this.cacheMap.get(ec),ey=F.toString();ep.get(e_).add(ey),eg.put(pa(F.toString(),eh),el)}removeImagesFromCacheByIds(F,el,eh=0){if(!this.cacheMap.has(eh)||!this.cacheDependenciesMap.has(eh))return;let ec=this.cacheMap.get(eh),ep=this.cacheDependenciesMap.get(eh);for(let eh of F){let F=pa(eh.toString(),el);if(ep.has(F)){for(let el of ep.get(F))ec.delete(el);ep.delete(F)}}}rasterize(F,el,eh,ec,ep=Og){let e_=this.getFromCache(F,eh,ec);if(e_)return e_.clone();let eg=ep(el.icon,F.options),ey=Qg._getImage(eg);return this.setInCache(F,ey,eh,ec),ey.clone()}};let tx=class tx{constructor(F){this.size=F,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(F,el){let eh=this.toIdx(F,el);return{min:this.minimums[eh],max:this.maximums[eh]}}isLeaf(F,el){return this.leaves[this.toIdx(F,el)]}toIdx(F,el){return el*this.size+F}};function ex(F,el,eh,ec){let ep=0,e_=Number.MAX_VALUE;for(let eg=0;eg<3;eg++)if(1e-15>Math.abs(ec[eg])){if(eh[eg]<F[eg]||eh[eg]>el[eg])return null}else{let ey=1/ec[eg],eb=(F[eg]-eh[eg])*ey,ew=(el[eg]-eh[eg])*ey;if(eb>ew){let F=eb;eb=ew,ew=F}if(eb>ep&&(ep=eb),ew<e_&&(e_=ew),ep>e_)return null}return ep}function rx(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT){let eS=ec-F,eE=ep-el,eM=e_-eh,eI=eg-F,eA=ey-el,eC=eb-eh,eP=eT[1]*eC-eT[2]*eA,ez=eT[2]*eI-eT[0]*eC,eD=eT[0]*eA-eT[1]*eI,eR=eS*eP+eE*ez+eM*eD;if(1e-15>Math.abs(eR))return null;let eL=1/eR,eO=ew[0]-F,ek=ew[1]-el,eF=ew[2]-eh,eB=(eO*eP+ek*ez+eF*eD)*eL;if(eB<0||eB>1)return null;let eN=ek*eM-eF*eE,eV=eF*eS-eO*eM,eU=eO*eE-ek*eS,ej=(eT[0]*eN+eT[1]*eV+eT[2]*eU)*eL;return ej<0||eB+ej>1?null:(eI*eN+eA*eV+eC*eU)*eL}function ix(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=1<<eh,eT=e_-ec,eS=eg-ep;ey[0]=(F+0)/ew*eT+ec,ey[1]=(el+0)/ew*eS+ep,eb[0]=(F+1)/ew*eT+ec,eb[1]=(el+1)/ew*eS+ep}let sx=class sx{constructor(F){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=F,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;let el=function(F){let el=Math.ceil(Math.log2(F.dim/8)),eh=[],ec=Math.ceil(Math.pow(2,el)),ep=1/ec,s=(F,el,eh,ec,ep)=>{let e_=ec?1:0;ep[0]=F*eh,ep[1]=el*eh,ep[2]=(F+1)*eh-e_,ep[3]=(el+1)*eh-e_},e_=new tx(ec),eg=[];for(let el=0;el<ec*ec;el++){s(el%ec,Math.floor(el/ec),ep,!1,eg);let eh=ox(eg[0],eg[1],F),ey=ox(eg[2],eg[1],F),eb=ox(eg[2],eg[3],F),ew=ox(eg[0],eg[3],F);e_.minimums.push(Math.min(eh,ey,eb,ew)),e_.maximums.push(Math.max(eh,ey,eb,ew)),e_.leaves.push(1)}for(eh.push(e_),ec/=2;ec>=1;ec/=2){let F=eh[eh.length-1];e_=new tx(ec);for(let el=0;el<ec*ec;el++){s(el%ec,Math.floor(el/ec),2,!0,eg);let eh=F.getElevation(eg[0],eg[1]),ep=F.getElevation(eg[2],eg[1]),ey=F.getElevation(eg[2],eg[3]),eb=F.getElevation(eg[0],eg[3]),ew=F.isLeaf(eg[0],eg[1]),eT=F.isLeaf(eg[2],eg[1]),eS=F.isLeaf(eg[2],eg[3]),eE=F.isLeaf(eg[0],eg[3]),eM=Math.min(eh.min,ep.min,ey.min,eb.min),eI=Math.max(eh.max,ep.max,ey.max,eb.max),eA=ew&&eT&&eS&&eE;e_.maximums.push(eI),e_.minimums.push(eM),e_.leaves.push(eI-eM<=5&&eA?1:0)}eh.push(e_)}return eh}(this.dem),eh=el.length-1,ec=el[eh];this._addNode(ec.minimums[0],ec.maximums[0],ec.leaves[0]),this._construct(el,0,0,eh,0)}raycastRoot(F,el,eh,ec,ep,e_,eg=1){return ex([F,el,-100],[eh,ec,this.maximums[0]*eg],ep,e_)}raycast(F,el,eh,ec,ep,e_,eg=1){if(!this.nodeCount)return null;let ey=this.raycastRoot(F,el,eh,ec,ep,e_,eg);if(null==ey)return null;let eb=[],ew=[],eT=[],eS=[],eE=[{idx:0,t:ey,nodex:0,nodey:0,depth:0}];for(;eE.length>0;){let{idx:ey,t:eA,nodex:eC,nodey:eP,depth:ez}=eE.pop();if(this.leaves[ey]){ix(eC,eP,ez,F,el,eh,ec,eT,eS);let ey=1<<ez,eb=(eC+0)/ey,ew=(eC+1)/ey,eE=(eP+0)/ey,eD=(eP+1)/ey,eR=ox(eb,eE,this.dem)*eg,eL=ox(ew,eE,this.dem)*eg,eO=ox(ew,eD,this.dem)*eg,ek=ox(eb,eD,this.dem)*eg,eF=rx(eT[0],eT[1],eR,eS[0],eT[1],eL,eS[0],eS[1],eO,ep,e_),eB=rx(eS[0],eS[1],eO,eT[0],eS[1],ek,eT[0],eT[1],eR,ep,e_),eN=Math.min(null!==eF?eF:Number.MAX_VALUE,null!==eB?eB:Number.MAX_VALUE);if(eN!==Number.MAX_VALUE)return eN;{var eM,eI;let F=tN.vec3.scaleAndAdd([],ep,e_,eA);if(ax(eR,eL,ek,eO,(F[0]-(eM=eT[0]))/(eS[0]-eM),(F[1]-(eI=eT[1]))/(eS[1]-eI))>=F[2])return eA}continue}let eD=0;for(let eE=0;eE<this._siblingOffset.length;eE++){ix((eC<<1)+this._siblingOffset[eE][0],(eP<<1)+this._siblingOffset[eE][1],ez+1,F,el,eh,ec,eT,eS),eT[2]=-100,eS[2]=this.maximums[this.childOffsets[ey]+eE]*eg;let eM=ex(eT,eS,ep,e_);if(null!=eM){eb[eE]=eM;let F=!1;for(let el=0;el<eD&&!F;el++)eM>=eb[ew[el]]&&(ew.splice(el,0,eE),F=!0);F||(ew[eD]=eE),eD++}}for(let F=0;F<eD;F++){let el=ew[F];eE.push({idx:this.childOffsets[ey]+el,t:eb[el],nodex:(eC<<1)+this._siblingOffset[el][0],nodey:(eP<<1)+this._siblingOffset[el][1],depth:ez+1})}}return null}_addNode(F,el,eh){return this.minimums.push(F),this.maximums.push(el),this.leaves.push(eh),this.childOffsets.push(0),this.nodeCount++}_construct(F,el,eh,ec,ep){if(1===F[ec].isLeaf(el,eh))return;this.childOffsets[ep]||(this.childOffsets[ep]=this.nodeCount);let e_=ec-1,eg=F[e_],ey=0,eb=0;for(let F=0;F<this._siblingOffset.length;F++){let ec=2*el+this._siblingOffset[F][0],ep=2*eh+this._siblingOffset[F][1],e_=eg.getElevation(ec,ep),ew=eg.isLeaf(ec,ep),eT=this._addNode(e_.min,e_.max,ew);ew&&(ey|=1<<F),eb||(eb=eT)}for(let ec=0;ec<this._siblingOffset.length;ec++)ey&1<<ec||this._construct(F,2*el+this._siblingOffset[ec][0],2*eh+this._siblingOffset[ec][1],e_,eb+ec)}};function ax(F,el,eh,ec,ep,e_){return Ee(Ee(F,eh,e_),Ee(el,ec,e_),ep)}function ox(F,el,eh){let ec=eh.dim,ep=Q(F*ec-.5,0,ec-1),e_=Q(el*ec-.5,0,ec-1),eg=Math.floor(ep),ey=Math.floor(e_),eb=Math.min(eg+1,ec-1),ew=Math.min(ey+1,ec-1);return ax(eh.get(eg,ey),eh.get(eb,ey),eh.get(eg,ew),eh.get(eb,ew),ep-eg,e_-ey)}let nX={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function ux(F,el,eh){return(256*F*256+256*el+eh)/10-1e4}function cx(F,el,eh){return 256*F+el+eh/256-32768}let hx=class hx{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(F,el,eh,ec=!1){if(this.uid=F,el.height!==el.width)throw RangeError("DEM tiles must be square");if(eh&&"mapbox"!==eh&&"terrarium"!==eh)return void pt(`"${eh}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=el.height;let ep=this.dim=el.height-2,e_=new Uint32Array(el.data.buffer);if(this.pixels=new Uint8Array(el.data.buffer),this.floatView=new Float32Array(el.data.buffer),this.borderReady=ec,this._modifiedForSources={},!ec){for(let F=0;F<ep;F++)e_[this._idx(-1,F)]=e_[this._idx(0,F)],e_[this._idx(ep,F)]=e_[this._idx(ep-1,F)],e_[this._idx(F,-1)]=e_[this._idx(F,0)],e_[this._idx(F,ep)]=e_[this._idx(F,ep-1)];e_[this._idx(-1,-1)]=e_[this._idx(0,0)],e_[this._idx(ep,-1)]=e_[this._idx(ep-1,0)],e_[this._idx(-1,ep)]=e_[this._idx(0,ep-1)],e_[this._idx(ep,ep)]=e_[this._idx(ep-1,ep-1)]}let eg="terrarium"===eh?cx:ux;for(let F=0;F<e_.length;++F){let el=4*F;this.floatView[F]=eg(this.pixels[el],this.pixels[el+1],this.pixels[el+2])}this._timestamp=tX.now()}_buildQuadTree(){this._tree=new sx(this)}get(F,el,eh=!1){eh&&(F=Q(F,-1,this.dim),el=Q(el,-1,this.dim));let ec=this._idx(F,el);return this.floatView[ec]}set(F,el,eh){let ec=this._idx(F,el),ep=this.floatView[ec];return this.floatView[ec]=eh,eh-ep}static getUnpackVector(F){return nX[F]}_idx(F,el){if(F<-1||F>=this.dim+1||el<-1||el>=this.dim+1)throw RangeError("out of range source coordinates for DEM data");return(el+1)*this.stride+(F+1)}static pack(F,el){let eh=[0,0,0,0],ec=hx.getUnpackVector(el),ep=Math.floor((F+ec[3])/ec[2]);return eh[2]=ep%256,ep=Math.floor(ep/256),eh[1]=ep%256,ep=Math.floor(ep/256),eh[0]=ep,eh}getPixels(){return new fc({width:this.stride,height:this.stride},this.pixels)}backfillBorder(F,el,eh){if(this.dim!==F.dim)throw Error("dem dimension mismatch");let ec=el*this.dim,ep=el*this.dim+this.dim,e_=eh*this.dim,eg=eh*this.dim+this.dim;switch(el){case -1:ec=ep-1;break;case 1:ep=ec+1}switch(eh){case -1:e_=eg-1;break;case 1:eg=e_+1}let ey=-el*this.dim,eb=-eh*this.dim;for(let el=e_;el<eg;el++)for(let eh=ec;eh<ep;eh++){let ec=4*this._idx(eh,el),ep=4*this._idx(eh+ey,el+eb);this.pixels[ec+0]=F.pixels[ep+0],this.pixels[ec+1]=F.pixels[ep+1],this.pixels[ec+2]=F.pixels[ep+2],this.pixels[ec+3]=F.pixels[ep+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}};function px(F,el,eh){var ec;1===F?el.headerLength=eh.readFixed32():2===F?el.x=eh.readVarint():3===F?el.y=eh.readVarint():4===F?el.z=eh.readVarint():5===F&&el.layers.push((ec=eh.readVarint()+eh.pos,eh.readFields(gx,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},ec)))}function fx(F,el,eh){var ec;1===F?(el.delta_filter=(ec=eh.readVarint()+eh.pos,eh.readFields(dx,{blockSize:0},ec)),el.filter="delta_filter"):2===F?(eh.readVarint(),el.filter="zigzag_filter"):3===F?(eh.readVarint(),el.filter="bitshuffle_filter"):4===F&&(eh.readVarint(),el.filter="byteshuffle_filter")}function dx(F,el,eh){1===F&&(el.blockSize=eh.readVarint())}function mx(F,el,eh){1===F?(eh.readVarint(),el.codec="gzip_data"):2===F?(eh.readVarint(),el.codec="jpeg_image"):3===F?(eh.readVarint(),el.codec="webp_image"):4===F&&(eh.readVarint(),el.codec="png_image")}function yx(F,el,eh){var ec,ep;let e_=0,eg=0;1===F?el.firstByte=eh.readFixed64():2===F?el.lastByte=eh.readFixed64():3===F?el.filters.push((ec=eh.readVarint()+eh.pos,eh.readFields(fx,{},ec))):4===F?el.codec=(ep=eh.readVarint()+eh.pos,eh.readFields(mx,{},ep)):5===F?eg=eh.readFloat():6===F?e_=eh.readFloat():7===F?el.bands.push(eh.readString()):8===F?el.offset=eh.readDouble():9===F&&(el.scale=eh.readDouble()),0===el.offset&&(el.offset=eg),0===el.scale&&(el.scale=e_)}function gx(F,el,eh){var ec;1===F?el.version=eh.readVarint():2===F?el.name=eh.readString():3===F?el.units=eh.readString():4===F?el.tileSize=eh.readVarint():5===F?el.buffer=eh.readVarint():6===F?el.pixelFormat=eh.readVarint():7===F&&el.dataIndex.push((ec=eh.readVarint()+eh.pos,eh.readFields(yx,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},ec)))}function xx(F,el,eh){if(2===F)!function(F,el,eh){F.readFields(vx,eh,el)}(eh,eh.readVarint()+eh.pos,el);else if(3===F)throw Error("Not implemented")}function vx(F,el,eh){if(1===F){let F=0,ec=eh.readVarint()+eh.pos;for(;eh.pos<ec;)el[F++]=eh.readVarint()}}us(hx,"DEMData"),us(sx,"DemMinMaxQuadTree",{omit:["dem"]});var nK=Uint8Array,nJ=Uint16Array,nQ=Int32Array,n0=new nK([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),n1=new nK([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),n2=new nK([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),zx=function(F,el){for(var eh=new nJ(31),ec=0;ec<31;++ec)eh[ec]=el+=1<<F[ec-1];var ep=new nQ(eh[30]);for(ec=1;ec<30;++ec)for(var e_=eh[ec];e_<eh[ec+1];++e_)ep[e_]=e_-eh[ec]<<5|ec;return{b:eh,r:ep}},n3=zx(n0,2),n4=n3.b,n5=n3.r;n4[28]=258,n5[258]=28;for(var n6=zx(n1,0).b,n8=new nJ(32768),n9=0;n9<32768;++n9){var n7=(43690&n9)>>1|(21845&n9)<<1;n8[n9]=((65280&(n7=(61680&(n7=(52428&n7)>>2|(13107&n7)<<2))>>4|(3855&n7)<<4))>>8|(255&n7)<<8)>>1}var Lx=function(F,el,eh){for(var ec=F.length,ep=0,e_=new nJ(el);ep<ec;++ep)F[ep]&&++e_[F[ep]-1];var eg,ey=new nJ(el);for(ep=1;ep<el;++ep)ey[ep]=ey[ep-1]+e_[ep-1]<<1;eg=new nJ(1<<el);var eb=15-el;for(ep=0;ep<ec;++ep)if(F[ep])for(var ew=ep<<4|F[ep],eT=el-F[ep],eS=ey[F[ep]-1]++<<eT,eE=eS|(1<<eT)-1;eS<=eE;++eS)eg[n8[eS]>>eb]=ew;return eg},oh=new nK(288);for(n9=0;n9<144;++n9)oh[n9]=8;for(n9=144;n9<256;++n9)oh[n9]=9;for(n9=256;n9<280;++n9)oh[n9]=7;for(n9=280;n9<288;++n9)oh[n9]=8;var oc=new nK(32);for(n9=0;n9<32;++n9)oc[n9]=5;var od=Lx(oh,9),op=Lx(oc,5),jx=function(F){for(var el=F[0],eh=1;eh<F.length;++eh)F[eh]>el&&(el=F[eh]);return el},qx=function(F,el,eh){var ec=el/8|0;return(F[ec]|F[ec+1]<<8)>>(7&el)&eh},$x=function(F,el){var eh=el/8|0;return(F[eh]|F[eh+1]<<8|F[eh+2]<<16)>>(7&el)},of=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Yx=function(F,el,eh){var ec=Error(el||of[F]);if(ec.code=F,Error.captureStackTrace&&Error.captureStackTrace(ec,Yx),!eh)throw ec;return ec},o_=new nK(0),og="undefined"!=typeof TextDecoder&&new TextDecoder;try{og.decode(o_,{stream:!0})}catch(F){}let ov={gzip_data:"gzip"};let Wx=class Wx extends Error{constructor(F){super(F),this.name="MRTError"}};let ob={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},ow={uint32:1,uint16:2,uint8:4},oT={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let ev=class ev{constructor(F=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=F}getLayer(F){let el=this.layers[F];if(!el)throw new Wx(`Layer '${F}' not found`);return el}getHeaderLength(F){let el=new Uint8Array(F),eh=new DataView(F);if(13!==el[0])throw new Wx("File is not a valid MRT.");return eh.getUint32(1,!0)}parseHeader(F){let el=new Uint8Array(F),eh=this.getHeaderLength(F);if(el.length<eh)throw new Wx(`Expected header with length >= ${eh} but got buffer of length ${el.length}`);let ec=new e2(el.subarray(0,eh)).readFields(px,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==ec.x||this.y!==ec.y||this.z!==ec.z))throw new Wx(`Invalid attempt to parse header ${ec.z}/${ec.x}/${ec.y} for tile ${this.z}/${this.x}/${this.y}`);for(let F of(this.x=ec.x,this.y=ec.y,this.z=ec.z,ec.layers))this.layers[F.name]=new rv(F,{cacheSize:this._cacheSize});return this}createDecodingTask(F){let el=[],eh=this.getLayer(F.layerName);for(let ec of F.blockIndices){let ep=eh.dataIndex[ec],e_=ep.firstByte-F.firstByte,eg=ep.lastByte-F.firstByte;if(eh._blocksInProgress.has(ec))continue;let ey={layerName:eh.name,firstByte:e_,lastByte:eg,pixelFormat:eh.pixelFormat,blockIndex:ec,blockShape:[ep.bands.length].concat(eh.bandShape),buffer:eh.buffer,codec:ep.codec.codec,filters:ep.filters.map(F=>F.filter)};eh._blocksInProgress.add(ec),el.push(ey)}return new nv(el,()=>{el.forEach(F=>eh._blocksInProgress.delete(F.blockIndex))},(F,ec)=>{if(el.forEach(F=>eh._blocksInProgress.delete(F.blockIndex)),F)throw F;ec.forEach(F=>{this.getLayer(F.layerName).processDecodedData(F)})})}};let rv=class rv{constructor({version:F,name:el,units:eh,tileSize:ec,pixelFormat:ep,buffer:e_,dataIndex:eg},ey){if(this.version=F,1!==this.version)throw new Wx(`Cannot parse raster layer encoded with MRT version ${F}`);this.name=el,this.units=eh,this.tileSize=ec,this.buffer=e_,this.pixelFormat=ob[ep],this.dataIndex=eg,this.bandShape=[ec+2*e_,ec+2*e_,ow[this.pixelFormat]],this._decodedBlocks=new Jg(ey?ey.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return ow[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:F})=>F).flat()}processDecodedData(F){let el=F.blockIndex.toString();this._decodedBlocks.get(el)||this._decodedBlocks.put(el,F.data)}getBlockForBand(F){let el=0;switch(typeof F){case"string":for(let[eh,ec]of this.dataIndex.entries()){for(let[ep,e_]of ec.bands.entries())if(e_===F)return{bandIndex:el+ep,blockIndex:eh,blockBandIndex:ep};el+=ec.bands.length}break;case"number":for(let[eh,ec]of this.dataIndex.entries()){if(F>=el&&F<el+ec.bands.length)return{bandIndex:F,blockIndex:eh,blockBandIndex:F-el};el+=ec.bands.length}break;default:throw new Wx(`Invalid band \`${JSON.stringify(F)}\`. Expected string or integer.`)}throw new Wx(`Band not found: ${JSON.stringify(F)}`)}getDataRange(F){let el=1/0,eh=-1/0,ec=[],ep=new Set;for(let e_ of F){let{blockIndex:F}=this.getBlockForBand(e_);if(F<0)throw new Wx(`Invalid band: ${JSON.stringify(e_)}`);let eg=this.dataIndex[F];ec.includes(F)||ec.push(F),ep.add(F),el=Math.min(el,eg.firstByte),eh=Math.max(eh,eg.lastByte)}if(ep.size>this.cacheSize)throw new Wx(`Number of blocks to decode (${ep.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:el,lastByte:eh,blockIndices:ec}}hasBand(F){let{blockIndex:el}=this.getBlockForBand(F);return el>=0}hasDataForBand(F){let{blockIndex:el}=this.getBlockForBand(F);return el>=0&&!!this._decodedBlocks.get(el.toString())}getBandView(F){let{blockIndex:el,blockBandIndex:eh}=this.getBlockForBand(F),ec=this._decodedBlocks.get(el.toString());if(!ec)throw new Wx(`Data for band ${JSON.stringify(F)} of layer "${this.name}" not decoded.`);let ep=this.dataIndex[el],e_=this.bandShape.reduce((F,el)=>F*el,1),eg=eh*e_,ey=ec.subarray(eg,eg+e_);return{data:ey,bytes:new Uint8Array(ey.buffer).subarray(ey.byteOffset,ey.byteOffset+ey.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:ep.offset,scale:ep.scale}}};ev.setPbf=function(F){e2=F};let nv=class nv{constructor(F,el,eh){this.tasks=F,this._onCancel=el,this._onComplete=eh,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(F,el){this._finalized||(this._onComplete(F,el),this._finalized=!0)}};ev.performDecoding=function(F,el){let eh=new Uint8Array(F);return Promise.all(el.tasks.map(F=>{let{layerName:el,firstByte:ec,lastByte:ep,pixelFormat:e_,blockShape:eg,blockIndex:ey,filters:eb,codec:ew}=F,eT=eh.subarray(ec,ep+1),eS=new Uint32Array(eg[0]*eg[1]*eg[2]);if("gzip_data"!==ew)throw new Wx(`Unhandled codec: ${ew}`);return(function(F,el){var eh,ec;if(!globalThis.DecompressionStream&&"gzip_data"===el)return Promise.resolve(((ec=function(F){31==F[0]&&139==F[1]&&8==F[2]||Yx(6,"invalid gzip data");var el=F[3],eh=10;4&el&&(eh+=2+(F[10]|F[11]<<8));for(var ec=(el>>3&1)+(el>>4&1);ec>0;ec-=!F[eh++]);return eh+(2&el)}(F))+8>F.length&&Yx(6,"invalid gzip data"),function(F,el,eh,ec){var ep=F.length;if(!ep||el.f&&!el.l)return eh||new nK(0);var e_=!eh,eg=e_||2!=el.i,ey=el.i;e_&&(eh=new nK(3*ep));var eb,ew,c=function(F){var el=eh.length;if(F>el){var ec=new nK(Math.max(2*el,F));ec.set(eh),eh=ec}},eT=el.f||0,eS=el.p||0,eE=el.b||0,eM=el.l,eI=el.d,eA=el.m,eC=el.n,eP=8*ep;do{if(!eM){eT=qx(F,eS,1);var ez=qx(F,eS+1,3);if(eS+=3,!ez){var eD=F[(eG=4+((eS+7)/8|0))-4]|F[eG-3]<<8,eR=eG+eD;if(eR>ep){ey&&Yx(0);break}eg&&c(eE+eD),eh.set(F.subarray(eG,eR),eE),el.b=eE+=eD,el.p=eS=8*eR,el.f=eT;continue}if(1==ez)eM=od,eI=op,eA=9,eC=5;else if(2==ez){var eL=qx(F,eS,31)+257,eO=qx(F,eS+10,15)+4,ek=eL+qx(F,eS+5,31)+1;eS+=14;for(var eF=new nK(ek),eB=new nK(19),eN=0;eN<eO;++eN)eB[n2[eN]]=qx(F,eS+3*eN,7);eS+=3*eO;var eV=jx(eB),eU=(1<<eV)-1,ej=Lx(eB,eV);for(eN=0;eN<ek;){var eG,eq=ej[qx(F,eS,eU)];if(eS+=15&eq,(eG=eq>>4)<16)eF[eN++]=eG;else{var e$=0,eH=0;for(16==eG?(eH=3+qx(F,eS,3),eS+=2,e$=eF[eN-1]):17==eG?(eH=3+qx(F,eS,7),eS+=3):18==eG&&(eH=11+qx(F,eS,127),eS+=7);eH--;)eF[eN++]=e$}}var eZ=eF.subarray(0,eL),eW=eF.subarray(eL);eA=jx(eZ),eC=jx(eW),eM=Lx(eZ,eA),eI=Lx(eW,eC)}else Yx(1);if(eS>eP){ey&&Yx(0);break}}eg&&c(eE+131072);for(var eY=(1<<eA)-1,eX=(1<<eC)-1,eK=eS;;eK=eS){var eJ=(e$=eM[$x(F,eS)&eY])>>4;if((eS+=15&e$)>eP){ey&&Yx(0);break}if(e$||Yx(2),eJ<256)eh[eE++]=eJ;else{if(256==eJ){eK=eS,eM=null;break}var eQ=eJ-254;eJ>264&&(eQ=qx(F,eS,(1<<(e2=n0[eN=eJ-257]))-1)+n4[eN],eS+=e2);var e0=eI[$x(F,eS)&eX],e1=e0>>4;if(e0||Yx(3),eS+=15&e0,eW=n6[e1],e1>3){var e2=n1[e1];eW+=$x(F,eS)&(1<<e2)-1,eS+=e2}if(eS>eP){ey&&Yx(0);break}eg&&c(eE+131072);var e3=eE+eQ;if(eE<eW){var e4=0-eW,e5=Math.min(eW,e3);for(e4+eE<0&&Yx(3);eE<e5;++eE)eh[eE]=(void 0)[e4+eE]}for(;eE<e3;++eE)eh[eE]=eh[eE-eW]}}el.l=eM,el.p=eK,el.b=eE,el.f=eT,eM&&(eT=1,el.m=eA,el.d=eI,el.n=eC)}while(!eT);return eE!=eh.length&&e_?(eb=eh,(null==(ew=eE)||ew>eb.length)&&(ew=eb.length),new nK(eb.subarray(0,ew))):eh.subarray(0,eE)}(F.subarray(ec,-8),{i:2},new nK((F[(eh=F.length)-4]|F[eh-3]<<8|F[eh-2]<<16|F[eh-1]<<24)>>>0))));let ep=ov[el];if(!ep)throw Error(`Unhandled codec: ${el}`);let e_=new globalThis.DecompressionStream(ep);return new Response(new Blob([F]).stream().pipeThrough(e_)).arrayBuffer().then(F=>new Uint8Array(F))})(eT,ew).then(F=>((function(F,el){F.readFields(xx,el)})(new e2(F),eS),new oT[e_](eS.buffer))).then(F=>{for(let el=eb.length-1;el>=0;el--)switch(eb[el]){case"delta_filter":(function(F,el){if(4!==el.length)throw Error(`Expected data of dimension 4 but got ${el.length}.`);let eh=el[3];for(let ec=2;ec>=1;ec--){let ep=1===ec?1:0,e_=2===ec?1:0;for(let ec=0;ec<el[0];ec++){let eg=el[1]*ec;for(let ec=ep;ec<el[1];ec++){let ep=el[2]*(ec+eg);for(let ec=e_;ec<el[2];ec++){let e_=el[3]*(ec+ep);for(let ec=0;ec<el[3];ec++){let el=e_+ec;F[el]+=F[el-eh]}}}}eh*=el[ec]}})(F,eg);break;case"zigzag_filter":(function(F){for(let el=0,eh=F.length;el<eh;el++)F[el]=F[el]>>>1^-(1&F[el])})(F);break;case"bitshuffle_filter":(function(F,el){switch(el){case"uint32":return;case"uint16":for(let el=0;el<F.length;el+=2){let eh=F[el],ec=F[el+1];F[el]=(240&eh)>>4|(61440&eh)>>8|(240&ec)<<4|61440&ec,F[el+1]=15&eh|(3840&eh)>>4|(15&ec)<<8|(3840&ec)<<4}return;case"uint8":for(let el=0;el<F.length;el+=4){let eh=F[el],ec=F[el+1],ep=F[el+2],e_=F[el+3];F[el+0]=(192&eh)>>6|(192&ec)>>4|(192&ep)>>2|192&e_,F[el+1]=(48&eh)>>4|(48&ec)>>2|48&ep|(48&e_)<<2,F[el+2]=(12&eh)>>2|12&ec|(12&ep)<<2|(12&e_)<<4,F[el+3]=3&eh|(3&ec)<<2|(3&ep)<<4|(3&e_)<<6}return;default:throw Error(`Invalid pixel format, "${el}"`)}})(F,e_);break;default:throw new Wx(`Unhandled filter "${eb[el]}"`)}return{layerName:el,blockIndex:ey,data:F}}).catch(F=>{throw F})}))},us(nv,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),us(ev,"MapboxRasterTile"),us(rv,"MapboxRasterLayer",{omit:["_blocksInProgress"]});let oS,oE,oM,oI,oA,oC=null;function cv(){return yt()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:oE||tY.DRACO_URL}function hv(){if(yt()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(oI)return oI;let F=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw Error("WebAssembly not supported, cannot instantiate meshoptimizer");return oI=WebAssembly.validate(F)?tY.MESHOPT_SIMD_URL:tY.MESHOPT_URL}let oP={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},oz={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},oD={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function mv(F,el,eh){let ec=eh.json.bufferViews.length,ep=eh.buffers.length;el.bufferView=ec,eh.json.bufferViews[ec]={buffer:ep,byteLength:F.byteLength},eh.buffers[ep]=F}let oR="KHR_draco_mesh_compression",oL="EXT_meshopt_compression",oO=new TextDecoder("utf8");function wv(F,el){return new URL(F,el).href}function Av(F,el){let eh=F.json.bufferViews[el];return new Uint8Array(F.buffers[eh.buffer],eh.byteOffset||0,eh.byteLength)}function Sv(F,el=0,eh){let ec={json:null,images:[],buffers:[]};if(1179937895===new Uint32Array(F,el,1)[0]){let eh=new Uint32Array(F,el),ep=2,e_=(eh[ep++]>>2)-3,eg=eh[ep++]>>2;if(ep++,ec.json=JSON.parse(oO.decode(eh.subarray(ep,ep+eg))),(ep+=eg)<e_){let e_=eh[ep++];ep++;let eg=el+(ep<<2);ec.buffers[0]=F.slice(eg,eg+e_)}}else ec.json=JSON.parse(oO.decode(new Uint8Array(F,el)));let{buffers:ep,images:e_,meshes:eg,extensionsUsed:ey,bufferViews:eb}=ec.json,ew=Promise.resolve();if(ep){let F=[];for(let el=0;el<ep.length;el++){let e_=ep[el];e_.uri?F.push(function(F,el,eh,ec){return fetch(wv(F.uri,ec)).then(F=>F.arrayBuffer()).then(F=>{el.buffers[eh]=F})}(e_,ec,el,eh)):ec.buffers[el]||(ec.buffers[el]=null)}ew=Promise.all(F)}return ew.then(()=>{let F=[],el=ey&&ey.includes(oR),ep=ey&&ey.includes(oL);if(el&&F.push(function(){if(!oM)return null!=oS?oS:(oS=function(F){let el,eh=null;function n(){el=new Uint8Array(eh.buffer)}function i(){throw Error("Unexpected Draco error.")}let ec={a:{a:i,d:function(F,eh,ec){return el.copyWithin(F,eh,eh+ec)},c:function(F){let ec=el.length,ep=Math.max(F>>>0,Math.ceil(1.2*ec)),e_=Math.ceil((ep-ec)/65536);try{return eh.grow(e_),n(),!0}catch(F){return!1}},b:i}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(F,ec):F.then(F=>F.arrayBuffer()).then(F=>WebAssembly.instantiate(F,ec))).then(F=>{let ec,ep,e_,eg;let{Rb:ey,Qb:eb,P:ew,T:eT,X:eS,Ja:eE,La:eM,Qa:eI,Va:eA,Wa:eC,eb:eP,jb:ez,f:eD,e:eR,yb:eL,zb:eO,Ab:ek,Bb:eF,Db:eB,Gb:eN}=F.instance.exports;eh=eR;let eV=(ec=0,ep=0,e_=0,eg=0,F=>{e_&&(ey(eg),ey(ec),ep+=e_,e_=ec=0),ec||(ep+=128,ec=eb(ep));let eh=F.length+7&-8,ew=ec;eh>=ep&&(e_=eh,ew=eg=eb(eh));for(let eh=0;eh<F.length;eh++)el[ew+eh]=F[eh];return ew});return n(),eD(),{memory:eR,_free:ey,_malloc:eb,Mesh:class{constructor(){this.ptr=ew()}destroy(){eT(this.ptr)}},Decoder:class{constructor(){this.ptr=eE()}destroy(){ez(this.ptr)}DecodeArrayToMesh(F,el,eh){let ec=eV(F),ep=eM(this.ptr,ec,el,eh.ptr);return!!eS(ep)}GetAttributeByUniqueId(F,el){return{ptr:eI(this.ptr,F.ptr,el)}}GetTrianglesUInt16Array(F,el,eh){eA(this.ptr,F.ptr,el,eh)}GetTrianglesUInt32Array(F,el,eh){eC(this.ptr,F.ptr,el,eh)}GetAttributeDataArrayForAllPoints(F,el,eh,ec,ep){eP(this.ptr,F.ptr,el.ptr,eh,ec,ep)}},DT_INT8:eL(),DT_UINT8:eO(),DT_INT16:ek(),DT_UINT16:eF(),DT_UINT32:eB(),DT_FLOAT32:eN()}})}(fetch(cv()))).then(F=>{oM=F,oS=void 0})}()),ep&&F.push(function(){if(oA)return;let F=function(F){let el;let eh=WebAssembly.instantiateStreaming(F,{}).then(F=>{(el=F.instance).exports.__wasm_call_ctors()}),ec={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},ep={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:eh,supported:!0,decodeGltfBuffer(F,eh,e_,eg,ey,eb){!function(F,el,eh,ec,ep,e_,eg){let ey=F.exports.sbrk,eb=ec+3&-4,ew=ey(eb*ep),eT=ey(e_.length),eS=new Uint8Array(F.exports.memory.buffer);eS.set(e_,eT);let eE=el(ew,ec,ep,eT,e_.length);if(0===eE&&eg&&eg(ew,eb,ep),eh.set(eS.subarray(ew,ew+ec*ep)),ey(ew-ey(0)),0!==eE)throw Error(`Malformed buffer data: ${eE}`)}(el,el.exports[ep[ey]],F,eh,e_,eg,el.exports[ec[eb]])}}}(fetch(hv()));return F.ready.then(()=>{oA=F})}()),e_)for(let el=0;el<e_.length;el++)F.push(function(F,el,eh,ec){if(F.uri){let ep=wv(F.uri,ec);return fetch(ep).then(F=>F.blob()).then(F=>createImageBitmap(F)).then(F=>{el.images[eh]=F})}if(void 0!==F.bufferView){let ec=Av(el,F.bufferView),ep=new Blob([ec],{type:F.mimeType});return createImageBitmap(ep).then(F=>{el.images[eh]=F})}}(e_[el],ec,el,eh));return(F.length?Promise.all(F):Promise.resolve()).then(()=>{if(el&&eg)for(let{primitives:F}of eg)for(let el of F)!function(F,el){let eh=F.extensions&&F.extensions[oR];if(!eh)return;let ec=new oM.Decoder,ep=Av(el,eh.bufferView),e_=new oM.Mesh;if(!ec.DecodeArrayToMesh(ep,ep.byteLength,e_))throw Error("Failed to decode Draco mesh");let eg=el.json.accessors[F.indices],ey=oP[eg.componentType],eb=eg.count*ey.BYTES_PER_ELEMENT,ew=oM._malloc(eb);for(let ep of(ey===Uint16Array?ec.GetTrianglesUInt16Array(e_,eb,ew):ec.GetTrianglesUInt32Array(e_,eb,ew),mv(oM.memory.buffer.slice(ew,ew+eb),eg,el),oM._free(ew),Object.keys(eh.attributes))){let eg=ec.GetAttributeByUniqueId(e_,eh.attributes[ep]),ey=el.json.accessors[F.attributes[ep]],eb=oz[ey.componentType],ew=ey.count*oD[ey.type]*oP[ey.componentType].BYTES_PER_ELEMENT,eT=oM._malloc(ew);ec.GetAttributeDataArrayForAllPoints(e_,eg,oM[eb],ew,eT),mv(oM.memory.buffer.slice(eT,eT+ew),ey,el),oM._free(eT)}ec.destroy(),e_.destroy(),delete F.extensions[oR]}(el,ec);if(ep&&eg&&eb)for(let F of eb)!function(F,el){if(!F.extensions||!F.extensions[oL])return;let eh=F.extensions[oL],ec=new Uint8Array(el.buffers[eh.buffer],eh.byteOffset||0,eh.byteLength||0),ep=new Uint8Array(eh.count*eh.byteStride);oA.decodeGltfBuffer(ep,eh.count,eh.byteStride,ec,eh.mode,eh.filter),F.buffer=el.buffers.length,F.byteOffset=0,el.buffers[F.buffer]=ep.buffer,delete F.extensions[oL]}(F,ec);return ec})})}function Pv(F,el){let eh=F.json.bufferViews[el.bufferView],ec=oP[el.componentType];return new ec(F.buffers[eh.buffer],(el.byteOffset||0)+(eh.byteOffset||0),el.count*(eh.byteStride&&eh.byteStride!==oD[el.type]*ec.BYTES_PER_ELEMENT?eh.byteStride/ec.BYTES_PER_ELEMENT:oD[el.type]))}function Ev(F,el,eh,ec){let ep=oP[el.componentType],e_=function(F){switch(F){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(ep),eg=F.json.bufferViews[el.bufferView],ey=eg.byteStride?eg.byteStride/ep.BYTES_PER_ELEMENT:oD[el.type],eb=eh.float32,ew=eb.length/eh.capacity;for(let F=0,eh=0;F<el.count*ey;F+=ey,eh+=ew)for(let el=0;el<ew;el++)eb[eh+el]=ec[F+el]*e_;eh._trim()}function Cv(F){let el=function(F,el){let eh=[],ec=WebGL2RenderingContext;if(F.json.textures)for(let ep of F.json.textures){let e_={magFilter:ec.LINEAR,minFilter:ec.NEAREST,wrapS:ec.REPEAT,wrapT:ec.REPEAT};void 0!==ep.sampler&&Object.assign(e_,F.json.samplers[ep.sampler]),eh.push({image:el[ep.source],sampler:e_,uploaded:!1})}return eh}(F,F.images),eh=function(F,el){let eh=[];for(let ec of F.json.meshes){let ep=[];for(let eh of ec.primitives)ep.push(function(F,el,eh){let ec=F.indices,ep=F.attributes,e_={};e_.indexArray=new ja;let eg=el.json.accessors[ec],ey=eg.count/3;e_.indexArray.reserve(ey);let eb=Pv(el,eg);for(let F=0;F<ey;F++)e_.indexArray.emplaceBack(eb[3*F],eb[3*F+1],eb[3*F+2]);e_.indexArray._trim(),e_.vertexArray=new za;let ew=el.json.accessors[ep.POSITION];e_.vertexArray.reserve(ew.count);let eT=Pv(el,ew);for(let F=0;F<ew.count;F++)e_.vertexArray.emplaceBack(eT[3*F],eT[3*F+1],eT[3*F+2]);if(e_.vertexArray._trim(),e_.aabb=new Au(ew.min,ew.max),e_.centroid=function(F,el){let eh=[0,0,0],ec=F.length;if(ec>0){for(let ep=0;ep<ec;ep++){let ec=3*F[ep];eh[0]+=el[ec],eh[1]+=el[ec+1],eh[2]+=el[ec+2]}eh[0]/=ec,eh[1]/=ec,eh[2]/=ec}return eh}(eb,eT),void 0!==ep.COLOR_0){let F=el.json.accessors[ep.COLOR_0],eh=oD[F.type],ec=Pv(el,F);e_.colorArray=3===eh?new za:new Da,e_.colorArray.resize(F.count),Ev(el,F,e_.colorArray,ec)}if(void 0!==ep.NORMAL){e_.normalArray=new za;let F=el.json.accessors[ep.NORMAL];e_.normalArray.resize(F.count);let eh=Pv(el,F);Ev(el,F,e_.normalArray,eh)}if(void 0!==ep.TEXCOORD_0&&eh.length>0){e_.texcoordArray=new Za;let F=el.json.accessors[ep.TEXCOORD_0];e_.texcoordArray.resize(F.count);let eh=Pv(el,F);Ev(el,F,e_.texcoordArray,eh)}if(void 0!==ep._FEATURE_ID_RGBA4444){let F=el.json.accessors[ep._FEATURE_ID_RGBA4444];el.json.extensionsUsed&&el.json.extensionsUsed.includes("EXT_meshopt_compression")&&(e_.featureData=Pv(el,F))}void 0!==ep._FEATURE_RGBA4444&&(e_.featureData=new Uint32Array(Pv(el,el.json.accessors[ep._FEATURE_RGBA4444]).buffer));let eS=F.material;return e_.material=function(F,el){let{emissiveFactor:eh=[0,0,0],alphaMode:ec="OPAQUE",alphaCutoff:ep=.5,normalTexture:e_,occlusionTexture:eg,emissiveTexture:ey,doubleSided:eb}=F,{baseColorFactor:ew=[1,1,1,1],metallicFactor:eT=1,roughnessFactor:eS=1,baseColorTexture:eE,metallicRoughnessTexture:eM}=F.pbrMetallicRoughness||{},eI=eg?el[eg.index]:void 0;if(eg&&eg.extensions&&eg.extensions.KHR_texture_transform&&eI){let F=eg.extensions.KHR_texture_transform;eI.offsetScale=[F.offset[0],F.offset[1],F.scale[0],F.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Se(...ew),metallicFactor:eT,roughnessFactor:eS,baseColorTexture:eE?el[eE.index]:void 0,metallicRoughnessTexture:eM?el[eM.index]:void 0},doubleSided:eb,emissiveFactor:eh,alphaMode:ec,alphaCutoff:ep,normalTexture:e_?el[e_.index]:void 0,occlusionTexture:eI,emissionTexture:ey?el[ey.index]:void 0,defined:void 0===F.defined}}(void 0!==eS?el.json.materials[eS]:{defined:!1},eh),e_}(eh,F,el));eh.push(ep)}return eh}(F,el),{scenes:ec,scene:ep,nodes:e_}=F.json,eg=ec?ec[ep||0].nodes:e_,ey=[];for(let el of eg)ey.push(function kv(F,el,eh){let{matrix:ec,rotation:ep,translation:e_,scale:eg,mesh:ey,extras:eb,children:ew}=F,eT={};if(eT.matrix=ec||tN.mat4.fromRotationTranslationScale([],ep||[0,0,0,1],e_||[0,0,0],eg||[1,1,1]),void 0!==ey){eT.meshes=eh[ey];let F=eT.anchor=[0,0];for(let el of eT.meshes){let{min:eh,max:ec}=el.aabb;F[0]+=eh[0]+ec[0],F[1]+=eh[1]+ec[1]}F[0]=Math.floor(F[0]/eT.meshes.length/2),F[1]=Math.floor(F[1]/eT.meshes.length/2)}if(eb&&(eb.id&&(eT.id=eb.id),eb.lights&&(eT.lights=function(F){if(!F.length)return[];let el=function(F){let el=atob(F),eh=new Uint8Array(el.length);for(let F=0;F<el.length;F++)eh[F]=el.codePointAt(F);return eh}(F),eh=[],ec=el.length/24,ep=new Uint16Array(el.buffer),e_=new Float32Array(el.buffer);for(let F=0;F<ec;F++){let el=ep[2*F*6]/30,ec=ep[2*F*6+1]/30,eg=ep[2*F*6+10]/100,ey=e_[6*F+1],eb=e_[6*F+2],ew=e_[6*F+3],eT=e_[6*F+4],eS=ew-ey,eE=eT-eb,eM=Math.hypot(eS,eE);eh.push({pos:[ey+.5*eS,eb+.5*eE,ec],normal:[eE/eM,-eS/eM,0],width:eM,height:el,depth:eg,points:[ey,eb,ew,eT]})}return eh}(eb.lights))),ew){let F=[];for(let ec of ew)F.push(kv(el.json.nodes[ec],el,eh));eT.children=F}return eT}(e_[el],F,eh));return function(F,el,eh){let ec={},ep=new Set;for(let e_=0;e_<F.length;e_++){let F=eh[el[e_]];if(!F.extras)continue;let eg=F.extras["mapbox:footprint:version"],ey=F.extras["mapbox:footprint:id"];(eg||ey)&&ep.add(e_),"1.0.0"===eg&&ey&&(ec[ey]=e_)}for(let e_=0;e_<F.length;e_++){if(ep.has(e_))continue;let eg=F[e_],ey=eh[el[e_]];if(!ey.extras)continue;let eb=null;eg.id in ec&&(eb=function(F,el){let eh=[],ec=[],ep=0,e_=[];for(let eg of F){ep=eh.length;let F=eg.vertexArray.float32,ey=eg.indexArray.uint16;for(let ec=0;ec<eg.vertexArray.length;ec++)e_[0]=F[3*ec+0],e_[1]=F[3*ec+1],e_[2]=F[3*ec+2],tN.vec3.transformMat4(e_,e_,el),eh.push(new tU(e_[0],e_[1]));for(let F=0;F<3*eg.indexArray.length;F++)ec.push(ey[F]+ep)}if(ec.length%3!=0)return null;for(let F=0;F<ec.length;F+=3){let el=eh[ec[F+0]],ep=eh[ec[F+1]],e_=eh[ec[F+2]];(el.x-ep.x)*(e_.y-ep.y)-(e_.x-ep.x)*(el.y-ep.y)>0&&([ec[F+1],ec[F+2]]=[ec[F+2],ec[F+1]])}return{vertices:eh,indices:ec}}(F[ec[eg.id]].meshes,eg.matrix)),eb||(eb=function(F){if(!F.extras||!F.extras.ground)return null;let el=F.extras.ground;if(!el||!Array.isArray(el)||0===el.length)return null;let eh=el[0];if(!eh||!Array.isArray(eh)||0===eh.length)return null;let ec=[];for(let F of eh){if(!Array.isArray(F)||2!==F.length)continue;let el=F[0],eh=F[1];"number"==typeof el&&"number"==typeof eh&&ec.push(new tU(el,eh))}if(ec.length<3)return null;ec.length>1&&ec[ec.length-1].equals(ec[0])&&ec.pop();let ep=0;for(let F=0;F<ec.length;F++){let el=ec[F],eh=ec[(F+1)%ec.length],e_=ec[(F+2)%ec.length];ep+=(el.x-eh.x)*(e_.y-eh.y)-(e_.x-eh.x)*(el.y-eh.y)}ep>0&&ec.reverse();let e_=vc(ec.flatMap(F=>[F.x,F.y]),[]);return 0===e_.length?null:{vertices:ec,indices:e_}}(ey)),eb&&(eg.footprint=function(F){if(0===F.vertices.length||0===F.indices.length)return null;let el=new Sh(F.vertices,F.indices,8,256),[eh,ec]=[el.min.clone(),el.max.clone()];return{vertices:F.vertices,indices:F.indices,grid:el,min:eh,max:ec}}(eb))}if(ep.size>0){let el=Array.from(ep.values()).sort((F,el)=>F-el);for(let eh=el.length-1;eh>=0;eh--)F.splice(el[eh],1)}}(ey,eg,F.json.nodes),ey}let Lv=class Lv{constructor(F){this._stringToNumber={},this._numberToString=[];for(let el=0;el<F.length;el++){let eh=F[el];this._stringToNumber[eh]=el,this._numberToString[el]=eh}}encode(F){return this._stringToNumber[F]}decode(F){return this._numberToString[F]}};let ok=["id","tile","layer","source","sourceLayer","state"];let Ov=class Ov{constructor(F,el,eh,ec,ep){this.type="Feature",this._vectorTileFeature=F,this._z=el,this._x=eh,this._y=ec,this.properties=F.properties,this.id=ep}clone(){let F=new Ov(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(F.state=Object.assign({},this.state)),this.layer&&(F.layer=Object.assign({},this.layer)),this.source&&(F.source=this.source),this.sourceLayer&&(F.sourceLayer=this.sourceLayer),F}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(F){this._geometry=F}toJSON(){let F={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(let el of ok)void 0!==this[el]&&(F[el]=this[el]);return F}};let Nv=class Nv{constructor(F,el){this.tileID=F,this.x=F.canonical.x,this.y=F.canonical.y,this.z=F.canonical.z,this.grid=new i9(8192,16,0),this.featureIndexArray=new ho,this.promoteId=el,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(F,el,eh,ec,ep,e_=0,eg=0){let ey=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(eh,ec,ep,e_);let eb=this.grid;for(let F=0;F<el.length;F++){let eh=el[F],ec=[1/0,1/0,-1/0,-1/0];for(let F=0;F<eh.length;F++){let el=eh[F];ec[0]=Math.min(ec[0],el.x),ec[1]=Math.min(ec[1],el.y),ec[2]=Math.max(ec[2],el.x),ec[3]=Math.max(ec[3],el.y)}0!==eg&&(ec[0]-=eg,ec[1]-=eg,ec[2]+=eg,ec[3]+=eg),ec[0]<8192&&ec[1]<8192&&ec[2]>=0&&ec[3]>=0&&eb.insert(ey,ec[0],ec[1],ec[2],ec[3])}}loadVTLayers(){if(!this.vtLayers)for(let F in this.vtLayers=new am.VectorTile(new a9(this.rawTileData)).layers,this.sourceLayerCoder=new Lv(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={},this.vtLayers)this.vtFeatures[F]=[];return this.vtLayers}query(F,el){let eh;let{tilespaceGeometry:ec,transform:ep,tileTransform:e_,pixelPosMatrix:eg,availableImages:ey}=el;this.loadVTLayers(),this.serializedLayersCache.clear();let eb=ec.bufferedTilespaceBounds,ew=this.grid.query(eb.min.x,eb.min.y,eb.max.x,eb.max.y,(F,el,eh,ep)=>Xl(ec.bufferedTilespaceGeometry,F,el,eh,ep));ew.sort(jv);let eT=null;ep.elevation&&ew.length>0&&(eT=Fy.create(ep.elevation,this.tileID));let eS={};for(let el=0;el<ew.length;el++){let eb=ew[el];if(eb===eh)continue;eh=eb;let eE=this.featureIndexArray.get(eb),eM=null;this.is3DTile?this.loadMatchingModelFeature(eS,eE,F,ec,ep):this.loadMatchingFeature(eS,eE,F,ey,(F,el,eh,ey=0)=>(eM||(eM=Vl(F,this.tileID.canonical,e_)),el.queryIntersectsFeature(ec,F,eh,eM,this.z,ep,eg,eT,ey)))}return eS}loadMatchingFeature(F,el,eh,ec,ep){let{featureIndex:e_,bucketIndex:eg,sourceLayerIndex:ey,layoutVertexArrayOffset:eb}=el,ew=this.bucketLayerIDs[eg],eT=eh.layers,eS=Object.keys(eT);if(eS.length&&!function(F,el){for(let eh=0;eh<F.length;eh++)if(el.indexOf(F[eh])>=0)return!0;return!1}(eS,ew))return;let eE=eh.sourceCache,eM=this.sourceLayerCoder.decode(ey),eI=this.vtLayers[eM].feature(e_),eA=this.getId(eI,eM);for(let el=0;el<ew.length;el++){let eh=ew[el];if(!eT[eh])continue;let{styleLayer:eg,targets:ey}=eT[eh],eS={};void 0!==eA&&(eS=eE.getFeatureState(eg.sourceLayer,eA));let eM=!ep||ep(eI,eg,eS,eb);if(!eM)continue;let eC=new Ov(eI,this.z,this.x,this.y,eA);eC.tile=this.tileID.canonical,eC.state=eS;let eP=this.serializedLayersCache.get(eh);eP||((eP=eg.serialize()).id=eh,this.serializedLayersCache.set(eh,eP)),eC.source=eP.source,eC.sourceLayer=eP["source-layer"],eC.layer=nt({},eP),eC.layer.paint=Uv(eP.paint,eg.paint,eI,eS,ec),eC.layer.layout=Uv(eP.layout,eg.layout,eI,eS,ec);let ez=!1;for(let F of ey){this.updateFeatureProperties(eC,F);let{filter:el}=F;if(el){if(eI.properties=eC.properties,el.needGeometry){let F=Cl(eI,!0);if(!el.filter(new Rs(this.tileID.overscaledZ),F,this.tileID.canonical))continue}else if(!el.filter(new Rs(this.tileID.overscaledZ),eI))continue}ez=!0,F.targetId&&this.addFeatureVariant(eC,F)}ez&&this.appendToResult(F,eh,e_,eC,eM)}}loadMatchingModelFeature(F,el,eh,ec,ep){let e_=this.bucketLayerIDs[0][0],eg=eh.layers;if(!eg[e_])return;let{styleLayer:ey,targets:eb}=eg[e_];if("model"!==ey.type)return;let ew=ec.tile,eT=el.featureIndex,eS=ew.getBucket(ey);if(!(eS&&eS instanceof Gy))return;let eE=function(F,el,eh,ec){let ep=F.getNodesInfo()[el];if(ep.hiddenByReplacement||!ep.node.meshes)return;let e_=Number.MAX_VALUE,eg=ep.node,ey=eh.tile,eb=ec.calculatePosMatrix(ey.tileID.toUnwrapped(),ec.worldSize),ew=ep.evaluatedScale,eT=0;ec.elevation&&eg.elevation&&(eT=eg.elevation*ec.elevation.exaggeration()),tN.mat4.translate(eb,eb,[(eg.anchor?eg.anchor[0]:0)*(ew[0]-1),(eg.anchor?eg.anchor[1]:0)*(ew[1]-1),eT]),tN.mat4.scale(eb,eb,ew);let eS=eh.queryGeometry,eE=eS.isPointQuery()?eS.screenBounds:eS.screenGeometry,f=function(F){let el=tN.mat4.multiply([],eb,F.matrix);tN.mat4.multiply(el,ec.expandedFarZProjMatrix,el);for(let eh=0;eh<F.meshes.length;++eh){let ep=F.meshes[eh];if(eh===F.lightMeshIndex)continue;let eg=dy(eE,ec,el,ep.aabb);null!=eg&&(e_=Math.min(eg,e_))}if(F.children)for(let el of F.children)f(el)};if(f(eg),e_===Number.MAX_VALUE)return;let eM=new ul(0,0);return Zy(ey.tileID.canonical,eM,ep.node.anchor[0],ep.node.anchor[1]),{intersectionZ:e_,position:eM,feature:ep.feature}}(eS,eT,ec,ep);if(!eE)return;let{z:eM,x:eI,y:eA}=ew.tileID.canonical,{feature:eC,intersectionZ:eP,position:ez}=eE,eD={};void 0!==eC.id&&(eD=eh.sourceCache.getFeatureState(ey.sourceLayer,eC.id));let eR=new Ov({},eM,eI,eA,eC.id);eR.tile=this.tileID.canonical,eR.state=eD,eR.properties=eC.properties,eR.geometry={type:"Point",coordinates:[ez.lng,ez.lat]};let eL=this.serializedLayersCache.get(e_);eL||((eL=ey.serialize()).id=e_,this.serializedLayersCache.set(e_,eL)),eR.source=eL.source,eR.sourceLayer=eL["source-layer"],eR.layer=nt({},eL);let eO=!1;for(let F of eb){this.updateFeatureProperties(eR,F);let{filter:el}=F;if(el){if(eC.properties=eR.properties,el.needGeometry){if(!el.filter(new Rs(this.tileID.overscaledZ),eC,this.tileID.canonical))continue}else if(!el.filter(new Rs(this.tileID.overscaledZ),eC))continue}eO=!0,F.targetId&&this.addFeatureVariant(eR,F)}eO&&this.appendToResult(F,e_,eT,eR,eP)}updateFeatureProperties(F,el,eh){if(el.properties){let ec={};for(let ep in el.properties){let e_=el.properties[ep].evaluate({zoom:this.z},F._vectorTileFeature,F.state,F.tile,eh);null!=e_&&(ec[ep]=e_)}F.properties=ec}}addFeatureVariant(F,el,eh){let ec={target:el.target,namespace:el.namespace,uniqueFeatureID:el.uniqueFeatureID};el.properties&&(ec.properties=F.properties),F.variants=F.variants||{},F.variants[el.targetId]=F.variants[el.targetId]||[],F.variants[el.targetId].push(ec)}appendToResult(F,el,eh,ec,ep){let e_=F[el];void 0===e_&&(e_=F[el]=[]),e_.push({featureIndex:eh,feature:ec,intersectionZ:ep})}lookupSymbolFeatures(F,el,eh,ec,ep){let e_={};for(let eg of(this.loadVTLayers(),F))this.loadMatchingFeature(e_,{bucketIndex:el,sourceLayerIndex:eh,featureIndex:eg,layoutVertexArrayOffset:0},ec,ep);return e_}loadFeature(F){let{featureIndex:el,sourceLayerIndex:eh}=F;this.loadVTLayers();let ec=this.sourceLayerCoder.decode(eh),ep=this.vtFeatures[ec];if(ep[el])return ep[el];let e_=this.vtLayers[ec].feature(el);return ep[el]=e_,e_}hasLayer(F){for(let el of this.bucketLayerIDs)for(let eh of el)if(F===eh)return!0;return!1}getId(F,el){let eh=F.id;if(this.promoteId){let ec=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[el];if(null!=ec){if(Array.isArray(ec)){if(!this.promoteIdExpression){let F=Ji(ec);if("success"!==F.result){let el=F.value.map(F=>`${F.key}: ${F.message}`).join(", ");return void pt(`Failed to create expression for promoteId: ${el}`)}this.promoteIdExpression=F.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new yr),eh=this.promoteIdExpression.evaluate({zoom:0},F)}else eh=F.properties[ec]}"boolean"==typeof eh&&(eh=Number(eh))}return eh}};function Uv(F,el,eh,ec,ep){return lt(F,(F,e_)=>{let eg=el instanceof $s?el.get(e_):null;return eg&&eg.evaluate?eg.evaluate(eh,ec,ep):eg})}function jv(F,el){return el-F}us(Nv,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});let oF=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];let $v=class $v{static from(F){if(!(F instanceof ArrayBuffer))throw Error("Data must be an instance of ArrayBuffer.");let[el,eh]=new Uint8Array(F,0,2);if(219!==el)throw Error("Data does not appear to be in a KDBush format.");let ec=eh>>4;if(1!==ec)throw Error(`Got v${ec} data when expected v1.`);let ep=oF[15&eh];if(!ep)throw Error("Unrecognized array type.");let[e_]=new Uint16Array(F,2,1),[eg]=new Uint32Array(F,4,1);return new $v(eg,e_,ep,F)}constructor(F,el=64,eh=Float64Array,ec){if(isNaN(F)||F<0)throw Error(`Unpexpected numItems value: ${F}.`);this.numItems=+F,this.nodeSize=Math.min(Math.max(+el,2),65535),this.ArrayType=eh,this.IndexArrayType=F<65536?Uint16Array:Uint32Array;let ep=oF.indexOf(this.ArrayType),e_=2*F*this.ArrayType.BYTES_PER_ELEMENT,eg=F*this.IndexArrayType.BYTES_PER_ELEMENT,ey=(8-eg%8)%8;if(ep<0)throw Error(`Unexpected typed array class: ${eh}.`);ec&&ec instanceof ArrayBuffer?(this.data=ec,this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+eg+ey,2*F),this._pos=2*F,this._finished=!0):(this.data=new ArrayBuffer(8+e_+eg+ey),this.ids=new this.IndexArrayType(this.data,8,F),this.coords=new this.ArrayType(this.data,8+eg+ey,2*F),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+ep]),new Uint16Array(this.data,2,1)[0]=el,new Uint32Array(this.data,4,1)[0]=F)}add(F,el){let eh=this._pos>>1;return this.ids[eh]=eh,this.coords[this._pos++]=F,this.coords[this._pos++]=el,eh}finish(){let F=this._pos>>1;if(F!==this.numItems)throw Error(`Added ${F} items when expected ${this.numItems}.`);return function Gv(F,el,eh,ec,ep,e_){if(ep-ec<=eh)return;let eg=ec+ep>>1;(function Yv(F,el,eh,ec,ep,e_){for(;ep>ec;){if(ep-ec>600){let eg=ep-ec+1,ey=eh-ec+1,eb=Math.log(eg),ew=.5*Math.exp(2*eb/3),eT=.5*Math.sqrt(eb*ew*(eg-ew)/eg)*(ey-eg/2<0?-1:1);Yv(F,el,eh,Math.max(ec,Math.floor(eh-ey*ew/eg+eT)),Math.min(ep,Math.floor(eh+(eg-ey)*ew/eg+eT)),e_)}let eg=el[2*eh+e_],ey=ec,eb=ep;for(Hv(F,el,ec,eh),el[2*ep+e_]>eg&&Hv(F,el,ec,ep);ey<eb;){for(Hv(F,el,ey,eb),ey++,eb--;el[2*ey+e_]<eg;)ey++;for(;el[2*eb+e_]>eg;)eb--}el[2*ec+e_]===eg?Hv(F,el,ec,eb):Hv(F,el,++eb,ep),eb<=eh&&(ec=eb+1),eh<=eb&&(ep=eb-1)}})(F,el,eg,ec,ep,e_),Gv(F,el,eh,ec,eg-1,1-e_),Gv(F,el,eh,eg+1,ep,1-e_)}(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(F,el,eh,ec){if(!this._finished)throw Error("Data not yet indexed - call index.finish().");let{ids:ep,coords:e_,nodeSize:eg}=this,ey=[0,ep.length-1,0],eb=[];for(;ey.length;){let ew=ey.pop()||0,eT=ey.pop()||0,eS=ey.pop()||0;if(eT-eS<=eg){for(let eg=eS;eg<=eT;eg++){let ey=e_[2*eg],ew=e_[2*eg+1];ey>=F&&ey<=eh&&ew>=el&&ew<=ec&&eb.push(ep[eg])}continue}let eE=eS+eT>>1,eM=e_[2*eE],eI=e_[2*eE+1];eM>=F&&eM<=eh&&eI>=el&&eI<=ec&&eb.push(ep[eE]),(0===ew?F<=eM:el<=eI)&&(ey.push(eS),ey.push(eE-1),ey.push(1-ew)),(0===ew?eh>=eM:ec>=eI)&&(ey.push(eE+1),ey.push(eT),ey.push(1-ew))}return eb}within(F,el,eh){if(!this._finished)throw Error("Data not yet indexed - call index.finish().");let{ids:ec,coords:ep,nodeSize:e_}=this,eg=[0,ec.length-1,0],ey=[],eb=eh*eh;for(;eg.length;){let ew=eg.pop()||0,eT=eg.pop()||0,eS=eg.pop()||0;if(eT-eS<=e_){for(let eh=eS;eh<=eT;eh++)Zv(ep[2*eh],ep[2*eh+1],F,el)<=eb&&ey.push(ec[eh]);continue}let eE=eS+eT>>1,eM=ep[2*eE],eI=ep[2*eE+1];Zv(eM,eI,F,el)<=eb&&ey.push(ec[eE]),(0===ew?F-eh<=eM:el-eh<=eI)&&(eg.push(eS),eg.push(eE-1),eg.push(1-ew)),(0===ew?F+eh>=eM:el+eh>=eI)&&(eg.push(eE+1),eg.push(eT),eg.push(1-ew))}return ey}};function Hv(F,el,eh,ec){Xv(F,eh,ec),Xv(el,2*eh,2*ec),Xv(el,2*eh+1,2*ec+1)}function Xv(F,el,eh){let ec=F[el];F[el]=F[eh],F[eh]=ec}function Zv(F,el,eh,ec){let ep=F-eh,e_=el-ec;return ep*ep+e_*e_}F.$=gr,F.A=ge,F.B=tr,F.C=pa,F.D=ng,F.E=_e,F.F=2,F.G=pd,F.H=cd,F.I=we,F.J=class extends My{},F.K=pr,F.L=Be,F.M=Ws,F.N=Ui,F.O=Fi,F.P=tU,F.Q=Ni,F.R=t9,F.S=Ki,F.T=qm,F.U=Ks,F.V=My,F.W=es,F.X=Ji,F.Y=Vn,F.Z=Dn,F._=Bn,F.a=function(F){return tY.API_CDN_URL_REGEX.test(F)},F.a$=Cl,F.a0=iT,F.a1=Js,F.a2=ji,F.a3=Oi,F.a4=function(F){let el=F.value,eh=[];if(!el)return eh;let ec=pr(el);return"string"!==ec?eh=eh.concat([new My(F.key,el,`string expected, "${ec}" found`)]):(Ay(el,!0)||(eh=eh.concat([new My(F.key,el,`invalid url "${el}"`)])),eh)},F.a5=rw,F.a6=Os,F.a7=Xs,F.a8=Gs,F.a9=class{constructor(F){this.specification=F}possiblyEvaluate(F,el){return mt(F.expression.evaluate(el))}interpolate(F,el,eh){return{x:Ee(F.x,el.x,eh),y:Ee(F.y,el.y,eh),z:Ee(F.z,el.z,eh),azimuthal:Ee(F.azimuthal,el.azimuthal,eh),polar:Ee(F.polar,el.polar,eh)}}},F.aA=function(F,el){let eh={};for(let ec=0;ec<el.length;ec++){let ep=el[ec];ep in F&&(eh[ep]=F[ep])}return eh},F.aB=cl,F.aC=ml,F.aD=class{constructor(F){this.entries={},this.scheduler=F}request(F,el,eh,ec){let ep=this.entries[F]=this.entries[F]||{callbacks:[]};if(ep.result){let[F,eh]=ep.result;return this.scheduler?this.scheduler.add(()=>{ec(F,eh)},el):ec(F,eh),()=>{}}return ep.callbacks.push(ec),ep.cancel||(ep.cancel=eh((eh,ec)=>{for(let F of(ep.result=[eh,ec],ep.callbacks))this.scheduler?this.scheduler.add(()=>{F(eh,ec)},el):F(eh,ec);setTimeout(()=>delete this.entries[F],3e3)})),()=>{ep.result||(ep.callbacks=ep.callbacks.filter(F=>F!==ec),ep.callbacks.length||(ep.cancel(),delete this.entries[F]))}}},F.aE=function(F,el,eh){let ec=JSON.stringify(F.request);return F.data&&(this.deduped.entries[ec]={result:[null,F.data]}),this.deduped.request(ec,{type:"parseTile",isSymbolTile:F.isSymbolTile,zoom:F.tileZoom},el=>{let ec=ne(F.request,(F,ec,ep,e_)=>{F?el(F):ec&&el(null,{vectorTile:eh?void 0:new am.VectorTile(new a9(ec)),rawData:ec,cacheControl:ep,expires:e_})});return()=>{ec.cancel(),el()}},el)},F.aF=function(F){++t1>tQ&&(F.getActor().send("enforceCacheSizeLimit",tJ),t1=0)},F.aG=function(F){return F<=1?1:Math.pow(2,Math.floor(Math.log(F)/Math.LN2))},F.aH=uu,F.aI=Wm,F.aJ=ry,F.aK=Xm,F.aL=function(F,el){let eh=document.createElement("video");eh.muted=!0,eh.onloadstart=function(){el(null,eh)};for(let el=0;el<F.length;el++){let ec=document.createElement("source");(function(F){let el=document.createElement("a");return el.href=F,el.protocol===location.protocol&&el.host===location.host})(F[el])||(eh.crossOrigin="Anonymous"),ec.src=F[el],eh.appendChild(ec)}return{cancel:()=>{}}},F.aM=$m,F.aN=function(F){return fetch(F).then(F=>F.arrayBuffer()).then(el=>Sv(el,0,F))},F.aO=Cv,F.aP=class{constructor(F,el,eh,ec){this.id=F,this.position=null!=el?new ul(el[0],el[1]):new ul(0,0),this.orientation=null!=eh?eh:[0,0,0],this.nodes=ec,this.uploaded=!1,this.aabb=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(F,el){if(tN.mat4.multiply(F.matrix,el,F.matrix),F.meshes)for(let el of F.meshes){let eh=Au.applyTransformFast(el.aabb,F.matrix);this.aabb.encapsulate(eh)}if(F.children)for(let el of F.children)this._applyTransformations(el,F.matrix)}computeBoundsAndApplyParent(){let F=tN.mat4.identity([]);for(let el of this.nodes)this._applyTransformations(el,F)}computeModelMatrix(F,el,eh,ec,ep,e_,eg=!1){By(this.matrix,this,F.transform,this.position,el,eh,ec,ep,e_,eg)}upload(F){if(!this.uploaded){for(let el of this.nodes)Dy(el,F);for(let F of this.nodes)Ry(F);this.uploaded=!0}}destroy(){for(let F of this.nodes)Ly(F)}},F.aQ=ot,F.aR=Kd,F.aS=gl,F.aT=xl,F.aU=Ma,F.aV=ja,F.aW=st,F.aX=no,F.aY=zm,F.aZ=function(){rb.isLoading()||rb.isLoaded()||"deferred"!==Vs()||Cs()},F.a_=Qs,F.aa=Rs,F.ab=ts,F.ac=Il,F.ad=tN,F.ae=tt,F.af=$s,F.ag=$u,F.ah=Ee,F.ai=8192,F.aj=ze,F.ak=function(F){return F*tj},F.al=Se,F.am=class{constructor(F){this.specification=F}possiblyEvaluate(F,el){return function([F,el]){let eh=mt([1,F,el]);return{x:eh.x,y:eh.y,z:eh.z}}(F.expression.evaluate(el))}interpolate(F,el,eh){return{x:Ee(F.x,el.x,eh),y:Ee(F.y,el.y,eh),z:Ee(F.z,el.z,eh)}}},F.an=function(F,el,eh=0,ec=!0){let ep=new tU(eh,eh),e_=F.sub(ep),eg=el.add(ep),ey=[e_,new tU(eg.x,e_.y),eg,new tU(e_.x,eg.y)];return ec&&ey.push(e_.clone()),ey},F.ao=function(F,el){let eh=[];for(let ec=0;ec<F.length;ec++){let ep=et(ec-1,-1,F.length-1),e_=et(ec+1,-1,F.length-1),eg=F[ec],ey=F[e_],eb=F[ep].sub(eg).unit(),ew=ey.sub(eg).unit(),eT=ew.angleWithSep(eb.x,eb.y),eS=eb.add(ew).unit().mult(-1*el/Math.sin(eT/2));eh.push(eg.add(eS))}return eh},F.ap=Jd,F.aq=Xl,F.ar=function(F,el,eh=0){return tN.vec3.fromValues(((el.x-eh)*F.scale-F.x)*8192,(el.y*F.scale-F.y)*8192,vl(el.z,el.y))},F.as=gu,F.at=Wp,F.au=function(F){let el=1/0,eh=1/0,ec=-1/0,ep=-1/0;for(let e_ of F)el=Math.min(el,e_.x),eh=Math.min(eh,e_.y),ec=Math.max(ec,e_.x),ep=Math.max(ep,e_.y);return{min:new tU(el,eh),max:new tU(ec,ep)}},F.av=dl,F.aw=Hl,F.ax=Pl,F.ay=Q,F.az=rF,F.b=function(F){return tY.API_FONTS_REGEX.test(F)},F.b$=oy,F.b0=Ov,F.b1=gt,F.b2=Yp,F.b3=_h,F.b4=Vl,F.b5=_a,F.b6=Ka,F.b7=rY,F.b8=xo,F.b9=vc,F.bA=Jh,F.bB=Nd,F.bC=Cd,F.bD=Kf,F.bE=$v,F.bF=et,F.bG=vt,F.bH=function(F,el){return F/fl(el)},F.bI=function(F,el,eh){F[4*el+0]=eh[0],F[4*el+1]=eh[1],F[4*el+2]=eh[2],F[4*el+3]=eh[3]},F.bJ=Co,F.bK=zo,F.bL=ko,F.bM=Eo,F.bN=Po,F.bO=ul,F.bP=vm,F.bQ=lu,F.bR=Mu,F.bS=ay,F.bT=ou,F.bU=Vu,F.bV=function(F,el,eh,ec,ep,e_,eg,ey,eb){if("globe"===eb.name)return Vu(F,el,new ou(eh,ec,ep),!1);let ew=Kd({z:eh,x:ec,y:ep},eb);return new Au([(e_+ew.x/ew.scale)*el,el*(ew.y/ew.scale),eg],[(e_+ew.x2/ew.scale)*el,el*(ew.y2/ew.scale),ey])},F.bW=function(F,el,eh){let ec=0;for(let eh=0;eh<2;++eh)F[eh]>0&&(ec+=(F[eh]-0)*(F[eh]-0)),el[eh]<0&&(ec+=(0-el[eh])*(0-el[eh]));return ec},F.bX=85.051129,F.bY=6,F.bZ=function(F){let el=tN.mat4.identity(new Float64Array(16));tN.mat4.multiply(el,F.pixelMatrix,F.globeMatrix);let eh=[0,rN,0],ec=[0,rF,0];return tN.vec3.transformMat4(eh,eh,el),tN.vec3.transformMat4(ec,ec,el),[eh[0]>0&&eh[0]<=F.width&&eh[1]>0&&eh[1]<=F.height&&!Yu(F,new ul(F.center.lat,90)),ec[0]>0&&ec[0]<=F.width&&ec[1]>0&&ec[1]<=F.height&&!Yu(F,new ul(F.center.lat,-90))]},F.b_=function(F,el){let{scale:eh}=F.tileTransform,ec=8192*eh/(F.tileSize*Math.pow(2,el.zoom-F.tileID.overscaledZ+F.tileID.canonical.z));return tN.mat2.scale(new Float32Array(4),el.inverseAdjustmentMatrix,[ec,ec])},F.ba=nM,F.bb=function(F,el){let eh=$u(el.zoom);if(0===eh)return ku(F);let ec=Cu(F),ep=Du(ec),e_=dl(ec.getWest())*el.worldSize,eg=dl(ec.getEast())*el.worldSize,ey=ml(ec.getNorth())*el.worldSize,eb=ml(ec.getSouth())*el.worldSize,ew=[e_,ey,0],eT=[eg,ey,0],eS=[e_,eb,0],eE=[eg,eb,0],eM=tN.mat4.invert([],el.globeMatrix);return tN.vec3.transformMat4(ew,ew,eM),tN.vec3.transformMat4(eT,eT,eM),tN.vec3.transformMat4(eS,eS,eM),tN.vec3.transformMat4(eE,eE,eM),ep[0]=Tu(ep[0],eS,eh),ep[1]=Tu(ep[1],eE,eh),ep[2]=Tu(ep[2],eT,eh),ep[3]=Tu(ep[3],ew,eh),Au.fromPoints(ep)},F.bc=Ou,F.bd=Ru,F.be=Tu,F.bf=wa,F.bg=rW,F.bh=ev,F.bi=a9,F.bj=ne,F.bk=function(F,el){let eh=[];for(let ec in F)ec in el||eh.push(ec);return eh},F.bl=rt,F.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],F.bn=$,F.bo=function(F,el){let{x:eh,y:ec}=F.point,ep=qu(eh,ec,F.worldSize/F._pixelsPerMercatorPixel,0,0);return tN.mat4.multiply(ep,ep,Nu(ku(el)))},F.bp=wf,F.bq=a7,F.br=_f,F.bs=function(F,el,eh,ec,ep){let e_=5*el+2;F.float32[e_+0]=eh,F.float32[e_+1]=ec,F.float32[e_+2]=ep},F.bt=Im,F.bu=ud,F.bv=Fl,F.bw=24,F.bx=jh,F.by=nO,F.bz=Kh,F.c=St,F.c$=tf,F.c0=sy,F.c1=function(F){let el=sy(F,!0);return tN.mat2.invert([],[el[0],el[1],el[4],el[5]])},F.c2=xu,F.c3=function(F){let{x:el,y:eh}=F.point,{lng:ec,lat:ep}=F._center;return qu(el,eh,F.worldSize,ec,ep)},F.c4=function(F){return F*tG},F.c5=cu,F.c6=5,F.c7=function(F){let el=Math.round((F+45+360)%360/90)%4;return tq[el]},F.c8=45,F.c9=ke,F.cA=Bo,F.cB=class extends So{constructor(F){super(F),this.current=rD}set(F,el,eh){if(this.fetchUniformLocation(F,el)){for(let F=0;F<9;F++)if(eh[F]!==this.current[F]){this.current=eh,this.gl.uniformMatrix3fv(this.location,!1,eh);break}}}},F.cC=W,F.cD=function(F,el,eh){let ec=$u(eh.zoom),ep=F.style.map._antialias,e_=F.terrain&&F.terrain.exaggeration()>0;return 0===ec&&!ep&&!e_},F.cE=function(F){let el=F.pixelsPerMeter,eh=el/(1/fl(F.center.lat)),ec=tN.mat4.identity(new Float64Array(16));return tN.mat4.translate(ec,ec,[F.point.x,F.point.y,0]),tN.mat4.scale(ec,ec,[eh,eh,el]),Float32Array.from(ec)},F.cF=Cu,F.cG=function(F){F=Q(F,-80.051129,80.051129)/80.051129*90;let el=Math.pow(Math.abs(Math.sin(F*tj)),3);return Math.round(el*(rB.length-1))},F.cH=function(F,el,eh,ec){let ep=el.getNorth(),e_=el.getSouth(),eg=el.getWest(),ey=el.getEast(),eb=1<<F.z,ew=ey-eg,eT=ep-e_,eS=ew/64,eE=-eT/rB[eh],eM=[0,eS,0,eE,0,0,ep,eg,0];if(F.z>0){let F=180/ec;tN.mat3.multiply(eM,eM,[F/ew+1,0,0,0,F/eT+1,0,-.5*F/eS,.5*F/eE,1])}return eM[2]=eb,eM[5]=F.x,eM[8]=F.y,eM},F.cI=ku,F.cJ=function(F,el,eh){let ec=tN.mat4.identity(new Float64Array(16)),ep=(el/(1<<F)-.5)*Math.PI*2;return tN.mat4.rotateY(ec,eh.globeMatrix,ep),Float32Array.from(ec)},F.cK=class{isDataAvailableAtPoint(F){let el=this._source();if(this.isUsingMockSource()||!el||F.y<0||F.y>1)return!1;let eh=el.getSource().maxzoom,ec=1<<eh,ep=Math.floor(F.x),e_=Math.floor((F.x-ep)*ec),eg=Math.floor(F.y*ec),ey=this.findDEMTileFor(new uu(eh,ep,eh,e_,eg));return!(!ey||!ey.dem)}getAtPointOrZero(F,el=0){return this.getAtPoint(F,el)||0}getAtPoint(F,el,eh=!0){if(this.isUsingMockSource())return null;null==el&&(el=null);let ec=this._source();if(!ec||F.y<0||F.y>1)return el;let ep=ec.getSource().maxzoom,e_=1<<ep,eg=Math.floor(F.x),ey=F.x-eg,eb=new uu(ep,eg,ep,Math.floor(ey*e_),Math.floor(F.y*e_)),ew=this.findDEMTileFor(eb);if(!ew||!ew.dem)return el;let eT=ew.dem,eS=1<<ew.tileID.canonical.z,eE=(ey*eS-ew.tileID.canonical.x)*eT.dim,eM=(F.y*eS-ew.tileID.canonical.y)*eT.dim,eI=Math.floor(eE),eA=Math.floor(eM);return(eh?this.exaggeration():1)*Ee(Ee(eT.get(eI,eA),eT.get(eI,eA+1),eM-eA),Ee(eT.get(eI+1,eA),eT.get(eI+1,eA+1),eM-eA),eE-eI)}getAtTileOffset(F,el,eh){let ec=1<<F.canonical.z;return this.getAtPointOrZero(new Il(F.wrap+(F.canonical.x+el/8192)/ec,(F.canonical.y+eh/8192)/ec))}getAtTileOffsetFunc(F,el,eh,ec){return ep=>{let e_=this.getAtTileOffset(F,ep.x,ep.y),eg=ec.upVector(F.canonical,ep.x,ep.y),ey=ec.upVectorScale(F.canonical,el,eh).metersToTile;return tN.vec3.scale(eg,eg,e_*ey),eg}}getForTilePoints(F,el,eh,ec){if(this.isUsingMockSource())return!1;let ep=Fy.create(this,F,ec);return!!ep&&(el.forEach(F=>{F[2]=this.exaggeration()*ep.getElevationAt(F[0],F[1],eh)}),!0)}getMinMaxForTile(F){if(this.isUsingMockSource())return null;let el=this.findDEMTileFor(F);if(!el||!el.dem)return null;let eh=el.dem.tree,ec=el.tileID,ep=1<<F.canonical.z-ec.canonical.z,e_=F.canonical.x/ep-ec.canonical.x,eg=F.canonical.y/ep-ec.canonical.y,ey=0;for(let el=0;el<F.canonical.z-ec.canonical.z&&!eh.leaves[ey];el++){e_*=2,eg*=2;let F=2*Math.floor(eg)+Math.floor(e_);ey=eh.childOffsets[ey]+F,e_%=1,eg%=1}return{min:this.exaggeration()*eh.minimums[ey],max:this.exaggeration()*eh.maximums[ey]}}getMinElevationBelowMSL(){throw Error("Pure virtual method called.")}raycast(F,el,eh){throw Error("Pure virtual method called.")}pointCoordinate(F){throw Error("Pure virtual method called.")}_source(){throw Error("Pure virtual method called.")}isUsingMockSource(){throw Error("Pure virtual method called.")}exaggeration(){throw Error("Pure virtual method called.")}findDEMTileFor(F){throw Error("Pure virtual method called.")}get visibleDemTiles(){throw Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){let F=this.visibleDemTiles;if(0===F.length)return null;let el=!1,eh=Number.MAX_VALUE,ec=Number.MIN_VALUE;for(let ep of F){let F=this.getMinMaxForTile(ep.tileID);F&&(eh=Math.min(eh,F.min),ec=Math.max(ec,F.max),el=!0)}return el?{min:eh,max:ec}:null}},F.cL=fc,F.cM=Iu,F.cN=function(F,el){return[Math.pow(F[0],2.2)*el,Math.pow(F[1],2.2)*el,Math.pow(F[2],2.2)*el]},F.cO=ju,F.cP=Mt,F.cQ=wt,F.cR=256,F.cS=function(F,el){let eh=[0,0,0],ec=Ou(ku(el.canonical));return tN.vec3.transformMat4(eh,eh,ec),tN.vec3.transformMat4(eh,eh,F),eh},F.cT=F=>({u_camera_to_center_distance:new Eo(F),u_extrude_scale:new Lo(F),u_device_pixel_ratio:new Eo(F),u_matrix:new Co(F),u_inv_rot_matrix:new Co(F),u_merc_center:new zo(F),u_tile_id:new ko(F),u_zoom_transition:new Eo(F),u_up_dir:new ko(F),u_emissive_strength:new Eo(F)}),F.cU=F=>({u_matrix:new Co(F),u_pixels_to_tile_units:new Lo(F),u_device_pixel_ratio:new Eo(F),u_width_scale:new Eo(F),u_floor_width_scale:new Eo(F),u_units_to_pixels:new zo(F),u_dash_image:new Po(F),u_gradient_image:new Po(F),u_image_height:new Eo(F),u_texsize:new zo(F),u_tile_units_to_pixels:new Eo(F),u_alpha_discard_threshold:new Eo(F),u_trim_offset:new zo(F),u_trim_fade_range:new zo(F),u_trim_color:new To(F),u_emissive_strength:new Eo(F),u_zbias_factor:new Eo(F),u_tile_to_meter:new Eo(F)}),F.cV=F=>({u_matrix:new Co(F),u_texsize:new zo(F),u_pixels_to_tile_units:new Lo(F),u_device_pixel_ratio:new Eo(F),u_width_scale:new Eo(F),u_floor_width_scale:new Eo(F),u_image:new Po(F),u_units_to_pixels:new zo(F),u_tile_units_to_pixels:new Eo(F),u_alpha_discard_threshold:new Eo(F),u_trim_offset:new zo(F),u_trim_fade_range:new zo(F),u_trim_color:new To(F),u_emissive_strength:new Eo(F),u_zbias_factor:new Eo(F),u_tile_to_meter:new Eo(F)}),F.cW=Na,F.cX=a1,F.cY=a2,F.cZ=Ku,F.c_=(F,el,eh,ec,ep,e_)=>{let eg;let ey=F.transform,eb="globe"===ey.projection.name;if("map"===e_.paint.get("circle-pitch-alignment")){if(eb){let F=ju(ey.zoom,el.canonical)*ey._pixelsPerMercatorPixel;eg=Float32Array.from([F,0,0,F])}else eg=ey.calculatePixelsToTileUnitsMatrix(eh)}else eg=new Float32Array([ey.pixelsToGLUnits[0],0,0,ey.pixelsToGLUnits[1]]);let ew={u_camera_to_center_distance:F.transform.getCameraToCenterDistance(ey.projection),u_matrix:F.translatePosMatrix(el.projMatrix,eh,e_.paint.get("circle-translate"),e_.paint.get("circle-translate-anchor")),u_device_pixel_ratio:tX.devicePixelRatio,u_extrude_scale:eg,u_inv_rot_matrix:r1,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:e_.paint.get("circle-emissive-strength")};if(eb){ew.u_inv_rot_matrix=ec,ew.u_merc_center=ep,ew.u_tile_id=[el.canonical.x,el.canonical.y,1<<el.canonical.z],ew.u_zoom_transition=$u(ey.zoom);let F=8192*ep[0],eh=8192*ep[1];ew.u_up_dir=ey.projection.upVector(new ou(0,0,0),F,eh)}return ew},F.ca=fl,F.cb=To,F.cc=function(F,el,eh){let ec=Math.sqrt(F*F+el*el+eh*eh),ep=ec>0?Math.acos(eh/ec)*tG:0,e_=0!==F||0!==el?Math.atan2(-el,-F)*tG+90:0;return e_<0&&(e_+=360),[ec,e_,ep]},F.cd=Al,F.ce=Au,F.cf=mt,F.cg=function(F){return[Math.pow(F[0],1/2.2),Math.pow(F[1],1/2.2),Math.pow(F[2],1/2.2)]},F.ch=function(F,el){return F.readFields(dg,{icons:[]},el)},F.ci=function(F){return F({pluginStatus:rf,pluginURL:rm}),r_.on("pluginStateChange",F),F},F.cj=ag,F.ck=bd,F.cl=nu,F.cm=t7,F.cn=ks,F.co=Rt,F.cp=iv,F.cq=ct,F.cr=function(F){let el=F.indexOf("\x1f");return el>=0?F.slice(0,el):F},F.cs=function(F){return F.indexOf("\x1f")>=0},F.ct=function(F){let el=F.indexOf("\x1f");return el>=0?F.slice(el+1):""},F.cu=function(F){let el=[],eh=F.id;return void 0===eh&&el.push({message:`layers.${eh}: missing required property "id"`}),void 0===F.render&&el.push({message:`layers.${eh}: missing required method "render"`}),F.renderingMode&&"2d"!==F.renderingMode&&"3d"!==F.renderingMode&&el.push({message:`layers.${eh}: property "renderingMode" must be either "2d" or "3d"`}),el},F.cv=function(F,el,eh,ec){return"custom"===F.type?new ny(F,el):new nV[F.type](F,el,eh,ec)},F.cw=ut,F.cx=class extends Ov{constructor(F,el){super(F._vectorTileFeature,F._z,F._x,F._y,F.id),F.state&&(this.state=Object.assign({},F.state)),this.target=el.target,this.namespace=el.namespace,el.properties&&(this.properties=el.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=F.source,this.sourceLayer=F.sourceLayer,this.layer=F.layer)}toJSON(){let F=super.toJSON();return F.target=this.target,F.namespace=this.namespace,F}},F.cy=r_,F.cz=re,F.d=function(F){return tY.API_TILEJSON_REGEX.test(F)},F.d$=Lv,F.d0=er,F.d1=(F,el,eh,ec,ep,e_,eg,ey)=>{let eb=F.transform,ew=eb.pitch<15?Kp(.07,.7,Q((14-eb.zoom)/5,0,1)):.07,eT="none"===eh.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:Qp(F,el,eh,ec),u_texsize:el.imageAtlasTexture?el.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:eb.calculatePixelsToTileUnitsMatrix(el),u_device_pixel_ratio:ep,u_width_scale:e_,u_floor_width_scale:eg,u_image:0,u_tile_units_to_pixels:Jp(el,eb),u_units_to_pixels:[1/eb.pixelsToGLUnits[0],1/eb.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:ey,u_trim_fade_range:eh.paint.get("line-trim-fade-range"),u_trim_color:eh.paint.get("line-trim-color").toRenderColor(eT?null:eh.lut).toArray01(),u_emissive_strength:eh.paint.get("line-emissive-strength"),u_zbias_factor:ew,u_tile_to_meter:Al(el.tileID.canonical,0)}},F.d2=(F,el,eh,ec,ep,e_,eg,ey,eb)=>{let ew=F.transform,eT=ew.calculatePixelsToTileUnitsMatrix(el),eS="none"===eh.paint.get("line-trim-color-use-theme").constantOr("default"),eE=ew.pitch<15?Kp(.07,.7,Q((14-ew.zoom)/5,0,1)):.07;return{u_matrix:Qp(F,el,eh,ec),u_pixels_to_tile_units:eT,u_device_pixel_ratio:e_,u_width_scale:eg,u_floor_width_scale:ey,u_units_to_pixels:[1/ew.pixelsToGLUnits[0],1/ew.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:ep,u_texsize:ef(eh)&&el.lineAtlasTexture?el.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:Jp(el,F.transform),u_alpha_discard_threshold:0,u_trim_offset:eb,u_trim_fade_range:eh.paint.get("line-trim-fade-range"),u_trim_color:eh.paint.get("line-trim-color").toRenderColor(eS?null:eh.lut).toArray01(),u_emissive_strength:eh.paint.get("line-emissive-strength"),u_zbias_factor:eE,u_tile_to_meter:Al(el.tileID.canonical,0)}},F.d3=at,F.d4=dc,F.d5=vl,F.d6=Pp,F.d7=r$,F.d8=vp,F.d9=2147483648,F.dA=aP,F.dB=K,F.dC=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},F.dD=t$,F.dE=Ml,F.dF=al,F.dG=function([F,el,eh]){let ec=Math.hypot(F,el,eh),ep=Math.atan2(F,eh),e_=.5*Math.PI-Math.acos(-el/ec);return new ul(ep*tG,e_*tG)},F.dH=uy,F.dI=function(F){let el=F.navigator?F.navigator.userAgent:null;return!!function(F){if(null==tW){let el=F.navigator?F.navigator.userAgent:null;tW=!!F.safari||!(!el||!(/\b(iPad|iPhone|iPod)\b/.test(el)||el.match("Safari")&&!el.match("Chrome")))}return tW}(F)&&el&&(el.match("Version/15.4")||el.match("Version/15.5")||el.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},F.dJ=function(F,el){tJ=F,tQ=el},F.dK=Yu,F.dL=Gu,F.dM=function(F){let el=[0,0,0],eh=tN.mat4.identity(new Float64Array(16));return tN.mat4.multiply(eh,F.pixelMatrix,F.globeMatrix),tN.vec3.transformMat4(el,el,eh),new tU(el[0],el[1])},F.dN=function(F,el,eh=!1){if(rf===rh||rf===ru||rf===rc)throw Error("setRTLTextPlugin cannot be called multiple times.");rm=tX.resolveURL(F),rf=rh,rp=el,Ts(),eh||Cs()},F.dO=Vs,F.dP=function(){ag().acquire(nj)},F.dQ=function(){let F=e0;F&&(F.isPreloaded()&&1===F.numActive()?(F.release(nj),e0=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},F.dR=rg,F.dS=function(F){let el=qt();if(!el)return;let eh=el.delete(tK);F&&eh.catch(F).then(()=>F())},F.dT=nU,F.dU=cv,F.dV=function(F){oE=tX.resolveURL(F),oC||(oC=new ng(ag(),new _e)),oC.broadcast("setDracoUrl",oE)},F.dW=hv,F.dX=function(F){oI=tX.resolveURL(F),oC||(oC=new ng(ag(),new _e)),oC.broadcast("setMeshoptUrl",oI)},F.dY=us,F.dZ=hc,F.d_=2,F.da=450,F.db=7,F.dc=.0038760859073359074,F.dd=va,F.de=to,F.df=256,F.dg=Nu,F.dh=za,F.di=Ga,F.dj=Ya,F.dk=function(F,el,eh,ec,ep){return Q((F-el)/(eh-el)*(ep-ec)+ec,ec,ep)},F.dl=Ei,F.dm=wl,F.dn=class{constructor(F,el,eh,ec){this.context=F,this.format=ec,this.size=eh,this.texture=F.gl.createTexture();let[ep,e_,eg]=this.size,{gl:ey}=F;ey.bindTexture(ey.TEXTURE_3D,this.texture),F.pixelStoreUnpackFlipY.set(!1),F.pixelStoreUnpack.set(1),F.pixelStoreUnpackPremultiplyAlpha.set(!1),ey.texImage3D(ey.TEXTURE_3D,0,this.format,ep,e_,eg,0,Um(this.format),jm(this.format),el.data)}bind(F,el){let{context:eh}=this,{gl:ec}=eh;ec.bindTexture(ec.TEXTURE_3D,this.texture),F!==this.minFilter&&(ec.texParameteri(ec.TEXTURE_3D,ec.TEXTURE_MAG_FILTER,F),ec.texParameteri(ec.TEXTURE_3D,ec.TEXTURE_MIN_FILTER,F),this.minFilter=F),el!==this.wrapS&&(ec.texParameteri(ec.TEXTURE_3D,ec.TEXTURE_WRAP_S,el),ec.texParameteri(ec.TEXTURE_3D,ec.TEXTURE_WRAP_T,el),this.wrapS=el)}destroy(){let{gl:F}=this.context;F.deleteTexture(this.texture),this.texture=null}},F.dp=fy,F.dq=[1,1,1],F.dr=Fy,F.ds=nk,F.dt=La,F.du=Za,F.dv=6371008.8,F.dw=Xa,F.dx=Ha,F.dy=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new tU(1/0,1/0),max:new tU(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(F,el=!1){let eh=Hh(new tU(0,0),new tU(8192,8192),F),ec=[];if(el&&!Gh(eh,this._globalClipBounds))return ec;for(let el of this._activeRegions){if(el.hiddenByOverlap||!Gh(eh,el))continue;let ep=function(F,el,eh){let ec=1<<eh.canonical.z,ep=((el.x-eh.wrap)*ec-eh.canonical.x)*8192,e_=(el.y*ec-eh.canonical.y)*8192;return{min:new tU(((F.x-eh.wrap)*ec-eh.canonical.x)*8192,(F.y*ec-eh.canonical.y)*8192),max:new tU(ep,e_)}}(el.min,el.max,F);ec.push({min:ep.min,max:ep.max,sourceId:this._sourceIds[el.priority],footprint:el.footprint,footprintTileId:el.tileId,order:el.order,clipMask:el.clipMask,clipScope:el.clipScope})}return ec}setSources(F){this._setSources(F.map(F=>({getSourceId:()=>F.cache.id,getFootprints:()=>{let el=[];for(let eh of F.cache.getVisibleCoordinates()){let ec=F.cache.getTile(eh).buckets[F.layer];ec&&ec.updateFootprints(eh.toUnwrapped(),el)}return el},getOrder:()=>F.order,getClipMask:()=>F.clipMask,getClipScope:()=>F.clipScope})))}_addSource(F){let el=F.getFootprints();if(0===el.length)return;let eh=F.getOrder(),ec=F.getClipMask(),ep=F.getClipScope();for(let F of el){if(!F.footprint)continue;let el=Hh(F.footprint.min,F.footprint.max,F.id);this._activeRegions.push({min:el.min,max:el.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:F.id,footprint:F.footprint,order:eh,clipMask:ec,clipScope:ep})}this._sourceIds.push(F.getSourceId())}_computeReplacement(){this._activeRegions.sort((F,el)=>F.priority-el.priority||qh(F.min,el.min)||qh(F.max,el.max)||F.order-el.order||F.clipMask-el.clipMask||function(F,el){let r=(F,el)=>F+el;return F.length-el.length||F.reduce(r,"").localeCompare(el.reduce(r,""))}(F.clipScope,el.clipScope));let F=this._activeRegions.length!==this._prevRegions.length;if(!F){let el=0;for(;!F&&el!==this._activeRegions.length;){let eh=this._activeRegions[el],ec=this._prevRegions[el];F=eh.priority!==ec.priority||!$h(eh,ec)||eh.order!==ec.order||eh.clipMask!==ec.clipMask||!$(eh.clipScope,ec.clipScope),++el}}if(F){for(let F of(++this._updateTime,this._activeRegions))F.order!==aP&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,F.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,F.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,F.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,F.max.y));let t=F=>{let el=this._activeRegions;if(F>=el.length)return F;let eh=el[F].priority;for(;F<el.length&&el[F].priority===eh;)++F;return F};if(this._sourceIds.length>1){let F=0,el=t(0);for(;F!==el;){let eh=F,ec=F;for(;eh!==el;){let F=this._activeRegions[eh];F.hiddenByOverlap=!1;for(let el=0;el<ec;el++){let eh=this._activeRegions[el];if(!eh.hiddenByOverlap&&F.order===aP&&Gh(F,eh)&&(F.hiddenByOverlap=function Wh(F,el,eh,ec){if(!F||!eh)return!1;let ep=F.vertices;if(!el.canonical.equals(ec.canonical)||el.wrap!==ec.wrap){if(eh.vertices.length<F.vertices.length)return Wh(eh,ec,F,el);let e_=el.canonical,eg=ec.canonical,ey=Math.pow(2,eg.z-e_.z);ep=F.vertices.map(F=>new tU((F.x+8192*e_.x)*ey-8192*eg.x,(F.y+8192*e_.y)*ey-8192*eg.y))}return Zh(eh,ep,F.indices,0,F.indices.length,0,0)}(F.footprint,F.tileId,eh.footprint,eh.tileId),F.hiddenByOverlap))break}++eh}el=t(F=el)}}}}_setSources(F){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let el=F.length-1;el>=0;el--)this._addSource(F[el]);this._computeReplacement()}},F.dz=class{constructor(F){this._createGrid(F),this._createPoles(F)}destroy(){for(let F of(this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy(),this._poleSegments))F.destroy();for(let F of this._gridSegments)F.withSkirts.destroy(),F.withoutSkirts.destroy()}_fillGridMeshWithLods(F,el){let eh=new _a,ec=new ja,ep=[],e_=F+1+2,eg=el[0]+1,ey=el[0]+1+(1+el.length),l=(F,el,eh)=>{let ec=F===e_-1?F-2:0===F?F:F-1;return[ec+=eh?24575:0,el]};for(let F=0;F<e_;++F)eh.emplaceBack(...l(F,0,!0));for(let F=0;F<eg;++F)for(let el=0;el<e_;++el)eh.emplaceBack(...l(el,F,0===el||el===e_-1));for(let F=0;F<el.length;++F){let ec=el[F];for(let F=0;F<e_;++F)eh.emplaceBack(...l(F,ec,!0))}for(let F=0;F<el.length;++F){let eg=ec.length,eb=el[F]+1+2,ew=new ja;for(let eh=0;eh<eb-1;eh++){let ep=eh===eb-2,eg=ep?e_*(ey-el.length+F-eh):e_;for(let F=0;F<e_-1;F++){let el=eh*e_+F;0===eh||ep||0===F||F===e_-2?(ew.emplaceBack(el+1,el,el+eg),ew.emplaceBack(el+eg,el+eg+1,el+1)):(ec.emplaceBack(el+1,el,el+eg),ec.emplaceBack(el+eg,el+eg+1,el+1))}}let eT=xo.simpleSegment(0,eg,eh.length,ec.length-eg);for(let F=0;F<ew.uint16.length;F+=3)ec.emplaceBack(ew.uint16[F],ew.uint16[F+1],ew.uint16[F+2]);let eS=xo.simpleSegment(0,eg,eh.length,ec.length-eg);ep.push({withoutSkirts:eT,withSkirts:eS})}return{vertices:eh,indices:ec,segments:ep}}_createGrid(F){let el=this._fillGridMeshWithLods(64,rB);this._gridSegments=el.segments,this._gridBuffer=F.createVertexBuffer(el.vertices,rY.members),this._gridIndexBuffer=F.createIndexBuffer(el.indices,!0)}_createPoles(F){let el=new ja;for(let F=0;F<=64;F++)el.emplaceBack(0,F+1,F+2);this._poleIndexBuffer=F.createIndexBuffer(el,!0);let eh=new Ga,ec=new Ga,ep=new Ga,e_=new Ga;this._poleSegments=[];for(let F=0,el=0;F<5;F++){let eg=360/(1<<F);eh.emplaceBack(0,-rF,0,.5,0),ec.emplaceBack(0,-rF,0,.5,1),ep.emplaceBack(0,-rF,0,.5,.5),e_.emplaceBack(0,-rF,0,.5,.5);for(let F=0;F<=64;F++){let el=F/64,ey=0,eb=Ee(0,eg,el),[ew,eT,eS]=sl(rQ,r0,eb,rF);eh.emplaceBack(ew,eT,eS,el,ey),ec.emplaceBack(ew,eT,eS,el,1-ey);let eE=eb*tj;el=.5+.5*Math.sin(eE),ey=.5+.5*Math.cos(eE),ep.emplaceBack(ew,eT,eS,el,ey),e_.emplaceBack(ew,eT,eS,el,1-ey)}this._poleSegments.push(xo.simpleSegment(el,0,66,64)),el+=66}this._poleNorthVertexBuffer=F.createVertexBuffer(eh,rZ,!1),this._poleSouthVertexBuffer=F.createVertexBuffer(ec,rZ,!1),this._texturedPoleNorthVertexBuffer=F.createVertexBuffer(ep,rZ,!1),this._texturedPoleSouthVertexBuffer=F.createVertexBuffer(e_,rZ,!1)}getGridBuffers(F,el){return[this._gridBuffer,this._gridIndexBuffer,el?this._gridSegments[F].withSkirts:this._gridSegments[F].withoutSkirts]}getPoleBuffers(F,el){return[el?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,el?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[F]]}},F.e=tY,F.e0=Nv,F.e1=jp,F.e2=a_,F.e3="hd_road_elevation",F.e4=class{static parseFrom(F,el){let eh=fh.parse(F);if(!eh)return[];let{vertices:ec,features:ep}=eh,e_=1/Al(el);ep.sort((F,el)=>F.id-el.id),ec.sort((F,el)=>F.id-el.id||F.idx-el.idx),ec=ec.filter((F,el,eh)=>el===eh.findIndex(el=>el.id===F.id&&el.idx===F.idx));let eg=[],ey=0,eb=ec.length;for(let F of ep){if(F.constantHeight){eg.push(new dh(F.id,F.bounds,F.constantHeight));continue}for(;ey!==eb&&ec[ey].id<F.id;)ey++;if(ey===eb||ec[ey].id!==F.id)continue;let el=[],eh=[],ep=ey;for(;ey!==eb&&ec[ey].id===F.id;){let F=ec[ey];if(el.push({position:F.position,height:F.height,extent:F.extent}),ey!==ep&&ec[ey-1].idx===F.idx-1){let F=ey-ep;eh.push({a:F-1,b:F})}ey++}eg.push(new dh(F.id,F.bounds,void 0,el,eh,e_))}return eg}},F.e5=lt,F.e6=gh,F.e7=fd,F.e8=1,F.e9=function(F,el,eh,ec,ep,e_,eg,ey=1,eb){F.createArrays(),F.tilePixelRatio=8192/(512*F.overscaling),F.compareText={},F.iconsNeedLinear=!1;let ew=F.layers[0].layout,eT=F.layers[0]._unevaluatedLayout._values,eS={};eS.scaleFactor=ey,eS.textSizeScaleRange=ew.get("text-size-scale-range"),eS.iconSizeScaleRange=ew.get("icon-size-scale-range");let[eE,eM]=eS.textSizeScaleRange,[eI,eA]=eS.iconSizeScaleRange;eS.textScaleFactor=Q(eS.scaleFactor,eE,eM),eS.iconScaleFactor=Q(eS.scaleFactor,eI,eA);let eC=eT["text-size"],eP=eT["icon-size"];if("composite"===F.textSizeData.kind){let{minZoom:el,maxZoom:eh}=F.textSizeData;eS.compositeTextSizes=[eC.possiblyEvaluate(new Rs(el),e_),eC.possiblyEvaluate(new Rs(eh),e_)]}if("composite"===F.iconSizeData.kind){let{minZoom:el,maxZoom:eh}=F.iconSizeData;eS.compositeIconSizes=[eP.possiblyEvaluate(new Rs(el),e_),eP.possiblyEvaluate(new Rs(eh),e_)]}eS.layoutTextSize=eC.possiblyEvaluate(new Rs(eg+1),e_),eS.layoutIconSize=eP.possiblyEvaluate(new Rs(eg+1),e_),eS.textMaxSize=eC.possiblyEvaluate(new Rs(18),e_);let ez=ew.get("symbol-placement"),eD="map"===ew.get("text-rotation-alignment")&&"point"!==ez,eR=ew.get("text-size"),eL=!1,eO=[];for(let eg of F.features){let ey=ew.get("text-font").evaluate(eg,{},e_).join(","),eE=eR.evaluate(eg,{},e_)*eS.textScaleFactor,eM=eS.layoutTextSize.evaluate(eg,{},e_)*eS.textScaleFactor,eI=eS.layoutIconSize.evaluate(eg,{},e_)*eS.iconScaleFactor,eA={horizontal:{},vertical:void 0},eC=eg.text,eP,ek=[0,0];if(eC){let ec=eC.toString(),eT=24*ew.get("text-letter-spacing").evaluate(eg,{},e_),eS=24*ew.get("text-line-height").evaluate(eg,{},e_),eI=!function(F){for(let eh of F){var el;if(el=eh.charCodeAt(0),ri.Arabic(el)||ri["Arabic Supplement"](el)||ri["Arabic Extended-A"](el)||ri["Arabic Presentation Forms-A"](el)||ri["Arabic Presentation Forms-B"](el))return!1}return!0}(ec)?0:eT,eP=ew.get("text-anchor").evaluate(eg,{},e_),eR=ew.get("text-variable-anchor");if(!eR){let F=ew.get("text-radial-offset").evaluate(eg,{},e_);ek=F?Cd(eP,[24*F,np]):ew.get("text-offset").evaluate(eg,{},e_).map(F=>24*F)}let eL=eD?"center":ew.get("text-justify").evaluate(eg,{},e_),eO="point"===ez,eF=eO?24*ew.get("text-max-width").evaluate(eg,{},e_):1/0,I=e_=>{F.allowVerticalPlacement&&ms(ec)&&(eA.vertical=qf(eC,el,eh,ep,ey,eF,eS,eP,e_,eI,ek,a7.vertical,!0,eM,eE,eb))};if(!eD&&eR){let F="auto"===eL?eR.map(F=>Nd(F)):[eL],ec=!1;for(let e_=0;e_<F.length;e_++){let eg=F[e_];if(!eA.horizontal[eg]){if(ec)eA.horizontal[eg]=eA.horizontal[0];else{let F=qf(eC,el,eh,ep,ey,eF,eS,"center",eg,eI,ek,a7.horizontal,!1,eM,eE,eb);F&&(eA.horizontal[eg]=F,ec=1===F.positionedLines.length)}}}I("left")}else{if("auto"===eL&&(eL=Nd(eP)),eO||ew.get("text-writing-mode").indexOf("horizontal")>=0||!ms(ec)){let F=qf(eC,el,eh,ep,ey,eF,eS,eP,eL,eI,ek,a7.horizontal,!1,eM,eE,eb);F&&(eA.horizontal[eL]=F)}I(eO?"left":eL)}}let eF,eB,eN,eV,eU,ej=!1;if(eg.icon&&eg.icon.hasPrimary()){let el=Rd(eg.icon,F.iconSizeData,eT["icon-size"],e_,F.zoom,eg,eb,eS.iconScaleFactor);eF=el.iconPrimary,eB=el.iconSecondary;let eh=eF.toString(),ey=ec.get(eh);ey&&(eN=ew.get("icon-offset").evaluate(eg,{},e_),eV=ew.get("icon-anchor").evaluate(eg,{},e_),eU=ew.get("icon-text-fit").evaluate(eg,{},e_),eP=function(F,el,eh,ec){let{horizontalAlign:ep,verticalAlign:e_}=Kf(ec),eg=eh[0]-F.displaySize[0]*ep,ey=eh[1]-F.displaySize[1]*e_;return{imagePrimary:F,imageSecondary:el,top:ey,bottom:ey+F.displaySize[1],left:eg,right:eg+F.displaySize[0]}}(ep.get(eh),eB?ep.get(eB.toString()):void 0,eN,eV),ej=ey.sdf,void 0===F.sdfIcons?F.sdfIcons=ey.sdf:F.sdfIcons!==ey.sdf&&pt("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(ey.pixelRatio!==F.pixelRatio||0!==ew.get("icon-rotate").constantOr(1))&&(F.iconsNeedLinear=!0))}eL=eL||!(!eg.icon||!eg.icon.hasSecondary());let eG=Yd(eA.horizontal)||eA.vertical;F.iconsInText||(F.iconsInText=!!eG&&eG.iconsInText);let eq=eM*eS.textScaleFactor/24,{defaultShapedIcon:e$,verticallyShapedIcon:eH}=function(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=Yd(e_.horizontal)||e_.vertical,eT=eh.get("icon-text-fit-padding").evaluate(ec,{},ep),eS,eE=el;return el&&"none"!==eb&&(F.allowVerticalPlacement&&e_.vertical&&(eS=td(el,e_.vertical,eb,eT,ey,eg)),ew&&(eE=td(el,ew,eb,eT,ey,eg))),{defaultShapedIcon:eE,verticallyShapedIcon:eS}}(F,eP,ew,eg,e_,eA,eq,eN,eU);eP=e$,eO.push({feature:eg,shapedTextOrientations:eA,shapedText:eG,shapedIcon:eP,iconPrimary:eF,iconSecondary:eB,iconOffset:eN,iconAnchor:eV,verticallyShapedIcon:eH,layoutTextSize:eM,layoutIconSize:eI,textOffset:ek,isSDFIcon:ej,iconTextFit:eU})}return{featureData:eO,sizes:eS,hasAnySecondaryIcon:eL,textAlongLine:eD,symbolPlacement:ez}},F.ea=dd,F.eb=function(F,el,eh,ec,ep,e_,eg,ey,eb,ew){let{featureData:eT,hasAnySecondaryIcon:eS,sizes:eE,textAlongLine:eM,symbolPlacement:eI}=el;for(let el of eT){let{shapedIcon:eh,verticallyShapedIcon:e_,feature:eT,shapedTextOrientations:eA,shapedText:eC,layoutTextSize:eP,textOffset:ez,isSDFIcon:eD,iconPrimary:eR,iconSecondary:eL,iconTextFit:eO,iconOffset:ek}=el;Ld(eh,ew.iconPositions,eR,eL),Ld(e_,ew.iconPositions,eR,eL),function(F,el){for(let eh in F.horizontal)Od(F.horizontal[eh],el);Od(F.vertical,el)}(eA,ew.iconPositions),(eC||eh)&&function(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD){var eR;let eL=eg.textMaxSize.evaluate(el,{},eE);void 0===eL?eL=ey*eg.textScaleFactor:eL*=eg.textScaleFactor;let eO=F.layers[0].layout,ek=Yd(eh.horizontal)||eh.vertical,eF="globe"===eM.name,eB=F.tilePixelRatio*eL/24,eN=(eR=F.overscaling,F.zoom>18&&eR>2&&(eR>>=1),Math.max(8192/(512*eR),1)*eO.get("symbol-spacing")),eV=eO.get("text-padding")*F.tilePixelRatio,eU=eO.get("icon-padding")*F.tilePixelRatio,ej=eO.get("text-max-angle")*tj,eG="map"===eO.get("icon-rotation-alignment")&&"point"!==eD,eq=eN/2;!1===F.hasAnyIconTextFit&&"none"!==eC&&(F.hasAnyIconTextFit=!0);let e$=el.properties?+el.properties[a_]:null,eH=e$&&F.elevationFeatureIdToIndex?F.elevationFeatureIdToIndex.get(e$):65535,D=(ey,eb,eD)=>{if(eb.x<0||eb.x>=8192||eb.y<0||eb.y>=8192)return;let eR=null;if(eF){let{x:F,y:el,z:eh}=eM.projectTilePoint(eb.x,eb.y,eD);eR={anchor:new ed(F,el,eh,0,void 0),up:eM.upVector(eD,eb.x,eb.y)}}!function(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO,ek,eF,eB,eN,eV,eU){let ej=F.addToLineVertexArray(el,ec),eG,eq,e$,eH,eZ,eW,eY,eX=0,eK=0,eJ=0,eQ=0,e0=-1,e1=-1,e2={},e3=iv(""),e4=eh?eh.anchor:el,e5="none"!==eV,e6=0,e8=0;if(void 0===eb._unevaluatedLayout.getValue("text-radial-offset")?[e6,e8]=eb.layout.get("text-offset").evaluate(eR,{},eF).map(F=>24*F):(e6=24*eb.layout.get("text-radial-offset").evaluate(eR,{},eF),e8=np),F.allowVerticalPlacement&&ep.vertical){let F=ep.vertical;if(eI)eW=Xd(F),ey&&(eY=Xd(ey));else{let eh=eb.layout.get("text-rotate").evaluate(eR,{},eF)+90;e$=Hd(ew,e4,el,eT,eS,eE,F,eM,eh,eA),ey&&(eH=Hd(ew,e4,el,eT,eS,eE,ey,eP,eh))}}if(e_){let ec=F.iconSizeData,ep=eb.layout.get("icon-rotate").evaluate(eR,{},eF),eg=Md(e_,ep,eO,e5,eL.iconScaleFactor),eM=ey?Md(ey,ep,eO,e5,eL.iconScaleFactor):void 0;eq=Hd(ew,e4,el,eT,eS,eE,e_,eP,ep,null),eX=4*eg.length;let eI=null;"source"===ec.kind?(eI=[128*eb.layout.get("icon-size").evaluate(eR,{},eF)*eL.iconScaleFactor])[0]>32640&&pt(`${F.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`):"composite"===ec.kind&&((eI=[128*eL.compositeIconSizes[0].evaluate(eR,{},eF)*eL.iconScaleFactor,128*eL.compositeIconSizes[1].evaluate(eR,{},eF)*eL.iconScaleFactor])[0]>32640||eI[1]>32640)&&pt(`${F.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`),F.addSymbols(F.icon,eg,eI,eD,ez,eR,!1,eh,el,ej.lineStartIndex,ej.lineLength,-1,ek,eF,eB,eN),e0=F.icon.placedSymbolArray.length-1,eM&&(eK=4*eM.length,F.addSymbols(F.icon,eM,eI,eD,ez,eR,a7.vertical,eh,el,ej.lineStartIndex,ej.lineLength,-1,ek,eF,eB,eN),e1=F.icon.placedSymbolArray.length-1)}for(let ec in ep.horizontal){let e_=ep.horizontal[ec];eG||(e3=iv(e_.text),eI?eZ=Xd(e_):eG=Hd(ew,e4,el,eT,eS,eE,e_,eM,eb.layout.get("text-rotate").evaluate(eR,{},eF),eA));let ey=1===e_.positionedLines.length;if(eJ+=Gd(F,eh,el,e_,eg,eb,eI,eR,eA,ej,ep.vertical?a7.horizontal:a7.horizontalOnly,ey?Object.keys(ep.horizontal):[ec],e2,e0,eL,ek,eF,eB),ey)break}ep.vertical&&(eQ+=Gd(F,eh,el,ep.vertical,eg,eb,eI,eR,eA,ej,a7.vertical,["vertical"],e2,e1,eL,ek,eF,eB));let e9=-1,W=(F,el)=>F?Math.max(F,el):el;e9=W(eZ,e9),e9=W(eW,e9),e9=W(eY,e9);let e7=e9>-1?1:0;F.glyphOffsetArray.length>=65535&&pt("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==eR.sortKey&&F.addToSortKeyRanges(F.symbolInstances.length,eR.sortKey),F.symbolInstances.emplaceBack(el.x,el.y,e4.x,e4.y,e4.z,e2.right>=0?e2.right:-1,e2.center>=0?e2.center:-1,e2.left>=0?e2.left:-1,e2.vertical>=0?e2.vertical:-1,e0,e1,e3,void 0!==eG?eG:F.collisionBoxArray.length,void 0!==eG?eG+1:F.collisionBoxArray.length,void 0!==e$?e$:F.collisionBoxArray.length,void 0!==e$?e$+1:F.collisionBoxArray.length,void 0!==eq?eq:F.collisionBoxArray.length,void 0!==eq?eq+1:F.collisionBoxArray.length,eH||F.collisionBoxArray.length,eH?eH+1:F.collisionBoxArray.length,eT,eJ,eQ,eX,eK,e7,0,e6,e8,e9,0,e5?1:0,eU)}(F,eb,eR,ey,eh,ec,e_,ep,F.layers[0],F.collisionBoxArray,el.index,el.sourceLayerIndex,F.index,eV,ez,ew,0,eU,eG,eP,el,eg,eT,eS,eE,eI,eA,eC,eH)};if("line"===eD)for(let ep of ud(el.geometry,0,0,8192,8192)){let el=function(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=ec?.6*e_*eg:0,eT=sd(ec,ep),eS=eT*eg,eE=0===F[0].x||F[0].x===eb||0===F[0].y||F[0].y===eb;return el-eS<el/4&&(el=eS+el/4),function ld(F,el,eh,ec,ep,e_,eg,ey,eb){let ew=e_/2,eT=nd(F),eS=0,eE=el-eh,eM=[];for(let el=0;el<F.length-1;el++){let eg=F[el],ey=F[el+1],eI=eg.dist(ey),eA=ey.angleTo(eg);for(;eE+eh<eS+eI;){eE+=eh;let eC=(eE-eS)/eI,eP=Ee(eg.x,ey.x,eC),ez=Ee(eg.y,ey.y,eC);if(eP>=0&&eP<eb&&ez>=0&&ez<eb&&eE-ew>=0&&eE+ew<=eT){let eh=new ed(eP,ez,0,eA,el);ec&&!rd(F,eh,e_,ec,ep)||eM.push(eh)}}eS+=eI}return ey||eM.length||eg||(eM=ld(F,eS/2,eh,ec,ep,e_,eg,!0,eb)),eM}(F,eE?el/2*ey%el:(eT/2+2*e_)*eg*ey%el,el,ew,eh,eS,eE,!1,eb)}(ep,eN,ej,eh.vertical||ek,ec,24,eB,F.overscaling,8192);for(let eh of el)ek&&function(F,el,eh,ec){let ep=F.compareText;if(el in ep){let F=ep[el];for(let el=F.length-1;el>=0;el--)if(ec.dist(F[el])<eh)return!0}else ep[el]=[];return ep[el].push(ec),!1}(F,ek.text,eq,eh)||D(ep,eh,eE)}else if("line-center"===eD){for(let F of el.geometry)if(F.length>1){let el=function(F,el,eh,ec,ep,e_){let eg=eh?14.399999999999999*e_:0,ey=sd(eh,ec)*e_,eb=0,ew=nd(F)/2;for(let eh=0;eh<F.length-1;eh++){let ec=F[eh],ep=F[eh+1],e_=ec.dist(ep);if(eb+e_>ew){let eT=(ew-eb)/e_,eS=Ee(ec.x,ep.x,eT),eE=Ee(ec.y,ep.y,eT),eM=new ed(eS,eE,0,ep.angleTo(ec),eh);return!eg||rd(F,eM,ey,eg,el)?eM:void 0}eb+=e_}}(F,ej,eh.vertical||ek,ec,0,eB);el&&D(F,el,eE)}}else if("Polygon"===el.type)for(let F of $c(el.geometry,0)){let el=function(F,el=1,eh=!1){let ec=1/0,ep=1/0,e_=-1/0,eg=-1/0,ey=F[0];for(let F=0;F<ey.length;F++){let el=ey[F];(!F||el.x<ec)&&(ec=el.x),(!F||el.y<ep)&&(ep=el.y),(!F||el.x>e_)&&(e_=el.x),(!F||el.y>eg)&&(eg=el.y)}let eb=Math.min(e_-ec,eg-ep),ew=eb/2,eT=new Wr([],kd);if(0===eb)return new tU(ec,ep);for(let el=ec;el<e_;el+=eb)for(let eh=ep;eh<eg;eh+=eb)eT.push(new Td(el+ew,eh+ew,ew,F));let eS=function(F){let el=0,eh=0,ec=0,ep=F[0];for(let F=0,e_=ep.length,eg=e_-1;F<e_;eg=F++){let e_=ep[F],ey=ep[eg],eb=e_.x*ey.y-ey.x*e_.y;eh+=(e_.x+ey.x)*eb,ec+=(e_.y+ey.y)*eb,el+=3*eb}return new Td(eh/el,ec/el,0,F)}(F),eE=eT.length;for(;eT.length;){let ec=eT.pop();(ec.d>eS.d||!eS.d)&&(eS=ec,eh&&console.log("found best %d after %d probes",Math.round(1e4*ec.d)/1e4,eE)),ec.max-eS.d<=el||(ew=ec.h/2,eT.push(new Td(ec.p.x-ew,ec.p.y-ew,ew,F)),eT.push(new Td(ec.p.x+ew,ec.p.y-ew,ew,F)),eT.push(new Td(ec.p.x-ew,ec.p.y+ew,ew,F)),eT.push(new Td(ec.p.x+ew,ec.p.y+ew,ew,F)),eE+=4)}return eh&&(console.log(`num probes: ${eE}`),console.log(`best distance: ${eS.d}`)),eS.p}(F,16);D(F[0],new ed(el.x,el.y,0,0,void 0),eE)}else if("LineString"===el.type)for(let F of el.geometry)D(F,new ed(F[0].x,F[0].y,0,0,void 0),eE);else if("Point"===el.type)for(let F of el.geometry)for(let el of F)D([el],new ed(el.x,el.y,0,0,void 0),eE)}(F,eT,eA,eh,e_,eb,eE,eP,0,ez,eD,ec,ep,eg,ey,eS,eO,ek,eM,eI)}eh&&F.generateCollisionDebugBuffers(e_,F.collisionBoxArray,eE.textScaleFactor)},F.ec=am,F.ed=hx,F.ee=j,F.ef=sh,F.eg=Vf,F.eh=e,F.ei=function(F){let el=0;if(1179937895!==new Uint32Array(F,0,1)[0]){let eh=new Uint32Array(F,0,7),[,,ec,ep,e_,eg]=eh;el=eh.byteLength+ep+e_+eg+e_,(ec!==F.byteLength||el>=F.byteLength)&&pt("Invalid b3dm header information.")}return Sv(F,el)},F.ej=function(F,el){let eh=Cv(F);for(let F of eh){for(let el of F.meshes)(function(F){F.heightmap=new Float32Array(4096),F.heightmap.fill(-1);let el=F.vertexArray.float32,eh=F.aabb.min[0]-1,ec=F.aabb.min[1]-1,ep=64/(F.aabb.max[0]-eh+2),e_=64/(F.aabb.max[1]-ec+2);for(let eg=0;eg<el.length;eg+=3){let ey=el[eg+2],eb=(el[eg+0]-eh)*ep|0,ew=(el[eg+1]-ec)*e_|0;ey>F.heightmap[64*ew+eb]&&(F.heightmap[64*ew+eb]=ey)}})(el);F.lights&&(F.lightMeshIndex=F.meshes.length,F.meshes.push(function(F,el){let eh={};eh.indexArray=new ja,eh.indexArray.reserve(4*F.length),eh.vertexArray=new za,eh.vertexArray.reserve(10*F.length),eh.colorArray=new Da,eh.vertexArray.reserve(10*F.length);let ec=0;for(let ep of F){let F=Math.min(10,Math.max(4,1.3*ep.height))*el,e_=[-ep.normal[1],ep.normal[0],0],eg=Math.min(.29,.1*ep.width/ep.depth),ey=ep.width-2*ep.depth*el*(eg+.01),eb=tN.vec3.scaleAndAdd([],ep.pos,e_,ey/2),ew=tN.vec3.scaleAndAdd([],ep.pos,e_,-ey/2),eT=[eb[0],eb[1],eb[2]+ep.height],eS=[ew[0],ew[1],ew[2]+ep.height],eE=tN.vec3.scaleAndAdd([],ep.normal,e_,eg);tN.vec3.scale(eE,eE,F);let eM=tN.vec3.scaleAndAdd([],ep.normal,e_,-eg);tN.vec3.scale(eM,eM,F),tN.vec3.add(eE,eb,eE),tN.vec3.add(eM,ew,eM),eb[2]+=.1,ew[2]+=.1,eh.vertexArray.emplaceBack(eE[0],eE[1],eE[2]),eh.vertexArray.emplaceBack(eM[0],eM[1],eM[2]),eh.vertexArray.emplaceBack(eb[0],eb[1],eb[2]),eh.vertexArray.emplaceBack(ew[0],ew[1],ew[2]),eh.vertexArray.emplaceBack(eT[0],eT[1],eT[2]),eh.vertexArray.emplaceBack(eS[0],eS[1],eS[2]),eh.vertexArray.emplaceBack(eb[0],eb[1],eb[2]),eh.vertexArray.emplaceBack(ew[0],ew[1],ew[2]),eh.vertexArray.emplaceBack(eE[0],eE[1],eE[2]),eh.vertexArray.emplaceBack(eM[0],eM[1],eM[2]);let eI=ey/F/2;eh.colorArray.emplaceBack(-eI-eg,-1,eI,.8),eh.colorArray.emplaceBack(eI+eg,-1,eI,.8),eh.colorArray.emplaceBack(-eI,0,eI,1.3),eh.colorArray.emplaceBack(eI,0,eI,1.3),eh.colorArray.emplaceBack(eI+eg,-.8,eI,.7),eh.colorArray.emplaceBack(eI+eg,-.8,eI,.7),eh.colorArray.emplaceBack(0,0,eI,1.3),eh.colorArray.emplaceBack(0,0,eI,1.3),eh.colorArray.emplaceBack(eI+eg,-1.2,eI,.8),eh.colorArray.emplaceBack(eI+eg,-1.2,eI,.8),eh.indexArray.emplaceBack(6+ec,4+ec,8+ec),eh.indexArray.emplaceBack(7+ec,9+ec,5+ec),eh.indexArray.emplaceBack(0+ec,1+ec,2+ec),eh.indexArray.emplaceBack(1+ec,3+ec,2+ec),ec+=10}let ep={defined:!0,emissiveFactor:[0,0,0]},e_={};return e_.baseColorFactor=Se.white,ep.pbrMetallicRoughness=e_,eh.material=ep,eh.aabb=new Au([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),eh}(F.lights,el)))}return eh},F.ek=Gy,F.el=Qy,F.em=rb,F.en=function(F){$t(),null!=ey&&ey.then(el=>{el.keys().then(eh=>{for(let ec=0;ec<eh.length-F;ec++)el.delete(eh[ec])})})},F.f=function(F){return 0===F.indexOf("mapbox:")},F.g=function(F,el){return re(nt(F,{method:"GET"}),el)},F.h=It,F.i=function(F){return tY.API_STYLE_REGEX.test(F)&&!St(F)},F.j=function(F){return decodeURIComponent(atob(F).split("").map(F=>"%"+("00"+F.charCodeAt(0).toString(16)).slice(-2)).join(""))},F.k=function(F){return btoa(encodeURIComponent(F).replace(/%([0-9A-F]{2})/g,(F,el)=>String.fromCharCode(Number("0x"+el))))},F.l=nt,F.m=t2,F.n=function(F,el){return re(nt(F,{type:"json"}),el)},F.o=le,F.p=function(F,el){return re(nt(F,{method:"POST"}),el)},F.q=tX,F.r=pc,F.s=function(F){try{let el=self[F];return el.setItem("_mapbox_test_",1),el.removeItem("_mapbox_test_"),!0}catch(F){return!1}},F.t=Vt,F.u=function(){return function t(F){return F?(F^Math.random()*(16>>F/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,t)}()},F.v=function(F){return!!F&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(F)},F.w=pt,F.x=function(){return e1||(e1=new rg),e1},F.y=Qg,F.z=xe}),define(["./shared"],function(F){function t(F){let el=F?F.url.toString():void 0;return el?performance.getEntriesByName(el):[]}function s(F){if("number"==typeof F||"boolean"==typeof F||"string"==typeof F||null==F)return JSON.stringify(F);if(Array.isArray(F)){let el="[";for(let eh of F)el+=`${s(eh)},`;return`${el}]`}let el="{";for(let eh of Object.keys(F).sort())el+=`${eh}:${s(F[eh])},`;return`${el}}`}let o=class o{constructor(F){this.keyCache={},this._layers={},this._layerConfigs={},F&&this.replace(F)}replace(F,el){this._layerConfigs={},this._layers={},this.update(F,[],el)}update(el,eh,ec){for(let eh of(this._options=ec,el))this._layerConfigs[eh.id]=eh,(this._layers[eh.id]=F.cv(eh,this.scope,null,this._options)).compileFilter(ec),this.keyCache[eh.id]&&delete this.keyCache[eh.id];for(let F of eh)delete this.keyCache[F],delete this._layerConfigs[F],delete this._layers[F];this.familiesBySource={};let ep=function(el,eh){let ec={};for(let ep=0;ep<el.length;ep++){let e_=el[ep],eg=eh&&eh[e_.id];!eg&&(eg=function(el){let eh="";for(let ec of F.bm)("model"!==el.type||"minzoom"!==ec&&"maxzoom"!==ec)&&(eh+=`/${s(el[ec])}`);return eh}(e_),"line"===e_.type&&e_.paint)&&function e(F){return"string"==typeof F&&"line-progress"===F||(Array.isArray(F)?F.some(e):!(!F||"object"!=typeof F)&&Object.values(F).some(e))}(e_.paint["line-width"])&&(eg+=`/${s(e_.paint["line-width"])}`),eh&&(eh[e_.id]=eg);let ey=ec[eg];ey||(ey=ec[eg]=[]),ey.push(e_)}let ep=[];for(let F in ec)ep.push(ec[F]);return ep}(Object.values(this._layerConfigs),this.keyCache);for(let F of ep){let el=F.map(F=>this._layers[F.id]),eh=el[0];if("none"===eh.visibility)continue;let ec=eh.source||"",ep=this.familiesBySource[ec];ep||(ep=this.familiesBySource[ec]={});let e_=eh.sourceLayer||"_geojsonTileLayer",eg=ep[e_];eg||(eg=ep[e_]=[]),eg.push(el)}}};let el=1*F.d_;let r=class r{constructor(eh){let ec={},ep=[];for(let F in eh){let e_=eh[F],eg=ec[F]={};for(let F in e_.glyphs){let eh=e_.glyphs[+F];if(!eh||0===eh.bitmap.width||0===eh.bitmap.height)continue;let ec=eh.metrics.localGlyph?el:1,ey={x:0,y:0,w:eh.bitmap.width+2*ec,h:eh.bitmap.height+2*ec};ep.push(ey),eg[F]=ey}}let{w:e_,h:eg}=F.H(ep),ey=new F.dZ({width:e_||1,height:eg||1});for(let ep in eh){let e_=eh[ep];for(let eh in e_.glyphs){let eg=e_.glyphs[+eh];if(!eg||0===eg.bitmap.width||0===eg.bitmap.height)continue;let eb=ec[ep][eh],ew=eg.metrics.localGlyph?el:1;F.dZ.copy(eg.bitmap,ey,{x:0,y:0},{x:eb.x+ew,y:eb.y+ew},eg.bitmap)}}this.image=ey,this.positions=ec}};F.dY(r,"GlyphAtlas");let a=class a{constructor(el){this.tileID=new F.aH(el.tileID.overscaledZ,el.tileID.wrap,el.tileID.canonical.z,el.tileID.canonical.x,el.tileID.canonical.y),this.tileZoom=el.tileZoom,this.uid=el.uid,this.zoom=el.zoom,this.lut=el.lut,this.canonical=el.tileID.canonical,this.pixelRatio=el.pixelRatio,this.tileSize=el.tileSize,this.source=el.source,this.scope=el.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=el.showCollisionBoxes,this.collectResourceTiming=!!el.request&&el.request.collectResourceTiming,this.promoteId=el.promoteId,this.isSymbolTile=el.isSymbolTile,this.tileTransform=F.aR(el.tileID.canonical,el.projection),this.projection=el.projection,this.worldview=el.worldview,this.localizableLayerIds=el.localizableLayerIds,this.brightness=el.brightness,this.extraShadowCaster=!!el.extraShadowCaster,this.tessellationStep=el.tessellationStep,this.scaleFactor=el.scaleFactor}parse(el,eh,ec,ep,e_){let eg,ey,eb,ew,eT,eS;this.status="parsing",this.data=el,this.collisionBoxArray=new F.aX;let eE=new F.d$(Object.keys(el.layers).sort()),eM=new F.e0(this.tileID,this.promoteId);eM.bucketLayerIDs=[];let eI={},eA=new F.e1(256,256),eC={featureIndex:eM,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:eA,availableImages:ec,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},eP=eh.familiesBySource[this.source];for(let eh in eP){let ep=el.layers[eh];if(!ep)continue;let e_=!1,eg=!1,ey=!1;for(let F of eP[eh])"symbol"===F[0].type?e_=!0:eg=!0,F[0].is3D()&&"model"!==F[0].type&&(ey=!0);if(this.extraShadowCaster&&!ey||!0===this.isSymbolTile&&!e_||!1===this.isSymbolTile&&!eg)continue;1===ep.version&&F.w(`Vector tile source "${this.source}" layer "${eh}" does not use vector tile spec v2 and therefore may have some rendering errors.`);let eb=eE.encode(eh),ew=[],eT=!1;for(let el=0,ec=0;el<ep.length;el++){let e_=ep.feature(el),eg=eM.getId(e_,eh);if(this.localizableLayerIds&&this.localizableLayerIds.has(eh)){let F=e_.properties?e_.properties.worldview:null;if(this.worldview&&"string"==typeof F){if("all"===F)e_.properties.$localized=!0;else{if(!F.split(",").includes(this.worldview))continue;e_.properties.$localized=!0,e_.properties.worldview=this.worldview}}}!eT&&e_.properties&&e_.properties.hasOwnProperty(F.e2)&&(eT=!0),ew.push({feature:e_,id:eg,index:ec,sourceLayerIndex:eb}),ec++}for(let ep of(eT&&!eC.elevationFeatures&&el.layers.hasOwnProperty(F.e3)&&(eC.elevationFeatures=F.e4.parseFrom(el.layers[F.e3],this.canonical)),eP[eh])){let el=ep[0];(!this.extraShadowCaster||el.is3D()&&"model"!==el.type)&&(void 0!==this.isSymbolTile&&"symbol"===el.type!==this.isSymbolTile||el.minzoom&&this.zoom<Math.floor(el.minzoom)||el.maxzoom&&this.zoom>=el.maxzoom||"none"!==el.visibility&&(l(ep,this.zoom,eC.brightness,ec),(eI[el.id]=el.createBucket({index:eM.bucketLayerIDs.length,layers:ep,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:eb,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(ew,eC,this.tileID.canonical,this.tileTransform),eM.bucketLayerIDs.push(ep.map(el=>F.C(el.id,el.scope)))))}}eA.trim();let ez={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},v=()=>{if(eg)return this.status="done",e_(eg);if(this.extraShadowCaster)this.status="done",e_(null,{buckets:Object.values(eI).filter(F=>!F.isEmpty()),featureIndex:eM,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:eC.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(ey&&eb&&ew){let el=new r(ey),eh=new Map;for(let[el,ec]of eb.entries()){let{imagePosition:ep}=F.e7(el,ec,F.e8);eh.set(el,ep)}let e_={};for(let ep in eI){let eg=eI[ep];eg instanceof F.aY&&(l(eg.layers,this.zoom,eC.brightness,ec),e_[ep]=F.e9(eg,ey,el.positions,eb,eh,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio))}let eg={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(ep,eb,eT,()=>{eg.iconsPending=!1,I(e_,el,eg)}),this.rasterizeIfNeeded(ep,ew,eS,()=>{eg.patternsPending=!1,I(e_,el,eg)})}},I=(el,eh,ep,eg)=>{if(ep.iconsPending||ep.patternsPending)return;let ey=new F.ea(eb,ew,this.lut);for(let eh in eI){let ep=eI[eh];if(eh in el)F.eb(ep,el[eh],this.showCollisionBoxes,ec,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,eb,ey);else if(ep.hasPattern&&(ep instanceof F.b2||ep instanceof F.b3||ep instanceof F.d8)){l(ep.layers,this.zoom,eC.brightness,ec);let F=Object.fromEntries(ey.patternPositions);ep.addFeatures(eC,this.tileID.canonical,F,ec,this.tileTransform,this.brightness)}}this.status="done",e_(null,{buckets:Object.values(eI).filter(F=>!F.isEmpty()),featureIndex:eM,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:eh.image,lineAtlas:eA,imageAtlas:ey,brightness:eC.brightness})};if(!this.extraShadowCaster){let el=F.e5(eC.glyphDependencies,F=>Object.keys(F).map(Number));Object.keys(el).length?ep.send("getGlyphs",{uid:this.uid,stacks:el,scope:this.scope},(F,el)=>{eg||(eg=F,ey=el,v())},void 0,!1,ez):ey={};let eh=Array.from(eC.iconDependencies.keys()).map(el=>F.I.parse(el));eh.length?ep.send("getImages",{images:eh,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(F,el)=>{eg||(eg=F,eb=new Map,eT=this.updateImageMapAndGetImageTaskQueue(eb,el,eC.iconDependencies),v())},void 0,!1,ez):(eb=new Map,eT=new Map);let ec=Array.from(eC.patternDependencies.keys()).map(el=>F.I.parse(el));ec.length?ep.send("getImages",{images:ec,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(F,el)=>{eg||(eg=F,ew=new Map,eS=this.updateImageMapAndGetImageTaskQueue(ew,el,eC.patternDependencies),v())},void 0,!1,ez):(ew=new Map,eS=new Map)}if(eC.elevationFeatures&&eC.elevationFeatures.length>0){let el=[];for(let eh of Object.values(eI))if(eh instanceof F.b3){let F=eh.getUnevaluatedPortalGraph();F&&el.push(F)}let eh=F.e6.evaluate(el);for(let el of Object.values(eI))el instanceof F.b3&&el.setEvaluatedPortalGraph(eh)}v()}rasterizeIfNeeded(F,el,eh,ec){Array.from(el.values()).some(F=>F.usvg)?this.rasterize(F,el,eh,ec):ec()}updateImageMapAndGetImageTaskQueue(F,el,eh){let ec=new Map;for(let ep of el.keys()){let e_=eh.get(ep)||[];for(let eh of e_){let ep=eh.toString(),e_=el.get(eh.id.toString());e_.usvg?ec.has(ep)||(ec.set(ep,eh),F.set(ep,Object.assign({},e_))):F.set(ep,e_)}}return ec}rasterize(F,el,eh,ec){this.rasterizeTask=F.send("rasterizeImages",{scope:this.scope,tasks:eh},(F,eh)=>{if(!F)for(let[F,ec]of eh.entries()){let eh=Object.assign(el.get(F),{data:ec});el.set(F,eh)}ec()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}};function l(el,eh,ec,ep){let e_=new F.aa(eh,{brightness:ec});for(let F of el)F.recalculate(e_,ep)}let c=class c extends F.E{constructor(el,eh,ec,ep,e_,eg){super(),this.actor=el,this.layerIndex=eh,this.availableImages=ec,this.loadVectorData=e_||F.aE,this.loading={},this.loaded={},this.deduped=new F.aD(el.scheduler),this.isSpriteLoaded=ep,this.scheduler=el.scheduler,this.brightness=eg}loadTile(el,eh){let ec=el.uid,ep=el&&el.request,e_=ep&&ep.collectResourceTiming,eg=this.loading[ec]=new a(el);eg.abort=this.loadVectorData(el,(ey,eb)=>{let ew=!this.loading[ec];if(delete this.loading[ec],eg.cancelRasterize(),ew||ey||!eb)return eg.status="done",ew||(this.loaded[ec]=eg),eh(ey);let eT=eb.rawData,eS={};eb.expires&&(eS.expires=eb.expires),eb.cacheControl&&(eS.cacheControl=eb.cacheControl),eg.vectorTile=eb.vectorTile||new F.ec.VectorTile(new F.bi(eT));let p=()=>{eg.parse(eg.vectorTile,this.layerIndex,this.availableImages,this.actor,(el,ec)=>{if(el||!ec)return eh(el);let eg={};if(e_){let F=t(ep);F.length>0&&(eg.resourceTiming=JSON.parse(JSON.stringify(F)))}eh(null,F.l({rawTileData:eT.slice(0)},ec,eS,eg))})};this.isSpriteLoaded?p():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(p,{type:"parseTile",isSymbolTile:el.isSymbolTile,zoom:el.tileZoom}):p()}),this.loaded=this.loaded||{},this.loaded[ec]=eg})}reloadTile(el,eh){let ec=this.loaded,ep=el.uid;if(ec&&ec[ep]){let e_=ec[ep];e_.scaleFactor=el.scaleFactor,e_.showCollisionBoxes=el.showCollisionBoxes,e_.projection=el.projection,e_.brightness=el.brightness,e_.tileTransform=F.aR(el.tileID.canonical,el.projection),e_.extraShadowCaster=el.extraShadowCaster,e_.lut=el.lut;let r=(F,el)=>{let ec=e_.reloadCallback;ec&&(delete e_.reloadCallback,e_.parse(e_.vectorTile,this.layerIndex,this.availableImages,this.actor,ec)),eh(F,el)};"parsing"===e_.status?e_.reloadCallback=r:"done"===e_.status&&(e_.vectorTile?e_.parse(e_.vectorTile,this.layerIndex,this.availableImages,this.actor,r):r())}else eh(null,void 0)}abortTile(F,el){let eh=F.uid,ec=this.loading[eh];ec&&(ec.abort&&ec.abort(),delete this.loading[eh]),el()}removeTile(F,el){let eh=this.loaded,ec=F.uid;eh&&eh[ec]&&delete eh[ec],el()}};let h=class h{loadTile(el,eh){let{uid:ec,encoding:ep,rawImageData:e_,padding:eg}=el,ey=ImageBitmap&&e_ instanceof ImageBitmap?this.getImageData(e_,eg):e_;eh(null,new F.ed(ec,ey,ep,eg<1))}reloadTile(F,el){el(null,null)}abortTile(F,el){el()}removeTile(F,el){el()}getImageData(F,el){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(F.width,F.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=F.width,this.offscreenCanvas.height=F.height,this.offscreenCanvasContext.drawImage(F,0,0,F.width,F.height);let eh=this.offscreenCanvasContext.getImageData(-el,-el,F.width+2*el,F.height+2*el);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),eh}};F.bh.setPbf(F.bi);let u=class u{constructor(el){this._mrt=new F.bh(el.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=el.uid,this.tileID=el.tileID,this.source=el.source}parse(el,eh){let ec=this._mrt;this.status="parsing",this._entireBuffer=el;try{ec.parseHeader(el),this._isHeaderLoaded=!0;let ep=[];for(let eh in ec.layers){let e_=ec.getLayer(eh),eg=e_.getDataRange(e_.getBandList()),ey=ec.createDecodingTask(eg),eb=el.slice(eg.firstByte,eg.lastByte+1),ew=F.bh.performDecoding(eb,ey).then(F=>ey.complete(null,F)).catch(F=>ey.complete(F,null));ep.push(ew)}Promise.allSettled(ep).then(()=>eh(null,ec))}catch(F){eh(F)}}};let d=class d{constructor(F){this.actor=F,this.loading={},this.loaded={}}loadTile(el,eh){let ec=el.uid,ep=el.request,e_=this.loading[ec]=new u(el),{cancel:eg}=F.bj(ep,(F,el,ep,eg)=>{let ey=!this.loading[ec];if(delete this.loading[ec],ey||F||!el)return e_.status="done",ey||(this.loaded[ec]=e_),eh(F);e_.parse(el,(F,el)=>{if(F||!el)return eh(F);eh(null,el,ep,eg)}),this.loaded[ec]=e_});e_.abort=eg}reloadTile(F,el){el(null,void 0)}abortTile(F,el){let eh=F.uid,ec=this.loading[eh];ec&&(ec.abort&&ec.abort(),delete this.loading[eh]),el()}removeTile(F,el){let eh=F.uid;this.loaded[eh]&&delete this.loaded[eh],el()}decodeRasterArray({task:el,buffer:eh},ec){F.bh.performDecoding(eh,el).then(F=>ec(null,F)).catch(F=>ec(F))}};let eh=F.ec.VectorTileFeature.prototype.toGeoJSON;let f=class f{constructor(el){this._feature=el,this.extent=F.ai,this.type=el.type,this.properties=el.tags,"id"in el&&!isNaN(el.id)&&(this.id=parseInt(el.id,10))}loadGeometry(){if(1===this._feature.type){let el=[];for(let eh of this._feature.geometry)el.push([new F.P(eh[0],eh[1])]);return el}{let el=[];for(let eh of this._feature.geometry){let ec=[];for(let el of eh)ec.push(new F.P(el[0],el[1]));el.push(ec)}return el}}toGeoJSON(F,el,ec){return eh.call(this,F,el,ec)}};let g=class g{constructor(el){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=F.ai,this.length=el.length,this._features=el}feature(F){return new f(this._features[F])}};let ec=64/4096;let x=class x{constructor(){this.features=new Map}clear(){this.features.clear()}load(F=[],el){for(let eh of F){let F=eh.id;if(null==F)continue;let ec=this.features.get(F);ec&&this.updateCache(ec,el),eh.geometry?(ec=function(F){let{id:el,geometry:eh,properties:ec}=F;if(!eh)return;if("GeometryCollection"===eh.type)throw Error("GeometryCollection not supported in dynamic mode.");let{type:ep,coordinates:e_}=eh,eg={id:el,type:1,geometry:[],tags:ec,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ey=eg.geometry;if("Point"===ep)v(e_,ey,eg);else if("MultiPoint"===ep)for(let F of e_)v(F,ey,eg);else if("LineString"===ep)eg.type=2,I(e_,ey,eg);else if("MultiLineString"===ep)eg.type=2,S(e_,ey,eg);else if("Polygon"===ep)eg.type=3,S(e_,ey,eg,!0);else{if("MultiPolygon"!==ep)throw Error("Input data is not a valid GeoJSON object.");for(let F of(eg.type=3,e_))S(F,ey,eg,!0)}return eg}(eh),this.updateCache(ec,el),this.features.set(F,ec)):this.features.delete(F),this.updateCache(ec,el)}}updateCache(F,el){for(let{canonical:eh,uid:ec}of Object.values(el)){let{z:ep,x:e_,y:eg}=eh;w(F,Math.pow(2,ep),e_,eg)&&delete el[ec]}}getTile(el,eh,ec){let ep=Math.pow(2,el),e_=[];for(let el of this.features.values())w(el,ep,eh,ec)&&e_.push(function(el,eh,ec,ep){let{id:e_,type:eg,geometry:ey,tags:eb}=el,ew=[];if(1===eg)!function(el,eh,ec,ep,e_){for(let eg=0;eg<el.length;eg+=2){let ey=Math.round(F.ai*(el[eg+0]*eh-ec)),eb=Math.round(F.ai*(el[eg+1]*eh-ep));e_.push([ey,eb])}}(ey,eh,ec,ep,ew);else for(let el of ey)(function(el,eh,ec,ep,e_){let eg;let ey=F.ai+128;for(let eb=0;eb<el.length-2;eb+=2){let ew=Math.round(F.ai*(el[eb+0]*eh-ec)),eT=Math.round(F.ai*(el[eb+1]*eh-ep)),eS=Math.round(F.ai*(el[eb+2]*eh-ec)),eE=Math.round(F.ai*(el[eb+3]*eh-ep)),eM=eS-ew,eI=eE-eT;ew<-128&&eS<-128||(ew<-128?(eT+=Math.round(eI*((-128-ew)/eM)),ew=-128):eS<-128&&(eE=eT+Math.round(eI*((-128-ew)/eM)),eS=-128),eT<-128&&eE<-128||(eT<-128?(ew+=Math.round(eM*((-128-eT)/eI)),eT=-128):eE<-128&&(eS=ew+Math.round(eM*((-128-eT)/eI)),eE=-128),ew>=ey&&eS>=ey||(ew>=ey?(eT+=Math.round(eI*((ey-ew)/eM)),ew=ey):eS>=ey&&(eE=eT+Math.round(eI*((ey-ew)/eM)),eS=ey),eT>=ey&&eE>=ey||(eT>=ey?(ew+=Math.round(eM*((ey-eT)/eI)),eT=ey):eE>=ey&&(eS=ew+Math.round(eM*((ey-eT)/eI)),eE=ey),eg&&ew===eg[eg.length-1][0]&&eT===eg[eg.length-1][1]||(eg=[[ew,eT]],e_.push(eg)),eg.push([eS,eE])))))}})(el,eh,ec,ep,ew);return{id:e_,type:eg,geometry:ew,tags:eb}}(el,ep,eh,ec));return{features:e_}}getFeatures(){return[...this.features.values()]}};function w({minX:F,minY:el,maxX:eh,maxY:ep},e_,eg,ey){return F<(eg+1+ec)/e_&&el<(ey+1+ec)/e_&&eh>(eg-ec)/e_&&ep>(ey-ec)/e_}function v([el,eh],ec,ep){let e_=F.av(el),eg=F.aC(eh);eg=eg<0?0:eg>1?1:eg,ec.push(e_,eg),ep.minX=Math.min(ep.minX,e_),ep.minY=Math.min(ep.minY,eg),ep.maxX=Math.max(ep.maxX,e_),ep.maxY=Math.max(ep.maxY,eg)}function I(F,el,eh,ec=!1,ep=!1){let e_=[];for(let el of F)v(el,e_,eh);el.push(e_),ec&&function(F,el){let eh=0;for(let el=0,ec=F.length,ep=ec-2;el<ec;ep=el,el+=2)eh+=(F[el]-F[ep])*(F[el+1]+F[ep+1]);if(eh>0===el)for(let el=0,eh=F.length;el<eh/2;el+=2){let ec=F[el],ep=F[el+1];F[el]=F[eh-2-el],F[el+1]=F[eh-1-el],F[eh-2-el]=ec,F[eh-1-el]=ep}}(e_,ep)}function S(F,el,eh,ec=!1){for(let ep=0;ep<F.length;ep++)I(F[ep],el,eh,ec,0===ep)}var ep,e_,eg,ey,eb={exports:{}},ew=function(){if(ey)return eb.exports;ey=1;var el=F.eg(),eh=function(){if(eg)return e_;eg=1;var el=F.ee(),eh=F.ef().VectorTileFeature;function i(F,el){this.options=el||{},this.features=F,this.length=F.length}function o(F,el){this.id="number"==typeof F.id?F.id:void 0,this.type=F.type,this.rawGeometry=1===F.type?[F.geometry]:F.geometry,this.properties=F.tags,this.extent=el||4096}return e_=i,i.prototype.feature=function(F){return new o(this.features[F],this.options.extent)},o.prototype.loadGeometry=function(){var F=this.rawGeometry;this.geometry=[];for(var eh=0;eh<F.length;eh++){for(var ec=F[eh],ep=[],e_=0;e_<ec.length;e_++)ep.push(new el(ec[e_][0],ec[e_][1]));this.geometry.push(ep)}return this.geometry},o.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var F=this.geometry,el=1/0,eh=-1/0,ec=1/0,ep=-1/0,e_=0;e_<F.length;e_++)for(var eg=F[e_],ey=0;ey<eg.length;ey++){var eb=eg[ey];el=Math.min(el,eb.x),eh=Math.max(eh,eb.x),ec=Math.min(ec,eb.y),ep=Math.max(ep,eb.y)}return[el,ec,eh,ep]},o.prototype.toGeoJSON=eh.prototype.toGeoJSON,e_}();function i(F){var eh=new el;return function(F,el){for(var eh in F.layers)el.writeMessage(3,o,F.layers[eh])}(F,eh),eh.finish()}function o(F,el){el.writeVarintField(15,F.version||1),el.writeStringField(1,F.name||""),el.writeVarintField(5,F.extent||4096);var eh,ec={keys:[],values:[],keycache:{},valuecache:{}};for(eh=0;eh<F.length;eh++)ec.feature=F.feature(eh),el.writeMessage(2,n,ec);var ep=ec.keys;for(eh=0;eh<ep.length;eh++)el.writeStringField(3,ep[eh]);var e_=ec.values;for(eh=0;eh<e_.length;eh++)el.writeMessage(4,h,e_[eh])}function n(F,el){var eh=F.feature;void 0!==eh.id&&el.writeVarintField(1,eh.id),el.writeMessage(2,r,F),el.writeVarintField(3,eh.type),el.writeMessage(4,c,eh)}function r(F,el){var eh=F.feature,ec=F.keys,ep=F.values,e_=F.keycache,eg=F.valuecache;for(var ey in eh.properties){var eb=eh.properties[ey],ew=e_[ey];if(null!==eb){void 0===ew&&(ec.push(ey),e_[ey]=ew=ec.length-1),el.writeVarint(ew);var eT=typeof eb;"string"!==eT&&"boolean"!==eT&&"number"!==eT&&(eb=JSON.stringify(eb));var eS=eT+":"+eb,eE=eg[eS];void 0===eE&&(ep.push(eb),eg[eS]=eE=ep.length-1),el.writeVarint(eE)}}}function c(F,el){for(var eh=F.loadGeometry(),ec=F.type,ep=0,e_=0,eg=eh.length,ey=0;ey<eg;ey++){var eb=eh[ey],ew=1;1===ec&&(ew=eb.length),el.writeVarint((ew<<3)+1);for(var eT=3===ec?eb.length-1:eb.length,eS=0;eS<eT;eS++){1===eS&&1!==ec&&el.writeVarint((eT-1<<3)+2);var eE=eb[eS].x-ep,eM=eb[eS].y-e_;el.writeVarint(eE<<1^eE>>31),el.writeVarint(eM<<1^eM>>31),ep+=eE,e_+=eM}3===ec&&el.writeVarint(15)}}function h(F,el){var eh=typeof F;"string"===eh?el.writeStringField(1,F):"boolean"===eh?el.writeBooleanField(7,F):"number"===eh&&(F%1!=0?el.writeDoubleField(3,F):F<0?el.writeSVarintField(6,F):el.writeVarintField(5,F))}return eb.exports=i,eb.exports.fromVectorTileJs=i,eb.exports.fromGeojsonVt=function(F,el){el=el||{};var ec={};for(var ep in F)ec[ep]=new eh(F[ep].features,el),ec[ep].name=ep,ec[ep].version=el.version,ec[ep].extent=el.extent;return i({layers:ec})},eb.exports.GeoJSONWrapper=eh,eb.exports}(),eT=F.eh(ew);let eS={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:F=>F},eE=Math.fround||(ep=new Float32Array(1),F=>(ep[0]=+F,ep[0]));let E=class E{constructor(F){this.options=Object.assign(Object.create(eS),F),this.trees=Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(F){let{log:el,minZoom:eh,maxZoom:ec}=this.options;el&&console.time("total time");let ep=`prepare ${F.length} points`;el&&console.time(ep),this.points=F;let e_=[];for(let el=0;el<F.length;el++){let eh=F[el];if(!eh.geometry)continue;let[ec,ep]=eh.geometry.coordinates,eg=eE(B(ec)),ey=eE(G(ep));e_.push(eg,ey,1/0,el,-1,1),this.options.reduce&&e_.push(0)}let eg=this.trees[ec+1]=this._createTree(e_);el&&console.timeEnd(ep);for(let F=ec;F>=eh;F--){let eh=+Date.now();eg=this.trees[F]=this._createTree(this._cluster(eg,F)),el&&console.log("z%d: %d clusters in %dms",F,eg.numItems,+Date.now()-eh)}return el&&console.timeEnd("total time"),this}getClusters(F,el){let eh=((F[0]+180)%360+360)%360-180,ec=Math.max(-90,Math.min(90,F[1])),ep=180===F[2]?180:((F[2]+180)%360+360)%360-180,e_=Math.max(-90,Math.min(90,F[3]));if(F[2]-F[0]>=360)eh=-180,ep=180;else if(eh>ep){let F=this.getClusters([eh,ec,180,e_],el),eg=this.getClusters([-180,ec,ep,e_],el);return F.concat(eg)}let eg=this.trees[this._limitZoom(el)],ey=eg.range(B(eh),G(e_),B(ep),G(ec)),eb=eg.data,ew=[];for(let F of ey){let el=this.stride*F;ew.push(eb[el+5]>1?N(eb,el,this.clusterProps):this.points[eb[el+3]])}return ew}getChildren(F){let el=this._getOriginId(F),eh=this._getOriginZoom(F),ec="No cluster with the specified id.",ep=this.trees[eh];if(!ep)throw Error(ec);let e_=ep.data;if(el*this.stride>=e_.length)throw Error(ec);let eg=this.options.radius/(this.options.extent*Math.pow(2,eh-1)),ey=ep.within(e_[el*this.stride],e_[el*this.stride+1],eg),eb=[];for(let el of ey){let eh=el*this.stride;e_[eh+4]===F&&eb.push(e_[eh+5]>1?N(e_,eh,this.clusterProps):this.points[e_[eh+3]])}if(0===eb.length)throw Error(ec);return eb}getLeaves(F,el,eh){let ec=[];return this._appendLeaves(ec,F,el=el||10,eh=eh||0,0),ec}getTile(F,el,eh){let ec=this.trees[this._limitZoom(F)],ep=Math.pow(2,F),{extent:e_,radius:eg}=this.options,ey=eg/e_,eb=(eh-ey)/ep,ew=(eh+1+ey)/ep,eT={features:[]};return this._addTileFeatures(ec.range((el-ey)/ep,eb,(el+1+ey)/ep,ew),ec.data,el,eh,ep,eT),0===el&&this._addTileFeatures(ec.range(1-ey/ep,eb,1,ew),ec.data,ep,eh,ep,eT),el===ep-1&&this._addTileFeatures(ec.range(0,eb,ey/ep,ew),ec.data,-1,eh,ep,eT),eT.features.length?eT:null}getClusterExpansionZoom(F){let el=this._getOriginZoom(F)-1;for(;el<=this.options.maxZoom;){let eh=this.getChildren(F);if(el++,1!==eh.length)break;F=eh[0].properties.cluster_id}return el}_appendLeaves(F,el,eh,ec,ep){let e_=this.getChildren(el);for(let el of e_){let e_=el.properties;if(e_&&e_.cluster?ep+e_.point_count<=ec?ep+=e_.point_count:ep=this._appendLeaves(F,e_.cluster_id,eh,ec,ep):ep<ec?ep++:F.push(el),F.length===eh)break}return ep}_createTree(el){let eh=new F.bE(el.length/this.stride|0,this.options.nodeSize,Float32Array);for(let F=0;F<el.length;F+=this.stride)eh.add(el[F],el[F+1]);return eh.finish(),eh.data=el,eh}_addTileFeatures(F,el,eh,ec,ep,e_){for(let eg of F){let F,ey,eb,ew;let eT=eg*this.stride,eS=el[eT+5]>1;if(eS)F=X(el,eT,this.clusterProps),ey=el[eT],eb=el[eT+1];else{let eh=this.points[el[eT+3]];F=eh.properties;let[ec,ep]=eh.geometry.coordinates;ey=B(ec),eb=G(ep)}let eE={type:1,geometry:[[Math.round(this.options.extent*(ey*ep-eh)),Math.round(this.options.extent*(eb*ep-ec))]],tags:F};void 0!==(ew=eS||this.options.generateId?el[eT+3]:this.points[el[eT+3]].id)&&(eE.id=ew),e_.features.push(eE)}}_limitZoom(F){return Math.max(this.options.minZoom,Math.min(Math.floor(+F),this.options.maxZoom+1))}_cluster(F,el){let{radius:eh,extent:ec,reduce:ep,minPoints:e_}=this.options,eg=eh/(ec*Math.pow(2,el)),ey=F.data,eb=[],ew=this.stride;for(let eh=0;eh<ey.length;eh+=ew){if(ey[eh+2]<=el)continue;ey[eh+2]=el;let ec=ey[eh],eT=ey[eh+1],eS=F.within(ey[eh],ey[eh+1],eg),eE=ey[eh+5],eM=eE;for(let F of eS){let eh=F*ew;ey[eh+2]>el&&(eM+=ey[eh+5])}if(eM>eE&&eM>=e_){let F,e_=ec*eE,eg=eT*eE,eI=-1,eA=(eh/ew<<5)+(el+1)+this.points.length;for(let ec of eS){let eb=ec*ew;if(ey[eb+2]<=el)continue;ey[eb+2]=el;let eT=ey[eb+5];e_+=ey[eb]*eT,eg+=ey[eb+1]*eT,ey[eb+4]=eA,ep&&(F||(F=this._map(ey,eh,!0),eI=this.clusterProps.length,this.clusterProps.push(F)),ep(F,this._map(ey,eb)))}ey[eh+4]=eA,eb.push(e_/eM,eg/eM,1/0,eA,-1,eM),ep&&eb.push(eI)}else{for(let F=0;F<ew;F++)eb.push(ey[eh+F]);if(eM>1)for(let F of eS){let eh=F*ew;if(!(ey[eh+2]<=el)){ey[eh+2]=el;for(let F=0;F<ew;F++)eb.push(ey[eh+F])}}}}return eb}_getOriginId(F){return F-this.points.length>>5}_getOriginZoom(F){return(F-this.points.length)%32}_map(F,el,eh){if(F[el+5]>1){let ec=this.clusterProps[F[el+6]];return eh?Object.assign({},ec):ec}let ec=this.points[F[el+3]].properties,ep=this.options.map(ec);return eh&&ep===ec?Object.assign({},ep):ep}};function N(F,el,eh){return{type:"Feature",id:F[el+3],properties:X(F,el,eh),geometry:{type:"Point",coordinates:[360*(F[el]-.5),function(F){let el=(180-360*F)*Math.PI/180;return 360*Math.atan(Math.exp(el))/Math.PI-90}(F[el+1])]}}}function X(F,el,eh){let ec=F[el+5],ep=ec>=1e4?`${Math.round(ec/1e3)}k`:ec>=1e3?Math.round(ec/100)/10+"k":ec,e_=F[el+6],eg=-1===e_?{}:Object.assign({},eh[e_]);return Object.assign(eg,{cluster:!0,cluster_id:F[el+3],point_count:ec,point_count_abbreviated:ep})}function B(F){return F/360+.5}function G(F){let el=Math.sin(F*Math.PI/180),eh=.5-.25*Math.log((1+el)/(1-el))/Math.PI;return eh<0?0:eh>1?1:eh}function V(F,el,eh,ec){let ep={id:F??null,type:el,geometry:eh,tags:ec,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===el||"MultiPoint"===el||"LineString"===el)$(ep,eh);else if("Polygon"===el)$(ep,eh[0]);else if("MultiLineString"===el)for(let F of eh)$(ep,F);else if("MultiPolygon"===el)for(let F of eh)$(ep,F[0]);return ep}function $(F,el){for(let eh=0;eh<el.length;eh+=3)F.minX=Math.min(F.minX,el[eh]),F.minY=Math.min(F.minY,el[eh+1]),F.maxX=Math.max(F.maxX,el[eh]),F.maxY=Math.max(F.maxY,el[eh+1])}function W(F,el,eh,ec){if(!el.geometry)return;let ep=el.geometry.coordinates;if(ep&&0===ep.length)return;let e_=el.geometry.type,eg=Math.pow(eh.tolerance/((1<<eh.maxZoom)*eh.extent),2),ey=[],eb=el.id;if(eh.promoteId?eb=el.properties[eh.promoteId]:eh.generateId&&(eb=ec||0),"Point"===e_)q(ep,ey);else if("MultiPoint"===e_)for(let F of ep)q(F,ey);else if("LineString"===e_)U(ep,ey,eg,!1);else if("MultiLineString"===e_){if(eh.lineMetrics){for(let eh of ep)U(eh,ey=[],eg,!1),F.push(V(eb,"LineString",ey,el.properties));return}H(ep,ey,eg,!1)}else if("Polygon"===e_)H(ep,ey,eg,!0);else{if("MultiPolygon"!==e_){if("GeometryCollection"===e_){for(let ep of el.geometry.geometries)W(F,{id:eb,geometry:ep,properties:el.properties},eh,ec);return}throw Error("Input data is not a valid GeoJSON object.")}for(let F of ep){let el=[];H(F,el,eg,!0),ey.push(el)}}F.push(V(eb,e_,ey,el.properties))}function q(F,el){var eh;el.push(F[0]/360+.5,K(F[1]),0)}function U(F,el,eh,ec){let ep,e_,eg=0;for(let eh=0;eh<F.length;eh++){var ey;let eb=F[eh][0]/360+.5,ew=K(F[eh][1]);el.push(eb,ew,0),eh>0&&(eg+=ec?(ep*ew-eb*e_)/2:Math.sqrt(Math.pow(eb-ep,2)+Math.pow(ew-e_,2))),ep=eb,e_=ew}let eb=el.length-3;el[2]=1,function R(F,el,eh,ec){let ep=ec,e_=el+(eh-el>>1),eg,ey=eh-el,eb=F[el],ew=F[el+1],eT=F[eh],eS=F[eh+1];for(let ec=el+3;ec<eh;ec+=3){let el=function(F,el,eh,ec,ep,e_){let eg=ep-eh,ey=e_-ec;if(0!==eg||0!==ey){let eb=((F-eh)*eg+(el-ec)*ey)/(eg*eg+ey*ey);eb>1?(eh=ep,ec=e_):eb>0&&(eh+=eg*eb,ec+=ey*eb)}return(eg=F-eh)*eg+(ey=el-ec)*ey}(F[ec],F[ec+1],eb,ew,eT,eS);if(el>ep)eg=ec,ep=el;else if(el===ep){let F=Math.abs(ec-e_);F<ey&&(eg=ec,ey=F)}}ep>ec&&(eg-el>3&&R(F,el,eg,ec),F[eg+2]=ep,eh-eg>3&&R(F,eg,eh,ec))}(el,0,eb,eh),el[eb+2]=1,el.size=Math.abs(eg),el.start=0,el.end=el.size}function H(F,el,eh,ec){for(let ep=0;ep<F.length;ep++){let e_=[];U(F[ep],e_,eh,ec),el.push(e_)}}function K(F){let el=Math.sin(F*Math.PI/180),eh=.5-.25*Math.log((1+el)/(1-el))/Math.PI;return eh<0?0:eh>1?1:eh}function ee(F,el,eh,ec,ep,e_,eg,ey){if(ec/=el,e_>=(eh/=el)&&eg<ec)return F;if(eg<eh||e_>=ec)return null;let eb=[];for(let el of F){let F=el.geometry,e_=el.type,eg=0===ep?el.minX:el.minY,ew=0===ep?el.maxX:el.maxY;if(eg>=eh&&ew<ec){eb.push(el);continue}if(ew<eh||eg>=ec)continue;let eT=[];if("Point"===e_||"MultiPoint"===e_)(function(F,el,eh,ec,ep){for(let e_=0;e_<F.length;e_+=3){let eg=F[e_+ep];eg>=eh&&eg<=ec&&ne(el,F[e_],F[e_+1],F[e_+2])}})(F,eT,eh,ec,ep);else if("LineString"===e_)se(F,eT,eh,ec,ep,!1,ey.lineMetrics);else if("MultiLineString"===e_)oe(F,eT,eh,ec,ep,!1);else if("Polygon"===e_)oe(F,eT,eh,ec,ep,!0);else if("MultiPolygon"===e_)for(let el of F){let F=[];oe(el,F,eh,ec,ep,!0),F.length&&eT.push(F)}if(eT.length){if(ey.lineMetrics&&"LineString"===e_){for(let F of eT)eb.push(V(el.id,e_,F,el.tags));continue}"LineString"!==e_&&"MultiLineString"!==e_||(1===eT.length?(e_="LineString",eT=eT[0]):e_="MultiLineString"),"Point"!==e_&&"MultiPoint"!==e_||(e_=3===eT.length?"Point":"MultiPoint"),eb.push(V(el.id,e_,eT,el.tags))}}return eb.length?eb:null}function se(F,el,eh,ec,ep,e_,eg){let ey=ie(F),eb=0===ep?re:ae,ew,eT,eS=F.start;for(let eE=0;eE<F.length-3;eE+=3){let eM=F[eE],eI=F[eE+1],eA=F[eE+2],eC=F[eE+3],eP=F[eE+4],ez=0===ep?eM:eI,eD=0===ep?eC:eP,eR=!1;eg&&(ew=Math.sqrt(Math.pow(eM-eC,2)+Math.pow(eI-eP,2))),ez<eh?eD>eh&&(eT=eb(ey,eM,eI,eC,eP,eh),eg&&(ey.start=eS+ew*eT)):ez>ec?eD<ec&&(eT=eb(ey,eM,eI,eC,eP,ec),eg&&(ey.start=eS+ew*eT)):ne(ey,eM,eI,eA),eD<eh&&ez>=eh&&(eT=eb(ey,eM,eI,eC,eP,eh),eR=!0),eD>ec&&ez<=ec&&(eT=eb(ey,eM,eI,eC,eP,ec),eR=!0),!e_&&eR&&(eg&&(ey.end=eS+ew*eT),el.push(ey),ey=ie(F)),eg&&(eS+=ew)}let eE=F.length-3,eM=F[eE],eI=F[eE+1],eA=0===ep?eM:eI;eA>=eh&&eA<=ec&&ne(ey,eM,eI,F[eE+2]),eE=ey.length-3,e_&&eE>=3&&(ey[eE]!==ey[0]||ey[eE+1]!==ey[1])&&ne(ey,ey[0],ey[1],ey[2]),ey.length&&el.push(ey)}function ie(F){let el=[];return el.size=F.size,el.start=F.start,el.end=F.end,el}function oe(F,el,eh,ec,ep,e_){for(let eg of F)se(eg,el,eh,ec,ep,e_,!1)}function ne(F,el,eh,ec){F.push(el,eh,ec)}function re(F,el,eh,ec,ep,e_){let eg=(e_-el)/(ec-el);return ne(F,e_,eh+(ep-eh)*eg,1),eg}function ae(F,el,eh,ec,ep,e_){let eg=(e_-eh)/(ep-eh);return ne(F,el+(ec-el)*eg,e_,1),eg}function le(F,el){let eh=[];for(let ec=0;ec<F.length;ec++){let ep;let e_=F[ec],eg=e_.type;if("Point"===eg||"MultiPoint"===eg||"LineString"===eg)ep=ce(e_.geometry,el);else if("MultiLineString"===eg||"Polygon"===eg)for(let F of(ep=[],e_.geometry))ep.push(ce(F,el));else if("MultiPolygon"===eg)for(let F of(ep=[],e_.geometry)){let eh=[];for(let ec of F)eh.push(ce(ec,el));ep.push(eh)}eh.push(V(e_.id,eg,ep,e_.tags))}return eh}function ce(F,el){let eh=[];eh.size=F.size,void 0!==F.start&&(eh.start=F.start,eh.end=F.end);for(let ec=0;ec<F.length;ec+=3)eh.push(F[ec]+el,F[ec+1],F[ec+2]);return eh}function he(F,el){if(F.transformed)return F;let eh=1<<F.z,ec=F.x,ep=F.y;for(let e_ of F.features){let F=e_.geometry,eg=e_.type;if(e_.geometry=[],1===eg)for(let eg=0;eg<F.length;eg+=2)e_.geometry.push(ue(F[eg],F[eg+1],el,eh,ec,ep));else for(let eg=0;eg<F.length;eg++){let ey=[];for(let e_=0;e_<F[eg].length;e_+=2)ey.push(ue(F[eg][e_],F[eg][e_+1],el,eh,ec,ep));e_.geometry.push(ey)}}return F.transformed=!0,F}function ue(F,el,eh,ec,ep,e_){return[Math.round(eh*(F*ec-ep)),Math.round(eh*(el*ec-e_))]}function fe(F,el,eh,ec,ep,e_){let eg=ec*ec;if(ec>0&&el.size<(ep?eg:ec))return void(eh.numPoints+=el.length/3);let ey=[];for(let F=0;F<el.length;F+=3)(0===ec||el[F+2]>eg)&&(eh.numSimplified++,ey.push(el[F],el[F+1])),eh.numPoints++;ep&&function(F,el){let eh=0;for(let el=0,ec=F.length,ep=ec-2;el<ec;ep=el,el+=2)eh+=(F[el]-F[ep])*(F[el+1]+F[ep+1]);if(eh>0===el)for(let el=0,eh=F.length;el<eh/2;el+=2){let ec=F[el],ep=F[el+1];F[el]=F[eh-2-el],F[el+1]=F[eh-1-el],F[eh-2-el]=ec,F[eh-1-el]=ep}}(ey,e_),F.push(ey)}let eM={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};let me=class me{constructor(F,el){let eh=(el=this.options=function(F,el){for(let eh in el)F[eh]=el[eh];return F}(Object.create(eM),el)).debug;if(eh&&console.time("preprocess data"),el.maxZoom<0||el.maxZoom>24)throw Error("maxZoom should be in the 0-24 range");if(el.promoteId&&el.generateId)throw Error("promoteId and generateId cannot be used together.");let ec=function(F,el){let eh=[];if("FeatureCollection"===F.type)for(let ec=0;ec<F.features.length;ec++)W(eh,F.features[ec],el,ec);else W(eh,"Feature"===F.type?F:{geometry:F},el);return eh}(F,el);this.tiles={},this.tileCoords=[],eh&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",el.indexMaxZoom,el.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(ec=function(F,el){let eh=el.buffer/el.extent,ec=F,ep=ee(F,1,-1-eh,eh,0,-1,2,el),e_=ee(F,1,1-eh,2+eh,0,-1,2,el);return(ep||e_)&&(ec=ee(F,1,-eh,1+eh,0,-1,2,el)||[],ep&&(ec=le(ep,1).concat(ec)),e_&&(ec=ec.concat(le(e_,-1)))),ec}(ec,el)).length&&this.splitTile(ec,0,0,0),eh&&(ec.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(F,el,eh,ec,ep,e_,eg){let ey=[F,el,eh,ec],eb=this.options,ew=eb.debug;for(;ey.length;){ec=ey.pop(),eh=ey.pop(),el=ey.pop(),F=ey.pop();let eT=1<<el,eS=ye(el,eh,ec),eE=this.tiles[eS];if(!eE&&(ew>1&&console.time("creation"),eE=this.tiles[eS]=function(F,el,eh,ec,ep){let e_=el===ep.maxZoom?0:ep.tolerance/((1<<el)*ep.extent),eg={features:[],numPoints:0,numSimplified:0,numFeatures:F.length,source:null,x:eh,y:ec,z:el,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(let el of F)(function(F,el,eh,ec){let ep=el.geometry,e_=el.type,eg=[];if(F.minX=Math.min(F.minX,el.minX),F.minY=Math.min(F.minY,el.minY),F.maxX=Math.max(F.maxX,el.maxX),F.maxY=Math.max(F.maxY,el.maxY),"Point"===e_||"MultiPoint"===e_)for(let el=0;el<ep.length;el+=3)eg.push(ep[el],ep[el+1]),F.numPoints++,F.numSimplified++;else if("LineString"===e_)fe(eg,ep,F,eh,!1,!1);else if("MultiLineString"===e_||"Polygon"===e_)for(let el=0;el<ep.length;el++)fe(eg,ep[el],F,eh,"Polygon"===e_,0===el);else if("MultiPolygon"===e_)for(let el=0;el<ep.length;el++){let ec=ep[el];for(let el=0;el<ec.length;el++)fe(eg,ec[el],F,eh,!0,0===el)}if(eg.length){let eh=el.tags||null;if("LineString"===e_&&ec.lineMetrics){for(let F in eh={},el.tags)eh[F]=el.tags[F];eh.mapbox_clip_start=ep.start/ep.size,eh.mapbox_clip_end=ep.end/ep.size}let ey={geometry:eg,type:"Polygon"===e_||"MultiPolygon"===e_?3:"LineString"===e_||"MultiLineString"===e_?2:1,tags:eh};null!==el.id&&(ey.id=el.id),F.features.push(ey)}})(eg,el,e_,ep);return eg}(F,el,eh,ec,eb),this.tileCoords.push({z:el,x:eh,y:ec}),ew)){ew>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",el,eh,ec,eE.numFeatures,eE.numPoints,eE.numSimplified),console.timeEnd("creation"));let F=`z${el}`;this.stats[F]=(this.stats[F]||0)+1,this.total++}if(eE.source=F,null==ep){if(el===eb.indexMaxZoom||eE.numPoints<=eb.indexMaxPoints)continue}else{if(el===eb.maxZoom||el===ep)continue;if(null!=ep){let F=ep-el;if(eh!==e_>>F||ec!==eg>>F)continue}}if(eE.source=null,0===F.length)continue;ew>1&&console.time("clipping");let eM=.5*eb.buffer/eb.extent,eI=.5-eM,eA=.5+eM,eC=1+eM,eP=null,ez=null,eD=null,eR=null,eL=ee(F,eT,eh-eM,eh+eA,0,eE.minX,eE.maxX,eb),eO=ee(F,eT,eh+eI,eh+eC,0,eE.minX,eE.maxX,eb);F=null,eL&&(eP=ee(eL,eT,ec-eM,ec+eA,1,eE.minY,eE.maxY,eb),ez=ee(eL,eT,ec+eI,ec+eC,1,eE.minY,eE.maxY,eb),eL=null),eO&&(eD=ee(eO,eT,ec-eM,ec+eA,1,eE.minY,eE.maxY,eb),eR=ee(eO,eT,ec+eI,ec+eC,1,eE.minY,eE.maxY,eb),eO=null),ew>1&&console.timeEnd("clipping"),ey.push(eP||[],el+1,2*eh,2*ec),ey.push(ez||[],el+1,2*eh,2*ec+1),ey.push(eD||[],el+1,2*eh+1,2*ec),ey.push(eR||[],el+1,2*eh+1,2*ec+1)}}getTile(F,el,eh){F=+F,el=+el,eh=+eh;let ec=this.options,{extent:ep,debug:e_}=ec;if(F<0||F>24)return null;let eg=1<<F,ey=ye(F,el=el+eg&eg-1,eh);if(this.tiles[ey])return he(this.tiles[ey],ep);e_>1&&console.log("drilling down to z%d-%d-%d",F,el,eh);let eb,ew=F,eT=el,eS=eh;for(;!eb&&ew>0;)ew--,eT>>=1,eS>>=1,eb=this.tiles[ye(ew,eT,eS)];return eb&&eb.source?(e_>1&&(console.log("found parent tile z%d-%d-%d",ew,eT,eS),console.time("drilling down")),this.splitTile(eb.source,ew,eT,eS,F,el,eh),e_>1&&console.timeEnd("drilling down"),this.tiles[ey]?he(this.tiles[ey],ep):null):null}};function ye(F,el,eh){return 32*((1<<F)*eh+el)+F}function xe(F,el){let eh=F.tileID.canonical;if(!this._geoJSONIndex)return void el(null,null);let ec=this._geoJSONIndex.getTile(eh.z,eh.x,eh.y);if(!ec)return void el(null,null);let ep=new g(ec.features),e_=eT(ep);0===e_.byteOffset&&e_.byteLength===e_.buffer.byteLength||(e_=new Uint8Array(e_)),el(null,{vectorTile:ep,rawData:e_.buffer})}let we=class we extends c{constructor(F,el,eh,ec,ep,e_){super(F,el,eh,ec,xe,e_),ep&&(this.loadGeoJSON=ep),this._dynamicIndex=new x}loadData(el,eh){let ec=el&&el.request,ep=ec&&ec.collectResourceTiming;this.loadGeoJSON(el,(e_,eg)=>{if(e_||!eg)return eh(e_);if("object"!=typeof eg)return eh(Error(`Input data given to '${el.source}' is not a valid GeoJSON object.`));{try{var ey,eb;if(el.filter){let eh=F.X(el.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===eh.result)throw Error(eh.value.map(F=>`${F.key}: ${F.message}`).join(", "));eg.features=eg.features.filter(F=>eh.value.evaluate({zoom:0},F))}el.dynamic?("Feature"===eg.type&&(eg={type:"FeatureCollection",features:[eg]}),el.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(eg.features,this.loaded),el.cluster&&(eg.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=el.cluster?new E(function({superclusterOptions:el,clusterProperties:eh}){if(!eh||!el)return el;let ec={},ep={},e_={accumulated:null,zoom:0},eg={properties:null},ey=Object.keys(eh);for(let el of ey){let[e_,eg]=eh[el],ey=F.X(eg),eb=F.X("string"==typeof e_?[e_,["accumulated"],["get",el]]:e_);ec[el]=ey.value,ep[el]=eb.value}return el.map=F=>{eg.properties=F;let el={};for(let F of ey)el[F]=ec[F].evaluate(e_,eg);return el},el.reduce=(F,el)=>{for(let eh of(eg.properties=el,ey))e_.accumulated=F[eh],F[eh]=ep[eh].evaluate(e_,eg)},el}(el)).load(eg.features):el.dynamic?this._dynamicIndex:(ey=eg,eb=el.geojsonVtOptions,new me(ey,eb))}catch(F){return eh(F)}let e_={};if(ep){let F=t(ec);F&&(e_.resourceTiming={},e_.resourceTiming[el.source]=JSON.parse(JSON.stringify(F)))}eh(null,e_)}})}reloadTile(F,el){let eh=this.loaded;return eh&&eh[F.uid]?F.partial?el(null,void 0):super.reloadTile(F,el):this.loadTile(F,el)}loadGeoJSON(el,eh){if(el.request)F.n(el.request,eh);else{if("string"!=typeof el.data)return eh(Error(`Input data given to '${el.source}' is not a valid GeoJSON object.`));try{return eh(null,JSON.parse(el.data))}catch(F){return eh(Error(`Input data given to '${el.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom(F,el){try{el(null,this._geoJSONIndex.getClusterExpansionZoom(F.clusterId))}catch(F){el(F)}}getClusterChildren(F,el){try{el(null,this._geoJSONIndex.getChildren(F.clusterId))}catch(F){el(F)}}getClusterLeaves(F,el){try{el(null,this._geoJSONIndex.getLeaves(F.clusterId,F.limit,F.offset))}catch(F){el(F)}}};let be=class be{constructor(el,eh){this.tileID=new F.aH(el.tileID.overscaledZ,el.tileID.wrap,el.tileID.canonical.z,el.tileID.canonical.x,el.tileID.canonical.y),this.tileZoom=el.tileZoom,this.uid=el.uid,this.zoom=el.zoom,this.canonical=el.tileID.canonical,this.pixelRatio=el.pixelRatio,this.tileSize=el.tileSize,this.source=el.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=el.projection,this.brightness=eh}parse(el,eh,ec,ep){this.status="parsing";let e_=new F.aH(ec.tileID.overscaledZ,ec.tileID.wrap,ec.tileID.canonical.z,ec.tileID.canonical.x,ec.tileID.canonical.y),eg=[],ey=eh.familiesBySource[ec.source],eb=new F.e0(e_,ec.promoteId);return eb.bucketLayerIDs=[],eb.is3DTile=!0,F.ei(el).then(el=>{if(!el)return ep(Error("Could not parse tile"));let eh=F.ej(el,1/F.cd(ec.tileID.canonical)),ew=el.json.extensionsUsed&&el.json.extensionsUsed.includes("MAPBOX_mesh_features")||el.json.asset.extras&&el.json.asset.extras.MAPBOX_mesh_features,eT=el.json.extensionsUsed&&el.json.extensionsUsed.includes("EXT_meshopt_compression"),eS=new F.aa(this.zoom,{brightness:this.brightness});for(let el in ey)for(let ec of ey[el]){let el=ec[0];eb.bucketLayerIDs.push(ec.map(el=>F.C(el.id,el.scope))),el.recalculate(eS,[]);let ep=new F.ek(ec,eh,e_,ew,eT,this.brightness,eb);ew||(ep.needsUpload=!0),eg.push(ep),ep.evaluate(el)}this.status="done",ep(null,{buckets:eg,featureIndex:eb,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(F=>ep(Error(F.message)))}};let ve=class ve{constructor(F,el,eh,ec,ep,e_){this.actor=F,this.layerIndex=el,this.availableImages=eh,this.brightness=e_,this.loading={},this.loaded={}}loadTile(el,eh){let ec=el.uid,ep=this.loading[ec]=new be(el,this.brightness);F.bj(el.request,(F,e_)=>{let eg=!this.loading[ec];return delete this.loading[ec],eg||F?(ep.status="done",eg||(this.loaded[ec]=ep),eh(F)):e_&&0!==e_.byteLength?void ep.parse(e_,this.layerIndex,el,(F,el)=>{ep.status="done",this.loaded=this.loaded||{},this.loaded[ec]=ep,F||!el?eh(F):eh(null,el)}):(ep.status="done",this.loaded[ec]=ep,eh())})}reloadTile(F,el){let eh=this.loaded,ec=F.uid;if(eh&&eh[ec]){let ep=eh[ec];ep.projection=F.projection,ep.brightness=F.brightness,"parsing"===ep.status?ep.reloadCallback=(eh,ec)=>{ep.reloadCallback&&(delete ep.reloadCallback,this.loadTile(F,el)),el(eh,ec)}:"done"===ep.status&&this.loadTile(F,el)}}abortTile(F,el){let eh=F.uid;this.loading[eh]&&delete this.loading[eh],el()}removeTile(F,el){let eh=this.loaded,ec=F.uid;eh&&eh[ec]&&delete eh[ec],el()}};let Ie=class Ie{constructor(el){this.self=el,this.actor=new F.el(el,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new F.y,this.projections={},this.defaultProjection=F.bP({name:"mercator"}),this.workerSourceTypes={vector:c,geojson:we,"raster-dem":h,"raster-array":d,"batched-model":ve},this.workerSources={},this.self.registerWorkerSource=(F,el)=>{if(this.workerSourceTypes[F])throw Error(`Worker source with name "${F}" already registered.`);this.workerSourceTypes[F]=el},this.self.registerRTLTextPlugin=el=>{if(F.em.isParsed())throw Error("RTL text plugin already registered.");F.em.applyArabicShaping=el.applyArabicShaping,F.em.processBidirectionalText=el.processBidirectionalText,F.em.processStyledBidirectionalText=el.processStyledBidirectionalText}}clearCaches(F,el,eh){delete this.layerIndexes[F],delete this.availableImages[F],delete this.workerSources[F],eh()}checkIfReady(F,el,eh){eh()}setReferrer(F,el){this.referrer=el}spriteLoaded(el,{scope:eh,isLoaded:ec}){if(this.isSpriteLoaded[el]||(this.isSpriteLoaded[el]={}),this.isSpriteLoaded[el][eh]=ec,this.workerSources[el]&&this.workerSources[el][eh])for(let ep in this.workerSources[el][eh]){let e_=this.workerSources[el][eh][ep];for(let el in e_){let eh=e_[el];eh instanceof c&&(eh.isSpriteLoaded=ec,eh.fire(new F.A("isSpriteLoaded")))}}}setImages(F,{scope:el,images:eh},ec){if(this.availableImages[F]||(this.availableImages[F]={}),this.availableImages[F][el]=eh,this.workerSources[F]&&this.workerSources[F][el]){for(let ec in this.workerSources[F][el]){let ep=this.workerSources[F][el][ec];for(let F in ep)ep[F].availableImages=eh}ec()}else ec()}setProjection(el,eh){this.projections[el]=F.bP(eh)}setBrightness(F,el,eh){this.brightness=el,eh()}setLayers(F,el,eh){this.getLayerIndex(F,el.scope).replace(el.layers,el.options),eh()}updateLayers(F,el,eh){this.getLayerIndex(F,el.scope).update(el.layers,el.removedIds,el.options),eh()}loadTile(F,el,eh){el.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,el.type,el.source,el.scope).loadTile(el,eh)}decodeRasterArray(F,el,eh){this.getWorkerSource(F,el.type,el.source,el.scope).decodeRasterArray(el,eh)}reloadTile(F,el,eh){el.projection=this.projections[F]||this.defaultProjection,this.getWorkerSource(F,el.type,el.source,el.scope).reloadTile(el,eh)}abortTile(F,el,eh){this.getWorkerSource(F,el.type,el.source,el.scope).abortTile(el,eh)}removeTile(F,el,eh){this.getWorkerSource(F,el.type,el.source,el.scope).removeTile(el,eh)}removeSource(F,el,eh){if(!(this.workerSources[F]&&this.workerSources[F][el.scope]&&this.workerSources[F][el.scope][el.type]&&this.workerSources[F][el.scope][el.type][el.source]))return;let ec=this.workerSources[F][el.scope][el.type][el.source];delete this.workerSources[F][el.scope][el.type][el.source],void 0!==ec.removeSource?ec.removeSource(el,eh):eh()}loadWorkerSource(F,el,eh){try{this.self.importScripts(el.url),eh()}catch(F){eh(F.toString())}}syncRTLPluginState(el,eh,ec){try{F.em.setState(eh);let el=F.em.getPluginURL();if(F.em.isLoaded()&&!F.em.isParsed()&&null!=el){this.self.importScripts(el);let eh=F.em.isParsed();ec(eh?void 0:Error(`RTL Text Plugin failed to import scripts from ${el}`),eh)}}catch(F){ec(F.toString())}}setDracoUrl(F,el){this.dracoUrl=el}getAvailableImages(F,el){this.availableImages[F]||(this.availableImages[F]={});let eh=this.availableImages[F][el];return eh||(eh=[]),eh}getLayerIndex(F,el){this.layerIndexes[F]||(this.layerIndexes[F]={});let eh=this.layerIndexes[F][el];return eh||((eh=this.layerIndexes[F][el]=new o).scope=el),eh}getWorkerSource(F,el,eh,ec){let ep=this.workerSources;return ep[F]||(ep[F]={}),ep[F][ec]||(ep[F][ec]={}),ep[F][ec][el]||(ep[F][ec][el]={}),this.isSpriteLoaded[F]||(this.isSpriteLoaded[F]={}),ep[F][ec][el][eh]||(ep[F][ec][el][eh]=new this.workerSourceTypes[el]({send:(el,eh,ec,ep,e_,eg)=>{this.actor.send(el,eh,ec,F,e_,eg)},scheduler:this.actor.scheduler},this.getLayerIndex(F,ec),this.getAvailableImages(F,ec),this.isSpriteLoaded[F][ec],void 0,this.brightness)),ep[F][ec][el][eh]}rasterizeImages(F,el,eh){let ec=new Map;for(let[eh,{image:ep,imageVariant:e_}]of el.tasks.entries()){let eg=this.imageRasterizer.rasterize(e_,ep,el.scope,F);ec.set(eh,eg)}eh(void 0,ec)}removeRasterizedImages(F,el,eh){this.imageRasterizer.removeImagesFromCacheByIds(el.imageIds,el.scope,F),eh()}enforceCacheSizeLimit(el,eh){F.en(eh)}getWorkerPerformanceMetrics(F,el,eh){eh(void 0,void 0)}};return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new Ie(self)),Ie}),define(["./shared"],function(F){let el,eh,ec;var ep="3.11.0";let e_={create:"create",load:"load",fullLoad:"fullLoad"},eg={mark(F){performance.mark(F)},measure(F,el,eh){performance.measure(F,el,eh)}};function s(el){let eh=el.name.split("?")[0];return F.a(eh)&&eh.includes("mapbox-gl.js")?"javascript":F.a(eh)&&eh.includes("mapbox-gl.css")?"css":F.b(eh)?"fontRange":F.c(eh)?"sprite":F.i(eh)?"style":F.d(eh)?"tilejson":"other"}var ey,eb={},ew=function(){if(ey)return eb;function e(F){return!t(F)}function t(el){var eh;return"undefined"==typeof window||"undefined"==typeof document?"not a browser":!function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var F,el,eh=new Blob([""],{type:"text/javascript"}),ec=URL.createObjectURL(eh);try{el=new Worker(ec),F=!0}catch(el){F=!1}return el&&el.terminate(),URL.revokeObjectURL(ec),F}()?"insufficient worker support":!function(){var F=document.createElement("canvas");F.width=F.height=1;var el=F.getContext("2d");if(!el)return!1;var eh=el.getImageData(0,0,1,1);return eh&&eh.width===F.width}()?"insufficient Canvas/getImageData support":(void 0===F[eh=el&&el.failIfMajorPerformanceCaveat]&&(F[eh]=function(F){var el,eh,ec,ep=(el=document.createElement("canvas"),(eh=Object.create(e.webGLContextAttributes)).failIfMajorPerformanceCaveat=F,el.getContext("webgl2",eh));if(!ep)return!1;try{ec=ep.createShader(ep.VERTEX_SHADER)}catch(F){return!1}return!(!ec||ep.isContextLost())&&(ep.shaderSource(ec,"void main() {}"),ep.compileShader(ec),!0===ep.getShaderParameter(ec,ep.COMPILE_STATUS))}(eh)),F[eh]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support")}ey=1,eb.supported=e,eb.notSupportedReason=t;var F={};return e.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},eb}();function l(F,el,eh){let ec=document.createElement(F);return null!=el&&(ec.className=el),eh&&eh.appendChild(ec),ec}function c(F,el,eh){let ec=document.createElementNS("http://www.w3.org/2000/svg",F);for(let F of Object.keys(el))ec.setAttributeNS(null,F,String(el[F]));return eh&&eh.appendChild(ec),ec}let eT="undefined"!=typeof document?document.documentElement&&document.documentElement.style:null,eS=eT&&void 0!==eT.userSelect?"userSelect":"WebkitUserSelect";function _(){eT&&eS&&(el=eT[eS],eT[eS]="none")}function p(){eT&&eS&&(eT[eS]=el)}function f(F){F.preventDefault(),F.stopPropagation(),window.removeEventListener("click",f,!0)}function m(){window.addEventListener("click",f,!0),window.setTimeout(()=>{window.removeEventListener("click",f,!0)},0)}function g(F,el){let eh=F.getBoundingClientRect();return x(F,eh,el)}function v(F,el){let eh=F.getBoundingClientRect(),ec=[];for(let ep=0;ep<el.length;ep++)ec.push(x(F,eh,el[ep]));return ec}function y(F){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===F.button&&F.ctrlKey?0:F.button}function x(el,eh,ec){let ep=el.offsetWidth===eh.width?1:el.offsetWidth/eh.width;return new F.P((ec.clientX-eh.left)*ep,(ec.clientY-eh.top)*ep)}let eE="NO_ACCESS_TOKEN";let T=class T{constructor(F,el,eh){this._transformRequestFn=F,this._customAccessToken=el,this._silenceAuthErrors=!!eh,this._createSkuToken()}_createSkuToken(){let F=function(){let F="";for(let el=0;el<10;el++)F+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1","01",F].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=F.token,this._skuTokenExpiresAt=F.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(F,el){return this._transformRequestFn&&this._transformRequestFn(F,el)||{url:F}}normalizeStyleURL(el,eh){if(!F.f(el))return el;let ec=S(el);return ec.params.push(`sdk=js-${ep}`),ec.path=`/styles/v1${ec.path}`,this._makeAPIURL(ec,this._customAccessToken||eh)}normalizeGlyphsURL(el,eh){if(!F.f(el))return el;let ec=S(el);return ec.path=`/fonts/v1${ec.path}`,this._makeAPIURL(ec,this._customAccessToken||eh)}normalizeModelURL(el,eh){if(!F.f(el))return el;let ec=S(el);return ec.path=`/models/v1${ec.path}`,this._makeAPIURL(ec,this._customAccessToken||eh)}normalizeSourceURL(el,eh,ec,ep){if(!F.f(el))return el;let e_=S(el);return e_.path=`/v4/${e_.authority}.json`,e_.params.push("secure"),ec&&e_.params.push(`language=${ec}`),ep&&e_.params.push(`worldview=${ep}`),this._makeAPIURL(e_,this._customAccessToken||eh)}normalizeIconsetURL(el,eh){let ec=S(el);return F.f(el)?(ec.path=`/styles/v1${ec.path}/iconset.pbf`,this._makeAPIURL(ec,this._customAccessToken||eh)):C(ec)}normalizeSpriteURL(el,eh,ec,ep){let e_=S(el);return F.f(el)?(e_.path=`/styles/v1${e_.path}/sprite${eh}${ec}`,this._makeAPIURL(e_,this._customAccessToken||ep)):(e_.path+=`${eh}${ec}`,C(e_))}normalizeTileURL(el,eh,ec){if(this._isSkuTokenExpired()&&this._createSkuToken(),el&&!F.f(el))return el;let ep=S(el);ep.path=ep.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${eh||ec&&"raster"!==ep.authority&&512===ec?"@2x":""}${F.m.supported?".webp":"$1"}`),"raster"===ep.authority?ep.path=`/${F.e.RASTER_URL_PREFIX}${ep.path}`:"rasterarrays"===ep.authority?ep.path=`/${F.e.RASTERARRAYS_URL_PREFIX}${ep.path}`:"3dtiles"===ep.authority?ep.path=`/${F.e.TILES3D_URL_PREFIX}${ep.path}`:(ep.path=ep.path.replace(/^.+\/v4\//,"/"),ep.path=`/${F.e.TILE_URL_VERSION}${ep.path}`);let e_=this._customAccessToken||function(F){for(let el of F){let F=el.match(/^access_token=(.*)$/);if(F)return F[1]}return null}(ep.params)||F.e.ACCESS_TOKEN;return F.e.REQUIRE_ACCESS_TOKEN&&e_&&this._skuToken&&ep.params.push(`sku=${this._skuToken}`),this._makeAPIURL(ep,e_)}canonicalizeTileURL(el,eh){let ec=S(el);if(!ec.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!ec.path.match(/\.[\w]+$/))return el;let ep="mapbox://";ec.path.match(/^\/raster\/v1\//)?ep+=`raster/${ec.path.replace(`/${F.e.RASTER_URL_PREFIX}/`,"")}`:ec.path.match(/^\/rasterarrays\/v1\//)?ep+=`rasterarrays/${ec.path.replace(`/${F.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:ep+=`tiles/${ec.path.replace(`/${F.e.TILE_URL_VERSION}/`,"")}`;let e_=ec.params;return eh&&(e_=e_.filter(F=>!F.match(/^access_token=/))),e_.length&&(ep+=`?${e_.join("&")}`),ep}canonicalizeTileset(el,eh){let ec=!!eh&&F.f(eh),ep=[];for(let eh of el.tiles||[])F.h(eh)?ep.push(this.canonicalizeTileURL(eh,ec)):ep.push(eh);return ep}_makeAPIURL(el,eh){let ec="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",ep=S(F.e.API_URL);if(el.protocol=ep.protocol,el.authority=ep.authority,"http"===el.protocol){let F=el.params.indexOf("secure");F>=0&&el.params.splice(F,1)}if("/"!==ep.path&&(el.path=`${ep.path}${el.path}`),!F.e.REQUIRE_ACCESS_TOKEN)return C(el);if(eh=eh||F.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!eh)throw Error(`An API access token is required to use Mapbox GL. ${ec}`);if("s"===eh[0])throw Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${ec}`)}return el.params=el.params.filter(F=>-1===F.indexOf("access_token")),el.params.push(`access_token=${eh||""}`),C(el)}};let eM=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function S(F){let el=F.match(eM);if(!el)throw Error("Unable to parse URL object");return{protocol:el[1],authority:el[2],path:el[3]||"/",params:el[4]?el[4].split("&"):[]}}function C(F){let el=F.params.length?`?${F.params.join("&")}`:"";return`${F.protocol}://${F.authority}${F.path}${el}`}let eI="mapbox.eventData";function R(el){if(!el)return null;let eh=el.split(".");if(!eh||3!==eh.length)return null;try{return JSON.parse(F.j(eh[1]))}catch(F){return null}}let D=class D{constructor(F){this.type=F,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(el){let eh=R(F.e.ACCESS_TOKEN),ec="";return ec=eh&&eh.u?F.k(eh.u):F.e.ACCESS_TOKEN||"",el?`${eI}.${el}:${ec}`:`${eI}:${ec}`}fetchEventData(){let el=F.s("localStorage"),eh=this.getStorageKey(),ec=this.getStorageKey("uuid");if(el)try{let F=localStorage.getItem(eh);F&&(this.eventData=JSON.parse(F));let el=localStorage.getItem(ec);el&&(this.anonId=el)}catch(el){F.w("Unable to read from LocalStorage")}}saveEventData(){let el=F.s("localStorage"),eh=this.getStorageKey(),ec=this.getStorageKey("uuid"),ep=this.anonId;if(el&&ep)try{localStorage.setItem(ec,ep),Object.keys(this.eventData).length>=1&&localStorage.setItem(eh,JSON.stringify(this.eventData))}catch(el){F.w("Unable to write to LocalStorage")}}processRequests(F){}postEvent(el,eh,ec,ep){if(!F.e.EVENTS_URL)return;let e_=S(F.e.EVENTS_URL);e_.params.push(`access_token=${ep||F.e.ACCESS_TOKEN||""}`);let eg={event:this.type,created:new Date(el).toISOString()},ey=eh?F.l(eg,eh):eg,eb={url:C(e_),headers:{"Content-Type":"text/plain"},body:JSON.stringify([ey])};this.pendingRequest=F.p(eb,F=>{this.pendingRequest=null,ec(F),this.saveEventData(),this.processRequests(ep)})}queueRequest(F,el){this.queue.push(F),this.processRequests(el)}};let eA=new class extends D{constructor(F){super("appUserTurnstile"),this._customAccessToken=F}postTurnstileEvent(el,eh){F.e.EVENTS_URL&&F.e.ACCESS_TOKEN&&Array.isArray(el)&&el.some(el=>F.f(el)||F.h(el))&&this.queueRequest(Date.now(),eh)}processRequests(el){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();let eh=R(F.e.ACCESS_TOKEN),ec=eh?eh.u:F.e.ACCESS_TOKEN,e_=ec!==this.eventData.tokenU;F.v(this.anonId)||(this.anonId=F.u(),e_=!0);let eg=this.queue.shift();if(this.eventData.lastSuccess){let F=new Date(this.eventData.lastSuccess),el=new Date(eg),eh=(eg-this.eventData.lastSuccess)/864e5;e_=e_||eh>=1||eh<-1||F.getDate()!==el.getDate()}else e_=!0;e_?this.postEvent(eg,{sdkIdentifier:"mapbox-gl-js",sdkVersion:ep,skuId:"01","enabled.telemetry":!1,userId:this.anonId},F=>{F||(this.eventData.lastSuccess=eg,this.eventData.tokenU=ec)},el):this.processRequests()}},eC=eA.postTurnstileEvent.bind(eA),eP=new class extends D{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(el,eh,ec,ep){this.skuToken=eh,this.errorCb=ep,F.e.EVENTS_URL&&(ec||F.e.ACCESS_TOKEN?this.queueRequest({id:el,timestamp:Date.now()},ec):this.errorCb(Error(eE)))}processRequests(el){if(this.pendingRequest||0===this.queue.length)return;let{id:eh,timestamp:ec}=this.queue.shift();eh&&this.success[eh]||(this.anonId||this.fetchEventData(),F.v(this.anonId)||(this.anonId=F.u()),this.postEvent(ec,{sdkIdentifier:"mapbox-gl-js",sdkVersion:ep,skuId:"01",skuToken:this.skuToken,userId:this.anonId},F=>{F?this.errorCb(F):eh&&(this.success[eh]=!0)},el))}remove(){this.errorCb=null}},ez=eP.postMapLoadEvent.bind(eP),eD=new class extends D{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(el){let eh=this.mapInstanceIdMap.get(el);return eh||(eh=F.u(),this.mapInstanceIdMap.set(el,eh)),eh}getEventId(F){let el=this.eventIdPerMapInstanceMap.get(F)||0;return this.eventIdPerMapInstanceMap.set(F,el+1),el}postStyleLoadEvent(el,eh){let{map:ec,style:ep,importedStyles:e_}=eh;if(!F.e.EVENTS_URL||!el&&!F.e.ACCESS_TOKEN)return;let eg=this.getMapInstanceId(ec),ey={mapInstanceId:eg,eventId:this.getEventId(eg),style:ep};e_.length&&(ey.importedStyles=e_),this.queueRequest({timestamp:Date.now(),payload:ey},el)}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;let{timestamp:el,payload:eh}=this.queue.shift();this.postEvent(el,eh,()=>{},F)}},eR=eD.postStyleLoadEvent.bind(eD),eL=new class extends D{constructor(){super("gljs.performance")}postPerformanceEvent(el,eh){F.e.EVENTS_URL&&(el||F.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:eh},el)}processRequests(el){if(this.pendingRequest||0===this.queue.length)return;let{timestamp:eh,performanceData:ec}=this.queue.shift(),eg=function(el){let eh=performance.getEntriesByType("resource"),ec=performance.getEntriesByType("mark"),eg=function(F){let el={};if(F){for(let eh in F)if("other"!==eh)for(let ec of F[eh]){let F=`${eh}ResolveRangeMin`,ep=`${eh}ResolveRangeMax`,e_=`${eh}RequestCount`,eg=`${eh}RequestCachedCount`;el[F]=Math.min(el[F]||1/0,ec.startTime),el[ep]=Math.max(el[ep]||-1/0,ec.responseEnd);let a=F=>{void 0===el[F]&&(el[F]=0),++el[F]};void 0!==ec.transferSize&&0===ec.transferSize&&a(eg),a(e_)}}return el}(function(F,el){let eh={};if(F)for(let ec of F){let F=el(ec);void 0===eh[F]&&(eh[F]=[]),eh[F].push(ec)}return eh}(eh,s)),ey=window.devicePixelRatio,eb=navigator.connection||navigator.mozConnection||navigator.webkitConnection,ew=eb?eb.effectiveType:void 0,eT={counters:[],metadata:[],attributes:[]},u=(F,el,eh)=>{null!=eh&&F.push({name:el,value:eh.toString()})};for(let F in eg)u(eT.counters,F,eg[F]);if(el.interactionRange[0]!==1/0&&el.interactionRange[1]!==-1/0&&(u(eT.counters,"interactionRangeMin",el.interactionRange[0]),u(eT.counters,"interactionRangeMax",el.interactionRange[1])),ec)for(let F of Object.keys(e_)){let el=e_[F],eh=ec.find(F=>F.name===el);eh&&u(eT.counters,el,eh.startTime)}return u(eT.counters,"visibilityHidden",el.visibilityHidden),u(eT.attributes,"style",function(el){if(el)for(let eh of el){let el=eh.name.split("?")[0];if(F.i(el)){let F=el.split("/").slice(-2);if(2===F.length)return`mapbox://styles/${F[0]}/${F[1]}`}}}(eh)),u(eT.attributes,"terrainEnabled",el.terrainEnabled?"true":"false"),u(eT.attributes,"fogEnabled",el.fogEnabled?"true":"false"),u(eT.attributes,"projection",el.projection),u(eT.attributes,"zoom",el.zoom),u(eT.metadata,"devicePixelRatio",ey),u(eT.metadata,"connectionEffectiveType",ew),u(eT.metadata,"navigatorUserAgent",navigator.userAgent),u(eT.metadata,"screenWidth",window.screen.width),u(eT.metadata,"screenHeight",window.screen.height),u(eT.metadata,"windowWidth",window.innerWidth),u(eT.metadata,"windowHeight",window.innerHeight),u(eT.metadata,"mapWidth",el.width/ey),u(eT.metadata,"mapHeight",el.height/ey),u(eT.metadata,"webglRenderer",el.renderer),u(eT.metadata,"webglVendor",el.vendor),u(eT.metadata,"sdkVersion",ep),u(eT.metadata,"sdkIdentifier","mapbox-gl-js"),eT}(ec);for(let F of eg.metadata);for(let F of eg.counters);for(let F of eg.attributes);this.postEvent(eh,eg,()=>{},el)}},eO=eL.postPerformanceEvent.bind(eL),ek=new class extends D{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(el,eh,ec,ep){if(!F.e.API_URL||!F.e.SESSION_PATH)return;let e_=S(F.e.API_URL+F.e.SESSION_PATH);e_.params.push(`sku=${eh||""}`),e_.params.push(`access_token=${ep||F.e.ACCESS_TOKEN||""}`);let eg={url:C(e_),headers:{"Content-Type":"text/plain"}};this.pendingRequest=F.g(eg,F=>{this.pendingRequest=null,ec(F),this.saveEventData(),this.processRequests(ep)})}getSessionAPI(el,eh,ec,ep){this.skuToken=eh,this.errorCb=ep,F.e.SESSION_PATH&&F.e.API_URL&&(ec||F.e.ACCESS_TOKEN?this.queueRequest({id:el,timestamp:Date.now()},ec):this.errorCb(Error(eE)))}processRequests(F){if(this.pendingRequest||0===this.queue.length)return;let{id:el,timestamp:eh}=this.queue.shift();el&&this.success[el]||this.getSession(eh,this.skuToken,F=>{F?this.errorCb(F):el&&(this.success[el]=!0)},F)}remove(){this.errorCb=null}},eF=ek.getSessionAPI.bind(ek),eB=new Set;function V(F,el){el?eB.add(F):eB.delete(F)}let G=class G{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(F,el){this._updatedSourceCaches[F]=el,this.setDirty()}discardSourceCacheUpdate(F){delete this._updatedSourceCaches[F]}updateLayer(F){let el=F.scope;this._updatedLayers[el]=this._updatedLayers[el]||new Set,this._updatedLayers[el].add(F.id),this.setDirty()}removeLayer(F){let el=F.scope;this._removedLayers[el]=this._removedLayers[el]||{},this._updatedLayers[el]=this._updatedLayers[el]||new Set,this._removedLayers[el][F.id]=F,this._updatedLayers[el].delete(F.id),this._updatedPaintProps.delete(F.fqid),this.setDirty()}getRemovedLayer(F){return this._removedLayers[F.scope]?this._removedLayers[F.scope][F.id]:null}discardLayerRemoval(F){this._removedLayers[F.scope]&&delete this._removedLayers[F.scope][F.id]}getLayerUpdatesByScope(){let F={};for(let el in this._updatedLayers)F[el]=F[el]||{},F[el].updatedIds=Array.from(this._updatedLayers[el].values());for(let el in this._removedLayers)F[el]=F[el]||{},F[el].removedIds=Object.keys(this._removedLayers[el]);return F}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(F){this._updatedPaintProps.add(F.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(el){this._updatedImages.add(F.I.toString(el)),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}};let q=class q extends F.E{constructor(el){super(),this._images={},this._iconsets={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.patternsInFlight=new Set,this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=el,"raster"!==el&&F.t()&&(this.imageRasterizerDispatcher=new F.D(F.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new F.y),this._imageRasterizer}createScope(el){this._images[el]={},this._iconsets[el]={},this.loaded[el]=!1,this.updatedImages[el]=new Set,this.patterns[el]={},this.callbackDispatchedThisFrame[el]=new Set,this.atlasImage[el]=new F.r({width:1,height:1})}createIconset(F,el){this._iconsets[F][el]={}}isLoaded(){for(let F in this.loaded)if(!this.loaded[F])return!1;return!0}setLoaded(F,el){if(this.loaded[el]!==F&&(this.loaded[el]=F,F)){for(let{ids:F,callback:eh}of this.requestors)this._notify(F,el,eh);this.requestors=[]}}hasImage(F,el){return!!this.getImage(F,el)}getImage(F,el){return(F.iconsetId?this._iconsets[el][F.iconsetId]:this._images[el])[F.name]}addImage(F,el,eh){let ec=F.iconsetId?this._iconsets[el][F.iconsetId]:this._images[el];this._validate(F,eh)&&(ec[F.name]=eh)}_validate(el,eh){let ec=!0;return this._validateStretch(eh.stretchX,eh.data&&eh.data.width)||(this.fire(new F.z(Error(`Image "${el.name}" has invalid "stretchX" value`))),ec=!1),this._validateStretch(eh.stretchY,eh.data&&eh.data.height)||(this.fire(new F.z(Error(`Image "${el.name}" has invalid "stretchY" value`))),ec=!1),this._validateContent(eh.content,eh)||(this.fire(new F.z(Error(`Image "${el.name}" has invalid "content" value`))),ec=!1),ec}_validateStretch(F,el){if(!F)return!0;let eh=0;for(let ec of F){if(ec[0]<eh||ec[1]<ec[0]||el<ec[1])return!1;eh=ec[1]}return!0}_validateContent(F,el){return!F||4===F.length&&(!!el.usvg||!(F[0]<0)&&!(el.data.width<F[0])&&!(F[1]<0)&&!(el.data.height<F[1])&&!(F[2]<0)&&!(el.data.width<F[2])&&!(F[3]<0)&&!(el.data.height<F[3]))&&!(F[2]<F[0]||F[3]<F[1])}updateImage(F,el,eh){let ec=F.iconsetId?this._iconsets[el][F.iconsetId]:this._images[el];eh.version=ec[F.name].version+1,ec[F.name]=eh,this.updatedImages[el].add(F),this.removeFromImageRasterizerCache(F,el)}clearUpdatedImages(F){this.updatedImages[F].clear()}removeFromImageRasterizerCache(el,eh){"raster"!==this.spriteFormat&&(F.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[el],scope:eh}):this.imageRasterizer.removeImagesFromCacheByIds([el],eh))}removeImage(F,el){let eh=F.iconsetId?this._iconsets[el][F.iconsetId]:this._images[el],ec=eh[F.name];delete eh[F.name],delete this.patterns[el][F.name],this.removeFromImageRasterizerCache(F,el),ec.userImage&&ec.userImage.onRemove&&ec.userImage.onRemove()}listImages(el){let eh=[];for(let ec of Object.keys(this._images[el]))eh.push(new F.I(ec));for(let ec in this._iconsets[el])for(let ep of Object.keys(this._iconsets[el][ec]))eh.push(new F.I({name:ep,iconsetId:ec}));return eh}getImages(F,el,eh){let ec=!0,ep=!!this.loaded[el];if(!ep)for(let eh of F)(eh.iconsetId?this._iconsets[el][eh.iconsetId]:this._images[el])[eh.name]||(ec=!1);ep||ec?this._notify(F,el,eh):this.requestors.push({ids:F,scope:el,callback:eh})}rasterizeImages({scope:F,tasks:el},eh){let ec=new Map;for(let[eh,ep]of el.entries()){let el=this.getImage(ep.id,F);el&&ec.set(eh,{image:el,imageVariant:ep})}this._rasterizeImages(F,ec,eh)}_rasterizeImages(el,eh,ec){if(F.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{tasks:eh,scope:el},ec);else{let F=new Map;for(let[ec,{image:ep,imageVariant:e_}]of eh.entries())F.set(ec,this.imageRasterizer.rasterize(e_,ep,el,0));ec(void 0,F)}}getUpdatedImages(F){return this.updatedImages[F]||new Set}_notify(el,eh,ec){let ep=new Map;for(let ec of el){ec.iconsetId&&(this._iconsets[eh][ec.iconsetId]=this._iconsets[eh][ec.iconsetId]||{});let el=(ec.iconsetId?this._iconsets[eh][ec.iconsetId]:this._images[eh])[ec.name];if(!el){if(ec.iconsetId)continue;F.w(`Image "${ec.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`),this.fire(new F.A("styleimagemissing",{id:ec.name}));continue}let e_={data:el.usvg?null:el.data.clone(),pixelRatio:el.pixelRatio,sdf:el.sdf,usvg:el.usvg,version:el.version,stretchX:el.stretchX,stretchY:el.stretchY,content:el.content,hasRenderCallback:!!(el.userImage&&el.userImage.render)};el.usvg&&Object.assign(e_,{width:el.icon.usvg_tree.width,height:el.icon.usvg_tree.height}),ep.set(F.I.toString(ec),e_)}ec(null,ep)}getPixelSize(F){let{width:el,height:eh}=this.atlasImage[F];return{width:el,height:eh}}getPattern(el,eh,ec){let ep=this.patterns[eh][el.name],e_=this.getImage(el,eh);if(!e_)return null;if(ep){if(ep.position.version===e_.version)return ep.position;ep.position.version=e_.version}else{if(e_.usvg&&!e_.data){let ep=this.getPatternInFlightId(el.toString(),eh);if(this.patternsInFlight.has(ep))return null;this.patternsInFlight.add(ep);let eg=new F.B(el).scaleSelf(F.q.devicePixelRatio),ey=new Map([[eg.toString(),{image:e_,imageVariant:eg}]]);return this._rasterizeImages(eh,ey,(F,el)=>this.storePatternImage(eg,eh,e_,ec,el)),null}this.storePattern(el,eh,e_)}return this._updatePatternAtlas(eh,ec),this.patterns[eh][el.name].position}getPatternInFlightId(el,eh){return F.C(el,eh)}hasPatternsInFlight(){return 0!==this.patternsInFlight.size}storePatternImage(F,el,eh,ec,ep){let e_=F.toString(),eg=ep?ep.get(e_):void 0;eg&&(eh.data=eg,this.storePattern(F.id,el,eh),this._updatePatternAtlas(el,ec),this.patternsInFlight.delete(this.getPatternInFlightId(F.id.toString(),el)))}storePattern(el,eh,ec){let ep={w:ec.data.width+2*F.F,h:ec.data.height+2*F.F,x:0,y:0},e_=new F.G(ep,ec,F.F);this.patterns[eh][el.name]={bin:ep,position:e_}}bind(el,eh){let ec=el.gl,ep=this.atlasTexture[eh];ep?this.dirty&&(ep.update(this.atlasImage[eh]),this.dirty=!1):(ep=new F.T(el,this.atlasImage[eh],ec.RGBA8),this.atlasTexture[eh]=ep),ep.bind(ec.LINEAR,ec.CLAMP_TO_EDGE)}_updatePatternAtlas(el,eh){let ec=[];for(let F in this.patterns[el])ec.push(this.patterns[el][F].bin);let{w:ep,h:e_}=F.H(ec),eg=this.atlasImage[el];for(let ec in eg.resize({width:ep||1,height:e_||1}),this.patterns[el]){let{bin:ep,position:e_}=this.patterns[el][ec],ey=e_.padding,eb=ep.x+ey,ew=ep.y+ey,eT=this._images[el][ec].data,eS=eT.width,eE=eT.height;ey=ey>1?ey-1:ey,F.r.copy(eT,eg,{x:0,y:0},{x:eb,y:ew},{width:eS,height:eE},eh),F.r.copy(eT,eg,{x:0,y:eE-ey},{x:eb,y:ew-ey},{width:eS,height:ey},eh),F.r.copy(eT,eg,{x:0,y:0},{x:eb,y:ew+eE},{width:eS,height:ey},eh),F.r.copy(eT,eg,{x:eS-ey,y:0},{x:eb-ey,y:ew},{width:ey,height:eE},eh),F.r.copy(eT,eg,{x:0,y:0},{x:eb+eS,y:ew},{width:ey,height:eE},eh),F.r.copy(eT,eg,{x:eS-ey,y:eE-ey},{x:eb-ey,y:ew-ey},{width:ey,height:ey},eh),F.r.copy(eT,eg,{x:0,y:eE-ey},{x:eb+eS,y:ew-ey},{width:ey,height:ey},eh),F.r.copy(eT,eg,{x:0,y:0},{x:eb+eS,y:ew+eE},{width:ey,height:ey},eh),F.r.copy(eT,eg,{x:eS-ey,y:0},{x:eb-ey,y:ew+eE},{width:ey,height:ey},eh)}this.dirty=!0}beginFrame(){for(let F in this._images)this.callbackDispatchedThisFrame[F]=new Set}dispatchRenderCallbacks(F,el){for(let eh of F){if(this.callbackDispatchedThisFrame[el].has(eh.toString()))continue;this.callbackDispatchedThisFrame[el].add(eh.toString());let F=(eh.iconsetId?this._iconsets[el][eh.iconsetId]:this._images[el])[eh.name];(function(F){let{userImage:el}=F;return!!(el&&el.render&&el.render())&&(F.data.replace(new Uint8Array(el.data.buffer)),!0)})(F)&&this.updateImage(eh,el,F)}}};function H(el){let eh=el.key,ec=el.value,ep=el.valueSpec||{},e_=el.objectElementValidators||{},eg=el.style,ey=el.styleSpec,eb=[],ew=F.K(ec);if("object"!==ew)return[new F.V(eh,ec,`object expected, ${ew} found`)];for(let el in ec){let ew;let eT=el.split(".")[0];e_[eT]?ew=e_[eT]:ep[eT]?ew=_e:e_["*"]?ew=e_["*"]:ep["*"]&&(ew=_e),ew?eb=eb.concat(ew({key:(eh?`${eh}.`:eh)+el,value:ec[el],valueSpec:ep[eT]||ep["*"],style:eg,styleSpec:ey,object:ec,objectKey:el},ec)):eb.push(new F.J(eh,ec[el],`unknown property "${el}"`))}for(let el in ep)e_[el]||ep[el].required&&void 0===ep[el].default&&void 0===ec[el]&&eb.push(new F.V(eh,ec,`missing required property "${el}"`));return eb}function Z(el){let eh=el.value,ec=el.valueSpec,ep=el.style,e_=el.styleSpec,eg=el.key,ey=el.arrayElementValidator||_e;if("array"!==F.K(eh))return[new F.V(eg,eh,`array expected, ${F.K(eh)} found`)];if(ec.length&&eh.length!==ec.length)return[new F.V(eg,eh,`array length ${ec.length} expected, length ${eh.length} found`)];if(ec["min-length"]&&eh.length<ec["min-length"])return[new F.V(eg,eh,`array length at least ${ec["min-length"]} expected, length ${eh.length} found`)];let eb={type:ec.value,values:ec.values,minimum:ec.minimum,maximum:ec.maximum,function:void 0};e_.$version<7&&(eb.function=ec.function),"object"===F.K(ec.value)&&(eb=ec.value);let ew=[];for(let F=0;F<eh.length;F++)ew=ew.concat(ey({array:eh,arrayIndex:F,value:eh[F],valueSpec:eb,style:ep,styleSpec:e_,key:`${eg}[${F}]`},!0));return ew}function W(el){let eh=el.key,ec=el.value,ep=el.valueSpec,e_=F.K(ec);if("number"===e_&&ec!=ec&&(e_="NaN"),"number"!==e_)return[new F.V(eh,ec,`number expected, ${e_} found`)];if("minimum"in ep){let e_=ep.minimum;if("array"===F.K(ep.minimum)&&(e_=ep.minimum[el.arrayIndex]),ec<e_)return[new F.V(eh,ec,`${ec} is less than the minimum value ${e_}`)]}if("maximum"in ep){let e_=ep.maximum;if("array"===F.K(ep.maximum)&&(e_=ep.maximum[el.arrayIndex]),ec>e_)return[new F.V(eh,ec,`${ec} is greater than the maximum value ${e_}`)]}return[]}function $(el){let eh=el.valueSpec,ec=F.M(el.value.type),ep,e_,eg,ey={},eb="categorical"!==ec&&void 0===el.value.property,ew="array"===F.K(el.value.stops)&&"array"===F.K(el.value.stops[0])&&"object"===F.K(el.value.stops[0][0]),eT=H({key:el.key,value:el.value,valueSpec:el.styleSpec.function,style:el.style,styleSpec:el.styleSpec,objectElementValidators:{stops:function(el){if("identity"===ec)return[new F.V(el.key,el.value,'identity function may not have a "stops" property')];let eh=[],ep=el.value;return eh=eh.concat(Z({key:el.key,value:ep,valueSpec:el.valueSpec,style:el.style,styleSpec:el.styleSpec,arrayElementValidator:u})),"array"===F.K(ep)&&0===ep.length&&eh.push(new F.V(el.key,ep,"array must have at least one stop")),eh},default:function(F){return _e({key:F.key,value:F.value,valueSpec:eh,style:F.style,styleSpec:F.styleSpec})}}});return"identity"===ec&&eb&&eT.push(new F.V(el.key,el.value,'missing required property "property"')),"identity"===ec||el.value.stops||eT.push(new F.V(el.key,el.value,'missing required property "stops"')),"exponential"===ec&&el.valueSpec.expression&&!F.N(el.valueSpec)&&eT.push(new F.V(el.key,el.value,"exponential functions not supported")),el.styleSpec.$version>=8&&(eb||F.O(el.valueSpec)?eb&&!F.Q(el.valueSpec)&&eT.push(new F.V(el.key,el.value,"zoom functions not supported")):eT.push(new F.V(el.key,el.value,"property functions not supported"))),("categorical"===ec||ew)&&void 0===el.value.property&&eT.push(new F.V(el.key,el.value,'"property" property is required')),eT;function u(el){let ec=[],ep=el.value,eb=el.key;if("array"!==F.K(ep))return[new F.V(eb,ep,`array expected, ${F.K(ep)} found`)];if(2!==ep.length)return[new F.V(eb,ep,`array length 2 expected, length ${ep.length} found`)];if(ew){if("object"!==F.K(ep[0]))return[new F.V(eb,ep,`object expected, ${F.K(ep[0])} found`)];if(void 0===ep[0].zoom)return[new F.V(eb,ep,"object stop key must have zoom")];if(void 0===ep[0].value)return[new F.V(eb,ep,"object stop key must have value")];let eh=F.M(ep[0].zoom);if("number"!=typeof eh)return[new F.V(eb,ep[0].zoom,"stop zoom values must be numbers")];if(eg&&eg>eh)return[new F.V(eb,ep[0].zoom,"stop zoom values must appear in ascending order")];eh!==eg&&(eg=eh,e_=void 0,ey={}),ec=ec.concat(H({key:`${eb}[0]`,value:ep[0],valueSpec:{zoom:{}},style:el.style,styleSpec:el.styleSpec,objectElementValidators:{zoom:W,value:_}}))}else ec=ec.concat(_({key:`${eb}[0]`,value:ep[0],valueSpec:{},style:el.style,styleSpec:el.styleSpec},ep));return F.S(F.U(ep[1]))?ec.concat([new F.V(`${eb}[1]`,ep[1],"expressions are not allowed in function stops.")]):ec.concat(_e({key:`${eb}[1]`,value:ep[1],valueSpec:eh,style:el.style,styleSpec:el.styleSpec}))}function _(el,eg){let eb=F.K(el.value),ew=F.M(el.value),eT=null!==el.value?el.value:eg;if(ep){if(eb!==ep)return[new F.V(el.key,eT,`${eb} stop domain type must match previous stop domain type ${ep}`)]}else ep=eb;if("number"!==eb&&"string"!==eb&&"boolean"!==eb&&"number"!=typeof ew&&"string"!=typeof ew&&"boolean"!=typeof ew)return[new F.V(el.key,eT,"stop domain value must be a number, string, or boolean")];if("number"!==eb&&"categorical"!==ec){let ep=`number expected, ${eb} found`;return F.O(eh)&&void 0===ec&&(ep+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new F.V(el.key,eT,ep)]}return"categorical"!==ec||"number"!==eb||"number"==typeof ew&&isFinite(ew)&&Math.floor(ew)===ew?"categorical"!==ec&&"number"===eb&&"number"==typeof ew&&"number"==typeof e_&&void 0!==e_&&ew<e_?[new F.V(el.key,eT,"stop domain values must appear in ascending order")]:(e_=ew,"categorical"===ec&&ew in ey?[new F.V(el.key,eT,"stop domain values must be unique")]:(ey[ew]=!0,[])):[new F.V(el.key,eT,`integer expected, found ${String(ew)}`)]}}function X(el){let eh=("property"===el.expressionContext?F.W:F.X)(F.U(el.value),el.valueSpec);if("error"===eh.result)return eh.value.map(eh=>new F.V(`${el.key}${eh.key}`,el.value,eh.message));let ec=eh.value.expression||eh.value._styleExpression.expression;if("property"===el.expressionContext&&"text-font"===el.propertyKey&&!ec.outputDefined())return[new F.V(el.key,el.value,`Invalid data expression for "${el.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===el.expressionContext&&"layout"===el.propertyType&&!F.Y(ec))return[new F.V(el.key,el.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===el.expressionContext)return function K(el,eh){let ec=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(eh.valueSpec&&eh.valueSpec.expression)for(let F of eh.valueSpec.expression.parameters)ec.delete(F);if(0===ec.size)return[];let ep=[];return el instanceof F.$&&ec.has(el.name)?[new F.V(eh.key,eh.value,`["${el.name}"] expression is not supported in a filter for a ${eh.object.type} layer with id: ${eh.object.id}`)]:(el.eachChild(F=>{ep.push(...K(F,eh))}),ep)}(ec,el);if(el.expressionContext&&0===el.expressionContext.indexOf("cluster")){if(!F.Z(ec,["zoom","feature-state"]))return[new F.V(el.key,el.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===el.expressionContext&&!F._(ec))return[new F.V(el.key,el.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Y(el){let eh=el.key,ec=el.value,ep=el.valueSpec,e_=[];return Array.isArray(ep.values)?-1===ep.values.indexOf(F.M(ec))&&e_.push(new F.V(eh,ec,`expected one of [${ep.values.join(", ")}], ${JSON.stringify(ec)} found`)):-1===Object.keys(ep.values).indexOf(F.M(ec))&&e_.push(new F.V(eh,ec,`expected one of [${Object.keys(ep.values).join(", ")}], ${JSON.stringify(ec)} found`)),e_}function J(el){return F.a1(F.U(el.value))?X(F.L({},el,{expressionContext:"filter",valueSpec:el.styleSpec[`filter_${el.layerType||"fill"}`]})):function Q(el){let eh=el.value,ec=el.key;if("array"!==F.K(eh))return[new F.V(ec,eh,`array expected, ${F.K(eh)} found`)];let ep=el.styleSpec,e_,eg=[];if(eh.length<1)return[new F.V(ec,eh,"filter array must have at least 1 element")];switch(eg=eg.concat(Y({key:`${ec}[0]`,value:eh[0],valueSpec:ep.filter_operator,style:el.style,styleSpec:el.styleSpec})),F.M(eh[0])){case"<":case"<=":case">":case">=":eh.length>=2&&"$type"===F.M(eh[1])&&eg.push(new F.V(ec,eh,`"$type" cannot be use with operator "${eh[0]}"`));case"==":case"!=":3!==eh.length&&eg.push(new F.V(ec,eh,`filter array for operator "${eh[0]}" must have 3 elements`));case"in":case"!in":eh.length>=2&&"string"!==(e_=F.K(eh[1]))&&eg.push(new F.V(`${ec}[1]`,eh[1],`string expected, ${e_} found`));for(let ey=2;ey<eh.length;ey++)e_=F.K(eh[ey]),"$type"===F.M(eh[1])?eg=eg.concat(Y({key:`${ec}[${ey}]`,value:eh[ey],valueSpec:ep.geometry_type,style:el.style,styleSpec:el.styleSpec})):"string"!==e_&&"number"!==e_&&"boolean"!==e_&&eg.push(new F.V(`${ec}[${ey}]`,eh[ey],`string, number, or boolean expected, ${e_} found`));break;case"any":case"all":case"none":for(let F=1;F<eh.length;F++)eg=eg.concat(Q({key:`${ec}[${F}]`,value:eh[F],style:el.style,styleSpec:el.styleSpec}));break;case"has":case"!has":e_=F.K(eh[1]),2!==eh.length?eg.push(new F.V(ec,eh,`filter array for "${eh[0]}" operator must have 2 elements`)):"string"!==e_&&eg.push(new F.V(`${ec}[1]`,eh[1],`string expected, ${e_} found`))}return eg}(el)}function ee(el,eh){let ec;let ep=el.key,e_=el.style,eg=el.layer,ey=el.styleSpec,eb=el.value,ew=el.objectKey,eT=ey[`${eh}_${el.layerType}`];if(!eT)return[];let eS=ew.match(/^(.*)-use-theme$/);if("paint"===eh&&eS&&eT[eS[1]])return F.S(eb)?[].concat(_e({key:el.key,value:eb,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:e_,styleSpec:ey,expressionContext:"property",propertyType:eh,propertyKey:ew})):_e({key:ep,value:eb,valueSpec:{type:"string"},style:e_,styleSpec:ey});let eE=ew.match(/^(.*)-transition$/);if("paint"===eh&&eE&&eT[eE[1]]&&eT[eE[1]].transition)return _e({key:ep,value:eb,valueSpec:ey.transition,style:e_,styleSpec:ey});let eM=el.valueSpec||eT[ew];if(!eM)return[new F.J(ep,eb,`unknown property "${ew}"`)];if("string"===F.K(eb)&&F.O(eM)&&!eM.tokens&&(ec=/^{([^}]+)}$/.exec(eb))){let el=`\`{ "type": "identity", "property": ${ec?JSON.stringify(ec[1]):'"_"'} }\``;return[new F.V(ep,eb,`"${ew}" does not support interpolation syntax
Use an identity property function instead: ${el}.`)]}let eI=[];if("symbol"===el.layerType)"text-field"!==ew||!e_||e_.glyphs||e_.imports||eI.push(new F.V(ep,eb,'use of "text-field" requires a style "glyphs" property')),"text-font"===ew&&F.a2(F.U(eb))&&"identity"===F.M(eb.type)&&eI.push(new F.V(ep,eb,'"text-font" does not support identity functions'));else if("model"===el.layerType&&"paint"===eh&&eg&&eg.layout&&eg.layout.hasOwnProperty("model-id")&&F.O(eM)&&(F.a3(eM)||F.Q(eM))){let el=F.W(F.U(eb),eM),eh=el.value.expression||el.value._styleExpression.expression;eh&&!F.Z(eh,["measure-light"])&&("model-emissive-strength"===ew&&F._(eh)&&F.Y(eh)||eI.push(new F.V(ep,eb,`${ew} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return eI.concat(_e({key:el.key,value:eb,valueSpec:eM,style:e_,styleSpec:ey,expressionContext:"property",propertyType:eh,propertyKey:ew}))}function te(F){return ee(F,"paint")}function ie(F){return ee(F,"layout")}function oe(el){let eh=[],ec=el.value,ep=el.key,e_=el.style,eg=el.styleSpec;ec.type||ec.ref||eh.push(new F.V(ep,ec,'either "type" or "ref" is required'));let ey=F.M(ec.type),eb=F.M(ec.ref);if(ec.id){let eg=F.M(ec.id);for(let ey=0;ey<el.arrayIndex;ey++){let el=e_.layers[ey];F.M(el.id)===eg&&eh.push(new F.V(ep,ec.id,`duplicate layer id "${ec.id}", previously used at line ${el.id.__line__}`))}}if("ref"in ec){let el;["type","source","source-layer","filter","layout"].forEach(el=>{el in ec&&eh.push(new F.V(ep,ec[el],`"${el}" is prohibited for ref layers`))}),e_.layers.forEach(eh=>{F.M(eh.id)===eb&&(el=eh)}),el?el.ref?eh.push(new F.V(ep,ec.ref,"ref cannot reference another ref layer")):ey=F.M(el.type):"string"==typeof eb&&eh.push(new F.V(ep,ec.ref,`ref layer "${eb}" not found`))}else if("background"!==ey&&"sky"!==ey&&"slot"!==ey){if(ec.source){let el=e_.sources&&e_.sources[ec.source],eg=el&&F.M(el.type);el?"vector"===eg&&"raster"===ey?eh.push(new F.V(ep,ec.source,`layer "${ec.id}" requires a raster source`)):"raster"===eg&&"raster"!==ey?eh.push(new F.V(ep,ec.source,`layer "${ec.id}" requires a vector source`)):"vector"!==eg||ec["source-layer"]?"raster-dem"===eg&&"hillshade"!==ey?eh.push(new F.V(ep,ec.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==eg||["raster","raster-particle"].includes(ey)?"line"===ey&&ec.paint&&(ec.paint["line-gradient"]||ec.paint["line-trim-offset"])&&("geojson"!==eg||!el.lineMetrics)?eh.push(new F.V(ep,ec,`layer "${ec.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):"raster-particle"===ey&&"raster-array"!==eg&&eh.push(new F.V(ep,ec.source,`layer "${ec.id}" requires a 'raster-array' source.`)):eh.push(new F.V(ep,ec.source,"raster-array source can only be used with layer type 'raster'.")):eh.push(new F.V(ep,ec,`layer "${ec.id}" must specify a "source-layer"`)):eh.push(new F.V(ep,ec.source,`source "${ec.source}" not found`))}else eh.push(new F.V(ep,ec,'missing required property "source"'))}return eh=eh.concat(H({key:ep,value:ec,valueSpec:eg.layer,style:el.style,styleSpec:el.styleSpec,objectElementValidators:{"*":()=>[],type:()=>_e({key:`${ep}.type`,value:ec.type,valueSpec:eg.layer.type,style:el.style,styleSpec:el.styleSpec,object:ec,objectKey:"type"}),filter:el=>J(F.L({layerType:ey},el)),layout:el=>H({layer:ec,key:el.key,value:el.value,valueSpec:{},style:el.style,styleSpec:el.styleSpec,objectElementValidators:{"*":el=>ie(F.L({layerType:ey},el))}}),paint:el=>H({layer:ec,key:el.key,value:el.value,valueSpec:{},style:el.style,styleSpec:el.styleSpec,objectElementValidators:{"*":el=>te(F.L({layerType:ey,layer:ec},el))}})}}))}function se(el){let eh=el.value,ec=el.key,ep=F.K(eh);return"string"!==ep?[new F.V(ec,eh,`string expected, ${ep} found`)]:[]}let eN={promoteId:function t({key:el,value:eh}){if("string"===F.K(eh))return se({key:el,value:eh});if(Array.isArray(eh)){let ec=[],ep=F.U(eh),e_=F.X(ep);return"error"===e_.result&&e_.value.forEach(eh=>{ec.push(new F.V(`${el}${eh.key}`,null,`${eh.message}`))}),F.Z(e_.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||ec.push(new F.V(`${el}`,null,"promoteId expression should be only feature dependent")),ec}{let F=[];for(let ec in eh)F.push(...t({key:`${el}.${ec}`,value:eh[ec]}));return F}}};function ne(el){let eh=el.value,ec=el.key,ep=el.styleSpec,e_=el.style;if(!eh.type)return[new F.V(ec,eh,'"type" is required')];let eg=F.M(eh.type),ey=[];switch(["vector","raster","raster-dem","raster-array"].includes(eg)&&(eh.url||eh.tiles||ey.push(new F.J(ec,eh,'Either "url" or "tiles" is required.'))),eg){case"vector":case"raster":case"raster-dem":case"raster-array":return ey.concat(H({key:ec,value:eh,valueSpec:ep[`source_${eg.replace("-","_")}`],style:el.style,styleSpec:ep,objectElementValidators:eN}));case"geojson":if(ey=H({key:ec,value:eh,valueSpec:ep.source_geojson,style:e_,styleSpec:ep,objectElementValidators:eN}),eh.cluster)for(let F in eh.clusterProperties){let[el,ep]=eh.clusterProperties[F],e_="string"==typeof el?[el,["accumulated"],["get",F]]:el;ey.push(...X({key:`${ec}.${F}.map`,value:ep,expressionContext:"cluster-map"})),ey.push(...X({key:`${ec}.${F}.reduce`,value:e_,expressionContext:"cluster-reduce"}))}return ey;case"video":return H({key:ec,value:eh,valueSpec:ep.source_video,style:e_,styleSpec:ep});case"image":return H({key:ec,value:eh,valueSpec:ep.source_image,style:e_,styleSpec:ep});case"canvas":return[new F.V(ec,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Y({key:`${ec}.type`,value:eh.type,valueSpec:{values:ep.source.reduce((F,el)=>{let eh=ep[el];return"enum"===eh.type.type&&(F=F.concat(Object.keys(eh.type.values))),F},[])},style:e_,styleSpec:ep})}}function le(el){let eh=el.value,ec=el.styleSpec,ep=ec.light,e_=el.style,eg=[],ey=F.K(eh);if(void 0===eh)return eg;if("object"!==ey)return eg.concat([new F.V("light",eh,`object expected, ${ey} found`)]);for(let el in eh){let ey=el.match(/^(.*)-transition$/),eb=el.match(/^(.*)-use-theme$/);eg=eg.concat(eb&&ep[eb[1]]?_e({key:el,value:eh[el],valueSpec:{type:"string"},style:e_,styleSpec:ec}):ey&&ep[ey[1]]&&ep[ey[1]].transition?_e({key:el,value:eh[el],valueSpec:ec.transition,style:e_,styleSpec:ec}):ep[el]?_e({key:el,value:eh[el],valueSpec:ep[el],style:e_,styleSpec:ec}):[new F.V(el,eh[el],`unknown property "${el}"`)])}return eg}function ce(el){let eh=el.value,ec=[];if(!eh)return ec;let ep=F.K(eh);if("object"!==ep)return ec.concat([new F.V("light-3d",eh,`object expected, ${ep} found`)]);let e_=el.styleSpec,eg=e_["light-3d"],ey=el.key,eb=el.style,ew=el.style.lights;for(let el of["type","id"])if(!(el in eh))return ec.concat([new F.V("light-3d",eh,`missing property ${el} on light`)]);if(eh.type&&ew)for(let ep=0;ep<el.arrayIndex;ep++){let el=F.M(eh.type),e_=ew[ep];F.M(e_.type)===el&&ec.push(new F.V(ey,eh.id,`duplicate light type "${eh.type}", previously defined at line ${e_.id.__line__}`))}let eT=`properties_light_${eh.type}`;if(!(eT in e_))return ec.concat([new F.V("light-3d",eh,`Invalid light type ${eh.type}`)]);let eS=e_[eT];for(let ep in eh)if("properties"===ep){let eg=eh[ep],ey=F.K(eg);if("object"!==ey)return ec.concat([new F.V("properties",eg,`object expected, ${ey} found`)]);for(let eh in eg)ec=ec.concat(eS[eh]?_e({key:eh,value:eg[eh],valueSpec:eS[eh],style:eb,styleSpec:e_}):[new F.J(el.key,eg[eh],`unknown property "${eh}"`)])}else{let el=ep.match(/^(.*)-transition$/),ey=ep.match(/^(.*)-use-theme$/);ec=ec.concat(ey&&eg[ey[1]]?_e({key:ep,value:eh[ep],valueSpec:{type:"string"},style:eb,styleSpec:e_}):el&&eg[el[1]]&&eg[el[1]].transition?_e({key:ep,value:eh[ep],valueSpec:e_.transition,style:eb,styleSpec:e_}):eg[ep]?_e({key:ep,value:eh[ep],valueSpec:eg[ep],style:eb,styleSpec:e_}):[new F.J(ep,eh[ep],`unknown property "${ep}"`)])}return ec}function he(el){let eh=el.value,ec=el.key,ep=el.style,e_=el.styleSpec,eg=e_.terrain,ey=[],eb=F.K(eh);if(void 0===eh||"null"===eb)return ey;if("object"!==eb)return ey.concat([new F.V("terrain",eh,`object expected, ${eb} found`)]);for(let el in eh){let ec=el.match(/^(.*)-transition$/),eb=el.match(/^(.*)-use-theme$/);ey=ey.concat(eb&&eg[eb[1]]?_e({key:el,value:eh[el],valueSpec:{type:"string"},style:ep,styleSpec:e_}):ec&&eg[ec[1]]&&eg[ec[1]].transition?_e({key:el,value:eh[el],valueSpec:e_.transition,style:ep,styleSpec:e_}):eg[el]?_e({key:el,value:eh[el],valueSpec:eg[el],style:ep,styleSpec:e_}):[new F.J(el,eh[el],`unknown property "${el}"`)])}if(eh.source){let el=ep.sources&&ep.sources[eh.source],e_=el&&F.M(el.type);el?"raster-dem"!==e_&&ey.push(new F.V(ec,eh.source,`terrain cannot be used with a source of type ${String(e_)}, it only be used with a "raster-dem" source type`)):ey.push(new F.V(ec,eh.source,`source "${eh.source}" not found`))}else ey.push(new F.V(ec,eh,'terrain is missing required property "source"'));return ey}function de(el){let eh=el.value,ec=el.style,ep=el.styleSpec,e_=ep.fog,eg=[],ey=F.K(eh);if(void 0===eh)return eg;if("object"!==ey)return eg.concat([new F.V("fog",eh,`object expected, ${ey} found`)]);for(let el in eh){let ey=el.match(/^(.*)-transition$/),eb=el.match(/^(.*)-use-theme$/);eg=eg.concat(eb&&e_[eb[1]]?_e({key:el,value:eh[el],valueSpec:{type:"string"},style:ec,styleSpec:ep}):ey&&e_[ey[1]]&&e_[ey[1]].transition?_e({key:el,value:eh[el],valueSpec:ep.transition,style:ec,styleSpec:ep}):e_[el]?_e({key:el,value:eh[el],valueSpec:e_[el],style:ec,styleSpec:ep}):[new F.J(el,eh[el],`unknown property "${el}"`)])}return eg}let eV={"*":()=>[],array:Z,boolean:function(el){let eh=el.value,ec=el.key,ep=F.K(eh);return"boolean"!==ep?[new F.V(ec,eh,`boolean expected, ${ep} found`)]:[]},number:W,color:function(el){let eh=el.key,ec=el.value,ep=F.K(ec);return"string"!==ep?[new F.V(eh,ec,`color expected, ${ep} found`)]:null===F.a0.parseCSSColor(ec)?[new F.V(eh,ec,`color expected, "${ec}" found`)]:[]},enum:Y,filter:J,function:$,layer:oe,object:H,source:ne,model:F.a4,light:le,"light-3d":ce,terrain:he,fog:de,string:se,formatted:function(F){return 0===se(F).length?[]:X(F)},resolvedImage:function(F){return 0===se(F).length?[]:X(F)},projection:function(el){let eh=el.value,ec=el.styleSpec,ep=ec.projection,e_=el.style,eg=[],ey=F.K(eh);if("object"===ey)for(let F in eh)eg=eg.concat(_e({key:F,value:eh[F],valueSpec:ep[F],style:e_,styleSpec:ec}));else"string"!==ey&&(eg=eg.concat([new F.V("projection",eh,`object or string expected, ${ey} found`)]));return eg},import:function(el){let{value:eh,styleSpec:ec}=el,{data:ep,...e_}=eh;Object.defineProperty(e_,"__line__",{value:eh.__line__,enumerable:!1});let eg=H(F.L({},el,{value:e_,valueSpec:ec.import}));return""===F.M(e_.id)&&eg.push(new F.V(`${el.key}.id`,e_,"import id can't be an empty string")),ep&&(eg=eg.concat(fe(ep,ec,{key:`${el.key}.data`}))),eg},iconset:function(el){let eh=el.value,ec=el.key,ep=el.styleSpec,e_=el.style;if(!eh.type)return[new F.V(ec,eh,'"type" is required')];let eg=F.M(eh.type),ey=[];if(ey=ey.concat(H({key:ec,value:eh,valueSpec:ep[`iconset_${eg}`],style:e_,styleSpec:ep})),"source"===eg&&eh.source){let el=e_.sources&&e_.sources[eh.source],ep=el&&F.M(el.type);el?"raster-array"!==ep&&ey.push(new F.V(ec,eh.source,`iconset cannot be used with a source of type ${String(ep)}, it only be used with a "raster-array" source type`)):ey.push(new F.V(ec,eh.source,`source "${eh.source}" not found`))}return ey}};function _e(el,eh=!1){let ec=el.value,ep=el.valueSpec,e_=el.styleSpec;if(ep.expression&&F.a2(F.M(ec)))return $(el);if(ep.expression&&F.S(F.U(ec)))return X(el);if(ep.type&&eV[ep.type]){let ec=eV[ep.type](el);return!0===eh&&ec.length>0&&"array"===F.K(el.value)?X(el):ec}return H(F.L({},el,{valueSpec:ep.type?e_[ep.type]:ep}))}function pe(el){let eh=el.value,ec=el.key,ep=se(el);return ep.length||(-1===eh.indexOf("{fontstack}")&&ep.push(new F.V(ec,eh,'"glyphs" url must include a "{fontstack}" token')),-1===eh.indexOf("{range}")&&ep.push(new F.V(ec,eh,'"glyphs" url must include a "{range}" token'))),ep}function fe(el,eh=F.a5,ec={}){return _e({key:ec.key||"",value:el,valueSpec:eh.$root,styleSpec:eh,style:el,objectElementValidators:{glyphs:pe,"*":()=>[]}})}function me(el,eh=F.a5){return De(fe(el,eh))}let ge=F=>De(ne(F)),ve=F=>De(le(F)),ye=F=>De(ce(F)),xe=F=>De(he(F)),be=F=>De(de(F)),we=el=>De(function(el){let eh=el.value,ec=el.style,ep=el.styleSpec,e_=ep.snow,eg=[],ey=F.K(eh);if(void 0===eh)return eg;if("object"!==ey)return eg.concat([new F.V("snow",eh,`object expected, ${ey} found`)]);for(let el in eh){let ey=el.match(/^(.*)-transition$/);eg=eg.concat(ey&&e_[ey[1]]&&e_[ey[1]].transition?_e({key:el,value:eh[el],valueSpec:ep.transition,style:ec,styleSpec:ep}):e_[el]?_e({key:el,value:eh[el],valueSpec:e_[el],style:ec,styleSpec:ep}):[new F.J(el,eh[el],`unknown property "${el}"`)])}return eg}(el)),Te=el=>De(function(el){let eh=el.value,ec=el.style,ep=el.styleSpec,e_=ep.rain,eg=[],ey=F.K(eh);if(void 0===eh)return eg;if("object"!==ey)return eg.concat([new F.V("rain",eh,`object expected, ${ey} found`)]);for(let el in eh){let ey=el.match(/^(.*)-transition$/);eg=eg.concat(ey&&e_[ey[1]]&&e_[ey[1]].transition?_e({key:el,value:eh[el],valueSpec:ep.transition,style:ec,styleSpec:ep}):e_[el]?_e({key:el,value:eh[el],valueSpec:e_[el],style:ec,styleSpec:ep}):[new F.J(el,eh[el],`unknown property "${el}"`)])}return eg}(el)),Ee=F=>De(oe(F)),Se=F=>De(J(F)),Ce=F=>De(te(F)),Ie=F=>De(ie(F)),Re=el=>De(F.a4(el));function De(F){return F.slice().sort((F,el)=>F.line&&el.line?F.line-el.line:0)}function Ae(el,eh){let ec=!1;if(eh&&eh.length)for(let ep of eh)ep instanceof F.J?F.w(ep.message):(el.fire(new F.z(Error(ep.message))),ec=!0);return ec}let Me=class Me extends F.E{constructor(el,ec="flat"){super(),this._transitionable=new F.a6(eh||(eh=new F.a7({anchor:new F.a8(F.a5.light.anchor),position:new F.a9(F.a5.light.position),color:new F.a8(F.a5.light.color),intensity:new F.a8(F.a5.light.intensity)}))),this.setLight(el,ec),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(F,el,eh={}){this._validate(ve,F,eh)||(this._transitionable.setTransitionOrValue(F),this.id=el)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(el,eh,ec){return(!ec||!1!==ec.validate)&&Ae(this,el.call(me,F.l({value:eh,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}};let eU=class extends F.E{constructor(el,eh,ec,ep){super(),this.scope=ec,this._transitionable=new F.a6(new F.a7({source:new F.a8(F.a5.terrain.source),exaggeration:new F.a8(F.a5.terrain.exaggeration)}),ec,ep),this._transitionable.setTransitionOrValue(el,ep),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=eh}get(){return this._transitionable.serialize()}set(F,el){this._transitionable.setTransitionOrValue(F,el)}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}getExaggeration(el){return this._transitioning.possiblyEvaluate(new F.aa(el)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;let el=this._transitionable._values.exaggeration;if(!el)return null;let eh=el.value.expression;if(!eh)return null;let ec=-1,ep=-1,e_=1;for(let el of eh.zoomStops)(e_=eh.evaluate(new F.aa(el)))>.01?(ec=el,ep=-1):ep=el;return e_<.01&&ec>0&&ep>ec?[ec,ep]:null}isZoomDependent(){let el=this._transitionable._values.exaggeration;return null!=el&&null!=el.value&&null!=el.value.expression&&el.value.expression instanceof F.ab}};function ke(el,eh,ec,ep){let e_=F.ae(45,65,ec),[eg,ey]=Be(el,ep),eb=1-Math.min(1,Math.exp(-((eh-eg)/(ey-eg)*6)));return eb*=eb*eb,(eb=Math.min(1,1.00747*eb))*e_*el.alpha}function Be(F,el){let eh=.5/Math.tan(.5*el);return[F.range[0]+eh,F.range[1]+eh]}function Ne(el,eh,ec,ep,e_){let eg=F.ad.vec3.transformMat4([],[eh,ec,ep],e_.mercatorFogMatrix);return ke(el,F.ad.vec3.length(eg),e_.pitch,e_._fov)}function Ue(el,eh,ec,ep,e_,eg,ey){let eb=Number.MAX_VALUE,ew=-Number.MAX_VALUE;for(let el of[[ec,ep,0],[e_,ep,0],[e_,eg,0],[ec,eg,0]]){let ec=F.ad.vec3.transformMat4([],el,eh),ep=F.ad.vec3.length(ec);eb=Math.min(eb,ep),ew=Math.max(ew,ep)}return[ke(el,eb,ey.pitch,ey._fov),ke(el,ew,ey.pitch,ey._fov)]}let Ve=class Ve extends F.E{constructor(el,eh,ec,ep){super();let e_=new F.a7({range:new F.a8(F.a5.fog.range),color:new F.a8(F.a5.fog.color),"color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new F.a8(F.a5.fog["high-color"]),"high-color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new F.a8(F.a5.fog["space-color"]),"space-color-use-theme":new F.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new F.a8(F.a5.fog["horizon-blend"]),"star-intensity":new F.a8(F.a5.fog["star-intensity"]),"vertical-range":new F.a8(F.a5.fog["vertical-range"])});this._transitionable=new F.a6(e_,ec,new Map(ep)),this.set(el,ep),this._transitioning=this._transitionable.untransitioned(),this._transform=eh,this.properties=new F.af(e_),this.scope=ec}get state(){let el=this._transform,eh="globe"===el.projection.name,ec=F.ag(el.zoom),ep=this.properties.get("range");return{range:eh?[F.ah(.5,ep[0],ec),F.ah(3,ep[1],ec)]:ep,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(el,eh,ec={}){if(this._validate(be,el,ec))return;let ep=F.l({},el);for(let el of Object.keys(F.a5.fog))void 0===ep[el]&&(ep[el]=F.a5.fog[el].default);this._options=ep,this._transitionable.setTransitionOrValue(this._options,eh)}getOpacity(el){if(!this._transform.projection.supportsFog)return 0;let eh=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:F.ae(45,65,el))*eh.a}getOpacityAtLatLng(el,eh){return this._transform.projection.supportsFog?function(el,eh,ec){let ep=F.ac.fromLngLat(eh),e_=ec.elevation?ec.elevation.getAtPointOrZero(ep):0;return Ne(el,ep.x,ep.y,e_,ec)}(this.state,el,eh):0}getOpacityForTile(el){if(!this._transform.projection.supportsFog)return[1,1];let eh=this._transform.calculateFogTileMatrix(el.toUnwrapped());return Ue(this.state,eh,0,0,F.ai,F.ai,this._transform)}getOpacityForBounds(F,el,eh,ec,ep){return this._transform.projection.supportsFog?Ue(this.state,F,el,eh,ec,ep,this._transform):[1,1]}getFovAdjustedRange(F){return this._transform.projection.supportsFog?Be(this.state,F):[0,1]}isVisibleOnFrustum(el){if(!this._transform.projection.supportsFog)return!1;for(let eh of[4,5,6,7]){let ec;let ep=el.points[eh];if(ep[2]>=0)ec=ep;else{let e_=el.points[eh-4];ec=F.aj(e_,ep,e_[2]/(e_[2]-ep[2]))}if(Ne(this.state,ec[0],ec[1],0,this._transform)>=.05)return!0}return!1}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(el,eh,ec){return(!ec||!1!==ec.validate)&&Ae(this,el.call(me,F.l({value:eh,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}};let ej,eG,eq,e$,eH=class extends F.E{constructor(el,eh,ec,ep){super();let e_=ej||(ej=new F.a7({density:new F.a8(F.a5.snow.density),intensity:new F.a8(F.a5.snow.intensity),color:new F.a8(F.a5.snow.color),opacity:new F.a8(F.a5.snow.opacity),vignette:new F.a8(F.a5.snow.vignette),"vignette-color":new F.a8(F.a5.snow["vignette-color"]),"center-thinning":new F.a8(F.a5.snow["center-thinning"]),direction:new F.a8(F.a5.snow.direction),"flake-size":new F.a8(F.a5.snow["flake-size"])}));this._transitionable=new F.a6(e_,ec,new Map(ep)),this.set(el,ep),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.af(e_),this.scope=ec}get state(){let el=this.properties.get("opacity"),eh=this.properties.get("color"),ec=this.properties.get("direction"),ep=F.ak(ec[0]),e_=-Math.max(F.ak(ec[1]),.01),eg=[Math.cos(ep)*Math.cos(e_),Math.sin(ep)*Math.cos(e_),Math.sin(e_)],ey=this.properties.get("vignette"),eb=this.properties.get("vignette-color");return eb.a=ey,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.al(eh.r,eh.g,eh.b,eh.a*el),direction:eg,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:eb}}get(){return this._transitionable.serialize()}set(el,eh,ec={}){if(this._validate(we,el,ec))return;let ep=F.l({},el);for(let el of Object.keys(F.a5.snow))void 0===ep[el]&&(ep[el]=F.a5.snow[el].default);this._options=ep,this._transitionable.setTransitionOrValue(this._options,eh)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(el,eh,ec){return(!ec||!1!==ec.validate)&&Ae(this,el.call(me,F.l({value:eh,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}},eZ=class extends F.E{constructor(el,eh,ec,ep){super();let e_=eG||(eG=new F.a7({density:new F.a8(F.a5.rain.density),intensity:new F.a8(F.a5.rain.intensity),color:new F.a8(F.a5.rain.color),opacity:new F.a8(F.a5.rain.opacity),vignette:new F.a8(F.a5.rain.vignette),"vignette-color":new F.a8(F.a5.rain["vignette-color"]),"center-thinning":new F.a8(F.a5.rain["center-thinning"]),direction:new F.a8(F.a5.rain.direction),"droplet-size":new F.a8(F.a5.rain["droplet-size"]),"distortion-strength":new F.a8(F.a5.rain["distortion-strength"])}));this._transitionable=new F.a6(e_,ec,new Map(ep)),this.set(el,ep),this._transitioning=this._transitionable.untransitioned(),this.properties=new F.af(e_),this.scope=ec}get state(){let el=this.properties.get("opacity"),eh=this.properties.get("color"),ec=this.properties.get("direction"),ep=F.ak(ec[0]),e_=-Math.max(F.ak(ec[1]),.01),eg=[Math.cos(ep)*Math.cos(e_),Math.sin(ep)*Math.cos(e_),Math.sin(e_)],ey=this.properties.get("vignette-color");return ey.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new F.al(eh.r,eh.g,eh.b,eh.a*el),direction:eg,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:ey}}get(){return this._transitionable.serialize()}set(el,eh,ec={}){if(this._validate(Te,el,ec))return;let ep=F.l({},el);for(let el of Object.keys(F.a5.rain))void 0===ep[el]&&(ep[el]=F.a5.rain[el].default);this._options=ep,this._transitionable.setTransitionOrValue(this._options,eh)}updateConfig(F){this._transitionable.setTransitionOrValue(this._options,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}_validate(el,eh,ec){return(!ec||!1!==ec.validate)&&Ae(this,el.call(me,F.l({value:eh,style:{glyphs:!0,sprite:!0},styleSpec:F.a5})))}};let $e=class $e extends F.E{constructor(el,eh,ec,ep){super(),this.scope=ec,this._options=el,this.properties=new F.af(eh),this._transitionable=new F.a6(eh,ec,new Map(ep)),this._transitionable.setTransitionOrValue(el.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(F){this._transitionable.setTransitionOrValue(this._options.properties,new Map(F))}updateTransitions(F){this._transitioning=this._transitionable.transitioned(F,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(F){this.properties=this._transitioning.possiblyEvaluate(F)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(F,el){this._options=F,this._transitionable.setTransitionOrValue(F.properties,el)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}};let Xe=class Xe{constructor(F,el,eh,ec){this.screenBounds=F,this.cameraPoint=el,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=eh,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,ec)}static createFromScreenPoints(el,eh){let ec,ep;if(el instanceof F.P||"number"==typeof el[0]){let e_=F.P.convert(el);ec=[e_],ep=eh.isPointAboveHorizon(e_)}else{let e_=F.P.convert(el[0]),eg=F.P.convert(el[1]);ec=[e_,eg],ep=F.an(e_,eg).every(F=>eh.isPointAboveHorizon(F))}return new Xe(ec,eh.getCameraPoint(),ep,eh)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(el){return F.an(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],el)}bufferedCameraGeometry(el){let eh=this.screenBounds[0],ec=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],ep=F.an(eh,ec,0,!1);return this.cameraPoint.y>ec.y&&(this.cameraPoint.x>eh.x&&this.cameraPoint.x<ec.x?ep.splice(3,0,this.cameraPoint):this.cameraPoint.x>=ec.x?ep[2]=this.cameraPoint:this.cameraPoint.x<=eh.x&&(ep[3]=this.cameraPoint)),F.ao(ep,el)}bufferedCameraGeometryGlobe(el){let eh=this.screenBounds[0],ec=1===this.screenBounds.length?this.screenBounds[0].add(new F.P(1,1)):this.screenBounds[1],ep=F.an(eh,ec,el),e_=this.cameraPoint.clone();switch(3*((e_.y>eh.y)+(e_.y>ec.y))+((e_.x>eh.x)+(e_.x>ec.x))){case 0:ep[0]=e_,ep[4]=e_.clone();break;case 1:ep.splice(1,0,e_);break;case 2:ep[1]=e_;break;case 3:ep.splice(4,0,e_);break;case 5:ep.splice(2,0,e_);break;case 6:ep[3]=e_;break;case 7:ep.splice(3,0,e_);break;case 8:ep[2]=e_}return ep}containsTile(el,eh,ec,ep=0){var e_;let eg=el.queryPadding/eh._pixelsPerMercatorPixel+1,ey=ec?this._bufferedCameraMercator(eg,eh):this._bufferedScreenMercator(eg,eh),eb=el.tileID.wrap+(ey.unwrapped?ep:0),ew=ey.polygon.map(eh=>F.ap(el.tileTransform,eh,eb));if(!F.aq(ew,0,0,F.ai,F.ai))return;eb=el.tileID.wrap+(this.screenGeometryMercator.unwrapped?ep:0);let eT=this.screenGeometryMercator.polygon.map(eh=>F.ar(el.tileTransform,eh,eb)),eS=eT.map(el=>new F.P(el[0],el[1])),eE=eh.getFreeCameraOptions().position||new F.ac(0,0,0),eM=F.ar(el.tileTransform,eE,eb),eI=eT.map(el=>{let eh=F.ad.vec3.sub(el,el,eM);return F.ad.vec3.normalize(eh,eh),new F.as(eM,eh)}),eA=F.at(el,1,eh.zoom)*eh._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:eS,tilespaceRays:eI,bufferedTilespaceGeometry:ew,bufferedTilespaceBounds:((e_=F.au(ew)).min.x=F.ay(e_.min.x,0,F.ai),e_.min.y=F.ay(e_.min.y,0,F.ai),e_.max.x=F.ay(e_.max.x,0,F.ai),e_.max.y=F.ay(e_.max.y,0,F.ai),e_),tile:el,tileID:el.tileID,pixelToTileUnitsFactor:eA}}_bufferedScreenMercator(F,el){let eh=100*F|0;if(this._screenRaycastCache[eh])return this._screenRaycastCache[eh];{let ec;return ec="globe"===el.projection.name?this._projectAndResample(this.bufferedScreenGeometry(F),el):{polygon:this.bufferedScreenGeometry(F).map(F=>el.pointCoordinate3D(F)),unwrapped:!0},this._screenRaycastCache[eh]=ec,ec}}_bufferedCameraMercator(F,el){let eh=100*F|0;if(this._cameraRaycastCache[eh])return this._cameraRaycastCache[eh];{let ec;return ec="globe"===el.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(F),el):{polygon:this.bufferedCameraGeometry(F).map(F=>el.pointCoordinate3D(F)),unwrapped:!0},this._cameraRaycastCache[eh]=ec,ec}}_projectAndResample(el,eh){let ec=function(el,eh){let ec=F.ad.mat4.multiply([],eh.pixelMatrix,eh.globeMatrix),ep=[0,-F.az,0,1],e_=[0,F.az,0,1],eg=[0,0,0,1];F.ad.vec4.transformMat4(ep,ep,ec),F.ad.vec4.transformMat4(e_,e_,ec),F.ad.vec4.transformMat4(eg,eg,ec);let ey=new F.P(ep[0]/ep[3],ep[1]/ep[3]),eb=new F.P(e_[0]/e_[3],e_[1]/e_[3]),ew=F.aw(el,ey)&&ep[3]<eg[3],eT=F.aw(el,eb)&&e_[3]<eg[3];if(!ew&&!eT)return null;let eS=function(F,el,eh){for(let ec=1;ec<F.length;ec++){let ep=Ye(el.pointCoordinate3D(F[ec-1]).x),e_=Ye(el.pointCoordinate3D(F[ec]).x);if(eh<0){if(ep<e_)return{idx:ec,t:-ep/(e_-1-ep)}}else if(e_<ep)return{idx:ec,t:(1-ep)/(e_+1-ep)}}return null}(el,eh,ew?-1:1);if(!eS)return null;let{idx:eE,t:eM}=eS,eI=eE>1?Ke(el.slice(0,eE),eh):[],eA=eE<el.length?Ke(el.slice(eE),eh):[];eI=eI.map(el=>new F.P(Ye(el.x),el.y)),eA=eA.map(el=>new F.P(Ye(el.x),el.y));let eC=[...eI];0===eC.length&&eC.push(eA[eA.length-1]);let eP=F.ah(eC[eC.length-1].y,(0===eA.length?eI[0]:eA[0]).y,eM);return eC.push(...ew?[new F.P(0,eP),new F.P(0,0),new F.P(1,0),new F.P(1,eP)]:[new F.P(1,eP),new F.P(1,1),new F.P(0,1),new F.P(0,eP)]),0===eA.length?eC.push(eI[0]):eC.push(...eA),{polygon:eC.map(el=>new F.ac(el.x,el.y)),unwrapped:!1}}(el,eh);if(ec)return ec;let ep=function(el,eh){let ec=!1,ep=-1/0,e_=0;for(let F=0;F<el.length-1;F++)el[F].x>ep&&(ep=el[F].x,e_=F);for(let F=0;F<el.length-1;F++){let eh=(e_+F)%(el.length-1),ep=el[eh],eg=el[eh+1];Math.abs(ep.x-eg.x)>.5&&(ep.x<eg.x?(ep.x+=1,0===eh&&(el[el.length-1].x+=1)):(eg.x+=1,eh+1===el.length-1&&(el[0].x+=1)),ec=!0)}let eg=F.av(eh.center.lng);return ec&&eg<Math.abs(eg-1)&&el.forEach(F=>{F.x-=1}),{polygon:el,unwrapped:ec}}(Ke(el,eh).map(el=>new F.P(Ye(el.x),el.y)),eh);return{polygon:ep.polygon.map(el=>new F.ac(el.x,el.y)),unwrapped:ep.unwrapped}}};function Ke(el,eh){return F.ax(el,F=>{let el=eh.pointCoordinate3D(F);F.x=el.x,F.y=el.y},1/256)}function Ye(F){return F<0?1+F%1:F%1}function Qe(el,eh,ec,ep,e_){let n=function(ec,ep){if(ec)return e_(ec);if(ep){if(el.url&&ep.tiles&&el.tiles&&delete el.tiles,ep.variants){if(!Array.isArray(ep.variants))return e_(Error("variants must be an array"));for(let el of ep.variants){if(null==el||"object"!=typeof el||el.constructor!==Object)return e_(Error("variant must be an object"));if(!Array.isArray(el.capabilities))return e_(Error("capabilities must be an array"));if(1===el.capabilities.length&&"meshopt"===el.capabilities[0]){ep=F.l(ep,el);break}}}let ec=F.aA(F.l({},ep,el),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);ec.tiles=eh.canonicalizeTileset(ec,el.url),e_(null,ec)}},eg=function(F,el,eh){if(!F)return null;if(!el&&!eh)return F;eh=eh||F.worldview_default;let ec=Object.values(F.language||{});if(0===ec.length)return null;let ep=Object.values(F.worldview||{});if(0===ep.length)return null;let e_=ec.every(F=>F===el),eg=ep.every(F=>F===eh);return e_&&eg?F:el in(F.language_options||{})||eh in(F.worldview_options||{})?null:F.language_options&&F.worldview_options?F:null}(el.data,ec,ep);return eg?F.q.frame(()=>n(null,eg)):el.url?F.n(eh.transformRequest(eh.normalizeSourceURL(el.url,null,ec,ep),F.R.Source),n):F.q.frame(()=>{let{data:F,...eh}=el;n(null,eh)})}let et=class et{constructor(el,eh,ec){this.bounds=F.aB.convert(this.validateBounds(el)),this.minzoom=eh||0,this.maxzoom=ec||24}validateBounds(F){return Array.isArray(F)&&4===F.length?[Math.max(-180,F[0]),Math.max(-90,F[1]),Math.min(180,F[2]),Math.min(90,F[3])]:[-180,-90,180,90]}contains(el){let eh=Math.pow(2,el.z),ec=Math.floor(F.av(this.bounds.getWest())*eh),ep=Math.floor(F.aC(this.bounds.getNorth())*eh),e_=Math.ceil(F.av(this.bounds.getEast())*eh),eg=Math.ceil(F.aC(this.bounds.getSouth())*eh);return el.x>=ec&&el.x<e_&&el.y>=ep&&el.y<eg}};let tt=class tt extends F.E{constructor(el,eh,ec,ep){if(super(),this.id=el,this.dispatcher=ec,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,F.l(this,F.aA(eh,["url","scheme","tileSize","promoteId"])),this._options=F.l({type:"vector"},eh),this._collectResourceTiming=!!eh.collectResourceTiming,512!==this.tileSize)throw Error("vector tile sources must have a tileSize of 512");this.setEventedParent(ep),this._tileWorkers={},this._deduped=new F.aD}load(el){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"}));let eh=Array.isArray(this.map._language)?this.map._language.join():this.map._language,ec=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,eh,ec,(ep,e_)=>{if(this._tileJSONRequest=null,this._loaded=!0,ep)eh&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${eh}`),ec&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${ec}`),this.fire(new F.z(ep));else if(e_){if(F.l(this,e_),this.hasWorldviews=!!e_.worldview_options,e_.worldview_default&&(this.worldviewDefault=e_.worldview_default),e_.vector_layers)for(let F of(this.vectorLayers=e_.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set,e_.vector_layers))this.vectorLayerIds.push(F.id),e_.worldview&&e_.worldview[F.source]&&this.localizableLayerIds.add(F.id);e_.bounds&&(this.tileBounds=new et(e_.bounds,this.minzoom,this.maxzoom)),eC(e_.tiles,this.map._requestManager._customAccessToken),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}el&&el(ep)})}loaded(){return this._loaded}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();let el=F.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(el))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}loadTile(el,eh){let ec=el.tileID.canonical.url(this.tiles,this.scheme),ep=this.map._requestManager.normalizeTileURL(ec),e_=this.map._requestManager.transformRequest(ep,F.R.Tile),eg=this.map.style?this.map.style.getLut(this.scope):null,ey=eg?{image:eg.image.clone()}:null,eb={request:e_,data:void 0,uid:el.uid,tileID:el.tileID,tileZoom:el.tileZoom,zoom:el.tileID.overscaledZ,maxZoom:this.maxzoom,lut:ey,tileSize:this.tileSize*el.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:el.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:el.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&F.f(ec)&&(eb.worldview=this.map.getWorldview()||this.worldviewDefault,eb.localizableLayerIds=this.localizableLayerIds),eb.request.collectResourceTiming=this._collectResourceTiming,el.actor&&"expired"!==el.state)"loading"===el.state?el.reloadCallback=eh:el.request=el.actor.send("reloadTile",eb,c.bind(this));else if(el.actor=this._tileWorkers[ep]=this._tileWorkers[ep]||this.dispatcher.getActor(),this.dispatcher.ready)el.request=el.actor.send("loadTile",eb,c.bind(this),void 0,!0);else{let eh=F.aE.call({deduped:this._deduped},eb,(F,eh)=>{F||!eh?c.call(this,F):(eb.data={cacheControl:eh.cacheControl,expires:eh.expires,rawData:eh.rawData.slice(0)},el.actor&&el.actor.send("loadTile",eb,c.bind(this),void 0,!0))},!0);el.request={cancel:eh}}function c(ec,ep){return delete el.request,el.aborted?eh(null):ec&&404!==ec.status?eh(ec):(ep&&ep.resourceTiming&&(el.resourceTiming=ep.resourceTiming),this.map._refreshExpiredTiles&&ep&&el.setExpiryData(ep),el.loadVectorData(ep,this.map.painter),F.aF(this.dispatcher),eh(null),void(el.reloadCallback&&(this.loadTile(el,el.reloadCallback),el.reloadCallback=null)))}}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(F,el){F.actor&&F.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}};let it=class it extends F.E{constructor(el,eh,ec,ep){super(),this.id=el,this.dispatcher=ec,this.setEventedParent(ep),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=F.l({type:"raster"},eh),F.l(this,F.aA(eh,["url","scheme","tileSize"]))}load(el){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"})),this._tileJSONRequest=Qe(this._options,this.map._requestManager,null,null,(eh,ec)=>{this._tileJSONRequest=null,this._loaded=!0,eh?this.fire(new F.z(eh)):ec&&(F.l(this,ec),ec.raster_layers&&(this.rasterLayers=ec.raster_layers,this.rasterLayerIds=this.rasterLayers.map(F=>F.id)),ec.bounds&&(this.tileBounds=new et(ec.bounds,this.minzoom,this.maxzoom)),eC(ec.tiles),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))),el&&el(eh)})}loaded(){return this._loaded}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();let el=F.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(el))}setTiles(F){return this._options.tiles=F,this.reload(),this}setUrl(F){return this.url=F,this._options.url=F,this.reload(),this}onRemove(F){this.cancelTileJSONRequest()}serialize(){return F.l({},this._options)}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(el,eh){let ec=F.q.devicePixelRatio>=2,ep=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme),ec,this.tileSize);el.request=F.o(this.map._requestManager.transformRequest(ep,F.R.Tile),(ec,ep,e_,eg)=>(delete el.request,el.aborted?(el.state="unloaded",eh(null)):ec?(el.state="errored",eh(ec)):ep?(this.map._refreshExpiredTiles&&el.setExpiryData({cacheControl:e_,expires:eg}),el.setTexture(ep,this.map.painter),el.state="loaded",F.aF(this.dispatcher),void eh(null)):eh(null)))}abortTile(F,el){F.request&&(F.request.cancel(),delete F.request),el&&el()}unloadTile(el,eh){el.texture&&el.texture instanceof F.T?(el.destroy(!0),el.texture&&el.texture instanceof F.T&&this.map.painter.saveTileTexture(el.texture)):el.destroy(),eh&&eh()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}};let ot=class ot extends it{constructor(el,eh,ec,ep){super(el,eh,ec,ep),this.type="raster-array",this.maxzoom=22,this.partial=!0,this.iconsets={},this._options=F.l({type:"raster-array"},eh)}triggerRepaint(F){let el=this.map.painter._terrain,eh=this.map.style.getSourceCache(this.id);el&&el.enabled&&eh&&el._clearRenderCacheForTile(eh.id,F.tileID),this.map.triggerRepaint()}loadTile(el,eh){let ec=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),ep=this.map._requestManager.transformRequest(ec,F.R.Tile),e_={request:ep,uid:el.uid,tileID:el.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};el.source=this.id,el.scope=this.scope,el.requestParams=ep,el.actor||(el.actor=this.dispatcher.getActor());let n=(ec,ep,e_,eg)=>{if(delete el.request,el.aborted)return el.state="unloaded",eh(null);if(ec){if("AbortError"===ec.name)return;return el.state="errored",eh(ec)}if(this.map._refreshExpiredTiles&&ep&&el.setExpiryData({cacheControl:e_,expires:eg}),this.partial)el.state="empty";else{if(!ep)return eh(null);el.state="loaded",el._isHeaderLoaded=!0,el._mrt=ep;let ec=new Map;for(let eh in el._mrt.layers){let ep=el.getLayer(eh);if(ep)for(let el of ep.getBandList()){let{bytes:e_,tileSize:eg,buffer:ey}=ep.getBandView(el),eb=eg+2*ey,ew={data:new F.r({width:eb,height:eb},e_),pixelRatio:2,sdf:!1,usvg:!1,version:0};ec.set(`${eh}/${el}`,ew)}}for(let F in this.iconsets)this.iconsets[F].addIcons(ec)}eh(null)};el.request=this.partial?el.fetchHeader(void 0,n.bind(this)):el.actor.send("loadTile",e_,n.bind(this),void 0,!0)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.actor&&F.actor.send("abortTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(el,eh){let ec=el.texture;ec&&ec instanceof F.T?(el.destroy(!0),this.map.painter.saveTileTexture(ec)):(el.destroy(),el.flushQueues(),el._isHeaderLoaded=!1,delete el._mrt,delete el.textureDescriptor),el.fbo&&(el.fbo.destroy(),delete el.fbo),delete el.request,delete el.requestParams,delete el.neighboringTiles,el.state="unloaded"}prepareTile(el,eh,ec){el._isHeaderLoaded&&("empty"!==el.state&&(el.state="reloading"),el.fetchBand(eh,ec,(eh,ec)=>{if(eh)return el.state="errored",this.fire(new F.z(eh)),void this.triggerRepaint(el);ec&&(el._isHeaderLoaded=!0,el.setTexture(ec,this.map.painter),el.state="loaded",this.triggerRepaint(el))}))}getInitialBand(F){if(!this.rasterLayers)return 0;let el=this.rasterLayers.find(({id:el})=>el===F),eh=el&&el.fields,ec=eh&&eh.bands&&eh.bands;return ec?ec[0]:0}getTextureDescriptor(el,eh,ec){if(!el)return;let ep=eh.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!ep)return;let e_=null;eh instanceof F.aI?e_=eh.paint.get("raster-array-band"):eh instanceof F.aJ&&(e_=eh.paint.get("raster-particle-array-band"));let eg=e_||this.getInitialBand(ep);if(null!=eg){if(el.textureDescriptor){if(!el.updateNeeded(ep,eg)||ec)return Object.assign({},el.textureDescriptor,{texture:el.texture})}else this.prepareTile(el,ep,eg)}}addIconset(F,el){this.iconsets[F]=el,this.partial=!1}};let eW={vector:tt,raster:it,"raster-dem":class extends it{constructor(el,eh,ec,ep){super(el,eh,ec,ep),this.type="raster-dem",this.maxzoom=22,this._options=F.l({type:"raster-dem"},eh),this.encoding=eh.encoding||"mapbox"}loadTile(el,eh){let ec=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function s(F,ec){F&&(el.state="errored",eh(F)),ec&&(el.dem=ec,el.dem.onDeserialize(),el.needsHillshadePrepare=!0,el.needsDEMTextureUpload=!0,el.state="loaded",eh(null))}el.request=F.o(this.map._requestManager.transformRequest(ec,F.R.Tile),(function(ec,ep,e_,eg){if(delete el.request,el.aborted)el.state="unloaded",eh(null);else if(ec)el.state="errored",eh(ec);else if(ep){this.map._refreshExpiredTiles&&el.setExpiryData({cacheControl:e_,expires:eg});let eh=ImageBitmap&&ep instanceof ImageBitmap&&F.t(),ec=1-(ep.width-F.aG(ep.width))/2;ec<1||el.neighboringTiles||(el.neighboringTiles=this._getNeighboringTiles(el.tileID));let ey=eh?ep:F.q.getImageData(ep,ec),eb={uid:el.uid,tileID:el.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:ey,encoding:this.encoding,padding:ec};el.actor&&"expired"!==el.state||(el.actor=this.dispatcher.getActor(),el.actor.send("loadTile",eb,s.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(el){let eh=el.canonical,ec=Math.pow(2,eh.z),ep=(eh.x-1+ec)%ec,e_=0===eh.x?el.wrap-1:el.wrap,eg=(eh.x+1+ec)%ec,ey=eh.x+1===ec?el.wrap+1:el.wrap,eb={};return eb[new F.aH(el.overscaledZ,e_,eh.z,ep,eh.y).key]={backfilled:!1},eb[new F.aH(el.overscaledZ,ey,eh.z,eg,eh.y).key]={backfilled:!1},eh.y>0&&(eb[new F.aH(el.overscaledZ,e_,eh.z,ep,eh.y-1).key]={backfilled:!1},eb[new F.aH(el.overscaledZ,el.wrap,eh.z,eh.x,eh.y-1).key]={backfilled:!1},eb[new F.aH(el.overscaledZ,ey,eh.z,eg,eh.y-1).key]={backfilled:!1}),eh.y+1<ec&&(eb[new F.aH(el.overscaledZ,e_,eh.z,ep,eh.y+1).key]={backfilled:!1},eb[new F.aH(el.overscaledZ,el.wrap,eh.z,eh.x,eh.y+1).key]={backfilled:!1},eb[new F.aH(el.overscaledZ,ey,eh.z,eg,eh.y+1).key]={backfilled:!1}),eb}},"raster-array":ot,geojson:class extends F.E{constructor(el,eh,ec,ep){super(),this.id=el,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=ec.getActor(),this.setEventedParent(ep),this._data=eh.data,this._options=F.l({},eh),this._collectResourceTiming=eh.collectResourceTiming,void 0!==eh.maxzoom&&(this.maxzoom=eh.maxzoom),void 0!==eh.minzoom&&(this.minzoom=eh.minzoom),eh.type&&(this.type=eh.type),eh.attribution&&(this.attribution=eh.attribution),this.promoteId=eh.promoteId;let e_=F.ai/this.tileSize;this.workerOptions=F.l({source:this.id,scope:this.scope,cluster:eh.cluster||!1,geojsonVtOptions:{buffer:(void 0!==eh.buffer?eh.buffer:128)*e_,tolerance:(void 0!==eh.tolerance?eh.tolerance:.375)*e_,extent:F.ai,maxZoom:this.maxzoom,lineMetrics:eh.lineMetrics||!1,generateId:eh.generateId||!1},superclusterOptions:{maxZoom:void 0!==eh.clusterMaxZoom?eh.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,eh.clusterMinPoints||2),extent:F.ai,radius:(void 0!==eh.clusterRadius?eh.clusterRadius:50)*e_,log:!1,generateId:eh.generateId||!1},clusterProperties:eh.clusterProperties,filter:eh.filter,dynamic:eh.dynamic},eh.workerOptions)}onAdd(F){this.map=F,this.setData(this._data)}setData(F){return this._data=F,this._updateWorkerData(),this}updateData(el){if(!this._options.dynamic)return this.fire(new F.z(Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof el&&("Feature"===el.type&&(el={type:"FeatureCollection",features:[el]}),"FeatureCollection"!==el.type))return this.fire(new F.z(Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof el&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){let F=new Map;for(let el of this._data.features)F.set(el.id,el);for(let eh of el.features)F.set(eh.id,eh);this._data.features=[...F.values()]}else this._data=el;return this._updateWorkerData(!0),this}getClusterExpansionZoom(F,el){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:F,source:this.id,scope:this.scope},el),this}getClusterChildren(F,el){return this.actor.send("geojson.getClusterChildren",{clusterId:F,source:this.id,scope:this.scope},el),this}getClusterLeaves(F,el,eh,ec){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:F,limit:el,offset:eh},ec),this}_updateWorkerData(el=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new F.A("dataloading",{dataType:"source"})),this._loaded=!1;let eh=F.l({append:el},this.workerOptions);eh.scope=this.scope;let ec=this._data;"string"==typeof ec?(eh.request=this.map._requestManager.transformRequest(F.q.resolveURL(ec),F.R.Source),eh.request.collectResourceTiming=this._collectResourceTiming):eh.data=JSON.stringify(ec),this._pendingLoad=this.actor.send(`${this.type}.loadData`,eh,(eh,ec)=>{if(this._loaded=!0,this._pendingLoad=null,eh)this.fire(new F.z(eh));else{let eh={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&ec&&ec.resourceTiming&&ec.resourceTiming[this.id]&&(eh.resourceTiming=ec.resourceTiming[this.id]),el&&(this._partialReload=!0),this.fire(new F.A("data",eh)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(el),this._coalesce=!1)})}loaded(){return this._loaded}reload(){let el=F.C(this.id,this.scope);this.map.style.clearSource(el),this._updateWorkerData()}loadTile(el,eh){let ec=el.actor?"reloadTile":"loadTile";el.actor=this.actor;let ep=this.map.style?this.map.style.getLut(this.scope):null,e_=ep?{image:ep.image.clone()}:null,eg=this._partialReload,ey={type:this.type,uid:el.uid,tileID:el.tileID,tileZoom:el.tileZoom,zoom:el.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:e_,scope:this.scope,pixelRatio:F.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:eg};el.request=this.actor.send(ec,ey,(F,ep)=>eg&&!ep?(el.state="loaded",eh(null)):(delete el.request,el.destroy(),el.aborted?eh(null):F?eh(F):(el.loadVectorData(ep,this.map.painter,"reloadTile"===ec),eh(null))),void 0,"loadTile"===ec)}abortTile(F){F.request&&(F.request.cancel(),delete F.request),F.aborted=!0}unloadTile(F,el){this.actor.send("removeTile",{uid:F.uid,type:this.type,source:this.id,scope:this.scope}),F.destroy()}onRemove(F){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return F.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends F.aK{constructor(F,el,eh,ec){super(F,el,eh,ec),this.roundZoom=!0,this.type="video",this.options=el}load(){this._loaded=!1;let el=this.options;for(let eh of(this.urls=[],el.urls))this.urls.push(this.map._requestManager.transformRequest(eh,F.R.Source).url);F.aL(this.urls,(el,eh)=>{this._loaded=!0,el?this.fire(new F.z(el)):eh&&(this.video=eh,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(el){if(this.video){let eh=this.video.seekable;el<eh.start(0)||el>eh.end(0)?this.fire(new F.z(new F.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${eh.start(0)} and ${eh.end(0)}-second mark.`))):this.video.currentTime=el}}getVideo(){return this.video}onAdd(F){this.map||(this.map=F,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;let el=this.map.painter.context,eh=el.gl;this.texture?this.video.paused||(this.texture.bind(eh.LINEAR,eh.CLAMP_TO_EDGE),eh.texSubImage2D(eh.TEXTURE_2D,0,0,0,eh.RGBA,eh.UNSIGNED_BYTE,this.video)):(this.texture=new F.T(el,this.video,eh.RGBA8),this.texture.bind(eh.LINEAR,eh.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(el)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:F.aK,model:class extends F.E{constructor(F,el,eh,ec){super(),this.id=F,this.type="model",this.models=[],this._loaded=!1,this._options=el}load(){let el=[];for(let eh in this._options.models){let ec=this._options.models[eh],ep=F.aN(this.map._requestManager.transformRequest(ec.uri,F.R.Model).url).then(el=>{if(!el)return;let ep=F.aO(el),e_=new F.aP(eh,ec.position,ec.orientation,ep);e_.computeBoundsAndApplyParent(),this.models.push(e_)}).catch(el=>{this.fire(new F.z(Error(`Could not load model ${eh} from ${ec.uri}: ${el.message}`)))});el.push(ep)}return Promise.allSettled(el).then(()=>{this._loaded=!0,this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(el=>{this.fire(new F.z(Error(`Could not load models: ${el.message}`)))})}onAdd(F){this.map=F,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(F,el){}serialize(){return{type:"model"}}},"batched-model":class extends F.E{constructor(F,el,eh,ec){super(),this.type="batched-model",this.id=F,this.tileSize=512,this._options=el,this.tiles=this._options.tiles,this.maxzoom=el.maxzoom||19,this.minzoom=el.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=eh,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(ec)}onAdd(F){this.map=F,this.load()}reload(){this.cancelTileJSONRequest();let el=F.C(this.id,this.scope);this.load(()=>this.map.style.clearSource(el))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(el){this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"}));let eh=Array.isArray(this.map._language)?this.map._language.join():this.map._language,ec=this.map.getWorldview();this._tileJSONRequest=Qe(this._options,this.map._requestManager,eh,ec,(ep,e_)=>{this._tileJSONRequest=null,this._loaded=!0,ep?(eh&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${eh}`),ec&&2!==ec.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${ec}`),this.fire(new F.z(ep))):e_&&(F.l(this,e_),e_.bounds&&(this.tileBounds=new et(e_.bounds,this.minzoom,this.maxzoom)),eC(e_.tiles,this.map._requestManager._customAccessToken),this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))),el&&el(ep)})}hasTransition(){return!1}hasTile(F){return!this.tileBounds||this.tileBounds.contains(F.canonical)}loaded(){return this._loaded}loadTile(el,eh){let ec=this.map._requestManager.normalizeTileURL(el.tileID.canonical.url(this.tiles,this.scheme)),ep={request:this.map._requestManager.transformRequest(ec,F.R.Tile),data:void 0,uid:el.uid,tileID:el.tileID,tileZoom:el.tileZoom,zoom:el.tileID.overscaledZ,tileSize:this.tileSize*el.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:el.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:F.q.devicePixelRatio,promoteId:this.promoteId};if(el.actor&&"expired"!==el.state){if("loading"===el.state)el.reloadCallback=eh;else{if(el.buckets){let F=Object.values(el.buckets);for(let el of F)el.dirty=!0;return void(el.state="loaded")}el.request=el.actor.send("reloadTile",ep,r.bind(this))}}else el.actor=this.dispatcher.getActor(),el.request=el.actor.send("loadTile",ep,r.bind(this),void 0,!0);function r(F,ec){return el.aborted?eh(null):F&&404!==F.status?eh(F):(this.map._refreshExpiredTiles&&ec&&el.setExpiryData(ec),el.loadModelData(ec,this.map.painter),el.state="loaded",void eh(null))}}serialize(){return F.l({},this._options)}},canvas:class extends F.aK{constructor(el,eh,ec,ep){super(el,eh,ec,ep),eh.coordinates?Array.isArray(eh.coordinates)&&4===eh.coordinates.length&&!eh.coordinates.some(F=>!Array.isArray(F)||2!==F.length||F.some(F=>"number"!=typeof F))||this.fire(new F.z(new F.V(`sources.${el}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new F.z(new F.V(`sources.${el}`,null,'missing required property "coordinates"'))),eh.animate&&"boolean"!=typeof eh.animate&&this.fire(new F.z(new F.V(`sources.${el}`,null,'optional "animate" property must be a boolean value'))),eh.canvas?"string"==typeof eh.canvas||eh.canvas instanceof HTMLCanvasElement||this.fire(new F.z(new F.V(`sources.${el}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new F.z(new F.V(`sources.${el}`,null,'missing required property "canvas"'))),this.options=eh,this.animate=void 0===eh.animate||eh.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new F.z(Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(F){this.map=F,this.load(),this.canvas&&this.animate&&this.play()}onRemove(F){this.pause()}prepare(){let el=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,el=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,el=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;let eh=this.map.painter.context;this.texture?!el&&!this._playing||this.texture instanceof F.aM||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new F.T(eh,this.canvas,eh.gl.RGBA8,{premultiply:!0}),this._prepareData(eh)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(let F of[this.canvas.width,this.canvas.height])if(isNaN(F)||F<=0)return!0;return!1}},custom:class extends F.E{constructor(el,eh,ec,ep){super(),this.id=el,this.type="custom",this._dataType="raster",this._dispatcher=ec,this._implementation=eh,this.setEventedParent(ep),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new F.z(Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new F.z(Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new et(this._implementation.bounds,this.minzoom,this.maxzoom)),eh.update=this._update.bind(this),eh.clearTiles=this._clearTiles.bind(this),eh.coveringTiles=this._coveringTiles.bind(this),F.l(this,F.aA(eh,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return F.aA(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new F.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(el){this.map=el,this._loaded=!1,this.fire(new F.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(el),this.load()}onRemove(F){this._implementation.onRemove&&this._implementation.onRemove(F)}hasTile(F){if(this._implementation.hasTile){let{x:el,y:eh,z:ec}=F.canonical;return this._implementation.hasTile({x:el,y:eh,z:ec})}return!this.tileBounds||this.tileBounds.contains(F.canonical)}loadTile(F,el){let{x:eh,y:ec,z:ep}=F.tileID.canonical,e_=new AbortController;F.request=Promise.resolve(this._implementation.loadTile({x:eh,y:ec,z:ep},{signal:e_.signal})).then((function(eh){return delete F.request,F.aborted?(F.state="unloaded",el(null)):void 0===eh?(F.state="errored",el(null)):null===eh?(this.loadTileData(F,{width:this.tileSize,height:this.tileSize,data:null}),F.state="loaded",el(null)):eh instanceof ImageData||eh instanceof HTMLCanvasElement||eh instanceof ImageBitmap||eh instanceof HTMLImageElement?(this.loadTileData(F,eh),F.state="loaded",void el(null)):(F.state="errored",el(Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch(eh=>{"AbortError"!==eh.name&&(F.state="errored",el(eh))}),F.request.cancel=()=>e_.abort()}loadTileData(F,el){F.setTexture(el,this.map.painter)}unloadTile(el,eh){if(el.texture&&el.texture instanceof F.T?(el.destroy(!0),el.texture&&el.texture instanceof F.T&&this.map.painter.saveTileTexture(el.texture)):el.destroy(),this._implementation.unloadTile){let{x:F,y:eh,z:ec}=el.tileID.canonical;this._implementation.unloadTile({x:F,y:eh,z:ec})}eh&&eh()}abortTile(F,el){F.request&&F.request.cancel&&(F.request.cancel(),delete F.request),el&&el()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(F=>({x:F.canonical.x,y:F.canonical.y,z:F.canonical.z}))}_clearTiles(){let el=F.C(this.id,this.scope);this.map.style.clearSource(el)}_update(){this.fire(new F.A("data",{dataType:"source",sourceDataType:"content"}))}}},rt=function(el,eh,ec,ep){let e_=new eW[eh.type](el,eh,ec,ep);if(e_.id!==el)throw Error(`Expected Source id to be ${el} instead of ${e_.id}`);return F.aQ(["load","abort","unload","serialize","prepare"],e_),e_};function nt(F,el,eh=""){return`${eh}:${el.id||""}:${el.layer.id}:${function(F){if("layerId"in F)return`layer:${F.layerId}`;{let{featuresetId:el,importId:eh}=F;return`featureset:${el}${eh?`:import:${eh}`:""}`}}(F.target)}`}function at(F,el,eh,ec=""){if(F.uniqueFeatureID){let ep=nt(F,el,ec);if(eh.has(ep))return!0;eh.add(ep)}return!1}function dt(F,el){let eh=F.tileID,ec=el.tileID;return eh.overscaledZ-ec.overscaledZ||eh.canonical.y-ec.canonical.y||eh.wrap-ec.wrap||eh.canonical.x-ec.canonical.x}function ut(F,el){let eh={};if(!el)return eh;for(let ec of F){let F=ec.layerIds.map(F=>el.getLayer(F)).filter(Boolean);if(0!==F.length)for(let el of(ec.layers=F,ec.stateDependentLayerIds&&(ec.stateDependentLayers=ec.stateDependentLayerIds.map(el=>F.filter(F=>F.id===el)[0])),F))eh[el.fqid]=ec}return eh}let eY=new Uint16Array(8184);for(let F=0;F<2046;F++){let el=F+2,eh=0,ec=0,ep=0,e_=0,eg=0,ey=0;for(1&el?ep=e_=eg=32:eh=ec=ey=32;(el>>=1)>1;){let F=eh+ep>>1,eb=ec+e_>>1;1&el?(ep=eh,e_=ec,eh=eg,ec=ey):(eh=ep,ec=e_,ep=eg,e_=ey),eg=F,ey=eb}let eb=4*F;eY[eb+0]=eh,eY[eb+1]=ec,eY[eb+2]=ep,eY[eb+3]=e_}let eX=new Uint16Array(2178),eK=new Uint8Array(1089),eJ=new Uint16Array(1089);function yt(F){return 0===F?-.03125:32===F?.03125:0}let eQ={type:2,extent:F.ai,loadGeometry:()=>[[new F.P(0,0),new F.P(F.ai+1,0),new F.P(F.ai+1,F.ai+1),new F.P(0,F.ai+1),new F.P(0,0)]]};let bt=class bt{constructor(el,eh,ec,ep,e_){this.tileID=el,this.uid=F.aW(),this.uses=0,this.tileSize=eh,this.tileZoom=ec,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=e_,ep&&ep.style&&(this._lastUpdatedBrightness=ep.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",ep&&ep.transform&&(this.projection=ep.transform.projection)}registerFadeDuration(el){let eh=el+this.timeAdded;eh<F.q.now()||this.fadeEndTime&&eh<this.fadeEndTime||(this.fadeEndTime=eh)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=F.aR(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(el,eh,ec){if(this.unloadVectorData(),this.state="loaded",el){for(let ep in el.featureIndex&&(this.latestFeatureIndex=el.featureIndex,el.rawTileData?(this.latestRawTileData=el.rawTileData,this.latestFeatureIndex.rawTileData=el.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=el.collisionBoxArray,this.buckets=ut(el.buckets,eh.style),this.hasSymbolBuckets=!1,this.buckets){let el=this.buckets[ep];if(el instanceof F.aY){if(this.hasSymbolBuckets=!0,!ec)break;el.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(let el in this.buckets){let eh=this.buckets[el];if(eh instanceof F.aY&&eh.hasRTLText){this.hasRTLText=!0,F.aZ();break}}for(let F in this.queryPadding=0,this.buckets){let el=this.buckets[F],ec=eh.style.getOwnLayer(F);if(!ec)continue;let ep=ec.queryRadius(el);this.queryPadding=Math.max(this.queryPadding,ep)}el.imageAtlas&&(this.imageAtlas=el.imageAtlas),el.glyphAtlasImage&&(this.glyphAtlasImage=el.glyphAtlasImage),el.lineAtlas&&(this.lineAtlas=el.lineAtlas),this._lastUpdatedBrightness=el.brightness}else this.collisionBoxArray=new F.aX}unloadVectorData(){if(this.hasData()){for(let F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(F,el,eh){F&&(F.resourceTiming&&(this.resourceTiming=F.resourceTiming),this.buckets=Object.assign({},this.buckets,ut(F.buckets,el.style)),F.featureIndex&&(this.latestFeatureIndex=F.featureIndex))}getBucket(F){return this.buckets[F.fqid]}upload(el){for(let F in this.buckets){let eh=this.buckets[F];eh.uploadPending()&&eh.upload(el)}let eh=el.gl,ec=this.imageAtlas;ec&&!ec.uploaded&&(this.imageAtlasTexture=new F.T(el,ec.image,eh.RGBA8,{useMipmap:!!ec.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new F.T(el,this.glyphAtlasImage,eh.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new F.T(el,this.lineAtlas.image,eh.R8),this.lineAtlas.uploaded=!0)}prepare(F,el,eh){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(F,this.imageAtlasTexture,eh),!el||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;let ec=el.style.getBrightness();(this._lastUpdatedBrightness||ec)&&(this._lastUpdatedBrightness&&ec&&.001>Math.abs(this._lastUpdatedBrightness-ec)||(this.updateBuckets(el,this._lastUpdatedBrightness!==ec),this._lastUpdatedBrightness=ec))}queryRenderedFeatures(el,eh,ec,ep,e_,eg){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};let ey=function(el,eh){let ec=F.ad.mat4.fromScaling([],[.5*el.width,-(.5*el.height),1]);return F.ad.mat4.translate(ec,ec,[1,-1,0]),F.ad.mat4.multiply(ec,ec,el.calculateProjMatrix(eh.toUnwrapped())),Float32Array.from(ec)}(e_,this.tileID);return this.latestFeatureIndex.query(el,{tilespaceGeometry:eh,pixelPosMatrix:ey,transform:ep,availableImages:ec,tileTransform:this.tileTransform})}querySourceFeatures(el,eh){let ec=this.latestFeatureIndex;if(!ec||!ec.rawTileData)return;let ep=ec.loadVTLayers(),e_=eh?eh.sourceLayer:"",eg=ep._geojsonTileLayer||ep[e_];if(!eg)return;let ey=F.a_(eh&&eh.filter),{z:eb,x:ew,y:eT}=this.tileID.canonical,eS={z:eb,x:ew,y:eT};for(let eh=0;eh<eg.length;eh++){let ep=eg.feature(eh);if(ey.needGeometry){let el=F.a$(ep,!0);if(!ey.filter(new F.aa(this.tileID.overscaledZ),el,this.tileID.canonical))continue}else if(!ey.filter(new F.aa(this.tileID.overscaledZ),ep))continue;let eE=ec.getId(ep,e_),eM=new F.b0(ep,eb,ew,eT,eE);eM.tile=eS,el.push(eM)}}loaded(){return"loaded"===this.state||"errored"===this.state}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(el){let eh=this.expirationTime;if(el.cacheControl){let eh=F.b1(el.cacheControl);eh["max-age"]&&(this.expirationTime=Date.now()+1e3*eh["max-age"])}else el.expires&&(this.expirationTime=new Date(el.expires).getTime());if(this.expirationTime){let F=Date.now(),el=!1;if(this.expirationTime>F)el=!1;else if(eh){if(this.expirationTime<eh)el=!0;else{let ec=this.expirationTime-eh;ec?this.expirationTime=F+Math.max(ec,3e4):el=!0}}else el=!0;el?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),2147483647)}refreshFeatureState(F){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&F&&this.updateBuckets(F)}updateBuckets(el,eh){if(!this.latestFeatureIndex||!el.style)return;let ec=this.latestFeatureIndex.loadVTLayers(),ep=el.style.listImages(),e_=el.style.getBrightness();for(let eg in this.buckets){if(!el.style.hasLayer(eg))continue;let ey=this.buckets[eg],eb=ey.layers[0],ew=eb.sourceLayer||"_geojsonTileLayer",eT=ec[ew],eS=el.style.getLayerSourceCache(eb),eE={};eS&&(eE=eS._state.getState(ew,void 0));let eM=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},eI=Object.keys(eE).length>0&&!eh;(!eI||ey.stateDependentLayers.length||eh)&&ey.update(eE,eT,ep,eM,eI?ey.stateDependentLayers:ey.layers,eh,e_),(ey instanceof F.b2||ey instanceof F.b3)&&el._terrain&&el._terrain.enabled&&eS&&ey.uploadPending()&&el._terrain._clearRenderCacheForTile(eS.id,this.tileID);let eA=el&&el.style&&el.style.getOwnLayer(eg);eA&&(this.queryPadding=Math.max(this.queryPadding,eA.queryRadius(ey)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<F.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(el){this.symbolFadeHoldUntil=F.q.now()+el}setTexture(el,eh){let ec=eh.context,ep=ec.gl;this.texture=this.texture||eh.getTileTexture(el.width),this.texture&&this.texture instanceof F.T?this.texture.update(el):(this.texture=new F.T(ec,el,ep.RGBA8,{useMipmap:!0}),this.texture.bind(ep.LINEAR,ep.CLAMP_TO_EDGE))}setDependencies(F,el){let eh={};for(let F of el)eh[F]=!0;this.dependencies[F]=eh}hasDependency(F,el){for(let eh of F){let F=this.dependencies[eh];if(F){for(let eh of el)if(F[eh])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(el,eh){if(!eh||"mercator"===eh.name||this._tileDebugBuffer)return;let ec=F.b4(eQ,this.tileID.canonical,this.tileTransform)[0],ep=new F.b5,e_=new F.b6;for(let F=0;F<ec.length;F++){let{x:el,y:eh}=ec[F];ep.emplaceBack(el,eh),e_.emplaceBack(F)}e_.emplaceBack(0),this._tileDebugIndexBuffer=el.createIndexBuffer(e_),this._tileDebugBuffer=el.createVertexBuffer(ep,F.b7.members),this._tileDebugSegments=F.b8.simpleSegment(0,0,ep.length,e_.length)}_makeTileBoundsBuffers(el,eh){let ec,ep;if(this._tileBoundsBuffer||!eh||"mercator"===eh.name)return;let e_=F.b4(eQ,this.tileID.canonical,this.tileTransform)[0];if(this.isRaster){let el=function(el,eh){let ec=F.aR(el,eh),ep=Math.pow(2,el.z);for(let e_=0;e_<33;e_++)for(let eg=0;eg<33;eg++){let ey=F.aS((el.x+(eg+yt(eg))/32)/ep),eb=F.aT((el.y+(e_+yt(e_))/32)/ep),ew=eh.project(ey,eb),eT=33*e_+eg;eX[2*eT+0]=Math.round((ew.x*ec.scale-ec.x)*F.ai),eX[2*eT+1]=Math.round((ew.y*ec.scale-ec.y)*F.ai)}eK.fill(0),eJ.fill(0);for(let F=2045;F>=0;F--){let el=4*F,eh=eY[el+0],ec=eY[el+1],ep=eY[el+2],e_=eY[el+3],eg=eh+ep>>1,ey=ec+e_>>1,eb=eg+ey-ec,ew=ey+eh-eg,eT=33*ec+eh,eS=33*e_+ep,eE=33*ey+eg,eM=Math.hypot((eX[2*eT+0]+eX[2*eS+0])/2-eX[2*eE+0],(eX[2*eT+1]+eX[2*eS+1])/2-eX[2*eE+1])>=16;eK[eE]=eK[eE]||(eM?1:0),F<1022&&(eK[eE]=eK[eE]||eK[(ec+ew>>1)*33+(eh+eb>>1)]||eK[(e_+ew>>1)*33+(ep+eb>>1)])}let e_=new F.aU,eg=new F.aV,ey=0;function l(el,eh){let ec=33*eh+el;return 0===eJ[ec]&&(e_.emplaceBack(eX[2*ec+0],eX[2*ec+1],el*F.ai/32,eh*F.ai/32),eJ[ec]=++ey),eJ[ec]-1}function c(F,el,eh,ec,ep,e_){let ey=F+eh>>1,eb=el+ec>>1;if(Math.abs(F-ep)+Math.abs(el-e_)>1&&eK[33*eb+ey])c(ep,e_,F,el,ey,eb),c(eh,ec,ep,e_,ey,eb);else{let ey=l(F,el),eb=l(eh,ec),ew=l(ep,e_);eg.emplaceBack(ey,eb,ew)}}return c(0,0,32,32,32,0),c(32,32,0,0,0,32),{vertices:e_,indices:eg}}(this.tileID.canonical,eh);ec=el.vertices,ep=el.indices}else{for(let{x:el,y:eh}of(ec=new F.aU,ep=new F.aV,e_))ec.emplaceBack(el,eh,0,0);let el=F.b9(ec.int16,void 0,4);for(let F=0;F<el.length;F+=3)ep.emplaceBack(el[F],el[F+1],el[F+2])}this._tileBoundsBuffer=el.createVertexBuffer(ec,F.ba.members),this._tileBoundsIndexBuffer=el.createIndexBuffer(ep),this._tileBoundsSegments=F.b8.simpleSegment(0,0,ec.length,ep.length)}_makeGlobeTileDebugBuffers(el,eh){let ec;let ep=eh.projection;if(!ep||"globe"!==ep.name||eh.freezeTileCoverage)return;let e_=this.tileID.canonical,eg=F.bb(e_,eh),ey=F.bc(eg),eb=F.ag(eh.zoom);eb>0&&(ec=F.ad.mat4.invert(new Float64Array(16),eh.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(el,e_,eh,ey,ec,eb),this._makeGlobeTileDebugTextBuffer(el,e_,eh,ey,ec,eb)}_globePoint(el,eh,ec,ep,e_,eg,ey){let eb=F.bd(el,eh,ec);if(eg){let e_=1<<ec.z,ew=F.av(ep.center.lng),eT=F.aC(ep.center.lat),eS=(ec.x+.5)/e_-ew,eE=0;eS>.5?eE=-1:eS<-.5&&(eE=1);let eM=(el/F.ai+ec.x)/e_+eE,eI=(eh/F.ai+ec.y)/e_;eM=(eM-ew)*ep._pixelsPerMercatorPixel+ew,eI=(eI-eT)*ep._pixelsPerMercatorPixel+eT;let eA=[eM*ep.worldSize,eI*ep.worldSize,0];F.ad.vec3.transformMat4(eA,eA,eg),eb=F.be(eb,eA,ey)}return F.ad.vec3.transformMat4(eb,eb,e_)}_makeGlobeTileDebugBorderBuffer(el,eh,ec,ep,e_,eg){let ey=new F.b5,eb=new F.b6,ew=new F.bf,h=(F,el,eT,eS,eE)=>{let eM=(eT-F)/(eE-1),eI=(eS-el)/(eE-1),eA=ey.length;for(let eT=0;eT<eE;eT++){let eS=F+eT*eM,eE=el+eT*eI;ey.emplaceBack(eS,eE);let eC=this._globePoint(eS,eE,eh,ec,ep,e_,eg);ew.emplaceBack(eC[0],eC[1],eC[2]),eb.emplaceBack(eA+eT)}},eT=F.ai;h(0,0,eT,0,16),h(eT,0,eT,eT,16),h(eT,eT,0,eT,16),h(0,eT,0,0,16),this._tileDebugIndexBuffer=el.createIndexBuffer(eb),this._tileDebugBuffer=el.createVertexBuffer(ey,F.b7.members),this._globeTileDebugBorderBuffer=el.createVertexBuffer(ew,F.bg.members),this._tileDebugSegments=F.b8.simpleSegment(0,0,ey.length,eb.length)}_makeGlobeTileDebugTextBuffer(el,eh,ec,ep,e_,eg){let ey=F.ai/4,eb=new F.b5,ew=new F.aV,eT=new F.bf;ew.reserve(32),eb.reserve(25),eT.reserve(25);let u=(F,el)=>25*F+el;for(let F=0;F<25;F++){let el=F*ey;for(let F=0;F<25;F++){let ew=F*ey;eb.emplaceBack(ew,el);let eS=this._globePoint(ew,el,eh,ec,ep,e_,eg);eT.emplaceBack(eS[0],eS[1],eS[2])}}for(let F=0;F<4;F++)for(let el=0;el<4;el++){let eh=u(F,el),ec=u(F,el+1),ep=u(F+1,el),e_=u(F+1,el+1);ew.emplaceBack(eh,ec,ep),ew.emplaceBack(ep,ec,e_)}this._tileDebugTextIndexBuffer=el.createIndexBuffer(ew),this._tileDebugTextBuffer=el.createVertexBuffer(eb,F.b7.members),this._globeTileDebugTextBuffer=el.createVertexBuffer(eT,F.bg.members),this._tileDebugTextSegments=F.b8.simpleSegment(0,0,25,32)}destroy(el=!1){for(let F in this.buckets)this.buckets[F].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!el&&this.texture&&this.texture instanceof F.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}};F.bh.setPbf(F.bi);let wt=class wt extends bt{constructor(F,el,eh,ec,ep){super(F,el,eh,ec,ep),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(F){return this._mrt&&this._mrt.getLayer(F)}setTexture(el,eh){let ec=eh.context,ep=ec.gl;this.texture=this.texture||eh.getTileTexture(el.width),this.texture&&this.texture instanceof F.T?this.texture.update(el,{premultiply:!1}):this.texture=new F.T(ec,el,ep.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(el=16384,eh){let ec=this._mrt=new F.bh(30),ep=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(el-1)}});return this.entireBuffer=null,this.request=F.bj(ep,(F,ep,e_,eg)=>{if(F)eh(F);else try{let F=ec.getHeaderLength(ep);if(F>el)return void(this.request=this.fetchHeader(F,eh));ec.parseHeader(ep),this._isHeaderLoaded=!0;let ey=0;for(let F of Object.values(ec.layers))ey=Math.max(ey,F.dataIndex[F.dataIndex.length-1].lastByte);ep.byteLength>=ey&&(this.entireBuffer=ep),eh(null,this.entireBuffer||ep,e_,eg)}catch(F){eh(F)}}),this.request}fetchBand(el,eh,ec){let ep;let e_=this._mrt;if(!this._isHeaderLoaded||!e_)return void ec(Error("Tile header is not ready"));let eg=this.actor;if(!eg)return void ec(Error("Can't fetch tile band without an actor"));let a=(F,e_)=>{ep.complete(F,e_),F?ec(F):(this.updateTextureDescriptor(el,eh),ec(null,this.textureDescriptor&&this.textureDescriptor.img))},l=(F,el)=>{if(F)return ec(F);let eh=eg.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:el,task:ep},a,void 0,!0);this._workQueue.push(()=>{eh&&eh.cancel(),ep.cancel()})},ey=e_.getLayer(el);if(!ey)return void ec(Error(`Unknown sourceLayer "${el}"`));if(ey.hasDataForBand(eh))return this.updateTextureDescriptor(el,eh),void ec(null,this.textureDescriptor?this.textureDescriptor.img:null);let eb=ey.getDataRange([eh]);if((ep=e_.createDecodingTask(eb))&&!ep.tasks.length)ec(null);else if(this.flushQueues(),this.entireBuffer)l(null,this.entireBuffer.slice(eb.firstByte,eb.lastByte+1));else{let el=Object.assign({},this.requestParams,{headers:{Range:`bytes=${eb.firstByte}-${eb.lastByte}`}}),eh=F.bj(el,l);this._fetchQueue.push(()=>{eh.cancel(),ep.cancel()})}}updateNeeded(F,el){return(!this.textureDescriptor||this.textureDescriptor.band!==el||this.textureDescriptor.layer!==F)&&"errored"!==this.state}updateTextureDescriptor(el,eh){if(!this._mrt)return;let ec=this._mrt.getLayer(el);if(!ec||!ec.hasBand(eh)||!ec.hasDataForBand(eh))return;let{bytes:ep,tileSize:e_,buffer:eg,offset:ey,scale:eb}=ec.getBandView(eh),ew=e_+2*eg,eT=new F.r({width:ew,height:ew},ep),eS=this.texture;eS&&eS instanceof F.T&&eS.update(eT,{premultiply:!1}),this.textureDescriptor={layer:el,band:eh,img:eT,buffer:eg,offset:ey,tileSize:e_,format:ec.pixelFormat,mix:[eb,256*eb,65536*eb,16777216*eb]}}};let Tt=class Tt{constructor(F,el){this.max=F,this.onRemove=el,this.reset()}reset(){for(let F in this.data)for(let el of this.data[F])el.timeout&&clearTimeout(el.timeout),this.onRemove(el.value);return this.data={},this.order=[],this}add(F,el,eh){let ec=F.wrapped().key;void 0===this.data[ec]&&(this.data[ec]=[]);let ep={value:el,timeout:void 0};if(void 0!==eh&&(ep.timeout=setTimeout(()=>{this.remove(F,ep)},eh)),this.data[ec].push(ep),this.order.push(ec),this.order.length>this.max){let F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}has(F){return F.wrapped().key in this.data}getAndRemove(F){return this.has(F)?this._getAndRemoveByKey(F.wrapped().key):null}_getAndRemoveByKey(F){let el=this.data[F].shift();return el.timeout&&clearTimeout(el.timeout),0===this.data[F].length&&delete this.data[F],this.order.splice(this.order.indexOf(F),1),el.value}getByKey(F){let el=this.data[F];return el?el[0].value:null}get(F){return this.has(F)?this.data[F.wrapped().key][0].value:null}remove(F,el){if(!this.has(F))return this;let eh=F.wrapped().key,ec=void 0===el?0:this.data[eh].indexOf(el),ep=this.data[eh][ec];return this.data[eh].splice(ec,1),ep.timeout&&clearTimeout(ep.timeout),0===this.data[eh].length&&delete this.data[eh],this.onRemove(ep.value),this.order.splice(this.order.indexOf(eh),1),this}setMaxSize(F){for(this.max=F;this.order.length>this.max;){let F=this._getAndRemoveByKey(this.order[0]);F&&this.onRemove(F)}return this}filter(F){let el=[];for(let eh in this.data)for(let ec of this.data[eh])F(ec.value)||el.push(ec);for(let F of el)this.remove(F.value.tileID,F)}};let Et=class Et{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(el,eh,ec){let ep=String(eh);if(this.stateChanges[el]=this.stateChanges[el]||{},this.stateChanges[el][ep]=this.stateChanges[el][ep]||{},F.l(this.stateChanges[el][ep],ec),null===this.deletedStates[el])for(let F in this.deletedStates[el]={},this.state[el])F!==ep&&(this.deletedStates[el][F]=null);else if(this.deletedStates[el]&&null===this.deletedStates[el][ep])for(let F in this.deletedStates[el][ep]={},this.state[el][ep])ec[F]||(this.deletedStates[el][ep][F]=null);else for(let F in ec)this.deletedStates[el]&&this.deletedStates[el][ep]&&null===this.deletedStates[el][ep][F]&&delete this.deletedStates[el][ep][F]}removeFeatureState(F,el,eh){if(null===this.deletedStates[F])return;let ec=String(el);if(this.deletedStates[F]=this.deletedStates[F]||{},eh&&void 0!==el)null!==this.deletedStates[F][ec]&&(this.deletedStates[F][ec]=this.deletedStates[F][ec]||{},this.deletedStates[F][ec][eh]=null);else if(void 0!==el){if(this.stateChanges[F]&&this.stateChanges[F][ec])for(eh in this.deletedStates[F][ec]={},this.stateChanges[F][ec])this.deletedStates[F][ec][eh]=null;else this.deletedStates[F][ec]=null}else this.deletedStates[F]=null}getState(el,eh){let ec=this.state[el]||{},ep=this.stateChanges[el]||{},e_=this.deletedStates[el];if(null===e_)return{};if(void 0!==eh){let el=String(eh),eg=F.l({},ec[el],ep[el]);if(e_){let F=e_[eh];if(null===F)return{};for(let el in F)delete eg[el]}return eg}let eg=F.l({},ec,ep);if(e_)for(let F in e_)delete eg[F];return eg}initializeTileState(F,el){F.refreshFeatureState(el)}coalesceChanges(el,eh){let ec={};for(let el in this.stateChanges){this.state[el]=this.state[el]||{};let eh={};for(let ec in this.stateChanges[el])this.state[el][ec]||(this.state[el][ec]={}),F.l(this.state[el][ec],this.stateChanges[el][ec]),eh[ec]=this.state[el][ec];ec[el]=eh}for(let el in this.deletedStates){this.state[el]=this.state[el]||{};let eh={};if(null===this.deletedStates[el])for(let F in this.state[el])eh[F]={},this.state[el][F]={};else for(let F in this.deletedStates[el]){if(null===this.deletedStates[el][F])this.state[el][F]={};else if(this.state[el][F])for(let eh of Object.keys(this.deletedStates[el][F]))delete this.state[el][F][eh];eh[F]=this.state[el][F]}ec[el]=ec[el]||{},F.l(ec[el],eh)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(ec).length)for(let F in el)el[F].refreshFeatureState(eh)}};let St=class St extends F.E{constructor(F,el,eh){super(),this.id=F,this._onlySymbols=eh,el.on("data",F=>{"source"===F.dataType&&"metadata"===F.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===F.dataType&&"content"===F.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),el.on("error",()=>{this._sourceErrored=!0}),this._source=el,this._tiles={},this._cache=new Tt(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=el.minTileCacheSize,this._maxTileCacheSize=el.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Et,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(F){this.map=F,this._minTileCacheSize=void 0===this._minTileCacheSize&&F?F._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&F?F._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(let F in this._tiles)if(!this._tiles[F].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;let F=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,F&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(F,el){return F.isSymbolTile=this._onlySymbols,F.isExtraShadowCaster=this._shadowCasterTiles[F.tileID.key],this._source.loadTile(F,el)}_unloadTile(F){if(this._source.unloadTile)return this._source.unloadTile(F)}_abortTile(F){if(this._source.abortTile)return this._source.abortTile(F)}serialize(){return this._source.serialize()}prepare(F){for(let el in this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null),this._tiles){let eh=this._tiles[el];eh.upload(F),eh.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map(F=>F.tileID).sort(Ct).map(F=>F.key)}getRenderableIds(el,eh){let ec=[];for(let F in this._tiles)this._isIdRenderable(+F,el,eh)&&ec.push(this._tiles[F]);return el?ec.sort((el,eh)=>{let ec=el.tileID,ep=eh.tileID,e_=new F.P(ec.canonical.x,ec.canonical.y)._rotate(this.transform.angle),eg=new F.P(ep.canonical.x,ep.canonical.y)._rotate(this.transform.angle);return ec.overscaledZ-ep.overscaledZ||eg.y-e_.y||eg.x-e_.x}).map(F=>F.tileID.key):ec.map(F=>F.tileID).sort(Ct).map(F=>F.key)}hasRenderableParent(F){let el=this.findLoadedParent(F,0);return!!el&&this._isIdRenderable(el.tileID.key)}_isIdRenderable(F,el,eh){return this._tiles[F]&&this._tiles[F].hasData()&&!this._coveredTiles[F]&&(el||!this._tiles[F].holdingForFade())&&(eh||!this._shadowCasterTiles[F])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else for(let F in this._cache.reset(),this._tiles)"errored"!==this._tiles[F].state&&this._reloadTile(+F,"reloading")}_reloadTile(F,el){let eh=this._tiles[F];eh&&("loading"!==eh.state&&(eh.state=el),this._loadTile(eh,this._tileLoaded.bind(this,eh,F,el)))}_tileLoaded(el,eh,ec,ep){if(ep){if(el.state="errored",404!==ep.status)this._source.fire(new F.z(ep,{tile:el}));else{if(this._source.fire(new F.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:el})),!(el.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){let F=this.map.painter.terrain;this.update(this.transform,F.getScaledDemTileSize(),!0),F.resetTileLookupCache(this.id)}else this.update(this.transform)}}else el.timeAdded=F.q.now(),"expired"===ec&&(el.refreshedUponExpiration=!0),this._setTileReloadTimer(eh,el),"raster-dem"===this._source.type&&el.dem&&this._backfillDEM(el),this._state.initializeTileState(el,this.map?this.map.painter:null),this._source.fire(new F.A("data",{dataType:"source",tile:el,coord:el.tileID,sourceCacheId:this.id}))}_backfillDEM(F){let el=this.getRenderableIds();for(let eh=0;eh<el.length;eh++){let ec=el[eh];if(F.neighboringTiles&&F.neighboringTiles[ec]){let el=this.getTileByID(ec);i(F,el),i(el,F)}}function i(F,el){if(!F.dem||F.dem.borderReady)return;F.needsHillshadePrepare=!0,F.needsDEMTextureUpload=!0;let eh=el.tileID.canonical.x-F.tileID.canonical.x,ec=el.tileID.canonical.y-F.tileID.canonical.y,ep=Math.pow(2,F.tileID.canonical.z),e_=el.tileID.key;0===eh&&0===ec||Math.abs(ec)>1||(Math.abs(eh)>1&&(1===Math.abs(eh+ep)?eh+=ep:1===Math.abs(eh-ep)&&(eh-=ep)),el.dem&&F.dem&&(F.dem.backfillBorder(el.dem,eh,ec),F.neighboringTiles&&F.neighboringTiles[e_]&&(F.neighboringTiles[e_].backfilled=!0)))}}getTile(F){return this.getTileByID(F.key)}getTileByID(F){return this._tiles[F]}_retainLoadedChildren(F,el,eh,ec){for(let ep in this._tiles){let e_=this._tiles[ep];if(ec[ep]||!e_.hasData()||e_.tileID.overscaledZ<=el||e_.tileID.overscaledZ>eh)continue;let eg=e_.tileID;for(;e_&&e_.tileID.overscaledZ>el+1;){let F=e_.tileID.scaledTo(e_.tileID.overscaledZ-1);(e_=this._tiles[F.key])&&e_.hasData()&&(eg=F)}let ey=eg;for(;ey.overscaledZ>el;)if(F[(ey=ey.scaledTo(ey.overscaledZ-1)).key]){ec[eg.key]=eg;break}}}findLoadedParent(F,el){if(F.key in this._loadedParentTiles){let eh=this._loadedParentTiles[F.key];return eh&&eh.tileID.overscaledZ>=el?eh:null}for(let eh=F.overscaledZ-1;eh>=el;eh--){let el=F.scaledTo(eh),ec=this._getLoadedTile(el);if(ec)return ec}}_getLoadedTile(F){let el=this._tiles[F.key];return el&&el.hasData()?el:this._cache.getByKey(this._source.reparseOverscaled?F.wrapped().key:F.canonical.key)}updateCacheSize(F,el){el=el||this._source.tileSize;let eh=Math.ceil(F.width/el)+1,ec=Math.ceil(F.height/el)+1,ep=Math.floor(eh*ec*5),e_="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,ep):ep,eg="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,e_):e_;this._cache.setMaxSize(eg)}handleWrapJump(F){let el=Math.round((F-(void 0===this._prevLng?F:this._prevLng))/360);if(this._prevLng=F,el){let F={};for(let eh in this._tiles){let ec=this._tiles[eh];ec.tileID=ec.tileID.unwrapTo(ec.tileID.wrap+el),F[ec.tileID.key]=ec}for(let el in this._tiles=F,this._timers)clearTimeout(this._timers[el]),delete this._timers[el];for(let F in this._tiles)this._setTileReloadTimer(+F,this._tiles[F])}}update(el,eh,ec,ep){if(this.transform=el,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!ec)return;this.updateCacheSize(el,eh),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};let e_="batched-model"===this._source.type,eg,ey=this._source.maxzoom,eb=this.map&&this.map.painter?this.map.painter._terrain:null;if(eb&&eb.sourceCache===this&&eb.attenuationRange()){let F=eb.attenuationRange()[0],el=Math.floor(F)-Math.log2(eb.getDemUpscale());ey>el&&(ey=el)}if(this.used||this.usedForTerrain){if(this._source.tileID)eg=el.getVisibleUnwrappedCoordinates(this._source.tileID).map(el=>new F.aH(el.canonical.z,el.wrap,el.canonical.z,el.canonical.x,el.canonical.y));else if(0!==this.tileCoverLift){let ep=el.clone();ep.tileCoverLift=this.tileCoverLift,eg=ep.coveringTiles({tileSize:eh||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:ey,roundZoom:this._source.roundZoom&&!ec,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:e_}),this._source.minzoom<=1&&"globe"===el.projection.name&&(eg.push(new F.aH(1,0,1,0,0)),eg.push(new F.aH(1,0,1,1,0)),eg.push(new F.aH(1,0,1,0,1)),eg.push(new F.aH(1,0,1,1,1)))}else if(eg=el.coveringTiles({tileSize:eh||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:ey,roundZoom:this._source.roundZoom&&!ec,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:e_}),this._source.hasTile){let F=this._source.hasTile.bind(this._source);eg=eg.filter(el=>F(el))}}else eg=[];if(eg.length>0&&this.castsShadows&&ep&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!It(this._source.type)){let F=el.coveringZoomLevel({tileSize:eh||this._source.tileSize,roundZoom:this._source.roundZoom&&!ec}),ey=Math.min(F,this._source.maxzoom);if(e_){let F=el.extendTileCover(eg,ey);for(let el of F)eg.push(el)}else{let F=el.extendTileCover(eg,ey,ep);for(let el of F)this._shadowCasterTiles[el.key]=!0,eg.push(el)}}let ew=this._updateRetainedTiles(eg);if(It(this._source.type)&&0!==eg.length){let el={},eh={},ec=Object.keys(ew);for(let ep of ec){let ec=ew[ep],e_=this._tiles[ep];if(!e_||e_.fadeEndTime&&e_.fadeEndTime<=F.q.now())continue;let eg=this.findLoadedParent(ec,Math.max(ec.overscaledZ-St.maxOverzooming,this._source.minzoom));eg&&(this._addTile(eg.tileID),el[eg.tileID.key]=eg.tileID),eh[ep]=ec}let ep=eg[eg.length-1].overscaledZ;for(let F in this._tiles){let el=this._tiles[F];if(ew[F]||!el.hasData())continue;let ec=el.tileID;for(;ec.overscaledZ>ep;){ec=ec.scaledTo(ec.overscaledZ-1);let ep=this._tiles[ec.key];if(ep&&ep.hasData()&&eh[ec.key]){ew[F]=el.tileID;break}}}for(let F in el)ew[F]||(this._coveredTiles[F]=!0,ew[F]=el[F])}for(let F in ew)this._tiles[F].clearFadeHold();let eT=F.bk(this._tiles,ew);for(let F of eT){let el=this._tiles[F];el.hasSymbolBuckets&&!el.holdingForFade()?el.setHoldDuration(this.map._fadeDuration):el.hasSymbolBuckets&&!el.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(let F in this._tiles)this._tiles[F].holdingForFade()&&this._removeTile(+F)}_updateRetainedTiles(F){let el={};if(0===F.length)return el;let eh={},ec=F.reduce((F,el)=>Math.min(F,el.overscaledZ),1/0),ep=F[0].overscaledZ,e_=Math.max(ep-St.maxOverzooming,this._source.minzoom),eg=Math.max(ep+St.maxUnderzooming,this._source.minzoom),ey={};for(let eh of F){let F=this._addTile(eh);el[eh.key]=eh,F.hasData()||ec<this._source.maxzoom&&(ey[eh.key]=eh)}for(let ep of(this._retainLoadedChildren(ey,ec,eg,el),F)){let F=this._tiles[ep.key];if(F.hasData())continue;if(ep.canonical.z>=this._source.maxzoom){let F=ep.children(this._source.maxzoom)[0],eh=this.getTile(F);if(eh&&eh.hasData()){el[F.key]=F;continue}}else{let F=ep.children(this._source.maxzoom);if(el[F[0].key]&&el[F[1].key]&&el[F[2].key]&&el[F[3].key])continue}let ec=F.wasRequested();for(let eg=ep.overscaledZ-1;eg>=e_;--eg){let e_=ep.scaledTo(eg);if(eh[e_.key]||(eh[e_.key]=!0,(F=this.getTile(e_))||!ec||(F=this._addTile(e_)),F&&(el[e_.key]=e_,ec=F.wasRequested(),F.hasData())))break}}return el}_updateLoadedParentTileCache(){for(let F in this._loadedParentTiles={},this._tiles){let el=[],eh,ec=this._tiles[F].tileID;for(;ec.overscaledZ>0;){if(ec.key in this._loadedParentTiles){eh=this._loadedParentTiles[ec.key];break}el.push(ec.key);let F=ec.scaledTo(ec.overscaledZ-1);if(eh=this._getLoadedTile(F))break;ec=F}for(let F of el)this._loadedParentTiles[F]=eh}}_addTile(el){let eh=this._tiles[el.key];if(eh)return!0!==eh.isExtraShadowCaster||this._shadowCasterTiles[el.key]||this._reloadTile(el.key,"reloading"),eh;(eh=this._cache.getAndRemove(el))&&(this._setTileReloadTimer(el.key,eh),eh.tileID=el,this._state.initializeTileState(eh,this.map?this.map.painter:null),this._cacheTimers[el.key]&&(clearTimeout(this._cacheTimers[el.key]),delete this._cacheTimers[el.key],this._setTileReloadTimer(el.key,eh)));let ec=!!eh;if(!ec){let F=this.map?this.map.painter:null,ec=this._source.tileSize*el.overscaleFactor();eh="raster-array"===this._source.type?new wt(el,ec,this.transform.tileZoom,F,this._isRaster):new bt(el,ec,this.transform.tileZoom,F,this._isRaster),this._loadTile(eh,this._tileLoaded.bind(this,eh,el.key,eh.state))}return eh?(eh.uses++,this._tiles[el.key]=eh,ec||this._source.fire(new F.A("dataloading",{tile:eh,coord:eh.tileID,dataType:"source"})),eh):null}_setTileReloadTimer(F,el){F in this._timers&&(clearTimeout(this._timers[F]),delete this._timers[F]);let eh=el.getExpiryTimeout();eh&&(this._timers[F]=setTimeout(()=>{this._reloadTile(F,"expired"),delete this._timers[F]},eh))}_removeTile(F){let el=this._tiles[F];el&&(el.uses--,delete this._tiles[F],this._timers[F]&&(clearTimeout(this._timers[F]),delete this._timers[F]),el.uses>0||(el.hasData()&&"reloading"!==el.state||"empty"===el.state?this._cache.add(el.tileID,el,el.getExpiryTimeout()):(el.aborted=!0,this._abortTile(el),this._unloadTile(el))))}clearTiles(){for(let F in this._shouldReloadOnResume=!1,this._paused=!1,this._tiles)this._removeTile(+F);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(el,eh,ec){let ep=[],e_=this.transform;if(!e_)return ep;let eg="globe"===e_.projection.name,ey=F.av(e_.center.lng);for(let eb in this._tiles){let ew;let eT=this._tiles[eb];if(ec&&eT.clearQueryDebugViz(),!eT.holdingForFade()){if(eg){let el=eT.tileID.canonical;if(0===el.z){let eh=[Math.abs(F.ay(ey,...Rt(el,-1))-ey),Math.abs(F.ay(ey,...Rt(el,1))-ey)];ew=[0,2*eh.indexOf(Math.min(...eh))-1]}else{let eh=[Math.abs(F.ay(ey,...Rt(el,-1))-ey),Math.abs(F.ay(ey,...Rt(el,0))-ey),Math.abs(F.ay(ey,...Rt(el,1))-ey)];ew=[eh.indexOf(Math.min(...eh))-1]}}else ew=[0];for(let F of ew){let ec=el.containsTile(eT,e_,eh,F);ec&&ep.push(ec)}}}return ep}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(F){return this._getRenderableCoordinates(F)}_getRenderableCoordinates(F,el){let eh=this.getRenderableIds(F,el).map(F=>this._tiles[F].tileID),ec="globe"===this.transform.projection.name;for(let F of eh)F.projMatrix=this.transform.calculateProjMatrix(F.toUnwrapped()),F.expandedProjMatrix=ec?this.transform.calculateProjMatrix(F.toUnwrapped(),!1,!0):F.projMatrix;return eh}sortCoordinatesByDistance(F){let el=F.slice(),eh=this.transform._camera.position,ec=this.transform._camera.forward(),ep={};for(let F of el){let el=1/(1<<F.canonical.z);ep[F.key]=((F.canonical.x+.5)*el+F.wrap-eh[0])*ec[0]+((F.canonical.y+.5)*el-eh[1])*ec[1]-eh[2]*ec[2]}return el.sort((F,el)=>ep[F.key]-ep[el.key]),el}hasTransition(){if(this._source.hasTransition())return!0;if(It(this._source.type))for(let el in this._tiles){let eh=this._tiles[el];if(void 0!==eh.fadeEndTime&&eh.fadeEndTime>=F.q.now())return!0}return!1}setFeatureState(F,el,eh){this._state.updateState(F=F||"_geojsonTileLayer",el,eh)}removeFeatureState(F,el,eh){this._state.removeFeatureState(F=F||"_geojsonTileLayer",el,eh)}getFeatureState(F,el){return this._state.getState(F=F||"_geojsonTileLayer",el)}setDependencies(F,el,eh){let ec=this._tiles[F];ec&&ec.setDependencies(el,eh)}reloadTilesForDependencies(F,el){for(let eh in this._tiles)this._tiles[eh].hasDependency(F,el)&&this._reloadTile(+eh,"reloading");this._cache.filter(eh=>!eh.hasDependency(F,el))}_preloadTiles(el,eh){if(!this._sourceLoaded){let e=()=>{this._sourceLoaded&&(this._source.off("data",e),this._preloadTiles(el,eh))};return void this._source.on("data",e)}let ec=new Map,ep=Array.isArray(el)?el:[el],e_=this.map.painter.terrain,eg=this.usedForTerrain&&e_?e_.getScaledDemTileSize():this._source.tileSize;for(let F of ep){let el=F.coveringTiles({tileSize:eg,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(let F of el)ec.set(F.key,F);this.usedForTerrain&&F.updateElevation(!1)}let ey=Array.from(ec.values());F.bl(ey,(F,el)=>{let eh=new bt(F,this._source.tileSize*F.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(eh,F=>{"raster-dem"===this._source.type&&eh.dem&&this._backfillDEM(eh),el(F,eh)})},eh)}};function Ct(F,el){let eh=Math.abs(2*F.wrap)-+(F.wrap<0),ec=Math.abs(2*el.wrap)-+(el.wrap<0);return F.overscaledZ-el.overscaledZ||ec-eh||el.canonical.y-F.canonical.y||el.canonical.x-F.canonical.x}function It(F){return"raster"===F||"image"===F||"video"===F||"custom"===F}function Rt(F,el){let eh=1<<F.z;return[F.x/eh+el,(F.x+1)/eh+el]}St.maxOverzooming=10,St.maxUnderzooming=3;let Dt=class Dt{constructor(F){this.style=F,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){for(let F in this.layers=[],this.style._mergedLayers){let el=this.style._mergedLayers[F];if("fill-extrusion"===el.type)this.layers.push({layer:el,visible:!1,visibilityChanged:!1});else if("model"===el.type){let F=this.style.getLayerSource(el);F&&"batched-model"===F.type&&this.layers.push({layer:el,visible:!1,visibilityChanged:!1})}}}onNewFrame(F){for(let el of(this.layersGotHidden=!1,this.layers)){let eh=el.layer,ec=!1;"fill-extrusion"===eh.type?ec=!eh.isHidden(F)&&eh.paint.get("fill-extrusion-opacity")>0:"model"===eh.type&&(ec=!eh.isHidden(F)&&eh.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!ec&&el.visible,el.visible=ec}}updateZOffset(F,el){for(let F of(this.currentBuildingBuckets=[],this.layers)){let eh=F.layer,ec=this.style.getLayerSourceCache(eh),ep=1;"fill-extrusion"===eh.type&&(ep=F.visible?eh.paint.get("fill-extrusion-vertical-scale"):0);let e_=ec?ec.getTile(el):null;if(!e_&&ec&&el.canonical.z>ec.getSource().minzoom){let F=el.scaledTo(Math.min(ec.getSource().maxzoom,el.overscaledZ-1));for(;F.overscaledZ>=ec.getSource().minzoom&&!(e_=ec.getTile(F))&&0!==F.overscaledZ;)F=F.scaledTo(F.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:e_?e_.getBucket(eh):null,tileID:e_?e_.tileID:el,verticalScale:ep})}F.hasAnyZOffset=!1;let eh=!1;for(let ec=0;ec<F.symbolInstances.length;ec++){let ep=F.symbolInstances.get(ec),e_=ep.zOffset,eg=this._getHeightAtTileOffset(el,ep.tileAnchorX,ep.tileAnchorY);ep.zOffset=eg!==Number.NEGATIVE_INFINITY?eg:e_,eh||e_===ep.zOffset||(eh=!0),F.hasAnyZOffset||0===ep.zOffset||(F.hasAnyZOffset=!0)}eh&&(F.zOffsetBuffersNeedUpload=!0,F.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(el,eh,ec,ep){let e_=eh,eg=ec;if(el.canonical.z!==ep.canonical.z){let ey=ep.canonical,eb=1/(1<<el.canonical.z-ey.z);e_=(eh+el.canonical.x*F.ai)*eb-ey.x*F.ai|0,eg=(ec+el.canonical.y*F.ai)*eb-ey.y*F.ai|0}return{tileX:e_,tileY:eg}}_getHeightAtTileOffset(F,el,eh){let ec,ep;for(let e_=0;e_<this.layers.length;++e_){if("fill-extrusion"!==this.layers[e_].layer.type)continue;let{bucket:eg,tileID:ey,verticalScale:eb}=this.currentBuildingBuckets[e_];if(!eg)continue;let{tileX:ew,tileY:eT}=this._mapCoordToOverlappingTile(F,el,eh,ey),eS=eg.getHeightAtTileCoord(ew,eT);eS&&void 0!==eS.height&&(eS.hidden?ec=eS.height:ep=Math.max(eS.height*eb,ep||0))}if(void 0!==ep)return ep;for(let ep=0;ep<this.layers.length;++ep){let e_=this.layers[ep];if("model"!==e_.layer.type||!e_.visible)continue;let{bucket:eg,tileID:ey}=this.currentBuildingBuckets[ep];if(!eg)continue;let{tileX:eb,tileY:ew}=this._mapCoordToOverlappingTile(F,el,eh,ey),eT=eg.getHeightAtTileCoord(eb,ew);if(eT&&!eT.hidden)return void 0===eT.height&&void 0!==ec?Math.min(eT.maxHeight,ec)*eT.verticalScale:eT.height?eT.height*eT.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}};function Lt(el){el=el.slice();let eh=Object.create(null);for(let F=0;F<el.length;F++)eh[el[F].id]=el[F];for(let ec=0;ec<el.length;ec++)"ref"in el[ec]&&(el[ec]=function(el,eh){let ec={};for(let F in el)"ref"!==F&&(ec[F]=el[F]);return F.bm.forEach(F=>{F in eh&&(ec[F]=eh[F])}),ec}(el[ec],eh[el[ec].ref]));return el}let e0={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function Pt(F,el,eh){eh.push({command:e0.addSource,args:[F,el[F]]})}function zt(F,el,eh){el.push({command:e0.removeSource,args:[F]}),eh[F]=!0}function kt(el,eh,ec,ep,e_,eg){let ey;for(ey in eh=eh||{},el=el||{})el.hasOwnProperty(ey)&&(F.bn(el[ey],eh[ey])||ec.push({command:eg,args:[ep,ey,eh[ey],e_]}));for(ey in eh)eh.hasOwnProperty(ey)&&!el.hasOwnProperty(ey)&&(F.bn(el[ey],eh[ey])||ec.push({command:eg,args:[ep,ey,eh[ey],e_]}))}function Bt(F){return F.id}function Nt(F,el){return F[el.id]=el,F}let Ut=class Ut{constructor(F,el){this.reset(F,el)}reset(F,el){this.points=F||[],this._distances=[0];for(let F=1;F<this.points.length;F++)this._distances[F]=this._distances[F-1]+this.points[F].dist(this.points[F-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(el||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(el){if(1===this.points.length)return this.points[0];el=F.ay(el,0,1);let eh=1,ec=this._distances[eh],ep=el*this.paddedLength+this.padding;for(;ec<ep&&eh<this._distances.length;)ec=this._distances[++eh];let e_=eh-1,eg=this._distances[e_],ey=ec-eg,eb=ey>0?(ep-eg)/ey:0;return this.points[e_].mult(1-eb).add(this.points[eh].mult(eb))}};let Vt=class Vt{constructor(F,el,eh){let ec=this.boxCells=[],ep=this.circleCells=[];this.xCellCount=Math.ceil(F/eh),this.yCellCount=Math.ceil(el/eh);for(let F=0;F<this.xCellCount*this.yCellCount;F++)ec.push([]),ep.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=F,this.height=el,this.xScale=this.xCellCount/F,this.yScale=this.yCellCount/el,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(F,el,eh,ec,ep){this._forEachCell(el,eh,ec,ep,this._insertBoxCell,this.boxUid++),this.boxKeys.push(F),this.bboxes.push(el),this.bboxes.push(eh),this.bboxes.push(ec),this.bboxes.push(ep)}insertCircle(F,el,eh,ec){this._forEachCell(el-ec,eh-ec,el+ec,eh+ec,this._insertCircleCell,this.circleUid++),this.circleKeys.push(F),this.circles.push(el),this.circles.push(eh),this.circles.push(ec)}_insertBoxCell(F,el,eh,ec,ep,e_){this.boxCells[ep].push(e_)}_insertCircleCell(F,el,eh,ec,ep,e_){this.circleCells[ep].push(e_)}_query(F,el,eh,ec,ep,e_){if(eh<0||F>this.width||ec<0||el>this.height)return!ep&&[];let eg=[];if(F<=0&&el<=0&&this.width<=eh&&this.height<=ec){if(ep)return!0;for(let F=0;F<this.boxKeys.length;F++)eg.push({key:this.boxKeys[F],x1:this.bboxes[4*F],y1:this.bboxes[4*F+1],x2:this.bboxes[4*F+2],y2:this.bboxes[4*F+3]});for(let F=0;F<this.circleKeys.length;F++){let el=this.circles[3*F],eh=this.circles[3*F+1],ec=this.circles[3*F+2];eg.push({key:this.circleKeys[F],x1:el-ec,y1:eh-ec,x2:el+ec,y2:eh+ec})}return e_?eg.filter(e_):eg}return this._forEachCell(F,el,eh,ec,this._queryCell,eg,{hitTest:ep,seenUids:{box:{},circle:{}}},e_),ep?eg.length>0:eg}_queryCircle(F,el,eh,ec,ep){let e_=F-eh,eg=F+eh,ey=el-eh,eb=el+eh;if(eg<0||e_>this.width||eb<0||ey>this.height)return!ec&&[];let ew=[];return this._forEachCell(e_,ey,eg,eb,this._queryCellCircle,ew,{hitTest:ec,circle:{x:F,y:el,radius:eh},seenUids:{box:{},circle:{}}},ep),ec?ew.length>0:ew}query(F,el,eh,ec,ep){return this._query(F,el,eh,ec,!1,ep)}hitTest(F,el,eh,ec,ep){return this._query(F,el,eh,ec,!0,ep)}hitTestCircle(F,el,eh,ec){return this._queryCircle(F,el,eh,!0,ec)}_queryCell(F,el,eh,ec,ep,e_,eg,ey){let eb=eg.seenUids,ew=this.boxCells[ep];if(null!==ew){let ep=this.bboxes;for(let eT of ew)if(!eb.box[eT]){eb.box[eT]=!0;let ew=4*eT;if(F<=ep[ew+2]&&el<=ep[ew+3]&&eh>=ep[ew+0]&&ec>=ep[ew+1]&&(!ey||ey(this.boxKeys[eT]))){if(eg.hitTest)return e_.push(!0),!0;e_.push({key:this.boxKeys[eT],x1:ep[ew],y1:ep[ew+1],x2:ep[ew+2],y2:ep[ew+3]})}}}let eT=this.circleCells[ep];if(null!==eT){let ep=this.circles;for(let ew of eT)if(!eb.circle[ew]){eb.circle[ew]=!0;let eT=3*ew;if(this._circleAndRectCollide(ep[eT],ep[eT+1],ep[eT+2],F,el,eh,ec)&&(!ey||ey(this.circleKeys[ew]))){if(eg.hitTest)return e_.push(!0),!0;{let F=ep[eT],el=ep[eT+1],eh=ep[eT+2];e_.push({key:this.circleKeys[ew],x1:F-eh,y1:el-eh,x2:F+eh,y2:el+eh})}}}}}_queryCellCircle(F,el,eh,ec,ep,e_,eg,ey){let eb=eg.circle,ew=eg.seenUids,eT=this.boxCells[ep];if(null!==eT){let F=this.bboxes;for(let el of eT)if(!ew.box[el]){ew.box[el]=!0;let eh=4*el;if(this._circleAndRectCollide(eb.x,eb.y,eb.radius,F[eh+0],F[eh+1],F[eh+2],F[eh+3])&&(!ey||ey(this.boxKeys[el])))return e_.push(!0),!0}}let eS=this.circleCells[ep];if(null!==eS){let F=this.circles;for(let el of eS)if(!ew.circle[el]){ew.circle[el]=!0;let eh=3*el;if(this._circlesCollide(F[eh],F[eh+1],F[eh+2],eb.x,eb.y,eb.radius)&&(!ey||ey(this.circleKeys[el])))return e_.push(!0),!0}}}_forEachCell(F,el,eh,ec,ep,e_,eg,ey){let eb=this._convertToXCellCoord(F),ew=this._convertToYCellCoord(el),eT=this._convertToXCellCoord(eh),eS=this._convertToYCellCoord(ec);for(let eE=eb;eE<=eT;eE++)for(let eb=ew;eb<=eS;eb++)if(ep.call(this,F,el,eh,ec,this.xCellCount*eb+eE,e_,eg,ey))return}_convertToXCellCoord(F){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(F*this.xScale)))}_convertToYCellCoord(F){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(F*this.yScale)))}_circlesCollide(F,el,eh,ec,ep,e_){let eg=ec-F,ey=ep-el,eb=eh+e_;return eb*eb>eg*eg+ey*ey}_circleAndRectCollide(F,el,eh,ec,ep,e_,eg){let ey=(e_-ec)/2,eb=Math.abs(F-(ec+ey));if(eb>ey+eh)return!1;let ew=(eg-ep)/2,eT=Math.abs(el-(ep+ew));if(eT>ew+eh)return!1;if(eb<=ey||eT<=ew)return!0;let eS=eb-ey,eE=eT-ew;return eS*eS+eE*eE<=eh*eh}};let e1={unknown:0,flipRequired:1,flipNotRequired:2},e2=Math.tan(85*Math.PI/180);function qt(el,eh,ec,ep,e_,eg,ey){let eb=F.ad.mat4.create();if(ec){if("globe"===eg.name){let el=F.bo(e_,eh);F.ad.mat4.multiply(eb,eb,el)}else{let el=F.ad.mat2.invert([],ey);eb[0]=el[0],eb[1]=el[1],eb[4]=el[2],eb[5]=el[3],ep||F.ad.mat4.rotateZ(eb,eb,e_.angle)}}else F.ad.mat4.multiply(eb,e_.labelPlaneMatrix,el);return eb}function Ht(F,el,eh,ec,ep,e_,eg){let ey=qt(F,el,eh,ec,ep,e_,eg);return"globe"===e_.name&&eh||(ey[2]=ey[6]=ey[10]=ey[14]=0),ey}function Zt(el,eh,ec,ep,e_,eg,ey){if(ec){if("globe"===eg.name){let eb=qt(el,eh,ec,ep,e_,eg,ey);return F.ad.mat4.invert(eb,eb),F.ad.mat4.multiply(eb,el,eb),eb}{let eh=F.ad.mat4.clone(el),ec=F.ad.mat4.identity([]);return ec[0]=ey[0],ec[1]=ey[1],ec[4]=ey[2],ec[5]=ey[3],F.ad.mat4.multiply(eh,eh,ec),ep||F.ad.mat4.rotateZ(eh,eh,-e_.angle),eh}}return e_.glCoordMatrix}function Wt(el,eh,ec,ep){let e_=[el,eh,ec,1];ec?F.ad.vec4.transformMat4(e_,e_,ep):si(e_,e_,ep);let eg=e_[3];return e_[0]/=eg,e_[1]/=eg,e_[2]/=eg,e_}function $t(F,el){return Math.min(.5+F/el*.5,1.5)}function Kt(el,eh,ec,ep,e_,eg,ey,eb,ew,eT){let eS=ec.transform,eE=ep?el.textSizeData:el.iconSizeData,eM=F.bp(eE,ec.transform.zoom),eI="globe"===eS.projection.name,eA=[256/ec.width*2+1,256/ec.height*2+1],eC=ep?el.text.dynamicLayoutVertexArray:el.icon.dynamicLayoutVertexArray;eC.clear();let eP=null;eI&&(eP=ep?el.text.globeExtVertexArray:el.icon.globeExtVertexArray);let ez=el.lineVertexArray,eD=ep?el.text.placedSymbolArray:el.icon.placedSymbolArray,eR=ec.transform.width/ec.transform.height,eL,eO=!1;for(let ep=0;ep<eD.length;ep++){let eI=eD.get(ep),{numGlyphs:ek,writingMode:eF}=eI;if(eF!==F.bq.vertical||eO||eL===F.bq.horizontal||(eO=!0),eL=eF,(eI.hidden||eF===F.bq.vertical)&&!eO){oi(ek,eC);continue}eO=!1;let eB=new F.P(eI.tileAnchorX,eI.tileAnchorY),{x:eN,y:eV,z:eU}=eS.projection.projectTilePoint(eB.x,eB.y,eT.canonical);if(ew){let[F,el,eh]=ew(eB);eN+=F,eV+=el,eU+=eh}let ej=[eN,eV,eU,1];if(F.ad.vec4.transformMat4(ej,ej,eh),!function(F,el){let eh=F[0]/F[3],ec=F[1]/F[3];return eh>=-el[0]&&eh<=el[0]&&ec>=-el[1]&&ec<=el[1]}(ej,eA)){oi(ek,eC);continue}let eG=ej[3],eq=$t(ec.transform.getCameraToCenterDistance(eS.projection),eG),e$=F.br(eE,eM,eI),eH=ey?e$/eq:e$*eq,eZ=Wt(eN,eV,eU,e_);if(eZ[3]<=0){oi(ek,eC);continue}let eW={},eY=F.ak(el.layers[0].layout.get("text-max-angle")),eX=Math.cos(eY),eK=ey?null:ew,eJ=Qt(eI,eH,!1,eb,eh,e_,eg,el.glyphOffsetArray,ez,eC,eP,eZ,eB,eW,eR,eK,eS.projection,eT,ey,eX);eO=eJ.useVertical,eK&&eJ.needsFlipping&&(eW={}),(eJ.notEnoughRoom||eO||eJ.needsFlipping&&Qt(eI,eH,!0,eb,eh,e_,eg,el.glyphOffsetArray,ez,eC,eP,eZ,eB,eW,eR,eK,eS.projection,eT,ey,eX).notEnoughRoom)&&oi(ek,eC)}ep?(el.text.dynamicLayoutVertexBuffer.updateData(eC),eP&&el.text.globeExtVertexBuffer&&el.text.globeExtVertexBuffer.updateData(eP)):(el.icon.dynamicLayoutVertexBuffer.updateData(eC),eP&&el.icon.globeExtVertexBuffer&&el.icon.globeExtVertexBuffer.updateData(eP))}function Yt(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC){let{lineStartIndex:eP,glyphStartIndex:ez,segment:eD}=ey,eR=ez+ey.numGlyphs,eL=eP+ey.lineLength,eO=el.getoffsetX(ez),ek=el.getoffsetX(eR-1),eF=ii(F*eO,eh,ec,ep,e_,eg,eD,eP,eL,eb,ew,eT,eS,eE,!0,eM,eI,eA,eC);if(!eF)return null;let eB=ii(F*ek,eh,ec,ep,e_,eg,eD,eP,eL,eb,ew,eT,eS,eE,!0,eM,eI,eA,eC);return eB?{first:eF,last:eB}:null}function Jt(el,eh,ec,ep){return el===F.bq.horizontal&&Math.abs(ep)>Math.abs(ec)?{useVertical:!0}:el===F.bq.vertical?ep>0?{needsFlipping:!0}:null:eh!==e1.unknown&&(0===ec||Math.abs(ep/ec)>e2)?eh===e1.flipRequired?{needsFlipping:!0}:null:ec<0?{needsFlipping:!0}:null}function Qt(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR){let eL=eh/24,eO=el.lineOffsetX*eL,ek=el.lineOffsetY*eL,{lineStartIndex:eF,glyphStartIndex:eB,numGlyphs:eN,segment:eV,writingMode:eU,flipState:ej}=el,eG=eF+el.lineLength,L=el=>{if(eS){let[eh,ec,ep]=el.up,e_=eT.length;F.bs(eS,e_+0,eh,ec,ep),F.bs(eS,e_+1,eh,ec,ep),F.bs(eS,e_+2,eh,ec,ep),F.bs(eS,e_+3,eh,ec,ep)}let[eh,ec,ep]=el.point;F.bt(eT,eh,ec,ep,el.angle)};if(eN>1){let F=Yt(eL,eb,eO,ek,ec,eE,eM,el,ew,eg,eI,eC,!1,eP,ez,eD,eR);if(!F)return{notEnoughRoom:!0};if(ep&&!ec){let[eh,ec,ep]=F.first.point,[e_,eg,eb]=F.last.point;[eh,ec]=Wt(eh,ec,ep,ey),[e_,eg]=Wt(e_,eg,eb,ey);let ew=Jt(eU,ej,(e_-eh)*eA,eg-ec);if(el.flipState=ew&&ew.needsFlipping?e1.flipRequired:e1.flipNotRequired,ew)return ew}L(F.first);for(let F=eB+1;F<eB+eN-1;F++){let el=ii(eL*eb.getoffsetX(F),eO,ek,ec,eE,eM,eV,eF,eG,ew,eg,eI,eC,!1,!1,eP,ez,eD,eR);if(!el)return eT.length-=4*(F-eB),{notEnoughRoom:!0};L(el)}L(F.last)}else{if(ep&&!ec){let eh=Wt(eM.x,eM.y,0,e_),ec=eF+eV+1,ep=new F.P(ew.getx(ec),ew.gety(ec)),eg=Wt(ep.x,ep.y,0,e_),ey=eg[3]>0?eg:ti(eM,ep,eh,1,e_,void 0,eP,ez.canonical),eb=Jt(eU,ej,(ey[0]-eh[0])*eA,ey[1]-eh[1]);if(el.flipState=eb&&eb.needsFlipping?e1.flipRequired:e1.flipNotRequired,eb)return eb}let eh=ii(eL*eb.getoffsetX(eB),eO,ek,ec,eE,eM,eV,eF,eG,ew,eg,eI,eC,!1,!1,eP,ez,eD,eR);if(!eh)return{notEnoughRoom:!0};L(eh)}return{}}function ei(F,el,eh,ec,ep){let{x:e_,y:eg,z:ey}=ec.projectTilePoint(F.x,F.y,el);if(!ep)return Wt(e_,eg,ey,eh);let[eb,ew,eT]=ep(F);return Wt(e_+eb,eg+ew,ey+eT,eh)}function ti(el,eh,ec,ep,e_,eg,ey,eb){let ew=ei(el.sub(eh)._unit()._add(el),eb,e_,ey,eg);return F.ad.vec3.sub(ew,ec,ew),F.ad.vec3.normalize(ew,ew),F.ad.vec3.scaleAndAdd(ew,ec,ew,ep)}function ii(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD){let eR=ep?el-eh:el+eh,eL=eR>0?1:-1,eO=0;ep&&(eL*=-1,eO=Math.PI),eL<0&&(eO+=Math.PI);let ek=eb+ey+(eL>0?0:1)|0,eF=e_,eB=e_,eN=0,eV=0,eU=Math.abs(eR),ej=[],eG=[],eq=eg,e$=eq,eH=F.ad.vec3.zero([]),z=()=>ti(e$,eq,eB,eU-eN+1,eS,eM,eC,eP.canonical);for(;eN+eV<=eU;){if((ek+=eL)<eb||ek>=ew)return null;if(eB=eF,e$=eq,ej.push(eB),eI&&eG.push(e$),eq=new F.P(eT.getx(ek),eT.gety(ek)),!(eF=eE[ek])){let F=ei(eq,eP.canonical,eS,eC,eM);eF=F[3]>0?eE[ek]=F:z()}eN+=eV;let el=F.ad.vec3.sub([],eF,eB),eh=F.ad.vec3.distance(eB,eF);if(ec&&eh>0&&eV>0&&F.ad.vec3.dot(eH,el)/(eV*eh)<eD)return null;eV=eh,eH=el}eA&&eM&&(eE[ek]&&(eF=z(),eV=F.ad.vec3.distance(eB,eF),eH=F.ad.vec3.sub([],eF,eB)),eE[ek]=eF);let eZ=(eU-eN)/eV,eW=eq.sub(e$)._mult(eZ)._add(e$),eY=F.ad.vec3.scaleAndAdd([],eB,eH,eZ),eX=[0,0,1],eK=eH[0],eJ=eH[1];if(ez&&(0!==(eX=eC.upVector(eP.canonical,eW.x,eW.y))[0]||0!==eX[1]||1!==eX[2])){let el=[eX[2],0,-eX[0]],eh=F.ad.vec3.cross([],eX,el);F.ad.vec3.normalize(el,el),F.ad.vec3.normalize(eh,eh),eK=F.ad.vec3.dot(eH,el),eJ=F.ad.vec3.dot(eH,eh)}if(ec){let el=F.ad.vec3.cross([],eX,eH);F.ad.vec3.normalize(el,el),F.ad.vec3.scaleAndAdd(eY,eY,el,ec*eL)}let eQ=eO+Math.atan2(eJ,eK);return ej.push(eY),eI&&eG.push(eW),{point:eY,angle:eQ,path:ej,tilePath:eG,up:eX}}function oi(F,el){let eh=el.length,ec=eh+4*F;el.resize(ec),el.float32.fill(-1/0,4*eh,4*ec)}function si(F,el,eh){let ec=el[0],ep=el[1];return F[0]=eh[0]*ec+eh[4]*ep+eh[12],F[1]=eh[1]*ec+eh[5]*ep+eh[13],F[3]=eh[3]*ec+eh[7]*ep+eh[15],F}let ni=class ni{constructor(F,el,eh=new Vt(F.width+200,F.height+200,25),ec=new Vt(F.width+200,F.height+200,25)){this.transform=F,this.grid=eh,this.ignoredGrid=ec,this.pitchfactor=Math.cos(F._pitch)*F.cameraToCenterDistance,this.screenRightBoundary=F.width+100,this.screenBottomBoundary=F.height+100,this.gridRightBoundary=F.width+200,this.gridBottomBoundary=F.height+200,this.fogState=el}placeCollisionBox(F,el,eh,ec,ep,e_,eg,ey){let eb=eh.projectedAnchorX,ew=eh.projectedAnchorY,eT=eh.projectedAnchorZ,eS=eh.elevation,eE=eh.tileID,eM=F.getProjection();if(eS&&eE){let[F,el,ec]=eM.upVector(eE.canonical,eh.tileAnchorX,eh.tileAnchorY),ep=eM.upVectorScale(eE.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;eb+=F*eS*ep,ew+=el*eS*ep,eT+=ec*eS*ep}let eI=this.projectAndGetPerspectiveRatio(eg,eb,ew,eT,eh.tileID,"globe"===eM.name||!!eS||this.transform.pitch>0,eM),eA=e_*eI.perspectiveRatio,eC=(eh.x1*el+ec.x-eh.padding)*eA+eI.point.x,eP=(eh.y1*el+ec.y-eh.padding)*eA+eI.point.y,ez=(eh.x2*el+ec.x+eh.padding)*eA+eI.point.x,eD=(eh.y2*el+ec.y+eh.padding)*eA+eI.point.y,eR=eI.perspectiveRatio<=.55||eI.occluded;return!this.isInsideGrid(eC,eP,ez,eD)||!ep&&this.grid.hitTest(eC,eP,ez,eD,ey)||eR?{box:[],offscreen:!1,occluded:eI.occluded}:{box:[eC,eP,ez,eD],offscreen:this.isOffscreen(eC,eP,ez,eD),occluded:!1}}placeCollisionCircles(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA){let eC=[],eP=this.transform.elevation,ez=el.getProjection(),eD=eP?eP.getAtTileOffsetFunc(eA,this.transform.center.lat,this.transform.worldSize,ez):null,eR=new F.P(ec.tileAnchorX,ec.tileAnchorY),{x:eL,y:eO,z:ek}=ez.projectTilePoint(eR.x,eR.y,eA.canonical);if(eD){let[F,el,eh]=eD(eR);eL+=F,eO+=el,ek+=eh}let eF="globe"===ez.name,eB=this.projectAndGetPerspectiveRatio(ey,eL,eO,ek,eA,eF||!!eP||this.transform.pitch>0,ez),{perspectiveRatio:eN}=eB,eV=(eS?eg/eN:eg*eN)/F.bw,eU=Wt(eL,eO,ek,eb),ej=ec.lineOffsetX*eV,eG=ec.lineOffsetY*eV,eq=F.ak(el.layers[0].layout.get("text-max-angle")),e$=Math.cos(eq),eH=eB.signedDistanceFromCamera>0?Yt(eV,e_,ej,eG,!1,eU,eR,ec,ep,eb,{},eP&&!eS?eD:null,eS&&!!eP,ez,eA,eS,e$):null,eZ=!1,eW=!1,eY=!0;if(eH&&!eB.occluded){let el=.5*eM*eN+eI,ec=new F.P(-100,-100),ep=new F.P(this.screenRightBoundary,this.screenBottomBoundary),e_=new Ut,{first:eg,last:ey}=eH,eb=eg.path.length,eS=[];for(let F=eb-1;F>=1;F--)eS.push(eg.path[F]);for(let F=1;F<ey.path.length;F++)eS.push(ey.path[F]);let eA=2.5*el;ew&&(eS=eS.map(([F,el,eh],ec)=>(eD&&!eF&&(eh=eD(ec<eb-1?eg.tilePath[eb-1-ec]:ey.tilePath[ec-eb+2])[2]),Wt(F,el,eh,ew)))).some(F=>F[3]<=0)&&(eS=[]);let eP=[];if(eS.length>0){let el=1/0,eh=-1/0,e_=1/0,eg=-1/0;for(let F of eS)el=Math.min(el,F[0]),e_=Math.min(e_,F[1]),eh=Math.max(eh,F[0]),eg=Math.max(eg,F[1]);eh>=ec.x&&el<=ep.x&&eg>=ec.y&&e_<=ep.y&&(eP=[eS.map(el=>new F.P(el[0],el[1]))],(el<ec.x||eh>ep.x||e_<ec.y||eg>ep.y)&&(eP=F.bu(eP,ec.x,ec.y,ep.x,ep.y)))}for(let F of eP){e_.reset(F,.25*el);let ec=0;ec=e_.length<=.5*el?1:Math.ceil(e_.paddedLength/eA)+1;for(let F=0;F<ec;F++){let ep=F/Math.max(ec-1,1),eg=e_.lerp(ep),ey=eg.x+100,eb=eg.y+100;eC.push(ey,eb,el,0);let ew=ey-el,eS=eb-el,eM=ey+el,eI=eb+el;if(eY=eY&&this.isOffscreen(ew,eS,eM,eI),eW=eW||this.isInsideGrid(ew,eS,eM,eI),!eh&&this.grid.hitTestCircle(ey,eb,el,eE)&&(eZ=!0,!eT))return{circles:[],offscreen:!1,collisionDetected:eZ,occluded:!1}}}}return{circles:(eT||!eZ)&&eW?eC:[],offscreen:eY,collisionDetected:eZ,occluded:eB.occluded}}queryRenderedSymbols(el){if(0===el.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};let eh=[],ec=1/0,ep=1/0,e_=-1/0,eg=-1/0;for(let ey of el){let el=new F.P(ey.x+100,ey.y+100);ec=Math.min(ec,el.x),ep=Math.min(ep,el.y),e_=Math.max(e_,el.x),eg=Math.max(eg,el.y),eh.push(el)}let ey=this.grid.query(ec,ep,e_,eg).concat(this.ignoredGrid.query(ec,ep,e_,eg)),eb={},ew={};for(let el of ey){let ec=el.key;if(void 0===eb[ec.bucketInstanceId]&&(eb[ec.bucketInstanceId]={}),eb[ec.bucketInstanceId][ec.featureIndex])continue;let ep=[new F.P(el.x1,el.y1),new F.P(el.x2,el.y1),new F.P(el.x2,el.y2),new F.P(el.x1,el.y2)];F.bv(eh,ep)&&(eb[ec.bucketInstanceId][ec.featureIndex]=!0,void 0===ew[ec.bucketInstanceId]&&(ew[ec.bucketInstanceId]=[]),ew[ec.bucketInstanceId].push(ec.featureIndex))}return ew}insertCollisionBox(F,el,eh,ec,ep){(el?this.ignoredGrid:this.grid).insert({bucketInstanceId:eh,featureIndex:ec,collisionGroupID:ep},F[0],F[1],F[2],F[3])}insertCollisionCircles(F,el,eh,ec,ep){let e_=el?this.ignoredGrid:this.grid,eg={bucketInstanceId:eh,featureIndex:ec,collisionGroupID:ep};for(let el=0;el<F.length;el+=4)e_.insertCircle(eg,F[el],F[el+1],F[el+2])}projectAndGetPerspectiveRatio(el,eh,ec,ep,e_,eg,ey){let eb=[eh,ec,ep,1],ew=!1;if(ep||this.transform.pitch>0){if(F.ad.vec4.transformMat4(eb,eb,el),this.fogState&&e_&&"globe"!==ey.name){let el=function(el,eh,ec,ep,e_,eg){let ey=eg.calculateFogTileMatrix(e_),eb=[eh,ec,ep];return F.ad.vec3.transformMat4(eb,eb,ey),ke(el,F.ad.vec3.length(eb),eg.pitch,eg._fov)}(this.fogState,eh,ec,ep,e_.toUnwrapped(),this.transform);ew=el>.9}}else si(eb,eb,el);let eT=eb[3];return{point:new F.P((eb[0]/eT+1)/2*this.transform.width+100,(-eb[1]/eT+1)/2*this.transform.height+100),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(ey)/eT*.5,1.5),signedDistanceFromCamera:eT,occluded:eg&&eb[2]>eT||ew}}isOffscreen(F,el,eh,ec){return eh<100||F>=this.screenRightBoundary||ec<100||el>this.screenBottomBoundary}isInsideGrid(F,el,eh,ec){return eh>=0&&F<this.gridRightBoundary&&ec>=0&&el<this.gridBottomBoundary}getViewportMatrix(){let el=F.ad.mat4.identity([]);return F.ad.mat4.translate(el,el,[-100,-100,0]),el}};function ai(el,eh,ec){let ep=eh.createTileMatrix(el,el.worldSize,ec.toUnwrapped());return F.ad.mat4.multiply(new Float32Array(16),el.projMatrix,ep)}function ci(F,el,eh){return el.name===eh.projection.name?F.projMatrix:ai(eh,el,F)}let hi=class hi{constructor(F,el,eh,ec){this.opacity=F?Math.max(0,Math.min(1,F.opacity+(F.placed?el:-el))):ec&&eh?1:0,this.placed=eh}isHidden(){return 0===this.opacity&&!this.placed}};let di=class di{constructor(F,el,eh,ec,ep,e_=!1){this.text=new hi(F?F.text:null,el,eh,ep),this.icon=new hi(F?F.icon:null,el,ec,ep),this.clipped=e_}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}};let ui=class ui{constructor(F,el,eh,ec=!1){this.text=F,this.icon=el,this.skipFade=eh,this.clipped=ec}};let _i=class _i{constructor(){this.invProjMatrix=F.ad.mat4.create(),this.viewportMatrix=F.ad.mat4.create(),this.circles=[]}};let pi=class pi{constructor(F,el,eh,ec,ep){this.bucketInstanceId=F,this.featureIndex=el,this.sourceLayerIndex=eh,this.bucketIndex=ec,this.tileID=ep}};let fi=class fi{constructor(F){this.crossSourceCollisions=F,this.maxGroupID=0,this.collisionGroups={}}get(F){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[F]){let el=++this.maxGroupID;this.collisionGroups[F]={ID:el,predicate:F=>F.collisionGroupID===el}}return this.collisionGroups[F]}};function mi(el,eh,ec,ep,e_){let{horizontalAlign:eg,verticalAlign:ey}=F.bD(el),eb=F.bC(el,ep);return new F.P(-(eg-.5)*eh+eb[0]*e_,-(ey-.5)*ec+eb[1]*e_)}function gi(el,eh,ec,ep,e_){let eg=new F.P(el,eh);return ec&&eg._rotate(ep?e_:-e_),eg}let vi=class vi{constructor(F,el,eh,ec,ep,e_){this.transform=F.clone(),this.projection=F.projection.name,this.collisionIndex=new ni(this.transform,ep),this.buildingIndex=e_,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=el,this.retainedQueryData={},this.collisionGroups=new fi(eh),this.collisionCircleArrays={},this.prevPlacement=ec,ec&&(ec.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(el,eh,ec,ep,e_=1){var eg,ey,eb;let ew=ec.getBucket(eh),eT=ec.latestFeatureIndex;if(!ew||!eT||eh.fqid!==ew.layerIds[0])return;let eS=ew.layers[0].layout,eE=ew.layers[0].paint,eM=ec.collisionBoxArray,eI=Math.pow(2,this.transform.zoom-ec.tileID.overscaledZ),eA=ec.tileSize/F.ai,eC=ec.tileID.toUnwrapped();this.transform.setProjection(ew.projection);let eP=(eg=ec.tileID,ey=ew.getProjection(),eb=this.transform,ey.name===this.projection?eb.calculateProjMatrix(eg.toUnwrapped()):ai(eb,ey,eg)),ez="map"===eS.get("text-pitch-alignment"),eD="map"===eS.get("text-rotation-alignment");eh.compileFilter(eh.options);let eR=eh.dynamicFilter(),eL=eh.dynamicFilterNeedsFeature(),eO=this.transform.calculatePixelsToTileUnitsMatrix(ec),ek=Ht(eP,ec.tileID.canonical,ez,eD,this.transform,ew.getProjection(),eO),eF=null;if(ez){let el=Zt(eP,ec.tileID.canonical,ez,eD,this.transform,ew.getProjection(),eO);eF=F.ad.mat4.multiply([],this.transform.labelPlaneMatrix,el)}let eB=null;eR&&ec.latestFeatureIndex&&(eB={unwrappedTileID:eC,dynamicFilter:eR,dynamicFilterNeedsFeature:eL}),this.retainedQueryData[ew.bucketInstanceId]=new pi(ew.bucketInstanceId,eT,ew.sourceLayerIndex,ew.index,ec.tileID);let[eN,eV]=ew.layers[0].layout.get("text-size-scale-range"),eU=F.ay(e_,eN,eV),[ej,eG]=eS.get("icon-size-scale-range"),eq=F.ay(e_,ej,eG),e$={bucket:ew,layout:eS,paint:eE,posMatrix:eP,textLabelPlaneMatrix:ek,labelToScreenMatrix:eF,clippingData:eB,scale:eI,textPixelRatio:eA,holdingForFade:ec.holdingForFade(),collisionBoxArray:eM,partiallyEvaluatedTextSize:F.bp(ew.textSizeData,this.transform.zoom,eU),partiallyEvaluatedIconSize:F.bp(ew.iconSizeData,this.transform.zoom,eq),collisionGroup:this.collisionGroups.get(ew.sourceID),latestFeatureIndex:ec.latestFeatureIndex};if(ep)for(let F of ew.sortKeyRanges){let{sortKey:eh,symbolInstanceStart:ec,symbolInstanceEnd:ep}=F;el.push({sortKey:eh,symbolInstanceStart:ec,symbolInstanceEnd:ep,parameters:e$})}else el.push({symbolInstanceStart:0,symbolInstanceEnd:ew.symbolInstances.length,parameters:e$})}attemptAnchorPlacement(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP){let{textOffset0:ez,textOffset1:eD,crossTileID:eR}=eS,eL=[ez,eD],eO=mi(F,eh,ec,eL,ep),ek=this.collisionIndex.placeCollisionBox(eM,ep,el,gi(eO.x,eO.y,e_,eg,this.transform.angle),eT,ey,eb,ew.predicate);if(eA){let F=eM.getSymbolInstanceIconSize(eP,this.transform.zoom,eS.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(eM,F,eA,gi(eO.x,eO.y,e_,eg,this.transform.angle),eT,ey,eb,ew.predicate).box.length)return}if(ek.box.length>0){let el;return this.prevPlacement&&this.prevPlacement.variableOffsets[eR]&&this.prevPlacement.placements[eR]&&this.prevPlacement.placements[eR].text&&(el=this.prevPlacement.variableOffsets[eR].anchor),this.variableOffsets[eR]={textOffset:eL,width:eh,height:ec,anchor:F,textScale:ep,prevAnchor:el},this.markUsedJustification(eM,F,eS,eI),eM.allowVerticalPlacement&&(this.markUsedOrientation(eM,eI,eS),this.placedOrientations[eR]=eI),{shift:eO,placedGlyphBoxes:ek}}}placeLayerBucketPart(el,eh,ec,ep,e_=1){let{bucket:eg,layout:ey,paint:eb,posMatrix:ew,textLabelPlaneMatrix:eT,labelToScreenMatrix:eS,clippingData:eE,textPixelRatio:eM,holdingForFade:eI,collisionBoxArray:eA,partiallyEvaluatedTextSize:eC,partiallyEvaluatedIconSize:eP,collisionGroup:ez,latestFeatureIndex:eD}=el.parameters,eR=ey.get("text-optional"),eL=ey.get("icon-optional"),eO=ey.get("text-allow-overlap"),ek=ey.get("icon-allow-overlap"),eF="map"===ey.get("text-rotation-alignment"),eB="map"===ey.get("text-pitch-alignment"),eN=eb.get("symbol-z-offset"),eV="sea"===ey.get("symbol-elevation-reference"),[eU,ej]=ey.get("text-size-scale-range"),[eG,eq]=ey.get("icon-size-scale-range"),e$=F.ay(e_,eU,ej),eH=F.ay(e_,eG,eq);this.transform.setProjection(eg.projection);let eZ=eO&&(ek||!eg.hasIconData()||eL),eW=ek&&(eO||!eg.hasTextData()||eR),eY=!eN.isConstant();!eg.collisionArrays&&eA&&eg.deserializeCollisionBoxes(eA),ec&&ep&&eg.updateCollisionDebugBuffers(this.transform.zoom,eA,e$,eH);let k=(el,ep,eb)=>{let{crossTileID:eA,numVerticalGlyphVertices:eU}=el,ej=null;if(eE&&eE.dynamicFilterNeedsFeature||eY){let F=this.retainedQueryData[eg.bucketInstanceId];ej=eD.loadFeature({featureIndex:el.featureIndex,bucketIndex:F.bucketIndex,sourceLayerIndex:F.sourceLayerIndex,layoutVertexArrayOffset:0})}if(eE&&!(0,eE.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},ej,this.retainedQueryData[eg.bucketInstanceId].tileID.canonical,new F.P(el.tileAnchorX,el.tileAnchorY),this.transform.calculateDistanceTileData(eE.unwrappedTileID)))return this.placements[eA]=new ui(!1,!1,!1,!0),void eh.add(eA);let eG=eN.evaluate(ej,{});if(eh.has(eA))return;if(eI)return void(this.placements[eA]=new ui(!1,!1,!1));let eq=!1,e$=!1,eH=!0,eX=!1,eK=!1,eJ=null,eQ={box:null,offscreen:null,occluded:null},e0={box:null,offscreen:null,occluded:null},e1=null,e2=null,e3=null,e4=0,e5=0,e6=0;eb.textFeatureIndex?e4=eb.textFeatureIndex:el.useRuntimeCollisionCircles&&(e4=el.featureIndex),eb.verticalTextFeatureIndex&&(e5=eb.verticalTextFeatureIndex);let $=F=>{F.tileID=this.retainedQueryData[eg.bucketInstanceId].tileID;let eh=this.transform.elevation;F.elevation=eV?eG:eG+(eh?eh.getAtTileOffset(F.tileID,F.tileAnchorX,F.tileAnchorY):0),F.elevation+=el.zOffset},e8=eb.textBox;if(e8){$(e8);let i=eh=>{let ec=F.bq.horizontal;if(eg.allowVerticalPlacement&&!eh&&this.prevPlacement){let F=this.prevPlacement.placedOrientations[eA];F&&(this.placedOrientations[eA]=F,ec=F,this.markUsedOrientation(eg,ec,el))}return ec},o=(el,eh)=>{if(eg.allowVerticalPlacement&&eU>0&&eb.verticalTextBox){for(let ec of eg.writingModes)if(ec===F.bq.vertical?e0=eQ=eh():eQ=el(),eQ&&eQ.box&&eQ.box.length)break}else eQ=el()};if(ey.get("text-variable-anchor")){let eh=ey.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[eA]){let F=this.prevPlacement.variableOffsets[eA];eh.indexOf(F.anchor)>0&&(eh=eh.filter(el=>el!==F.anchor)).unshift(F.anchor)}let h=(F,ec,e_)=>{let ey=eg.getSymbolInstanceTextSize(eC,el,this.transform.zoom,ep),eb=(F.x2-F.x1)*ey+2*F.padding,eT=(F.y2-F.y1)*ey+2*F.padding,eS=el.hasIconTextFit&&!ek?ec:null;eS&&$(eS);let eE={box:[],offscreen:!1,occluded:!1},eI=eO?2*eh.length:eh.length;for(let ec=0;ec<eI;++ec){let eI=this.attemptAnchorPlacement(eh[ec%eh.length],F,eb,eT,ey,eF,eB,eM,ew,ez,ec>=eh.length,el,ep,eg,e_,eS,eC,eP);if(eI&&(eE=eI.placedGlyphBoxes)&&eE.box&&eE.box.length){eq=!0,eJ=eI.shift;break}}return eE};o(()=>h(e8,eb.iconBox,F.bq.horizontal),()=>{let el=eb.verticalTextBox;return el&&$(el),eg.allowVerticalPlacement&&!(eQ&&eQ.box&&eQ.box.length)&&eU>0&&el?h(el,eb.verticalIconBox,F.bq.vertical):{box:null,offscreen:null,occluded:null}}),eQ&&(eq=eQ.box,eH=eQ.offscreen,eX=eQ.occluded);let ec=i(!(!eQ||!eQ.box));if(!eq&&this.prevPlacement){let F=this.prevPlacement.variableOffsets[eA];F&&(this.variableOffsets[eA]=F,this.markUsedJustification(eg,F.anchor,el,ec))}}else{let a=(eh,ec)=>{let ey=eg.getSymbolInstanceTextSize(eC,el,this.transform.zoom,ep,e_),eb=this.collisionIndex.placeCollisionBox(eg,ey,eh,new F.P(0,0),eO,eM,ew,ez.predicate);return eb&&eb.box&&eb.box.length&&(this.markUsedOrientation(eg,ec,el),this.placedOrientations[eA]=ec),eb};o(()=>a(e8,F.bq.horizontal),()=>{let el=eb.verticalTextBox;return eg.allowVerticalPlacement&&eU>0&&el?($(el),a(el,F.bq.vertical)):{box:null,offscreen:null,occluded:null}}),i(!!(eQ&&eQ.box&&eQ.box.length))}}if(eq=(e1=eQ)&&e1.box&&e1.box.length>0,eH=e1&&e1.offscreen,eX=e1&&e1.occluded,el.useRuntimeCollisionCircles){let eh=eg.text.placedSymbolArray.get(el.centerJustifiedTextSymbolIndex>=0?el.centerJustifiedTextSymbolIndex:el.verticalPlacedTextSymbolIndex),ep=F.br(eg.textSizeData,eC,eh),e_=ey.get("text-padding");e2=this.collisionIndex.placeCollisionCircles(eg,eO,eh,eg.lineVertexArray,eg.glyphOffsetArray,ep,ew,eT,eS,ec,eB,ez.predicate,el.collisionCircleDiameter*ep/F.bw,e_,this.retainedQueryData[eg.bucketInstanceId].tileID),eq=eO||e2.circles.length>0&&!e2.collisionDetected,eH=eH&&e2.offscreen,eX=e2.occluded}if(eb.iconFeatureIndex&&(e6=eb.iconFeatureIndex),eb.iconBox){let i=eh=>{$(eh);let ec=el.hasIconTextFit&&eJ?gi(eJ.x,eJ.y,eF,eB,this.transform.angle):new F.P(0,0),ep=eg.getSymbolInstanceIconSize(eP,this.transform.zoom,el.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(eg,ep,eh,ec,ek,eM,ew,ez.predicate)};e$=e0&&e0.box&&e0.box.length&&eb.verticalIconBox?(e3=i(eb.verticalIconBox)).box.length>0:(e3=i(eb.iconBox)).box.length>0,eH=eH&&e3.offscreen,eK=e3.occluded}let e9=eR||0===el.numHorizontalGlyphVertices&&0===eU,e7=eL||0===el.numIconVertices;if(e9||e7?e7?e9||(e$=e$&&eq):eq=e$&&eq:e$=eq=e$&&eq,eq&&e1&&e1.box&&this.collisionIndex.insertCollisionBox(e1.box,ey.get("text-ignore-placement"),eg.bucketInstanceId,e0&&e0.box&&e5?e5:e4,ez.ID),e$&&e3&&this.collisionIndex.insertCollisionBox(e3.box,ey.get("icon-ignore-placement"),eg.bucketInstanceId,e6,ez.ID),e2&&(eq&&this.collisionIndex.insertCollisionCircles(e2.circles,ey.get("text-ignore-placement"),eg.bucketInstanceId,e4,ez.ID),ec)){let F=eg.bucketInstanceId,el=this.collisionCircleArrays[F];void 0===el&&(el=this.collisionCircleArrays[F]=new _i);for(let F=0;F<e2.circles.length;F+=4)el.circles.push(e2.circles[F+0]),el.circles.push(e2.circles[F+1]),el.circles.push(e2.circles[F+2]),el.circles.push(e2.collisionDetected?1:0)}let tn="globe"!==eg.projection.name;eZ=eZ&&(tn||!eX),eW=eW&&(tn||!eK),this.placements[eA]=new ui(eq||eZ,e$||eW,eH||eg.justReloaded),eh.add(eA)};if("offset"===eg.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(eg,this.retainedQueryData[eg.bucketInstanceId].tileID),"road"===eg.elevationType&&eg.updateRoadElevation(),eg.updateZOffset(),eg.sortFeaturesByY){let el=eg.getSortedSymbolIndexes(this.transform.angle);for(let F=el.length-1;F>=0;--F){let eh=el[F];k(eg.symbolInstances.get(eh),eh,eg.collisionArrays[eh])}eg.hasAnyZOffset&&F.w(`${eg.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(eg.hasAnyZOffset){let F=eg.getSortedIndexesByZOffset();for(let el=0;el<F.length;++el){let eh=F[el];k(eg.symbolInstances.get(eh),eh,eg.collisionArrays[eh])}}else for(let F=el.symbolInstanceStart;F<el.symbolInstanceEnd;F++)k(eg.symbolInstances.get(F),F,eg.collisionArrays[F]);if(ec&&eg.bucketInstanceId in this.collisionCircleArrays){let el=this.collisionCircleArrays[eg.bucketInstanceId];F.ad.mat4.invert(el.invProjMatrix,ew),el.viewportMatrix=this.collisionIndex.getViewportMatrix()}eg.justReloaded=!1}markUsedJustification(el,eh,ec,ep){let{leftJustifiedTextSymbolIndex:e_,centerJustifiedTextSymbolIndex:eg,rightJustifiedTextSymbolIndex:ey,verticalPlacedTextSymbolIndex:eb,crossTileID:ew}=ec,eT=F.bB(eh),eS=ep===F.bq.vertical?eb:"left"===eT?e_:"center"===eT?eg:"right"===eT?ey:-1;e_>=0&&(el.text.placedSymbolArray.get(e_).crossTileID=eS>=0&&e_!==eS?0:ew),eg>=0&&(el.text.placedSymbolArray.get(eg).crossTileID=eS>=0&&eg!==eS?0:ew),ey>=0&&(el.text.placedSymbolArray.get(ey).crossTileID=eS>=0&&ey!==eS?0:ew),eb>=0&&(el.text.placedSymbolArray.get(eb).crossTileID=eS>=0&&eb!==eS?0:ew)}markUsedOrientation(el,eh,ec){let ep=eh===F.bq.horizontal||eh===F.bq.horizontalOnly?eh:0,e_=eh===F.bq.vertical?eh:0,{leftJustifiedTextSymbolIndex:eg,centerJustifiedTextSymbolIndex:ey,rightJustifiedTextSymbolIndex:eb,verticalPlacedTextSymbolIndex:ew}=ec,eT=el.text.placedSymbolArray;eg>=0&&(eT.get(eg).placedOrientation=ep),ey>=0&&(eT.get(ey).placedOrientation=ep),eb>=0&&(eT.get(eb).placedOrientation=ep),ew>=0&&(eT.get(ew).placedOrientation=e_)}commit(F){this.commitTime=F,this.zoomAtLastRecencyCheck=this.transform.zoom;let el=this.prevPlacement,eh=!1;this.prevZoomAdjustment=el?el.zoomAdjustment(this.transform.zoom):0;let ec=el?el.symbolFadeChange(F):1,ep=el?el.opacities:{},e_=el?el.variableOffsets:{},eg=el?el.placedOrientations:{};for(let F in this.placements){let el=this.placements[F],e_=ep[F];e_?(this.opacities[F]=new di(e_,ec,el.text,el.icon,null,el.clipped),eh=eh||el.text!==e_.text.placed||el.icon!==e_.icon.placed):(this.opacities[F]=new di(null,ec,el.text,el.icon,el.skipFade,el.clipped),eh=eh||el.text||el.icon)}for(let F in ep){let el=ep[F];if(!this.opacities[F]){let ep=new di(el,ec,!1,!1);ep.isHidden()||(this.opacities[F]=ep,eh=eh||el.text.placed||el.icon.placed)}}for(let F in e_)this.variableOffsets[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.variableOffsets[F]=e_[F]);for(let F in eg)this.placedOrientations[F]||!this.opacities[F]||this.opacities[F].isHidden()||(this.placedOrientations[F]=eg[F]);eh?this.lastPlacementChangeTime=F:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=el?el.lastPlacementChangeTime:F)}updateLayerOpacities(F,el,eh,ec){let ep=new Set;for(let e_ of el){let el=e_.getBucket(F);el&&e_.latestFeatureIndex&&F.fqid===el.layerIds[0]&&(this.updateBucketOpacities(el,ep,e_,e_.collisionBoxArray,eh,ec,e_.tileID,F.scope),"offset"===el.elevationType&&this.buildingIndex&&this.buildingIndex.updateZOffset(el,e_.tileID),"road"===el.elevationType&&el.updateRoadElevation(),el.updateZOffset())}}updateBucketOpacities(el,eh,ec,ep,e_,eg,ey,eb){el.hasTextData()&&el.text.opacityVertexArray.clear(),el.hasIconData()&&el.icon.opacityVertexArray.clear(),el.hasIconCollisionBoxData()&&el.iconCollisionBox.collisionVertexArray.clear(),el.hasTextCollisionBoxData()&&el.textCollisionBox.collisionVertexArray.clear();let ew=el.layers[0].layout,eT=el.layers[0].paint,eS=!!el.layers[0].dynamicFilter(),eE=new di(null,0,!1,!1,!0),eM=ew.get("text-allow-overlap"),eI=ew.get("icon-allow-overlap"),eA=ew.get("text-variable-anchor"),eC="map"===ew.get("text-rotation-alignment"),eP="map"===ew.get("text-pitch-alignment"),ez=eT.get("symbol-z-offset"),eD="sea"===ew.get("symbol-elevation-reference"),eR=!ez.isConstant(),eL=new di(null,0,eM&&(eI||!el.hasIconData()||ew.get("icon-optional")),eI&&(eM||!el.hasTextData()||ew.get("text-optional")),!0);!el.collisionArrays&&ep&&(el.hasIconCollisionBoxData()||el.hasTextCollisionBoxData())&&el.deserializeCollisionBoxes(ep);let w=(F,el,eh)=>{for(let ec=0;ec<el/4;ec++)F.opacityVertexArray.emplaceBack(eh)},eO=0;eg&&el.updateReplacement(ey,eg);for(let ep=0;ep<el.symbolInstances.length;ep++){let ew=el.symbolInstances.get(ep),{numHorizontalGlyphVertices:eT,numVerticalGlyphVertices:eM,crossTileID:eI,numIconVertices:ek,tileAnchorX:eF,tileAnchorY:eB}=ew,eN=null,eV=this.retainedQueryData[el.bucketInstanceId];eR&&ew&&eV&&(eN=ec.latestFeatureIndex.loadFeature({featureIndex:ew.featureIndex,bucketIndex:eV.bucketIndex,sourceLayerIndex:eV.sourceLayerIndex,layoutVertexArrayOffset:0}));let eU=ez.evaluate(eN,{}),ej=eh.has(eI),eG=this.opacities[eI];ej?eG=eE:eG||(eG=eL,this.opacities[eI]=eG),eh.add(eI);let eq=eT>0||eM>0,e$=ek>0,eH=this.placedOrientations[eI],eZ=eH===F.bq.vertical,eW=eH===F.bq.horizontal||eH===F.bq.horizontalOnly;!eq&&!e$||eG.isHidden()||eO++;let eY=!1;if((eq||e$)&&eg)for(let eh of el.activeReplacements){if(F.bx(eh,e_,F.by.Symbol,eb)||eh.min.x>eF||eF>eh.max.x||eh.min.y>eB||eB>eh.max.y)continue;let el=F.bz(eF,eB,ey.canonical,eh.footprintTileId.canonical);if(eY=F.bA(el,eh.footprint))break}if(eq){let F=eY?e3:Ii(eG.text);w(el.text,eT,eZ?e3:F),w(el.text,eM,eW?e3:F);let eh=eG.text.isHidden(),{leftJustifiedTextSymbolIndex:ec,centerJustifiedTextSymbolIndex:ep,rightJustifiedTextSymbolIndex:e_,verticalPlacedTextSymbolIndex:eg}=ew,ey=el.text.placedSymbolArray,eb=eh||eZ?1:0;ec>=0&&(ey.get(ec).hidden=eb),ep>=0&&(ey.get(ep).hidden=eb),e_>=0&&(ey.get(e_).hidden=eb),eg>=0&&(ey.get(eg).hidden=eh||eW?1:0);let eS=this.variableOffsets[eI];eS&&this.markUsedJustification(el,eS.anchor,ew,eH);let eE=this.placedOrientations[eI];eE&&(this.markUsedJustification(el,"left",ew,eE),this.markUsedOrientation(el,eE,ew))}if(e$){let F=eY?e3:Ii(eG.icon),{placedIconSymbolIndex:eh,verticalPlacedIconSymbolIndex:ec}=ew,ep=el.icon.placedSymbolArray,e_=eG.icon.isHidden()?1:0;eh>=0&&(w(el.icon,ek,eZ?e3:F),ep.get(eh).hidden=e_),ec>=0&&(w(el.icon,ew.numVerticalIconVertices,eW?e3:F),ep.get(ec).hidden=e_)}if(el.hasIconCollisionBoxData()||el.hasTextCollisionBoxData()){let eh=el.collisionArrays[ep];if(eh){let ec=new F.P(0,0),ep=!0;if(eh.textBox||eh.verticalTextBox){if(eA){let F=this.variableOffsets[eI];F?(ec=mi(F.anchor,F.width,F.height,F.textOffset,F.textScale),eC&&ec._rotate(eP?this.transform.angle:-this.transform.angle)):ep=!1}eS&&(ep=!eG.clipped),eh.textBox&&yi(el.textCollisionBox.collisionVertexArray,eG.text.placed,!ep||eZ,eU,eD,ec.x,ec.y),eh.verticalTextBox&&yi(el.textCollisionBox.collisionVertexArray,eG.text.placed,!ep||eW,eU,eD,ec.x,ec.y)}let e_=ep&&!!(!eW&&eh.verticalIconBox);eh.iconBox&&yi(el.iconCollisionBox.collisionVertexArray,eG.icon.placed,e_,eU,eD,ew.hasIconTextFit?ec.x:0,ew.hasIconTextFit?ec.y:0),eh.verticalIconBox&&yi(el.iconCollisionBox.collisionVertexArray,eG.icon.placed,!e_,eU,eD,ew.hasIconTextFit?ec.x:0,ew.hasIconTextFit?ec.y:0)}}}if(el.fullyClipped=0===eO,el.sortFeatures(this.transform.angle),this.retainedQueryData[el.bucketInstanceId]&&(this.retainedQueryData[el.bucketInstanceId].featureSortOrder=el.featureSortOrder),el.hasTextData()&&el.text.opacityVertexBuffer&&el.text.opacityVertexBuffer.updateData(el.text.opacityVertexArray),el.hasIconData()&&el.icon.opacityVertexBuffer&&el.icon.opacityVertexBuffer.updateData(el.icon.opacityVertexArray),el.hasIconCollisionBoxData()&&el.iconCollisionBox.collisionVertexBuffer&&el.iconCollisionBox.collisionVertexBuffer.updateData(el.iconCollisionBox.collisionVertexArray),el.hasTextCollisionBoxData()&&el.textCollisionBox.collisionVertexBuffer&&el.textCollisionBox.collisionVertexBuffer.updateData(el.textCollisionBox.collisionVertexArray),el.bucketInstanceId in this.collisionCircleArrays){let F=this.collisionCircleArrays[el.bucketInstanceId];el.placementInvProjMatrix=F.invProjMatrix,el.placementViewportMatrix=F.viewportMatrix,el.collisionCircleArray=F.circles,delete this.collisionCircleArrays[el.bucketInstanceId]}}symbolFadeChange(F){return 0===this.fadeDuration?1:(F-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(F){return Math.max(0,(this.transform.zoom-F)/1.5)}hasTransitions(F){return this.stale||F-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(F,el){let eh=this.zoomAtLastRecencyCheck===el?1-this.zoomAdjustment(el):1;return this.zoomAtLastRecencyCheck=el,this.commitTime+this.fadeDuration*eh>F}setStale(){this.stale=!0}};function yi(F,el,eh,ec,ep,e_,eg){F.emplaceBack(el?1:0,eh?1:0,e_||0,eg||0,ec,ep?1:0),F.emplaceBack(el?1:0,eh?1:0,e_||0,eg||0,ec,ep?1:0),F.emplaceBack(el?1:0,eh?1:0,e_||0,eg||0,ec,ep?1:0),F.emplaceBack(el?1:0,eh?1:0,e_||0,eg||0,ec,ep?1:0)}function Ii(F){if(0===F.opacity&&!F.placed)return 0;if(1===F.opacity&&F.placed)return 4294967295;let el=F.placed?1:0,eh=Math.floor(127*F.opacity);return 33554432*eh+16777216*el+131072*eh+65536*el+512*eh+256*el+2*eh+el}let e3=0;let Di=class Di{constructor(F){this._sortAcrossTiles="viewport-y"!==F.layout.get("symbol-z-order")&&void 0!==F.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(F,el,eh,ec,ep,e_){let eg=this._bucketParts;for(;this._currentTileIndex<F.length;)if(el.getBucketParts(eg,ec,F[this._currentTileIndex],this._sortAcrossTiles,e_),this._currentTileIndex++,ep())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,eg.sort((F,el)=>F.sortKey-el.sortKey));this._currentPartIndex<eg.length;){let F=eg[this._currentPartIndex];if(el.placeLayerBucketPart(F,this._seenCrossTileIDs,eh,0===F.symbolInstanceStart,e_),this._currentPartIndex++,ep())return!0}return!1}};let Ai=class Ai{constructor(F,el,eh,ec,ep,e_,eg,ey,eb){this.placement=new vi(F,ep,e_,eg,ey,eb),this._currentPlacementIndex=el.length-1,this._forceFullPlacement=eh,this._showCollisionBoxes=ec,this._done=!1}isDone(){return this._done}continuePlacement(el,eh,ec,ep,e_){let eg=F.q.now(),a=()=>{let el=F.q.now()-eg;return!this._forceFullPlacement&&el>2};for(;this._currentPlacementIndex>=0;){let eg=eh[el[this._currentPlacementIndex]],ey=this.placement.collisionIndex.transform.zoom;if("symbol"===eg.type&&(!eg.minzoom||eg.minzoom<=ey)&&(!eg.maxzoom||eg.maxzoom>ey)){let el=eg.layout.get("symbol-z-elevate"),eh=void 0!==eg.layout.get("symbol-sort-key").constantOr(1),ey=eg.layout.get("symbol-z-order"),eb="viewport-y"===ey||"auto"===ey&&!("viewport-y"!==ey&&eh),ew=eg.layout.get("text-allow-overlap")||eg.layout.get("icon-allow-overlap")||eg.layout.get("text-ignore-placement")||eg.layout.get("icon-ignore-placement"),eT=eb&&ew,eS=this._inProgressLayer=this._inProgressLayer||new Di(eg),eE=F.C(eg.source,eg.scope);if(eS.continuePlacement(el||eT?ep[eE]:ec[eE],this.placement,this._showCollisionBoxes,eg,a,e_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(F){return this.placement.commit(F),this.placement}};let e4=512/F.ai/2;let Mi=class Mi{constructor(el,eh,ec){this.tileID=el,this.bucketInstanceId=ec,this.index=new F.bE(eh.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];let ep=el.canonical.x*F.ai,e_=el.canonical.y*F.ai;for(let F=0;F<eh.length;F++){let{key:el,crossTileID:ec,tileAnchorX:eg,tileAnchorY:ey}=eh.get(F),eb=Math.floor((ep+eg)*e4),ew=Math.floor((e_+ey)*e4);this.index.add(eb,ew),this.keys.push(el),this.crossTileIDs.push(ec)}this.index.finish()}findMatches(el,eh,ec){let ep=this.tileID.canonical.z<eh.canonical.z?1:Math.pow(2,this.tileID.canonical.z-eh.canonical.z),e_=e4/Math.pow(2,eh.canonical.z-this.tileID.canonical.z),eg=eh.canonical.x*F.ai,ey=eh.canonical.y*F.ai;for(let F=0;F<el.length;F++){let eh=el.get(F);if(eh.crossTileID)continue;let{key:eb,tileAnchorX:ew,tileAnchorY:eT}=eh,eS=Math.floor((eg+ew)*e_),eE=Math.floor((ey+eT)*e_),eM=this.index.range(eS-ep,eE-ep,eS+ep,eE+ep);for(let F of eM){let el=this.crossTileIDs[F];if(this.keys[F]===eb&&!ec.has(el)){ec.add(el),eh.crossTileID=el;break}}}}};let Pi=class Pi{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}};let zi=class zi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(F){let el=Math.round((F-this.lng)/360);if(0!==el)for(let F in this.indexes){let eh=this.indexes[F],ec={};for(let F in eh){let ep=eh[F];ep.tileID=ep.tileID.unwrapTo(ep.tileID.wrap+el),ec[ep.tileID.key]=ep}this.indexes[F]=ec}this.lng=F}addBucket(F,el,eh){if(this.indexes[F.overscaledZ]&&this.indexes[F.overscaledZ][F.key]){if(this.indexes[F.overscaledZ][F.key].bucketInstanceId===el.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(F.overscaledZ,this.indexes[F.overscaledZ][F.key])}for(let F=0;F<el.symbolInstances.length;F++)el.symbolInstances.get(F).crossTileID=0;this.usedCrossTileIDs[F.overscaledZ]||(this.usedCrossTileIDs[F.overscaledZ]=new Set);let ec=this.usedCrossTileIDs[F.overscaledZ];for(let eh in this.indexes){let ep=this.indexes[eh];if(Number(eh)>F.overscaledZ)for(let eh in ep){let e_=ep[eh];e_.tileID.isChildOf(F)&&e_.findMatches(el.symbolInstances,F,ec)}else{let e_=ep[F.scaledTo(Number(eh)).key];e_&&e_.findMatches(el.symbolInstances,F,ec)}}for(let F=0;F<el.symbolInstances.length;F++){let ep=el.symbolInstances.get(F);ep.crossTileID||(ep.crossTileID=eh.generate(),ec.add(ep.crossTileID))}return void 0===this.indexes[F.overscaledZ]&&(this.indexes[F.overscaledZ]={}),this.indexes[F.overscaledZ][F.key]=new Mi(F,el.symbolInstances,el.bucketInstanceId),!0}removeBucketCrossTileIDs(F,el){for(let eh of el.crossTileIDs)this.usedCrossTileIDs[F].delete(eh)}removeStaleBuckets(F){let el=!1;for(let eh in this.indexes){let ec=this.indexes[eh];for(let ep in ec)F[ec[ep].bucketInstanceId]||(this.removeBucketCrossTileIDs(eh,ec[ep]),delete ec[ep],el=!0)}return el}};let Oi=class Oi{constructor(){this.layerIndexes={},this.crossTileIDs=new Pi,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(F,el,eh,ec){let ep=this.layerIndexes[F.fqid];void 0===ep&&(ep=this.layerIndexes[F.fqid]=new zi);let e_=!1,eg={};for(let ey of("globe"!==ec.name&&ep.handleWrapJump(eh),el)){let el=ey.getBucket(F);el&&F.fqid===el.layerIds[0]&&(el.bucketInstanceId||(el.bucketInstanceId=++this.maxBucketInstanceId),ep.addBucket(ey.tileID,el,this.crossTileIDs)&&(e_=!0),eg[el.bucketInstanceId]=!0)}return ep.removeStaleBuckets(eg)&&(e_=!0),e_}pruneUnusedLayers(F){let el={};for(let eh in F.forEach(F=>{el[F]=!0}),this.layerIndexes)el[eh]||delete this.layerIndexes[eh]}};let ki=class ki{constructor(F,el,eh,ec){this.blendFunction=F,this.blendColor=el,this.mask=eh,this.blendEquation=ec}};ki.Replace=[1,0,1,0],ki.disabled=new ki(ki.Replace,F.al.transparent,[!1,!1,!1,!1]),ki.unblended=new ki(ki.Replace,F.al.transparent,[!0,!0,!0,!0]),ki.alphaBlended=new ki([1,771,1,771],F.al.transparent,[!0,!0,!0,!0]),ki.alphaBlendedNonPremultiplied=new ki([770,771,770,771],F.al.transparent,[!0,!0,!0,!0]),ki.multiply=new ki([774,0,774,0],F.al.transparent,[!0,!0,!0,!0]);let Bi=class Bi{constructor(F,el,eh){this.func=F,this.mask=el,this.range=eh}};Bi.ReadOnly=!1,Bi.ReadWrite=!0,Bi.disabled=new Bi(519,Bi.ReadOnly,[0,1]);let Ui=class Ui{constructor(F,el,eh,ec,ep,e_){this.test=F,this.ref=el,this.mask=eh,this.fail=ec,this.depthFail=ep,this.pass=e_}};Ui.disabled=new Ui({func:519,mask:0},0,0,7680,7680,7680);let ji=class ji{constructor(F,el,eh){this.enable=F,this.mode=el,this.frontFace=eh}};function qi(el,eh){let ec=F.bG(el,3);F.ad.mat4.fromQuat(el,eh),F.bI(el,3,ec)}function Hi(el,eh){let ec=F.ad.quat.identity([]);return F.ad.quat.rotateZ(ec,ec,-eh),F.ad.quat.rotateX(ec,ec,-el),ec}function Zi(el,eh){let ec=[el[0],el[1],0],ep=[eh[0],eh[1],0];if(F.ad.vec3.length(ec)>=1e-15){let el=F.ad.vec3.normalize([],ec);F.ad.vec3.scale(ep,el,F.ad.vec3.dot(ep,el)),eh[0]=ep[0],eh[1]=ep[1]}let e_=F.ad.vec3.cross([],eh,el);if(1e-15>F.ad.vec3.len(e_))return null;let eg=Math.atan2(-e_[1],e_[0]);return Hi(Math.atan2(Math.sqrt(el[0]*el[0]+el[1]*el[1]),-el[2]),eg)}ji.disabled=new ji(!1,1029,2305),ji.backCCW=new ji(!0,1029,2305),ji.backCW=new ji(!0,1029,2304),ji.frontCW=new ji(!0,1028,2304),ji.frontCCW=new ji(!0,1028,2305);let Wi=class Wi{constructor(F,el){this.position=F,this.orientation=el}get position(){return this._position}set position(el){if(el){let eh=el instanceof F.ac?el:new F.ac(el[0],el[1],el[2]);this._renderWorldCopies&&(eh.x=F.bF(eh.x,0,1)),this._position=eh}else this._position=null}lookAtPoint(el,eh){if(this.orientation=null,!this.position)return;let ec=this.position,ep=this._elevation?this._elevation.getAtPointOrZero(F.ac.fromLngLat(el)):0,e_=F.ac.fromLngLat(el,ep),eg=[e_.x-ec.x,e_.y-ec.y,e_.z-ec.z];eh||(eh=[0,0,1]),eh[2]=Math.abs(eh[2]),this.orientation=Zi(eg,eh)}setPitchBearing(el,eh){this.orientation=Hi(F.ak(el),F.ak(-eh))}};let $i=class $i{constructor(el,eh){this._transform=F.ad.mat4.identity([]),this.orientation=eh,this.position=el}get mercatorPosition(){let el=this.position;return new F.ac(el[0],el[1],el[2])}get position(){let el=F.bG(this._transform,3);return[el[0],el[1],el[2]]}set position(el){el&&F.bI(this._transform,3,[el[0],el[1],el[2],1])}get orientation(){return this._orientation}set orientation(el){this._orientation=el||F.ad.quat.identity([]),el&&qi(this._transform,this._orientation)}getPitchBearing(){let F=this.forward(),el=this.right();return{bearing:Math.atan2(-el[1],el[0]),pitch:Math.atan2(Math.sqrt(F[0]*F[0]+F[1]*F[1]),-F[2])}}setPitchBearing(F,el){this._orientation=Hi(F,el),qi(this._transform,this._orientation)}forward(){let el=F.bG(this._transform,2);return[-el[0],-el[1],-el[2]]}up(){let el=F.bG(this._transform,1);return[-el[0],-el[1],-el[2]]}right(){let el=F.bG(this._transform,0);return[el[0],el[1],el[2]]}getCameraToWorld(el,eh){let ec=new Float64Array(16);return F.ad.mat4.invert(ec,this.getWorldToCamera(el,eh)),ec}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(el,eh,ec){let ep=this.position;F.ad.vec3.scale(ep,ep,-el);let e_=new Float64Array(16);return F.ad.mat4.fromScaling(e_,[ec,ec,ec]),F.ad.mat4.translate(e_,e_,ep),e_[10]*=eh,e_}getWorldToCamera(el,eh){let ec=new Float64Array(16),ep=new Float64Array(4),e_=this.position;return F.ad.quat.conjugate(ep,this._orientation),F.ad.vec3.scale(e_,e_,-el),F.ad.mat4.fromQuat(ec,ep),F.ad.mat4.translate(ec,ec,e_),ec[1]*=-1,ec[5]*=-1,ec[9]*=-1,ec[13]*=-1,ec[8]*=eh,ec[9]*=eh,ec[10]*=eh,ec[11]*=eh,ec}getCameraToClipPerspective(el,eh,ec,ep){let e_=new Float64Array(16);return F.ad.mat4.perspective(e_,el,eh,ec,ep),e_}getCameraToClipOrthographic(el,eh,ec,ep,e_,eg){let ey=new Float64Array(16);return F.ad.mat4.ortho(ey,el,eh,ec,ep,e_,eg),ey}getDistanceToElevation(el,eh=!1){let ec=0===el?0:F.bH(el,eh?F.aT(this.position[1]):this.position[1]),ep=this.forward();return(ec-this.position[2])/ep[2]}clone(){return new $i([...this.position],[...this.orientation])}};let e5={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};let Ki=class Ki{constructor(F=0,el=0,eh=0,ec=0){if(isNaN(F)||F<0||isNaN(el)||el<0||isNaN(eh)||eh<0||isNaN(ec)||ec<0)throw Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=F,this.bottom=el,this.left=eh,this.right=ec}interpolate(el,eh,ec){return null!=eh.top&&null!=el.top&&(this.top=F.ah(el.top,eh.top,ec)),null!=eh.bottom&&null!=el.bottom&&(this.bottom=F.ah(el.bottom,eh.bottom,ec)),null!=eh.left&&null!=el.left&&(this.left=F.ah(el.left,eh.left,ec)),null!=eh.right&&null!=el.right&&(this.right=F.ah(el.right,eh.right,ec)),this}getCenter(el,eh){let ec=F.ay((this.left+el-this.right)/2,0,el),ep=F.ay((this.top+eh-this.bottom)/2,0,eh);return new F.P(ec,ep)}equals(F){return this.top===F.top&&this.bottom===F.bottom&&this.left===F.left&&this.right===F.right}clone(){return new Ki(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}};let Ji=class Ji{constructor(el,eh,ec,ep,e_,eg,ey){this.tileSize=512,this._renderWorldCopies=void 0===e_||e_,this._minZoom=el||0,this._maxZoom=eh||22,this._minPitch=ec??0,this._maxPitch=ep??60,this.setProjection(eg),this.setMaxBounds(ey),this.width=0,this.height=0,this._center=new F.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ki,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new $i,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){let F=new Ji(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return F._elevation=this._elevation,F._centerAltitude=this._centerAltitude,F._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,F.tileSize=this.tileSize,F.mercatorFromTransition=this.mercatorFromTransition,F.width=this.width,F.height=this.height,F.cameraElevationReference=this.cameraElevationReference,F._center=this._center,F._setZoom(this.zoom),F._seaLevelZoom=this._seaLevelZoom,F.angle=this.angle,F._fov=this._fov,F._pitch=this._pitch,F._nearZ=this._nearZ,F._farZ=this._farZ,F._averageElevation=this._averageElevation,F._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,F._unmodified=this._unmodified,F._edgeInsets=this._edgeInsets.clone(),F._camera=this._camera.clone(),F._calcMatrices(),F.freezeTileCoverage=this.freezeTileCoverage,F.frustumCorners=this.frustumCorners,F._allowWorldUnderZoom=this._allowWorldUnderZoom,F}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(F){this._elevation!==F&&(this._elevation=F,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(F,el=!1){let eh=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||eh)&&this._updateCameraOnTerrain(),(F||eh)&&this._constrainCamera(el),this._calcMatrices()}getProjection(){return F.aA(this.projection,["name","center","parallels"])}setProjection(el){this.projectionOptions=el||{name:"mercator"};let eh=this.projection?this.getProjection():void 0;this.projection=F.bP(this.projectionOptions);let ec=this.getProjection(),ep=!F.bn(eh,ec);return ep&&this._calcMatrices(),this.mercatorFromTransition=!1,ep}setOrthographicProjectionAtLowPitch(F){return this._orthographicProjectionAtLowPitch!==F&&(this._orthographicProjectionAtLowPitch=F,this._calcMatrices(),!0)}setMercatorFromTransition(){let el=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=F.bP({name:"mercator"});let eh=el!==this.projection.name;return eh&&this._calcMatrices(),eh}get minZoom(){return this._minZoom}set minZoom(F){this._minZoom!==F&&(this._minZoom=F,this.zoom=Math.max(this.zoom,F))}get maxZoom(){return this._maxZoom}set maxZoom(F){this._maxZoom!==F&&(this._maxZoom=F,this.zoom=Math.min(this.zoom,F))}get minPitch(){return this._minPitch}set minPitch(F){this._minPitch!==F&&(this._minPitch=F,this.pitch=Math.max(this.pitch,F))}get maxPitch(){return this._maxPitch}set maxPitch(F){this._maxPitch!==F&&(this._maxPitch=F,this.pitch=Math.min(this.pitch,F))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(F){void 0===F?F=!0:null===F&&(F=!1),this._renderWorldCopies=F}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){let F=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get cameraWorldSize(){let F=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(F))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return F.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new F.P(this.width,this.height)}get bearing(){return F.bF(this.rotation,-180,180)}set bearing(F){this.rotation=F}get rotation(){return-this.angle/Math.PI*180}set rotation(el){let eh=-el*Math.PI/180;this.angle!==eh&&(this._unmodified=!1,this.angle=eh,this._calcMatrices(),this.rotationMatrix=F.ad.mat2.create(),F.ad.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(el){let eh=F.ay(el,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==eh&&(this._unmodified=!1,this._pitch=eh,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(el){el=Math.max(.01,Math.min(60,el)),this._fov!==el&&(this._unmodified=!1,this._fov=F.ak(el),this._calcMatrices())}get fovX(){return this._fov}get fovY(){let F=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/F)}get averageElevation(){return this._averageElevation}set averageElevation(F){this._averageElevation=F,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(F){let el=Math.min(Math.max(F,this.minZoom),this.maxZoom);this._zoom!==el&&(this._unmodified=!1,this._setZoom(el),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(F){this._zoom=F,this.scale=this.zoomScale(F),this.tileZoom=Math.floor(F),this.zoomFraction=F-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(F){this._tileCoverLift!==F&&(this._tileCoverLift=F)}_updateCameraOnTerrain(){let F=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,el=this.elevation&&F===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||F===Number.NEGATIVE_INFINITY&&(!el||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);let eh=this._elevation;el||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&eh.exaggeration()&&this._centerAltitudeValidForExaggeration!==eh.exaggeration()?this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*eh.exaggeration():this._centerAltitude=F||0,this._centerAltitudeValidForExaggeration=eh.exaggeration(),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;let el=this._elevation,eh=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],ec=this.horizonLineFromTop(),ep=0,e_=0;for(let eg=0;eg<eh.length;eg++){let ey=new F.P(eh[eg][0]*this.width,ec+eh[eg][1]*(this.height-ec)),eb=el.pointCoordinate(ey);if(!eb)continue;let ew=1/Math.hypot(eb[0]-this._camera.position[0],eb[1]-this._camera.position[1]);ep+=eb[3]*ew,e_+=ew}return 0===e_?NaN:ep/e_}get center(){return this._center}set center(F){F.lat===this._center.lat&&F.lng===this._center.lng||(this._unmodified=!1,this._center=F,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;let F=this._seaLevelZoom,el=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),eh=this.pixelsPerMeter/this.worldSize*el,ec=this._mercatorZfromZoom(F),ep=this._mercatorZfromZoom(this._maxZoom),e_=Math.max(ec-eh,ep);this._setZoom(this._zoomFromMercatorZ(e_))}get padding(){return this._edgeInsets.toJSON()}set padding(F){this._edgeInsets.equals(F)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,F,1),this._calcMatrices())}computeZoomRelativeTo(el){let eh;let ec=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,el.toAltitude()));eh=el.z<this._camera.position[2]?[ec.x,ec.y,ec.z]:[el.x,el.y,el.z];let ep=F.ad.vec3.length(F.ad.vec3.sub([],this._camera.position,eh));return F.ay(this._zoomFromMercatorZ(ep),this._minZoom,this._maxZoom)}setFreeCameraOptions(el){if(!this.height||!el.position&&!el.orientation)return;this._updateCameraState();let eh=!1;if(el.orientation&&!F.ad.quat.exactEquals(el.orientation,this._camera.orientation)&&(eh=this._setCameraOrientation(el.orientation)),el.position){let ec=[el.position.x,el.position.y,el.position.z];F.ad.vec3.exactEquals(ec,this._camera.position)||(this._setCameraPosition(ec),eh=!0)}eh&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();let el=this._camera.position,eh=new Wi;return eh.position=new F.ac(el[0],el[1],el[2]),eh.orientation=this._camera.orientation,eh._elevation=this.elevation,eh._renderWorldCopies=this.renderWorldCopies,eh}_setCameraOrientation(el){if(!F.ad.quat.length(el))return!1;F.ad.quat.normalize(el,el);let eh=F.ad.vec3.transformQuat([],[0,0,-1],el),ec=F.ad.vec3.transformQuat([],[0,-1,0],el);if(ec[2]<0)return!1;let ep=Zi(eh,ec);return!!ep&&(this._camera.orientation=ep,!0)}_setCameraPosition(el){let eh=this.zoomScale(this.minZoom)*this.tileSize,ec=this.zoomScale(this.maxZoom)*this.tileSize,ep=this.cameraToCenterDistance;el[2]=F.ay(el[2],ep/ec,ep/eh),this._camera.position=el}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(F){return this._edgeInsets.equals(F)}interpolatePadding(F,el,eh){this._unmodified=!1,this._edgeInsets.interpolate(F,el,eh),this._constrain(),this._calcMatrices()}coveringZoomLevel(F){let el=(F.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/F.tileSize));return Math.max(0,el)}getVisibleUnwrappedCoordinates(el){let eh=[new F.bQ(0,el)];if(this.renderWorldCopies){let ec=this.pointCoordinate(new F.P(0,0)),ep=this.pointCoordinate(new F.P(this.width,0)),e_=this.pointCoordinate(new F.P(this.width,this.height)),eg=this.pointCoordinate(new F.P(0,this.height)),ey=Math.floor(Math.min(ec.x,ep.x,e_.x,eg.x)),eb=Math.floor(Math.max(ec.x,ep.x,e_.x,eg.x));for(let ec=ey-1;ec<=eb+1;ec++)0!==ec&&eh.push(new F.bQ(ec,el))}return eh}isLODDisabled(F){return(!F||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(el,eh,ec){let ep=[],e_=void 0!==ec,eg=!e_;if(eg&&this.zoom<eh||e_&&0===ec[0]&&0===ec[1])return ep;let ey=new Set,l=(el,eh,ec,e_,eg)=>{let eb=F.c5(eh,el,ec,e_,eg);ey.has(eb)||(ep.push(new F.aH(el,eh,ec,e_,eg)),ey.add(eb))};for(let F=0;F<el.length;F++){let ep=el[F];if(eg&&ep.canonical.z!==eh)continue;let ey=ep.canonical,eb=ep.overscaledZ,ew=ep.wrap,eT=1<<ey.z,eS=ey.x+1<eT,eE=ey.x>0,eM=ey.y+1<eT,eI=ey.y>0,eA=ep.wrap-(eE?0:1),eC=ep.wrap+(eS?0:1),eP=eE?ey.x-1:eT-1,ez=eS?ey.x+1:0;if(e_)ec[0]<0?(l(eb,eC,ey.z,ez,ey.y),ec[1]<0&&eM&&(l(eb,ew,ey.z,ey.x,ey.y+1),l(eb,eC,ey.z,ez,ey.y+1)),ec[1]>0&&eI&&(l(eb,ew,ey.z,ey.x,ey.y-1),l(eb,eC,ey.z,ez,ey.y-1))):ec[0]>0?(l(eb,eA,ey.z,eP,ey.y),ec[1]<0&&eM&&(l(eb,ew,ey.z,ey.x,ey.y+1),l(eb,eA,ey.z,eP,ey.y+1)),ec[1]>0&&eI&&(l(eb,ew,ey.z,ey.x,ey.y-1),l(eb,eA,ey.z,eP,ey.y-1))):ec[1]<0&&eM?l(eb,ew,ey.z,ey.x,ey.y+1):eI&&l(eb,ew,ey.z,ey.x,ey.y-1);else{let F=ep.visibleQuadrants;1&F&&(l(eb,eA,ey.z,eP,ey.y),eI&&(l(eb,ew,ey.z,ey.x,ey.y-1),l(eb,eA,ey.z,eP,ey.y-1))),2&F&&(l(eb,eC,ey.z,ez,ey.y),eI&&(l(eb,ew,ey.z,ey.x,ey.y-1),l(eb,eC,ey.z,ez,ey.y-1))),4&F&&(l(eb,eA,ey.z,eP,ey.y),eM&&(l(eb,ew,ey.z,ey.x,ey.y+1),l(eb,eA,ey.z,eP,ey.y+1))),8&F&&(l(eb,eC,ey.z,ez,ey.y),eM&&(l(eb,ew,ey.z,ey.x,ey.y+1),l(eb,eC,ey.z,ez,ey.y+1)))}}let eb=[];for(let F of ep)ep.some(el=>F.isChildOf(el))||eb.push(F);if(ep=eb.filter(F=>!el.some(el=>!!(F.overscaledZ<eh&&el.isChildOf(F))||F.equals(el)||F.isChildOf(el))),eg){let F=1<<eh,el="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),ec=[F*el.x,F*el.y];ep=ep.filter(F=>{let el=F.canonical.x+.5-ec[0],eh=F.canonical.y+.5-ec[1];return el*el+eh*eh<16})}return ep}coveringTiles(el){let eh,ec=this.coveringZoomLevel(el),ep=ec,e_=this.elevation&&this.elevation.exaggeration(),eg=e_&&!el.isTerrainDEM,ey="mercator"===this.projection.name;if(void 0!==el.minzoom&&ec<el.minzoom)return[];void 0!==el.maxzoom&&ec>el.maxzoom&&(ec=el.maxzoom);let eb=this.locationCoordinate(this.center),ew=this.center.lat,eT=1<<ec,eS=[eT*eb.x,eT*eb.y,0],eE="globe"===this.projection.name,eM=!eE,eI=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,ec,eM),eA=eE?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),eC=eT*F.bH(1,this.center.lat),eP=this._camera.position[2]/F.bH(1,this.center.lat),ez=[eT*eA.x,eT*eA.y,eP*(eM?1:eC)],eD=eE||e_,eR=this.cameraToCenterDistance/el.tileSize*(el.roundZoom?1:.502),eL=this.isLODDisabled(!0)?ec:0;if(this._elevation&&el.isTerrainDEM)eh=1e4*this._elevation.exaggeration();else if(this._elevation){let F=this._elevation.getMinMaxForVisibleTiles();eh=F?F.max:this._centerAltitude}else eh=this._centerAltitude;let eO=el.isTerrainDEM?-eh:this._elevation?this._elevation.getMinElevationBelowMSL():0,ek=this.projection.isReprojectedInTileSpace?F.bS(this):1,E=el=>{let eh=1/4e4,ec=new F.ac(el.x+eh,el.y,el.z),ep=new F.ac(el.x,el.y+eh,el.z),e_=el.toLngLat(),eg=ec.toLngLat(),ey=ep.toLngLat(),eb=this.locationCoordinate(e_),ew=this.locationCoordinate(eg),eT=this.locationCoordinate(ey),eS=Math.hypot(ew.x-eb.x,ew.y-eb.y),eE=Math.hypot(eT.x-eb.x,eT.y-eb.y);return Math.sqrt(eS*eE)*ek/eh},S=el=>{let ec=eh;return{aabb:F.bV(this,eT,0,0,0,el,eO,ec,this.projection),zoom:0,x:0,y:0,minZ:eO,maxZ:ec,wrap:el,fullyVisible:!1}},eF=[],eB=[],eN=ec,eV=el.reparseOverscaled?ep:ec,eU=(eP-this._centerAltitude)*eC,L=F=>{if(!this._elevation||!F.tileID||!ey)return;let el=this._elevation.getMinMaxForTile(F.tileID),eh=F.aabb;el?(eh.min[2]=el.min,eh.max[2]=el.max,eh.center[2]=(eh.min[2]+eh.max[2])/2):(F.shouldSplit=P(F),F.shouldSplit||(eh.min[2]=eh.max[2]=eh.center[2]=this._centerAltitude))},M=(F,el)=>{if(.707*el<F)return 1;let eh=el/F;return eh/(1.4144271570014144+(Math.pow(1.1,eh-1.4144271570014144+1)-1)/(1.1-1)-1)},P=el=>{if(el.zoom<eL)return!0;if(el.zoom===eN)return!1;if(null!=el.shouldSplit)return el.shouldSplit;let eh=el.aabb.distanceX(ez),ec=el.aabb.distanceY(ez),e_=eU,eb=1;if(eE){e_=el.aabb.distanceZ(ez);let eh=Math.pow(2,el.zoom),ec=F.aT((el.y+1)/eh),ep=F.aT(el.y/eh),eg=Math.min(Math.max(ew,ec),ep),ey=F.ca(eg)/F.ca(ew);if(eb=eg===ew?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,ey/this._mercatorScaleRatio),this.zoom<=F.c6&&el.zoom===eN-1&&ey>=.9)return!0}else if(eg&&(e_=el.aabb.distanceZ(ez)*eC),this.projection.isReprojectedInTileSpace&&ep<=5){let eh=Math.pow(2,el.zoom),ec=E(new F.ac((el.x+.5)/eh,(el.y+.5)/eh));eb=ec>.85?1:ec}if(!ey){let F=Math.sqrt(eh*eh+ec*ec+e_*e_),ep=(1<<eN-el.zoom)*eR*eb;return ep*=M(Math.max(e_,eU),F),F<ep}let eT=Number.MAX_VALUE,eM=0,eI=el.aabb.getCorners(),eA=[];for(let el of eI){F.ad.vec3.sub(eA,el,ez),eE||(eg?eA[2]*=eC:eA[2]=eU);let eh=F.ad.vec3.dot(eA,this._camera.forward());eh<eT&&(eT=eh,eM=Math.abs(eA[2]))}let eP=(1<<eN-el.zoom)*eR*eb;if(eP*=M(Math.max(eM,eU),eT),eT<eP)return!0;let eD=el.aabb.closestPoint(eS);return eD[0]===eS[0]&&eD[1]===eS[1]};if(this.renderWorldCopies)for(let F=1;F<=3;F++)eF.push(S(-F)),eF.push(S(F));for(eF.push(S(0));eF.length>0;){let eh=eF.pop(),ep=eh.x,e_=eh.y,eb=eh.fullyVisible,u=()=>"globe"===this.projection.name&&(0===eh.y||eh.y===(1<<eh.zoom)-1);if(!eb){let el=eD?eh.aabb.intersects(eI):eh.aabb.intersectsFlat(eI);if(0===el&&u()){let ec=new F.bT(eh.zoom,ep,e_);el=F.bU(this,eT,ec,!0).intersects(eI)}if(0===el)continue;eb=2===el}if(eh.zoom!==eN&&P(eh))for(let el=0;el<4;el++){let ec=(ep<<1)+el%2,ew=(e_<<1)+(el>>1),eS={aabb:ey?eh.aabb.quadrant(el):F.bV(this,eT,eh.zoom+1,ec,ew,eh.wrap,eh.minZ,eh.maxZ,this.projection),zoom:eh.zoom+1,x:ec,y:ew,wrap:eh.wrap,fullyVisible:eb,tileID:void 0,shouldSplit:void 0,minZ:eh.minZ,maxZ:eh.maxZ};eg&&!eE&&(eS.tileID=new F.aH(eh.zoom+1===eN?eV:eh.zoom+1,eh.wrap,eh.zoom+1,ec,ew),L(eS)),eF.push(eS)}else{let eg=eh.zoom===eN?eV:eh.zoom;if(el.minzoom&&el.minzoom>eg)continue;let ey=0;if(!eb){let ec=eD?eh.aabb.intersectsPrecise(eI):eh.aabb.intersectsPreciseFlat(eI);if(0===ec&&u()){let el=new F.bT(eh.zoom,ep,e_);ec=F.bU(this,eT,el,!0).intersectsPrecise(eI)}if(0===ec)continue;if(el.calculateQuadrantVisibility){if(eI.containsPoint(eh.aabb.center))ey=15;else for(let F=0;F<4;F++)0!==eh.aabb.quadrant(F).intersects(eI)&&(ey|=1<<F)}}let ew=eS[0]-(.5+ep+(eh.wrap<<eh.zoom))*(1<<ec-eh.zoom),eE=eS[1]-.5-e_,eM=eh.tileID?eh.tileID:new F.aH(eg,eh.wrap,eh.zoom,ep,e_);el.calculateQuadrantVisibility&&(eM.visibleQuadrants=ey),eB.push({tileID:eM,distanceSq:ew*ew+eE*eE})}}if(this.fogCullDistSq){let ec=this.fogCullDistSq,ep=this.horizonLineFromTop();eB=eB.filter(e_=>{let eg=[0,0,0,1],ey=[F.ai,F.ai,0,1],eb=this.calculateFogTileMatrix(e_.tileID.toUnwrapped());F.ad.vec4.transformMat4(eg,eg,eb),F.ad.vec4.transformMat4(ey,ey,eb);let ew=F.ad.vec4.min([],eg,ey),eT=F.ad.vec4.max([],eg,ey),eS=F.bW(ew,eT);if(0===eS)return!0;let eE=!1,eM=this._elevation;if(eM&&eS>ec&&0!==ep){let ec;let eg=this.calculateProjMatrix(e_.tileID.toUnwrapped());el.isTerrainDEM||(ec=eM.getMinMaxForTile(e_.tileID)),ec||(ec={min:eO,max:eh});let ey=F.c7(this.rotation),eb=[ey[0]*F.ai,ey[1]*F.ai,ec.max];F.ad.vec3.transformMat4(eb,eb,eg),eE=(1-eb[1])*this.height*.5<ep}return eS<ec||eE})}return eB.sort((F,el)=>F.distanceSq-el.distanceSq).map(F=>F.tileID)}resize(F,el){this.width=F,this.height=el,this.pixelsToGLUnits=[2/F,-2/el],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(F){return Math.pow(2,F)}scaleZoom(F){return Math.log(F)/Math.LN2}project(el){let eh=F.ay(el.lat,-F.bX,F.bX),ec=this.projection.project(el.lng,eh);return new F.P(ec.x*this.worldSize,ec.y*this.worldSize)}unproject(F){return this.projection.unproject(F.x/this.worldSize,F.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/F.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(el,eh){let ec,ep;let e_=this.centerPoint;if("globe"===this.projection.name){let F=this.worldSize;ec=(eh.x-e_.x)/F,ep=(eh.y-e_.y)/F}else{let F=this.pointCoordinate(eh),el=this.pointCoordinate(e_);ec=F.x-el.x,ep=F.y-el.y}let eg=this.locationCoordinate(el);this.setLocation(new F.ac(eg.x-ec,eg.y-ep))}setLocation(F){this.center=this.coordinateLocation(F),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(F,el){return this.projection.locationPoint(this,F,el)}locationPoint3D(F,el){return this.projection.locationPoint(this,F,el,!0)}pointLocation(F){return this.coordinateLocation(this.pointCoordinate(F))}pointLocation3D(F,el){return this.coordinateLocation(this.pointCoordinate3D(F,el))}locationCoordinate(el,eh){let ec=eh?F.bH(eh,el.lat):void 0,ep=this.projection.project(el.lng,el.lat);return new F.ac(ep.x,ep.y,ec)}coordinateLocation(F){return this.projection.unproject(F.x,F.y)}pointRayIntersection(el,eh){let ec=null!=eh?eh:this._centerAltitude,ep=[el.x,el.y,0,1],e_=[el.x,el.y,1,1];F.ad.vec4.transformMat4(ep,ep,this.pixelMatrixInverse),F.ad.vec4.transformMat4(e_,e_,this.pixelMatrixInverse);let eg=e_[3];F.ad.vec4.scale(ep,ep,1/ep[3]),F.ad.vec4.scale(e_,e_,1/eg);let ey=ep[2],eb=e_[2];return{p0:ep,p1:e_,t:ey===eb?0:(ec-ey)/(eb-ey)}}screenPointToMercatorRay(el){let eh=[el.x,el.y,0,1],ec=[el.x,el.y,1,1];return F.ad.vec4.transformMat4(eh,eh,this.pixelMatrixInverse),F.ad.vec4.transformMat4(ec,ec,this.pixelMatrixInverse),F.ad.vec4.scale(eh,eh,1/eh[3]),F.ad.vec4.scale(ec,ec,1/ec[3]),eh[2]=F.bH(eh[2],this._center.lat)*this.worldSize,ec[2]=F.bH(ec[2],this._center.lat)*this.worldSize,F.ad.vec4.scale(eh,eh,1/this.worldSize),F.ad.vec4.scale(ec,ec,1/this.worldSize),new F.as([eh[0],eh[1],eh[2]],F.ad.vec3.normalize([],F.ad.vec3.sub([],ec,eh)))}rayIntersectionCoordinate(el){let{p0:eh,p1:ec,t:ep}=el,e_=F.bH(eh[2],this._center.lat),eg=F.bH(ec[2],this._center.lat);return new F.ac(F.ah(eh[0],ec[0],ep)/this.worldSize,F.ah(eh[1],ec[1],ep)/this.worldSize,F.ah(e_,eg,ep))}pointCoordinate(F,el=this._centerAltitude){return this.projection.pointCoordinate(this,F.x,F.y,el)}pointCoordinate3D(el,eh){if(!this.elevation)return this.pointCoordinate(el,eh);let ec=this.projection.pointCoordinate3D(this,el.x,el.y);if(ec)return new F.ac(ec[0],ec[1],ec[2]);let ep=0,e_=this.horizonLineFromTop();if(el.y>e_)return this.pointCoordinate(el,eh);let eg=.02*e_,ey=el.clone();for(let el=0;el<10&&e_-ep>eg;el++){ey.y=F.ah(ep,e_,.66);let el=this.projection.pointCoordinate3D(this,ey.x,ey.y);el?(e_=ey.y,ec=el):ep=ey.y}return ec?new F.ac(ec[0],ec[1],ec[2]):this.pointCoordinate(el)}isPointAboveHorizon(F){return this.projection.isPointAboveHorizon(this,F)}isPointOnSurface(el){if(el.y<0||el.y>this.height||el.x<0||el.x>this.width)return!1;if(this.elevation||this.zoom>=F.bY)return!this.isPointAboveHorizon(el);let eh=this.pointCoordinate(el);return eh.y>=0&&eh.y<=1}_coordinatePoint(el,eh){let ec=eh&&this.elevation?this.elevation.getAtPointOrZero(el,this._centerAltitude):this._centerAltitude,ep=[el.x*this.worldSize,el.y*this.worldSize,ec+el.toAltitude(),1];return F.ad.vec4.transformMat4(ep,ep,this.pixelMatrix),ep[3]>0?new F.P(ep[0]/ep[3],ep[1]/ep[3]):new F.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){let{top:el,left:eh}=this._edgeInsets,ec=this.height-this._edgeInsets.bottom,ep=this.width-this._edgeInsets.right,e_=this.pointLocation3D(new F.P(eh,el)),eg=this.pointLocation3D(new F.P(ep,el)),ey=this.pointLocation3D(new F.P(ep,ec)),eb=this.pointLocation3D(new F.P(eh,ec)),ew=Math.min(e_.lng,eg.lng,ey.lng,eb.lng),eT=Math.max(e_.lng,eg.lng,ey.lng,eb.lng),eS=Math.min(e_.lat,eg.lat,ey.lat,eb.lat),eE=Math.max(e_.lat,eg.lat,ey.lat,eb.lat),eM=Math.pow(2,-this.zoom)/16*270,eI="globe"===this.projection.name?1:4,f=(el,eh,ec,ep,e_)=>{let eg=(el+ec)/2,ey=(eh+ep)/2,eb=new F.P(eg,ey),{lng:eA,lat:eC}=this.pointLocation3D(eb),eP=Math.max(0,ew-eA,eS-eC,eA-eT,eC-eE);ew=Math.min(ew,eA),eT=Math.max(eT,eA),eS=Math.min(eS,eC),eE=Math.max(eE,eC),(e_<eI||eP>eM)&&(f(el,eh,eg,ey,e_+1),f(eg,ey,ec,ep,e_+1))};if(f(eh,el,ep,el,1),f(ep,el,ep,ec,1),f(ep,ec,eh,ec,1),f(eh,ec,eh,el,1),"globe"===this.projection.name){let[el,eh]=F.bZ(this);el?(eE=90,eT=180,ew=-180):eh&&(eS=-90,eT=180,ew=-180)}return new F.aB(new F.bO(ew,eS),new F.bO(eT,eE))}_getBoundsRectangular(el,eh){let{top:ec,left:ep}=this._edgeInsets,e_=this.height-this._edgeInsets.bottom,eg=this.width-this._edgeInsets.right,ey=new F.P(ep,ec),eb=new F.P(eg,ec),ew=new F.P(eg,e_),eT=new F.P(ep,e_),eS=this.pointCoordinate(ey,el),eE=this.pointCoordinate(eb,el),eM=this.pointCoordinate(ew,eh),eI=this.pointCoordinate(eT,eh),f=(F,el)=>(el.y-F.y)/(el.x-F.x);return eS.y>1&&eE.y>=0?eS=new F.ac((1-eI.y)/f(eI,eS)+eI.x,1):eS.y<0&&eE.y<=1&&(eS=new F.ac(-eI.y/f(eI,eS)+eI.x,0)),eE.y>1&&eS.y>=0?eE=new F.ac((1-eM.y)/f(eM,eE)+eM.x,1):eE.y<0&&eS.y<=1&&(eE=new F.ac(-eM.y/f(eM,eE)+eM.x,0)),(new F.aB).extend(this.coordinateLocation(eS)).extend(this.coordinateLocation(eE)).extend(this.coordinateLocation(eI)).extend(this.coordinateLocation(eM))}_getBoundsRectangularTerrain(){let F=this.elevation;if(!F.visibleDemTiles.length||F.isUsingMockSource())return this._getBoundsRectangular(0,0);let el=F.visibleDemTiles.reduce((F,el)=>{if(el.dem){let eh=el.dem.tree;F.min=Math.min(F.min,eh.minimums[0]),F.max=Math.max(F.max,eh.maximums[0])}return F},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(el.min*F.exaggeration(),el.max*F.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(F=!0){let el=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,eh=this.height/2-el*(1-this._horizonShift);return F?Math.max(0,eh):eh}getMaxBounds(){return this.maxBounds}setMaxBounds(el){this.maxBounds=el,this.minLat=-F.bX,this.maxLat=F.bX,this.minLng=-180,this.maxLng=180,el&&(this.minLat=el.getSouth(),this.maxLat=el.getNorth(),this.minLng=el.getWest(),this.maxLng=el.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=F.av(this.minLng)*this.tileSize,this.worldMaxX=F.av(this.maxLng)*this.tileSize,this.worldMinY=F.aC(this.maxLat)*this.tileSize,this.worldMaxY=F.aC(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(F,el){return this.projection.createTileMatrix(this,el,F)}calculateDistanceTileData(el){let eh=el.key,ec=this._distanceTileDataCache;if(ec[eh])return ec[eh];let ep=el.canonical,e_=1/this.height,eg=this.cameraWorldSize,ey=eg/this.zoomScale(ep.z),eb=(ep.x+Math.pow(2,ep.z)*el.wrap)*ey,ew=ep.y*ey,eT=this.point;eT.x*=eg/this.worldSize,eT.y*=eg/this.worldSize;let eS=this.angle,eE=Math.sin(-eS),eM=-Math.cos(-eS);return ec[eh]={bearing:[eE,eM],center:[(eT.x-eb)*e_,(eT.y-ew)*e_],scale:ey/F.ai*e_},ec[eh]}calculateFogTileMatrix(el){let eh=el.key,ec=this._fogTileMatrixCache;if(ec[eh])return ec[eh];let ep=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,el);return F.ad.mat4.multiply(ep,this.worldToFogMatrix,ep),ec[eh]=new Float32Array(ep),ec[eh]}calculateProjMatrix(el,eh=!1,ec=!1){let ep,e_;let eg=el.key;if((ep=ec?this._expandedProjMatrixCache:eh?this._alignedProjMatrixCache:this._projMatrixCache)[eg])return ep[eg];let ey=this.calculatePosMatrix(el,this.worldSize);return e_=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:ec?this.expandedFarZProjMatrix:eh?this.alignedProjMatrix:this.projMatrix,F.ad.mat4.multiply(ey,e_,ey),ep[eg]=new Float32Array(ey),ep[eg]}calculatePixelsToTileUnitsMatrix(el){let eh=el.tileID.key,ec=this._pixelsToTileUnitsCache;if(ec[eh])return ec[eh];let ep=F.b_(el,this);return ec[eh]=ep,ec[eh]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){let el=1/this.worldSize,eh=F.ad.mat4.fromScaling([],[el,el,el]);return F.ad.mat4.multiply(eh,eh,this.globeMatrix),eh}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;let el=this._elevation;this._updateCameraState();let eh=F.bH(1,this._center.lat)*this.worldSize,ec=this._computeCameraPosition(eh),ep=this._camera.forward(),e_=F.bH(1,this._center.lat);ec[2]/=e_,ep[2]/=e_,F.ad.vec3.normalize(ep,ep);let eg=el.raycast(ec,ep,el.exaggeration());if(eg){let el=F.ad.vec3.scaleAndAdd([],ec,ep,eg),eh=new F.ac(el[0],el[1],F.bH(el[2],F.aT(el[1]))),ey=(eh.z+F.ad.vec3.length([eh.x-ec[0],eh.y-ec[1],eh.z-ec[2]*e_]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(ey),this._centerAltitude=eh.toAltitude(),this._center=this.coordinateLocation(eh),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(el=!1){if(!this._elevation)return;let eh=this._elevation,ec=F.bH(1,this._center.lat)*this.worldSize,ep=this._computeCameraPosition(ec),e_=eh.getAtPointOrZero(new F.ac(...ep)),eg=this.pixelsPerMeter/this.worldSize*e_,ey=this._minimumHeightOverTerrain(),eb=ep[2]-eg;if(eb<=ey){if(eb<0||el){let el=this.locationCoordinate(this._center,this._centerAltitude),eh=[ep[0],ep[1],el.z-ep[2]],ec=F.ad.vec3.length(eh);eh[2]-=(ey-eb)/this._pixelsPerMercatorPixel;let e_=F.ad.vec3.length(eh);if(0===e_)return;F.ad.vec3.scale(eh,eh,ec/e_*this._pixelsPerMercatorPixel),this._camera.position=[ep[0],ep[1],el.z*this._pixelsPerMercatorPixel-eh[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;let el="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||el){let eh=this.center;return eh.lat=F.ay(eh.lat,this.minLat,this.maxLat),!this.maxBounds&&(this.renderWorldCopies||el)||(eh.lng=F.ay(eh.lng,this.minLng,this.maxLng)),this.center=eh,void(this._constraining=!1)}let eh=this._unmodified,{x:ec,y:ep}=this.point,e_=0,eg=ec,ey=ep,eb=this.width/2,ew=this.height/2,eT=this.worldMinY*this.scale,eS=this.worldMaxY*this.scale;if(ep-ew<eT&&(ey=eT+ew),ep+ew>eS&&(ey=eS-ew),eS-eT<this.height&&(e_=Math.max(e_,this.height/(eS-eT)),ey=(eS+eT)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){let F=this.worldMinX*this.scale,el=this.worldMaxX*this.scale,eh=this.worldSize/2-(F+el)/2;(eg=(ec+eh+this.worldSize)%this.worldSize-eh)-eb<F&&(eg=F+eb),eg+eb>el&&(eg=el-eb),el-F<this.width&&(e_=Math.max(e_,this.width/(el-F)),eg=(el+F)/2)}eg===ec&&ey===ep||this._allowWorldUnderZoom||(this.center=this.unproject(new F.P(eg,ey))),e_&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(e_)),this._constrainCamera(),this._unmodified=eh,this._constraining=!1}_minZoomForBounds(){let F=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(F=Math.max(F,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),F}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){let el;if(!this.height)return;let eh=this.centerOffset,ec="globe"===this.projection.name,ep=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=F.bH(1,this.center.lat)/F.bH(1,F.c8));let e_=F.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,e_),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;let eg="meters"===this.projection.zAxisUnit?ep:1,ey=this._camera.getWorldToCamera(this.worldSize,eg),eb=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(eb[8]=-(2*eh.x)/this.width,eb[9]=2*eh.y/this.height,this.isOrthographic){let ec=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ep=ec*this.aspect,e_=-ep,eg=-ec;ep-=eh.x,e_-=eh.x,ec+=eh.y,eg+=eh.y,((el,eh,ec,ep)=>{for(let e_=0;e_<16;e_++)el[e_]=F.ah(eh[e_],ec[e_],ep)})(el=this._camera.getCameraToClipOrthographic(e_,ep,eg,ec,this._nearZ,this._farZ),el,eb,F.c9(this.pitch>=15?1:this.pitch/15))}else el=eb;let ew=F.ad.mat4.mul([],eb,ey),eT=F.ad.mat4.mul([],el,ey);if(this.projection.isReprojectedInTileSpace){let el=this.locationCoordinate(this.center),eh=F.ad.mat4.identity([]);F.ad.mat4.translate(eh,eh,[el.x*this.worldSize,el.y*this.worldSize,0]),F.ad.mat4.multiply(eh,eh,F.c0(this)),F.ad.mat4.translate(eh,eh,[-el.x*this.worldSize,-el.y*this.worldSize,0]),F.ad.mat4.multiply(eT,eT,eh),F.ad.mat4.multiply(ew,ew,eh),this.inverseAdjustmentMatrix=F.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=F.ad.mat4.scale([],eT,[this.worldSize,this.worldSize,this.worldSize/eg,1]),this.projMatrix=eT,this.invProjMatrix=F.ad.mat4.invert(new Float64Array(16),this.projMatrix),ec){let el=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);el[8]=-(2*eh.x)/this.width,el[9]=2*eh.y/this.height,this.expandedFarZProjMatrix=F.ad.mat4.mul([],el,ey)}else this.expandedFarZProjMatrix=this.projMatrix;let eS=F.ad.mat4.invert([],el);this.frustumCorners=F.c2.fromInvProjectionMatrix(eS,this.horizonLineFromTop(),this.height),this.cameraFrustum=F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!ec);let eE=new Float32Array(16);F.ad.mat4.identity(eE),F.ad.mat4.scale(eE,eE,[1,-1,1]),F.ad.mat4.rotateX(eE,eE,this._pitch),F.ad.mat4.rotateZ(eE,eE,this.angle);let eM=F.ad.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=F.ad.mat4.clone(eM);let eI=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;eM[8]=-(2*eh.x)/this.width,eM[9]=2*(eh.y+eI)/this.height,this.skyboxMatrix=F.ad.mat4.multiply(eE,eM,eE);let eA=this.point,eC=eA.x,eP=eA.y,ez=this.width%2/2,eD=this.height%2/2,eR=Math.cos(this.angle),eL=Math.sin(this.angle),eO=eC-Math.round(eC)+eR*ez+eL*eD,ek=eP-Math.round(eP)+eR*eD+eL*ez,eF=new Float64Array(eT);if(F.ad.mat4.translate(eF,eF,[eO>.5?eO-1:eO,ek>.5?ek-1:ek,0]),this.alignedProjMatrix=eF,eT=F.ad.mat4.create(),F.ad.mat4.scale(eT,eT,[this.width/2,-this.height/2,1]),F.ad.mat4.translate(eT,eT,[1,-1,0]),this.labelPlaneMatrix=eT,eT=F.ad.mat4.create(),F.ad.mat4.scale(eT,eT,[1,-1,1]),F.ad.mat4.translate(eT,eT,[-1,-1,0]),F.ad.mat4.scale(eT,eT,[2/this.width,2/this.height,1]),this.glCoordMatrix=eT,this.pixelMatrix=F.ad.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,ew),this._calcFogMatrices(),this._distanceTileDataCache={},!(eT=F.ad.mat4.invert(new Float64Array(16),this.pixelMatrix)))throw Error("failed to invert matrix");if(this.pixelMatrixInverse=eT,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=F.c3(this);let el=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=F.ad.vec3.transformMat4(el,el,ey),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=eT;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};let el=this.cameraWorldSizeForFog,eh=this.cameraPixelsPerMeter,ec=this._camera.position,ep=1/this.height/this._pixelsPerMercatorPixel,e_=[el,el,eh];F.ad.vec3.scale(e_,e_,ep),F.ad.vec3.scale(ec,ec,-1),F.ad.vec3.multiply(ec,ec,e_);let eg=F.ad.mat4.create();F.ad.mat4.translate(eg,eg,ec),F.ad.mat4.scale(eg,eg,e_),this.mercatorFogMatrix=eg,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(el,eh,ep)}_computeCameraPosition(F){let el=(F=F||this.pixelsPerMeter)/this.pixelsPerMeter,eh=this._camera.forward(),ec=this.point,ep=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*el-F/this.worldSize*this._centerAltitude;return[ec.x/this.worldSize-eh[0]*ep,ec.y/this.worldSize-eh[1]*ep,F/this.worldSize*this._centerAltitude-eh[2]*ep]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(el){let eh=this._maxCameraBoundsDistance()*Math.cos(this._pitch),ec=this._camera.position[2],ep=el[2],e_=1;this.projection.wrap&&(this.center=this.center.wrap()),ep>0&&(e_=Math.min((eh-ec)/ep,1)),this._camera.position=F.ad.vec3.scaleAndAdd([],this._camera.position,el,e_),this._updateStateFromCamera()}_updateStateFromCamera(){let el=this._camera.position,eh=this._camera.forward(),{pitch:ec,bearing:ep}=this._camera.getPitchBearing(),e_=F.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,eg=this._mercatorZfromZoom(this._maxZoom)*Math.cos(F.ak(this._maxPitch)),ey=Math.max((el[2]-e_)/Math.cos(ec),eg),eb=this._zoomFromMercatorZ(ey);F.ad.vec3.scaleAndAdd(el,el,eh,ey),this._pitch=F.ay(ec,F.ak(this.minPitch),F.ak(this.maxPitch)),this.angle=F.bF(ep,-Math.PI,Math.PI),this._setZoom(F.ay(eb,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new F.ac(el[0],el[1],el[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(F){return Math.pow(2,F)*this.tileSize}_mercatorZfromZoom(F){return this.cameraToCenterDistance/this._worldSizeFromZoom(F)}_minimumHeightOverTerrain(){let F=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(F)}_zoomFromMercatorZ(F){return this.scaleZoom(this.cameraToCenterDistance/(F*this.tileSize))}zoomFromMercatorZAdjusted(el){let eh=0,ec=F.bY,ep=0,e_=1/0;for(;ec-eh>1e-6&&ec>eh;){let F=eh+.5*(ec-eh),eg=this.tileSize*Math.pow(2,F),ey=this.getCameraToCenterDistance(this.projection,F,eg),eb=this.scaleZoom(ey/(el*this.tileSize)),ew=Math.abs(F-eb);ew<e_&&(e_=ew,ep=F),F<eb?eh=F:ec=F}return ep}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(F.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(el,eh){let ec=Math.min(el.x,eh.x),ep=Math.max(el.x,eh.x),e_=Math.min(el.y,eh.y),eg=Math.max(el.y,eh.y);if(e_<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;let ey=[new F.P(ec,e_),new F.P(ep,eg),new F.P(ec,eg),new F.P(ep,e_)],eb=this.renderWorldCopies?-3:0,ew=this.renderWorldCopies?4:1;for(let F of ey){let el=this.pointRayIntersection(F);if(el.t<0)return!0;let eh=this.rayIntersectionCoordinate(el);if(eh.x<eb||eh.y<0||eh.x>ew||eh.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+F.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new F.P(0,0),new F.P(this.width,this.height))}zoomDeltaToMovement(el,eh){let ec=F.ad.vec3.length(F.ad.vec3.sub([],this._camera.position,el)),ep=this._zoomFromMercatorZ(ec)+eh;return ec-this._mercatorZfromZoom(ep)}getCameraPoint(){if("globe"===this.projection.name){let el=function([el,eh,ec],ep){let e_=[el,eh,ec,1];F.ad.vec4.transformMat4(e_,e_,ep);let eg=e_[3]=Math.max(e_[3],1e-6);return e_[0]/=eg,e_[1]/=eg,e_[2]/=eg,e_}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new F.P(el[0],el[1])}{let el=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new F.P(0,el))}}getCameraToCenterDistance(el,eh=this.zoom,ec=this.worldSize){let ep=F.b$(el,eh,this.width,this.height,1024),e_=el.pixelSpaceConversion(this.center.lat,ec,ep),eg=.5/Math.tan(.5*this._fov)*this.height*e_;return this.isOrthographic&&(eg=F.ah(1,eg,F.c9(this.pitch>=15?1:this.pitch/15))),eg}getWorldToCameraMatrix(){let el=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&F.ad.mat4.multiply(el,el,this.globeMatrix),el}getFrustum(el){return F.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,el,"meters"===this.projection.zAxisUnit)}};let Qi=(el,eh)=>{if(eh>0&&el.terrain&&F.w("Cutoff is currently disabled on terrain"),eh<=0||el.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};let ec=el.transform,ep=Math.max(Math.abs(ec._zoom-(el.minCutoffZoom-1)),1),e_=ec.isLODDisabled(!1)?F.ae(60,45,ec.pitch):F.ae(30,15,ec.pitch),eg=ec._farZ-ec._nearZ,ey=eh*ec.height,eb=((1-e_)*ec.cameraToCenterDistance+e_*(ec._farZ+ey))*ep;return{shouldRenderCutoff:e_<1,uniformValues:{u_cutoff_params:[ec._nearZ,ec._farZ,(eb-ec._nearZ)/eg,(eb-ey-ec._nearZ)/eg]}}},e6={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};let to=class to{constructor(F,el){this.aabb=F,this.lastCascade=el}};let io=class io{add(F,el){let eh=this.receivers[F.key];void 0!==eh?(eh.aabb.min[0]=Math.min(eh.aabb.min[0],el.min[0]),eh.aabb.min[1]=Math.min(eh.aabb.min[1],el.min[1]),eh.aabb.min[2]=Math.min(eh.aabb.min[2],el.min[2]),eh.aabb.max[0]=Math.max(eh.aabb.max[0],el.max[0]),eh.aabb.max[1]=Math.max(eh.aabb.max[1],el.max[1]),eh.aabb.max[2]=Math.max(eh.aabb.max[2],el.max[2])):this.receivers[F.key]=new to(el,null)}clear(){this.receivers={}}get(F){return this.receivers[F.key]}computeRequiredCascades(el,eh,ec){let ep=F.ce.fromPoints(el.points),e_=0;for(let el in this.receivers){let eg=this.receivers[el];if(!eg||!ep.intersectsAabb(eg.aabb))continue;eg.aabb.min=ep.closestPoint(eg.aabb.min),eg.aabb.max=ep.closestPoint(eg.aabb.max);let ey=eg.aabb.getCorners();for(let el=0;el<ec.length;el++){let ep=!0;for(let e_ of ey){let eg=[e_[0]*eh,e_[1]*eh,e_[2]];if(F.ad.vec3.transformMat4(eg,eg,ec[el].matrix),eg[0]<-1||eg[0]>1||eg[1]<-1||eg[1]>1){ep=!1;break}}if(eg.lastCascade=el,e_=Math.max(e_,el),ep)break}}return e_+1}};let oo=class oo{constructor(F){this.painter=F,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new io,this._depthMode=new Bi(F.context.gl.LEQUAL,Bi.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,F.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),F.tp.registerParameter(e6,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),F.tp.registerParameter(e6,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),F.tp.registerParameter(e6,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),F.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(let F of this._cascades)F.texture.destroy(),F.framebuffer.destroy();this._cascades=[]}updateShadowParameters(el,eh){let ec=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!eh||!eh.properties)return;let ep=eh.properties.get("shadow-intensity");if(!eh.shadowsEnabled()||ep<=0||(this._shadowLayerCount=ec.style.order.reduce((F,eh)=>{let ep=ec.style._mergedLayers[eh];return F+(ep.hasShadowPass()&&!ep.isHidden(el.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;let e_=ec.context,eg=e6.shadowMapResolution,ey=e6.shadowMapResolution;if(0===this._cascades.length||e6.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let el=0;el<e6.cascadeCount;++el){let el=ec._shadowMapDebug,eh=e_.gl,ep=e_.createFramebuffer(eg,ey,el,"texture"),eb=new F.T(e_,{width:eg,height:ey,data:null},eh.DEPTH_COMPONENT16);if(ep.depthAttachment.set(eb.texture),el){let el=new F.T(e_,{width:eg,height:ey,data:null},eh.RGBA8);ep.colorAttachment.set(el.texture)}this._cascades.push({framebuffer:ep,texture:eb,matrix:[],far:0,boundingSphereRadius:0,frustum:new F.bR,scale:0})}}this.shadowDirection=ro(eh);let eb=0;if(el.elevation){let F=el.elevation,eh=[1e4,-1e4];F.visibleDemTiles.filter(F=>F.dem).forEach(F=>{let el=F.dem.tree;eh[0]=Math.min(eh[0],el.minimums[0]),eh[1]=Math.max(eh[1],el.maximums[0])}),1e4!==eh[0]&&(eb=(eh[1]-eh[0])*F.exaggeration())}let ew=1.5*el.cameraToCenterDistance,eT=3*ew,eS=new Float64Array(16);for(let eh=0;eh<this._cascades.length;++eh){let ec=this._cascades[eh],ep=el.height/50,e_=1;1===e6.cascadeCount?e_=eT:0===eh?e_=ew:(ep=ew,e_=eT);let[eg,ey]=function(el,eh,ec,ep,e_,eg){let ey,eb;let ew=el.zoom,eT=el.scale,eS=el.worldSize,eE=1/eS,eM=el.aspect,eI=Math.sqrt(1+eM*eM)*Math.tan(.5*el.fovX),eA=eI*eI,eC=ep-ec,eP=ep+ec;eA>eC/eP?(ey=ep,eb=ep*eI):(ey=.5*eP*(1+eA),eb=.5*Math.sqrt(eC*eC+2*(ep*ep+ec*ec)*eA+eP*eP*eA*eA));let ez=el.projection.pixelsPerMeter(el.center.lat,eS),eD=el._camera.getCameraToWorldMercator(),eR=[0,0,-ey*eE];F.ad.vec3.transformMat4(eR,eR,eD);let eL=eb*eE,eO=el._edgeInsets;if(!(0===eO.left&&0===eO.top&&0===eO.right&&0===eO.bottom||eO.left===eO.right&&eO.top===eO.bottom)){let eh=el._camera.getWorldToCamera(el.worldSize,"meters"===el.projection.zAxisUnit?ez:1),e_=el._camera.getCameraToClipPerspective(el._fov,el.width/el.height,ec,ep);e_[8]=-(2*el.centerOffset.x)/el.width,e_[9]=2*el.centerOffset.y/el.height;let eg=new Float64Array(16);F.ad.mat4.mul(eg,e_,eh);let ey=new Float64Array(16);F.ad.mat4.invert(ey,eg);let eb=F.bR.fromInvProjectionMatrix(ey,eS,ew,!0);for(let eh of eb.points){let ec=(eh[0]/=eT,eh[1]/=eT,eh[2]=F.bH(eh[2],el._center.lat),eh);eL=Math.max(eL,F.ad.vec3.len(F.ad.vec3.subtract([],eR,ec)))}}eL*=e_/(e_-1);let ek=Math.acos(eh[2]),eF=Math.atan2(-eh[0],-eh[1]),eB=new $i;eB.position=eR,eB.setPitchBearing(ek,eF);let eN=eB.getWorldToCamera(eS,ez),eV=eL*eS,eU=Math.min(-(el._mercatorZfromZoom(17)*eS*2),-2*eV),ej=eB.getCameraToClipOrthographic(-eV,eV,-eV,eV,eU,(eV+eg*ez)/eh[2]),eG=new Float64Array(16);F.ad.mat4.multiply(eG,ej,eN);let eq=F.ad.vec3.fromValues(Math.floor(1e6*eR[0])/1e6*eS,Math.floor(1e6*eR[1])/1e6*eS,0),e$=.5*e_,eH=[0,0,0];F.ad.vec3.transformMat4(eH,eq,eG),F.ad.vec3.scale(eH,eH,e$);let eZ=[Math.floor(eH[0]),Math.floor(eH[1]),Math.floor(eH[2])],eW=[0,0,0];F.ad.vec3.sub(eW,eH,eZ),F.ad.vec3.scale(eW,eW,-1/e$);let eY=new Float64Array(16);return F.ad.mat4.identity(eY),F.ad.mat4.translate(eY,eY,eW),F.ad.mat4.multiply(eG,eY,eG),[eG,eV]}(el,this.shadowDirection,ep,e_,e6.shadowMapResolution,eb);ec.scale=el.scale,ec.matrix=eg,ec.boundingSphereRadius=ey,F.ad.mat4.invert(eS,ec.matrix),ec.frustum=F.bR.fromInvProjectionMatrix(eS,1,0,!0),ec.far=e_}let eE=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[eE].far,this._cascades[eE].far],this._uniformValues.u_shadow_intensity=ep,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/e6.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=e6.shadowMapResolution,this._uniformValues.u_shadowmap_0=e5.ShadowMap0,this._uniformValues.u_shadowmap_1=e5.ShadowMap0+1,this._groundShadowTiles=ec.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});let eM=ec.transform.elevation;for(let F of this._groundShadowTiles){let el={min:0,max:0};if(eM){let eh=eM.getMinMaxForTile(F);eh&&(el=eh)}this.addShadowReceiver(F.toUnwrapped(),el.min,el.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(F){this._enabled=F}drawShadowPass(el,eh){if(!this.enabled)return;let ec=this.painter,ep=ec.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(ec.transform.getFrustum(0),ec.transform.worldSize,this._cascades),ep.viewport.set([0,0,e6.shadowMapResolution,e6.shadowMapResolution]);for(let e_=0;e_<this._numCascadesToRender;++e_)for(let eg of(ec.currentShadowCascade=e_,ep.bindFramebuffer.set(this._cascades[e_].framebuffer.framebuffer),ep.clear({color:F.al.white,depth:1}),el.order)){let F=el._mergedLayers[eg];if(!F.hasShadowPass()||F.isHidden(ec.transform.zoom))continue;let ep=el.getLayerSourceCache(F),e_=ep?eh[ep.id]:void 0;("model"===F.type||e_&&e_.length)&&ec.renderLayer(ec,ep,F,e_)}ec.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;let F=this.painter,el=F.style,eh=F.context,ec=el.directionalLight,ep=el.ambientLight;if(!ec||!ep)return;let e_=[],eg=Qi(F,F.longestCutoffRange);eg.shouldRenderCutoff&&e_.push("RENDER_CUTOFF"),e_.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&e_.push("NORMAL_OFFSET");let ey=no(el,ec,ep),eb=new Bi(eh.gl.LEQUAL,Bi.ReadOnly,F.depthRangeFor3D);for(let el of this._groundShadowTiles){let ec=el.toUnwrapped(),ep=F.isTileAffectedByFog(el),ew=F.getOrCreateProgram("groundShadow",{defines:e_,overrideFog:ep});this.setupShadows(ec,ew),F.uploadCommonUniforms(eh,ew,ec,null,eg);let eT={u_matrix:F.transform.calculateProjMatrix(ec),u_ground_shadow_factor:ey};ew.draw(F,eh.gl.TRIANGLES,eb,Ui.disabled,ki.multiply,ji.disabled,eT,"ground_shadow",F.tileExtentBuffer,F.quadTriangleIndexBuffer,F.tileExtentSegments,null,F.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ki.unblended:ki.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(el){let eh=this.painter.transform,ec=eh.calculatePosMatrix(el,eh.worldSize);return F.ad.mat4.multiply(ec,this._cascades[this.painter.currentShadowCascade].matrix,ec),Float32Array.from(ec)}calculateShadowPassMatrixFromMatrix(el){return F.ad.mat4.multiply(el,this._cascades[this.painter.currentShadowCascade].matrix,el),Float32Array.from(el)}setupShadows(el,eh,ec,ep=0){if(!this.enabled)return;let e_=this.painter.transform,eg=this.painter.context,ey=eg.gl,eb=this._uniformValues,ew=new Float64Array(16),eT=e_.calculatePosMatrix(el,e_.worldSize);for(let el=0;el<this._cascades.length;el++)F.ad.mat4.multiply(ew,this._cascades[el].matrix,eT),eb[0===el?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(ew),eg.activeTexture.set(ey.TEXTURE0+e5.ShadowMap0+el),this._cascades[el].texture.bind(ey.NEAREST,ey.CLAMP_TO_EDGE);if(this.useNormalOffset=!!ec,this.useNormalOffset){let eh=F.cd(el.canonical),eg=2/e_.tileSize*F.ai/e6.shadowMapResolution,ey=eg*this._cascades[0].boundingSphereRadius,ew=eg*this._cascades[this._cascades.length-1].boundingSphereRadius,eT=("vector-tile"===ec?1:3)/Math.pow(2,ep-el.canonical.z-(1-e_.zoom+Math.floor(e_.zoom)));eb.u_shadow_normal_offset=[eh,ey*eT,ew*eT],eb.u_shadow_bias=[6e-5,.0012,.012]}else eb.u_shadow_bias=[36e-5,.0012,.012];eh.setShadowUniformValues(eg,eb)}setupShadowsFromMatrix(el,eh,ec=!1){if(!this.enabled)return;let ep=this.painter.context,e_=ep.gl,eg=this._uniformValues,ey=new Float64Array(16);for(let eh=0;eh<e6.cascadeCount;eh++)F.ad.mat4.multiply(ey,this._cascades[eh].matrix,el),eg[0===eh?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(ey),ep.activeTexture.set(e_.TEXTURE0+e5.ShadowMap0+eh),this._cascades[eh].texture.bind(e_.NEAREST,e_.CLAMP_TO_EDGE);if(this.useNormalOffset=ec,ec){let F=e6.normalOffset;eg.u_shadow_normal_offset=[1,F,F],eg.u_shadow_bias=[6e-5,.0012,.012]}else eg.u_shadow_bias=[36e-5,.0012,.012];eh.setShadowUniformValues(ep,eg)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(el,eh,ec,ep){if(ep[2]>=0)return{};let e_=(function(el,eh,ec){let ep=ec/(1<<el.canonical.z);return new F.ce([el.canonical.x*ep+el.wrap*ec,el.canonical.y*ep+el.wrap*ec,0],[(el.canonical.x+1)*ep+el.wrap*ec,(el.canonical.y+1)*ep+el.wrap*ec,eh])})(el,eh,ec).getCorners(),eg=-(eh/ep[2]);ep[0]<0?(F.ad.vec3.add(e_[0],e_[0],[ep[0]*eg,0,0]),F.ad.vec3.add(e_[3],e_[3],[ep[0]*eg,0,0])):ep[0]>0&&(F.ad.vec3.add(e_[1],e_[1],[ep[0]*eg,0,0]),F.ad.vec3.add(e_[2],e_[2],[ep[0]*eg,0,0])),ep[1]<0?(F.ad.vec3.add(e_[0],e_[0],[0,ep[1]*eg,0]),F.ad.vec3.add(e_[1],e_[1],[0,ep[1]*eg,0])):ep[1]>0&&(F.ad.vec3.add(e_[2],e_[2],[0,ep[1]*eg,0]),F.ad.vec3.add(e_[3],e_[3],[0,ep[1]*eg,0]));let ey={};return ey.vertices=e_,ey.planes=[so(e_[1],e_[0],e_[4]),so(e_[2],e_[1],e_[5]),so(e_[3],e_[2],e_[6]),so(e_[0],e_[3],e_[7])],ey}addShadowReceiver(el,eh,ec){this._receivers.add(el,F.ce.fromTileIdAndHeight(el,eh,ec))}getMaxCascadeForTile(F){let el=this._receivers.get(F);return el&&el.lastCascade?el.lastCascade:0}};function so(el,eh,ec){let ep=F.ad.vec3.sub([],ec,eh),e_=F.ad.vec3.sub([],el,eh),eg=F.ad.vec3.cross([],ep,e_),ey=F.ad.vec3.length(eg);return 0===ey?[0,0,1,0]:(F.ad.vec3.scale(eg,eg,1/ey),[eg[0],eg[1],eg[2],-F.ad.vec3.dot(eg,eh)])}function ro(el){let eh=el.properties.get("direction"),ec=F.cc(eh.x,eh.y,eh.z);ec[2]=F.ay(ec[2],0,75);let ep=F.cf([ec[0],ec[1],ec[2]]);return F.ad.vec3.fromValues(ep.x,ep.y,ep.z)}function no(el,eh,ec){let ep="none"===eh.properties.get("color-use-theme"),e_=eh.properties.get("color"),eg=eh.properties.get("intensity"),ey=eh.properties.get("direction"),eb=[ey.x,ey.y,ey.z],ew="none"===ec.properties.get("color-use-theme"),eT=ec.properties.get("color"),eS=ec.properties.get("intensity"),eE=Math.max(F.ad.vec3.dot([0,0,1],eb),0),eM=[0,0,0];F.ad.vec3.scale(eM,eT.toRenderColor(ew?null:el.getLut(eh.scope)).toArray01Linear().slice(0,3),eS);let eI=[0,0,0];return F.ad.vec3.scale(eI,e_.toRenderColor(ep?null:el.getLut(ec.scope)).toArray01Linear().slice(0,3),eE*eg),F.cg([eM[0]>0?eM[0]/(eM[0]+eI[0]):0,eM[1]>0?eM[1]/(eM[1]+eI[1]):0,eM[2]>0?eM[2]/(eM[2]+eI[2]):0])}let lo=class lo extends F.E{constructor(F){super(),this.requestManager=F,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(el,eh){return F.aN(this.requestManager.transformRequest(eh,F.R.Model).url).then(eh=>{if(!eh)return;let ec=F.aO(eh),ep=new F.aP(el,void 0,void 0,ec);return ep.computeBoundsAndApplyParent(),ep}).catch(ec=>{if(ec&&404===ec.status)return null;this.fire(new F.z(Error(`Could not load model ${el} from ${eh}: ${ec.message}`)))})}load(el,eh,ec={keepNumReferences:!1}){this.models[eh]||(this.models[eh]={});let ep=Object.keys(el);this.numModelsLoading[eh]=(this.numModelsLoading[eh]||0)+ep.length;let e_=[];for(let F of ep)e_.push(this.loadModel(F,el[F]));Promise.allSettled(e_).then(el=>{for(let F=0;F<el.length;F++){let{status:e_,value:eg}=el[F];if("fulfilled"===e_&&eg){let el=this.models[eh][ep[F]];this.models[eh][ep[F]]={model:eg,numReferences:ec.keepNumReferences&&el?el.numReferences:1}}}this.numModelsLoading[eh]-=ep.length,this.fire(new F.A("data",{dataType:"style"}))}).catch(el=>{this.fire(new F.z(Error(`Could not load models: ${el.message}`)))})}isLoaded(){for(let F in this.numModelsLoading)if(this.numModelsLoading[F]>0)return!1;return!0}hasModel(F,el){return!!this.getModel(F,el)}getModel(F,el){return this.models[el]||(this.models[el]={}),this.models[el][F]?this.models[el][F].model:void 0}addModel(F,el,eh){this.models[eh]||(this.models[eh]={}),this.modelUris[eh]||(this.modelUris[eh]={}),this.hasModel(F,eh)&&this.models[eh][F].numReferences++,this.modelUris[eh][F]=this.requestManager.normalizeModelURL(el),this.load({[F]:this.modelUris[eh][F]},eh)}addModels(F,el){this.models[el]||(this.models[el]={}),this.modelUris[el]||(this.modelUris[el]={});let eh=this.modelUris[el];for(let ec in F)this.models[el][ec]={},eh[ec]=this.requestManager.normalizeModelURL(F[ec]);this.load(eh,el,{keepNumReferences:!0})}reloadModels(F){this.load(this.modelUris[F],F)}addModelsFromBucket(F,el){this.models[el]||(this.models[el]={}),this.modelUris[el]||(this.modelUris[el]={});let eh={};for(let ec of F)this.hasModel(ec,el)?this.models[el][ec].numReferences++:(this.modelUris[el][ec]=this.requestManager.normalizeModelURL(ec),eh[ec]=this.modelUris[el][ec]);this.load(eh,el)}removeModel(F,el){if(this.models[el]&&this.models[el][F]&&(this.models[el][F].numReferences--,0===this.models[el][F].numReferences)){let eh=this.models[el][F].model;delete this.models[el][F],delete this.modelUris[el][F],eh.destroy()}}listModels(F){return this.models[F]||(this.models[F]={}),Object.keys(this.models[F])}upload(F,el){for(let eh in this.models[el]||(this.models[el]={}),this.models[el])this.models[el][eh].model&&this.models[el][eh].model.upload(F.context)}};let e8=new F.a7({data:new F.a8(F.a5.colorTheme.data)}),e9={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function uo(F){return Object.assign(F=F||{},e9)}let _o=class _o extends F.E{constructor(el){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},F.aQ(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=el,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(el=>{el.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new F.z(Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=el.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=el.stylesheet.indoor.buildingFeaturesetId,this._scope=el.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:F=>(F.feature&&F.feature.properties.floorplan&&this.selectFloorplan(F.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(el){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(F,el){let[eh,ec]=F,{center:ep,radius:e_}=el,[eg,ey]=ep,eb=Math.abs(eh-eg);return Math.sqrt((eb>180?360-eb:eb)**2+(ec-ey)**2)<=e_}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new F.A("floorplangone")));let eh={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},ec=new F.P(this._map.transform.width/2,this._map.transform.height/2),ep=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],e_=this._map.queryRenderedFeatures(el?ep:ec,eh);e_.length>0&&(this._selectedFloorplan&&e_[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=e_[0],this._floorplanSelected(!1)))}_floorplanSelected(el){let eh;this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(F){let[[el,eh],[ec,ep]]=F,e_=(ec-el+360)%360,eg=e_>180?360-e_:e_;return{center:[(el+eg/2+360)%360,(eh+ep)/2],radius:Math.sqrt(eg**2+(ep-eh)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});let ec=this._floorplanStates[this._indoorData.id].selectedBuilding,ep=this._floorplanStates[this._indoorData.id].selectedLevel;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(let F of this._indoorData.levels)F.id===this._selectedLevel.id&&(eh=F.id);if(this.fire(new F.A("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:eh})),ec){let F=this._indoorData.buildings.find(F=>F.id===ec);this._buildingSelected(F,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(ep){let F=this._indoorData.levels.find(F=>F.id===ep);this._updateLevels(F,el)}else el&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(el,eh){eh&&el&&el.extent&&this._map.fitBounds(el.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=el?el.id:void 0;let ec=this._indoorData.levels.filter(F=>el.levels.includes(F.id));this.fire(new F.A("buildingselected",{buildingId:el.id,levels:ec}))}_levelSelected(el){if("overview"===el)this._updateLevels(void 0,!0);else{let F=this._indoorData.levels.find(F=>F.id===el);this._updateLevels(F,!0)}this.fire(new F.A("levelselected",{levelId:"overview"===el?void 0:el}))}_updateLevels(F,el){if(!F)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(el&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function i(F){let el=F.indexOf("/floor/");if(-1===el)return F;let eh=el+7,ec=F.indexOf("/",eh);return -1===ec?F.slice(eh):F.slice(eh,ec)}this._selectedLevel=F,this._floorplanStates[this._indoorData.id].selectedLevel=F?F.id:void 0;let eh=[],ec={},ep={},e_={},eg={};for(let el of this._indoorData.levels)if(eh.push(el.id),ec[el.id]=el.height,ep[el.id]=el.base,F){if(this.mergeFloors){let eh=i(F.id),ec=i(el.id);e_[el.id]=ec===eh?"true":"false"}else e_[el.id]=el.id===F.id?"true":"false";eg[el.id]=el.base<F.base?"true":"false"}else eg[el.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",eh]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",ec]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",ep]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",e_]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",eg]),F&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!F.isUnderground),el&&F.extent)){let el=this._map.cameraForBounds(F.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),eh=this._map.getZoom(),ec=el.zoom?Math.abs(eh-el.zoom):0;this._map.fitBounds(F.extent,ec>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:eh})}}selectFloorplan(el){let eh={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},ec=[new F.P(0,0),new F.P(this._map.transform.width,this._map.transform.height)],ep=this._map.queryRenderedFeatures(ec,eh);if(ep.length>0){for(let F of ep)if(JSON.parse(F.properties["indoor-data"]).floorplanIDs.includes(el)){this._selectedFloorplan=F,this._floorplanSelected(!0);break}}}selectBuilding(F){let el=this._indoorData.buildings.find(el=>el.id===F);this._buildingSelected(el,!0)}selectLevel(F){this._levelSelected(F)}};function fo(el){if(el)return el.map(([el,eh])=>[el*F.q.devicePixelRatio,eh*F.q.devicePixelRatio])}let mo=class mo{constructor(F,el){this.id=F,this.style=el}addIcons(el){let eh=new Map;for(let[ec,ep]of el.entries()){let el=F.I.from({name:ec,iconsetId:this.id});eh.set(el,ep)}this.style.addImages(eh)}};let go=(F,el)=>Ae(F,el&&el.filter(F=>"source.canvas"!==F.identifier)),e7=F.aA(e0,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),tn=F.aA(e0,["setCenter","setZoom","setBearing","setPitch"]),th=new Set(["background","sky","slot","custom"]),tc={version:8,layers:[],sources:{}},t_={duration:300,delay:0};let To=class To extends F.E{constructor(el,eh={}){super(),this.map=el,this.scope=eh.scope||"",this.globalId=null,this.fragments=[],this.importDepth=eh.importDepth||0,this.importsCache=eh.importsCache||new Map,this.resolvedImports=eh.resolvedImports||new Set,this.transition=F.l({},t_),this._buildingIndex=new Dt(this),this.crossTileSymbolIndex=new Oi,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=eh.styleChanges||new G,this.dispatcher=eh.dispatcher?eh.dispatcher:new F.D(F.cj(),this),eh.imageManager?this.imageManager=eh.imageManager:(this.imageManager=new q(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=eh.glyphManager?eh.glyphManager:new F.ck(el._requestManager,eh.localFontFamily?F.cl.all:eh.localIdeographFontFamily?F.cl.ideographs:F.cl.none,eh.localFontFamily||eh.localIdeographFontFamily),eh.modelManager?this.modelManager=eh.modelManager:(this.modelManager=new lo(el._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=eh.configOptions?eh.configOptions:new Map,this._configDependentLayers=eh.configDependentLayers?eh.configDependentLayers:new Set,this._config=eh.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:eh.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=eh.initialConfig,this.dispatcher.broadcast("setReferrer",F.cm());let ec=this;this._rtlTextPluginCallback=To.registerForPluginStateChange(el=>{ec.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:el.pluginStatus,pluginURL:el.pluginURL},(el,eh)=>{if(F.cn(el),eh&&eh.every(F=>F))for(let F in ec._sourceCaches){let el=ec._sourceCaches[F],eh=el.getSource().type;"vector"!==eh&&"geojson"!==eh||el.reload()}})}),this.on("data",F=>{if("source"!==F.dataType||"metadata"!==F.sourceDataType)return;let el=this.getOwnSource(F.sourceId);if(el&&el.vectorLayerIds)for(let F in this._layers){let eh=this._layers[F];eh.source===el.id&&this._validateLayer(eh)}})}load(F){return F&&("string"==typeof F?this.loadURL(F):this.loadJSON(F)),this}_getGlobalId(el){if(!el)return null;if("string"==typeof el){if(F.f(el))return el;let eh=F.co(el);if(!eh.startsWith("http"))try{return new URL(eh,location.href).toString()}catch(F){}return eh}return`json://${F.cp(JSON.stringify(el))}`}_diffStyle(el,eh,ec){this.globalId=this._getGlobalId(el);let s=(F,el)=>{try{el(null,this.setState(F,ec))}catch(F){el(F,!1)}};if("string"==typeof el){let ec=this.map._requestManager.normalizeStyleURL(el),ep=this.map._requestManager.transformRequest(ec,F.R.Style);F.n(ep,(el,ec)=>{el?this.fire(new F.z(el)):ec&&s(ec,eh)})}else"object"==typeof el&&s(el,eh)}loadURL(el,eh={}){this.fire(new F.A("dataloading",{dataType:"style"}));let ec="boolean"==typeof eh.validate?eh.validate:!F.f(el);this.globalId=this._getGlobalId(el),el=this.map._requestManager.normalizeStyleURL(el,eh.accessToken),this.resolvedImports.add(el);let ep=this.importsCache.get(el);if(ep)return this._load(ep,ec);let e_=this.map._requestManager.transformRequest(el,F.R.Style);this._request=F.n(e_,(eh,ep)=>{if(this._request=null,eh)this.fire(new F.z(eh));else if(ep)return this.importsCache.set(el,ep),this._load(ep,ec)})}loadJSON(el,eh={}){this.fire(new F.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(el),this._request=F.q.frame(()=>{this._request=null,this._load(el,!1!==eh.validate)})}loadEmpty(){this.fire(new F.A("dataloading",{dataType:"style"})),this._load(tc,!1)}_loadImports(el,eh,ec){if(this.importDepth>=4)return F.w("Style doesn't support nesting deeper than 5"),Promise.resolve();let ep=[];for(let F of el){let el=this._createFragmentStyle(F),e_=new Promise(F=>{el.once("style.import.load",F),el.once("error",F)}).then(()=>this.mergeAll());if(ep.push(e_),this.resolvedImports.has(F.url)){el.loadEmpty();continue}let eg=F.data||this.importsCache.get(F.url);eg?(el.loadJSON(eg,{validate:eh}),this._isInternalStyle(eg)&&(el.globalId=null)):F.url?el.loadURL(F.url,{validate:eh}):el.loadEmpty();let ey={style:el,id:F.id,config:F.config};if(ec){let F=this.fragments.findIndex(({id:F})=>F===ec);this.fragments=this.fragments.slice(0,F).concat(ey).concat(this.fragments.slice(F))}else this.fragments.push(ey)}return Promise.allSettled(ep)}getImportGlobalIds(F=this,el=new Set){for(let eh of F.fragments)eh.style.globalId&&el.add(eh.style.globalId),this.getImportGlobalIds(eh.style,el);return[...el.values()]}_createFragmentStyle(el){let eh;let ec=this.scope?F.C(el.id,this.scope):el.id,ep=this._initialConfig&&this._initialConfig[ec];(el.config||ep)&&(eh=F.l({},el.config,ep));let e_=new To(this.map,{scope:ec,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:eh,configOptions:this.options,colorThemeOverride:el["color-theme"],configDependentLayers:this._configDependentLayers});return e_.setEventedParent(this.map,{style:e_}),e_}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(F){return this.isRootStyle()&&(F.fragment||!!F.schema&&!1!==F.fragment)}_load(el,eh){let ec=el.indoor?uo(el.schema):el.schema;if(this._isInternalStyle(el)){let ec=F.l({},tc,{imports:[{id:"basemap",data:el,url:""}]});return void this._load(ec,eh)}if(this.updateConfig(this._config,ec),eh&&go(this,me(el)))return;this._loaded=!0,this.stylesheet=F.cq(el);let s=()=>{for(let F in el.sources)this.addSource(F,el.sources[F],{validate:!1,isInitialLoad:!0});if(el.iconsets)for(let F in el.iconsets)this.addIconset(F,el.iconsets[F]);el.sprite?this._loadIconset(el.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.setGlyphsUrl(el.glyphs);let ec=Lt(this.stylesheet.layers);if(this._order=ec.map(F=>F.id),this.stylesheet.light&&F.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights){if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){let F=this.stylesheet.lights[0];this.light=new Me(F.properties,F.id)}else this.setLights(this.stylesheet.lights)}for(let el of(this.light||(this.light=new Me(this.stylesheet.light)),this._layers={},ec)){let eh=F.cv(el,this.scope,this._styleColorTheme.lut,this.options);0!==eh.configDependencies.size&&this._configDependentLayers.add(eh.fqid),eh.setEventedParent(this,{layer:{id:eh.id}}),this._layers[eh.id]=eh;let ec=this.getOwnLayerSourceCache(eh),ep=!!this.directionalLight&&this.directionalLight.shadowsEnabled();ec&&eh.canCastShadows()&&ep&&(ec.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);let ep=this.stylesheet.terrain;ep&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(ep,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new F.A("data",{dataType:"style"}));let e_=this.isRootStyle();el.imports?this._loadImports(el.imports,eh).then(()=>{this._reloadImports(),this.fire(new F.A(e_?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new F.A(e_?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];let ep=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(ep){let el=this._evaluateColorThemeData(ep);this._loadColorTheme(el).then(()=>{s()}).catch(el=>{F.w(`Couldn't load color theme from the stylesheet: ${el}`),s()})}else this._styleColorTheme.lut=null,s()}isRootStyle(){return 0===this.importDepth}mergeAll(){let el,eh,ec,ep,e_,eg,ey,eb,ew,eT;let eS={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(F=>{if(F.stylesheet){if(null!=F.light&&(el=F.light),F.stylesheet.lights)for(let el of F.stylesheet.lights)"ambient"===el.type&&null!=F.ambientLight&&(eh=F.ambientLight),"directional"===el.type&&null!=F.directionalLight&&(ec=F.directionalLight);ep=this._prioritizeTerrain(ep,F.terrain,F.stylesheet.terrain),F.stylesheet.fog&&null!=F.fog&&(e_=F.fog),F.stylesheet.snow&&null!=F.snow&&(eg=F.snow),F.stylesheet.rain&&null!=F.rain&&(ey=F.rain),null!=F.stylesheet.camera&&(eT=F.stylesheet.camera),null!=F.stylesheet.projection&&(eb=F.stylesheet.projection),null!=F.stylesheet.transition&&(ew=F.stylesheet.transition),eS[F.scope]=F._styleColorTheme}}),this.light=el,this.ambientLight=eh,this.directionalLight=ec,this.fog=e_,this.snow=eg,this.rain=ey,this._styleColorThemeForScope=eS,null===ep?delete this.terrain:this.terrain=ep,this.camera=eT||{"camera-projection":"perspective"},this.projection=eb||{name:"mercator"},this.transition=F.l({},t_,ew),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(F){let t=el=>{for(let F of el.fragments)t(F.style);F(el)};t(this)}_prioritizeTerrain(F,el,eh){let ec=F&&0===F.drapeRenderMode;return null===eh?el&&0===el.drapeRenderMode?el:ec?F:null:null!=el&&(!F||ec||el&&1===el.drapeRenderMode)?el:F}mergeTerrain(){let F;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(el=>{F=this._prioritizeTerrain(F,el.terrain,el.stylesheet.terrain)}),null===F?delete this.terrain:this.terrain=F}mergeProjection(){let F;this.forEachFragmentStyle(el=>{null!=el.stylesheet.projection&&(F=el.stylesheet.projection)}),this.projection=F||{name:"mercator"}}mergeSources(){let el={},eh={},ec={};this.forEachFragmentStyle(ep=>{for(let eh in ep._sourceCaches){let ec=F.C(eh,ep.scope);el[ec]=ep._sourceCaches[eh]}for(let el in ep._otherSourceCaches){let ec=F.C(el,ep.scope);eh[ec]=ep._otherSourceCaches[el]}for(let el in ep._symbolSourceCaches){let eh=F.C(el,ep.scope);ec[eh]=ep._symbolSourceCaches[el]}}),this._mergedSourceCaches=el,this._mergedOtherSourceCaches=eh,this._mergedSymbolSourceCaches=ec}mergeLayers(){let el={},eh=[],ec={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(ec=>{for(let ep of ec._order){let e_=ec._layers[ep];if("slot"===e_.type){let eh=F.cr(ep);if(el[eh])continue;el[eh]=[]}e_.slot&&el[e_.slot]?el[e_.slot].push(e_):eh.push(e_)}}),this._mergedOrder=[];let s=(eh=[])=>{for(let ep of eh)if("slot"===ep.type){let eh=F.cr(ep.id);el[eh]&&s(el[eh]),this._mergedSlots.push(eh)}else{let el=F.C(ep.id,ep.scope);this._mergedOrder.push(el),ec[el]=ep,ep.is3D(!!this.terrain)&&(this._has3DLayers=!0),"circle"===ep.type&&(this._hasCircleLayers=!0),"symbol"===ep.type&&(this._hasSymbolLayers=!0),"clip"===ep.type&&(this._clipLayerPresent=!0)}};s(eh),this._mergedOrder.sort((F,el)=>{let eh=ec[F],ep=ec[el];return eh.hasInitialOcclusionOpacityProperties?ep.is3D(!!this.terrain)?1:0:eh.is3D(!!this.terrain)&&ep.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=ec,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(el){return this.stylesheet.camera=F.l({},this.stylesheet.camera,el),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(el){return el.data?(function(el,eh,ec){let ep=F.l({},eh);for(let el of Object.keys(F.a5.colorTheme))void 0===ep[el]&&(ep[el]=F.a5.colorTheme[el].default);let e_=new F.a6(e8,el,new Map(ec));return e_.setTransitionOrValue(ep,ec),e_.untransitioned().possiblyEvaluate(new F.aa(0))})(this.scope,el,this.options).get("data"):null}_loadColorTheme(el){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;let eh=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((ec,ep)=>{let e_="data:image/png;base64,";if(!el||0===el.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void ec();let eg=el;eg.startsWith(e_)||(eg=e_+eg);let ey=F.I.from("mapbox-reserved-lut"),eb=new Image;eb.src=eg,eb.onerror=()=>{this._styleColorTheme.lutLoading=!1,ep(Error("Failed to load image data"))},eb.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==eh)return void ec();this._styleColorTheme.lutLoading=!1;let{width:e_,height:eg,data:ew}=F.q.getImageData(eb);if(eg>32)return void ep(Error("The height of the image must be less than or equal to 32 pixels."));if(e_!==eg*eg)return void ep(Error("The width of the image must be equal to the height squared."));this.getImage(ey)&&this.removeImage(ey),this.addImage(ey,{data:new F.r({width:e_,height:eg},ew),pixelRatio:1,sdf:!1,usvg:!1,version:0});let eT=this.imageManager.getImage(ey,this.scope);eT?(this._styleColorTheme.lut={image:eT.data,data:el},ec()):ep(Error("Missing LUT image."))}})}getLut(F){let el=this._styleColorThemeForScope[F];return el?el.lut:null}setProjection(F){F?this.stylesheet.projection=F:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(el){this._spriteRequest=function(el,eh,ec){let ep,e_,eg;let ey=F.q.devicePixelRatio>1?"@2x":"",eb=F.n(eh.transformRequest(eh.normalizeSpriteURL(el,ey,".json"),F.R.SpriteJSON),(F,el)=>{eb=null,eg||(eg=F,ep=el,h())}),ew=F.o(eh.transformRequest(eh.normalizeSpriteURL(el,ey,".png"),F.R.SpriteImage),(F,el)=>{ew=null,eg||(eg=F,e_=el,h())});function h(){if(eg)ec(eg);else if(ep&&e_){let el=F.q.getImageData(e_),eh={};for(let ec in ep){let{width:e_,height:eg,x:ey,y:eb,sdf:ew,pixelRatio:eT,stretchX:eS,stretchY:eE,content:eM}=ep[ec],eI=new F.r({width:e_,height:eg});F.r.copy(el,eI,{x:ey,y:eb},{x:0,y:0},{width:e_,height:eg},null),eh[ec]={data:eI,pixelRatio:eT,sdf:ew,stretchX:eS,stretchY:eE,content:eM,usvg:!1}}ec(null,eh)}}return{cancel(){eb&&(eb.cancel(),eb=null),ew&&(ew.cancel(),ew=null)}}}(el,this.map._requestManager,(el,eh)=>{if(this._spriteRequest=null,el)this.fire(new F.z(el));else if(eh){let el=new Map;for(let ec in eh)el.set(F.I.from(ec),eh[ec]);this.addImages(el)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.A("data",{dataType:"style"}))})}addIconset(el,eh){if("sprite"===eh.type)return void this._loadSprite(eh.url);let ec=this.getOwnSource(eh.source);if(!ec)return void this.fire(new F.z(Error(`Source "${eh.source}" as specified by iconset "${el}" does not exist and cannot be used as an iconset source`)));if("raster-array"!==ec.type)return void this.fire(new F.z(Error(`Source "${eh.source}" as specified by iconset "${el}" is not a "raster-array" source and cannot be used as an iconset source`)));this.imageManager.createIconset(this.scope,el);let ep=new mo(el,this);ec.addIconset(el,ep)}_loadIconset(el){var eh,ec;if(!F.f(el)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(el);let ep="auto"===this.map._spriteFormat;this._spriteRequest=(ec=(eh,ec)=>{if(this._spriteRequest=null,eh)ep?this._loadSprite(el):this.fire(new F.z(eh));else if(ec){let el=new Map;for(let eh in ec)el.set(F.I.from(eh),ec[eh]);this.addImages(el)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new F.A("data",{dataType:"style"}))},F.bj((eh=this.map._requestManager).transformRequest(eh.normalizeIconsetURL(el),F.R.Iconset),(el,eh)=>{if(el)return void ec(el);let ep={},e_=F.ch(new F.bi(eh));for(let el of e_.icons){let eh={version:1,pixelRatio:F.q.devicePixelRatio,content:function(el){if(!el.metadata||!el.metadata.content_area)return;let eh=F.q.devicePixelRatio,{left:ec,top:ep,width:e_,height:eg}=el.metadata.content_area,ey=ec*eh,eb=ep*eh;return[ey,eb,ey+e_*eh,eb+eg*eh]}(el),stretchX:el.metadata?fo(el.metadata.stretch_x_areas):void 0,stretchY:el.metadata?fo(el.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:el};ep[el.name]=eh}ec(null,ep)}))}_validateLayer(el){let eh=this.getOwnSource(el.source);if(!eh)return;let ec=el.sourceLayer;ec&&("geojson"===eh.type||eh.vectorLayerIds&&-1===eh.vectorLayerIds.indexOf(ec))&&this.fire(new F.z(Error(`Source layer "${ec}" does not exist on source "${eh.id}" as specified by style layer "${el.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(let F in this._sourceCaches)if(!this._sourceCaches[F].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(let{style:F}of this.fragments)if(!F.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((F,el)=>{let eh=this.fragments[el];return eh&&eh.style&&(F.data=eh.style.serialize()),F})}_serializeSources(){let F={};for(let el in this._sourceCaches){let eh=this._sourceCaches[el].getSource();F[eh.id]||(F[eh.id]=eh.serialize())}return F}_serializeLayers(F){let el=[];for(let eh of F){let F=this._layers[eh];F&&"custom"!==F.type&&el.push(F.serialize())}return el}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(let F in this._sourceCaches)if(this._sourceCaches[F].hasTransition())return!0;for(let F in this._layers)if(this._layers[F].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(F){return F?this.order:this._mergedOrder}isLayerDraped(F){return!!this.terrain&&F.isDraped(this.getLayerSourceCache(F))}_checkLoaded(){if(!this._loaded)throw Error("Style is not done loading")}_checkLayer(el){let eh=this.getOwnLayer(el);if(eh)return eh;this.fire(new F.z(Error(`The layer '${el}' does not exist in the map's style.`)))}_checkSource(el){let eh=this.getOwnSource(el);if(eh)return eh;this.fire(new F.z(Error(`The source '${el}' does not exist in the map's style.`)))}precompilePrograms(F,el){let eh=this.map.painter;if(eh)for(let ec=F.minzoom||0;ec<(F.maxzoom||25.5);ec++){let ec=F.getProgramIds();if(ec)for(let ep of ec){let ec=F.getDefaultProgramParams(ep,el.zoom,this._styleColorTheme.lut);ec&&(eh.style=this,this.fog&&(eh._fogVisible=!0,ec.overrideFog=!0,eh.getOrCreateProgram(ep,ec)),eh._fogVisible=!1,ec.overrideFog=!1,eh.getOrCreateProgram(ep,ec),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(ec.overrideRtt=!0,eh.getOrCreateProgram(ep,ec)))}}}update(el){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(el),this.directionalLight&&this.directionalLight.recalculate(el);let eh=this.calculateLightsBrightness();el.brightness=eh||0,eh!==this._brightness&&(this._brightness=eh,this.dispatcher.broadcast("setBrightness",eh));let ec=this._changes.isDirty(),ep=!1;if(this._changes.isDirty()){let F=this._changes.getLayerUpdatesByScope();for(let el in F){let{updatedIds:eh,removedIds:ec}=F[el];(eh||ec)&&(this._updateWorkerLayers(el,eh,ec),ep=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(el),this.light&&this.light.updateTransitions(el),this.ambientLight&&this.ambientLight.updateTransitions(el),this.directionalLight&&this.directionalLight.updateTransitions(el),this.fog&&this.fog.updateTransitions(el),this.snow&&this.snow.updateTransitions(el),this.rain&&this.rain.updateTransitions(el),this._changes.reset()}let e_={};for(let F in this._mergedSourceCaches){let el=this._mergedSourceCaches[F];e_[F]=el.used,el.used=!1,el.tileCoverLift=0}for(let F of this._mergedOrder){let eh=this._mergedLayers[F];if(eh.recalculate(el,this._availableImages),!eh.isHidden(el.zoom)){let F=this.getLayerSourceCache(eh);F&&(F.used=!0,F.tileCoverLift=Math.max(F.tileCoverLift,eh.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(eh,el)}):this.precompilePrograms(eh,el))}for(let F in this._mergedSourceCaches){let el=this._mergedSourceCaches[F];if(!el)continue;let eh=el._source;"raster-array"===eh.type&&eh.iconsets&&(el.used=!0)}for(let el in this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&ep&&this.mergeLayers(),e_){let eh=this._mergedSourceCaches[el];e_[el]!==eh.used&&eh.getSource().fire(new F.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:eh.getSource().id}))}this.light&&this.light.recalculate(el),this.terrain&&this.terrain.recalculate(el),this.fog&&this.fog.recalculate(el),this.snow&&this.snow.recalculate(el),this.rain&&this.rain.recalculate(el),this.z=el.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),ec&&this.fire(new F.A("data",{dataType:"style"}))}_updateTilesForChangedImages(){let F=this._changes.getUpdatedImages();if(F.length){for(let el in this._mergedSourceCaches)this._mergedSourceCaches[el].reloadTilesForDependencies(["icons","patterns"],F);this._changes.resetUpdatedImages()}}_updateWorkerLayers(F,el,eh){let ec=this.getFragmentStyle(F);ec&&this.dispatcher.broadcast("updateLayers",{layers:el?ec._serializeLayers(el):[],scope:F,removedIds:eh||[],options:ec.options})}setState(el,eh){if(this._checkLoaded(),go(this,me(el)))return!1;(el=F.cq(el)).layers=Lt(el.layers);let ec=(function(el,eh){if(!el)return[{command:e0.setStyle,args:[eh]}];let ec=[];try{if(!F.bn(el.version,eh.version)||(F.bn(el.center,eh.center)||ec.push({command:e0.setCenter,args:[eh.center]}),F.bn(el.zoom,eh.zoom)||ec.push({command:e0.setZoom,args:[eh.zoom]}),F.bn(el.bearing,eh.bearing)||ec.push({command:e0.setBearing,args:[eh.bearing]}),F.bn(el.pitch,eh.pitch)||ec.push({command:e0.setPitch,args:[eh.pitch]}),F.bn(el.sprite,eh.sprite)||ec.push({command:e0.setSprite,args:[eh.sprite]}),F.bn(el.glyphs,eh.glyphs)||ec.push({command:e0.setGlyphs,args:[eh.glyphs]}),F.bn(el.imports,eh.imports)||function(el=[],eh=[],ec){let ep,e_,eg,ey;eh=eh||[];let eb=(el=el||[]).map(Bt),ew=eh.map(Bt),eT=el.reduce(Nt,{}),eS=eh.reduce(Nt,{}),eE=eb.slice();for(ep=0,e_=0;ep<eb.length;ep++)eg=eb[ep],eS.hasOwnProperty(eg)?e_++:(ec.push({command:e0.removeImport,args:[eg]}),eE.splice(eE.indexOf(eg,e_),1));for(ep=0,e_=0;ep<ew.length;ep++)eg=ew[ew.length-1-ep],eE[eE.length-1-ep]!==eg&&(eT.hasOwnProperty(eg)?(ec.push({command:e0.removeImport,args:[eg]}),eE.splice(eE.lastIndexOf(eg,eE.length-e_),1)):e_++,ey=eE[eE.length-ep],ec.push({command:e0.addImport,args:[eS[eg],ey]}),eE.splice(eE.length-ep,0,eg));for(let el of eh){let eh=eT[el.id];eh&&!F.bn(eh,el)&&ec.push({command:e0.updateImport,args:[el.id,el]})}}(el.imports,eh.imports,ec),F.bn(el.transition,eh.transition)||ec.push({command:e0.setTransition,args:[eh.transition]}),F.bn(el.light,eh.light)||ec.push({command:e0.setLight,args:[eh.light]}),F.bn(el.fog,eh.fog)||ec.push({command:e0.setFog,args:[eh.fog]}),F.bn(el.snow,eh.snow)||ec.push({command:e0.setSnow,args:[eh.snow]}),F.bn(el.rain,eh.rain)||ec.push({command:e0.setRain,args:[eh.rain]}),F.bn(el.projection,eh.projection)||ec.push({command:e0.setProjection,args:[eh.projection]}),F.bn(el.lights,eh.lights)||ec.push({command:e0.setLights,args:[eh.lights]}),F.bn(el.camera,eh.camera)||ec.push({command:e0.setCamera,args:[eh.camera]}),!F.bn(el["color-theme"],eh["color-theme"])))return[{command:e0.setStyle,args:[eh]}];let ep={},e_=[];!function(el,eh,ec,ep){let e_;for(e_ in eh=eh||{},el=el||{})el.hasOwnProperty(e_)&&(eh.hasOwnProperty(e_)||zt(e_,ec,ep));for(e_ in eh){var eg,ey;if(!eh.hasOwnProperty(e_))continue;let eb=eh[e_];el.hasOwnProperty(e_)?F.bn(el[e_],eb)||("geojson"===el[e_].type&&"geojson"===eb.type&&function(el,eh,ec){let ep;for(ep in el[ec])if(el[ec].hasOwnProperty(ep)&&"data"!==ep&&!F.bn(el[ec][ep],eh[ec][ep]))return!1;for(ep in eh[ec])if(eh[ec].hasOwnProperty(ep)&&"data"!==ep&&!F.bn(el[ec][ep],eh[ec][ep]))return!1;return!0}(el,eh,e_)?ec.push({command:e0.setGeoJSONSourceData,args:[e_,eb.data]}):(eg=e_,ey=eh,zt(eg,ec,ep),Pt(eg,ey,ec))):Pt(e_,eh,ec)}}(el.sources,eh.sources,e_,ep);let eg=[];el.layers&&el.layers.forEach(F=>{F.source&&ep[F.source]?ec.push({command:e0.removeLayer,args:[F.id]}):eg.push(F)});let ey=el.terrain;ey&&ep[ey.source]&&(ec.push({command:e0.setTerrain,args:[void 0]}),ey=void 0),ec=ec.concat(e_),F.bn(ey,eh.terrain)||ec.push({command:e0.setTerrain,args:[eh.terrain]}),function(el,eh,ec){let ep,e_,eg,ey,eb,ew,eT;eh=eh||[];let eS=(el=el||[]).map(Bt),eE=eh.map(Bt),eM=el.reduce(Nt,{}),eI=eh.reduce(Nt,{}),eA=eS.slice(),eC=Object.create(null);for(ep=0,e_=0;ep<eS.length;ep++)eg=eS[ep],eI.hasOwnProperty(eg)?e_++:(ec.push({command:e0.removeLayer,args:[eg]}),eA.splice(eA.indexOf(eg,e_),1));for(ep=0,e_=0;ep<eE.length;ep++)eg=eE[eE.length-1-ep],eA[eA.length-1-ep]!==eg&&(eM.hasOwnProperty(eg)?(ec.push({command:e0.removeLayer,args:[eg]}),eA.splice(eA.lastIndexOf(eg,eA.length-e_),1)):e_++,ew=eA[eA.length-ep],ec.push({command:e0.addLayer,args:[eI[eg],ew]}),eA.splice(eA.length-ep,0,eg),eC[eg]=!0);for(ep=0;ep<eE.length;ep++)if(ey=eM[eg=eE[ep]],eb=eI[eg],!eC[eg]&&!F.bn(ey,eb)){if(F.bn(ey.source,eb.source)&&F.bn(ey["source-layer"],eb["source-layer"])&&F.bn(ey.type,eb.type)){for(eT in kt(ey.layout,eb.layout,ec,eg,null,e0.setLayoutProperty),kt(ey.paint,eb.paint,ec,eg,null,e0.setPaintProperty),F.bn(ey.slot,eb.slot)||ec.push({command:e0.setSlot,args:[eg,eb.slot]}),F.bn(ey.filter,eb.filter)||ec.push({command:e0.setFilter,args:[eg,eb.filter]}),F.bn(ey.minzoom,eb.minzoom)&&F.bn(ey.maxzoom,eb.maxzoom)||ec.push({command:e0.setLayerZoomRange,args:[eg,eb.minzoom,eb.maxzoom]}),ey)ey.hasOwnProperty(eT)&&"layout"!==eT&&"paint"!==eT&&"filter"!==eT&&"metadata"!==eT&&"minzoom"!==eT&&"maxzoom"!==eT&&"slot"!==eT&&(0===eT.indexOf("paint.")?kt(ey[eT],eb[eT],ec,eg,eT.slice(6),e0.setPaintProperty):F.bn(ey[eT],eb[eT])||ec.push({command:e0.setLayerProperty,args:[eg,eT,eb[eT]]}));for(eT in eb)eb.hasOwnProperty(eT)&&!ey.hasOwnProperty(eT)&&"layout"!==eT&&"paint"!==eT&&"filter"!==eT&&"metadata"!==eT&&"minzoom"!==eT&&"maxzoom"!==eT&&"slot"!==eT&&(0===eT.indexOf("paint.")?kt(ey[eT],eb[eT],ec,eg,eT.slice(6),e0.setPaintProperty):F.bn(ey[eT],eb[eT])||ec.push({command:e0.setLayerProperty,args:[eg,eT,eb[eT]]}))}else ec.push({command:e0.removeLayer,args:[eg]}),ew=eA[eA.lastIndexOf(eg)+1],ec.push({command:e0.addLayer,args:[eb,ew]})}}(eg,eh.layers,ec)}catch(F){console.warn("Unable to compute style diff:",F),ec=[{command:e0.setStyle,args:[eh]}]}return ec})(this.serialize(),el).filter(F=>!(F.command in tn));if(0===ec.length)return!1;let ep=ec.filter(F=>!(F.command in e7));if(ep.length>0)throw Error(`Unimplemented: ${ep.map(F=>F.command).join(", ")}.`);let e_=[];return ec.forEach(F=>{e_.push(this[F.command].apply(this,F.args))}),eh&&Promise.all(e_).then(eh),this.stylesheet=el,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}addImages(el){for(let[eh,ec]of el.entries()){if(this.getImage(eh)&&!eh.iconsetId)return this.fire(new F.z(Error(`An image with the name "${eh.name}" already exists.`)));this.imageManager.addImage(eh,this.scope,ec),this._changes.updateImage(eh)}return this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})),this}addImage(el,eh){return this.getImage(el)&&!el.iconsetId?this.fire(new F.z(Error(`An image with the name "${el.name}" already exists.`))):(this.imageManager.addImage(el,this.scope,eh),this._changes.updateImage(el),this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})),this)}updateImage(el,eh,ec=!1){this.imageManager.updateImage(el,this.scope,eh),ec&&(this._changes.updateImage(el),this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})))}getImage(F){return this.imageManager.getImage(F,this.scope)}removeImage(el){return this.getImage(el)?(this.imageManager.removeImage(el,this.scope),this._changes.updateImage(el),this._updateWorkerImages(),this.fire(new F.A("data",{dataType:"style"})),this):this.fire(new F.z(Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(F,el,eh={}){return this._checkLoaded(),this._validate(Re,`models.${F}`,el,null,eh)||(this.modelManager.addModel(F,el,this.scope),this._changes.setDirty()),this}hasModel(F){return this.modelManager.hasModel(F,this.scope)}removeModel(el){return this.hasModel(el)?(this.modelManager.removeModel(el,this.scope),this):this.fire(new F.z(Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(el,eh,ec={}){if(this._checkLoaded(),void 0!==this.getOwnSource(el))throw Error(`There is already a source with ID "${el}".`);if(!eh.type)throw Error(`The type property must be defined, but only the following properties were given: ${Object.keys(eh).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(eh.type)>=0&&this._validate(ge,`sources.${el}`,eh,null,ec))return;this.map&&this.map._collectResourceTiming&&(eh.collectResourceTiming=!0);let ep=rt(el,eh,this.dispatcher,this);ep.scope=this.scope,ep.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(ep.id),source:ep.serialize(),sourceId:ep.id}));let r=el=>{let eh=(el?"symbol:":"other:")+ep.id,ec=F.C(eh,this.scope),e_=this._sourceCaches[eh]=new St(ec,ep,el);(el?this._symbolSourceCaches:this._otherSourceCaches)[ep.id]=e_,e_.onAdd(this.map)};r(!1),"vector"!==eh.type&&"geojson"!==eh.type||r(!0),ep.onAdd&&ep.onAdd(this.map),ec.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(el){this._checkLoaded();let eh=this.getOwnSource(el);if(!eh)throw Error("There is no source with this ID");for(let eh in this._layers)if(this._layers[eh].source===el)return this.fire(new F.z(Error(`Source "${el}" cannot be removed while layer "${eh}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===el)return this.fire(new F.z(Error(`Source "${el}" cannot be removed while terrain is using it.`)));let ec=this.getOwnSourceCaches(el);for(let el of ec){let eh=F.cr(el.id);delete this._sourceCaches[eh],this._changes.discardSourceCacheUpdate(el.id),el.fire(new F.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:el.getSource().id})),el.setEventedParent(null),el.clearTiles()}return delete this._otherSourceCaches[el],delete this._symbolSourceCaches[el],this.mergeSources(),eh.setEventedParent(null),eh.onRemove&&eh.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(F,el){this._checkLoaded(),this.getOwnSource(F).setData(el),this._changes.setDirty()}getOwnSource(F){let el=this.getOwnSourceCache(F);return el&&el.getSource()}getOwnSources(){let F=[];for(let el in this._otherSourceCaches){let eh=this.getOwnSourceCache(el);eh&&F.push(eh.getSource())}return F}areTilesLoaded(){let F=this._mergedSourceCaches;for(let el in F){let eh=F[el]._tiles;for(let F in eh){let el=eh[F];if("loaded"!==el.state&&"errored"!==el.state)return!1}}return!0}setLights(el){if(this._checkLoaded(),!el)return delete this.ambientLight,void delete this.directionalLight;let eh=this._getTransitionParameters();for(let ec of el){if(this._validate(ye,"lights",ec))return;switch(ec.type){case"ambient":if(this.ambientLight){let F=this.ambientLight;F.set(ec),F.updateTransitions(eh)}else this.ambientLight=new $e(ec,eq||(eq=new F.a7({color:new F.a8(F.a5.properties_light_ambient.color),"color-use-theme":new F.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a8(F.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){let F=this.directionalLight;F.set(ec),F.updateTransitions(eh)}else this.directionalLight=new $e(ec,e$||(e$=new F.a7({direction:new F.am(F.a5.properties_light_directional.direction),color:new F.a8(F.a5.properties_light_directional.color),"color-use-theme":new F.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new F.a8(F.a5.properties_light_directional.intensity),"cast-shadows":new F.a8(F.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new F.a8(F.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new F.a8(F.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}let ec=new F.aa(this.z||0,eh);this.ambientLight&&this.ambientLight.recalculate(ec),this.directionalLight&&this.directionalLight.recalculate(ec),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){let el=this.directionalLight,eh=this.ambientLight;if(!el||!eh)return;let o=F=>.2126*(F[0]<=.03928?F[0]/12.92:Math.pow((F[0]+.055)/1.055,2.4))+.7152*(F[1]<=.03928?F[1]/12.92:Math.pow((F[1]+.055)/1.055,2.4))+.0722*(F[2]<=.03928?F[2]/12.92:Math.pow((F[2]+.055)/1.055,2.4)),ec=el.properties.get("color").toRenderColor(null).toArray01(),ep=el.properties.get("intensity"),e_=el.properties.get("direction"),eg=1-F.cc(e_.x,e_.y,e_.z)[2]/90,ey=o(ec)*ep*eg,eb=eh.properties.get("color").toRenderColor(null).toArray01(),ew=eh.properties.get("intensity"),eT=o(eb)*ew;return Number(((ey+eT)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;let F=[];return this.directionalLight&&F.push(this.directionalLight.get()),this.ambientLight&&F.push(this.ambientLight.get()),F}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(el){if(!el)return this;if(F.cs(el)){let eh=F.ct(el),ec=this.fragments.find(({id:F})=>F===eh);if(!ec)throw Error(`Style import '${el}' not found`);let ep=F.cr(el);return ec.style.getFragmentStyle(ep)}{let F=this.fragments.find(({id:F})=>F===el);return F?F.style:void 0}}setFeaturesetSelectors(el){if(!el)return;let eh={},o=(F,el="")=>`${F}::${el}`;for(let ec in this._featuresetSelectors={},el){let ep=this._featuresetSelectors[ec]=[];for(let e_ of el[ec].selectors){let el;if(e_.featureNamespace){let el=this.getOwnLayer(e_.layer);if(!el){F.w(`Layer is undefined for selector: ${e_.layer}`);continue}let ep=o(el.source,el.sourceLayer);if(ep in eh&&eh[ep]!==e_.featureNamespace){F.w(`"featureNamespace ${e_.featureNamespace} of featureset ${ec}'s selector is not associated to the same source, skip this selector`);continue}eh[ep]=e_.featureNamespace}if(e_.properties)for(let eh in e_.properties){let ec=F.X(e_.properties[eh]);"success"===ec.result&&((el=el||{})[eh]=ec.value)}ep.push({layerId:e_.layer,namespace:e_.featureNamespace,properties:el,uniqueFeatureID:e_._uniqueFeatureID})}}}getFeaturesetDescriptors(F){let el=this.getFragmentStyle(F);if(!el||!el.stylesheet.featuresets)return[];let eh=[];for(let F in el.stylesheet.featuresets)eh.push({featuresetId:F,importId:el.scope?el.scope:void 0});return eh}getFeaturesetLayers(el,eh){let ec=this.getFragmentStyle(eh),ep=ec.stylesheet.featuresets;if(!ep||!ep[el])return this.fire(new F.z(Error(`The featureset '${el}' does not exist in the map's style and cannot be queried.`))),[];let e_=[];for(let F of ep[el].selectors){let el=ec.getOwnLayer(F.layer);el&&e_.push(el)}return e_}getConfigProperty(el,eh){let ec=this.getFragmentStyle(el);if(!ec)return null;let ep=F.C(eh,ec.scope),e_=ec.options.get(ep),eg=e_?e_.value||e_.default:null;return eg?eg.serialize():null}setConfigProperty(el,eh,ec){let ep;let e_=this.getFragmentStyle(el);if(!e_)return;let eg=e_.stylesheet.indoor?uo(e_.stylesheet.schema):e_.stylesheet.schema;if(!eg||!eg[eh])return;let ey=F.X(ec);if("success"!==ey.result)return void go(this,ey.value);let eb=ey.value.expression,ew=F.C(eh,e_.scope),eT=e_.options.get(ew);if(!eT)return;let{minValue:eS,maxValue:eE,stepValue:eM,type:eI,values:eA}=eg[eh],eC=F.X(eg[eh].default);"success"===eC.result&&(ep=eC.value.expression),ep?(this.options.set(ew,Object.assign({},eT,{value:eb,default:ep,minValue:eS,maxValue:eE,stepValue:eM,type:eI,values:eA})),this.updateConfigDependencies(eh)):this.fire(new F.z(Error(`No schema defined for the config option "${eh}" in the "${el}" fragment.`)))}getConfig(el){let eh=this.getFragmentStyle(el);if(!eh)return null;let ec=eh.stylesheet.schema;if(!ec)return null;let ep={};for(let el in ec){let ec=F.C(el,eh.scope),e_=eh.options.get(ec),eg=e_?e_.value||e_.default:null;ep[el]=eg?eg.serialize():null}return ep}setConfig(F,el){let eh=this.getFragmentStyle(F);eh&&(eh.updateConfig(el,eh.stylesheet.schema),this.updateConfigDependencies())}getSchema(F){let el=this.getFragmentStyle(F);return el?el.stylesheet.schema:null}setSchema(F,el){let eh=this.getFragmentStyle(F);eh&&(eh.stylesheet.schema=el,eh.updateConfig(eh._config,el),this.updateConfigDependencies())}updateConfig(el,eh){if(this._config=el,el||eh){if(eh)for(let ec in eh){let ep,e_;let eg=F.X(eh[ec].default);if("success"===eg.result&&(ep=eg.value.expression),el&&void 0!==el[ec]){let eh=F.X(el[ec]);"success"===eh.result&&(e_=eh.value.expression)}let{minValue:ey,maxValue:eb,stepValue:ew,type:eT,values:eS}=eh[ec];if(ep){let el=F.C(ec,this.scope);this.options.set(el,{default:ep,value:e_,minValue:ey,maxValue:eb,stepValue:ew,type:eT,values:eS})}else this.fire(new F.z(Error(`No schema defined for config option "${ec}".`)))}else this.fire(new F.z(Error("Attempting to set config for a style without schema.")))}}updateConfigDependencies(F){for(let el of this._configDependentLayers){let eh=this.getLayer(el);if(eh){if(F&&!eh.configDependencies.has(F))continue;eh.possiblyEvaluateVisibility(),this._updateLayer(eh)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(F=>{let el=F._styleColorTheme.colorThemeOverride?F._styleColorTheme.colorThemeOverride:F._styleColorTheme.colorTheme;if(el){let eh=F._evaluateColorThemeData(el);(!F._styleColorTheme.lut&&""!==eh||F._styleColorTheme.lut&&eh!==F._styleColorTheme.lut.data)&&F.setColorTheme(el)}}),this._changes.setDirty()}addLayer(el,eh,ec={}){let ep;this._checkLoaded();let e_=el.id;if(this._layers[e_])return void this.fire(new F.z(Error(`Layer with id "${e_}" already exists on this map`)));if("custom"===el.type){if(go(this,F.cu(el)))return;ep=F.cv(el,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof el.source&&(this.addSource(e_,el.source),el=F.cq(el),el=F.l(el,{source:e_})),this._validate(Ee,`layers.${e_}`,el,{arrayIndex:-1},ec))return;ep=F.cv(el,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(ep),ep.setEventedParent(this,{layer:{id:e_}})}0!==ep.configDependencies.size&&this._configDependentLayers.add(ep.fqid);let eg=this._order.length;if(eh){let el=this._order.indexOf(eh);if(-1===el)return void this.fire(new F.z(Error(`Layer with id "${eh}" does not exist on this map.`)));ep.slot===this._layers[eh].slot?eg=el:F.w(`Layer with id "${eh}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(eg,0,e_),this._layerOrderChanged=!0,this._layers[e_]=ep;let ey=this.getOwnLayerSourceCache(ep),eb=!!this.directionalLight&&this.directionalLight.shadowsEnabled();ey&&ep.canCastShadows()&&eb&&(ey.castsShadows=!0);let ew=this._changes.getRemovedLayer(ep);if(ew&&ep.source&&ey&&"custom"!==ep.type){this._changes.discardLayerRemoval(ep);let el=F.C(ep.source,ep.scope);ew.type!==ep.type?this._changes.updateSourceCache(el,"clear"):(this._changes.updateSourceCache(el,"reload"),ey.pause())}this._updateLayer(ep),ep.onAdd&&ep.onAdd(this.map),ep.scope=this.scope,this.mergeLayers()}moveLayer(el,eh){this._checkLoaded();let ec=this._checkLayer(el);if(!ec||el===eh)return;let ep=this._order.indexOf(el);this._order.splice(ep,1);let e_=this._order.length;if(eh){let el=this._order.indexOf(eh);if(-1===el)return void this.fire(new F.z(Error(`Layer with id "${eh}" does not exist on this map.`)));ec.slot===this._layers[eh].slot?e_=el:F.w(`Layer with id "${eh}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(e_,0,el),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(F){this._checkLoaded();let el=this._checkLayer(F);if(!el)return;el.setEventedParent(null);let eh=this._order.indexOf(F);this._order.splice(eh,1),delete this._layers[F],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(el.fqid),this._changes.removeLayer(el);let ec=this.getOwnLayerSourceCache(el);if(ec&&ec.castsShadows){let F=!1;for(let eh in this._layers)if(this._layers[eh].source===el.source&&this._layers[eh].canCastShadows()){F=!0;break}ec.castsShadows=F}el.onRemove&&el.onRemove(this.map),this.mergeLayers()}getOwnLayer(F){return this._layers[F]}hasLayer(F){return F in this._mergedLayers}hasLayerType(F){for(let el in this._layers)if(this._layers[el].type===F)return!0;return!1}setLayerZoomRange(F,el,eh){this._checkLoaded();let ec=this._checkLayer(F);ec&&(ec.minzoom===el&&ec.maxzoom===eh||(null!=el&&(ec.minzoom=el),null!=eh&&(ec.maxzoom=eh),this._updateLayer(ec)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(F,el){this._checkLoaded();let eh=this._checkLayer(F);eh&&eh.slot!==el&&(eh.slot=el,this._updateLayer(eh))}setFilter(el,eh,ec={}){this._checkLoaded();let ep=this._checkLayer(el);if(ep&&!F.bn(ep.filter,eh))return null==eh?(ep.filter=void 0,void this._updateLayer(ep)):void(this._validate(Se,`layers.${ep.id}.filter`,eh,{layerType:ep.type},ec)||(ep.filter=F.cq(eh),this._updateLayer(ep)))}getFilter(el){let eh=this._checkLayer(el);if(eh)return F.cq(eh.filter)}setLayoutProperty(el,eh,ec,ep={}){this._checkLoaded();let e_=this._checkLayer(el);if(e_&&!F.bn(e_.getLayoutProperty(eh),ec)){if(null!=ec&&(!ep||!1!==ep.validate)&&go(e_,Ie.call(me,{key:`layers.${el}.layout.${eh}`,layerType:e_.type,objectKey:eh,value:ec,styleSpec:F.a5,style:{glyphs:!0,sprite:!0}})))return;e_.setLayoutProperty(eh,ec),0!==e_.configDependencies.size&&this._configDependentLayers.add(e_.fqid),this._updateLayer(e_)}}getLayoutProperty(F,el){let eh=this._checkLayer(F);if(eh)return eh.getLayoutProperty(el)}setPaintProperty(el,eh,ec,ep={}){this._checkLoaded();let e_=this._checkLayer(el);if(!e_||F.bn(e_.getPaintProperty(eh),ec)||null!=ec&&(!ep||!1!==ep.validate)&&go(e_,Ce.call(me,{key:`layers.${el}.paint.${eh}`,layerType:e_.type,objectKey:eh,value:ec,styleSpec:F.a5})))return;let eg=e_.setPaintProperty(eh,ec);0!==e_.configDependencies.size&&this._configDependentLayers.add(e_.fqid),eg&&this._updateLayer(e_),this._changes.updatePaintProperties(e_)}getPaintProperty(F,el){let eh=this._checkLayer(F);if(eh)return eh.getPaintProperty(el)}setFeatureState(el,eh){if(this._checkLoaded(),"target"in el){if("featuresetId"in el.target){let{featuresetId:F,importId:ec}=el.target,ep=this.getFragmentStyle(ec),e_=ep.getFeaturesetLayers(F);for(let{source:F,sourceLayer:ec}of e_)ep.setFeatureState({id:el.id,source:F,sourceLayer:ec},eh)}else if("layerId"in el.target){let{layerId:F}=el.target,ec=this.getLayer(F);this.setFeatureState({id:el.id,source:ec.source,sourceLayer:ec.sourceLayer},eh)}return}let ec=el.source,ep=el.sourceLayer,e_=this._checkSource(ec);if(!e_)return;let eg=e_.type;if("geojson"===eg&&ep)return void this.fire(new F.z(Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===eg&&!ep)return void this.fire(new F.z(Error("The sourceLayer parameter must be provided for vector source types.")));void 0===el.id&&this.fire(new F.z(Error("The feature id parameter must be provided.")));let ey=this.getOwnSourceCaches(ec);for(let F of ey)F.setFeatureState(ep,el.id,eh)}removeFeatureState(el,eh){if(this._checkLoaded(),"target"in el){if("featuresetId"in el.target){let{featuresetId:F,importId:ec}=el.target,ep=this.getFragmentStyle(ec),e_=ep.getFeaturesetLayers(F);for(let{source:F,sourceLayer:ec}of e_)ep.removeFeatureState({id:el.id,source:F,sourceLayer:ec},eh)}else if("layerId"in el.target){let{layerId:F}=el.target,ec=this.getLayer(F);this.removeFeatureState({id:el.id,source:ec.source,sourceLayer:ec.sourceLayer},eh)}return}let ec=el.source,ep=this._checkSource(ec);if(!ep)return;let e_=ep.type,eg="vector"===e_?el.sourceLayer:void 0;if("vector"===e_&&!eg)return void this.fire(new F.z(Error("The sourceLayer parameter must be provided for vector source types.")));if(eh&&"string"!=typeof el.id&&"number"!=typeof el.id)return void this.fire(new F.z(Error("A feature id is required to remove its specific state property.")));let ey=this.getOwnSourceCaches(ec);for(let F of ey)F.removeFeatureState(eg,el.id,eh)}getFeatureState(el){if(this._checkLoaded(),"target"in el){let eh;if("featuresetId"in el.target){let{featuresetId:ec,importId:ep}=el.target,e_=this.getFragmentStyle(ep),eg=e_.getFeaturesetLayers(ec);for(let{source:ec,sourceLayer:ep}of eg){let eg=e_.getFeatureState({id:el.id,source:ec,sourceLayer:ep});if(eg&&!eh)eh=eg;else if(!F.bn(eh,eg))return void this.fire(new F.z(Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in el.target){let{layerId:F}=el.target,ec=this.getLayer(F);eh=this.getFeatureState({id:el.id,source:ec.source,sourceLayer:ec.sourceLayer})}return eh}let eh=el.source,ec=el.sourceLayer,ep=this._checkSource(eh);if(ep){if("vector"!==ep.type||ec)return void 0===el.id&&this.fire(new F.z(Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(eh)[0].getFeatureState(ec,el.id);this.fire(new F.z(Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(el){return this.stylesheet.transition=F.l({},this.stylesheet.transition,el),this.transition=this.stylesheet.transition,this}getTransition(){return F.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();let el=this.getTerrain(),eh=el&&this.terrain&&this.terrain.scope===this.scope?el:this.stylesheet.terrain;return F.cw({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:eh,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},F=>void 0!==F)}_updateFilteredLayers(F){for(let el of Object.values(this._mergedLayers))F(el)&&this._updateLayer(el)}_updateLayer(el){this._changes.updateLayer(el);let eh=this.getLayerSourceCache(el),ec=F.C(el.source,el.scope),ep=this._changes.getUpdatedSourceCaches();el.source&&!ep[ec]&&eh&&"raster"!==eh.getSource().type&&(this._changes.updateSourceCache(ec,"reload"),eh.pause()),el.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(F){let t=F=>this._mergedLayers[F].is3D(!!this.terrain),el=this.order,eh={},ec=[];for(let ep=el.length-1;ep>=0;ep--){let e_=el[ep];if(t(e_))for(let el of(eh[e_]=ep,F)){let F=el[e_];if(F)for(let el of F)ec.push(el)}}ec.sort((F,el)=>el.intersectionZ-F.intersectionZ);let ep=[];for(let e_=el.length-1;e_>=0;e_--){let eg=el[e_];if(t(eg))for(let F=ec.length-1;F>=0;F--){let el=ec[F].feature;if(el.layer&&eh[el.layer.id]<e_)break;ep.push(el),ec.pop()}else for(let el of F){let F=el[eg];if(F)for(let el of F)ep.push(el.feature)}}return ep}queryRenderedFeatures(el,eh,ec){let ep;eh&&!Array.isArray(eh)&&eh.filter&&(this._validate(Se,"queryRenderedFeatures.filter",eh.filter,null,eh),ep=F.a_(eh.filter));let e_={},n=F=>{if(th.has(F.type))return;let el=this.getOwnLayerSourceCache(F),eh=e_[el.id]=e_[el.id]||{sourceCache:el,layers:{},has3DLayers:!1};F.is3D(!!this.terrain)&&(eh.has3DLayers=!0),eh.layers[F.fqid]=eh.layers[F.fqid]||{styleLayer:F,targets:[]},eh.layers[F.fqid].targets.push({filter:ep})};if(eh&&eh.layers){if(!Array.isArray(eh.layers))return this.fire(new F.z(Error("parameters.layers must be an Array."))),[];for(let el of eh.layers){let eh=this._layers[el];if(!eh)return this.fire(new F.z(Error(`The layer '${el}' does not exist in the map's style and cannot be queried for features.`))),[];n(eh)}}else for(let F in this._layers)n(this._layers[F]);let eg=this._queryRenderedFeatures(el,e_,ec),ey=this._flattenAndSortRenderedFeatures(eg),eb=[];for(let el of ey)F.ct(el.layer.id)===this.scope&&eb.push(el);return eb}queryRenderedFeatureset(el,eh,ec){let ep;eh&&!Array.isArray(eh)&&eh.filter&&(this._validate(Se,"queryRenderedFeatures.filter",eh.filter,null,eh),ep=F.a_(eh.filter));let e_="mock",eg=[];if(eh&&eh.target)eg.push(Object.assign({},eh,{targetId:e_,filter:ep}));else{let F=this.getFeaturesetDescriptors();for(let el of F)eg.push({targetId:e_,filter:ep,target:el});for(let{style:F}of this.fragments){let el=F.getFeaturesetDescriptors();for(let F of el)eg.push({targetId:e_,filter:ep,target:F})}}let ey=this.queryRenderedTargets(el,eg,ec),eb=[],ew=new Set;for(let el of ey)for(let eh of el.variants[e_])at(eh,el,ew)||eb.push(new F.cx(el,eh));return eb}queryRenderedTargets(el,eh,ec){let ep={},r=(F,el,eh,ec)=>{let e_=ep[el.id]=ep[el.id]||{sourceCache:el,layers:{},has3DLayers:!1};if(e_.layers[F.fqid]=e_.layers[F.fqid]||{styleLayer:F,targets:[]},F.is3D(!!this.terrain)&&(e_.has3DLayers=!0),!ec)return eh.uniqueFeatureID=!1,void e_.layers[F.fqid].targets.push(eh);e_.layers[F.fqid].targets.push(Object.assign({},eh,{namespace:ec.namespace,properties:ec.properties,uniqueFeatureID:ec.uniqueFeatureID}))};for(let el of eh)if("featuresetId"in el.target){let{featuresetId:eh,importId:ec}=el.target,ep=this.getFragmentStyle(ec);if(!ep||!ep._featuresetSelectors)continue;let e_=ep._featuresetSelectors[eh];if(!e_){this.fire(new F.z(Error(`The featureset '${eh}' does not exist in the map's style and cannot be queried for features.`)));continue}for(let F of e_){let eh=ep.getOwnLayer(F.layerId);eh&&!th.has(eh.type)&&r(eh,ep.getOwnLayerSourceCache(eh),el,F)}}else if("layerId"in el.target){let{layerId:F}=el.target,eh=this.getLayer(F);if(!eh||th.has(eh.type))continue;r(eh,this.getLayerSourceCache(eh),el)}let e_=this._queryRenderedFeatures(el,ep,ec);return this._flattenAndSortRenderedFeatures(e_)}_queryRenderedFeatures(F,el,eh){let ec=[],ep=!!this.map._showQueryGeometry,e_=Xe.createFromScreenPoints(F,eh);for(let F in el){let eg=function(F,el,eh,ec,ep=!1){let e_=el.sourceCache.transform,eg=el.sourceCache.tilesIn(F,el.has3DLayers,ep);eg.sort(dt);let ey=[];for(let F of eg){let eg=F.tile.queryRenderedFeatures(el,F,eh,ec,e_,ep);Object.keys(eg).length&&ey.push({wrappedTileID:F.tile.tileID.wrapped().key,queryResults:eg})}return 0===ey.length?{}:function(F){let el={},eh={};for(let ec of F){let F=ec.queryResults,ep=ec.wrappedTileID,e_=eh[ep]=eh[ep]||{};for(let eh in F){let ec=F[eh],ep=e_[eh]=e_[eh]||{},eg=el[eh]=el[eh]||[];for(let F of ec)ep[F.featureIndex]||(ep[F.featureIndex]=!0,eg.push(F))}}return el}(ey)}(e_,el[F],this._availableImages,eh,ep);Object.keys(eg).length&&ec.push(eg)}if(this.placement)for(let F in el){if(!el[F].sourceCache._onlySymbols)continue;let eh=function(F,el,eh,ec,ep){let e_={},eg=ec.queryRenderedSymbols(F),ey=[];for(let F of Object.keys(eg).map(Number))ey.push(ep[F]);for(let F of(ey.sort(dt),ey)){let ec=F.featureIndex.lookupSymbolFeatures(eg[F.bucketInstanceId],F.bucketIndex,F.sourceLayerIndex,el,eh);for(let el in ec){let eh=e_[el]=e_[el]||[],ep=ec[el];for(let el of(ep.sort((el,eh)=>{let ec=F.featureSortOrder;if(ec){let F=ec.indexOf(el.featureIndex);return ec.indexOf(eh.featureIndex)-F}return eh.featureIndex-el.featureIndex}),ep))eh.push(el)}}return e_}(e_.screenGeometry,el[F],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(eh).length&&ec.push(eh)}return ec}querySourceFeatures(F,el){let eh=el&&el.filter;eh&&this._validate(Se,"querySourceFeatures.filter",eh,null,el);let ec=[],ep=this.getOwnSourceCaches(F);for(let F of ep)ec=ec.concat(function(F,el){let eh=F.getRenderableIds().map(el=>F.getTileByID(el)),ec=[],ep={};for(let F=0;F<eh.length;F++){let e_=eh[F],eg=e_.tileID.canonical.key;ep[eg]||(ep[eg]=!0,e_.querySourceFeatures(ec,el))}return ec}(F,el));return ec}addSourceType(F,el,eh){return To.getSourceType(F)?eh(Error(`A source type called "${F}" already exists.`)):(To.setSourceType(F,el),el.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:F,url:el.workerSourceURL},eh):eh(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(el,eh,ec={}){this._checkLoaded();let ep=this.light.getLight(),e_=!1;for(let eh in el)if(!F.bn(el[eh],ep[eh])){e_=!0;break}if(!e_)return;let eg=this._getTransitionParameters();this.light.setLight(el,eh,ec),this.light.updateTransitions(eg)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=F.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&F.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(el,eh=1){if(this._checkLoaded(),!el)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===eh&&delete this.terrain,null===el?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let ec=el,ep=null==el.source;if(1===eh){if(this.disableElevatedTerrain)return;if("object"==typeof ec.source){let el="terrain-dem-src";this.addSource(el,ec.source),ec=F.cq(ec),ec=F.l(ec,{source:el})}let el=F.l({},ec),eh={};if(this.terrain&&ep){el.source=this.terrain.get().source;let F=this.terrain?this.getFragmentStyle(this.terrain.scope):null;F&&(eh.style=F.serialize())}if(this._validate(xe,"terrain",el,eh))return}if(this.terrain&&(this.terrain.scope===this.scope||ep)&&(!this.terrain||eh===this.terrain.drapeRenderMode)){let eh=this.terrain,ep=eh.get();for(let el of Object.keys(F.a5.terrain))!ec.hasOwnProperty(el)&&F.a5.terrain[el].default&&(ec[el]=F.a5.terrain[el].default);for(let ec in el)if(!F.bn(el[ec],ep[ec])){eh.set(el,this.options),this.stylesheet.terrain=el;let ec=this._getTransitionParameters({duration:0});eh.updateTransitions(ec),this.fire(new F.A("data",{dataType:"style"}));break}}else{if(!ec)return;this._createTerrain(ec,eh),this.fire(new F.A("data",{dataType:"style"}))}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(F){let el=this.fog=new Ve(F,this.map.transform,this.scope,this.options);this.stylesheet.fog=el.get();let eh=this._getTransitionParameters({duration:0});el.updateTransitions(eh)}_createSnow(F){let el=this.snow=new eH(F,this.map.transform,this.scope,this.options);this.stylesheet.snow=el.get();let eh=this._getTransitionParameters({duration:0});el.updateTransitions(eh)}_createRain(F){let el=this.rain=new eZ(F,this.map.transform,this.scope,this.options);this.stylesheet.rain=el.get();let eh=this._getTransitionParameters({duration:0});el.updateTransitions(eh)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(let F of this.map._markers)F._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(el){if(this._checkLoaded(),!el)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){let eh=this.fog;if(!F.bn(eh.get(),el)){eh.set(el,this.options),this.stylesheet.fog=eh.get();let F=this._getTransitionParameters({duration:0});eh.updateTransitions(F)}}else this._createFog(el);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(el){if(this._checkLoaded(),!el)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){let eh=this.snow;if(!F.bn(eh.get(),el)){eh.set(el,this.options),this.stylesheet.snow=eh.get();let F=this._getTransitionParameters({duration:0});eh.updateTransitions(F)}}else this._createSnow(el);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(el){if(this._checkLoaded(),!el)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){let eh=this.rain;if(!F.bn(eh.get(),el)){eh.set(el,this.options),this.stylesheet.rain=eh.get();let F=this._getTransitionParameters({duration:0});eh.updateTransitions(F)}}else this._createRain(el);this._markersNeedUpdate=!0}_reloadColorTheme(){let t=()=>{for(let F in this._layers)this._layers[F].lut=this._styleColorTheme.lut;for(let F in this._sourceCaches)this._sourceCaches[F].clearTiles()},el=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!el)return this._styleColorTheme.lut=null,void t();let eh=this._evaluateColorThemeData(el);this._loadColorTheme(eh).then(()=>{this.fire(new F.A("colorthemeset")),t()}).catch(el=>{F.w(`Couldn't set color theme: ${el}`)})}setColorTheme(el){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&F.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=el,this._reloadColorTheme()}setImportColorTheme(F,el){let eh=this.getFragmentStyle(F);eh&&(eh._styleColorTheme.colorThemeOverride=el,eh._reloadColorTheme())}_getTransitionParameters(el){return{now:F.q.now(),transition:F.l(this.transition,el)}}updateDrapeFirstLayers(){if(!this.terrain)return;let F=[],el=[];for(let eh of this._mergedOrder)this.isLayerDraped(this._mergedLayers[eh])?F.push(eh):el.push(eh);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...F),this._drapedFirstOrder.push(...el)}_createTerrain(F,el){let eh=this.terrain=new eU(F,el,this.scope,this.options);1===el&&(this.stylesheet.terrain=F),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();let ec=this._getTransitionParameters({duration:0});eh.updateTransitions(ec)}_force3DLayerUpdate(){for(let F in this._layers){let el=this._layers[F];"fill-extrusion"===el.type&&this._updateLayer(el)}}_forceSymbolLayerUpdate(){for(let F in this._layers){let el=this._layers[F];"symbol"===el.type&&this._updateLayer(el)}}_validate(el,eh,ec,ep,e_={}){if(e_&&!1===e_.validate)return!1;let eg=F.l({},this.serialize());return go(this,el.call(me,F.l({key:eh,style:eg,value:ec,styleSpec:F.a5},ep)))}_remove(){for(let el in this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),F.cy.off("pluginStateChange",this._rtlTextPluginCallback),this._mergedLayers)this._mergedLayers[el].setEventedParent(null);for(let F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles(),this._mergedSourceCaches[F].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(F){let el=this.getSourceCaches(F);for(let F of el)F.clearTiles()}clearSources(){for(let F in this._mergedSourceCaches)this._mergedSourceCaches[F].clearTiles()}reloadSource(F){let el=this.getSourceCaches(F);for(let F of el)F.resume(),F.reload()}reloadSources(){for(let F of this.getSources())F.reload&&F.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(F=>{F.modelManager.reloadModels(F.scope)})}updateSources(F){let el;for(let eh in this.directionalLight&&(el=ro(this.directionalLight)),this._mergedSourceCaches)this._mergedSourceCaches[eh].update(F,void 0,void 0,el)}_generateCollisionBoxes(){for(let F in this._sourceCaches){let el=this._sourceCaches[F];el.resume(),el.reload()}}_updatePlacement(el,eh,ec,ep,e_,eg,ey=!1){let eb=!1,ew=!1,eT={},eS={};for(let el of this._mergedOrder){let ec=this._mergedLayers[el];if("symbol"!==ec.type)continue;let ep=F.C(ec.source,ec.scope),e_=eT[ep];if(!e_){let F=this.getLayerSourceCache(ec);if(!F)continue;let el=F.getRenderableIds(!0).map(el=>F.getTileByID(el));eS[ep]=el.slice(),e_=eT[ep]=el.sort((F,el)=>el.tileID.overscaledZ-F.tileID.overscaledZ||(F.tileID.isLessThan(el.tileID)?-1:1))}let eg=this.crossTileSymbolIndex.addLayer(ec,e_,eh.center.lng,eh.projection);eb=eb||eg}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),ey=ey||this._layerOrderChanged||0===ep,this._layerOrderChanged&&this.fire(new F.A("neworder")),(ey||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(F.q.now(),eh.zoom))&&(this.pauseablePlacement=new Ai(eh,this._mergedOrder,ey,ec,ep,e_,this.placement,this.fog&&eh.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,eT,eS,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(F.q.now()),ew=!0),eb&&this.pauseablePlacement.placement.setStale()),ew||eb){this._buildingIndex.onNewFrame(eh.zoom);for(let el=0;el<this._mergedOrder.length;el++){let eh=this._mergedLayers[this._mergedOrder[el]];if("symbol"!==eh.type)continue;let ec=this.isLayerClipped(eh);this.placement.updateLayerOpacities(eh,eT[F.C(eh.source,eh.scope)],el,ec?eg:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(F.q.now())}}_releaseSymbolFadeTiles(){for(let F in this._sourceCaches)this._sourceCaches[F].releaseSymbolFadeTiles()}addImport(el,eh){this._checkLoaded();let ec=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==ec.findIndex(({id:F})=>F===el.id))return void this.fire(new F.z(Error(`Import with id '${el.id}' already exists in the map's style.`)));if(!eh)return ec.push(el),this._loadImports([el],!0);let ep=ec.findIndex(({id:F})=>F===eh);return -1===ep&&this.fire(new F.z(Error(`Import with id "${eh}" does not exist on this map.`))),this.stylesheet.imports=ec.slice(0,ep).concat(el).concat(ec.slice(ep)),this._loadImports([el],!0,eh)}updateImport(el,eh){this._checkLoaded();let ec=this.stylesheet.imports||[],ep=this.getImportIndex(el);return -1===ep||("string"==typeof eh?this.setImportUrl(el,eh):(eh.url&&eh.url!==ec[ep].url&&this.setImportUrl(el,eh.url),F.bn(eh.config,ec[ep].config)||this.setImportConfig(el,eh.config,eh.data.schema),F.bn(eh.data,ec[ep].data)||this.setImportData(el,eh.data))),this}moveImport(F,el){this._checkLoaded();let eh=this.stylesheet.imports||[],ec=this.getImportIndex(F);if(-1===ec)return this;let ep=this.getImportIndex(el);if(-1===ep)return this;let e_=eh[ec],eg=this.fragments[ec];return eh=eh.filter(({id:el})=>el!==F),this.fragments=this.fragments.filter(({id:el})=>el!==F),this.stylesheet.imports=eh.slice(0,ep).concat(e_).concat(eh.slice(ep)),this.fragments=this.fragments.slice(0,ep).concat(eg).concat(this.fragments.slice(ep)),this.mergeLayers(),this}setImportUrl(F,el){this._checkLoaded();let eh=this.stylesheet.imports||[],ec=this.getImportIndex(F);if(-1===ec)return this;eh[ec].url=el;let ep=this.fragments[ec];return ep.style=this._createFragmentStyle(eh[ec]),ep.style.on("style.import.load",()=>this.mergeAll()),ep.style.loadURL(el),this}setImportData(F,el){this._checkLoaded();let eh=this.getImportIndex(F),ec=this.stylesheet.imports||[];return -1===eh?this:el?(this.fragments[eh].style.setState(el),this._reloadImports(),this):(delete ec[eh].data,this.setImportUrl(F,ec[eh].url))}setImportConfig(F,el,eh){this._checkLoaded();let ec=this.getImportIndex(F),ep=this.stylesheet.imports||[];if(-1===ec)return this;el?ep[ec].config=el:delete ep[ec].config;let e_=this.fragments[ec];eh&&e_.style.stylesheet&&(e_.style.stylesheet.schema=eh);let eg=e_.style.stylesheet&&e_.style.stylesheet.schema;return e_.config=el,e_.style.updateConfig(el,eg),this.updateConfigDependencies(),this}removeImport(F){this._checkLoaded();let el=this.stylesheet.imports||[],eh=this.getImportIndex(F);-1!==eh&&(el.splice(eh,1),this.fragments[eh].style._remove(),this.fragments.splice(eh,1),this._reloadImports())}getImportIndex(el){let eh=(this.stylesheet.imports||[]).findIndex(F=>F.id===el);return -1===eh&&this.fire(new F.z(Error(`Import '${el}' does not exist in the map's style and cannot be updated.`))),eh}getLayer(F){return this._mergedLayers[F]}getSources(){let F=[];for(let el in this._mergedOtherSourceCaches){let eh=this._mergedOtherSourceCaches[el];eh&&F.push(eh.getSource())}return F}getSource(F,el){let eh=this.getSourceCache(F,el);return eh&&eh.getSource()}getLayerSource(F){let el=this.getLayerSourceCache(F);return el&&el.getSource()}getSourceCache(el,eh){let ec=F.C(el,eh);return this._mergedOtherSourceCaches[ec]}getLayerSourceCache(el){let eh=F.C(el.source,el.scope);return"symbol"===el.type?this._mergedSymbolSourceCaches[eh]:this._mergedOtherSourceCaches[eh]}getSourceCaches(F){if(null==F)return Object.values(this._mergedSourceCaches);let el=[];return this._mergedOtherSourceCaches[F]&&el.push(this._mergedOtherSourceCaches[F]),this._mergedSymbolSourceCaches[F]&&el.push(this._mergedSymbolSourceCaches[F]),el}updateSourceCaches(){let F=this._changes.getUpdatedSourceCaches();for(let el in F){let eh=F[el];"reload"===eh?this.reloadSource(el):"clear"===eh&&this.clearSource(el)}}updateLayers(F){let el=this._changes.getUpdatedPaintProperties();for(let eh of el){let el=this.getLayer(eh);el&&el.updateTransitions(F)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(F){this.stylesheet.glyphs=F,this.glyphManager.setURL(F,this.scope)}getImages(el,eh,ec){this.imageManager.getImages(eh.images,eh.scope,ec),this._updateTilesForChangedImages();let s=el=>{if(el){let ec=eh.images.map(el=>F.I.toString(el));el.setDependencies(eh.tileID.key,eh.type,ec)}},ep=F.C(eh.source,eh.scope);s(this._mergedOtherSourceCaches[ep]),s(this._mergedSymbolSourceCaches[ep])}rasterizeImages(F,el,eh){this.imageManager.rasterizeImages(el,eh)}getGlyphs(F,el,eh){this.glyphManager.getGlyphs(el.stacks,el.scope,eh)}getResource(el,eh,ec){return F.cz(eh,ec)}getOwnSourceCache(F){return this._otherSourceCaches[F]}getOwnLayerSourceCache(F){return"symbol"===F.type?this._symbolSourceCaches[F.source]:this._otherSourceCaches[F.source]}getOwnSourceCaches(F){let el=[];return this._otherSourceCaches[F]&&el.push(this._otherSourceCaches[F]),this._symbolSourceCaches[F]&&el.push(this._symbolSourceCaches[F]),el}_isSourceCacheLoaded(el){let eh=this.getOwnSourceCaches(el);return 0===eh.length?(this.fire(new F.z(Error(`There is no source with ID '${el}'`))),!1):eh.every(F=>F.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(F,el){if(!this._clipLayerPresent&&"fill-extrusion"!==F.type)return!1;let eh="fill-extrusion"===F.type&&"building"===F.sourceLayer;if(F.is3D(!!this.terrain)){if(eh||el&&"batched-model"===el.type||"model"===F.type)return!0}else if("symbol"===F.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(F=>{F.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}};To.getSourceType=function(F){return eW[F]},To.setSourceType=function(F,el){eW[F]=el},To.registerForPluginStateChange=F.ci;var tg="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",ty="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",tv="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",tb="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",tw="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",tT="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",tS="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",tE="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",tM="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",tI="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",tA="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return clamp(mix(lerpx.x,lerpx.y,f.y),0.0,1.0);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";let tC=[];Vo(tg,tC),Vo(tv,tC),Vo(ty,tC);let tP={"_prelude_fog.vertex.glsl":tT,"_prelude_terrain.vertex.glsl":tw,"_prelude_shadow.vertex.glsl":tI,"_prelude_fog.fragment.glsl":tS,"_prelude_shadow.fragment.glsl":tA,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":tE,"_prelude_raster_particle.glsl":tM},tz={};Go("",tw),Go(tS,tT),Go(tA,tI),Go(tE,""),Go(tM,"");let tD=Go(ty,tv);var tR={background:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:Go("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Go('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:Go("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Go("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:Go("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Go("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),elevatedStructuresDepth:Go("void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=vec4(0.);\n#endif\n}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:Go("#ifdef DEPTH_RECONSTRUCTION\nin float v_height;\n#endif\nvoid main() {\n#ifdef DEPTH_RECONSTRUCTION\nif (v_height >=0.0)\ndiscard;\n#endif\nglFragColor=vec4(1.0,0.0,0.0,1.0);}","in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;\n#ifdef DEPTH_RECONSTRUCTION\nout float v_height;\n#endif\nvoid main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);\n#ifdef DEPTH_RECONSTRUCTION\nif (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;\n#endif\ngl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}"),elevatedStructures:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin vec3 v_normal;in float v_height;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;\n#endif\nvoid main() {vec3 color=vec3(241.0/255.0,236.0/255.0,225.0/255.0);\n#ifdef LIGHTING_3D_MODE\nvec3 normal=normalize(v_normal);\n#ifdef RENDER_SHADOWS\nfloat shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#else\ncolor=apply_lighting(color,normal);\n#endif\nif (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}\n#endif\n#ifdef FOG\ncolor=fog_apply(color,v_fog_pos);\n#endif\nvec4 out_color=vec4(color,1.0);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_height);\n#endif\nglFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(v_normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fill:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:Go('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:Go("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:Go("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),0.001);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:Go("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:Go("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:Go('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:Go('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#else\nz+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#endif\n}'),terrainRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:Go("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:Go('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',tb),skyboxGradient:Go('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',tb),skyboxCapture:Go("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:Go('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:Go('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:Go("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:Go("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:Go("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:Go("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:Go("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:Go("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Vo(F,el){let eh=F.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let F of eh)if("#"===(F=F.trim())[0]&&F.includes("if")&&!F.includes("endif")){F=F.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();let eh=F.split(" ");for(let F of eh)el.includes(F)||el.push(F)}}function Go(F,el){let eh=/#include\s+"([^"]+)"/g,ec=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g,ep=el.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);ep&&(ep=ep.map(F=>{let el=F.split(" ");return el[el.length-1]}),ep=[...new Set(ep)]);let e_={},eg=[],ey=[];if(F=F.replace(eh,(F,el)=>(ey.push(el),"")),(el=el.replace(eh,(F,el)=>(eg.push(el),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let eb=[...tC];for(let eh of(Vo(F,eb),Vo(el,eb),[...eg,...ey]))tP[eh]||console.error(`Undefined include: ${eh}`),tz[eh]||(tz[eh]=[],Vo(tP[eh],tz[eh])),eb=[...eb,...tz[eh]];return{fragmentSource:F=F.replace(ec,(F,el,eh,ec,ep)=>(e_[ep]=!0,"define"===el?`
#ifndef HAS_UNIFORM_u_${ep}
in ${eh} ${ec} ${ep};
#else
uniform ${eh} ${ec} u_${ep};
#endif
`:"initialize"===el?`
#ifdef HAS_UNIFORM_u_${ep}
    ${eh} ${ec} ${ep} = u_${ep};
#endif
`:"define-attribute"===el?`
#ifdef HAS_ATTRIBUTE_a_${ep}
    in ${eh} ${ec} ${ep};
#endif
`:"initialize-attribute"===el?"":void 0)),vertexSource:el=el.replace(ec,(F,el,eh,ec,ep)=>{let eg="float"===ec?"vec2":ec,ey=ep.match(/color/)?"color":eg;return"define-attribute-vertex-shader-only"===el?`
#ifdef HAS_ATTRIBUTE_a_${ep}
in ${eh} ${ec} a_${ep};
#endif
`:e_[ep]?"define"===el?`
#ifndef HAS_UNIFORM_u_${ep}
uniform lowp float u_${ep}_t;
in ${eh} ${eg} a_${ep};
out ${eh} ${ec} ${ep};
#else
uniform ${eh} ${ec} u_${ep};
#endif
`:"initialize"===el?"vec4"===ey?`
#ifndef HAS_UNIFORM_u_${ep}
    ${ep} = a_${ep};
#else
    ${eh} ${ec} ${ep} = u_${ep};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ep}
    ${ep} = unpack_mix_${ey}(a_${ep}, u_${ep}_t);
#else
    ${eh} ${ec} ${ep} = u_${ep};
#endif
`:"define-attribute"===el?`
#ifdef HAS_ATTRIBUTE_a_${ep}
    in ${eh} ${ec} a_${ep};
    out ${eh} ${ec} ${ep};
#endif
`:"initialize-attribute"===el?`
#ifdef HAS_ATTRIBUTE_a_${ep}
    ${ep} = a_${ep};
#endif
`:void 0:"define"===el?`
#ifndef HAS_UNIFORM_u_${ep}
uniform lowp float u_${ep}_t;
in ${eh} ${eg} a_${ep};
#else
uniform ${eh} ${ec} u_${ep};
#endif
`:"define-instanced"===el?"mat4"===ey?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${ep}0;
in vec4 a_${ep}1;
in vec4 a_${ep}2;
in vec4 a_${ep}3;
#else
uniform ${eh} ${ec} u_${ep};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${eh} ${eg} a_${ep};
#else
uniform ${eh} ${ec} u_${ep};
#endif
`:"initialize-attribute-custom"===el?`
#ifdef HAS_ATTRIBUTE_a_${ep}
    ${eh} ${ec} ${ep} = a_${ep};
#endif
`:"vec4"===ey?`
#ifndef HAS_UNIFORM_u_${ep}
    ${eh} ${ec} ${ep} = a_${ep};
#else
    ${eh} ${ec} ${ep} = u_${ep};
#endif
`:`
#ifndef HAS_UNIFORM_u_${ep}
    ${eh} ${ec} ${ep} = unpack_mix_${ey}(a_${ep}, u_${ep}_t);
#else
    ${eh} ${ec} ${ep} = u_${ep};
#endif
`}),staticAttributes:ep,usedDefines:eb,vertexIncludes:eg,fragmentIncludes:ey}}let jo=class jo{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(F,el,eh,ec,ep,e_,eg,ey){this.context=F;let eb=this.boundPaintVertexBuffers.length!==ec.length;for(let F=0;!eb&&F<ec.length;F++)this.boundPaintVertexBuffers[F]!==ec[F]&&(eb=!0);let ew=this.boundDynamicVertexBuffers.length!==eg.length;for(let F=0;!ew&&F<eg.length;F++)this.boundDynamicVertexBuffers[F]!==eg[F]&&(ew=!0);if(!this.vao||this.boundProgram!==el||this.boundLayoutVertexBuffer!==eh||eb||ew||this.boundIndexBuffer!==ep||this.boundVertexOffset!==e_)this.freshBind(el,eh,ec,ep,e_,eg,ey);else{for(let eh of(F.bindVertexArrayOES.set(this.vao),eg))eh&&(eh.bind(),ey&&eh.instanceCount&&eh.setVertexAttribDivisor(F.gl,el,ey));ep&&ep.dynamicDraw&&ep.bind()}}freshBind(F,el,eh,ec,ep,e_,eg){let ey=F.numAttributes,eb=this.context,ew=eb.gl;for(let eg of(this.vao&&this.destroy(),this.vao=eb.gl.createVertexArray(),eb.bindVertexArrayOES.set(this.vao),this.boundProgram=F,this.boundLayoutVertexBuffer=el,this.boundPaintVertexBuffers=eh,this.boundIndexBuffer=ec,this.boundVertexOffset=ep,this.boundDynamicVertexBuffers=e_,el.enableAttributes(ew,F),el.bind(),el.setVertexAttribPointers(ew,F,ep),eh))eg.enableAttributes(ew,F),eg.bind(),eg.setVertexAttribPointers(ew,F,ep);for(let el of e_)el&&(el.enableAttributes(ew,F),el.bind(),el.setVertexAttribPointers(ew,F,ep),eg&&el.instanceCount&&el.setVertexAttribDivisor(ew,F,eg));ec&&ec.bind(),eb.currentNumAttributes=ey}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}};function Zo(el,eh,ec){if(!eh.needsDEMTextureUpload)return;let ep=el.context,e_=ep.gl;ep.pixelStoreUnpackPremultiplyAlpha.set(!1),eh.demTexture=eh.demTexture||el.getTileTexture(ec.stride);let eg=ec.getPixels();eh.demTexture?eh.demTexture.update(eg,{premultiply:!1}):eh.demTexture=new F.T(ep,eg,e_.R32F,{premultiply:!1}),eh.needsDEMTextureUpload=!1}let $o=class $o{constructor(F){this.gl=F.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(F){}getDefault(){return this.default}setDefault(){this.set(this.default)}};let Xo=class Xo extends $o{getDefault(){return F.al.transparent}set(F){let el=this.current;(F.r!==el.r||F.g!==el.g||F.b!==el.b||F.a!==el.a||this.dirty)&&(this.gl.clearColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}};let Ko=class Ko extends $o{getDefault(){return 1}set(F){(F!==this.current||this.dirty)&&(this.gl.clearDepth(F),this.current=F,this.dirty=!1)}};let Yo=class Yo extends $o{getDefault(){return 0}set(F){(F!==this.current||this.dirty)&&(this.gl.clearStencil(F),this.current=F,this.dirty=!1)}};let Jo=class Jo extends $o{getDefault(){return[!0,!0,!0,!0]}set(F){let el=this.current;(F[0]!==el[0]||F[1]!==el[1]||F[2]!==el[2]||F[3]!==el[3]||this.dirty)&&(this.gl.colorMask(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}};let Qo=class Qo extends $o{getDefault(){return!0}set(F){(F!==this.current||this.dirty)&&(this.gl.depthMask(F),this.current=F,this.dirty=!1)}};let es=class es extends $o{getDefault(){return 255}set(F){(F!==this.current||this.dirty)&&(this.gl.stencilMask(F),this.current=F,this.dirty=!1)}};let ts=class ts extends $o{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(F){let el=this.current;(F.func!==el.func||F.ref!==el.ref||F.mask!==el.mask||this.dirty)&&(this.gl.stencilFunc(F.func,F.ref,F.mask),this.current=F,this.dirty=!1)}};let is=class is extends $o{getDefault(){let F=this.gl;return[F.KEEP,F.KEEP,F.KEEP]}set(F){let el=this.current;(F[0]!==el[0]||F[1]!==el[1]||F[2]!==el[2]||this.dirty)&&(this.gl.stencilOp(F[0],F[1],F[2]),this.current=F,this.dirty=!1)}};let os=class os extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;F?el.enable(el.STENCIL_TEST):el.disable(el.STENCIL_TEST),this.current=F,this.dirty=!1}};let ss=class ss extends $o{getDefault(){return[0,1]}set(F){let el=this.current;(F[0]!==el[0]||F[1]!==el[1]||this.dirty)&&(this.gl.depthRange(F[0],F[1]),this.current=F,this.dirty=!1)}};let rs=class rs extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;F?el.enable(el.DEPTH_TEST):el.disable(el.DEPTH_TEST),this.current=F,this.dirty=!1}};let ns=class ns extends $o{getDefault(){return this.gl.LESS}set(F){(F!==this.current||this.dirty)&&(this.gl.depthFunc(F),this.current=F,this.dirty=!1)}};let as=class as extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;F?el.enable(el.BLEND):el.disable(el.BLEND),this.current=F,this.dirty=!1}};let ls=class ls extends $o{getDefault(){let F=this.gl;return[F.ONE,F.ZERO,F.ONE,F.ZERO]}set(F){let el=this.current;(F[0]!==el[0]||F[1]!==el[1]||F[2]!==el[2]||F[3]!==el[3]||this.dirty)&&(this.gl.blendFuncSeparate(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}};let cs=class cs extends $o{getDefault(){return F.al.transparent}set(F){let el=this.current;(F.r!==el.r||F.g!==el.g||F.b!==el.b||F.a!==el.a||this.dirty)&&(this.gl.blendColor(F.r,F.g,F.b,F.a),this.current=F,this.dirty=!1)}};let hs=class hs extends $o{getDefault(){return this.gl.FUNC_ADD}set(F){(F!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(F,F),this.current=F,this.dirty=!1)}};let ds=class ds extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;F?el.enable(el.CULL_FACE):el.disable(el.CULL_FACE),this.current=F,this.dirty=!1}};let us=class us extends $o{getDefault(){return this.gl.BACK}set(F){(F!==this.current||this.dirty)&&(this.gl.cullFace(F),this.current=F,this.dirty=!1)}};let _s=class _s extends $o{getDefault(){return this.gl.CCW}set(F){(F!==this.current||this.dirty)&&(this.gl.frontFace(F),this.current=F,this.dirty=!1)}};let tL=class extends $o{getDefault(){return null}set(F){(F!==this.current||this.dirty)&&(this.gl.useProgram(F),this.current=F,this.dirty=!1)}};let fs=class fs extends $o{getDefault(){return this.gl.TEXTURE0}set(F){(F!==this.current||this.dirty)&&(this.gl.activeTexture(F),this.current=F,this.dirty=!1)}};let ms=class ms extends $o{getDefault(){let F=this.gl;return[0,0,F.drawingBufferWidth,F.drawingBufferHeight]}set(F){let el=this.current;(F[0]!==el[0]||F[1]!==el[1]||F[2]!==el[2]||F[3]!==el[3]||this.dirty)&&(this.gl.viewport(F[0],F[1],F[2],F[3]),this.current=F,this.dirty=!1)}};let gs=class gs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.bindFramebuffer(el.FRAMEBUFFER,F),this.current=F,this.dirty=!1}};let vs=class vs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.bindRenderbuffer(el.RENDERBUFFER,F),this.current=F,this.dirty=!1}};let ys=class ys extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.bindTexture(el.TEXTURE_2D,F),this.current=F,this.dirty=!1}};let xs=class xs extends $o{getDefault(){return null}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.bindBuffer(el.ARRAY_BUFFER,F),this.current=F,this.dirty=!1}};let bs=class bs extends $o{getDefault(){return null}set(F){let el=this.gl;el.bindBuffer(el.ELEMENT_ARRAY_BUFFER,F),this.current=F,this.dirty=!1}};let ws=class ws extends $o{getDefault(){return null}set(F){this.gl&&(F!==this.current||this.dirty)&&(this.gl.bindVertexArray(F),this.current=F,this.dirty=!1)}};let Ts=class Ts extends $o{getDefault(){return 4}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.pixelStorei(el.UNPACK_ALIGNMENT,F),this.current=F,this.dirty=!1}};let Es=class Es extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.pixelStorei(el.UNPACK_PREMULTIPLY_ALPHA_WEBGL,F),this.current=F,this.dirty=!1}};let Ss=class Ss extends $o{getDefault(){return!1}set(F){if(F===this.current&&!this.dirty)return;let el=this.gl;el.pixelStorei(el.UNPACK_FLIP_Y_WEBGL,F),this.current=F,this.dirty=!1}};let Cs=class Cs extends $o{constructor(F,el){super(F),this.context=F,this.parent=el}getDefault(){return null}};let Is=class Is extends Cs{setDirty(){this.dirty=!0}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let el=this.gl;el.framebufferTexture2D(el.FRAMEBUFFER,el.COLOR_ATTACHMENT0,el.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}};let Rs=class Rs extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let el=this.gl;el.framebufferRenderbuffer(el.FRAMEBUFFER,this.attachment(),el.RENDERBUFFER,F),this.current=F,this.dirty=!1}};let Ds=class Ds extends Cs{attachment(){return this.gl.DEPTH_ATTACHMENT}set(F){if(F===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);let el=this.gl;el.framebufferTexture2D(el.FRAMEBUFFER,this.attachment(),el.TEXTURE_2D,F,0),this.current=F,this.dirty=!1}};let As=class As extends Rs{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}};let Ls=(F,el,eh)=>({u_matrix:F,u_image0:0,u_skirt_height:el,u_ground_shadow_factor:eh}),Ms=(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA)=>({u_proj_matrix:Float32Array.from(F),u_globe_matrix:el,u_normalize_matrix:Float32Array.from(ec),u_merc_matrix:eh,u_zoom_transition:ep,u_merc_center:e_,u_image0:0,u_frustum_tl:eg,u_frustum_tr:ey,u_frustum_br:eb,u_frustum_bl:ew,u_globe_pos:eT,u_globe_radius:eS,u_viewport:eE,u_grid_matrix:eA?Float32Array.from(eA):new Float32Array(9),u_skirt_height:eM,u_far_z_cutoff:eI});function Ps(F,el){return null!=F&&null!=el&&!(!F.hasData()||!el.hasData())&&null!=F.demTexture&&null!=el.demTexture&&F.tileID.key!==el.tileID.key}let tO=new class{constructor(){this.operations={}}newMorphing(F,el,eh,ec,ep){if(F in this.operations){let el=this.operations[F];el.to.tileID.key!==eh.tileID.key&&(el.queued=eh)}else this.operations[F]={startTime:ec,phase:0,duration:ep,from:el,to:eh,queued:null}}getMorphValuesForProxy(F){if(!(F in this.operations))return null;let el=this.operations[F];return{from:el.from,to:el.to,phase:el.phase}}update(F){for(let el in this.operations){let eh=this.operations[el];for(eh.phase=(F-eh.startTime)/eh.duration;eh.phase>=1||!this._validOp(eh);)if(!this._nextOp(eh,F)){delete this.operations[el];break}}}_nextOp(F,el){return!!F.queued&&(F.from=F.to,F.to=F.queued,F.queued=null,F.phase=0,F.startTime=el,!0)}_validOp(F){return F.from.hasData()&&F.to.hasData()}},tk={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Fs(F,el,eh){return 0===el?0:6*Math.pow(1.5,22-F)*Math.max(el,1)*(el<1&&514===eh?.25/el:1)}let Bs=F=>({u_matrix:F});function Ns(el,eh,ec,ep,e_){if(e_>0){let eg=F.q.now(),ey=(eg-el.timeAdded)/e_,eb=eh?(eg-eh.timeAdded)/e_:-1,ew=ec.getSource(),eT=ep.coveringZoomLevel({tileSize:ew.tileSize,roundZoom:ew.roundZoom}),eS=!eh||Math.abs(eh.tileID.overscaledZ-eT)>Math.abs(el.tileID.overscaledZ-eT),eE=eS&&el.refreshedUponExpiration?1:F.ay(eS?ey:1-eb,0,1);return el.refreshedUponExpiration&&ey>=1&&(el.refreshedUponExpiration=!1),eh?{opacity:1,mix:1-eE}:{opacity:eE,mix:0}}return{opacity:1,mix:0}}let Us=class Us extends St{constructor(el){let eh={type:"raster-dem",maxzoom:el.transform.maxZoom},ec=new F.D(F.cj(),null),ep=rt("mock-dem",eh,ec,el.style);super("mock-dem",ep,!1),ep.setEventedParent(this),this._sourceLoaded=!0}_loadTile(F,el){F.state="loaded",el(null)}};let Vs=class Vs extends St{constructor(el){let eh=rt("proxy",{type:"geojson",maxzoom:el.transform.maxZoom},new F.D(F.cj(),null),el.style);super("proxy",eh,!1),eh.setEventedParent(this),this.map=this.getSource().map=el,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(F,el,eh){if(F.freezeTileCoverage)return;this.transform=F;let ec=F.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((el,eh)=>{if(el[eh.key]="",!this._tiles[eh.key]){let el=new bt(eh,this._source.tileSize*eh.overscaleFactor(),F.tileZoom);el.state="loaded",this._tiles[eh.key]=el}return el},{});for(let F in this._tiles)F in ec||(this.freeFBO(F),this._tiles[F].unloadVectorData(),delete this._tiles[F])}freeFBO(F){let el=this.proxyCachedFBO[F];if(void 0!==el){let eh=Object.values(el);this.renderCachePool.push(...eh),delete this.proxyCachedFBO[F]}}deallocRenderCache(){this.renderCache.forEach(F=>F.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}};let Gs=class Gs extends F.aH{constructor(F,el,eh){super(F.overscaledZ,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y),this.proxyTileKey=el,this.projMatrix=eh}};let js=class js extends F.cK{constructor(el,eh){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},el.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),el.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),el.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=el,this.terrainTileForTile={},this.prevTerrainTileForTile={};let[ec,ep,e_]=function(el){let eh=new F.b5,ec=new F.aV;eh.reserve(17161),ec.reserve(33800);let ep=F.ai/128,e_=F.ai+ep/2,eg=e_+ep;for(let el=-ep;el<eg;el+=ep)for(let ec=-ep;ec<eg;ec+=ep){let ep=ec<0||ec>e_||el<0||el>e_?24575:0,eg=F.ay(Math.round(ec),0,F.ai),ey=F.ay(Math.round(el),0,F.ai);eh.emplaceBack(eg+ep,ey)}let l=(F,el)=>{let eh=131*el+F;ec.emplaceBack(eh+1,eh,eh+131),ec.emplaceBack(eh+131,eh+131+1,eh+1)};for(let F=1;F<129;F++)for(let el=1;el<129;el++)l(el,F);return[0,129].forEach(F=>{for(let el=0;el<130;el++)l(el,F),l(F,el)}),[eh,ec,32768]}(),eg=el.context;this.gridBuffer=eg.createVertexBuffer(ec,F.b7.members),this.gridIndexBuffer=eg.createIndexBuffer(ep),this.gridSegments=F.b8.simpleSegment(0,0,ec.length,ep.length),this.gridNoSkirtSegments=F.b8.simpleSegment(0,0,ec.length,e_),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Vs(eh.map),this.orthoMatrix=F.ad.mat4.create(),F.ad.mat4.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,F.ai,0,F.ai,0,1);let ey=eg.gl;this._overlapStencilMode=new Ui({func:ey.GEQUAL,mask:255},0,255,ey.KEEP,ey.KEEP,ey.REPLACE),this._previousZoom=el.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=eh,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Us(eh.map),this._pendingGroundEffectLayers=[]}set style(F){F.on("data",this._onStyleDataEvent.bind(this)),this._style=F,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(el,eh,ec){if(el&&el.terrain){this._style!==el&&(this.style=el,this._evaluationZoom=void 0);let ep=el.terrain.properties,e_=0===el.terrain.drapeRenderMode,eg=el.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=F.q.now();let ey=el.terrain&&el.terrain.scope,eb=ep.get("source"),ew=e_?this._mockSourceCache:el.getSourceCache(eb,ey);if(!ew)return void F.w(`Couldn't find terrain source "${eb}".`);if(this.sourceCache=ew,this._attenuationRange=el.terrain.getAttenuationRange(),this._exaggeration=eg?this.calculateExaggeration(eh):ep.get("exaggeration"),!eh.projection.requiresDraping&&eg&&0===this._exaggeration)return void this._disable();this.enabled=!0;let h=()=>{this.sourceCache.used&&F.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);let el=this.getScaledDemTileSize();this.sourceCache.update(eh,el,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,h(),this._initializing=!0),h(),eh.updateElevation(!0,ec),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(eh),this._emptyDEMTextureDirty=!0,this._previousZoom=eh.zoom}else this._disable()}calculateExaggeration(el){if(this._attenuationRange&&el.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(el.zoom);let eh=this._previousCameraAltitude,ec=el.getFreeCameraOptions().position.z/el.pixelsPerMeter*el.worldSize;this._previousCameraAltitude=ec;let ep=null!=eh?ec-eh:Number.MAX_VALUE;if(2>Math.abs(ep))return this._exaggeration;let e_=el.zoom,eg=this._style.terrain;if(!this._previousUpdateTimestamp)return eg.getExaggeration(e_);let ey=e_-this._previousZoom,eb=this._previousUpdateTimestamp,ew=e_;null!=this._evaluationZoom&&(Math.abs(e_-(ew=this._evaluationZoom))>.5&&(ey=.5*(e_-ew+ey)),ey*ep<0&&(ew+=ey)),this._evaluationZoom=ew;let eT=eg.getExaggeration(ew),eS=eT===eg.getExaggeration(Math.max(0,ew-.1));if(eS&&.01>Math.abs(eT-this._exaggeration))return eT;let eE=Math.min(.1,.00375*(this._updateTimestamp-eb));return(eS||eT<.1||1e-4>Math.abs(ey))&&(eE=Math.min(.2,4*eE)),F.ah(this._exaggeration,eT,eE)}resetTileLookupCache(F){this._findCoveringTileCache[F]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(F){F.coord&&"source"===F.dataType?this._clearRenderCacheForTile(F.sourceCacheId,F.coord):"style"===F.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(let F in this._style._mergedSourceCaches)this._style._mergedSourceCaches[F].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(F=>F.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){let F=2*this.proxySourceCache.getSource().tileSize;return[F,F]}set useVertexMorphing(F){this._useVertexMorphing=F}updateTileBinding(el){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;let eh=this.proxySourceCache,ec=this.painter.transform;this._initializing&&(this._initializing=0===ec._centerAltitude&&-1===this.getAtPointOrZero(F.ac.fromLngLat(ec.center),-1),this._emptyDEMTextureDirty=!this._initializing);let ep=this.proxyCoords=eh.getIds().map(F=>{let el=eh.getTileByID(F).tileID;return el.projMatrix=ec.calculateProjMatrix(el.toUnwrapped()),el});!function(el,eh){let ec=eh.transform.pointCoordinate(eh.transform.getCameraPoint()),ep=new F.P(ec.x,ec.y);el.sort((el,eh)=>{if(eh.overscaledZ-el.overscaledZ)return eh.overscaledZ-el.overscaledZ;let ec=new F.P(el.canonical.x+(1<<el.canonical.z)*el.wrap,el.canonical.y),e_=new F.P(eh.canonical.x+(1<<eh.canonical.z)*eh.wrap,eh.canonical.y),eg=ep.mult(1<<el.canonical.z);return eg.x-=.5,eg.y-=.5,eg.distSqr(ec)-eg.distSqr(e_)})}(ep,this.painter);let e_=this.proxyToSource||{};this.proxyToSource={},ep.forEach(F=>{this.proxyToSource[F.key]={}}),this.terrainTileForTile={};let eg=this._style._mergedSourceCaches;for(let F in eg){let eh=eg[F];if(!eh.used||(eh!==this.sourceCache&&this.resetTileLookupCache(eh.id),this._setupProxiedCoordsForOrtho(eh,el[F],e_),eh.usedForTerrain))continue;let ec=el[F];eh.getSource().reparseOverscaled&&this._assignTerrainTiles(ec)}this.proxiedCoords[eh.id]=ep.map(F=>new Gs(F,F.key,this.orthoMatrix)),this._assignTerrainTiles(ep),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(e_),this.renderingToTexture=!1;let ey={};for(let F of(this._visibleDemTiles=[],this.proxyCoords)){let el=this.terrainTileForTile[F.key];if(!el)continue;let eh=el.tileID.key;eh in ey||(this._visibleDemTiles.push(el),ey[eh]=eh)}}_assignTerrainTiles(F){this._initializing||F.forEach(F=>{if(this.terrainTileForTile[F.key])return;let el=this._findTileCoveringTileID(F,this.sourceCache);el&&(this.terrainTileForTile[F.key]=el)})}_prepareDEMTextures(){let F=this.painter.context,el=F.gl;for(let eh in this.terrainTileForTile){let ec=this.terrainTileForTile[eh],ep=ec.dem;ep&&(!ec.demTexture||ec.needsDEMTextureUpload)&&(F.activeTexture.set(el.TEXTURE1),Zo(this.painter,ec,ep))}}_prepareDemTileUniforms(F,el,eh,ec){if(!el||null==el.demTexture)return!1;let ep=F.tileID.canonical,e_=Math.pow(2,el.tileID.canonical.z-ep.z),eg=ec||"";return eh[`u_dem_tl${eg}`]=[ep.x*e_%1,ep.y*e_%1],eh[`u_dem_scale${eg}`]=e_,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let F=0,el=this._visibleDemTiles.reduce((el,eh)=>{if(!eh.dem)return el;let ec=eh.dem.tree.minimums[0];return ec>0&&F++,el+ec},0);return F?el/F:0}_updateEmptyDEMTexture(){let el=this.painter.context,eh=el.gl;el.activeTexture.set(eh.TEXTURE2);let ec=this._getLoadedAreaMinimum(),ep=new F.cL({width:1,height:1},new Float32Array([ec]));this._emptyDEMTextureDirty=!1;let e_=this._emptyDEMTexture;return e_?e_.update(ep,{premultiply:!1}):e_=this._emptyDEMTexture=new F.T(el,ep,eh.R32F,{premultiply:!1}),e_}setupElevationDraw(el,eh,ec){var ep;let e_=this.painter.context,eg=e_.gl,ey={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-.0001,u_exaggeration:0};ey.u_exaggeration=this.exaggeration();let eb=null,ew=null,eT=1;if(ec&&ec.morphing&&this._useVertexMorphing){let F=ec.morphing.srcDemTile,eh=ec.morphing.dstDemTile;eT=ec.morphing.phase,F&&eh&&(this._prepareDemTileUniforms(el,F,ey,"_prev")&&(ew=F),this._prepareDemTileUniforms(el,eh,ey)&&(eb=eh))}let h=F=>F&&F.demTexture&&this.painter.linearFloatFilteringSupported()?eg.LINEAR:eg.NEAREST,eS=null;if(this.enabled?ew&&eb?(eS=eb.demTexture,e_.activeTexture.set(eg.TEXTURE4),ew.demTexture.bind(h(ew),eg.CLAMP_TO_EDGE),ey.u_dem_lerp=eT):(eb=this.terrainTileForTile[el.tileID.key],eS=this._prepareDemTileUniforms(el,eb,ey)?eb.demTexture:this.emptyDEMTexture):eS=this.emptyDEMTexture,e_.activeTexture.set(eg.TEXTURE2),eS&&(ey.u_dem_size=1===(ep=eS).size[0]?1:ep.size[0]-2,eS.bind(h(eb),eg.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(ec&&ec.useDepthForOcclusion,eh,ey),ec&&ec.useMeterToDem&&eb){let el=(1<<eb.tileID.canonical.z)*F.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;ey.u_meter_to_dem=el}if(ec&&ec.labelPlaneMatrixInv&&(ey.u_label_plane_matrix_inv=ec.labelPlaneMatrixInv),eh.setTerrainUniformValues(e_,ey),"globe"===this.painter.transform.projection.name){let F=this.globeUniformValues(this.painter.transform,el.tileID.canonical,ec&&ec.useDenormalizedUpVectorScale);eh.setGlobeUniformValues(e_,F)}}globeUniformValues(el,eh,ec){let ep=el.projection;return{u_tile_tl_up:ep.upVector(eh,0,0),u_tile_tr_up:ep.upVector(eh,F.ai,0),u_tile_br_up:ep.upVector(eh,F.ai,F.ai),u_tile_bl_up:ep.upVector(eh,0,F.ai),u_tile_up_scale:ec?F.cM(1):ep.upVectorScale(eh,el.center.lat,el.worldSize).metersToTile}}renderToBackBuffer(el){let eh=this.painter,ec=this.painter.context;0!==el.length&&(ec.bindFramebuffer.set(null),ec.viewport.set([0,0,eh.width,eh.height]),eh.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(el,eh,ec,ep,e_){if("globe"===el.transform.projection.name)!function(el,eh,ec,ep,e_){let eg,ey;let eb=el.context,ew=eb.gl,eT=el.transform,eS=F.cD(el,eb,eT),u=(F,eh)=>{if(ey===eh)return;let ec=[tk[eh],"PROJECTION_GLOBE_VIEW"];eS&&ec.push("CUSTOM_ANTIALIASING");let ep=el.isTileAffectedByFog(F);eg=el.getOrCreateProgram("globeRaster",{defines:ec,overrideFog:ep}),ey=eh},eE=el.colorModeForRenderPass(),eM=new Bi(ew.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D);tO.update(e_);let eI=F.cE(eT),eA=[F.av(eT.center.lng),F.aC(eT.center.lat)],eC=el.globeSharedBuffers,eP=[eT.width*F.q.devicePixelRatio,eT.height*F.q.devicePixelRatio],ez=Float32Array.from(eT.globeMatrix),eD={useDenormalizedUpVectorScale:!0};{let eT=el.transform,eS=Fs(eT.zoom,eh.exaggeration(),eh.sourceCache._source.tileSize);ey=-1;let eR=ew.TRIANGLES;for(let ey of ep){let ep=ec.getTile(ey),eL=Ui.disabled,eO=eh.prevTerrainTileForTile[ey.key],ek=eh.terrainTileForTile[ey.key];Ps(eO,ek)&&tO.newMorphing(ey.key,eO,ek,e_,250),eb.activeTexture.set(ew.TEXTURE0),ep.texture&&ep.texture.bind(ew.LINEAR,ew.CLAMP_TO_EDGE);let eF=tO.getMorphValuesForProxy(ey.key),eB=eF?1:0;eF&&F.L(eD,{morphing:{srcDemTile:eF.from,dstDemTile:eF.to,phase:F.cC(eF.phase)}});let eN=F.cF(ey.canonical),eV=F.cG(eN.getCenter().lat),eU=F.cH(ey.canonical,eN,eV,eT.worldSize/eT._pixelsPerMercatorPixel),ej=F.bc(F.cI(ey.canonical)),eG=Ms(eT.expandedFarZProjMatrix,ez,eI,ej,F.ag(eT.zoom),eA,eT.frustumCorners.TL,eT.frustumCorners.TR,eT.frustumCorners.BR,eT.frustumCorners.BL,eT.globeCenterInViewSpace,eT.globeRadius,eP,eS,eT._farZ,eU);if(u(ey,eB),eg&&(eh.setupElevationDraw(ep,eg,eD),el.uploadCommonUniforms(eb,eg,ey.toUnwrapped()),eC)){let[F,eh,ec]=eC.getGridBuffers(eV,0!==eS);eg.draw(el,eR,eM,eL,eE,ji.backCCW,eG,"globe_raster",F,eh,ec)}}}if(eC&&(el.renderDefaultNorthPole||el.renderDefaultSouthPole)){let e_=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];for(let ey of(eS&&e_.push("CUSTOM_ANTIALIASING"),eg=el.getOrCreateProgram("globeRaster",{defines:e_}),ep)){let{x:ep,y:e_,z:eS}=ey.canonical,eI=0===e_,ez=e_===(1<<eS)-1,[eR,eL,eO,ek]=eC.getPoleBuffers(eS,!1);if(ek&&(eI||ez)){let e_=ec.getTile(ey);eb.activeTexture.set(ew.TEXTURE0),e_.texture&&e_.texture.bind(ew.LINEAR,ew.CLAMP_TO_EDGE);let eC=F.cJ(eS,ep,eT),eF=F.bc(F.cI(ey.canonical)),S=(F,eh)=>F.draw(el,ew.TRIANGLES,eM,Ui.disabled,eE,ji.disabled,Ms(eT.expandedFarZProjMatrix,eC,eC,eF,0,eA,eT.frustumCorners.TL,eT.frustumCorners.TR,eT.frustumCorners.BR,eT.frustumCorners.BL,eT.globeCenterInViewSpace,eT.globeRadius,eP,0,eT._farZ),"globe_pole_raster",eh,eO,ek);eh.setupElevationDraw(e_,eg,eD),el.uploadCommonUniforms(eb,eg,ey.toUnwrapped()),eI&&el.renderDefaultNorthPole&&S(eg,eR),ez&&el.renderDefaultSouthPole&&(eC=F.ad.mat4.scale(F.ad.mat4.create(),eC,[1,-1,1]),S(eg,eL))}}}}(el,eh,ec,ep,e_);else{let eg,ey;let eb=el.context,ew=eb.gl,eT=el.shadowRenderer,eS=Qi(el,el.longestCutoffRange),u=F=>{if(ey===F)return;let eh=[];eh.push(tk[F]),eS.shouldRenderCutoff&&eh.push("RENDER_CUTOFF"),eT&&(eh.push("RENDER_SHADOWS","DEPTH_TEXTURE"),eT.useNormalOffset&&eh.push("NORMAL_OFFSET")),eg=el.getOrCreateProgram("terrainRaster",{defines:eh}),ey=F},eE=el.colorModeForRenderPass(),eM=new Bi(ew.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D);tO.update(e_);let eI=el.transform,eA=Fs(eI.zoom,eh.exaggeration(),eh.sourceCache._source.tileSize),eC=[0,0,0];if(eT){let F=el.style.directionalLight,eh=el.style.ambientLight;F&&eh&&(eC=no(el.style,F,eh))}{ey=-1;let eP=ew.TRIANGLES,[ez,eD]=[eh.gridIndexBuffer,eh.gridSegments];for(let ey of ep){let ep;let eR=ec.getTile(ey),eL=Ui.disabled,eO=eh.prevTerrainTileForTile[ey.key],ek=eh.terrainTileForTile[ey.key];Ps(eO,ek)&&tO.newMorphing(ey.key,eO,ek,e_,250),eb.activeTexture.set(ew.TEXTURE0),eR.texture&&eR.texture.bind(ew.LINEAR,ew.CLAMP_TO_EDGE);let eF=tO.getMorphValuesForProxy(ey.key),eB=eF?1:0;eF&&(ep={morphing:{srcDemTile:eF.from,dstDemTile:eF.to,phase:F.cC(eF.phase)}});let eN=Ls(ey.projMatrix,!function(F,el){let eh=1<<F.z;return!el&&(0===F.x||F.x===eh-1)||0===F.y||F.y===eh-1}(ey.canonical,eI.renderWorldCopies)?eA:eA/10,eC);if(u(eB),!eg)continue;eh.setupElevationDraw(eR,eg,ep);let eV=ey.toUnwrapped();eT&&eT.setupShadows(eV,eg),el.uploadCommonUniforms(eb,eg,eV,null,eS),eg.draw(el,eP,eM,eL,eE,ji.backCCW,eN,"terrain_raster",eh.gridBuffer,ez,eD)}}}}(eh,this,this.proxySourceCache,el,this._updateTimestamp),this.renderingToTexture=!0,eh.gpuTimingDeferredRenderEnd(),el.splice(0,el.length))}renderBatch(el){if(0===this._drapedRenderBatches.length)return el+1;this.renderingToTexture=!0;let eh=this.painter,ec=this.painter.context,ep=this.proxySourceCache,e_=this.proxiedCoords[ep.id],eg=this._drapedRenderBatches.shift(),ey=eh.style.order,eb=[],ew=0;for(let eT of e_){let e_;let eS=ep.getTileByID(eT.proxyTileKey),eE=ep.proxyCachedFBO[eT.key]?ep.proxyCachedFBO[eT.key][el]:void 0,eM=void 0!==eE?ep.renderCache[eE]:this.pool[ew++],eI=void 0!==eE;if(eS.texture=eM.tex,eI&&!eM.dirty){eb.push(eS.tileID);continue}ec.bindFramebuffer.set(eM.fb.framebuffer),this.renderedToTile=!1,eM.dirty&&(ec.clear({color:F.al.transparent,stencil:0}),eM.dirty=!1);for(let F=eg.start;F<=eg.end;++F){let el=eh.style._mergedLayers[ey[F]];if(el.isHidden(eh.transform.zoom))continue;let ep=eh.style.getLayerSourceCache(el),eg=ep?this.proxyToSource[eT.key][ep.id]:[eT];eg&&(ec.viewport.set([0,0,eM.fb.width,eM.fb.height]),e_!==(ep?ep.id:null)&&(this._setupStencil(eM,eg,el,ep),e_=ep?ep.id:null),eh.renderLayer(eh,ep,el,eg))}if(0===this._drapedRenderBatches.length)for(let F of this._pendingGroundEffectLayers){let el=eh.style._mergedLayers[ey[F]];if(el.isHidden(eh.transform.zoom))continue;let ep=eh.style.getLayerSourceCache(el),eg=ep?this.proxyToSource[eT.key][ep.id]:[eT];eg&&(ec.viewport.set([0,0,eM.fb.width,eM.fb.height]),e_!==(ep?ep.id:null)&&(this._setupStencil(eM,eg,el,ep),e_=ep?ep.id:null),eh.renderLayer(eh,ep,el,eg))}this.renderedToTile?(eM.dirty=!0,eb.push(eS.tileID)):eI||--ew,5===ew&&(ew=0,this.renderToBackBuffer(eb))}return this.renderToBackBuffer(eb),this.renderingToTexture=!1,ec.bindFramebuffer.set(null),ec.viewport.set([0,0,eh.width,eh.height]),eg.end+1}postRender(){}isLayerOrderingCorrect(F){let el=F.order.length,eh=-1,ec=el;for(let ep=0;ep<el;++ep)this._style.isLayerDraped(F._mergedLayers[F.order[ep]])?eh=Math.max(eh,ep):ec=Math.min(ec,ep);return ec>eh}getMinElevationBelowMSL(){let F=0;return this._visibleDemTiles.filter(F=>F.dem).forEach(el=>{F=Math.min(F,el.dem.tree.minimums[0])}),0===F?F:(F-30)*this._exaggeration}raycast(F,el,eh){if(!this._visibleDemTiles)return null;let ec=this._visibleDemTiles.filter(F=>F.dem).map(ec=>{let ep=ec.tileID,e_=1<<ep.overscaledZ,{x:eg,y:ey}=ep.canonical,eb=eg/e_,ew=(eg+1)/e_,eT=ey/e_,eS=(ey+1)/e_;return{minx:eb,miny:eT,maxx:ew,maxy:eS,t:ec.dem.tree.raycastRoot(eb,eT,ew,eS,F,el,eh),tile:ec}});for(let ep of(ec.sort((F,el)=>(null!==F.t?F.t:Number.MAX_VALUE)-(null!==el.t?el.t:Number.MAX_VALUE)),ec)){if(null==ep.t)break;let ec=ep.tile.dem.tree.raycast(ep.minx,ep.miny,ep.maxx,ep.maxy,F,el,eh);if(null!=ec)return ec}return null}_createFBO(){let el=this.painter.context,eh=el.gl,ec=this.drapeBufferSize;el.activeTexture.set(eh.TEXTURE0);let ep=new F.T(el,{width:ec[0],height:ec[1],data:null},eh.RGBA8);ep.bind(eh.LINEAR,eh.CLAMP_TO_EDGE);let e_=el.createFramebuffer(ec[0],ec[1],!0,null);return e_.colorAttachment.set(ep.texture),e_.depthAttachment=new As(el,e_.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=el.createRenderbuffer(el.gl.DEPTH_STENCIL,ec[0],ec[1]),this._stencilRef=0,e_.depthAttachment.set(this._sharedDepthStencil),el.clear({stencil:0})):e_.depthAttachment.set(this._sharedDepthStencil),el.extTextureFilterAnisotropic&&eh.texParameterf(eh.TEXTURE_2D,el.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,el.extTextureFilterAnisotropicMax),{fb:e_,tex:ep,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(let F in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[F].hasTransition())return!0;return this._style.order.some(F=>{let el=this._style._mergedLayers[F],eh=el.isHidden(this.painter.transform.zoom);return"hillshade"===el.type||"custom"===el.type?!eh&&el.shouldRedrape():!eh&&el.hasTransition()})}_clearLineLayersFromRenderCache(){let el=!1;for(let F of this._style.getSources())if(F instanceof tt){el=!0;break}if(!el)return;let eh={};for(let el=0;el<this._style.order.length;++el){let ec=this._style._mergedLayers[this._style.order[el]],ep=this._style.getLayerSourceCache(ec);if(ep&&!eh[ep.id]&&!ec.isHidden(this.painter.transform.zoom)&&"line"===ec.type&&ec.widthExpression() instanceof F.ab)for(let F of(eh[ep.id]=!0,this.proxyCoords)){let el=this.proxyToSource[F.key][ep.id];if(el)for(let F of el)this._clearRenderCacheForTile(ep.id,F)}}}_clearRasterLayersFromRenderCache(){let F=!1;for(let el in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[el]._source instanceof it){F=!0;break}if(!F)return;let el={};for(let F=0;F<this._style.order.length;++F){let eh=this._style._mergedLayers[this._style.order[F]],ec=this._style.getLayerSourceCache(eh);if(!ec||el[ec.id]||eh.isHidden(this.painter.transform.zoom)||"raster"!==eh.type)continue;let ep=eh.paint.get("raster-fade-duration");for(let F of this.proxyCoords){let el=this.proxyToSource[F.key][ec.id];if(el)for(let F of el){let el=Ns(ec.getTile(F),ec.findLoadedParent(F,0),ec,this.painter.transform,ep);(1!==el.opacity||0!==el.mix)&&this._clearRenderCacheForTile(ec.id,F)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();let el=this._style.order,eh=el.length;if(0===eh)return;let ec=[];this._pendingGroundEffectLayers=[];let ep,e_=0,eg=this._style._mergedLayers[el[e_]];for(;!this._style.isLayerDraped(eg)&&eg.isHidden(this.painter.transform.zoom)&&++e_<eh;)eg=this._style._mergedLayers[el[e_]];for(;e_<eh;++e_){let F=this._style._mergedLayers[el[e_]];F.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(F)?void 0===ep&&(ep=e_):("fill-extrusion"===F.type&&this._pendingGroundEffectLayers.push(e_),void 0!==ep&&(ec.push({start:ep,end:e_-1}),ep=void 0)))}if(void 0!==ep&&ec.push({start:ep,end:e_-1}),0!==ec.length){let el=ec[ec.length-1];this._pendingGroundEffectLayers.every(F=>F>el.end)||F.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=ec}_setupRenderCache(F){let el=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,el.renderCache.length>el.renderCachePool.length){let F=Object.values(el.proxyCachedFBO);el.proxyCachedFBO={};for(let eh=0;eh<F.length;++eh){let ec=Object.values(F[eh]);el.renderCachePool.push(...ec)}}return}this._clearRasterLayersFromRenderCache();let eh=this.proxyCoords,ec=this._tilesDirty;for(let ep=eh.length-1;ep>=0;ep--){let e_=eh[ep];if(el.getTileByID(e_.key),void 0!==el.proxyCachedFBO[e_.key]){let eh=F[e_.key],ep=this.proxyToSource[e_.key],eg=0;for(let F in ep){let el=ep[F],e_=eh[F];if(!e_||e_.length!==el.length||el.some((el,eh)=>el!==e_[eh]||ec[F]&&ec[F].hasOwnProperty(el.key))){eg=-1;break}++eg}for(let F in el.proxyCachedFBO[e_.key])el.renderCache[el.proxyCachedFBO[e_.key][F]].dirty=eg<0||eg!==Object.values(eh).length}}let ep=[...this._drapedRenderBatches];for(let F of(ep.sort((F,el)=>el.end-el.start-(F.end-F.start)),ep))for(let ec of eh){if(el.proxyCachedFBO[ec.key])continue;let eh=el.renderCachePool.pop();void 0===eh&&el.renderCache.length<50&&(eh=el.renderCache.length,el.renderCache.push(this._createFBO())),void 0!==eh&&(el.proxyCachedFBO[ec.key]={},el.proxyCachedFBO[ec.key][F.start]=eh,el.renderCache[eh].dirty=!0)}this._tilesDirty={}}_setupStencil(F,el,eh,ec){let ep;if(!ec||!this._sourceTilesOverlap[ec.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));let e_=this.painter.context,eg=e_.gl;if(el.length<=1)return void(this._overlapStencilType=!1);if(eh.isTileClipped())ep=el.length,this._overlapStencilMode.test={func:eg.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(el[0].overscaledZ>el[el.length-1].overscaledZ))return void(this._overlapStencilType=!1);ep=1,this._overlapStencilMode.test={func:eg.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+ep>255&&(e_.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=ep,this._overlapStencilMode.ref=this._stencilRef,eh.isTileClipped()&&this._renderTileClippingMasks(el,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(F){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[F.key]),this._overlapStencilMode):Ui.disabled}_renderTileClippingMasks(F,el){let eh=this.painter,ec=this.painter.context,ep=ec.gl;eh._tileClippingMaskIDs={},ec.setColorMode(ki.disabled),ec.setDepthMode(Bi.disabled);let e_=eh.getOrCreateProgram("clippingMask");for(let ec of F){let F=eh._tileClippingMaskIDs[ec.key]=--el;e_.draw(eh,ep.TRIANGLES,Bi.disabled,new Ui({func:ep.ALWAYS,mask:0},F,255,ep.KEEP,ep.KEEP,ep.REPLACE),ki.disabled,ji.disabled,Bs(ec.projMatrix),"$clipping",eh.tileExtentBuffer,eh.quadTriangleIndexBuffer,eh.tileExtentSegments)}}pointCoordinate(el){let eh=this.painter.transform;if(el.x<0||el.x>eh.width||el.y<0||el.y>eh.height)return null;let ec=[el.x,el.y,1,1];F.ad.vec4.transformMat4(ec,ec,eh.pixelMatrixInverse),F.ad.vec4.scale(ec,ec,1/ec[3]),ec[0]/=eh.worldSize,ec[1]/=eh.worldSize;let ep=eh._camera.position,e_=F.bH(1,eh.center.lat),eg=[ep[0],ep[1],ep[2]/e_,0],ey=F.ad.vec3.subtract([],ec.slice(0,3),eg);F.ad.vec3.normalize(ey,ey);let eb=this.raycast(eg,ey,this._exaggeration);return null!==eb&&eb?(F.ad.vec3.scaleAndAdd(eg,eg,ey,eb),eg[3]=eg[2],eg[2]*=e_,eg):null}_setupProxiedCoordsForOrtho(el,eh,ec){if(el.getSource() instanceof F.aK)return this._setupProxiedCoordsForImageSource(el,eh,ec);this._findCoveringTileCache[el.id]=this._findCoveringTileCache[el.id]||{};let ep=this.proxiedCoords[el.id]=[],e_=this.proxyCoords;for(let F=0;F<e_.length;F++){let eh=e_[F],eg=this._findTileCoveringTileID(eh,el);if(eg){let F=this._createProxiedId(eh,eg,ec[eh.key]&&ec[eh.key][el.id]);ep.push(F),this.proxyToSource[eh.key][el.id]=[F]}}let eg=!1,ey=new Set;for(let F=0;F<eh.length;F++){let e_=el.getTile(eh[F]);if(!e_||!e_.hasData())continue;let eb=this._findTileCoveringTileID(e_.tileID,this.proxySourceCache);if(eb&&eb.tileID.canonical.z!==e_.tileID.canonical.z){let F=this.proxyToSource[eb.tileID.key][el.id],eh=this._createProxiedId(eb.tileID,e_,ec[eb.tileID.key]&&ec[eb.tileID.key][el.id]);F?F.splice(F.length-1,0,eh):this.proxyToSource[eb.tileID.key][el.id]=[eh];let ew=this.proxyToSource[eb.tileID.key][el.id];ey.has(ew)||ey.add(ew),ep.push(eh),eg=!0}}if(this._sourceTilesOverlap[el.id]=eg,eg&&this._debugParams.sortTilesHiZFirst)for(let F of ey)F.sort((F,el)=>el.overscaledZ-F.overscaledZ)}_setupProxiedCoordsForImageSource(el,eh,ec){if(!el.getSource().loaded())return;let ep=this.proxiedCoords[el.id]=[],e_=this.proxyCoords,eg=el.getSource(),ey=eg.tileID;if(!ey)return;let eb=new F.P(ey.x,ey.y)._div(1<<ey.z),ew=eg.coordinates.map(F.ac.fromLngLat).reduce((F,el)=>(F.min.x=Math.min(F.min.x,el.x-eb.x),F.min.y=Math.min(F.min.y,el.y-eb.y),F.max.x=Math.max(F.max.x,el.x-eb.x),F.max.y=Math.max(F.max.y,el.y-eb.y),F),{min:new F.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new F.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),h=(el,eh)=>{let ec=el.wrap+el.canonical.x/(1<<el.canonical.z),ep=el.canonical.y/(1<<el.canonical.z),e_=F.ai/(1<<el.canonical.z),eg=eh.wrap+eh.canonical.x/(1<<eh.canonical.z),ey=eh.canonical.y/(1<<eh.canonical.z);return ec+e_<eg+ew.min.x||ec>eg+ew.max.x||ep+e_<ey+ew.min.y||ep>ey+ew.max.y};for(let F=0;F<e_.length;F++){let eg=e_[F];for(let F=0;F<eh.length;F++){let e_=el.getTile(eh[F]);if(!e_||!e_.hasData()||h(eg,e_.tileID))continue;let ey=this._createProxiedId(eg,e_,ec[eg.key]&&ec[eg.key][el.id]),eb=this.proxyToSource[eg.key][el.id];eb?eb.push(ey):this.proxyToSource[eg.key][el.id]=[ey],ep.push(ey)}}}_createProxiedId(el,eh,ec){let ep=this.orthoMatrix;if(ec){let F=ec.find(F=>F.key===eh.tileID.key);if(F)return F}if(eh.tileID.key!==el.key){let ec,e_,eg;let ey=el.canonical.z-eh.tileID.canonical.z;ep=F.ad.mat4.create();let eb=eh.tileID.wrap-el.wrap<<el.overscaledZ;ey>0?(e_=(ec=F.ai>>ey)*((eh.tileID.canonical.x<<ey)-el.canonical.x+eb),eg=ec*((eh.tileID.canonical.y<<ey)-el.canonical.y)):(ec=F.ai<<-ey,e_=F.ai*(eh.tileID.canonical.x-(el.canonical.x+eb<<-ey)),eg=F.ai*(eh.tileID.canonical.y-(el.canonical.y<<-ey))),F.ad.mat4.ortho(ep,0,ec,0,ec,0,1),F.ad.mat4.translate(ep,ep,[e_,eg,0])}return new Gs(eh.tileID,el.key,ep)}_findTileCoveringTileID(el,eh){let ec=eh.getTile(el);if(ec&&ec.hasData())return ec;let ep=this._findCoveringTileCache[eh.id],e_=ep[el.key];if((ec=e_?eh.getTileByID(e_):null)&&ec.hasData()||null===e_)return ec;let eg=ec?ec.tileID:el,ey=eg.overscaledZ,eb=eh.getSource().minzoom,ew=[];if(!e_){let ep=eh.getSource().maxzoom;if(el.canonical.z>=ep){let ec=el.canonical.z-ep;eh.getSource().reparseOverscaled?(ey=Math.max(el.canonical.z+2,eh.transform.tileZoom),eg=new F.aH(ey,el.wrap,ep,el.canonical.x>>ec,el.canonical.y>>ec)):0!==ec&&(ey=ep,eg=new F.aH(ey,el.wrap,ep,el.canonical.x>>ec,el.canonical.y>>ec))}eg.key!==el.key&&(ew.push(eg.key),ec=eh.getTile(eg))}let h=F=>{ew.forEach(el=>{ep[el]=F}),ew.length=0};for(ey-=1;ey>=eb&&(!ec||!ec.hasData());ey--){ec&&h(ec.tileID.key);let F=eg.calculateScaledKey(ey);if((ec=eh.getTileByID(F))&&ec.hasData())break;let el=ep[F];if(null===el)break;void 0===el?ew.push(F):ec=eh.getTileByID(el)}return h(ec?ec.tileID.key:null),ec&&ec.hasData()?ec:null}findDEMTileFor(F){return this.enabled?this._findTileCoveringTileID(F,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(F,el){let eh=this._tilesDirty[F];eh||(eh=this._tilesDirty[F]={}),eh[el.key]=!0}};let tF=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],tB=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];let Ws=class Ws{static cacheKey(F,el,eh,ec){let ep=`${el}${ec?ec.cacheKey:""}`;for(let el of eh)F.usedDefines.includes(el)&&(ep+=`/${el}`);return ep}constructor(el,eh,ec,ep,e_,eg){let ey=el.gl;this.program=ey.createProgram(),this.configuration=ep,this.name=eh,this.fixedDefines=[...eg];let eb=ep?ep.getBinderAttributes():[],ew=(ec.staticAttributes||[]).concat(eb),eT=ep?ep.defines():[];eT=eT.concat(eg.map(F=>`#define ${F}`));let eS="#version 300 es\n",eE=eS+eT.concat("precision mediump float;",tg,tD.fragmentSource).join("\n");for(let F of ec.fragmentIncludes)eE+=`
${tP[F]}`;eE+=`
${ec.fragmentSource}`;let eM=eS+eT.concat("precision highp float;",tg,tD.vertexSource).join("\n");for(let F of ec.vertexIncludes)eM+=`
${tP[F]}`;this.forceManualRenderingForInstanceIDShaders=el.forceManualRenderingForInstanceIDShaders&&-1!==ec.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(eM+="\nuniform int u_instanceID;\n"),eM+=`
${ec.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(eM=eM.replaceAll("gl_InstanceID","u_instanceID"));let eI=ey.createShader(ey.FRAGMENT_SHADER);if(ey.isContextLost())return void(this.failedToCreate=!0);ey.shaderSource(eI,eE),ey.compileShader(eI),ey.attachShader(this.program,eI);let eA=ey.createShader(ey.VERTEX_SHADER);if(ey.isContextLost())this.failedToCreate=!0;else{ey.shaderSource(eA,eM),ey.compileShader(eA),ey.attachShader(this.program,eA),this.attributes={},this.numAttributes=ew.length;for(let F=0;F<this.numAttributes;F++)if(ew[F]){let el=ew[F].startsWith("a_")?ew[F]:`a_${ew[F]}`;ey.bindAttribLocation(this.program,F,el),this.attributes[el]=F}ey.linkProgram(this.program),ey.deleteShader(eA),ey.deleteShader(eI),this.fixedUniforms=e_(el),this.binderUniforms=ep?ep.getUniforms(el):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms={u_instanceID:new F.bN(el)}),(eg.includes("TERRAIN")||-1!==eh.indexOf("symbol")||-1!==eh.indexOf("circle"))&&(this.terrainUniforms={u_dem:new F.bN(el),u_dem_prev:new F.bN(el),u_dem_tl:new F.bK(el),u_dem_scale:new F.bM(el),u_dem_tl_prev:new F.bK(el),u_dem_scale_prev:new F.bM(el),u_dem_size:new F.bM(el),u_dem_lerp:new F.bM(el),u_exaggeration:new F.bM(el),u_depth:new F.bN(el),u_depth_size_inv:new F.bK(el),u_depth_range_unpack:new F.bK(el),u_occluder_half_size:new F.bM(el),u_occlusion_depth_offset:new F.bM(el),u_meter_to_dem:new F.bM(el),u_label_plane_matrix_inv:new F.bJ(el)}),eg.includes("GLOBE")&&(this.globeUniforms={u_tile_tl_up:new F.bL(el),u_tile_tr_up:new F.bL(el),u_tile_br_up:new F.bL(el),u_tile_bl_up:new F.bL(el),u_tile_up_scale:new F.bM(el)}),eg.includes("FOG")&&(this.fogUniforms={u_fog_matrix:new F.bJ(el),u_fog_range:new F.bK(el),u_fog_color:new F.cb(el),u_fog_horizon_blend:new F.bM(el),u_fog_vertical_limit:new F.bK(el),u_fog_temporal_offset:new F.bM(el),u_frustum_tl:new F.bL(el),u_frustum_tr:new F.bL(el),u_frustum_br:new F.bL(el),u_frustum_bl:new F.bL(el),u_globe_pos:new F.bL(el),u_globe_radius:new F.bM(el),u_globe_transition:new F.bM(el),u_is_globe:new F.bN(el),u_viewport:new F.bK(el)}),eg.includes("RENDER_CUTOFF")&&(this.cutoffUniforms={u_cutoff_params:new F.cb(el)}),eg.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms={u_lighting_ambient_color:new F.bL(el),u_lighting_directional_dir:new F.bL(el),u_lighting_directional_color:new F.bL(el),u_ground_radiance:new F.bL(el)}),eg.includes("RENDER_SHADOWS")&&(this.shadowUniforms={u_light_matrix_0:new F.bJ(el),u_light_matrix_1:new F.bJ(el),u_fade_range:new F.bK(el),u_shadow_normal_offset:new F.bL(el),u_shadow_intensity:new F.bM(el),u_shadow_texel_size:new F.bM(el),u_shadow_map_resolution:new F.bM(el),u_shadow_direction:new F.bL(el),u_shadow_bias:new F.bL(el),u_shadowmap_0:new F.bN(el),u_shadowmap_1:new F.bN(el)})}}setTerrainUniformValues(F,el){if(!this.terrainUniforms)return;let eh=this.terrainUniforms;if(!this.failedToCreate)for(let ec in F.program.set(this.program),el)eh[ec]&&eh[ec].set(this.program,ec,el[ec])}setGlobeUniformValues(F,el){if(!this.globeUniforms)return;let eh=this.globeUniforms;if(!this.failedToCreate)for(let ec in F.program.set(this.program),el)eh[ec]&&eh[ec].set(this.program,ec,el[ec])}setFogUniformValues(F,el){if(!this.fogUniforms)return;let eh=this.fogUniforms;if(!this.failedToCreate)for(let ec in F.program.set(this.program),el)eh[ec].set(this.program,ec,el[ec])}setCutoffUniformValues(F,el){if(!this.cutoffUniforms)return;let eh=this.cutoffUniforms;if(!this.failedToCreate)for(let ec in F.program.set(this.program),el)eh[ec].set(this.program,ec,el[ec])}setLightsUniformValues(F,el){if(!this.lightsUniforms)return;let eh=this.lightsUniforms;if(!this.failedToCreate)for(let ec in F.program.set(this.program),el)eh[ec].set(this.program,ec,el[ec])}setShadowUniformValues(F,el){if(this.failedToCreate||!this.shadowUniforms)return;let eh=this.shadowUniforms;for(let ec in F.program.set(this.program),el)eh[ec].set(this.program,ec,el[ec])}_drawDebugWireframe(el,eh,ec,ep,e_,eg,ey,eb,ew,eT){let eS=el.options.wireframe;if(!1===eS.terrain&&!1===eS.layers2D&&!1===eS.layers3D)return;let eE=el.context;if(!(!(!eS.terrain||"terrainRaster"!==this.name&&"globeRaster"!==this.name)||!(!eS.layers2D||el._terrain&&el._terrain.renderingToTexture||!tF.includes(this.name))||!(!eS.layers3D||!tB.includes(this.name))))return;let eM=eE.gl,eI=el.wireframeDebugCache.getLinesFromTrianglesBuffer(el.frameCounter,e_,eE);if(!eI)return;let eA=[...this.fixedDefines];eA.push("DEBUG_WIREFRAME");let eC=el.getOrCreateProgram(this.name,{config:this.configuration,defines:eA});eE.program.set(eC.program);let g=(F,el,eh)=>{if(el[F]&&eh[F])for(let ec in el[F])eh[F][ec]&&eh[F][ec].set(eh.program,ec,el[F][ec].current)};ew&&ew.setUniforms(eC.program,eE,eC.binderUniforms,ey,{zoom:eb}),g("fixedUniforms",this,eC),g("terrainUniforms",this,eC),g("globeUniforms",this,eC),g("fogUniforms",this,eC),g("lightsUniforms",this,eC),g("shadowUniforms",this,eC),eI.bind(),eE.setColorMode(new ki([eM.ONE,eM.ONE_MINUS_SRC_ALPHA,eM.ZERO,eM.ONE],F.al.transparent,[!0,!0,!0,!1])),eE.setDepthMode(new Bi(eh.func===eM.LESS?eM.LEQUAL:eh.func,Bi.ReadOnly,eh.range)),eE.setStencilMode(Ui.disabled);let eP=3*eg.primitiveLength*2,ez=3*eg.primitiveOffset*4;if(this.forceManualRenderingForInstanceIDShaders){let F=eT||1;for(let el=0;el<F;++el)eC.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",el),eM.drawElements(eM.LINES,eP,eM.UNSIGNED_SHORT,ez)}else eT&&eT>1?eM.drawElementsInstanced(eM.LINES,eP,eM.UNSIGNED_SHORT,ez,eT):eM.drawElements(eM.LINES,eP,eM.UNSIGNED_SHORT,ez);e_.bind(),eE.program.set(this.program),eE.setDepthMode(eh),eE.setStencilMode(ec),eE.setColorMode(ep)}checkUniforms(F,el,eh){if(this.fixedDefines.includes(el)){for(let ec of Object.keys(eh))if(!eh[ec].initialized)throw Error(`Program '${this.name}', from draw '${F}': uniform ${ec} not set but required by ${el} being defined`)}}draw(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA){let eC=F.context,eP=eC.gl;if(this.failedToCreate)return;for(let F of(eC.program.set(this.program),eC.setDepthMode(eh),eC.setStencilMode(ec),eC.setColorMode(ep),eC.setCullFace(e_),Object.keys(this.fixedUniforms)))this.fixedUniforms[F].set(this.program,F,eg[F]);eM&&eM.setUniforms(this.program,eC,this.binderUniforms,eS,{zoom:eE});let ez={[eP.POINTS]:1,[eP.LINES]:2,[eP.TRIANGLES]:3,[eP.LINE_STRIP]:1}[el];this.checkUniforms(ey,"RENDER_SHADOWS",this.shadowUniforms);let eD=eA&&eA>0?1:void 0;for(let e_ of eT.get()){let eg=e_.vaos||(e_.vaos={});if((eg[ey]||(eg[ey]=new jo)).bind(eC,this,eb,eM?eM.getPaintVertexBuffers():[],ew,e_.vertexOffset,eI||[],eD),this.forceManualRenderingForInstanceIDShaders){let F=eA||1;for(let eh=0;eh<F;++eh)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",eh),ew?eP.drawElements(el,e_.primitiveLength*ez,eP.UNSIGNED_SHORT,e_.primitiveOffset*ez*2):eP.drawArrays(el,e_.vertexOffset,e_.vertexLength)}else eA&&eA>1?eP.drawElementsInstanced(el,e_.primitiveLength*ez,eP.UNSIGNED_SHORT,e_.primitiveOffset*ez*2,eA):ew?eP.drawElements(el,e_.primitiveLength*ez,eP.UNSIGNED_SHORT,e_.primitiveOffset*ez*2):eP.drawArrays(el,e_.vertexOffset,e_.vertexLength);el===eP.TRIANGLES&&ew&&this._drawDebugWireframe(F,eh,ec,ep,ew,e_,eS,eE,eM,eA)}}};function $s(el,eh){let ec=Math.pow(2,eh.tileID.overscaledZ),ep=eh.tileSize*Math.pow(2,el.transform.tileZoom)/ec,e_=ep*(eh.tileID.canonical.x+eh.tileID.wrap*ec),eg=ep*eh.tileID.canonical.y;return{u_image:0,u_texsize:eh.imageAtlasTexture?eh.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/F.at(eh,1,el.transform.tileZoom),u_pixel_coord_upper:[e_>>16,eg>>16],u_pixel_coord_lower:[65535&e_,65535&eg]}}let tN={terrain:0,flat:1},tV=F.ad.mat4.create(),Ys=(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez)=>{let eD=eh.style.light,eR=eD.properties.get("position"),eL=[eR.x,eR.y,eR.z],eO=F.ad.mat3.create();"viewport"===eD.properties.get("anchor")&&(F.ad.mat3.fromRotation(eO,-eh.transform.angle),F.ad.vec3.transformMat3(eL,eL,eO));let ek=eD.properties.get("color"),eF=eh.transform,eB={u_matrix:el,u_lightpos:eL,u_lightintensity:eD.properties.get("intensity"),u_lightcolor:[ek.r,ek.g,ek.b],u_vertical_gradient:+ec,u_opacity:ep,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:tV,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:tN[eT],u_base_type:tN[eS],u_ao:e_,u_edge_radius:eg,u_width_scale:ey,u_flood_light_color:eA,u_vertical_scale:eC,u_flood_light_intensity:eP,u_ground_shadow_factor:ez};return"globe"===eF.projection.name&&(eB.u_tile_id=[eb.canonical.x,eb.canonical.y,1<<eb.canonical.z],eB.u_zoom_transition=eE,eB.u_inv_rot_matrix=eI,eB.u_merc_center=eM,eB.u_up_dir=eF.projection.upVector(new F.bT(0,0,0),eM[0]*F.ai,eM[1]*F.ai),eB.u_height_lift=ew),eB},Js=(F,el,eh,ec,ep,e_)=>({u_matrix:F,u_edge_radius:el,u_width_scale:eh,u_vertical_scale:ec,u_height_type:tN[ep],u_base_type:tN[e_]}),Qs=(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP)=>{let ez=Ys(el,eh,ec,ep,e_,eg,ey,eb,eT,eS,eE,eM,eI,eA,eC,eP,1,[0,0,0]),eD={u_height_factor:-Math.pow(2,eb.overscaledZ)/ew.tileSize/8};return F.l(ez,$s(eh,ew),eD)},er=(F,el)=>({u_matrix:F,u_emissive_strength:el}),tr=(el,eh,ec,ep)=>F.l(er(el,eh),$s(ec,ep)),ir=(F,el,eh)=>({u_matrix:F,u_world:eh,u_emissive_strength:el}),or=(el,eh,ec,ep,e_)=>F.l(tr(el,eh,ec,ep),{u_world:e_}),sr=(F,el,eh,ec,ep)=>({u_matrix:F,u_camera_pos:[el[0],el[1],el[2]],u_depth_bias:eh,u_height_scale:ec,u_reset_depth:ep}),rr=(el,eh,ec,ep)=>{let e_=F.ai/ec.tileSize;return{u_matrix:el,u_camera_to_center_distance:eh.getCameraToCenterDistance(ep),u_extrude_scale:[eh.pixelsToGLUnits[0]/e_,eh.pixelsToGLUnits[1]/e_]}},nr=(F,el,eh=1)=>({u_matrix:F,u_color:el.toRenderColor(null),u_overlay:0,u_overlay_scale:eh}),tU=F.ad.mat4.create(),lr=(el,eh,ec,ep,e_,eg,ey)=>{let eb=el.transform,ew="globe"===eb.projection.name,eT=ew?F.cO(eb.zoom,eh.canonical)*eb._pixelsPerMercatorPixel:F.at(ec,1,eg),eS={u_matrix:eh.projMatrix,u_extrude_scale:eT,u_intensity:ey,u_inv_rot_matrix:tU,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(ew){eS.u_inv_rot_matrix=ep,eS.u_merc_center=e_,eS.u_tile_id=[eh.canonical.x,eh.canonical.y,1<<eh.canonical.z],eS.u_zoom_transition=F.ag(eb.zoom);let el=e_[0]*F.ai,ec=e_[1]*F.ai;eS.u_up_dir=eb.projection.upVector(new F.bT(0,0,0),el,ec)}return eS};function cr(F,[el,eh,ec,ep],[e_,eg]){if(e_===eg)return[0,0,0,0];let ey=255*(F-1)/(F*(eg-e_));return[el*ey,eh*ey,ec*ey,ep*ey]}function hr(F,el,[eh,ec]){return eh===ec?0:.5/F+(el-eh)*(F-1)/(F*(ec-eh))}let dr=(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL)=>({u_matrix:el,u_normalize_matrix:eh,u_globe_matrix:ec,u_merc_matrix:ep,u_grid_matrix:e_,u_tl_parent:eg,u_scale_parent:eT,u_fade_t:eS.mix,u_opacity:eS.opacity*eE.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:eE.paint.get("raster-brightness-min"),u_brightness_high:eE.paint.get("raster-brightness-max"),u_saturation_factor:F.cP(eE.paint.get("raster-saturation")),u_contrast_factor:F.cQ(eE.paint.get("raster-contrast")),u_spin_weights:function(F){F*=Math.PI/180;let el=Math.sin(F),eh=Math.cos(F);return[(2*eh+1)/3,(-Math.sqrt(3)*el-eh+1)/3,(Math.sqrt(3)*el-eh+1)/3]}(eE.paint.get("raster-hue-rotate")),u_perspective_transform:eM,u_raster_elevation:eI,u_zoom_transition:ey,u_merc_center:eb,u_cutoff_params:ew,u_colorization_mix:cr(F.cR,eC,ez),u_colorization_offset:hr(F.cR,eP,ez),u_color_ramp:eA,u_texture_offset:[eR/(eD+2*eR),eD/(eD+2*eR)],u_texture_res:[eD+2*eR,eD+2*eR],u_emissive_strength:eL}),pr=(F,el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS)=>({u_matrix:F,u_normalize_matrix:el,u_globe_matrix:eh,u_merc_matrix:ec,u_grid_matrix:ep,u_tl_parent:e_,u_scale_parent:ew,u_fade_t:eT.mix,u_opacity:eT.opacity,u_image0:0,u_image1:1,u_raster_elevation:eS,u_zoom_transition:eg,u_merc_center:ey,u_cutoff_params:eb}),fr=(F,el,eh,ec,ep,e_,eg,ey,eb,ew)=>({u_particle_texture:F,u_particle_texture_side_len:el,u_tile_offset:eh,u_velocity:ec,u_color_ramp:e_,u_velocity_res:ep,u_max_speed:eg,u_uv_offset:ey,u_data_scale:[255*eb[0],255*eb[1]],u_data_offset:ew,u_particle_pos_scale:1.1,u_particle_pos_offset:[.05,.05]}),mr=(F,el,eh,ec,ep,e_,eg,ey,eb,ew)=>({u_particle_texture:F,u_particle_texture_side_len:el,u_velocity:eh,u_velocity_res:ec,u_max_speed:ep,u_speed_factor:e_,u_reset_rate:eg,u_rand_seed:Math.random(),u_uv_offset:ey,u_data_scale:[255*eb[0],255*eb[1]],u_data_offset:ew,u_particle_pos_scale:1.1,u_particle_pos_offset:[.05,.05]}),tj=F.ad.mat4.create(),vr=(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD,eR,eL,eO)=>{let ek=e_.transform,eF={u_is_size_zoom_constant:+("constant"===el||"source"===el),u_is_size_feature_constant:+("constant"===el||"camera"===el),u_size_t:eh?eh.uSizeT:0,u_size:eh?eh.uSize:0,u_camera_to_center_distance:ek.getCameraToCenterDistance(eD),u_rotate_symbol:+ec,u_aspect_ratio:ek.width/ek.height,u_fade_change:e_.options.fadeDuration?e_.symbolFadeChange:1,u_matrix:eg,u_label_plane_matrix:ey,u_coord_matrix:eb,u_is_text:+eT,u_elevation_from_sea:ew?1:0,u_pitch_with_map:+ep,u_texsize:eS,u_texsize_icon:eE,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:tj,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:tj,u_up_vector:[0,-1,0],u_color_adj_mat:eR,u_icon_transition:eL||0,u_gamma_scale:ep?e_.transform.getCameraToCenterDistance(eD)*Math.cos(e_.terrain?0:e_.transform._pitch):1,u_device_pixel_ratio:F.q.devicePixelRatio,u_is_halo:+eM,u_scale_factor:eO||1};return"globe"===eD.name&&(eF.u_tile_id=[eI.canonical.x,eI.canonical.y,1<<eI.canonical.z],eF.u_zoom_transition=eA,eF.u_inv_rot_matrix=eP,eF.u_merc_center=eC,eF.u_camera_forward=ek._camera.forward(),eF.u_ecef_origin=F.cS(ek.globeMatrix,eI.toUnwrapped()),eF.u_tile_matrix=Float32Array.from(ek.globeMatrix),eF.u_up_vector=ez),eF},yr=(F,el,eh,ec)=>({u_matrix:F,u_emissive_strength:el,u_opacity:eh,u_color:ec}),xr=(el,eh,ec,ep,e_,eg,ey,eb,ew)=>F.l(function(el,eh,ec,ep,e_,eg){let{width:ey,height:eb}=ep.imageManager.getPixelSize(eh),ew=Math.pow(2,eg.tileID.overscaledZ),eT=eg.tileSize*Math.pow(2,ep.transform.tileZoom)/ew,eS=eT*(eg.tileID.canonical.x+eg.tileID.wrap*ew),eE=eT*eg.tileID.canonical.y;return{u_image:0,u_pattern_tl:ec.tl,u_pattern_br:ec.br,u_texsize:[ey,eb],u_pattern_size:ec.displaySize,u_pattern_units_to_pixels:e_?[ep.transform.width,-1*ep.transform.height]:[1/F.at(eg,1,ep.transform.tileZoom),1/F.at(eg,1,ep.transform.tileZoom)],u_pixel_coord_upper:[eS>>16,eE>>16],u_pixel_coord_lower:[65535&eS,65535&eE]}}(0,eg,ey,ep,eb,ew),{u_matrix:el,u_emissive_strength:eh,u_opacity:ec}),tG=new Float32Array(F.ad.mat4.identity([])),wr=(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI=[0,0,0],eA)=>{let eC=e_.style.light,eP=eC.properties.get("position"),ez=[-eP.x,-eP.y,eP.z],eD=F.ad.mat3.create();"viewport"===eC.properties.get("anchor")&&(F.ad.mat3.fromRotation(eD,-e_.transform.angle),F.ad.vec3.transformMat3(ez,ez,eD));let eR="MASK"===eS.alphaMode,eL=eC.properties.get("color").toRenderColor(null),eO=eM.paint.get("model-ambient-occlusion-intensity"),ek=eM.paint.get("model-color").constantOr(F.al.white).toRenderColor(null),eF=eM.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:el,u_lighting_matrix:eh,u_normal_matrix:ec,u_node_matrix:ep||tG,u_lightpos:ez,u_lightintensity:eC.properties.get("intensity"),u_lightcolor:[eL.r,eL.g,eL.b],u_camera_pos:eI,u_opacity:eg,u_baseTextureIsAlpha:0,u_alphaMask:+eR,u_alphaCutoff:eS.alphaCutoff,u_baseColorFactor:[ey.r,ey.g,ey.b,ey.a],u_emissiveFactor:[eb[0],eb[1],eb[2],1],u_metallicFactor:ew,u_roughnessFactor:eT,u_baseColorTexture:e5.BaseColor,u_metallicRoughnessTexture:e5.MetallicRoughness,u_normalTexture:e5.Normal,u_occlusionTexture:e5.Occlusion,u_emissionTexture:e5.Emission,u_lutTexture:e5.LUT,u_color_mix:[ek.r,ek.g,ek.b,eF],u_aoIntensity:eO,u_emissive_strength:eE,u_occlusionTextureTransform:eA||[0,0,0,0]}},Tr=(F,el=tG,eh=tG)=>({u_matrix:F,u_instance:el,u_node_matrix:eh}),tq={fillExtrusion:el=>({u_matrix:new F.bJ(el),u_lightpos:new F.bL(el),u_lightintensity:new F.bM(el),u_lightcolor:new F.bL(el),u_vertical_gradient:new F.bM(el),u_opacity:new F.bM(el),u_edge_radius:new F.bM(el),u_width_scale:new F.bM(el),u_ao:new F.bK(el),u_height_type:new F.bN(el),u_base_type:new F.bN(el),u_tile_id:new F.bL(el),u_zoom_transition:new F.bM(el),u_inv_rot_matrix:new F.bJ(el),u_merc_center:new F.bK(el),u_up_dir:new F.bL(el),u_height_lift:new F.bM(el),u_flood_light_color:new F.bL(el),u_vertical_scale:new F.bM(el),u_flood_light_intensity:new F.bM(el),u_ground_shadow_factor:new F.bL(el)}),fillExtrusionDepth:el=>({u_matrix:new F.bJ(el),u_edge_radius:new F.bM(el),u_width_scale:new F.bM(el),u_vertical_scale:new F.bM(el),u_height_type:new F.bN(el),u_base_type:new F.bN(el)}),fillExtrusionPattern:el=>({u_matrix:new F.bJ(el),u_lightpos:new F.bL(el),u_lightintensity:new F.bM(el),u_lightcolor:new F.bL(el),u_vertical_gradient:new F.bM(el),u_height_factor:new F.bM(el),u_edge_radius:new F.bM(el),u_width_scale:new F.bM(el),u_ao:new F.bK(el),u_height_type:new F.bN(el),u_base_type:new F.bN(el),u_tile_id:new F.bL(el),u_zoom_transition:new F.bM(el),u_inv_rot_matrix:new F.bJ(el),u_merc_center:new F.bK(el),u_up_dir:new F.bL(el),u_height_lift:new F.bM(el),u_image:new F.bN(el),u_texsize:new F.bK(el),u_pixel_coord_upper:new F.bK(el),u_pixel_coord_lower:new F.bK(el),u_tile_units_to_pixels:new F.bM(el),u_opacity:new F.bM(el)}),fillExtrusionGroundEffect:el=>({u_matrix:new F.bJ(el),u_opacity:new F.bM(el),u_ao_pass:new F.bM(el),u_meter_to_tile:new F.bM(el),u_ao:new F.bK(el),u_flood_light_intensity:new F.bM(el),u_flood_light_color:new F.bL(el),u_attenuation:new F.bM(el),u_edge_radius:new F.bM(el),u_fb:new F.bN(el),u_fb_size:new F.bM(el),u_dynamic_offset:new F.bM(el)}),fill:el=>({u_matrix:new F.bJ(el),u_emissive_strength:new F.bM(el)}),fillPattern:el=>({u_matrix:new F.bJ(el),u_emissive_strength:new F.bM(el),u_image:new F.bN(el),u_texsize:new F.bK(el),u_pixel_coord_upper:new F.bK(el),u_pixel_coord_lower:new F.bK(el),u_tile_units_to_pixels:new F.bM(el)}),fillOutline:el=>({u_matrix:new F.bJ(el),u_emissive_strength:new F.bM(el),u_world:new F.bK(el)}),fillOutlinePattern:el=>({u_matrix:new F.bJ(el),u_emissive_strength:new F.bM(el),u_world:new F.bK(el),u_image:new F.bN(el),u_texsize:new F.bK(el),u_pixel_coord_upper:new F.bK(el),u_pixel_coord_lower:new F.bK(el),u_tile_units_to_pixels:new F.bM(el)}),elevatedStructures:el=>({u_matrix:new F.bJ(el)}),elevatedStructuresDepthReconstruct:el=>({u_matrix:new F.bJ(el),u_camera_pos:new F.bL(el),u_depth_bias:new F.bM(el),u_height_scale:new F.bM(el),u_reset_depth:new F.bM(el)}),circle:F.cT,collisionBox:el=>({u_matrix:new F.bJ(el),u_camera_to_center_distance:new F.bM(el),u_extrude_scale:new F.bK(el)}),collisionCircle:el=>({u_matrix:new F.bJ(el),u_inv_matrix:new F.bJ(el),u_camera_to_center_distance:new F.bM(el),u_viewport_size:new F.bK(el)}),debug:el=>({u_color:new F.cA(el),u_matrix:new F.bJ(el),u_overlay:new F.bN(el),u_overlay_scale:new F.bM(el)}),clippingMask:el=>({u_matrix:new F.bJ(el)}),heatmap:el=>({u_extrude_scale:new F.bM(el),u_intensity:new F.bM(el),u_matrix:new F.bJ(el),u_inv_rot_matrix:new F.bJ(el),u_merc_center:new F.bK(el),u_tile_id:new F.bL(el),u_zoom_transition:new F.bM(el),u_up_dir:new F.bL(el)}),heatmapTexture:el=>({u_image:new F.bN(el),u_color_ramp:new F.bN(el),u_opacity:new F.bM(el)}),hillshade:el=>({u_matrix:new F.bJ(el),u_image:new F.bN(el),u_latrange:new F.bK(el),u_light:new F.bK(el),u_shadow:new F.cA(el),u_highlight:new F.cA(el),u_emissive_strength:new F.bM(el),u_accent:new F.cA(el)}),hillshadePrepare:el=>({u_matrix:new F.bJ(el),u_image:new F.bN(el),u_dimension:new F.bK(el),u_zoom:new F.bM(el)}),line:F.cU,linePattern:F.cV,raster:el=>({u_matrix:new F.bJ(el),u_normalize_matrix:new F.bJ(el),u_globe_matrix:new F.bJ(el),u_merc_matrix:new F.bJ(el),u_grid_matrix:new F.cB(el),u_tl_parent:new F.bK(el),u_scale_parent:new F.bM(el),u_fade_t:new F.bM(el),u_opacity:new F.bM(el),u_image0:new F.bN(el),u_image1:new F.bN(el),u_brightness_low:new F.bM(el),u_brightness_high:new F.bM(el),u_saturation_factor:new F.bM(el),u_contrast_factor:new F.bM(el),u_spin_weights:new F.bL(el),u_perspective_transform:new F.bK(el),u_raster_elevation:new F.bM(el),u_zoom_transition:new F.bM(el),u_merc_center:new F.bK(el),u_cutoff_params:new F.cb(el),u_colorization_mix:new F.cb(el),u_colorization_offset:new F.bM(el),u_color_ramp:new F.bN(el),u_texture_offset:new F.bK(el),u_texture_res:new F.bK(el),u_emissive_strength:new F.bM(el)}),rasterParticle:el=>({u_matrix:new F.bJ(el),u_normalize_matrix:new F.bJ(el),u_globe_matrix:new F.bJ(el),u_merc_matrix:new F.bJ(el),u_grid_matrix:new F.cB(el),u_tl_parent:new F.bK(el),u_scale_parent:new F.bM(el),u_fade_t:new F.bM(el),u_opacity:new F.bM(el),u_image0:new F.bN(el),u_image1:new F.bN(el),u_raster_elevation:new F.bM(el),u_zoom_transition:new F.bM(el),u_merc_center:new F.bK(el),u_cutoff_params:new F.cb(el)}),rasterParticleTexture:el=>({u_texture:new F.bN(el),u_opacity:new F.bM(el)}),rasterParticleDraw:el=>({u_particle_texture:new F.bN(el),u_particle_texture_side_len:new F.bM(el),u_tile_offset:new F.bK(el),u_velocity:new F.bN(el),u_color_ramp:new F.bN(el),u_velocity_res:new F.bK(el),u_max_speed:new F.bM(el),u_uv_offset:new F.bK(el),u_data_scale:new F.bK(el),u_data_offset:new F.bM(el),u_particle_pos_scale:new F.bM(el),u_particle_pos_offset:new F.bK(el)}),rasterParticleUpdate:el=>({u_particle_texture:new F.bN(el),u_particle_texture_side_len:new F.bM(el),u_velocity:new F.bN(el),u_velocity_res:new F.bK(el),u_max_speed:new F.bM(el),u_speed_factor:new F.bM(el),u_reset_rate:new F.bM(el),u_rand_seed:new F.bM(el),u_uv_offset:new F.bK(el),u_data_scale:new F.bK(el),u_data_offset:new F.bM(el),u_particle_pos_scale:new F.bM(el),u_particle_pos_offset:new F.bK(el)}),symbol:el=>({u_is_size_zoom_constant:new F.bN(el),u_is_size_feature_constant:new F.bN(el),u_size_t:new F.bM(el),u_size:new F.bM(el),u_camera_to_center_distance:new F.bM(el),u_rotate_symbol:new F.bN(el),u_aspect_ratio:new F.bM(el),u_fade_change:new F.bM(el),u_matrix:new F.bJ(el),u_label_plane_matrix:new F.bJ(el),u_coord_matrix:new F.bJ(el),u_is_text:new F.bN(el),u_elevation_from_sea:new F.bN(el),u_pitch_with_map:new F.bN(el),u_texsize:new F.bK(el),u_texsize_icon:new F.bK(el),u_texture:new F.bN(el),u_texture_icon:new F.bN(el),u_gamma_scale:new F.bM(el),u_device_pixel_ratio:new F.bM(el),u_tile_id:new F.bL(el),u_zoom_transition:new F.bM(el),u_inv_rot_matrix:new F.bJ(el),u_merc_center:new F.bK(el),u_camera_forward:new F.bL(el),u_tile_matrix:new F.bJ(el),u_up_vector:new F.bL(el),u_ecef_origin:new F.bL(el),u_is_halo:new F.bN(el),u_icon_transition:new F.bM(el),u_color_adj_mat:new F.bJ(el),u_scale_factor:new F.bM(el)}),background:el=>({u_matrix:new F.bJ(el),u_emissive_strength:new F.bM(el),u_opacity:new F.bM(el),u_color:new F.cA(el)}),backgroundPattern:el=>({u_matrix:new F.bJ(el),u_emissive_strength:new F.bM(el),u_opacity:new F.bM(el),u_image:new F.bN(el),u_pattern_tl:new F.bK(el),u_pattern_br:new F.bK(el),u_texsize:new F.bK(el),u_pattern_size:new F.bK(el),u_pixel_coord_upper:new F.bK(el),u_pixel_coord_lower:new F.bK(el),u_pattern_units_to_pixels:new F.bK(el)}),terrainRaster:el=>({u_matrix:new F.bJ(el),u_image0:new F.bN(el),u_skirt_height:new F.bM(el),u_ground_shadow_factor:new F.bL(el)}),skybox:el=>({u_matrix:new F.bJ(el),u_sun_direction:new F.bL(el),u_cubemap:new F.bN(el),u_opacity:new F.bM(el),u_temporal_offset:new F.bM(el)}),skyboxGradient:el=>({u_matrix:new F.bJ(el),u_color_ramp:new F.bN(el),u_center_direction:new F.bL(el),u_radius:new F.bM(el),u_opacity:new F.bM(el),u_temporal_offset:new F.bM(el)}),skyboxCapture:el=>({u_matrix_3f:new F.cB(el),u_sun_direction:new F.bL(el),u_sun_intensity:new F.bM(el),u_color_tint_r:new F.cb(el),u_color_tint_m:new F.cb(el),u_luminance:new F.bM(el)}),globeRaster:el=>({u_proj_matrix:new F.bJ(el),u_globe_matrix:new F.bJ(el),u_normalize_matrix:new F.bJ(el),u_merc_matrix:new F.bJ(el),u_zoom_transition:new F.bM(el),u_merc_center:new F.bK(el),u_image0:new F.bN(el),u_grid_matrix:new F.cB(el),u_skirt_height:new F.bM(el),u_far_z_cutoff:new F.bM(el),u_frustum_tl:new F.bL(el),u_frustum_tr:new F.bL(el),u_frustum_br:new F.bL(el),u_frustum_bl:new F.bL(el),u_globe_pos:new F.bL(el),u_globe_radius:new F.bM(el),u_viewport:new F.bK(el)}),globeAtmosphere:el=>({u_frustum_tl:new F.bL(el),u_frustum_tr:new F.bL(el),u_frustum_br:new F.bL(el),u_frustum_bl:new F.bL(el),u_horizon:new F.bM(el),u_transition:new F.bM(el),u_fadeout_range:new F.bM(el),u_color:new F.cb(el),u_high_color:new F.cb(el),u_space_color:new F.cb(el),u_temporal_offset:new F.bM(el),u_horizon_angle:new F.bM(el)}),model:el=>({u_matrix:new F.bJ(el),u_lighting_matrix:new F.bJ(el),u_normal_matrix:new F.bJ(el),u_node_matrix:new F.bJ(el),u_lightpos:new F.bL(el),u_lightintensity:new F.bM(el),u_lightcolor:new F.bL(el),u_camera_pos:new F.bL(el),u_opacity:new F.bM(el),u_baseColorFactor:new F.cb(el),u_emissiveFactor:new F.cb(el),u_metallicFactor:new F.bM(el),u_roughnessFactor:new F.bM(el),u_baseTextureIsAlpha:new F.bN(el),u_alphaMask:new F.bN(el),u_alphaCutoff:new F.bM(el),u_baseColorTexture:new F.bN(el),u_metallicRoughnessTexture:new F.bN(el),u_normalTexture:new F.bN(el),u_occlusionTexture:new F.bN(el),u_emissionTexture:new F.bN(el),u_lutTexture:new F.bN(el),u_color_mix:new F.cb(el),u_aoIntensity:new F.bM(el),u_emissive_strength:new F.bM(el),u_occlusionTextureTransform:new F.cb(el)}),modelDepth:el=>({u_matrix:new F.bJ(el),u_instance:new F.bJ(el),u_node_matrix:new F.bJ(el)}),groundShadow:el=>({u_matrix:new F.bJ(el),u_ground_shadow_factor:new F.bL(el)}),stars:el=>({u_matrix:new F.bJ(el),u_up:new F.bL(el),u_right:new F.bL(el),u_intensity_multiplier:new F.bM(el)}),snowParticle:el=>({u_modelview:new F.bJ(el),u_projection:new F.bJ(el),u_time:new F.bM(el),u_cam_pos:new F.bL(el),u_velocityConeAperture:new F.bM(el),u_velocity:new F.bM(el),u_horizontalOscillationRadius:new F.bM(el),u_horizontalOscillationRate:new F.bM(el),u_boxSize:new F.bM(el),u_billboardSize:new F.bM(el),u_simpleShapeParameters:new F.bK(el),u_screenSize:new F.bK(el),u_thinningCenterPos:new F.bK(el),u_thinningShape:new F.bL(el),u_thinningAffectedRatio:new F.bM(el),u_thinningParticleOffset:new F.bM(el),u_particleColor:new F.cb(el),u_direction:new F.bL(el)}),rainParticle:el=>({u_modelview:new F.bJ(el),u_projection:new F.bJ(el),u_time:new F.bM(el),u_cam_pos:new F.bL(el),u_texScreen:new F.bN(el),u_velocityConeAperture:new F.bM(el),u_velocity:new F.bM(el),u_boxSize:new F.bM(el),u_rainDropletSize:new F.bK(el),u_distortionStrength:new F.bM(el),u_rainDirection:new F.bL(el),u_color:new F.cb(el),u_screenSize:new F.bK(el),u_thinningCenterPos:new F.bK(el),u_thinningShape:new F.bL(el),u_thinningAffectedRatio:new F.bM(el),u_thinningParticleOffset:new F.bM(el),u_shapeDirectionalPower:new F.bM(el),u_shapeNormalPower:new F.bM(el),u_mode:new F.bM(el)}),vignette:el=>({u_vignetteShape:new F.bL(el),u_vignetteColor:new F.cb(el)}),occlusion:el=>({u_matrix:new F.bJ(el),u_anchorPos:new F.bL(el),u_screenSizePx:new F.bK(el),u_occluderSizePx:new F.bK(el),u_color:new F.cb(el)})};let Sr=class Sr{constructor(F,el,eh,ec){this.id=Sr.uniqueIdxCounter,Sr.uniqueIdxCounter++,this.context=F;let ep=F.gl;this.buffer=ep.createBuffer(),this.dynamicDraw=!!eh,this.context.unbindVAO(),F.bindElementBuffer.set(this.buffer),ep.bufferData(ep.ELEMENT_ARRAY_BUFFER,el.arrayBuffer,this.dynamicDraw?ep.DYNAMIC_DRAW:ep.STATIC_DRAW),this.dynamicDraw||ec||el.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(F){this.id=Sr.uniqueIdxCounter,Sr.uniqueIdxCounter++;let el=this.context.gl;this.context.unbindVAO(),this.bind(),el.bufferSubData(el.ELEMENT_ARRAY_BUFFER,0,F.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}};Sr.uniqueIdxCounter=0;let t$={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};let Ir=class Ir{constructor(F,el,eh,ec,ep,e_){this.length=el.length,this.attributes=eh,this.itemSize=el.bytesPerElement,this.dynamicDraw=ec,this.instanceCount=e_,this.context=F;let eg=F.gl;this.buffer=eg.createBuffer(),F.bindVertexBuffer.set(this.buffer),eg.bufferData(eg.ARRAY_BUFFER,el.arrayBuffer,this.dynamicDraw?eg.DYNAMIC_DRAW:eg.STATIC_DRAW),this.dynamicDraw||ep||el.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(F){let el=this.context.gl;this.bind(),el.bufferSubData(el.ARRAY_BUFFER,0,F.arrayBuffer)}enableAttributes(F,el){for(let eh=0;eh<this.attributes.length;eh++){let ec=el.attributes[this.attributes[eh].name];void 0!==ec&&F.enableVertexAttribArray(ec)}}setVertexAttribPointers(F,el,eh){for(let ec=0;ec<this.attributes.length;ec++){let ep=this.attributes[ec],e_=el.attributes[ep.name];void 0!==e_&&F.vertexAttribPointer(e_,ep.components,F[t$[ep.type]],!1,this.itemSize,ep.offset+this.itemSize*(eh||0))}}setVertexAttribDivisor(F,el,eh){for(let ec=0;ec<this.attributes.length;ec++){let ep=el.attributes[this.attributes[ec].name];void 0!==ep&&this.instanceCount&&this.instanceCount>0&&F.vertexAttribDivisor(ep,eh)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}};let Rr=class Rr{constructor(F,el,eh,ec,ep){this.context=F,this.width=el,this.height=eh;let e_=this.framebuffer=F.gl.createFramebuffer();ec&&(this.colorAttachment=new Is(F,e_)),ep&&(this.depthAttachmentType=ep,this.depthAttachment="renderbuffer"===ep?new Rs(F,e_):new Ds(F,e_))}destroy(){let F=this.context.gl;if(this.colorAttachment){let el=this.colorAttachment.get();el&&F.deleteTexture(el)}if(this.depthAttachment&&this.depthAttachmentType){if("renderbuffer"===this.depthAttachmentType){let el=this.depthAttachment.get();el&&F.deleteRenderbuffer(el)}else{let el=this.depthAttachment.get();el&&F.deleteTexture(el)}}F.deleteFramebuffer(this.framebuffer)}};let Dr=class Dr{constructor(F,el){this.gl=F,this.clearColor=new Xo(this),this.clearDepth=new Ko(this),this.clearStencil=new Yo(this),this.colorMask=new Jo(this),this.depthMask=new Qo(this),this.stencilMask=new es(this),this.stencilFunc=new ts(this),this.stencilOp=new is(this),this.stencilTest=new os(this),this.depthRange=new ss(this),this.depthTest=new rs(this),this.depthFunc=new ns(this),this.blend=new as(this),this.blendFunc=new ls(this),this.blendColor=new cs(this),this.blendEquation=new hs(this),this.cullFace=new ds(this),this.cullFaceSide=new us(this),this.frontFace=new _s(this),this.program=new tL(this),this.activeTexture=new fs(this),this.viewport=new ms(this),this.bindFramebuffer=new gs(this),this.bindRenderbuffer=new vs(this),this.bindTexture=new ys(this),this.bindVertexBuffer=new xs(this),this.bindElementBuffer=new bs(this),this.bindVertexArrayOES=new ws(this),this.pixelStoreUnpack=new Ts(this),this.pixelStoreUnpackPremultiplyAlpha=new Es(this),this.pixelStoreUnpackFlipY=new Ss(this),this.options=el?Object.assign({},el):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=F.getExtension("EXT_texture_filter_anisotropic")||F.getExtension("MOZ_EXT_texture_filter_anisotropic")||F.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=F.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=F.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=F.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=F.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=el&&!!el.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=F.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=F.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=F.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=F.getParameter(F.MAX_TEXTURE_SIZE),this.maxPointSize=F.getParameter(F.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(F,el,eh){return new Sr(this,F,el,eh)}createVertexBuffer(F,el,eh,ec,ep){return new Ir(this,F,el,eh,ec,ep)}createRenderbuffer(F,el,eh){let ec=this.gl,ep=ec.createRenderbuffer();return this.bindRenderbuffer.set(ep),ec.renderbufferStorage(ec.RENDERBUFFER,F,el,eh),this.bindRenderbuffer.set(null),ep}createFramebuffer(F,el,eh,ec){return new Rr(this,F,el,eh,ec)}clear({color:F,depth:el,stencil:eh,colorMask:ec}){let ep=this.gl,e_=0;F&&(e_|=ep.COLOR_BUFFER_BIT,this.clearColor.set(F),this.colorMask.set(ec||[!0,!0,!0,!0])),void 0!==el&&(e_|=ep.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(el),this.depthMask.set(!0)),void 0!==eh&&(e_|=ep.STENCIL_BUFFER_BIT,this.clearStencil.set(eh),this.stencilMask.set(255)),ep.clear(e_)}setCullFace(F){!1===F.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(F.mode),this.frontFace.set(F.frontFace))}setDepthMode(F){F.func!==this.gl.ALWAYS||F.mask?(this.depthTest.set(!0),this.depthFunc.set(F.func),this.depthMask.set(F.mask),this.depthRange.set(F.range)):this.depthTest.set(!1)}setStencilMode(F){F.test.func!==this.gl.ALWAYS||F.mask?(this.stencilTest.set(!0),this.stencilMask.set(F.mask),this.stencilOp.set([F.fail,F.depthFail,F.pass]),this.stencilFunc.set({func:F.test.func,ref:F.ref,mask:F.test.mask})):this.stencilTest.set(!1)}setColorMode(el){F.bn(el.blendFunction,ki.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(el.blendFunction),this.blendColor.set(el.blendColor),el.blendEquation?this.blendEquation.set(el.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(el.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}};function Lr(el,eh,ep,e_,eg,ey,eb){let ew=el.context,eT=ew.gl,eS=el.transform,eE=el.getOrCreateProgram("collisionBox"),eM=[],eI=0,eA=0;for(let ec=0;ec<e_.length;ec++){let ew=e_[ec],eC=eh.getTile(ew),eP=eC.getBucket(ep);if(!eP)continue;let ez=function(F,el,eh){if(el.projection.name===eh.projection.name)return F.projMatrix;let ec=eh.clone();return ec.setProjection(el.projection),ai(ec,el.getProjection(),F)}(ew,eP,eS),eD=ez;0===eg[0]&&0===eg[1]||(eD=el.translatePosMatrix(ez,eC,eg,ey));let eR=eb?eP.textCollisionBox:eP.iconCollisionBox,eL=eP.collisionCircleArray;if(eL.length>0){let el=F.ad.mat4.create(),eh=eD;F.ad.mat4.mul(el,eP.placementInvProjMatrix,eS.glCoordMatrix),F.ad.mat4.mul(el,el,eP.placementViewportMatrix),eM.push({circleArray:eL,circleOffset:eA,transform:eh,invTransform:el,projection:eP.getProjection()}),eI+=eL.length/4,eA=eI}eR&&(el.terrain&&el.terrain.setupElevationDraw(eC,eE),eE.draw(el,eT.LINES,Bi.disabled,Ui.disabled,el.colorModeForRenderPass(),ji.disabled,rr(eD,eS,eC,eP.getProjection()),ep.id,eR.layoutVertexBuffer,eR.indexBuffer,eR.segments,null,eS.zoom,null,[eR.collisionVertexBuffer,eR.collisionVertexBufferExt]))}if(!eb||!eM.length)return;let eC=el.getOrCreateProgram("collisionCircle"),eP=new F.cW;eP.resize(4*eI),eP._trim();let ez=0;for(let F of eM)for(let el=0;el<F.circleArray.length/4;el++){let eh=4*el,ec=F.circleArray[eh+0],ep=F.circleArray[eh+1],e_=F.circleArray[eh+2],eg=F.circleArray[eh+3];eP.emplace(ez++,ec,ep,e_,eg,0),eP.emplace(ez++,ec,ep,e_,eg,1),eP.emplace(ez++,ec,ep,e_,eg,2),eP.emplace(ez++,ec,ep,e_,eg,3)}(!ec||ec.length<2*eI)&&(ec=function(el){let eh=2*el,ec=new F.aV;ec.resize(eh),ec._trim();for(let F=0;F<eh;F++){let el=6*F;ec.uint16[el+0]=4*F+0,ec.uint16[el+1]=4*F+1,ec.uint16[el+2]=4*F+2,ec.uint16[el+3]=4*F+2,ec.uint16[el+4]=4*F+3,ec.uint16[el+5]=4*F+0}return ec}(eI));let eD=ew.createIndexBuffer(ec,!0),eR=ew.createVertexBuffer(eP,F.cX.members,!0);for(let eh of eM){let ec={u_matrix:eh.transform,u_inv_matrix:eh.invTransform,u_camera_to_center_distance:eS.getCameraToCenterDistance(eh.projection),u_viewport_size:[eS.width,eS.height]};eC.draw(el,eT.TRIANGLES,Bi.disabled,Ui.disabled,el.colorModeForRenderPass(),ji.disabled,ec,ep.id,eR,eD,F.b8.simpleSegment(0,2*eh.circleOffset,eh.circleArray.length,eh.circleArray.length/2),null,eS.zoom)}eR.destroy(),eD.destroy()}let tH=F.ad.mat4.create();function Pr(el){let eh=el._camera.getWorldToCamera(el.worldSize,1),ec=F.ad.mat4.multiply([],eh,el.globeMatrix);F.ad.mat4.invert(ec,ec);let ep=[0,0,0],e_=[0,1,0,0];return F.ad.vec4.transformMat4(e_,e_,ec),ep[0]=e_[0],ep[1]=e_[1],ep[2]=e_[2],F.ad.vec3.normalize(ep,ep),ep}function Fr(el,eh,ec,ep,e_,eg,ey={}){let eb=ec.paint.get("icon-translate"),ew=ec.paint.get("text-translate"),eT=ec.paint.get("icon-translate-anchor"),eS=ec.paint.get("text-translate-anchor"),eE=ec.layout.get("icon-rotation-alignment"),eM=ec.layout.get("text-rotation-alignment"),eI=ec.layout.get("icon-pitch-alignment"),eA=ec.layout.get("text-pitch-alignment"),eC=ec.layout.get("icon-keep-upright"),eP=ec.layout.get("text-keep-upright"),ez=ec.paint.get("icon-color-saturation"),eD=ec.paint.get("icon-color-contrast"),eR=ec.paint.get("icon-color-brightness-min"),eL=ec.paint.get("icon-color-brightness-max"),eO="sea"===ec.layout.get("symbol-elevation-reference"),ek=el.context,eF=ek.gl,eB=el.transform,eN="map"===eE,eV="map"===eM,eU="map"===eI,ej="map"===eA,eG=void 0!==ec.layout.get("symbol-sort-key").constantOr(1),eq=!1,e$=el.depthModeForSublayer(0,Bi.ReadOnly),eH=[F.av(eB.center.lng),F.aC(eB.center.lat)],eZ=ec.layout.get("text-variable-anchor"),eW="globe"===eB.projection.name,eY=[],eX=[0,-1,0];for(let e_ of ep){let ep=eh.getTile(e_),eg=ep.getBucket(ec);if(!eg||"mercator"===eg.projection.name&&eW||eg.fullyClipped)continue;let eE="globe"===eg.projection.name,eM=eE?F.ag(eB.zoom):0,eI=ci(e_,eg.getProjection(),eB),eA=eB.calculatePixelsToTileUnitsMatrix(ep),ek=eZ&&eg.hasTextData(),e$=eg.hasIconTextFit()&&ek&&eg.hasIconData(),eK=eg.getProjection().createInversionMatrix(eB,e_.canonical),N=F=>{eB.depthOcclusionForSymbolsAndCircles&&(ec.hasInitialOcclusionOpacityProperties||el.terrain)&&(F.push("DEPTH_D24"),F.push("DEPTH_OCCLUSION"))},U=()=>{let eh=eN&&"point"!==ec.layout.get("symbol-placement"),ey=[];N(ey);let ew=eh||e$,eS=ec.paint.get("icon-image-cross-fade").constantOr(0);el.terrainRenderModeElevated()&&eU&&ey.push("PITCH_WITH_MAP_TERRAIN"),eE&&(ey.push("PROJECTION_GLOBE_VIEW"),ew&&ey.push("PROJECTED_POS_ON_VIEWPORT")),eS>0&&ey.push("ICON_TRANSITION"),eg.icon.zOffsetVertexBuffer&&ey.push("Z_OFFSET"),0===ez&&0===eD&&0===eR&&1===eL||ey.push("COLOR_ADJUSTMENT"),eg.sdfIcons&&ey.push("RENDER_SDF");let eP=eg.icon.programConfigurations.get(ec.id),ek=el.getOrCreateProgram("symbol",{config:eP,defines:ey}),eV=ep.imageAtlasTexture?ep.imageAtlasTexture.size:[0,0],ej=eg.iconSizeData,eG=F.bp(ej,eB.zoom),eq=eU||0!==eB.pitch,eZ=qt(eI,ep.tileID.canonical,eU,eN,eB,eg.getProjection(),eA),eY=Zt(eI,ep.tileID.canonical,eU,eN,eB,eg.getProjection(),eA),eJ=el.translatePosMatrix(eY,ep,eb,eT,!0),eQ=el.translatePosMatrix(eI,ep,eb,eT),e0=ew?tH:eZ,e1=eN&&!eU&&!eh,e2=eX;(eW||eB.mercatorFromTransition)&&!eN&&(e2=Pr(eB));let e3=eE?e2:eX,e4=ec.getColorAdjustmentMatrix(ez,eD,eR,eL),e5=vr(ej.kind,eG,e1,eU,el,eQ,e0,eJ,eO,!1,eV,[0,0],!0,e_,eM,eH,eK,e3,eg.getProjection(),e4,eS),e6=ep.imageAtlasTexture?ep.imageAtlasTexture:null,e8=1!==ec.layout.get("icon-size").constantOr(0)||eg.iconsNeedLinear,e9=eg.sdfIcons||el.options.rotating||el.options.zooming||e8||eq?eF.LINEAR:eF.NEAREST,e7=eg.sdfIcons&&0!==ec.paint.get("icon-halo-width").constantOr(1),tn=el.terrain&&eU&&eh?F.ad.mat4.invert(F.ad.mat4.create(),eZ):tH;if(eh&&eg.icon){let F=eB.elevation,eh=F?F.getAtTileOffsetFunc(e_,eB.center.lat,eB.worldSize,eg.getProjection()):null,ec=Ht(eI,ep.tileID.canonical,eU,eN,eB,eg.getProjection(),eA);Kt(eg,eI,el,!1,ec,eY,eU,eC,eh,e_)}return{program:ek,buffers:eg.icon,uniformValues:e5,atlasTexture:e6,atlasTextureIcon:null,atlasInterpolation:e9,atlasInterpolationIcon:null,isSDF:eg.sdfIcons,hasHalo:e7,tile:ep,labelPlaneMatrixInv:tn}},V=()=>{let eh=eV&&"point"!==ec.layout.get("symbol-placement"),ey=[],eb=eh||eZ||e$;el.terrainRenderModeElevated()&&ej&&ey.push("PITCH_WITH_MAP_TERRAIN"),eE&&(ey.push("PROJECTION_GLOBE_VIEW"),eb&&ey.push("PROJECTED_POS_ON_VIEWPORT")),eg.text.zOffsetVertexBuffer&&ey.push("Z_OFFSET"),eg.iconsInText&&ey.push("RENDER_TEXT_AND_SYMBOL"),ey.push("RENDER_SDF"),N(ey);let eT=eg.text.programConfigurations.get(ec.id),eC=el.getOrCreateProgram("symbol",{config:eT,defines:ey}),ez,eD=[0,0],eR=null,eL=eg.textSizeData;eg.iconsInText&&(eD=ep.imageAtlasTexture?ep.imageAtlasTexture.size:[0,0],eR=ep.imageAtlasTexture?ep.imageAtlasTexture:null,ez=ej||0!==eB.pitch||el.options.rotating||el.options.zooming||"composite"===eL.kind||"camera"===eL.kind?eF.LINEAR:eF.NEAREST);let ek=ep.glyphAtlasTexture?ep.glyphAtlasTexture.size:[0,0],eN=ec.layout.get("text-size-scale-range"),eU=F.ay(el.scaleFactor,eN[0],eN[1]),eG=F.bp(eL,eB.zoom,eU),eq=qt(eI,ep.tileID.canonical,ej,eV,eB,eg.getProjection(),eA),eY=Zt(eI,ep.tileID.canonical,ej,eV,eB,eg.getProjection(),eA),eJ=el.translatePosMatrix(eY,ep,ew,eS,!0),eQ=el.translatePosMatrix(eI,ep,ew,eS),e0=eb?tH:eq,e1=eV&&!ej&&!eh,e2=eX;(eW||eB.mercatorFromTransition)&&!eV&&(e2=Pr(eB));let e3=vr(eL.kind,eG,e1,ej,el,eQ,e0,eJ,eO,!0,ek,eD,!0,e_,eM,eH,eK,eE?e2:eX,eg.getProjection(),null,null,eU),e4=ep.glyphAtlasTexture?ep.glyphAtlasTexture:null,e5=eF.LINEAR,e6=0!==ec.paint.get("text-halo-width").constantOr(1),e8=el.terrain&&ej&&eh?F.ad.mat4.invert(F.ad.mat4.create(),eq):tH;if(eh&&eg.text){let F=eB.elevation,eh=F?F.getAtTileOffsetFunc(e_,eB.center.lat,eB.worldSize,eg.getProjection()):null,ec=Ht(eI,ep.tileID.canonical,ej,eV,eB,eg.getProjection(),eA);Kt(eg,eI,el,!0,ec,eY,ej,eP,eh,e_)}return{program:eC,buffers:eg.text,uniformValues:e3,atlasTexture:e4,atlasTextureIcon:eR,atlasInterpolation:e5,atlasInterpolationIcon:ez,isSDF:!0,hasHalo:e6,tile:ep,labelPlaneMatrixInv:e8}},eJ=eg.icon.segments.get().length,eQ=eg.text.segments.get().length,e0=eJ&&!ey.onlyText?U():null,e1=eQ&&!ey.onlyIcons?V():null,e2=ec.paint.get("icon-opacity").constantOr(1),e3=ec.paint.get("text-opacity").constantOr(1);if(eG&&eg.canOverlap){eq=!0;let el=e2&&!ey.onlyText?eg.icon.segments.get():[],eh=e3&&!ey.onlyIcons?eg.text.segments.get():[];for(let eh of el)eY.push({segments:new F.b8([eh]),sortKey:eh.sortKey,state:e0});for(let el of eh)eY.push({segments:new F.b8([el]),sortKey:el.sortKey,state:e1})}else ey.onlyText||eY.push({segments:e2?eg.icon.segments:new F.b8([]),sortKey:0,state:e0}),ey.onlyIcons||eY.push({segments:e3?eg.text.segments:new F.b8([]),sortKey:0,state:e1})}for(let F of(eq&&eY.sort((F,el)=>F.sortKey-el.sortKey),eY)){let eh=F.state;if(eh){if(el.terrain?el.terrain.setupElevationDraw(eh.tile,eh.program,{useDepthForOcclusion:eB.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:eh.labelPlaneMatrixInv}):el.setupDepthForOcclusion(eB.depthOcclusionForSymbolsAndCircles,eh.program),ek.activeTexture.set(eF.TEXTURE0),eh.atlasTexture&&eh.atlasTexture.bind(eh.atlasInterpolation,eF.CLAMP_TO_EDGE,!0),eh.atlasTextureIcon&&(ek.activeTexture.set(eF.TEXTURE1),eh.atlasTextureIcon&&eh.atlasTextureIcon.bind(eh.atlasInterpolationIcon,eF.CLAMP_TO_EDGE,!0)),el.uploadCommonLightUniforms(el.context,eh.program),eh.hasHalo){let ep=eh.uniformValues;ep.u_is_halo=1,kr(eh.buffers,F.segments,ec,el,eh.program,e$,e_,eg,ep,2),ep.u_is_halo=0}else{if(eh.isSDF){let ep=eh.uniformValues;eh.hasHalo&&(ep.u_is_halo=1,kr(eh.buffers,F.segments,ec,el,eh.program,e$,e_,eg,ep,1)),ep.u_is_halo=0}kr(eh.buffers,F.segments,ec,el,eh.program,e$,e_,eg,eh.uniformValues,1)}}}}function kr(F,el,eh,ec,ep,e_,eg,ey,eb,ew){let eT=[F.dynamicLayoutVertexBuffer,F.opacityVertexBuffer,F.iconTransitioningVertexBuffer,F.globeExtVertexBuffer,F.zOffsetVertexBuffer];ep.draw(ec,ec.context.gl.TRIANGLES,e_,eg,ey,ji.disabled,eb,eh.id,F.layoutVertexBuffer,F.indexBuffer,el,eh.paint,ec.transform.zoom,F.programConfigurations.get(eh.id),eT,ew)}function Nr(el,eh,ec,ep,e_){if(!ec.layout||"none"===ec.layout.get("fill-elevation-reference"))return;let eg=el.context.gl,ey=new Bi(el.context.gl.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D),eb=new Bi(el.context.gl.GREATER,Bi.ReadWrite,el.depthRangeFor3D),ew=function(el){let eh=F.c4(el.pitch),ec=.01;return el.isOrthographic&&(ec=F.ah(1e-4,ec,F.c9(eh>=15?1:eh/15))),2*ec}(el.transform),eT=el.transform.getFreeCameraOptions().position,eS="elevatedStructuresDepthReconstruct",eE=el.getOrCreateProgram(eS,{defines:["DEPTH_RECONSTRUCTION"]}),eM=el.getOrCreateProgram(eS);for(let eS of ep){let ep,eI,eA,eC;let eP=eh.getTile(eS),ez=eP.getBucket(ec);if(!ez)continue;let eD=ez.elevatedStructures;if(!eD)continue;let eR=ez.elevationBufferData.heightRange,eL=function(el,eh){let ec=1<<el.canonical.z,ep=(eh.x*ec-el.canonical.x-el.wrap*ec)*F.ai,e_=(eh.y*ec-el.canonical.y)*F.ai,eg=F.d5(eh.z,eh.y);return F.ad.vec3.fromValues(ep,e_,eg)}(eS.toUnwrapped(),eT),eO=el.translatePosMatrix(eS.projMatrix,eP,ec.paint.get("fill-translate"),ec.paint.get("fill-translate-anchor"));if("initialize"===e_){if(!eR||eR.min>=1||0===eD.depthSegments.segments[0].primitiveLength)continue;ep=sr(eO,eL,ew,1,0),eI=ey,eA=eD.depthSegments,eC=eE}else if("reset"===e_){if(!eR||eR.min>=0||0===eD.maskSegments.segments[0].primitiveLength)continue;ep=sr(eO,eL,0,0,1),eI=eb,eA=eD.maskSegments,eC=eE}else if("geometry"===e_){if(0===eD.depthSegments.segments[0].primitiveLength)continue;ep=sr(eO,eL,ew,1,0),eI=ey,eA=eD.depthSegments,eC=eM}eC.draw(el,eg.TRIANGLES,eI,Ui.disabled,ki.disabled,ji.disabled,ep,ec.id,eD.vertexBuffer,eD.indexBuffer,eA,ec.paint,el.transform.zoom)}}function Ur(el,eh,ec){let{painter:ep,sourceCache:e_,layer:eg,coords:ey,colorMode:eb,elevationType:ew,terrainEnabled:eT,pass:eS}=el,eE=ep.context.gl,eM=eg.paint.get("fill-pattern"),eI=ew;"road"!==ew||eh&&!eT||(eI="none");let eA="road"===eI,eC=new Bi(ep.context.gl.LEQUAL,Bi.ReadWrite,ep.depthRangeFor3D),eP=eM&&eM.constantOr(1),v=(el,ew)=>{let eT,eS,ez,eD,eR;for(let eL of(ew?(eS=eP&&!eg.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",eT=eE.LINES):(eS=eP?"fillPattern":"fill",eT=eE.TRIANGLES),ey)){let ey=e_.getTile(eL);if(eP&&!ey.patternsLoaded())continue;let eO=ey.getBucket(eg);if(!eO)continue;let ek=eh?eO.elevationBufferData:eO.bufferData;if(ek.isEmpty())continue;ep.prepareDrawTile();let eF=ek.programConfigurations.get(eg.id),eB=ep.isTileAffectedByFog(eL),eN=[],eV=[];eA&&(eN.push("ELEVATED_ROADS"),eV.push(ek.elevatedLayoutVertexBuffer));let eU=ep.getOrCreateProgram(eS,{config:eF,overrideFog:eB,defines:eN});eP&&(ep.context.activeTexture.set(eE.TEXTURE0),ey.imageAtlasTexture&&ey.imageAtlasTexture.bind(eE.LINEAR,eE.CLAMP_TO_EDGE),eF.updatePaintBuffers());let ej=eM.constantOr(null);if(ej&&ey.imageAtlas){let el=ey.imageAtlas,eh=F.d0.from(ej).getPrimary().scaleSelf(F.q.devicePixelRatio).toString(),ec=el.patternPositions.get(eh);ec&&eF.setConstantPatternPositions(ec)}let eG=ep.translatePosMatrix(eL.projMatrix,ey,eg.paint.get("fill-translate"),eg.paint.get("fill-translate-anchor")),eq=eg.paint.get("fill-emissive-strength");if(ew){eD=ek.lineIndexBuffer,eR=ek.lineSegments;let F=ep.terrain&&ep.terrain.renderingToTexture?ep.terrain.drapeBufferSize:[eE.drawingBufferWidth,eE.drawingBufferHeight];ez="fillOutlinePattern"===eS&&eP?or(eG,eq,ep,ey,F):ir(eG,eq,F)}else eD=ek.indexBuffer,eR=ek.triangleSegments,ez=eP?tr(eG,eq,ep,ey):er(eG,eq);ep.uploadCommonUniforms(ep.context,eU,eL.toUnwrapped()),eU.draw(ep,eT,"none"!==eI?eC:el,ec||ep.stencilModeForClipping(eL),eb,ji.disabled,ez,eg.id,ek.layoutVertexBuffer,eD,eR,eg.paint,ep.transform.zoom,eF,eV)}};ep.renderPass===eS&&v(ep.depthModeForSublayer(1,"opaque"===ep.renderPass?Bi.ReadWrite:Bi.ReadOnly),!1),"none"===eI&&"translucent"===ep.renderPass&&eg.paint.get("fill-antialias")&&v(ep.depthModeForSublayer(eg.getPaintProperty("fill-outline-color")?2:0,Bi.ReadOnly),!0)}function Vr(el,eh,ec,ep,e_,eg,ey,eb){let ew;ec.resetLayerRenderingStats(el);let eT=el.context,eS=eT.gl,eE=el.transform,eM=ec.paint.get("fill-extrusion-pattern"),eI=eM.constantOr(1),eA=ec.paint.get("fill-extrusion-opacity"),eC=el.style.enable3dLights(),eP=ec.paint.get(eC&&!eI?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),ez=[ec.paint.get("fill-extrusion-ambient-occlusion-intensity"),eP],eD=ec.layout.get("fill-extrusion-edge-radius"),eR=eD>0&&!ec.paint.get("fill-extrusion-rounded-roof"),eL=eR?0:eD,eO="globe"===eE.projection.name?F.d6():0,ek="globe"===eE.projection.name,eF=ek?F.ag(eE.zoom):0,eB=[F.av(eE.center.lng),F.aC(eE.center.lat)],eN="none"===ec.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),eV=ec.paint.get("fill-extrusion-flood-light-color").toRenderColor(eN?null:ec.lut).toArray01().slice(0,3),eU=ec.paint.get("fill-extrusion-flood-light-intensity"),ej=ec.paint.get("fill-extrusion-vertical-scale"),eG=0!==ec.paint.get("fill-extrusion-line-width").constantOr(1),eq=ec.paint.get("fill-extrusion-height-alignment"),e$=ec.paint.get("fill-extrusion-base-alignment"),eH=Qi(el,ec.paint.get("fill-extrusion-cutoff-fade-range")),eZ=[];ek&&eZ.push("PROJECTION_GLOBE_VIEW"),ez[0]>0&&eZ.push("FAUX_AO"),eR&&eZ.push("ZERO_ROOF_RADIUS"),eb&&eZ.push("HAS_CENTROID"),eU>0&&eZ.push("FLOOD_LIGHT"),eH.shouldRenderCutoff&&eZ.push("RENDER_CUTOFF"),eG&&eZ.push("RENDER_WALL_MODE");let eW="shadow"===el.renderPass,eY=el.shadowRenderer;el.shadowRenderer&&(el.shadowRenderer.useNormalOffset=!0);let eX=[0,0,0];if(eY){let F=el.style.directionalLight,eh=el.style.ambientLight;F&&eh&&(eX=no(el.style,F,eh)),eW||(eZ.push("RENDER_SHADOWS","DEPTH_TEXTURE"),eY.useNormalOffset&&eZ.push("NORMAL_OFFSET")),ew=eZ.concat(["SHADOWS_SINGLE_CASCADE"])}let eK=eW&&eY?"fillExtrusionDepth":eI?"fillExtrusionPattern":"fillExtrusion",eJ=ec.getLayerRenderingStats();for(let eC of ep){let ep;let eP=eh.getTile(eC),eD=eP.getBucket(ec);if(!eD||eD.projection.name!==eE.projection.name)continue;let eR=!1;eY&&(eR=0===eY.getMaxCascadeForTile(eC.toUnwrapped()));let eN=el.isTileAffectedByFog(eC),eQ=eD.programConfigurations.get(ec.id),e0=el.getOrCreateProgram(eK,{config:eQ,defines:eR?ew:eZ,overrideFog:eN});if(el.terrain&&el.terrain.setupElevationDraw(eP,e0,{useMeterToDem:!0}),!eD.centroidVertexBuffer){let F=e0.attributes.a_centroid_pos;void 0!==F&&eS.vertexAttrib2f(F,0,0)}!eW&&eY&&eY.setupShadows(eP.tileID.toUnwrapped(),e0,"vector-tile",eP.tileID.overscaledZ),eI&&(el.context.activeTexture.set(eS.TEXTURE0),eP.imageAtlasTexture&&eP.imageAtlasTexture.bind(eS.LINEAR,eS.CLAMP_TO_EDGE),eQ.updatePaintBuffers());let e1=eM.constantOr(null);if(e1&&eP.imageAtlas){let el=eP.imageAtlas,eh=F.d0.from(e1).getPrimary().scaleSelf(F.q.devicePixelRatio),ec=el.patternPositions.get(eh.toString());ec&&eQ.setConstantPatternPositions(ec)}let e2=ec.paint.get("fill-extrusion-vertical-gradient"),e3=1/eD.tileToMeter;if(eW&&eY){if(function(el,eh,ec){let ep=ec.transform,e_=ec.shadowRenderer;if(!e_)return!0;let eg=el.toUnwrapped(),ey=ep.tileSize*e_._cascades[ec.currentShadowCascade].scale,eb=eh.maxHeight;if(ep.elevation){let F=ep.elevation.getMinMaxForTile(el);F&&(eb+=F.max)}let ew=[...e_.shadowDirection];ew[2]=-ew[2];let eT=e_.computeSimplifiedTileShadowVolume(eg,eb,ey,ew);if(!eT)return!1;let eS=[tZ,tW,tY,ew,[ew[0],0,ew[2]],[0,ew[1],ew[2]]],eE="globe"===ep.projection.name,eM=ep.scaleZoom(ey),eI=F.bR.fromInvProjectionMatrix(ep.invProjMatrix,ep.worldSize,eM,!eE),eA=e_.getCurrentCascadeFrustum();return 0===eI.intersectsPrecise(eT.vertices,eT.planes,eS)||0===eA.intersectsPrecise(eT.vertices,eT.planes,eS)}(eP.tileID,eD,el))continue;let eh=eY.calculateShadowPassMatrixFromTile(eP.tileID.toUnwrapped());ep=Js(eh,eL,e3,ej,eq,e$)}else{let F=el.translatePosMatrix(eC.expandedProjMatrix,eP,ec.paint.get("fill-extrusion-translate"),ec.paint.get("fill-extrusion-translate-anchor")),eh=eE.projection.createInversionMatrix(eE,eC.canonical);ep=eI?Qs(F,el,e2,eA,ez,eL,e3,eC,eP,eO,eq,e$,eF,eB,eh,eV,ej):Ys(F,el,e2,eA,ez,eL,e3,eC,eO,eq,e$,eF,eB,eh,eV,ej,eU,eX)}el.uploadCommonUniforms(eT,e0,eC.toUnwrapped(),null,eH);let e4=eD.segments;if("mercator"===eE.projection.name&&!eW&&!(e4=eD.getVisibleSegments(eP.tileID,el.terrain,el.transform.getFrustum(0))).get().length)continue;if(eJ){if(eW)for(let F of e4.get())eJ.numRenderedVerticesInShadowPass+=F.primitiveLength;else for(let F of e4.get())eJ.numRenderedVerticesInTransparentPass+=F.primitiveLength}let e5=[];(el.terrain||eb)&&e5.push(eD.centroidVertexBuffer),ek&&e5.push(eD.layoutVertexExtBuffer),eG&&e5.push(eD.wallVertexBuffer),e0.draw(el,eT.gl.TRIANGLES,e_,eg,ey,ji.backCCW,ep,ec.id,eD.layoutVertexBuffer,eD.indexBuffer,e4,ec.paint,el.transform.zoom,eQ,e5)}el.shadowRenderer&&(el.shadowRenderer.useNormalOffset=!1)}function Gr(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE,eM,eI,eA,eC,eP,ez,eD){let eR=el.context,eL=eR.gl,eO=el.transform,ek=el.transform.zoom,eF=[],eB=Qi(el,ec.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===eT?(eF.push("CLEAR_SUBPASS"),eD&&(eF.push("CLEAR_FROM_TEXTURE"),eR.activeTexture.set(eL.TEXTURE0),eD.bind(eL.LINEAR,eL.CLAMP_TO_EDGE))):"sdf"===eT&&eF.push("SDF_SUBPASS"),eP&&eF.push("HAS_CENTROID"),eB.shouldRenderCutoff&&eF.push("RENDER_CUTOFF");let eN=ec.layout.get("fill-extrusion-edge-radius"),I=(F,eh,ep,eT,ez)=>{var eL,eO;let eV=eh.programConfigurations.get(ec.id),eU=el.isTileAffectedByFog(F),ej=el.getOrCreateProgram("fillExtrusionGroundEffect",{config:eV,defines:eF,overrideFog:eU}),eG=(eL=[eE,eM*ez],eO=ek>=17?0:eN*ez,{u_matrix:eT,u_opacity:eS,u_ao_pass:ew?1:0,u_meter_to_tile:ez,u_ao:eL,u_flood_light_intensity:eI,u_flood_light_color:eA,u_attenuation:eC,u_edge_radius:eO,u_fb:0,u_fb_size:eD?eD.size[0]:0,u_dynamic_offset:1}),eq=[];eP&&eq.push(eh.hiddenByLandmarkVertexBuffer),el.uploadCommonUniforms(eR,ej,F.toUnwrapped(),null,eB),ej.draw(el,eR.gl.TRIANGLES,e_,eg,ey,eb,eG,ec.id,eh.vertexBuffer,eh.indexBuffer,ep,ec.paint,ek,eV,eq)};for(let e_ of ep){let ep=eh.getTile(e_),eg=ep.getBucket(ec);if(!eg||eg.projection.name!==eO.projection.name||!eg.groundEffect||eg.groundEffect&&!eg.groundEffect.hasData())continue;let ey=eg.groundEffect,eb=1/eg.tileToMeter;{let F=el.translatePosMatrix(e_.projMatrix,ep,ec.paint.get("fill-extrusion-translate"),ec.paint.get("fill-extrusion-translate-anchor")),eh=ey.getDefaultSegment();I(e_,ey,eh,F,eb)}if(ez)for(let eg=0;eg<4;eg++){let ey,ew;let eT=F.d7[eg](e_),eS=eh.getTile(eT);if(!eS)continue;let eE=eS.getBucket(ec);if(!eE||eE.projection.name!==eO.projection.name||!eE.groundEffect||eE.groundEffect&&!eE.groundEffect.hasData())continue;let eM=eE.groundEffect;0===eg?(ey=[-F.ai,0,0],ew=1):1===eg?(ey=[F.ai,0,0],ew=0):2===eg?(ey=[0,-F.ai,0],ew=3):(ey=[0,F.ai,0],ew=2);let eI=eM.regionSegments[ew];if(!eI)continue;let eA=new Float32Array(16);F.ad.mat4.translate(eA,e_.projMatrix,ey),I(e_,eM,eI,el.translatePosMatrix(eA,ep,ec.paint.get("fill-extrusion-translate"),ec.paint.get("fill-extrusion-translate-anchor")),eb)}}}let tZ=[1,0,0],tW=[0,1,0],tY=[0,0,1];function $r(el){return[el[0]*F.dc,el[1]*F.dc,el[2]*F.dc,0]}function Xr(el,eh,ec,ep,e_,eg,ey,eb,ew){var eT,eS,eE,eM;let eI,eA,eC,eP;let ez=ep.getSource(),eD=ec.globeSharedBuffers;if(!eD||(eh&&(eI=ep.getTile(eh)),ez instanceof F.aK?(eA=ez.texture,eC=F.cJ(0,0,ec.transform)):eI&&eh&&(eA=eI.texture,eC=F.cJ(eh.canonical.z,eh.canonical.x,ec.transform)),!eA||!eC))return;el||(eC=F.ad.mat4.scale(F.ad.mat4.create(),eC,[1,-1,1]));let eR=ec.context,eL=eR.gl,eO="nearest"===e_.paint.get("raster-resampling")?eL.NEAREST:eL.LINEAR,ek=ec.colorModeForDrapableLayerRenderPass(eg),eF=ey.defines;eF.push("GLOBE_POLES");let eB=new Bi(eL.LEQUAL,Bi.ReadWrite,ec.depthRangeFor3D),eN=Float32Array.from(ec.transform.expandedFarZProjMatrix),eV=Float32Array.from(F.bc(F.cI(new F.bT(0,0,0))));ec.terrain&&ec.terrain.prepareDrawTile(),eR.activeTexture.set(eL.TEXTURE0),eA.bind(eO,eL.CLAMP_TO_EDGE),eR.activeTexture.set(eL.TEXTURE1),eA.bind(eO,eL.CLAMP_TO_EDGE),"useMipmap"in eA&&eR.extTextureFilterAnisotropic&&ec.transform.pitch>20&&eL.texParameterf(eL.TEXTURE_2D,eR.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,eR.extTextureFilterAnisotropicMax);let[eU,ej,eG,eq]=eh?eD.getPoleBuffers(eh.canonical.z,!1):eD.getPoleBuffers(0,!0),e$=e_.paint.get("raster-elevation");el?(eP=eU,ec.renderDefaultNorthPole=0!==e$):(eP=ej,ec.renderDefaultSouthPole=0!==e$);let eH=$r(ey.mix),eZ=(eT=eC,eS=F.ag(ec.transform.zoom),eE=ey.offset,eM=ey.range,dr(eN,eV,eT,new Float32Array(16),new Float32Array(9),[0,0],eS,[0,0],[0,0,0,0],1,{opacity:1,mix:0},e_,[0,0],e$,2,eH,eE,eM,1,0,eg)),eW=ec.getOrCreateProgram("raster",{defines:eF});ec.uploadCommonUniforms(eR,eW,null),eW.draw(ec,eL.TRIANGLES,eB,ew,ek,eb,eZ,e_.id,eP,eG,eq)}var tX=F.dd([{name:"a_index",type:"Int16",components:1}]);let Qr=class Qr{constructor(el,eh,ec,ep){let e_={width:ec[0],height:ec[1],data:null},eg=el.gl;this.targetColorTexture=new F.T(el,e_,eg.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new F.T(el,e_,eg.RGBA8,{useMipmap:!1}),this.context=el,this.updateParticleTexture(eh,ep),this.lastInvalidatedAt=0}updateParticleTexture(el,eh){if(this.particleTextureDimension===eh.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());let ec=this.context.gl,ep=eh.width*eh.height;this.particleTexture0=new F.T(this.context,eh,ec.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new F.T(this.context,eh,ec.RGBA8,{premultiply:!1,useMipmap:!1});let e_=new F.de;e_.reserve(ep);for(let F=0;F<ep;F++)e_.emplaceBack(F);this.particleIndexBuffer=this.context.createVertexBuffer(e_,tX.members,!0),this.particleSegment=F.b8.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=eh.width}update(el){return!(this.lastInvalidatedAt<el&&(this.lastInvalidatedAt=F.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}};let tK=new F.al(1,0,0,1),tJ=new F.al(0,1,0,1),tQ=new F.al(0,0,1,1),t0=new F.al(1,0,1,1),t1=new F.al(0,1,1,1);function ln(el,eh,ec,ep,e_,eg,ey){let eb=el.context,ew=el.transform,eT=eb.gl,eS="globe"===ew.projection.name,eE=F.ad.mat4.clone(ec.projMatrix);if(eS&&F.ag(ew.zoom)>0){let el=F.bb(ec.canonical,ew),eh=F.dg(el);eE=F.ad.mat4.multiply(new Float32Array(16),ew.globeMatrix,eh),F.ad.mat4.multiply(eE,ew.projMatrix,eE)}let eM=F.ad.mat4.create();eM[12]+=2*e_/(F.q.devicePixelRatio*ew.width),eM[13]+=2*eg/(F.q.devicePixelRatio*ew.height),F.ad.mat4.multiply(eE,eM,eE);let eI=el.getOrCreateProgram("debug",{defines:eS?["PROJECTION_GLOBE_VIEW"]:[]}),eA=eh.getTileByID(ec.key);el.terrain&&el.terrain.setupElevationDraw(eA,eI);let eC=Bi.disabled,eP=Ui.disabled,ez=el.colorModeForRenderPass(),eD="$debug";eb.activeTexture.set(eT.TEXTURE0),el.emptyTexture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE),eS?eA._makeGlobeTileDebugBuffers(el.context,ew):eA._makeDebugTileBoundsBuffers(el.context,ew.projection);let eR=eA._tileDebugBuffer||el.debugBuffer,eL=eA._tileDebugIndexBuffer||el.debugIndexBuffer,eO=eA._tileDebugSegments||el.debugSegments;if(eI.draw(el,eT.LINE_STRIP,eC,eP,ez,ji.disabled,nr(eE,ep),eD,eR,eL,eO,null,null,null,[eA._globeTileDebugBorderBuffer]),ey){let F=eA.latestRawTileData,eh=Math.floor((F&&F.byteLength||0)/1024),ep=ec.canonical.toString();ec.overscaledZ!==ec.canonical.z&&(ep+=` => ${ec.overscaledZ}`),function(F,el){F.initDebugOverlayCanvas();let eh=F.debugOverlayCanvas,ec=F.context.gl,ep=F.debugOverlayCanvas.getContext("2d");ep.clearRect(0,0,eh.width,eh.height),ep.shadowColor="white",ep.shadowBlur=2,ep.lineWidth=1.5,ep.strokeStyle="white",ep.textBaseline="top",ep.font="bold 36px Open Sans, sans-serif",ep.fillText(el,5,5),ep.strokeText(el,5,5),F.debugOverlayTexture.update(eh),F.debugOverlayTexture.bind(ec.LINEAR,ec.CLAMP_TO_EDGE)}(el,ep+=` ${eA.state} ${eh}kb`)}let ek=eh.getTile(ec).tileSize,eF=512/Math.min(ek,512)*(ec.overscaledZ/ew.zoom)*.5,eB=eA._tileDebugTextBuffer||el.debugBuffer,eN=eA._tileDebugTextIndexBuffer||el.quadTriangleIndexBuffer,eV=eA._tileDebugTextSegments||el.debugSegments;eI.draw(el,eT.TRIANGLES,eC,eP,ki.alphaBlended,ji.disabled,nr(eE,F.al.transparent,eF),eD,eB,eN,eV,null,null,null,[eA._globeTileDebugTextBuffer])}function cn(F,el,eh,ec){dn(F,0,el+eh/2,F.transform.width,eh,ec)}function hn(F,el,eh,ec){dn(F,el-eh/2,0,eh,F.transform.height,ec)}function dn(el,eh,ec,ep,e_,eg){let ey=el.context,eb=ey.gl;eb.enable(eb.SCISSOR_TEST),eb.scissor(eh*F.q.devicePixelRatio,ec*F.q.devicePixelRatio,ep*F.q.devicePixelRatio,e_*F.q.devicePixelRatio),ey.clear({color:eg}),eb.disable(eb.SCISSOR_TEST)}let t2=F.dd([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:t3}=t2;function pn(F,el,eh,ec){F.emplaceBack(el,eh,ec)}let fn=class fn{constructor(el){this.vertexArray=new F.dh,this.indices=new F.aV,pn(this.vertexArray,-1,-1,1),pn(this.vertexArray,1,-1,1),pn(this.vertexArray,-1,1,1),pn(this.vertexArray,1,1,1),pn(this.vertexArray,-1,-1,-1),pn(this.vertexArray,1,-1,-1),pn(this.vertexArray,-1,1,-1),pn(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=el.createVertexBuffer(this.vertexArray,t3),this.indexBuffer=el.createIndexBuffer(this.indices),this.segment=F.b8.simpleSegment(0,0,36,12)}};function mn(el,eh,ec,ep,e_,eg){let ey=el.context.gl,eb=eh.paint.get("sky-atmosphere-color"),ew=eh.paint.get("sky-atmosphere-halo-color"),eT=eh.paint.get("sky-atmosphere-sun-intensity"),eS={u_matrix_3f:F.ad.mat3.fromMat4(F.ad.mat3.create(),ep),u_sun_direction:e_,u_sun_intensity:eT,u_color_tint_r:[eb.r,eb.g,eb.b,eb.a],u_color_tint_m:[ew.r,ew.g,ew.b,ew.a],u_luminance:5e-5};ey.framebufferTexture2D(ey.FRAMEBUFFER,ey.COLOR_ATTACHMENT0,ey.TEXTURE_CUBE_MAP_POSITIVE_X+eg,eh.skyboxTexture,0),ec.draw(el,ey.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.frontCW,eS,"skyboxCapture",eh.skyboxGeometry.vertexBuffer,eh.skyboxGeometry.indexBuffer,eh.skyboxGeometry.segment)}let t4=F.dd([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);let vn=class vn{constructor(el){let eh=new F.di;eh.emplaceBack(-1,1,1,0,0),eh.emplaceBack(1,1,1,1,0),eh.emplaceBack(1,-1,1,1,1),eh.emplaceBack(-1,-1,1,0,1);let ec=new F.aV;ec.emplaceBack(0,1,2),ec.emplaceBack(2,3,0),this.vertexBuffer=el.createVertexBuffer(eh,t4.members),this.indexBuffer=el.createIndexBuffer(ec),this.segments=F.b8.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}};let t5=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);let xn=class xn{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}};let bn=class bn{constructor(el){this.colorModeAlphaBlendedWriteRGB=new ki([1,771,1,771],F.al.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ki([1,0,1,0],F.al.transparent,[!1,!1,!1,!0]),this.params=new xn,this.updateNeeded=!0,el.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),el.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),el.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),el.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(el){let eh=el.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new vn(eh);let el=this.params.sizeRange,ec=this.params.intensityRange,ep=function(el){let eh=F.dl(30),ec=[];for(let ep=0;ep<el;++ep){let el=2*Math.PI*eh(),ep=Math.acos(1-2*eh())-.5*Math.PI;ec.push(F.ad.vec3.fromValues(Math.cos(ep)*Math.cos(el),Math.cos(ep)*Math.sin(el),Math.sin(ep)))}return ec}(this.params.starsCount),e_=F.dl(300),eg=new F.dj,ey=new F.aV,eb=0;for(let eh=0;eh<ep.length;++eh){let ew=F.ad.vec3.scale([],ep[eh],200),eT=Math.max(0,1+.01*el*(1*e_()-.5)),eS=Math.max(0,1+.01*ec*(1*e_()-.5));eg.emplaceBack(ew[0],ew[1],ew[2],-1,-1,eT,eS),eg.emplaceBack(ew[0],ew[1],ew[2],1,-1,eT,eS),eg.emplaceBack(ew[0],ew[1],ew[2],1,1,eT,eS),eg.emplaceBack(ew[0],ew[1],ew[2],-1,1,eT,eS),ey.emplaceBack(eb+0,eb+1,eb+2),ey.emplaceBack(eb+0,eb+2,eb+3),eb+=4}this.starsVx=eh.createVertexBuffer(eg,t5.members),this.starsIdx=eh.createIndexBuffer(ey),this.starsSegments=F.b8.simpleSegment(0,0,eg.length,ey.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(el,eh){let ec=el.context,ep=ec.gl,e_=el.transform,eg=new Bi(ep.LEQUAL,Bi.ReadOnly,[0,1]),ey=F.ag(e_.zoom),eb=el.style.getLut(eh.scope),ew="none"===eh.properties.get("color-use-theme"),eT=eh.properties.get("color").toRenderColor(ew?null:eb).toArray01(),eS="none"===eh.properties.get("high-color-use-theme"),eE=eh.properties.get("high-color").toRenderColor(eS?null:eb).toArray01(),eM="none"===eh.properties.get("space-color-use-theme"),eI=eh.properties.get("space-color").toRenderColor(eM?null:eb).toArray01PremultipliedAlpha(),eA=F.dk(eh.properties.get("horizon-blend"),0,1,5e-4,.25),eC=F.cD(el,ec,e_)&&5e-4===eA?e_.worldSize/(2*Math.PI*1.025)-1:e_.globeRadius,eP=el.frameCounter/1e3%1,ez=F.ad.vec3.length(e_.globeCenterInViewSpace),eD=Math.sqrt(Math.pow(ez,2)-Math.pow(eC,2)),eR=Math.acos(eD/ez),w=F=>{var eh,eb,ew;let eS="globe"===e_.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];F&&eS.push("ALPHA_PASS");let eM=el.getOrCreateProgram("globeAtmosphere",{defines:eS}),eC=(eh=e_.frustumCorners.TL,eb=e_.frustumCorners.TR,ew=e_.frustumCorners.BR,{u_frustum_tl:eh,u_frustum_tr:eb,u_frustum_br:ew,u_frustum_bl:e_.frustumCorners.BL,u_horizon:e_.frustumCorners.horizon,u_transition:ey,u_fadeout_range:eA,u_color:eT,u_high_color:eE,u_space_color:eI,u_temporal_offset:eP,u_horizon_angle:eR});el.uploadCommonUniforms(ec,eM);let ez=this.atmosphereBuffer;ez&&eM.draw(el,ep.TRIANGLES,eg,Ui.disabled,F?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,ji.backCW,eC,F?"atmosphere_glow_alpha":"atmosphere_glow",ez.vertexBuffer,ez.indexBuffer,ez.segments)};w(!1),w(!0)}drawStars(el,eh){let ec=F.ay(eh.properties.get("star-intensity"),0,1);if(0===ec)return;let ep=el.context,e_=ep.gl,eg=el.transform,ey=el.getOrCreateProgram("stars"),eb=F.ad.quat.identity([]);F.ad.quat.rotateX(eb,eb,-eg._pitch),F.ad.quat.rotateZ(eb,eb,-eg.angle),F.ad.quat.rotateX(eb,eb,F.ak(eg._center.lat)),F.ad.quat.rotateY(eb,eb,-F.ak(eg._center.lng));let ew=F.ad.mat4.fromQuat(new Float32Array(16),eb),eT=F.ad.mat4.multiply([],eg.starsProjMatrix,ew),eS=F.ad.mat3.fromMat4([],ew),eE=F.ad.mat3.invert([],eS),eM=[0,1,0];F.ad.vec3.transformMat3(eM,eM,eE),F.ad.vec3.scale(eM,eM,this.params.sizeMultiplier);let eI=[1,0,0];F.ad.vec3.transformMat3(eI,eI,eE),F.ad.vec3.scale(eI,eI,this.params.sizeMultiplier);let eA={u_matrix:Float32Array.from(eT),u_up:eM,u_right:eI,u_intensity_multiplier:ec};el.uploadCommonUniforms(ep,ey),this.starsVx&&this.starsIdx&&ey.draw(el,e_.TRIANGLES,Bi.disabled,Ui.disabled,this.colorModeAlphaBlendedWriteRGB,ji.disabled,eA,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}};function wn(el,eh){let ec=[...el],ep=eh.cameraWorldSizeForFog/eh.worldSize,e_=F.ad.mat4.identity([]);return F.ad.mat4.scale(e_,e_,[ep,ep,1]),F.ad.mat4.multiply(ec,e_,ec),F.ad.mat4.multiply(ec,eh.worldToFogMatrix,ec),ec}function Tn(el,eh,ec,ep,e_){let eg=ec.material,ey=ep.context,{baseColorTexture:eb,metallicRoughnessTexture:ew}=eg.pbrMetallicRoughness,{normalTexture:eT,occlusionTexture:eS,emissionTexture:eE}=eg;function _(F,eh,ec){if(F&&(el.push(eh),ey.activeTexture.set(ey.gl.TEXTURE0+ec),F.gfxTexture)){let{minFilter:el,magFilter:eh,wrapS:ec,wrapT:ep}=F.sampler;F.gfxTexture.bindExtraParam(el,eh,ec,ep)}}_(eb,"HAS_TEXTURE_u_baseColorTexture",e5.BaseColor),_(ew,"HAS_TEXTURE_u_metallicRoughnessTexture",e5.MetallicRoughness),_(eT,"HAS_TEXTURE_u_normalTexture",e5.Normal),_(eS,"HAS_TEXTURE_u_occlusionTexture",e5.Occlusion),_(eE,"HAS_TEXTURE_u_emissionTexture",e5.Emission),e_&&(e_.texture||(e_.texture=new F.dn(ep.context,e_.image,[e_.image.height,e_.image.height,e_.image.height],ey.gl.RGBA8)),ey.activeTexture.set(ey.gl.TEXTURE0+e5.LUT),e_.texture&&e_.texture.bind(ey.gl.LINEAR,ey.gl.CLAMP_TO_EDGE),el.push("APPLY_LUT_ON_GPU")),ec.texcoordBuffer&&(el.push("HAS_ATTRIBUTE_a_uv_2f"),eh.push(ec.texcoordBuffer)),ec.colorBuffer&&(el.push(12===ec.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),eh.push(ec.colorBuffer)),ec.normalBuffer&&(el.push("HAS_ATTRIBUTE_a_normal_3f"),eh.push(ec.normalBuffer)),ec.pbrBuffer&&(el.push("HAS_ATTRIBUTE_a_pbr"),el.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),eh.push(ec.pbrBuffer)),"OPAQUE"!==eg.alphaMode&&"MASK"!==eg.alphaMode||el.push("UNPREMULT_TEXTURE_IN_SHADER"),eg.defined||el.push("DIFFUSE_SHADED");let eM=ep.shadowRenderer;eM&&(el.push("RENDER_SHADOWS","DEPTH_TEXTURE"),eM.useNormalOffset&&el.push("NORMAL_OFFSET"))}function En(el,eh,ec,ep,e_,eg){let ey;let eb=ec.paint.get("model-opacity").constantOr(1),ew=eh.context,eT=new Bi(eh.context.gl.LEQUAL,Bi.ReadWrite,eh.depthRangeFor3D),eS=eh.transform,eE=el.mesh,eM=eE.material,eI=eM.pbrMetallicRoughness,eA=eh.style.fog;ey="pixels"===eh.transform.projection.zAxisUnit?[...el.nodeModelMatrix]:F.ad.mat4.multiply([],ep.zScaleMatrix,el.nodeModelMatrix),F.ad.mat4.multiply(ey,ep.negCameraPosMatrix,ey);let eC=F.ad.mat4.invert([],ey);F.ad.mat4.transpose(eC,eC);let eP="none"===ec.paint.get("model-color-use-theme").constantOr("default"),ez=ec.paint.get("model-emissive-strength").constantOr(0),eD=wr(new Float32Array(el.worldViewProjection),new Float32Array(ey),new Float32Array(eC),null,eh,eb,eI.baseColorFactor.toRenderColor(null),eM.emissiveFactor,eI.metallicFactor,eI.roughnessFactor,eM,ez,ec),eR={defines:[]},eL=[],eO=eh.shadowRenderer;eO&&(eO.useNormalOffset=!1),Tn(eR.defines,eL,eE,eh,eP?null:ec.lut);let ek=null;if(eA){let F=wn(el.nodeModelMatrix,eh.transform);if(ek=new Float32Array(F),"globe"!==eS.projection.name){let el=eE.aabb.min,eh=eE.aabb.max,[ec,ep]=eA.getOpacityForBounds(F,el[0],el[1],eh[0],eh[1]);eR.overrideFog=ec>=.05||ep>=.05}}let eF=Qi(eh,ec.paint.get("model-cutoff-fade-range"));eF.shouldRenderCutoff&&eR.defines.push("RENDER_CUTOFF");let eB=eh.getOrCreateProgram("model",eR);eh.uploadCommonUniforms(ew,eB,null,ek,eF),"shadow"!==eh.renderPass&&eO&&eO.setupShadowsFromMatrix(el.nodeModelMatrix,eB),eB.draw(eh,ew.gl.TRIANGLES,eT,e_,eg,eE.material.doubleSided?ji.disabled:ji.backCCW,eD,ec.id,eE.vertexBuffer,eE.indexBuffer,eE.segments,ec.paint,eh.transform.zoom,void 0,eL)}function Cn(F,el,eh,ec){let ep=eh.shadowRenderer;if(!ep)return;let e_=ep.getShadowPassDepthMode(),eg=ep.getShadowPassColorMode(),ey=ep.calculateShadowPassMatrixFromMatrix(el),eb=Tr(ey);eh.getOrCreateProgram("modelDepth",{defines:eh._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(eh,eh.context.gl.TRIANGLES,e_,Ui.disabled,eg,ji.backCCW,eb,ec.id,F.vertexBuffer,F.indexBuffer,F.segments,ec.paint,eh.transform.zoom,void 0,void 0)}let t6={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new F.ce([0,0,0],[F.ai,F.ai,0])},t8=[1,-1,1];let On=class On{};let Fn=class Fn{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(el,eh,ec){{let F=this._storage.get(eh.id);if(F)return F.lastUsedFrameIdx=el,F.buf}let ep=ec.gl,e_=ep.getBufferParameter(ep.ELEMENT_ARRAY_BUFFER,ep.BUFFER_SIZE),eg=new ArrayBuffer(e_),ey=new Int16Array(eg);ep.getBufferSubData(ep.ELEMENT_ARRAY_BUFFER,0,new Int16Array(eg));let eb=new F.dt;for(let F=0;F<e_/2;F+=3){let el=ey[F],eh=ey[F+1],ec=ey[F+2];eb.emplaceBack(el,eh),eb.emplaceBack(eh,ec),eb.emplaceBack(ec,el)}let ew=ec.bindVertexArrayOES.current,eT=new On;return eT.buf=new Sr(ec,eb),eT.lastUsedFrameIdx=el,this._storage.set(eh.id,eT),ec.bindVertexArrayOES.set(ew),eT.buf}update(F){for(let[el,eh]of this._storage)F-eh.lastUsedFrameIdx>30&&(eh.buf.destroy(),this._storage.delete(el))}destroy(){for(let[F,el]of this._storage)el.buf.destroy(),this._storage.delete(F)}};let kn=class kn{constructor(F){this.occluderSize=30,this.depthOffset=-.0001,F.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),F.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}};let t9=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);let Nn=class Nn{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}};let Un=class Un{constructor(F,el){this.revealStart=11,this.revealRange=2,F.registerParameter(this,[...el,"Reveal"],"revealStart",{min:0,max:17,step:.05}),F.registerParameter(this,[...el,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}};let t7=F.dd([{type:"Float32",name:"a_pos_2f",components:2}]);let Gn=class Gn{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(el,eh){var ec;let ep=el.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){let eh=new F.du,ec=new F.aV;eh.emplaceBack(-1,-1),eh.emplaceBack(1,-1),eh.emplaceBack(1,1),eh.emplaceBack(-1,1),ec.emplaceBack(0,1,2),ec.emplaceBack(0,2,3),this.vignetteVx=el.context.createVertexBuffer(eh,t7.members),this.vignetteIdx=el.context.createIndexBuffer(ec)}let e_=F.b8.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){el.uploadCommonUniforms(el.context,ep);let F={u_vignetteShape:(ec={vignetteShape:[eh.start,eh.range,Math.pow(10,eh.fadePower)],vignetteColor:[eh.color.r,eh.color.g,eh.color.b,eh.color.a*eh.strength]}).vignetteShape,u_vignetteColor:ec.vignetteColor};ep.draw(el,el.context.gl.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,F,"vignette",this.vignetteVx,this.vignetteIdx,e_)}}};let jn=class jn{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(el,eh){let ec=el.getFreeCameraOptions().position,ep=ec.toAltitude(),e_=ec.toLngLat(),eg=F.ak(e_.lng),ey=F.ak(e_.lat),eb=el.pixelsPerMeter/eh,ew=eg*F.dv,eT=F.dv*Math.log(Math.tan(Math.PI/4+ey/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{let F=-this._offsetYPrev+eT,el=-this._elevationPrev+ep;this._accumulatedOffsetX+=(-this._offsetXPrev+ew)*eb,this._accumulatedOffsetY+=F*eb,this._accumulatedElevation+=el*eb,this._offsetXPrev=ew,this._offsetYPrev=eT,this._elevationPrev=ep}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}};function qn(F,el){return[-(F[0]-Math.floor(F[0]/el)*el),-(F[1]-Math.floor(F[1]/el)*el),-(F[2]-Math.floor(F[2]/el)*el)]}function Hn(el){let eh=F.dl(1323123451230),ec=[];for(let ep=0;ep<el;++ep){let el=2*eh()-1,ep=2*eh()-1,e_=2*eh()-1;ec.push(F.ad.vec3.fromValues(el,ep,e_))}return ec}function Zn(el,eh,ec,ep,e_){let eg=F.ay((e_-ec)/(ep-ec),0,1);return(1-eg)*el+eg*eh}let Wn=class Wn{constructor(F){this._movement=new jn,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new Gn,this._ppmScaleFactor=F}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(el,eh){let ec=el.transform;this._movement.update(ec,this._ppmScaleFactor);let ep=ec.starsProjMatrix,e_=F.ad.quat.identity([]);F.ad.quat.rotateX(e_,e_,F.ak(90)-ec._pitch),F.ad.quat.rotateZ(e_,e_,-ec.angle);let eg=F.ad.mat4.fromQuat(new Float32Array(16),e_),ey=F.ad.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),eb=F.ad.mat4.transpose([],ey),ew=F.ad.mat4.multiply([],eb,eg),eT=Date.now()/1e3;return this._accumulatedTimeFromStart+=(eT-this._prevTime)*eh,this._prevTime=eT,{projectionMatrix:ep,modelviewMatrix:ew}}};let $n=class $n extends Wn{constructor(F){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Un(F.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(el){let eh=el.context;if(!this.particlesVx){let el=Hn(this.particlesCount),ec=new F.dw,ep=new F.aV,e_=0,eg=F.dl(1323123451230);for(let F=0;F<el.length;++F){let eh=el[F],ey=[2*eg()-1,eg(),eg(),eg()];ec.emplaceBack(eh[0],eh[1],eh[2],-1,-1,...ey),ec.emplaceBack(eh[0],eh[1],eh[2],1,-1,...ey),ec.emplaceBack(eh[0],eh[1],eh[2],1,1,...ey),ec.emplaceBack(eh[0],eh[1],eh[2],-1,1,...ey),ep.emplaceBack(e_+0,e_+1,e_+2),ep.emplaceBack(e_+0,e_+2,e_+3),e_+=4}this.particlesVx=eh.createVertexBuffer(ec,t9.members),this.particlesIdx=eh.createIndexBuffer(ep)}}draw(el){if(!this._params.overrideStyleParameters&&!el.style.rain)return;let eh=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},ec=el.transform.zoom;if(eh.revealStart>ec)return;let ep=Zn(0,1,eh.revealStart,eh.revealStart+eh.revealRange,ec);if(!this.particlesVx||!this.particlesIdx)return;let e_=structuredClone(this._params),eg=[-e_.direction.x,e_.direction.y,-100];F.ad.vec3.normalize(eg,eg);let ey=structuredClone(this._vignetteParams);ey.strength*=ep,e_.overrideStyleParameters||(e_.intensity=el.style.rain.state.density,e_.timeFactor=el.style.rain.state.intensity,e_.color=structuredClone(el.style.rain.state.color),eg=structuredClone(el.style.rain.state.direction),e_.screenThinning.intensity=el.style.rain.state.centerThinning,e_.dropletSizeX=el.style.rain.state.dropletSize[0],e_.dropletSizeYScale=el.style.rain.state.dropletSize[1]/el.style.rain.state.dropletSize[0],e_.distortionStrength=100*el.style.rain.state.distortionStrength,ey.strength=1,ey.color=structuredClone(el.style.rain.state.vignetteColor));let eb=this.updateOnRender(el,e_.timeFactor),ew=el.context,eT=ew.gl,eS=el.transform;this.screenTexture&&this.screenTexture.size[0]===el.width&&this.screenTexture.size[1]===el.height||(this.screenTexture=new F.T(ew,{width:el.width,height:el.height,data:null},eT.RGBA8)),e_.distortionStrength>0&&(ew.activeTexture.set(eT.TEXTURE0),this.screenTexture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE),eT.copyTexSubImage2D(eT.TEXTURE_2D,0,0,0,0,0,el.width,el.height));let eE=el.getOrCreateProgram("rainParticle");el.uploadCommonUniforms(ew,eE),ew.activeTexture.set(eT.TEXTURE0),this.screenTexture.bind(eT.LINEAR,eT.CLAMP_TO_EDGE);let eM=[e_.color.r,e_.color.g,e_.color.b,e_.color.a],p=(eh,ec)=>{var ep;let ey=qn(this._movement.getPosition(),eh),ew=e_.dropletSizeX,eI=e_.dropletSizeX*e_.dropletSizeYScale,eA=el.width/2,eC=el.height/2,eP=Zn(0,e_.screenThinning.start,0,1,e_.screenThinning.intensity),ez=Zn(.001,e_.screenThinning.range,0,1,e_.screenThinning.intensity),eD=Zn(0,e_.screenThinning.particleOffset,0,1,e_.screenThinning.intensity),eR=(ep={modelview:eb.modelviewMatrix,projection:eb.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ey,velocityConeAperture:e_.velocityConeAperture,velocity:e_.velocity,boxSize:eh,rainDropletSize:[ew,eI],distortionStrength:e_.distortionStrength,rainDirection:eg,color:eM,screenSize:[eS.width,eS.height],thinningCenterPos:[eA,eC],thinningShape:[eP,ez,Math.pow(10,e_.screenThinning.fadePower)],thinningAffectedRatio:e_.screenThinning.affectedRatio,thinningParticleOffset:eD,shapeDirectionalPower:e_.shapeDirPower,shapeNormalPower:e_.shapeNormalPower,mode:ec?0:1},{u_modelview:Float32Array.from(ep.modelview),u_projection:Float32Array.from(ep.projection),u_time:ep.time,u_cam_pos:ep.camPos,u_texScreen:0,u_velocityConeAperture:ep.velocityConeAperture,u_velocity:ep.velocity,u_boxSize:ep.boxSize,u_rainDropletSize:ep.rainDropletSize,u_distortionStrength:ep.distortionStrength,u_rainDirection:ep.rainDirection,u_color:ep.color,u_screenSize:ep.screenSize,u_thinningCenterPos:ep.thinningCenterPos,u_thinningShape:ep.thinningShape,u_thinningAffectedRatio:ep.thinningAffectedRatio,u_thinningParticleOffset:ep.thinningParticleOffset,u_shapeDirectionalPower:ep.shapeDirectionalPower,u_shapeNormalPower:ep.shapeNormalPower,u_mode:ep.mode}),eL=Math.round(e_.intensity*this.particlesCount),eO=F.b8.simpleSegment(0,0,4*eL,2*eL);eE.draw(el,eT.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,eR,"rain_particles",this.particlesVx,this.particlesIdx,eO)};e_.distortionStrength>0&&p(e_.boxSize,!0),p(e_.boxSize,!1),this._vignette.draw(el,ey)}};let iu=F.dd([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);let Kn=class Kn extends Wn{constructor(F){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Un(F.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(el){let eh=el.context;if(!this.particlesVx){let el=Hn(this.particlesCount),ec=new F.dx,ep=new F.aV,e_=0,eg=F.dl(1323123451230);for(let F=0;F<el.length;++F){let eh=el[F],ey=eg(),eb=eg(),ew=eg(),eT=[F/el.length,ey,eb,ew],eS=[eg(),eg()];ec.emplaceBack(eh[0],eh[1],eh[2],-1,-1,...eT,...eS),ec.emplaceBack(eh[0],eh[1],eh[2],1,-1,...eT,...eS),ec.emplaceBack(eh[0],eh[1],eh[2],1,1,...eT,...eS),ec.emplaceBack(eh[0],eh[1],eh[2],-1,1,...eT,...eS),ep.emplaceBack(e_+0,e_+1,e_+2),ep.emplaceBack(e_+0,e_+2,e_+3),e_+=4}this.particlesVx=eh.createVertexBuffer(ec,iu.members),this.particlesIdx=eh.createIndexBuffer(ep)}}draw(el){if(!this._params.overrideStyleParameters&&!el.style.snow)return;let eh=structuredClone(this._params),ec=[-eh.direction.x,eh.direction.y,-100];F.ad.vec3.normalize(ec,ec);let ep=structuredClone(this._vignetteParams),e_=eh.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},eg=el.transform.zoom;if(e_.revealStart>eg)return;let ey=Zn(0,1,e_.revealStart,e_.revealStart+e_.revealRange,eg);ep.strength*=ey,eh.overrideStyleParameters||(eh.intensity=el.style.snow.state.density,eh.timeFactor=el.style.snow.state.intensity,eh.color=structuredClone(el.style.snow.state.color),ec=structuredClone(el.style.snow.state.direction),eh.screenThinning.intensity=el.style.snow.state.centerThinning,eh.billboardSize=2.79*el.style.snow.state.flakeSize,ep.strength=1,ep.color=structuredClone(el.style.snow.state.vignetteColor));let eb=this.updateOnRender(el,eh.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;let ew=el.context,eT=ew.gl,eS=el.transform,eE=el.getOrCreateProgram("snowParticle");el.uploadCommonUniforms(ew,eE),((eh,ep,e_)=>{var eg;let ey=qn(this._movement.getPosition(),eh),ew=eS.width/2,eM=eS.height/2,eI=Zn(0,e_.screenThinning.start,0,1,e_.screenThinning.intensity),eA=Zn(.001,e_.screenThinning.range,0,1,e_.screenThinning.intensity),eC=Zn(0,e_.screenThinning.particleOffset,0,1,e_.screenThinning.intensity),eP=(eg={modelview:eb.modelviewMatrix,projection:eb.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:ey,velocityConeAperture:e_.velocityConeAperture,velocity:e_.velocity,horizontalOscillationRadius:e_.horizontalOscillationRadius,horizontalOscillationRate:e_.horizontalOscillationRate,boxSize:eh,billboardSize:1*e_.billboardSize,simpleShapeParameters:[e_.shapeFadeStart,e_.shapeFadePower],screenSize:[eS.width,eS.height],thinningCenterPos:[ew,eM],thinningShape:[eI,eA,Math.pow(10,e_.screenThinning.fadePower)],thinningAffectedRatio:e_.screenThinning.affectedRatio,thinningParticleOffset:eC,color:[e_.color.r,e_.color.g,e_.color.b,e_.color.a],direction:ec},{u_modelview:Float32Array.from(eg.modelview),u_projection:Float32Array.from(eg.projection),u_time:eg.time,u_cam_pos:eg.camPos,u_velocityConeAperture:eg.velocityConeAperture,u_velocity:eg.velocity,u_horizontalOscillationRadius:eg.horizontalOscillationRadius,u_horizontalOscillationRate:eg.horizontalOscillationRate,u_boxSize:eg.boxSize,u_billboardSize:eg.billboardSize,u_simpleShapeParameters:eg.simpleShapeParameters,u_screenSize:eg.screenSize,u_thinningCenterPos:eg.thinningCenterPos,u_thinningShape:eg.thinningShape,u_thinningAffectedRatio:eg.thinningAffectedRatio,u_thinningParticleOffset:eg.thinningParticleOffset,u_particleColor:eg.color,u_direction:eg.direction}),ez=Math.round(e_.intensity*this.particlesCount),eD=F.b8.simpleSegment(0,0,4*ez,2*ez);this.particlesVx&&this.particlesIdx&&eE.draw(el,eT.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,eP,"snow_particles",this.particlesVx,this.particlesIdx,eD)})(eh.boxSize,0,eh),this._vignette.draw(el,ep)}};let ic={symbol:function(el,eh,ec,ep,e_){if("translucent"!==el.renderPass)return;let eg=Ui.disabled,ey=el.colorModeForRenderPass(),eb=ec.layout.get("text-variable-anchor"),ew=ec.layout.get("text-size-scale-range"),eT=F.ay(el.scaleFactor,ew[0],ew[1]);eb&&function(el,eh,ec,ep,e_,eg,ey,eb){let ew=eh.transform,eT="map"===e_,eS="map"===eg;for(let eh of el){let el=ep.getTile(eh),e_=el.getBucket(ec);if(!e_||!e_.text||!e_.text.segments.get().length)continue;let eg=F.bp(e_.textSizeData,ew.zoom,eb),eE=ci(eh,e_.getProjection(),ew),eM=ew.calculatePixelsToTileUnitsMatrix(el),eI=qt(eE,el.tileID.canonical,eS,eT,ew,e_.getProjection(),eM),eA=e_.hasIconTextFit()&&e_.hasIconData();if(eg){let ec=Math.pow(2,ew.zoom-el.tileID.overscaledZ);!function(el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS){let eE=el.text.placedSymbolArray,eM=el.text.dynamicLayoutVertexArray,eI=el.icon.dynamicLayoutVertexArray,eA={},eC=el.getProjection(),eP=ci(eb,eC,eg),ez=eg.elevation,eD=eC.upVectorScale(eb.canonical,eg.center.lat,eg.worldSize).metersToTile;eM.clear();for(let eI=0;eI<eE.length;eI++){let eR=eE.get(eI),{tileAnchorX:eL,tileAnchorY:eO,numGlyphs:ek}=eR,eF=eR.hidden||!eR.crossTileID||el.allowVerticalPlacement&&!eR.placedOrientation?null:ep[eR.crossTileID];if(eF){let ep=0,eE=0,eI=0;if(ez){let F=ez?ez.getAtTileOffset(eb,eL,eO):0,[el,eh,ec]=eC.upVector(eb.canonical,eL,eO);ep=F*el*eD,eE=F*eh*eD,eI=F*ec*eD}let[eB,eN,eV,eU]=Wt(eR.projectedAnchorX+ep,eR.projectedAnchorY+eE,eR.projectedAnchorZ+eI,ec?eP:ey),ej=$t(eg.getCameraToCenterDistance(eC),eU),eG=e_.evaluateSizeForFeature(el.textSizeData,eT,eR)*ej/F.bw;ec&&(eG*=el.tilePixelRatio/ew);let eq=function({width:el,height:eh,anchor:ec,textOffset:ep,textScale:e_},eg){let{horizontalAlign:ey,verticalAlign:eb}=F.bD(ec),ew=F.bC(ec,ep);return new F.P((-(ey-.5)*el/e_+ew[0])*eg,(-(eb-.5)*eh/e_+ew[1])*eg)}(eF,eG);ec?({x:eB,y:eN,z:eV}=eC.projectTilePoint(eL+eq.x,eO+eq.y,eb.canonical),[eB,eN,eV]=Wt(eB+ep,eN+eE,eV+eI,ey)):(eh&&eq._rotate(-eg.angle),eB+=eq.x,eN+=eq.y,eV=0);let e$=el.allowVerticalPlacement&&eR.placedOrientation===F.bq.vertical?Math.PI/2:0;for(let el=0;el<ek;el++)F.bt(eM,eB,eN,eV,e$);eS&&eR.associatedIconIndex>=0&&(eA[eR.associatedIconIndex]={x:eB,y:eN,z:eV,angle:e$})}else oi(ek,eM)}if(eS){eI.clear();let eh=el.icon.placedSymbolArray;for(let el=0;el<eh.length;el++){let ec=eh.get(el),{numGlyphs:ep}=ec,e_=eA[el];if(ec.hidden||!e_)oi(ep,eI);else{let{x:el,y:eh,z:ec,angle:eg}=e_;for(let e_=0;e_<ep;e_++)F.bt(eI,el,eh,ec,eg)}}el.icon.dynamicLayoutVertexBuffer.updateData(eI)}el.text.dynamicLayoutVertexBuffer.updateData(eM)}(e_,eT,eS,ey,F.cY,ew,eI,eh,ec,eg,eA)}}}(ep,el,ec,eh,ec.layout.get("text-rotation-alignment"),ec.layout.get("text-pitch-alignment"),e_,eT);let eS=0!==ec.paint.get("icon-opacity").constantOr(1),eE=0!==ec.paint.get("text-opacity").constantOr(1);void 0!==ec.layout.get("symbol-sort-key").constantOr(1)&&(eS||eE)?Fr(el,eh,ec,ep,eg,ey):(eS&&Fr(el,eh,ec,ep,eg,ey,{onlyIcons:!0}),eE&&Fr(el,eh,ec,ep,eg,ey,{onlyText:!0})),eh.map.showCollisionBoxes&&(Lr(el,eh,ec,ep,ec.paint.get("text-translate"),ec.paint.get("text-translate-anchor"),!0),Lr(el,eh,ec,ep,ec.paint.get("icon-translate"),ec.paint.get("icon-translate-anchor"),!1))},circle:function(el,eh,ec,ep){if("translucent"!==el.renderPass)return;let e_=ec.paint.get("circle-opacity"),eg=ec.paint.get("circle-stroke-width"),ey=ec.paint.get("circle-stroke-opacity"),eb=void 0!==ec.layout.get("circle-sort-key").constantOr(1),ew=ec.paint.get("circle-emissive-strength");if(0===e_.constantOr(1)&&(0===eg.constantOr(1)||0===ey.constantOr(1)))return;let eT=el.context,eS=eT.gl,eE=el.transform,eM=el.depthModeForSublayer(0,Bi.ReadOnly),eI=Ui.disabled,eA=el.colorModeForDrapableLayerRenderPass(ew),eC="globe"===eE.projection.name,eP=[F.av(eE.center.lng),F.aC(eE.center.lat)],ez=[];for(let e_=0;e_<ep.length;e_++){let eg=ep[e_],ey=eh.getTile(eg),ew=ey.getBucket(ec);if(!ew||ew.projection.name!==eE.projection.name)continue;let eT=ew.programConfigurations.get(ec.id),eS=F.cZ(ec),eM=el.isTileAffectedByFog(eg);eC&&eS.push("PROJECTION_GLOBE_VIEW"),eS.push("DEPTH_D24"),el.terrain&&eE.depthOcclusionForSymbolsAndCircles&&eS.push("DEPTH_OCCLUSION");let eI=el.getOrCreateProgram("circle",{config:eT,defines:eS,overrideFog:eM}),eA=ew.layoutVertexBuffer,eD=ew.globeExtVertexBuffer,eR=ew.indexBuffer,eL=eE.projection.createInversionMatrix(eE,eg.canonical),eO={programConfiguration:eT,program:eI,layoutVertexBuffer:eA,globeExtVertexBuffer:eD,indexBuffer:eR,uniformValues:F.c_(el,eg,ey,eL,eP,ec),tile:ey};if(eb){let el=ew.segments.get();for(let eh of el)ez.push({segments:new F.b8([eh]),sortKey:eh.sortKey,state:eO})}else ez.push({segments:ew.segments,sortKey:0,state:eO})}eb&&ez.sort((F,el)=>F.sortKey-el.sortKey);let eD={useDepthForOcclusion:eE.depthOcclusionForSymbolsAndCircles};for(let F of ez){let{programConfiguration:eh,program:ep,layoutVertexBuffer:e_,globeExtVertexBuffer:eg,indexBuffer:ey,uniformValues:eb,tile:ew}=F.state,eC=F.segments;el.terrain&&el.terrain.setupElevationDraw(ew,ep,eD),el.uploadCommonUniforms(eT,ep,ew.tileID.toUnwrapped()),ep.draw(el,eS.TRIANGLES,eM,eI,eA,ji.disabled,eb,ec.id,e_,ey,eC,ec.paint,eE.zoom,eh,[eg])}},heatmap:function(el,eh,ec,ep){if(0!==ec.paint.get("heatmap-opacity")){if("offscreen"===el.renderPass){let e_=el.context,eg=e_.gl,ey=Ui.disabled,eb=new ki([eg.ONE,eg.ONE,eg.ONE,eg.ONE],F.al.transparent,[!0,!0,!0,!0]);(function(F,el,eh,ec){let ep=F.gl,e_=el.width*ec,eg=el.height*ec;F.activeTexture.set(ep.TEXTURE1),F.viewport.set([0,0,e_,eg]);let ey=eh.heatmapFbo;if(!ey||ey&&(ey.width!==e_||ey.height!==eg)){ey&&ey.destroy();let el=ep.createTexture();ep.bindTexture(ep.TEXTURE_2D,el),ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_WRAP_S,ep.CLAMP_TO_EDGE),ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_WRAP_T,ep.CLAMP_TO_EDGE),ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_MIN_FILTER,ep.LINEAR),ep.texParameteri(ep.TEXTURE_2D,ep.TEXTURE_MAG_FILTER,ep.LINEAR),ey=eh.heatmapFbo=F.createFramebuffer(e_,eg,!0,null),function(F,el,eh,ec,ep,e_){let eg=F.gl;eg.texImage2D(eg.TEXTURE_2D,0,F.extRenderToTextureHalfFloat?eg.RGBA16F:eg.RGBA,ep,e_,0,eg.RGBA,F.extRenderToTextureHalfFloat?eg.HALF_FLOAT:eg.UNSIGNED_BYTE,null),ec.colorAttachment.set(eh)}(F,0,el,ey,e_,eg)}else ep.bindTexture(ep.TEXTURE_2D,ey.colorAttachment.get()),F.bindFramebuffer.set(ey.framebuffer)})(e_,el,ec,"globe"===el.transform.projection.name?.5:.25),e_.clear({color:F.al.transparent});let ew=el.transform,eT="globe"===ew.projection.name,eS=eT?["PROJECTION_GLOBE_VIEW"]:[],eE=eT?ji.frontCCW:ji.disabled,eM=[F.av(ew.center.lng),F.aC(ew.center.lat)];for(let F=0;F<ep.length;F++){let eI=ep[F];if(eh.hasRenderableParent(eI))continue;let eA=eh.getTile(eI),eC=eA.getBucket(ec);if(!eC||eC.projection.name!==ew.projection.name)continue;let eP=el.isTileAffectedByFog(eI),ez=eC.programConfigurations.get(ec.id),eD=el.getOrCreateProgram("heatmap",{config:ez,defines:eS,overrideFog:eP}),{zoom:eR}=el.transform;el.terrain&&el.terrain.setupElevationDraw(eA,eD),el.uploadCommonUniforms(e_,eD,eI.toUnwrapped());let eL=ew.projection.createInversionMatrix(ew,eI.canonical);eD.draw(el,eg.TRIANGLES,Bi.disabled,ey,eb,eE,lr(el,eI,eA,eL,eM,eR,ec.paint.get("heatmap-intensity")),ec.id,eC.layoutVertexBuffer,eC.indexBuffer,eC.segments,ec.paint,el.transform.zoom,ez,eT?[eC.globeExtVertexBuffer]:null)}e_.viewport.set([0,0,el.width,el.height])}else"translucent"===el.renderPass&&(el.context.setColorMode(el.colorModeForRenderPass()),function(el,eh){let ec=el.context,ep=ec.gl,e_=eh.heatmapFbo;if(!e_)return;ec.activeTexture.set(ep.TEXTURE0),ep.bindTexture(ep.TEXTURE_2D,e_.colorAttachment.get()),ec.activeTexture.set(ep.TEXTURE1);let eg=eh.colorRampTexture;eg||(eg=eh.colorRampTexture=new F.T(ec,eh.colorRamp,ep.RGBA8)),eg.bind(ep.LINEAR,ep.CLAMP_TO_EDGE),el.getOrCreateProgram("heatmapTexture").draw(el,ep.TRIANGLES,Bi.disabled,Ui.disabled,el.colorModeForRenderPass(),ji.disabled,{u_image:0,u_color_ramp:1,u_opacity:eh.paint.get("heatmap-opacity")},eh.id,el.viewportBuffer,el.quadTriangleIndexBuffer,el.viewportSegments,eh.paint,el.transform.zoom)}(el,ec))}},line:function(el,eh,ec,ep){let e_;if("translucent"!==el.renderPass)return;let eg=ec.paint.get("line-opacity"),ey=ec.paint.get("line-width");if(0===eg.constantOr(1)||0===ey.constantOr(1))return;let eb=ec.paint.get("line-emissive-strength"),ew=ec.paint.get("line-occlusion-opacity"),eT=ec.layout.get("line-elevation-reference"),eS="meters"===ec.layout.get("line-width-unit"),eE="sea"===eT,eM=el.context,eI=eM.gl;if(ec.hasElevatedBuckets&&"globe"===el.transform.projection.name)return;let eA=ec.layout.get("line-cross-slope"),eC=el.colorModeForDrapableLayerRenderPass(eb),eP=el.terrain&&el.terrain.renderingToTexture,ez=eP?1:F.q.devicePixelRatio,eD=ec.paint.get("line-dasharray"),eR=eD.constantOr(1),eL=ec.layout.get("line-cap"),eO=eD.constantOr(null),ek=eL.constantOr(null),eF=ec.paint.get("line-pattern"),eB=eF.constantOr(1),eN=eF.constantOr(null),eV=ec.paint.get("line-opacity").constantOr(1),eU=!eB&&1!==eV||el.depthOcclusion&&ew>0&&ew<1,ej=ec.paint.get("line-gradient"),eG=eB?"linePattern":"line",eq=F.c$(ec);if(eP&&el.terrain&&el.terrain.clipOrMaskOverlapStencilType()&&(eU=!1),0!==ew&&el.depthOcclusion){let el=ec.paint._values["line-opacity"];el&&el.value&&"constant"===el.value.kind?e_=el.value:F.w(`Occlusion opacity for layer ${ec.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==ey.value.kind&&!1===ey.value.isLineProgressConstant&&eq.push("VARIABLE_LINE_WIDTH");let z=(ep,eg,ey,eb,eT,eA)=>{for(let eD of ep){let ep=eh.getTile(eD);if(eB&&!ep.patternsLoaded())continue;let eL=ep.getBucket(ec);if(!eL||eL.hasZOffset&&!eT||!eL.hasZOffset&&eT)continue;el.prepareDrawTile();let eF=eL.programConfigurations.get(ec.id),eq=el.isTileAffectedByFog(eD),e$=el.getOrCreateProgram(eG,{config:eF,defines:eg,overrideFog:eq,overrideRtt:!eT&&void 0});if(eN&&ep.imageAtlas){let el=F.d0.from(eN).getPrimary().scaleSelf(ez).toString(),eh=ep.imageAtlas.patternPositions.get(el);eh&&eF.setConstantPatternPositions(eh)}if(!eB&&eO&&ek&&ep.lineAtlas){let F=ep.lineAtlas.getDash(eO,ek);F&&eF.setConstantPatternPositions(F)}let[eH,eZ]=ec.paint.get("line-trim-offset");("round"===ek||"square"===ek)&&eH!==eZ&&(0===eH&&(eH-=1),1===eZ&&(eZ+=1));let eW=eP?eD.projMatrix:null,eY=eS?1/eL.tileToMeter/F.at(ep,1,el.transform.zoom):1,eX=eS?1/eL.tileToMeter/F.at(ep,1,Math.floor(el.transform.zoom)):1,eK=eB?F.d1(el,ep,ec,eW,ez,eY,eX,[eH,eZ]):F.d2(el,ep,ec,eW,eL.lineClipsArray.length,ez,eY,eX,[eH,eZ]);if(ej){let ep=eL.gradients[ec.id],e_=ep.texture;if(ec.gradientVersion!==ep.version){let eg=256;if(ec.stepInterpolant){let ec=eh.getSource().maxzoom,ep=eD.canonical.z===ec?Math.ceil(1<<el.transform.maxZoom-eD.canonical.z):1;eg=F.ay(F.d3(eL.maxLineLength/F.ai*1024*ep),256,eM.maxTextureSize)}ep.gradient=F.d4({expression:ec.gradientExpression(),evaluationKey:"lineProgress",resolution:eg,image:ep.gradient||void 0,clips:eL.lineClipsArray}),ep.texture?ep.texture.update(ep.gradient):ep.texture=new F.T(eM,ep.gradient,eI.RGBA8),ep.version=ec.gradientVersion,e_=ep.texture}eM.activeTexture.set(eI.TEXTURE1),e_.bind(ec.stepInterpolant?eI.NEAREST:eI.LINEAR,eI.CLAMP_TO_EDGE)}eR&&(eM.activeTexture.set(eI.TEXTURE0),ep.lineAtlasTexture&&ep.lineAtlasTexture.bind(eI.LINEAR,eI.REPEAT),eF.updatePaintBuffers()),eB&&(eM.activeTexture.set(eI.TEXTURE0),ep.imageAtlasTexture&&ep.imageAtlasTexture.bind(eI.LINEAR,eI.CLAMP_TO_EDGE),eF.updatePaintBuffers()),eT&&!eE&&el.terrain.setupElevationDraw(ep,e$),el.uploadCommonUniforms(eM,e$,eD.toUnwrapped());let N=F=>{null!=e_&&(e_.value=eV*ew),e$.draw(el,eI.TRIANGLES,ey,F,eC,ji.disabled,eK,ec.id,eL.layoutVertexBuffer,eL.indexBuffer,eL.segments,ec.paint,el.transform.zoom,eF,[eL.layoutVertexBuffer2,eL.patternVertexBuffer,eL.zOffsetVertexBuffer]),null!=e_&&(e_.value=eV)};if(eU&&!eT){let F=el.stencilModeForClipping(eD).ref;0===F&&eP&&eM.clear({stencil:0});let eh={func:eI.EQUAL,mask:255};eK.u_alpha_discard_threshold=.8,N(new Ui(eh,F,255,eI.KEEP,eI.KEEP,eI.INVERT)),eK.u_alpha_discard_threshold=0,N(new Ui(eh,F,255,eI.KEEP,eI.KEEP,eI.KEEP))}else eK.u_alpha_discard_threshold=eU&&eT&&eA?.8:0,N(eT?eb:el.stencilModeForClipping(eD))}};if(ec.hasNonElevatedBuckets){let eh=!eP&&el.terrain;0!==ew&&eh?F.w(`Occlusion opacity for layer ${ec.id} is supported on terrain only if the layer has line-z-offset enabled.`):eh?F.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${ec.id}.`):z(ep,eq,el.depthModeForSublayer(0,Bi.ReadOnly),Ui.disabled,!1,!0)}if(ec.hasElevatedBuckets){eq.push("ELEVATED"),void 0!==eA&&eq.push(eA<1?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),eE&&eq.push("ELEVATION_REFERENCE_SEA");let F=eU?el.stencilModeFor3D():Ui.disabled,eh=new Bi(el.depthOcclusion?eI.GREATER:eI.LEQUAL,Bi.ReadOnly,el.depthRangeFor3D);el.forceTerrainMode=!0,z(ep,eq,eh,F,!0,!0),eU&&z(ep,eq,eh,F,!0,!1),el.forceTerrainMode=!1}eU&&(el.resetStencilClippingMasks(),eP&&eM.clear({stencil:0})),0===ew||el.depthOcclusion||eP||el.layersWithOcclusionOpacity.push(el.currentLayer)},fill:function(el,eh,ec,ep){let e_=ec.paint.get("fill-color"),eg=ec.paint.get("fill-opacity");if(0===eg.constantOr(1))return;let ey=ec.paint.get("fill-emissive-strength"),eb=el.colorModeForDrapableLayerRenderPass(ey),ew=ec.paint.get("fill-pattern"),eT=el.opaquePassEnabledForLayer()&&!ew.constantOr(1)&&1===e_.constantOr(F.al.transparent).a&&1===eg.constantOr(0)?"opaque":"translucent",eS="none";"none"!==ec.layout.get("fill-elevation-reference")?eS="road":0!==ec.paint.get("fill-z-offset").constantOr(1)&&(eS="offset");let eE=!(!el.terrain||!el.terrain.enabled),eM={painter:el,sourceCache:eh,layer:ec,coords:ep,colorMode:eb,elevationType:eS,terrainEnabled:eE,pass:eT};if("offset"!==eS){if(Ur(eM,!1),"road"===eS){let F=!eE&&"translucent"===el.renderPass;F&&Nr(el,eh,ec,ep,"geometry"),Ur(eM,!0,Ui.disabled),F&&function(F){let{painter:el,sourceCache:eh,layer:ec,coords:ep,colorMode:e_}=F,eg=el.context.gl,ey=new Bi(el.context.gl.LEQUAL,Bi.ReadOnly,el.depthRangeFor3D);for(let F of ep){let ep=eh.getTile(F),eb=ep.getBucket(ec);if(!eb)continue;let ew=eb.elevatedStructures;if(!ew||!ew.renderableSegments||0===ew.renderableSegments.segments[0].primitiveLength)continue;el.prepareDrawTile();let eT=eb.bufferData.programConfigurations.get(ec.id),eS=el.isTileAffectedByFog(F),eE=el.getOrCreateProgram("elevatedStructures",{config:eT,overrideFog:eS,defines:["NORMAL_OFFSET"]}),eM={u_matrix:el.translatePosMatrix(F.projMatrix,ep,ec.paint.get("fill-translate"),ec.paint.get("fill-translate-anchor"))};el.uploadCommonUniforms(el.context,eE,F.toUnwrapped()),eE.draw(el,eg.TRIANGLES,ey,Ui.disabled,e_,ji.backCCW,eM,ec.id,ew.vertexBuffer,ew.indexBuffer,ew.renderableSegments,ec.paint,el.transform.zoom,eT,[ew.vertexBufferNormal])}}(eM)}}else Ur(eM,!1,el.stencilModeFor3D())},"fill-extrusion":function(el,eh,ec,ep){let e_=ec.paint.get("fill-extrusion-opacity"),eg=el.context,ey=eg.gl,eb=el.terrain,ew=eb&&eb.renderingToTexture;if(0===e_)return;let eT=el.conflationActive&&el.style.isLayerClipped(ec,eh.getSource()),eS=el.style.order.indexOf(ec.fqid);if(eT&&function(F,el,eh,ec,ep){for(let e_ of ec){let ec=el.getTile(e_).getBucket(eh);ec&&(ec.updateReplacement(e_,F.replacementSource,ep),ec.uploadCentroid(F.context))}}(el,eh,ec,ep,eS),eb||eT)for(let e_ of ep){let ep=eh.getTile(e_).getBucket(ec);ep&&function(el,eh,ec,ep,e_,eg,ey){0===ep.centroidVertexArray.length&&ep.createCentroidsBuffer();let eb=eg?eg.findDEMTileFor(ec):null;if(!(eb&&eb.dem||ey))return;eg&&eb&&eb.dem&&ep.selfDEMTileTimestamp!==eb.dem._timestamp&&(ep.borderDoneWithNeighborZ=[-1,-1,-1,-1],ep.selfDEMTileTimestamp=eb.dem._timestamp);let c=el=>new F.P(Math.ceil((el+F.da)*F.db),0),h=F=>{let el=eh.getSource().minzoom,o=F=>{let el=eh.getTileByID(F);if(el&&el.hasData())return el.getBucket(e_)};for(let eh of[0,-1,1]){if(F.overscaledZ+eh<el)continue;let ec=o(F.calculateScaledKey(F.overscaledZ+eh));if(ec)return ec}},ew=[0,0,0],u=(el,eh)=>(ew[0]=Math.min(el.min.y,eh.min.y),ew[1]=Math.max(el.max.y,eh.max.y),ew[2]=F.ai-eh.min.x>el.max.x?eh.min.x-F.ai:el.max.x,ew),_=(el,eh)=>(ew[0]=Math.min(el.min.x,eh.min.x),ew[1]=Math.max(el.max.x,eh.max.x),ew[2]=F.ai-eh.min.y>el.max.y?eh.min.y-F.ai:el.max.y,ew),eT=[(F,el)=>u(F,el),(F,el)=>u(el,F),(F,el)=>_(F,el),(F,el)=>_(el,F)],f=(el,eh,ep,e_,ey,ew,eT)=>{if(!eg)return 0;let eS=[[ew?ep:el,ew?el:ep,0],[ew?ep:eh,ew?eh:ep,0]],eE=eT<0?F.ai+eT:eT,eM=[ew?eE:(el+eh)/2,ew?(el+eh)/2:eE,0];return 0===ep&&eT<0||0!==ep&&eT>0?eg.getForTilePoints(ey,[eM],!0,e_):eS.push(eM),eg.getForTilePoints(ec,eS,!0,eb),Math.max(eS[0][2],eS[1][2],eM[2])/eg.exaggeration()};for(let el=0;el<4;el++){let eh=ep.borderFeatureIndices[el];if(0===eh.length)continue;let e_=F.d7[el](ec),eb=h(e_);if(!(eb&&eb instanceof F.d8))continue;let ew=eg?eg.findDEMTileFor(e_):null;if(!(ew&&ew.dem||ey)||(eg&&ew&&ew.dem&&ep.borderDEMTileTimestamp[el]!==ew.dem._timestamp&&(ep.borderDoneWithNeighborZ[el]=-1,ep.borderDEMTileTimestamp[el]=ew.dem._timestamp),ep.borderDoneWithNeighborZ[el]===eb.canonical.z))continue;0===eb.centroidVertexArray.length&&eb.createCentroidsBuffer();let eS=(el<2?1:5)-el,eE=eb.borderDoneWithNeighborZ[eS]!==ep.canonical.z,eM=eb.borderFeatureIndices[eS],eI=0;if(ep.canonical.z!==eb.canonical.z){for(let F of eh)ep.showCentroid(ep.featuresOnBorder[F]);if(eE)for(let F of eM)eb.showCentroid(eb.featuresOnBorder[F]);ep.borderDoneWithNeighborZ[el]=eb.canonical.z,eb.borderDoneWithNeighborZ[eS]=ep.canonical.z}for(let ec of eh){let eh;let eg=ep.featuresOnBorder[ec],eE=ep.centroidData[eg.centroidDataIndex],eA=eg.borders[el];for(;eI<eM.length;){eh=eb.featuresOnBorder[eM[eI]];let F=eh.borders[eS];if(F[1]>eA[0]+3||F[0]>eA[0]-3)break;eb.showCentroid(eh),eI++}if(eh&&eI<eM.length){let ec=eI,eC=0;for(;!(eh.borders[eS][0]>eA[1]-3)&&(eC++,++eI!==eM.length);)eh=eb.featuresOnBorder[eM[eI]];eh=eb.featuresOnBorder[eM[ec]];let eP=!1;if(eC>=1){let F=eh.borders[eS];3>Math.abs(eA[0]-F[0])&&3>Math.abs(eA[1]-F[1])&&(eC=1,eP=!0,eI=ec+1)}else if(0===eC){ep.showCentroid(eg);continue}let ez=eb.centroidData[eh.centroidDataIndex];ey&&eP&&((eE.flags|ez.flags)&F.d9?(eE.flags|=F.d9,ez.flags|=F.d9):(eE.flags&=~F.d9,ez.flags&=~F.d9));let eD=eg.intersectsCount()>1||eh.intersectsCount()>1;if(eC>1)eI=ec,eE.centroidXY=ez.centroidXY=new F.P(0,0);else if(ew&&ew.dem&&!eD){let eh=eT[el](eE,ez),ec=el%2?F.ai-1:0,ep=f(eh[0],Math.min(F.ai-1,eh[1]),ec,ew,e_,el<2,eh[2]);eE.centroidXY=ez.centroidXY=c(ep)}else eD?eE.centroidXY=ez.centroidXY=new F.P(0,0):(eE.centroidXY=ep.encodeBorderCentroid(eg),ez.centroidXY=eb.encodeBorderCentroid(eh));ep.writeCentroidToBuffer(eE),eb.writeCentroidToBuffer(ez)}else ep.showCentroid(eg)}ep.borderDoneWithNeighborZ[el]=eb.canonical.z,eb.borderDoneWithNeighborZ[eS]=ep.canonical.z}(ep.needsCentroidUpdate||!ep.centroidVertexBuffer&&0!==ep.centroidVertexArray.length)&&ep.uploadCentroid(el)}(el.context,eh,e_,ep,ec,eb,eT)}if("shadow"===el.renderPass&&el.shadowRenderer){let eg=el.shadowRenderer;if(eb&&e_<.65&&ec._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof F.ab)return;let ey=eg.getShadowPassDepthMode(),ew=eg.getShadowPassColorMode();Vr(el,eh,ec,ep,ey,Ui.disabled,ew,eT)}else if("translucent"===el.renderPass){let eS=!ec.paint.get("fill-extrusion-pattern").constantOr(1),eE=ec.paint.get("fill-extrusion-color").constantOr(F.al.white);if(!ew&&0!==eE.a){let F=new Bi(el.context.gl.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D);1===e_&&eS?Vr(el,eh,ec,ep,F,Ui.disabled,ki.unblended,eT):(Vr(el,eh,ec,ep,F,Ui.disabled,ki.disabled,eT),Vr(el,eh,ec,ep,F,el.stencilModeFor3D(),el.colorModeForRenderPass(),eT),el.resetStencilClippingMasks())}if(el.style.enable3dLights()&&eS&&(!eb&&"globe"!==el.transform.projection.name||ew)){let e_=ec.paint.get("fill-extrusion-opacity"),eS=ec.paint.get("fill-extrusion-ambient-occlusion-intensity"),eE=ec.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),eM=ec.paint.get("fill-extrusion-flood-light-intensity"),eI="none"===ec.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),eA=ec.paint.get("fill-extrusion-flood-light-color").toRenderColor(eI?null:ec.lut).toArray01().slice(0,3),eC=eS>0&&eE>0,eP=eM>0,v=(F,el,eh)=>(1-eh)*F+eh*el,y=eg=>{let eb=el.depthModeForSublayer(1,Bi.ReadOnly,ey.LEQUAL,!0),ew=ec.paint.get(eg?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),eI=v(.1,3,ew),eC=el._showOverdrawInspector;if(!eC){let ew=new Ui({func:ey.ALWAYS,mask:255},255,255,ey.KEEP,ey.KEEP,ey.REPLACE),eC=new ki([ey.ONE,ey.ONE,ey.ONE,ey.ONE],F.al.transparent,[!1,!1,!1,!0],ey.MIN);Gr(el,eh,ec,ep,eb,ew,eC,ji.disabled,eg,"sdf",e_,eS,eE,eM,eA,eI,eT,!1)}{let ew=eC?Ui.disabled:new Ui({func:ey.EQUAL,mask:255},255,255,ey.KEEP,ey.DECR,ey.DECR),eP=eC?el.colorModeForRenderPass():new ki([ey.ONE_MINUS_DST_ALPHA,ey.DST_ALPHA,ey.ONE,ey.ONE],F.al.transparent,[!0,!0,!0,!0]);Gr(el,eh,ec,ep,eb,ew,eP,ji.disabled,eg,"color",e_,eS,eE,eM,eA,eI,eT,!1)}};if(ew){let c=(eg,eb,ew)=>{let eI=el.depthModeForSublayer(1,Bi.ReadOnly,ey.LEQUAL,!1),eC=ec.paint.get(eg?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),eP=v(.1,3,eC);{let ew=new ki([ey.ONE,ey.ONE,ey.ONE,ey.ONE],F.al.transparent,[!1,!1,!1,!0]);Gr(el,eh,ec,ep,eI,Ui.disabled,ew,ji.disabled,eg,"clear",e_,eS,eE,eM,eA,eP,eT,eb)}{let ew=new Ui({func:ey.ALWAYS,mask:255},255,255,ey.KEEP,ey.KEEP,ey.REPLACE),eC=new ki([ey.ONE,ey.ONE,ey.ONE,ey.ONE],F.al.transparent,[!1,!1,!1,!0],ey.MIN);Gr(el,eh,ec,ep,eI,ew,eC,ji.disabled,eg,"sdf",e_,eS,eE,eM,eA,eP,eT,eb)}{let ew=eg?ey.ZERO:ey.ONE_MINUS_DST_ALPHA,eC=new Ui({func:ey.EQUAL,mask:255},255,255,ey.KEEP,ey.DECR,ey.DECR),ez=new ki([ew,ey.DST_ALPHA,ey.ONE_MINUS_DST_ALPHA,ey.ZERO],F.al.transparent,[!0,!0,!0,!0]);Gr(el,eh,ec,ep,eI,eC,ez,ji.disabled,eg,"color",e_,eS,eE,eM,eA,eP,eT,eb)}{let eC=new ki([ey.ONE,ey.ONE,ey.ONE,eg?ey.ZERO:ey.ONE],F.al.transparent,[!1,!1,!1,!0],eg?ey.FUNC_ADD:ey.MAX);Gr(el,eh,ec,ep,eI,Ui.disabled,eC,ji.disabled,eg,"clear",e_,eS,eE,eM,eA,eP,eT,eb,ew)}};if(eC||eP){let eh;if(el.prepareDrawTile(),eb){let el=eb.drapeBufferSize[0],ec=eb.drapeBufferSize[1];(eh=eb.framebufferCopyTexture)&&(!eh||eh.size[0]===el&&eh.size[1]===ec)||(eh&&eh.destroy(),eh=eb.framebufferCopyTexture=new F.T(eg,new F.r({width:el,height:ec}),ey.RGBA8)),eh.bind(ey.LINEAR,ey.CLAMP_TO_EDGE),ey.copyTexSubImage2D(ey.TEXTURE_2D,0,0,0,0,0,el,ec)}eC&&c(!0,!1,eh),eP&&c(!1,!0,eh)}}else eC&&y(!0),eP&&y(!1),(eC||eP)&&el.resetStencilClippingMasks()}}},hillshade:function(el,eh,ec,ep){if("offscreen"!==el.renderPass&&"translucent"!==el.renderPass||el.style.disableElevatedTerrain)return;let e_=el.context,eg=el.terrain&&el.terrain.renderingToTexture,[ey,eb]="translucent"!==el.renderPass||eg?[{},ep]:el.stencilConfigForOverlap(ep);for(let ep of eb){let e_=eh.getTile(ep);if(e_.needsHillshadePrepare&&"offscreen"===el.renderPass)!function(el,eh,ec){let ep=el.context,e_=ep.gl;if(!eh.dem)return;let eg=eh.dem;if(ep.activeTexture.set(e_.TEXTURE1),Zo(el,eh,eg),!eh.demTexture)return;eh.demTexture.bind(e_.NEAREST,e_.CLAMP_TO_EDGE);let ey=eg.dim;ep.activeTexture.set(e_.TEXTURE0);let eb=eh.hillshadeFBO;if(!eb){let el=new F.T(ep,{width:ey,height:ey,data:null},e_.RGBA8);el.bind(e_.LINEAR,e_.CLAMP_TO_EDGE),(eb=eh.hillshadeFBO=ep.createFramebuffer(ey,ey,!0,"renderbuffer")).colorAttachment.set(el.texture)}ep.bindFramebuffer.set(eb.framebuffer),ep.viewport.set([0,0,ey,ey]);let{tileBoundsBuffer:ew,tileBoundsIndexBuffer:eT,tileBoundsSegments:eS}=el.getMercatorTileBoundsBuffers(),eE=[];el.linearFloatFilteringSupported()&&eE.push("TERRAIN_DEM_FLOAT_FORMAT"),el.getOrCreateProgram("hillshadePrepare",{defines:eE}).draw(el,e_.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.disabled,((el,eh)=>{let ec=eh.stride,ep=F.ad.mat4.create();return F.ad.mat4.ortho(ep,0,F.ai,-F.ai,0,0,1),F.ad.mat4.translate(ep,ep,[0,-F.ai,0]),{u_matrix:ep,u_image:1,u_dimension:[ec,ec],u_zoom:el.overscaledZ}})(eh.tileID,eg),ec.id,ew,eT,eS),eh.needsHillshadePrepare=!1}(el,e_,ec);else if("translucent"===el.renderPass){let eh=el.depthModeForSublayer(0,Bi.ReadOnly),eb=ec.paint.get("hillshade-emissive-strength"),ew=el.colorModeForDrapableLayerRenderPass(eb),eT=eg&&el.terrain?el.terrain.stencilModeForRTTOverlap(ep):ey[ep.overscaledZ];!function(el,eh,ec,ep,e_,eg,ey){let eb=el.context,ew=eb.gl,eT=ec.hillshadeFBO;if(!eT)return;el.prepareDrawTile();let eS=el.isTileAffectedByFog(eh),eE=el.getOrCreateProgram("hillshade",{overrideFog:eS});eb.activeTexture.set(ew.TEXTURE0),ew.bindTexture(ew.TEXTURE_2D,eT.colorAttachment.get());let eM=((el,eh,ec,ep)=>{let e_=ec.paint.get("hillshade-shadow-color"),eg="none"===ec.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),ey=ec.paint.get("hillshade-highlight-color"),eb="none"===ec.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),ew=ec.paint.get("hillshade-accent-color"),eT="none"===ec.paint.get("hillshade-accent-color-use-theme").constantOr("default"),eS=ec.paint.get("hillshade-emissive-strength"),eE=F.ak(ec.paint.get("hillshade-illumination-direction"));if("viewport"===ec.paint.get("hillshade-illumination-anchor"))eE-=el.transform.angle;else if(el.style&&el.style.enable3dLights()&&el.style.directionalLight){let eh=el.style.directionalLight.properties.get("direction"),ec=F.cc(eh.x,eh.y,eh.z);eE=F.ak(ec[1])}let eM=!el.options.moving;return{u_matrix:ep||el.transform.calculateProjMatrix(eh.tileID.toUnwrapped(),eM),u_image:0,u_latrange:function(el,eh){let ec=Math.pow(2,eh.canonical.z),ep=eh.canonical.y;return[new F.ac(0,ep/ec).toLngLat().lat,new F.ac(0,(ep+1)/ec).toLngLat().lat]}(0,eh.tileID),u_light:[ec.paint.get("hillshade-exaggeration"),eE],u_shadow:e_.toRenderColor(eg?null:ec.lut),u_highlight:ey.toRenderColor(eb?null:ec.lut),u_emissive_strength:eS,u_accent:ew.toRenderColor(eT?null:ec.lut)}})(el,ec,ep,el.terrain?eh.projMatrix:null);el.uploadCommonUniforms(eb,eE,eh.toUnwrapped());let{tileBoundsBuffer:eI,tileBoundsIndexBuffer:eA,tileBoundsSegments:eC}=el.getTileBoundsBuffers(ec);eE.draw(el,ew.TRIANGLES,e_,eg,ey,ji.disabled,eM,ep.id,eI,eA,eC)}(el,ep,e_,ec,eh,eT,ew)}}e_.viewport.set([0,0,el.width,el.height]),el.resetStencilClippingMasks()},raster:function(el,eh,ec,ep,e_,eg){if("translucent"!==el.renderPass||0===ec.paint.get("raster-opacity"))return;let ey="globe"===el.transform.projection.name,eb=0!==ec.paint.get("raster-elevation"),ew=eb&&ey;if(el.renderElevatedRasterBackface&&!ew)return;let eT=el.context,eS=eT.gl,eE=eh.getSource(),eM=function(el,eh,ec,ep){let e_=eh.paint.get("raster-color"),eg="raster-array"===el.type,ey=[],eb=eh.paint.get("raster-resampling"),ew=eh.paint.get("raster-color-mix"),eT=eh.paint.get("raster-color-range"),eS=[ew[0],ew[1],ew[2],0],eE=ew[3],eM="nearest"===eb?ep.NEAREST:ep.LINEAR;if(eg&&(ey.push("RASTER_ARRAY"),e_||ey.push("RASTER_COLOR"),"linear"===eb&&ey.push("RASTER_ARRAY_LINEAR"),eM=ep.NEAREST,!eT&&el.rasterLayers)){let F=el.rasterLayers.find(({id:F})=>F===eh.sourceLayer);F&&F.fields&&F.fields.range&&(eT=F.fields.range)}if(eT=eT||[0,1],e_){ey.push("RASTER_COLOR"),ec.activeTexture.set(ep.TEXTURE2),eh.updateColorRamp(eT);let el=eh.colorRampTexture;el||(el=eh.colorRampTexture=new F.T(ec,eh.colorRamp,ep.RGBA8)),el.bind(ep.LINEAR,ep.CLAMP_TO_EDGE)}return{mix:eS,range:eT,offset:eE,defines:ey,resampling:eM}}(eE,ec,eT,eS);if(eE instanceof F.aK&&!ep.length&&!ey)return;let eI=ec.paint.get("raster-emissive-strength"),eA=el.colorModeForDrapableLayerRenderPass(eI),eC=el.terrain&&el.terrain.renderingToTexture,eP=!el.options.moving,ez="nearest"===ec.paint.get("raster-resampling")?eS.NEAREST:eS.LINEAR;if(eE instanceof F.aK&&!ep.length&&(eE.onNorthPole||eE.onSouthPole)){let F=eb?el.stencilModeFor3D():Ui.disabled;return void Xr(!!eE.onNorthPole,null,el,eh,ec,eI,eM,ji.disabled,F)}if(!ep.length)return;let[eD,eR]=eE instanceof F.aK||eC?[{},ep]:el.stencilConfigForOverlap(ep),eL=eR[eR.length-1].overscaledZ;ew&&eM.defines.push("PROJECTION_GLOBE_VIEW"),eb&&eM.defines.push("RENDER_CUTOFF");let w=(ep,e_,eR)=>{for(let eO of ep){let ep,ek,eF,eB,eN;let eV=eO.toUnwrapped(),eU=eh.getTile(eO);if(eC&&(!eU||!eU.hasData()))continue;eT.activeTexture.set(eS.TEXTURE0);let ej=function(F,el,eh,ec){if(F)return el instanceof ot&&F instanceof wt?el.getTextureDescriptor(F,eh,!0):{texture:F.texture,mix:$r(ec.mix),offset:ec.offset,buffer:0,tileSize:1}}(eU,eE,ec,eM);if(!ej||!ej.texture)continue;let{texture:eG,mix:eq,offset:e$,tileSize:eH,buffer:eZ}=ej;eC?(ep=Bi.disabled,ek=eO.projMatrix):eb?(ep=new Bi(eS.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D),ek=ey?Float32Array.from(el.transform.expandedFarZProjMatrix):el.transform.calculateProjMatrix(eV,eP)):(ep=el.depthModeForSublayer(eO.overscaledZ-eL,1===ec.paint.get("raster-opacity")?Bi.ReadWrite:Bi.ReadOnly,eS.LESS),ek=el.transform.calculateProjMatrix(eV,eP));let eW=el.terrain&&eC?el.terrain.stencilModeForRTTOverlap(eO):eD[eO.overscaledZ],eY=eg?0:ec.paint.get("raster-fade-duration");eU.registerFadeDuration(eY);let eX=eh.findLoadedParent(eO,0),eK=Ns(eU,eX,eh,el.transform,eY);el.terrain&&el.terrain.prepareDrawTile(),eT.activeTexture.set(eS.TEXTURE0),eG.bind(ez,eS.CLAMP_TO_EDGE),eT.activeTexture.set(eS.TEXTURE1),eX?(eX.texture&&eX.texture.bind(ez,eS.CLAMP_TO_EDGE),eF=Math.pow(2,eX.tileID.overscaledZ-eU.tileID.overscaledZ),eB=[eU.tileID.canonical.x*eF%1,eU.tileID.canonical.y*eF%1]):eG.bind(ez,eS.CLAMP_TO_EDGE),"useMipmap"in eG&&eT.extTextureFilterAnisotropic&&el.transform.pitch>20&&eS.texParameterf(eS.TEXTURE_2D,eT.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,eT.extTextureFilterAnisotropicMax);let eJ=el.transform,eQ=eb?function(F){let el=F._nearZ,eh=F.projection.farthestPixelDistance(F),ec=eh-el,ep=.2*F.height,e_=el+ep;return[el,eh,(e_-ep-el)/ec,(e_-el)/ec]}(eJ):[0,0,0,0],e0,e1,e2,e3,e4,e5=0;if(ew&&eE instanceof F.aK&&eE.coordinates.length>3)e0=Float32Array.from(F.bc(F.cI(new F.bT(0,0,0)))),e1=Float32Array.from(eJ.globeMatrix),e2=Float32Array.from(F.cE(eJ)),e3=[F.av(eJ.center.lng),F.aC(eJ.center.lat)],eN=eE.elevatedGlobePerspectiveTransform,e4=eE.elevatedGlobeGridMatrix||new Float32Array(9);else if(ew){let el=F.cF(eO.canonical);e5=F.cG(el.getCenter().lat),e0=Float32Array.from(F.bc(F.cI(eO.canonical))),e1=Float32Array.from(eJ.globeMatrix),e2=Float32Array.from(F.cE(eJ)),e3=[F.av(eJ.center.lng),F.aC(eJ.center.lat)],eN=[0,0],e4=Float32Array.from(F.cH(eO.canonical,el,e5,eJ.worldSize/eJ._pixelsPerMercatorPixel))}else eN=eE instanceof F.aK?eE.perspectiveTransform:[0,0],e0=new Float32Array(16),e1=new Float32Array(9),e2=new Float32Array(16),e3=[0,0],e4=new Float32Array(9);let e6=dr(ek,e0,e1,e2,e4,eB||[0,0],F.ag(el.transform.zoom),e3,eQ,eF||1,eK,ec,eN,eb?ec.paint.get("raster-elevation"):0,2,eq,e$,eM.range,eH,eZ,eI),e8=el.isTileAffectedByFog(eO),e9=el.getOrCreateProgram("raster",{defines:eM.defines,overrideFog:e8});if(el.uploadCommonUniforms(eT,e9,eV),eE instanceof F.aK){let eh=eE.elevatedGlobeVertexBuffer,eg=eE.elevatedGlobeIndexBuffer;if(eC||!ey)eE.boundsBuffer&&eE.boundsSegments&&e9.draw(el,eS.TRIANGLES,ep,Ui.disabled,eA,ji.disabled,e6,ec.id,eE.boundsBuffer,el.quadTriangleIndexBuffer,eE.boundsSegments);else if(eh&&eg){let ey=eJ.zoom<=F.c6?eE.elevatedGlobeSegments:eE.getSegmentsForLongitude(eJ.center.lng);ey&&e9.draw(el,eS.TRIANGLES,ep,Ui.disabled,eA,e_,e6,ec.id,eh,eg,ey)}}else if(ew){ep=new Bi(eS.LEQUAL,Bi.ReadOnly,el.depthRangeFor3D);let F=el.globeSharedBuffers;if(F){let[eh,eg,ey]=F.getGridBuffers(e5,!1);e9.draw(el,eS.TRIANGLES,ep,eR||eW,el.colorModeForRenderPass(),e_,e6,ec.id,eh,eg,ey)}}else{let{tileBoundsBuffer:F,tileBoundsIndexBuffer:eh,tileBoundsSegments:e_}=el.getTileBoundsBuffers(eU);e9.draw(el,eS.TRIANGLES,ep,eW,eA,ji.disabled,e6,ec.id,F,eh,e_)}}if(!(eE instanceof F.aK)&&ew)for(let F of ep){let ep=F.canonical.y===(1<<F.canonical.z)-1;0===F.canonical.y&&Xr(!0,F,el,eh,ec,eI,eM,e_,eR||Ui.disabled),ep&&Xr(!1,F,el,eh,ec,eI,eM,e_===ji.frontCW?ji.backCW:ji.frontCW,eR||Ui.disabled)}};ew?w(eR,el.renderElevatedRasterBackface?ji.backCW:ji.frontCW,el.stencilModeFor3D()):w(eR,ji.disabled,void 0),el.resetStencilClippingMasks()},"raster-particle":function(el,eh,ec,ep,e_,eg){"offscreen"===el.renderPass&&function(el,eh,ec,ep){if(!ep.length)return;let e_=el.context,eg=e_.gl,ey=eh.getSource();if(!(ey instanceof ot))return;let eb=Math.ceil(Math.sqrt(ec.paint.get("raster-particle-count"))),ew=ec.particlePositionRGBAImage;if(!ew||ew.width!==eb){let el=function(F){let el=F*F,eh=new Uint8Array(4*el),o=function(F){return F|=0,((F=Math.imul((F=Math.imul((F=Math.imul(2747636419^F,2654435769))^F>>>16,2654435769))^F>>>16,2654435769))>>>0)/4294967296},ec=1/1.1;for(let F=0;F<el;F++){let el=ec*(o(2*F+0)+.05),ep=ec*(o(2*F+1)+.05),e_=255*el%1,eg=255*ep%1,ey=ep-eg/255;eh[4*F+0]=255*(el-e_/255),eh[4*F+1]=255*e_,eh[4*F+2]=255*ey,eh[4*F+3]=255*eg}return eh}(eb);ew=ec.particlePositionRGBAImage=new F.r({width:eb,height:eb},el)}let eT=ec.particleFramebuffer;eT?eT.width!==eb&&(eT.destroy(),eT=ec.particleFramebuffer=e_.createFramebuffer(eb,eb,!0,null)):eT=ec.particleFramebuffer=e_.createFramebuffer(eb,eb,!0,null);let eS=[];for(let el of ep){let ep=eh.getTile(el);if(!(ep instanceof wt))continue;let eg=function(el,eh,ec){if(!el)return null;let ep=eh.getTextureDescriptor(el,ec,!0);if(!ep)return null;let{texture:e_,mix:eg,offset:ey,tileSize:eb,buffer:ew,format:eT}=ep;if(!e_||!eT)return null;let eS=!1;return"uint32"===eT&&(eS=!0,eg[3]=0,eg=cr(F.df,eg,[0,ec.paint.get("raster-particle-max-speed")]),ey=hr(F.df,ey,[0,ec.paint.get("raster-particle-max-speed")])),{texture:e_,textureOffset:[ew/(eb+2*ew),eb/(eb+2*ew)],tileSize:eb,scalarData:eS,scale:eg,offset:ey,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[eT]]}}(ep,ey,ec);if(!eg)continue;let eT=[ep.tileSize,ep.tileSize],eE=ec.tileFramebuffer;eE||(eE=ec.tileFramebuffer=e_.createFramebuffer(eT[0],eT[1],!0,null));let eM=ep.rasterParticleState;eM||(eM=ep.rasterParticleState=new Qr(e_,el,eT,ew));let eI=eM.update(ec.lastInvalidatedAt);eM.particleTextureDimension!==eb&&eM.updateParticleTexture(el,ew);let eA=eM.targetColorTexture;eM.targetColorTexture=eM.backgroundColorTexture,eM.backgroundColorTexture=eA;let eC=eM.particleTexture0;eM.particleTexture0=eM.particleTexture1,eM.particleTexture1=eC,eS.push([el,eg,eM,eI])}if(0===eS.length)return;let eE=F.q.now(),eM=ec.previousDrawTimestamp?.001*(eE-ec.previousDrawTimestamp):.0167;if(ec.previousDrawTimestamp=eE,ec.hasColorMap()){e_.activeTexture.set(eg.TEXTURE0+2);let el=ec.colorRampTexture;el||(el=ec.colorRampTexture=new F.T(e_,ec.colorRamp,eg.RGBA8)),el.bind(eg.LINEAR,eg.CLAMP_TO_EDGE)}e_.bindFramebuffer.set(ec.tileFramebuffer.framebuffer),function(el,eh,ec){var ep;let e_=el.context,eg=e_.gl,ey=eh.tileFramebuffer;e_.activeTexture.set(eg.TEXTURE0);let eb={u_texture:0,u_opacity:1.05*(ep=eh.paint.get("raster-particle-fade-opacity-factor"))/(ep+.05)},ew=el.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});for(let ep of ec){let[,,ec,eT]=ep;ey.colorAttachment.set(ec.targetColorTexture.texture),e_.viewport.set([0,0,ey.width,ey.height]),e_.clear({color:F.al.transparent}),eT&&(ec.backgroundColorTexture.bind(eg.NEAREST,eg.CLAMP_TO_EDGE),ew.draw(el,eg.TRIANGLES,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,eb,eh.id,el.viewportBuffer,el.quadTriangleIndexBuffer,el.viewportSegments))}}(el,ec,eS),function(el,eh,ec,ep){let e_=el.context,eg=e_.gl,ey=ec.tileFramebuffer,eb="globe"===el.transform.projection.name,ew=ec.paint.get("raster-particle-max-speed");for(let eT of ep){let[ep,eS,eE]=eT;e_.activeTexture.set(eg.TEXTURE0+0),eS.texture.bind(eg.LINEAR,eg.CLAMP_TO_EDGE),ey.colorAttachment.set(eE.targetColorTexture.texture);let eM=el.getOrCreateProgram("rasterParticleDraw",{defines:eS.defines,overrideFog:!1});e_.activeTexture.set(eg.TEXTURE0+1);let eI=eS.scalarData?[]:[0,1,2,3].map(el=>F.d7[el](ep));eI.push(ep);let eA=ep.canonical.x,eC=ep.canonical.y;for(let F of eI){let e_=eh.getTile(eb?F.wrapped():F);if(!e_)continue;let ey=e_.rasterParticleState;if(!ey)continue;let eT=F.canonical.x+(1<<F.canonical.z)*(F.wrap-ep.wrap),eE=F.canonical.y;ey.particleTexture0.bind(eg.NEAREST,eg.CLAMP_TO_EDGE);let eI=fr(1,ey.particleTexture0.size[0],[eT-eA,eE-eC],0,eS.texture.size,2,ew,eS.textureOffset,eS.scale,eS.offset);eM.draw(el,eg.POINTS,Bi.disabled,Ui.disabled,ki.alphaBlended,ji.disabled,eI,ec.id,ey.particleIndexBuffer,void 0,ey.particleSegment)}}}(el,eh,ec,eS),e_.bindFramebuffer.set(ec.particleFramebuffer.framebuffer),function(el,eh,ec,ep){let e_=el.context,eg=e_.gl,ey=eh.paint.get("raster-particle-max-speed"),eb=ep*eh.paint.get("raster-particle-speed-factor")*.15,ew=Math.pow(.01+1*eh.paint.get("raster-particle-reset-rate-factor"),6),eT=eh.particleFramebuffer;for(let ep of(e_.viewport.set([0,0,eT.width,eT.height]),ec)){let[,ec,eS]=ep;e_.activeTexture.set(eg.TEXTURE0+0),ec.texture.bind(eg.LINEAR,eg.CLAMP_TO_EDGE),e_.activeTexture.set(eg.TEXTURE0+1);let eE=eS.particleTexture0;eE.bind(eg.NEAREST,eg.CLAMP_TO_EDGE);let eM=mr(1,eE.size[0],0,ec.texture.size,ey,eb,ew,ec.textureOffset,ec.scale,ec.offset);eT.colorAttachment.set(eS.particleTexture1.texture),e_.clear({color:F.al.transparent}),el.getOrCreateProgram("rasterParticleUpdate",{defines:ec.defines}).draw(el,eg.TRIANGLES,Bi.disabled,Ui.disabled,ki.unblended,ji.disabled,eM,eh.id,el.viewportBuffer,el.quadTriangleIndexBuffer,el.viewportSegments)}}(el,ec,eS,eM)}(el,eh,ec,ep),"translucent"===el.renderPass&&(function(el,eh,ec,ep,e_){let eg=el.context,ey=eg.gl,eb=eh.getSource().tileSize,ew=5*(1-F.ae(F.bY,F.bY+1,el.transform.zoom))*eb+ec.paint.get("raster-particle-elevation"),eT=!el.options.moving,eS="globe"===el.transform.projection.name;if(!ep.length)return;let[eE,eM]=el.stencilConfigForOverlap(ep),eI=[];eS&&eI.push("PROJECTION_GLOBE_VIEW");let eA=el.stencilModeFor3D();for(let ep of eM){let e_,eb,eM,eC,eP,ez,eD;let eR=ep.toUnwrapped(),eL=eh.getTile(ep);if(!eL.rasterParticleState)continue;let eO=eL.rasterParticleState;eL.registerFadeDuration(100);let ek=eh.findLoadedParent(ep,0),eF=Ns(eL,ek,eh,el.transform,100);el.terrain&&el.terrain.prepareDrawTile(),eg.activeTexture.set(ey.TEXTURE0),eO.targetColorTexture.bind(ey.LINEAR,ey.CLAMP_TO_EDGE),eg.activeTexture.set(ey.TEXTURE1),ek&&ek.rasterParticleState?(ek.rasterParticleState.targetColorTexture.bind(ey.LINEAR,ey.CLAMP_TO_EDGE),e_=Math.pow(2,ek.tileID.overscaledZ-eL.tileID.overscaledZ),eb=[eL.tileID.canonical.x*e_%1,eL.tileID.canonical.y*e_%1]):eO.targetColorTexture.bind(ey.LINEAR,ey.CLAMP_TO_EDGE);let eB=eS?Float32Array.from(el.transform.expandedFarZProjMatrix):el.transform.calculateProjMatrix(eR,eT),eN=el.transform,eV=function(F){let el=F._nearZ,eh=F.projection.farthestPixelDistance(F),ec=eh-el,ep=.2*F.height,e_=el+ep;return[el,eh,(e_-ep-el)/ec,(e_-el)/ec]}(eN),eU=F.cF(ep.canonical),ej=F.cG(eU.getCenter().lat);eS?(eM=Float32Array.from(F.bc(F.cI(ep.canonical))),eC=Float32Array.from(eN.globeMatrix),eP=Float32Array.from(F.cE(eN)),ez=[F.av(eN.center.lng),F.aC(eN.center.lat)],eD=Float32Array.from(F.cH(ep.canonical,eU,ej,eN.worldSize/eN._pixelsPerMercatorPixel))):(eM=new Float32Array(16),eC=new Float32Array(9),eP=new Float32Array(16),ez=[0,0],eD=new Float32Array(9));let eG=pr(eB,eM,eC,eP,eD,eb||[0,0],F.ag(el.transform.zoom),ez,eV,e_||1,eF,ew),eq=el.isTileAffectedByFog(ep),e$=el.getOrCreateProgram("rasterParticle",{defines:eI,overrideFog:eq});if(el.uploadCommonUniforms(eg,e$,eR),eS){let F=new Bi(ey.LEQUAL,Bi.ReadOnly,el.depthRangeFor3D),eh=el.globeSharedBuffers;if(eh){let[ep,e_,eg]=eh.getGridBuffers(ej,!1);e$.draw(el,ey.TRIANGLES,F,eA,ki.alphaBlended,el.renderElevatedRasterBackface?ji.frontCCW:ji.backCCW,eG,ec.id,ep,e_,eg)}}else{let F=el.depthModeForSublayer(0,Bi.ReadOnly),eh=eE[ep.overscaledZ],{tileBoundsBuffer:e_,tileBoundsIndexBuffer:eg,tileBoundsSegments:eb}=el.getTileBoundsBuffers(eL);e$.draw(el,ey.TRIANGLES,F,eh,ki.alphaBlended,ji.disabled,eG,ec.id,e_,eg,eb)}}el.resetStencilClippingMasks()}(el,eh,ec,ep),el.style.map.triggerRepaint())},background:function(el,eh,ec,ep){let e_;let eg=ec.paint.get("background-color"),ey="none"===ec.paint.get("background-color-use-theme").constantOr("default"),eb=ec.paint.get("background-opacity"),ew=ec.paint.get("background-emissive-strength"),eT="viewport"===ec.paint.get("background-pitch-alignment");if(0===eb)return;let eS=el.context,eE=eS.gl,eM=el.transform,eI=eM.tileSize,eA=ec.paint.get("background-pattern");if(void 0!==eA&&(null===eA||!(e_=el.imageManager.getPattern(F.I.from(eA.toString()),ec.scope,el.style.getLut(ec.scope)))))return;let eC=!eA&&1===eg.a&&1===eb&&el.opaquePassEnabledForLayer()?"opaque":"translucent";if(el.renderPass!==eC)return;let eP=Ui.disabled,ez=el.depthModeForSublayer(0,"opaque"===eC?Bi.ReadWrite:Bi.ReadOnly),eD=el.colorModeForDrapableLayerRenderPass(ew),eR=eA?"backgroundPattern":"background",eL,eO=ep;if(eO||(eO=Object.values(eL=el.getBackgroundTiles()).map(F=>F.tileID)),eA&&(eS.activeTexture.set(eE.TEXTURE0),el.imageManager.bind(el.context,ec.scope)),eT){let eh=el.getOrCreateProgram(eR,{overrideFog:!1,overrideRtt:!0}),ep=new Float32Array(F.ad.mat4.identity([])),eS=new F.aH(0,0,0,0,0),eM=eA?xr(ep,ew,eb,el,0,ec.scope,e_,eT,{tileID:eS,tileSize:eI}):yr(ep,ew,eb,eg.toRenderColor(ey?null:ec.lut));eh.draw(el,eE.TRIANGLES,ez,eP,eD,ji.disabled,eM,ec.id,el.viewportBuffer,el.quadTriangleIndexBuffer,el.viewportSegments)}else for(let F of eO){let eC=el.isTileAffectedByFog(F),eO=el.getOrCreateProgram(eR,{overrideFog:eC}),ek=F.toUnwrapped(),eF=ep?F.projMatrix:el.transform.calculateProjMatrix(ek);el.prepareDrawTile();let eB=eh?eh.getTile(F):eL?eL[F.key]:new bt(F,eI,eM.zoom,el),eN=eA?xr(eF,ew,eb,el,0,ec.scope,e_,eT,{tileID:F,tileSize:eI}):yr(eF,ew,eb,eg.toRenderColor(ey?null:ec.lut));el.uploadCommonUniforms(eS,eO,ek);let{tileBoundsBuffer:eV,tileBoundsIndexBuffer:eU,tileBoundsSegments:ej}=el.getTileBoundsBuffers(eB);eO.draw(el,eE.TRIANGLES,ez,eP,eD,ji.disabled,eN,ec.id,eV,eU,ej)}},sky:function(el,eh,ec){let ep=el._atmosphere?F.ag(el.transform.zoom):1,e_=ec.paint.get("sky-opacity")*ep;if(0===e_)return;let eg=el.context,ey=ec.paint.get("sky-type"),eb=new Bi(eg.gl.LEQUAL,Bi.ReadOnly,[0,1]),ew=el.frameCounter/1e3%1;"atmosphere"===ey?"offscreen"===el.renderPass?ec.needsSkyboxCapture(el)&&(function(el,eh,ec,ep){let e_=el.context,eg=e_.gl,ey=eh.skyboxFbo;if(!ey){ey=eh.skyboxFbo=e_.createFramebuffer(32,32,!0,null),eh.skyboxGeometry=new fn(e_),eh.skyboxTexture=e_.gl.createTexture(),eg.bindTexture(eg.TEXTURE_CUBE_MAP,eh.skyboxTexture),eg.texParameteri(eg.TEXTURE_CUBE_MAP,eg.TEXTURE_WRAP_S,eg.CLAMP_TO_EDGE),eg.texParameteri(eg.TEXTURE_CUBE_MAP,eg.TEXTURE_WRAP_T,eg.CLAMP_TO_EDGE),eg.texParameteri(eg.TEXTURE_CUBE_MAP,eg.TEXTURE_MIN_FILTER,eg.LINEAR),eg.texParameteri(eg.TEXTURE_CUBE_MAP,eg.TEXTURE_MAG_FILTER,eg.LINEAR);for(let F=0;F<6;++F)eg.texImage2D(eg.TEXTURE_CUBE_MAP_POSITIVE_X+F,0,eg.RGBA,32,32,0,eg.RGBA,eg.UNSIGNED_BYTE,null)}e_.bindFramebuffer.set(ey.framebuffer),e_.viewport.set([0,0,32,32]);let eb=eh.getCenter(el,!0),ew=el.getOrCreateProgram("skyboxCapture"),eT=new Float64Array(16);F.ad.mat4.identity(eT),F.ad.mat4.rotateY(eT,eT,-(.5*Math.PI)),mn(el,eh,ew,eT,eb,0),F.ad.mat4.identity(eT),F.ad.mat4.rotateY(eT,eT,.5*Math.PI),mn(el,eh,ew,eT,eb,1),F.ad.mat4.identity(eT),F.ad.mat4.rotateX(eT,eT,-(.5*Math.PI)),mn(el,eh,ew,eT,eb,2),F.ad.mat4.identity(eT),F.ad.mat4.rotateX(eT,eT,.5*Math.PI),mn(el,eh,ew,eT,eb,3),F.ad.mat4.identity(eT),mn(el,eh,ew,eT,eb,4),F.ad.mat4.identity(eT),F.ad.mat4.rotateY(eT,eT,Math.PI),mn(el,eh,ew,eT,eb,5),e_.viewport.set([0,0,el.width,el.height])}(el,ec),ec.markSkyboxValid(el)):"sky"===el.renderPass&&function(F,el,eh,ec,ep){let e_=F.context,eg=e_.gl,ey=F.transform,eb=F.getOrCreateProgram("skybox");e_.activeTexture.set(eg.TEXTURE0),eg.bindTexture(eg.TEXTURE_CUBE_MAP,el.skyboxTexture);let ew={u_matrix:ey.skyboxMatrix,u_sun_direction:el.getCenter(F,!1),u_cubemap:0,u_opacity:ec,u_temporal_offset:ep};F.uploadCommonUniforms(e_,eb),eb.draw(F,eg.TRIANGLES,eh,Ui.disabled,F.colorModeForRenderPass(),ji.backCW,ew,"skybox",el.skyboxGeometry.vertexBuffer,el.skyboxGeometry.indexBuffer,el.skyboxGeometry.segment)}(el,ec,eb,e_,ew):"gradient"===ey&&"sky"===el.renderPass&&function(el,eh,ec,ep,e_){var eg,ey,eb;let ew=el.context,eT=ew.gl,eS=el.transform,eE=el.getOrCreateProgram("skyboxGradient");eh.skyboxGeometry||(eh.skyboxGeometry=new fn(ew)),ew.activeTexture.set(eT.TEXTURE0);let eM=eh.colorRampTexture;eM||(eM=eh.colorRampTexture=new F.T(ew,eh.colorRamp,eT.RGBA8)),eM.bind(eT.LINEAR,eT.CLAMP_TO_EDGE);let eI=(eg=eS.skyboxMatrix,ey=eh.getCenter(el,!1),eb=eh.paint.get("sky-gradient-radius"),{u_matrix:eg,u_color_ramp:0,u_center_direction:ey,u_radius:F.ak(eb),u_opacity:ep,u_temporal_offset:e_});el.uploadCommonUniforms(ew,eE),eE.draw(el,eT.TRIANGLES,ec,Ui.disabled,el.colorModeForRenderPass(),ji.backCW,eI,"skyboxGradient",eh.skyboxGeometry.vertexBuffer,eh.skyboxGeometry.indexBuffer,eh.skyboxGeometry.segment)}(el,ec,eb,e_,ew)},debug:function(el,eh,ec,ep,e_,eg){for(let ey=0;ey<ec.length;ey++)if(e_){let e_=new F.al(.8*ep.r,.8*ep.g,.8*ep.b,1);ln(el,eh,ec[ey],ep,-1,-1,eg),ln(el,eh,ec[ey],ep,-1,1,eg),ln(el,eh,ec[ey],ep,1,1,eg),ln(el,eh,ec[ey],ep,1,-1,eg),ln(el,eh,ec[ey],e_,0,0,eg)}else ln(el,eh,ec[ey],ep,0,0,eg)},custom:function(el,eh,ec,ep){let e_=el.context,eg=ec.implementation;if(!el.transform.projection.unsupportedLayers||!el.transform.projection.unsupportedLayers.includes("custom")||el.terrain&&(el.terrain.renderingToTexture||"offscreen"===el.renderPass)&&ec.isDraped(eh)){if("offscreen"===el.renderPass){let eh=eg.prerender;if(eh){if(el.setCustomLayerDefaults(),e_.setColorMode(el.colorModeForRenderPass()),"globe"===el.transform.projection.name){let ec=el.transform.pointMerc;eh.call(eg,e_.gl,el.transform.customLayerMatrix(),el.transform.getProjection(),el.transform.globeToMercatorMatrix(),F.ag(el.transform.zoom),[ec.x,ec.y],el.transform.pixelsPerMeterRatio)}else eh.call(eg,e_.gl,el.transform.customLayerMatrix());e_.setDirty(),el.setBaseState()}}else if("translucent"===el.renderPass){if(el.terrain&&el.terrain.renderingToTexture){let eh=eg.renderToTile;if(eh){let ec=ep[0].canonical,ey=new F.ac(ec.x+ep[0].wrap*(1<<ec.z),ec.y,ec.z);e_.setDepthMode(Bi.disabled),e_.setStencilMode(Ui.disabled),e_.setColorMode(el.colorModeForRenderPass()),el.setCustomLayerDefaults(),eh.call(eg,e_.gl,ey),e_.setDirty(),el.setBaseState()}return}el.setCustomLayerDefaults(),e_.setColorMode(el.colorModeForRenderPass()),e_.setStencilMode(Ui.disabled);let eh="3d"===eg.renderingMode?new Bi(el.context.gl.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D):el.depthModeForSublayer(0,Bi.ReadOnly);if(e_.setDepthMode(eh),"globe"===el.transform.projection.name){let eh=el.transform.pointMerc;eg.render(e_.gl,el.transform.customLayerMatrix(),el.transform.getProjection(),el.transform.globeToMercatorMatrix(),F.ag(el.transform.zoom),[eh.x,eh.y],el.transform.pixelsPerMeterRatio)}else eg.render(e_.gl,el.transform.customLayerMatrix());e_.setDirty(),el.setBaseState(),e_.bindFramebuffer.set(null)}}else F.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(el,eh,ec,ep){if("opaque"===el.renderPass)return;let e_=ec.paint.get("model-opacity").constantOr(1);if(0===e_)return;let eg=ec.paint.get("model-cast-shadows");if("shadow"===el.renderPass&&(!eg||el.terrain&&e_<.65&&ec._transitionablePaint._values["model-opacity"].value.expression instanceof F.ab))return;let ey=el.shadowRenderer,eb=ec.paint.get("model-receive-shadows");ey&&(ey.useNormalOffset=!0,eb||(ey.enabled=!1));let c=()=>{ey&&(ey.useNormalOffset=!0,eb||(ey.enabled=!0))},ew=eh.getSource();if("light-beam"===el.renderPass&&"batched-model"!==ew.type)return;if("vector"===ew.type||"geojson"===ew.type)return function(el,eh,ec,ep,e_){let eg=el.transform;if("mercator"!==eg.projection.name)return void F.w(`Drawing 3D models for ${eg.projection.name} projection is not yet implemented`);let ey=eg.getFreeCameraOptions().position;if(!el.modelManager)return;let eb=el.modelManager;ec.modelManager=eb;let ew=el.shadowRenderer;if(!ec._unevaluatedLayout._values.hasOwnProperty("model-id"))return;let eT=ec._unevaluatedLayout._values["model-id"],eS=Object.assign({},ec.layout.get("model-id").parameters),eE=el.style.order.indexOf(ec.fqid);for(let eM of ep){let ep=eh.getTile(eM).getBucket(ec);if(!ep||ep.projection.name!==eg.projection.name)continue;let eI=ep.getModelUris();eI&&!ep.modelsRequested&&(eb.addModelsFromBucket(eI,e_),ep.modelsRequested=!0);let eA=function(el,eh){let ec=1<<el.canonical.z,ep=eh.getFreeCameraOptions().position,e_=eh.elevation,eg=el.canonical.x/ec,ey=(el.canonical.x+1)/ec,eb=el.canonical.y/ec,ew=(el.canonical.y+1)/ec,eT=eh._centerAltitude;if(e_){let F=e_.getMinMaxForTile(el);F&&F.max>eT&&(eT=F.max)}let eS=F.ay(ep.x,eg,ey)-ep.x,eE=F.ay(ep.y,eb,ew)-ep.y,eM=F.bH(eT,eh.center.lat)-ep.z;return eh._zoomFromMercatorZ(Math.sqrt(eS*eS+eE*eE+eM*eM))}(eM,eg);eS.zoom=eA;let eC=eT.possiblyEvaluate(eS);if(function(el,eh,ec){let ep=eh.updateZoomBasedPaintProperties(),e_=function(el,eh,ec){let ep,e_,eg,ey=el.terrain?el.terrain.exaggeration():0;if(el.terrain&&ey>0){let eh=el.terrain,e_=eh.findDEMTileFor(ec);e_&&e_.dem?ep=F.dr.create(eh,ec,e_):ey=0}if(0===ey&&(eh.terrainElevationMin=0,eh.terrainElevationMax=0),ey===eh.validForExaggeration&&(0===ey||ep&&ep._demTile&&ep._demTile.tileID===eh.validForDEMTile.id&&ep._dem._timestamp===eh.validForDEMTile.timestamp))return!1;for(let F in eh.instancesPerModel){let el=eh.instancesPerModel[F];for(let F=0;F<el.instancedDataArray.length;++F){let ec=(ep?ey*ep.getElevationAt(0|el.instancedDataArray.float32[16*F],0|el.instancedDataArray.float32[16*F+1],!0,!0):0)+el.instancesEvaluatedElevation[F];el.instancedDataArray.float32[16*F+6]=ec,e_=e_?Math.min(eh.terrainElevationMin,ec):ec,eg=eg?Math.max(eh.terrainElevationMax,ec):ec}}return eh.terrainElevationMin=e_||0,eh.terrainElevationMax=eg||0,eh.validForExaggeration=ey,eh.validForDEMTile=ep&&ep._demTile?{id:ep._demTile.tileID,timestamp:ep._dem._timestamp}:{id:void 0,timestamp:0},!0}(el,eh,ec);(ep||e_)&&(eh.uploaded=!1,eh.upload(el.context))}(el,ep,eM),t6.shadowUniformsInitialized=!1,t6.useSingleShadowCascade=!!ew&&0===ew.getMaxCascadeForTile(eM.toUnwrapped()),"shadow"===el.renderPass&&ew){if(1===el.currentShadowCascade&&ep.isInsideFirstShadowMapFrustum)continue;let eh=eg.calculatePosMatrix(eM.toUnwrapped(),eg.worldSize);if(t6.tileMatrix.set(eh),t6.shadowTileMatrix=Float32Array.from(ew.calculateShadowPassMatrixFromMatrix(eh)),t6.aabb.min.fill(0),t6.aabb.max[0]=t6.aabb.max[1]=F.ai,t6.aabb.max[2]=0,function(el,eh,ec,ep){if(!ec.modelManager)return!0;let e_=ec.modelManager;if(!ec.shadowRenderer)return!0;let eg=ec.shadowRenderer,ey=eh.aabb,eb=!0,ew=el.maxHeight;if(0===ew){let F=0;for(let eh in el.instancesPerModel){let el=e_.getModel(eh,ep);el?F=Math.max(F,Math.max(Math.max(el.aabb.max[0],el.aabb.max[1]),el.aabb.max[2])):eb=!1}ew=el.maxScale*F*1.41+el.maxVerticalOffset,eb&&(el.maxHeight=ew)}ey.max[2]=ew,ey.min[2]+=el.terrainElevationMin,ey.max[2]+=el.terrainElevationMax,F.ad.vec3.transformMat4(ey.min,ey.min,eh.tileMatrix),F.ad.vec3.transformMat4(ey.max,ey.max,eh.tileMatrix);let eT=ey.intersects(eg.getCurrentCascadeFrustum());return 0===ec.currentShadowCascade&&(el.isInsideFirstShadowMapFrustum=2===eT),0===eT}(ep,t6,el,ec.scope))continue}let eP=1<<eM.canonical.z,ez=[((ey.x-eM.wrap)*eP-eM.canonical.x)*F.ai,(ey.y*eP-eM.canonical.y)*F.ai,ey.z*eP*F.ai];for(let F in el.conflationActive&&Object.keys(ep.instancesPerModel).length>0&&el.style.isLayerClipped(ec,eh.getSource())&&ep.updateReplacement(eM,el.replacementSource,eE,e_)&&(ep.uploaded=!1,ep.upload(el.context)),ep.instancesPerModel){let eh=ep.instancesPerModel[F];eh.features.length>0&&(F=eC.evaluate(eh.features[0].feature,{}));let eg=eb.getModel(F,e_);if(eg&&eg.uploaded)for(let F of eg.nodes)(function An(F,el,eh,ec,ep,e_,eg){let ey=F.context,eb="shadow"===F.renderPass,ew=F.shadowRenderer,eT=eb&&ew?ew.getShadowPassDepthMode():new Bi(ey.gl.LEQUAL,Bi.ReadWrite,F.depthRangeFor3D),eS=F.isTileAffectedByFog(e_);if(eh.meshes)for(let eE of eh.meshes){let eM,eI,eA;let eC=["MODEL_POSITION_ON_GPU"],eP=[];ec.instancedDataArray.length>20&&eC.push("INSTANCED_ARRAYS");let ez=Qi(F,el.paint.get("model-cutoff-fade-range"));if(ez.shouldRenderCutoff&&eC.push("RENDER_CUTOFF"),eb&&ew)eM=F.getOrCreateProgram("modelDepth",{defines:eC}),eI=Tr(eg.shadowTileMatrix,eg.shadowTileMatrix,Float32Array.from(eh.matrix)),eA=ew.getShadowPassColorMode();else{Tn(eC,eP,eE,F,"none"===el.paint.get("model-color-use-theme").constantOr("default")?null:el.lut),eM=F.getOrCreateProgram("model",{defines:eC,overrideFog:eS});let ec=eE.material,eb=ec.pbrMetallicRoughness,eT=el.paint.get("model-opacity").constantOr(1),eD=el.paint.get("model-emissive-strength").constantOr(0);eI=wr(e_.expandedProjMatrix,Float32Array.from(eh.matrix),new Float32Array(16),null,F,eT,eb.baseColorFactor.toRenderColor(null),ec.emissiveFactor,eb.metallicFactor,eb.roughnessFactor,ec,eD,el,ep),ew&&(eg.shadowUniformsInitialized?eM.setShadowUniformValues(ey,ew.getShadowUniformValues()):(ew.setupShadows(e_.toUnwrapped(),eM,"model-tile",e_.overscaledZ),eg.shadowUniformsInitialized=!0)),eA=ez.shouldRenderCutoff||eT<1||"OPAQUE"!==ec.alphaMode?ki.alphaBlended:ki.unblended}F.uploadCommonUniforms(ey,eM,e_.toUnwrapped(),null,ez);let eD=eE.material.doubleSided?ji.disabled:ji.backCCW;if(ec.instancedDataArray.length>20)eP.push(ec.instancedDataBuffer),eM.draw(F,ey.gl.TRIANGLES,eT,Ui.disabled,eA,eD,eI,el.id,eE.vertexBuffer,eE.indexBuffer,eE.segments,el.paint,F.transform.zoom,void 0,eP,ec.instancedDataArray.length);else{let eh=eb?"u_instance":"u_normal_matrix";for(let ep=0;ep<ec.instancedDataArray.length;++ep)eI[eh]=new Float32Array(ec.instancedDataArray.arrayBuffer,64*ep,16),eM.draw(F,ey.gl.TRIANGLES,eT,Ui.disabled,eA,eD,eI,el.id,eE.vertexBuffer,eE.indexBuffer,eE.segments,el.paint,F.transform.zoom,void 0,eP)}}if(eh.children)for(let ey of eh.children)An(F,el,ey,ec,ep,e_,eg)})(el,ec,F,eh,ez,eM,t6)}}}(el,eh,ec,ep,"vector"===ew.type?ec.scope:""),void c();if(!ew.loaded())return;if("batched-model"===ew.type)return function(el,eh,ec,ep){ec.resetLayerRenderingStats(el);let e_=el.context,eg=el.transform,ey=el.style.fog,eb=el.shadowRenderer;if("mercator"!==eg.projection.name)return void F.w(`Drawing 3D landmark models for ${eg.projection.name} projection is not yet implemented`);let ew=el.transform.getFreeCameraOptions().position,eT=F.ad.vec3.scale([],[ew.x,ew.y,ew.z],el.transform.worldSize),eS=F.ad.vec3.negate([],eT),eE=F.ad.mat4.identity([]),eM=F.dm(eg.center.lat,eg.zoom),eI=F.ad.mat4.fromScaling([],[1,1,1/eM]);F.ad.mat4.translate(eE,eE,eS);let eA=ec.paint.get("model-opacity").constantOr(1),eC=new Bi(e_.gl.LEQUAL,Bi.ReadWrite,el.depthRangeFor3D),eP=new Bi(e_.gl.LEQUAL,Bi.ReadOnly,el.depthRangeFor3D),ez=new F.ce([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),eD="shadow"===el.renderPass,eR=eD&&eb?eb.getCurrentCascadeFrustum():eg.getFrustum(eg.scaleZoom(eg.worldSize)),eL=ec.paint.get("model-front-cutoff"),eO=eL[2]<1,ek=Qi(el,ec.paint.get("model-cutoff-fade-range")),eF=ec.getLayerRenderingStats();(function(F,el,eh,ec){let ep=F.terrain?F.terrain.exaggeration():0,e_=F.transform.zoom;for(let eg of ec){let ec=el.getTile(eg).getBucket(eh);ec&&(ec.setFilter(eh.filter),F.conflationActive&&ec.updateReplacement(eg,F.replacementSource),ec.evaluateScale(F,eh),F.terrain&&ep>0&&ec.elevationUpdate(F.terrain,ep,eg,eh.source),ec.needsReEvaluation(F,e_,eh)&&ec.evaluate(eh))}})(el,eh,ec,ep),function(){let ew,eS,eB;eO?(ew=ep.length-1,eS=-1,eB=-1):(ew=0,eS=ep.length,eB=1);let eN=new Float64Array(16),eV=F.ad.vec3.create(),eU=new F.P(0,0);for(let ej=ew;ej!==eS;ej+=eB){let ew=ep[ej],eS=eh.getTile(ew).getBucket(ec);if(!eS||!eS.uploaded)continue;let eB=!1;eb&&(eB=0===eb.getMaxCascadeForTile(ew.toUnwrapped()));let eG=eg.calculatePosMatrix(ew.toUnwrapped(),eg.worldSize),eq=eS.modelTraits;!eD&&eO&&(F.ad.mat4.invert(eN,eG),F.ad.vec3.transformMat4(eV,eT,eN),eU.x=eV[0],eU.y=eV[1]);let e$=[];for(let eh of(eS.setFilter(ec.filter),eS.getNodesInfo())){if(eh.hiddenByReplacement||!eh.node.meshes)continue;let ec=eh.node,ep=0;el.terrain&&ec.elevation&&(ep=ec.elevation*el.terrain.exaggeration());let e_=(()=>{let el=eh.aabb;return ez.min=[...el.min],ez.max=[...el.max],ez.min[2]+=ep,ez.max[2]+=ep,F.ad.vec3.transformMat4(ez.min,ez.min,eG),F.ad.vec3.transformMat4(ez.max,ez.max,eG),ez})(),ey=eh.evaluatedScale;if(ey[0]<=1&&ey[1]<=1&&ey[2]<=1&&0===e_.intersects(eR))continue;if(!eD&&eO){let el=1/6;eh.cameraCollisionOpacity=eT[0]>e_.min[0]&&eT[0]<e_.max[0]&&eT[1]>e_.min[1]&&eT[1]<e_.max[1]&&eT[2]*eM<e_.max[2]&&ec.footprint&&F.bA(eU,ec.footprint)?Math.max(eh.cameraCollisionOpacity-el,0):Math.min(1,eh.cameraCollisionOpacity+el)}let eb=[...eG],ew=ec.anchor?ec.anchor[0]:0,eS=ec.anchor?ec.anchor[1]:0;F.ad.mat4.translate(eb,eb,[ew*(ey[0]-1),eS*(ey[1]-1),ep]),F.ad.vec3.exactEquals(ey,F.dq)||F.ad.mat4.scale(eb,eb,ey);let eE=F.ad.mat4.multiply([],eb,ec.matrix),eI=F.ad.mat4.multiply([],eg.expandedFarZProjMatrix,eE),eC=F.ad.mat4.multiply([],eg.expandedFarZProjMatrix,eb),eP=F.ad.vec4.transformMat4([],[ew,eS,ep,1],eI)[2];ec.hidden=!1;let eF=eA;eD||(eO&&(eF*=eh.cameraCollisionOpacity*function(el,eh,ec,ep){if(eh.pitch<20)return 1;let e_=eh.getWorldToCameraMatrix();F.ad.mat4.multiply(e_,e_,el);let eg=F.ad.vec4.fromValues(ec.min[0],ec.min[1],ec.min[2],1),ey=F.ad.vec4.transformMat4(F.ad.vec4.create(),eg,e_),eb=ey,ew=ey;eg[1]=ec.max[1],eb=(ey=F.ad.vec4.transformMat4(F.ad.vec4.create(),eg,e_))[1]<eb[1]?ey:eb,ew=ey[1]>ew[1]?ey:ew,eg[0]=ec.max[0],eb=(ey=F.ad.vec4.transformMat4(F.ad.vec4.create(),eg,e_))[1]<eb[1]?ey:eb,ew=ey[1]>ew[1]?ey:ew,eg[1]=ec.min[1],eb=(ey=F.ad.vec4.transformMat4(F.ad.vec4.create(),eg,e_))[1]<eb[1]?ey:eb,ew=ey[1]>ew[1]?ey:ew;let eT=F.ay(ep[0],0,1),eS=100*eh.pixelsPerMeter*F.ay(ep[1],0,1),eE=F.ay(ep[2],0,1),eM=F.ad.vec4.lerp(F.ad.vec4.create(),eb,ew,eT),eI=Math.tan(.5*eh.fovX),eA=-eM[2]*eI;if(0===eS)return eM[1]<-Math.abs(eA)?eE:1;let eC=(-Math.abs(eA)-eM[1])/eS,g=(F,el,eh)=>(1-eh)*F+eh*el,eP=F.ay(g(1,eE,eC),eE,1);return g(1,eP,F.ay((eh.pitch-20)/20,0,1))}(eb,eg,eh.aabb,eL)),eF*=function(el,eh){let ec=el.uniformValues.u_cutoff_params[0],ep=el.uniformValues.u_cutoff_params[1],e_=el.uniformValues.u_cutoff_params[2],eg=el.uniformValues.u_cutoff_params[3];return ep===ec||eg===e_?1:F.ay(((eh-ec)/(ep-ec)-e_)/(eg-e_),0,1)}(ek,eP)),0!==eF?e$.push({nodeInfo:eh,depth:eP,opacity:eF,wvpForNode:eI,wvpForTile:eC,nodeModelMatrix:eE,tileModelMatrix:eb}):ec.hidden=!0}for(let eh of(eD||e$.sort((F,el)=>eO&&(1!==F.opacity||1!==el.opacity)?1===F.opacity?-1:1===el.opacity?1:F.depth>el.depth?-1:1:F.depth<el.depth?-1:1),e$)){let ep=eh.nodeInfo,ew=ep.node,eT=F.ad.mat4.multiply([],eI,eh.tileModelMatrix);F.ad.mat4.multiply(eT,eE,eT);let eS=F.ad.mat4.invert([],eT);F.ad.mat4.transpose(eS,eS),F.ad.mat4.scale(eS,eS,t8),eT=F.ad.mat4.multiply(eT,eT,ew.matrix);let eM="light-beam"===el.renderPass,eA="none"===ec.paint.get("model-color-use-theme").constantOr("default"),ez=eq&F.ds.HasMapboxMeshFeatures,eR=ez?0:ep.evaluatedRMEA[0][2];for(let F=0;F<ew.meshes.length;++F){let eE;let eI=ew.meshes[F],eL=F===ew.lightMeshIndex,eO=eh.wvpForNode;if(eL){if(!eM&&!el.terrain&&el.shadowRenderer){el.currentLayer<el.firstLightBeamLayer&&(el.firstLightBeamLayer=el.currentLayer);continue}eO=eh.wvpForTile}else if(eM)continue;let ek={defines:[]},eN=[];if(!eD&&eb&&(eb.useNormalOffset=!!eI.normalBuffer),Tn(ek.defines,eN,eI,el,eA?null:ec.lut),ez||ek.defines.push("DIFFUSE_SHADED"),eB&&ek.defines.push("SHADOWS_SINGLE_CASCADE"),eF&&(eD?eF.numRenderedVerticesInShadowPass+=eI.vertexArray.length:eF.numRenderedVerticesInTransparentPass+=eI.vertexArray.length),eD){Cn(eI,eh.nodeModelMatrix,el,ec);continue}let eV=null;if(ey){let F=wn(eh.nodeModelMatrix,el.transform);if(eV=new Float32Array(F),"globe"!==eg.projection.name){let el=eI.aabb.min,eh=eI.aabb.max,[ec,ep]=ey.getOpacityForBounds(F,el[0],el[1],eh[0],eh[1]);ek.overrideFog=ec>=.05||ep>=.05}}let eU=eI.material;eU.occlusionTexture&&eU.occlusionTexture.offsetScale&&(eE=eU.occlusionTexture.offsetScale,ek.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));let ej=el.getOrCreateProgram("model",ek);!eD&&eb&&eb.setupShadowsFromMatrix(eh.tileModelMatrix,ej,eb.useNormalOffset),el.uploadCommonUniforms(e_,ej,null,eV);let eG=eU.pbrMetallicRoughness;eG.metallicFactor=.9,eG.roughnessFactor=.5;let eq=wr(new Float32Array(eO),new Float32Array(eT),new Float32Array(eS),new Float32Array(ew.matrix),el,eh.opacity,eG.baseColorFactor.toRenderColor(null),eU.emissiveFactor,eG.metallicFactor,eG.roughnessFactor,eU,eR,ec,[0,0,0],eE);!eL&&(ep.hasTranslucentParts||eh.opacity<1)&&ej.draw(el,e_.gl.TRIANGLES,eC,Ui.disabled,ki.disabled,ji.backCCW,eq,ec.id,eI.vertexBuffer,eI.indexBuffer,eI.segments,ec.paint,el.transform.zoom,void 0,eN),ej.draw(el,e_.gl.TRIANGLES,eL?eP:eC,Ui.disabled,eL||eh.opacity<1||ep.hasTranslucentParts?ki.alphaBlended:ki.unblended,ji.backCCW,eq,ec.id,eI.vertexBuffer,eI.indexBuffer,eI.segments,ec.paint,el.transform.zoom,void 0,eN)}}}}()}(el,eh,ec,ep),void c();if("model"!==ew.type)return;let eT=ew.getModels(),eS=[],eE=el.transform.getFreeCameraOptions().position,eM=F.ad.vec3.scale([],[eE.x,eE.y,eE.z],el.transform.worldSize);F.ad.vec3.negate(eM,eM);let eI=[],eA=[],eC=0;for(let eh of eT){let ep=ec.paint.get("model-rotation").constantOr(null),e_=ec.paint.get("model-scale").constantOr(null),eg=ec.paint.get("model-translation").constantOr(null);eh.computeModelMatrix(el,ep,e_,eg,!0,!0,!1);let ey=F.ad.mat4.identity([]),eb=F.dm(eh.position.lat,el.transform.zoom),ew=F.ad.mat4.fromScaling([],[1,1,1/eb]);for(let ec of(F.ad.mat4.translate(ey,ey,eM),eS.push({zScaleMatrix:ew,negCameraPosMatrix:ey}),eh.nodes))!function Sn(el,eh,ec,ep,e_,eg,ey){let eb;eb="globe"===el.projection.name?F.dp(ec,el):[...ec],F.ad.mat4.multiply(eb,eb,eh.matrix);let ew=F.ad.mat4.multiply([],ep,eb);if(eh.meshes)for(let ec of eh.meshes){if("BLEND"!==ec.material.alphaMode){ey.push({mesh:ec,depth:0,modelIndex:e_,worldViewProjection:ew,nodeModelMatrix:eb});continue}let eh=F.ad.vec3.transformMat4([],ec.centroid,ew);!el.isOrthographic&&eh[2]<=0||eg.push({mesh:ec,depth:eh[2],modelIndex:e_,worldViewProjection:ew,nodeModelMatrix:eb})}if(eh.children)for(let F of eh.children)Sn(el,F,ec,ep,e_,eg,ey)}(el.transform,ec,eh.matrix,el.transform.expandedFarZProjMatrix,eC,eI,eA);eC++}if(eI.sort((F,el)=>el.depth-F.depth),"shadow"!==el.renderPass){if(1===e_)for(let F of eA)En(F,el,ec,eS[F.modelIndex],Ui.disabled,el.colorModeForRenderPass());else{for(let F of eA)En(F,el,ec,eS[F.modelIndex],Ui.disabled,ki.disabled);for(let F of eA)En(F,el,ec,eS[F.modelIndex],el.stencilModeFor3D(),el.colorModeForRenderPass());el.resetStencilClippingMasks()}for(let F of eI)En(F,el,ec,eS[F.modelIndex],Ui.disabled,el.colorModeForRenderPass());c()}else{for(let F of eA)Cn(F.mesh,F.nodeModelMatrix,el,ec);for(let F of eI)Cn(F.mesh,F.nodeModelMatrix,el,ec);c()}}},id={line:function(F,el,eh){if(F.hasElevatedBuckets=!1,F.hasNonElevatedBuckets=!1,void 0!==F._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==F._unevaluatedLayout.getValue("line-z-offset")){if(el){let eh=el.getVisibleCoordinates();for(let ec of eh){let eh=el.getTile(ec).getBucket(F);if(eh&&(eh.hasZOffset?F.hasElevatedBuckets=!0:F.hasNonElevatedBuckets=!0,F.hasElevatedBuckets&&F.hasNonElevatedBuckets))break}}}else F.hasNonElevatedBuckets=!0},model:function(F,el,eh){let ec=el.getSource();if(!ec.loaded())return;if("vector"===ec.type||"geojson"===ec.type)return void(eh.modelManager&&eh.modelManager.upload(eh,"vector"===ec.type?F.scope:""));if("batched-model"===ec.type||"model"!==ec.type)return;let ep=ec.getModels();for(let F of ep)F.upload(eh.context)},raster:function(F,el,eh){let ec=el.getSource();if(!(ec instanceof ot&&ec.loaded()))return;let ep=F.sourceLayer||ec.rasterLayerIds&&ec.rasterLayerIds[0];if(!ep)return;let e_=F.paint.get("raster-array-band")||ec.getInitialBand(ep);if(null==e_)return;let eg=el.getIds().map(F=>el.getTileByID(F));for(let F of eg)F.updateNeeded(ep,e_)&&ec.prepareTile(F,ep,e_)},"raster-particle":function(F,el,eh){let ec=el.getSource();if(!(ec instanceof ot&&ec.loaded()))return;let ep=F.sourceLayer||ec.rasterLayerIds&&ec.rasterLayerIds[0];if(!ep)return;let e_=F.paint.get("raster-particle-array-band")||ec.getInitialBand(ep);if(null==e_)return;let eg=el.getIds().map(F=>el.getTileByID(F));for(let F of eg)F.updateNeeded(ep,e_)&&ec.prepareTile(F,ep,e_)}},ip={fill:Nr};let ea=class ea{constructor(el,eh,ec,ep,e_){this.context=new Dr(el,eh),this.transform=ec,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=e_,this._timeStamp=F.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};let eg=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(let F of eg)this._debugParams.enabledLayers[F]=!0;for(let F of(e_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),e_.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),e_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),e_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),e_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),e_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200}),eg))e_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],F);this.occlusionParams=new kn(e_),this.setup(),this.numSublayers=St.maxUnderzooming+St.maxOverzooming+1,this.depthEpsilon=1/65536,this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new F.dy,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new oo(this),this._wireframeDebugCache=new Fn,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];let ey=new F.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new F.T(this.context,ey,el.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=ep}updateTerrain(F,el){let eh=!!F&&!!F.terrain&&this.transform.projection.supportsTerrain;if(!(eh||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new js(this,F));let ec=this._terrain;this.transform.elevation=eh?ec:null,ec.update(F,this.transform,el),this.transform.elevation&&!ec.enabled&&(this.transform.elevation=null)}_updateFog(F){let el=F.fog;if(!el||"globe"===this.transform.projection.name||1>el.getOpacity(this.transform.pitch)||.03>el.properties.get("horizon-blend"))return void(this.transform.fogCullDistSq=null);let[eh,ec]=el.getFovAdjustedRange(this.transform._fov);if(eh>ec)return void(this.transform.fogCullDistSq=null);let ep=eh+.78*(ec-eh);this.transform.fogCullDistSq=ep*ep}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(F){F&&!this._terrain&&(this._terrain=new js(this,this.style)),this._forceTerrainMode=F}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(el,eh){if(this.width=el*F.q.devicePixelRatio,this.height=eh*F.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(let F of this.style.order)this.style._mergedLayers[F].resize()}setup(){let el=this.context,eh=new F.b5;eh.emplaceBack(0,0),eh.emplaceBack(F.ai,0),eh.emplaceBack(0,F.ai),eh.emplaceBack(F.ai,F.ai),this.tileExtentBuffer=el.createVertexBuffer(eh,F.b7.members),this.tileExtentSegments=F.b8.simpleSegment(0,0,4,2);let ec=new F.b5;ec.emplaceBack(0,0),ec.emplaceBack(F.ai,0),ec.emplaceBack(0,F.ai),ec.emplaceBack(F.ai,F.ai),this.debugBuffer=el.createVertexBuffer(ec,F.b7.members),this.debugSegments=F.b8.simpleSegment(0,0,4,5);let ep=new F.b5;ep.emplaceBack(-1,-1),ep.emplaceBack(1,-1),ep.emplaceBack(-1,1),ep.emplaceBack(1,1),this.viewportBuffer=el.createVertexBuffer(ep,F.b7.members),this.viewportSegments=F.b8.simpleSegment(0,0,4,2);let e_=new F.aU;e_.emplaceBack(0,0,0,0),e_.emplaceBack(F.ai,0,F.ai,0),e_.emplaceBack(0,F.ai,0,F.ai),e_.emplaceBack(F.ai,F.ai,F.ai,F.ai),this.mercatorBoundsBuffer=el.createVertexBuffer(e_,F.ba.members),this.mercatorBoundsSegments=F.b8.simpleSegment(0,0,4,2);let eg=new F.aV;eg.emplaceBack(0,1,2),eg.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=el.createIndexBuffer(eg);let ey=new F.b6;for(let F of[0,1,3,2,0])ey.emplaceBack(F);this.debugIndexBuffer=el.createIndexBuffer(ey),this.emptyTexture=new F.T(el,new F.r({width:1,height:1},Uint8Array.of(0,0,0,0)),el.gl.RGBA8),this.identityMat=F.ad.mat4.create();let eb=this.context.gl;this.stencilClearMode=new Ui({func:eb.ALWAYS,mask:0},0,255,eb.ZERO,eb.ZERO,eb.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(F){return F._makeTileBoundsBuffers(this.context,this.transform.projection),F._tileBoundsBuffer?{tileBoundsBuffer:F._tileBoundsBuffer,tileBoundsIndexBuffer:F._tileBoundsIndexBuffer,tileBoundsSegments:F._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){let F=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,F.TRIANGLES,Bi.disabled,this.stencilClearMode,ki.disabled,ji.disabled,Bs(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(F,el,eh){if(!el||this.currentStencilSource===el.id||!F.isTileClipped()||!eh||0===eh.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let F=!1;for(let el of eh)if(void 0===this._tileClippingMaskIDs[el.key]){F=!0;break}if(!F)return}this.currentStencilSource=el.id;let ec=this.context,ep=ec.gl;this.nextStencilID+eh.length>256&&this.clearStencil(),ec.setColorMode(ki.disabled),ec.setDepthMode(Bi.disabled);let e_=this.getOrCreateProgram("clippingMask");for(let F of(this._tileClippingMaskIDs={},eh)){let eh=el.getTile(F),ec=this._tileClippingMaskIDs[F.key]=this.nextStencilID++,{tileBoundsBuffer:eg,tileBoundsIndexBuffer:ey,tileBoundsSegments:eb}=this.getTileBoundsBuffers(eh);e_.draw(this,ep.TRIANGLES,Bi.disabled,new Ui({func:ep.ALWAYS,mask:0},ec,255,ep.KEEP,ep.KEEP,ep.REPLACE),ki.disabled,ji.disabled,Bs(F.projMatrix),"$clipping",eg,ey,eb)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();let F=this.nextStencilID++,el=this.context.gl;return new Ui({func:el.NOTEQUAL,mask:255},F,255,el.KEEP,el.KEEP,el.REPLACE)}stencilModeForClipping(F){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(F);let el=this.context.gl;return new Ui({func:el.EQUAL,mask:255},this._tileClippingMaskIDs[F.key],0,el.KEEP,el.KEEP,el.REPLACE)}stencilConfigForOverlap(F){let el=this.context.gl,eh=F.sort((F,el)=>el.overscaledZ-F.overscaledZ),ec=eh[eh.length-1].overscaledZ,ep=eh[0].overscaledZ-ec+1;if(ep>1){this.currentStencilSource=void 0,this.nextStencilID+ep>256&&this.clearStencil();let F={};for(let eh=0;eh<ep;eh++)F[eh+ec]=new Ui({func:el.GEQUAL,mask:255},eh+this.nextStencilID,255,el.KEEP,el.KEEP,el.REPLACE);return this.nextStencilID+=ep,[F,eh]}return[{[ec]:Ui.disabled},eh]}colorModeForRenderPass(){let el=this.context.gl;if(this._showOverdrawInspector){let eh=1/8;return new ki([el.CONSTANT_COLOR,el.ONE,el.CONSTANT_COLOR,el.ONE],new F.al(eh,eh,eh,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?ki.unblended:ki.alphaBlended}colorModeForDrapableLayerRenderPass(el){let eh=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&"translucent"===this.renderPass?new ki([eh.ONE,eh.ONE_MINUS_SRC_ALPHA,eh.CONSTANT_ALPHA,eh.ONE_MINUS_SRC_ALPHA],new F.al(0,0,0,void 0===el?0:el),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(F,el,eh,ec=!1){if(this.depthOcclusion)return new Bi(this.context.gl.GREATER,Bi.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!ec)return Bi.disabled;let ep=1-((1+this.currentLayer)*this.numSublayers+F)*this.depthEpsilon;return new Bi(eh||this.context.gl.LEQUAL,el,[ep,ep])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){let el=this.context.gl,eh=Math.ceil(this.width),ec=Math.ceil(this.height),ep=this.context.bindFramebuffer.get(),e_=el.getParameter(el.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===eh&&this.depthFBO.height===ec||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==eh&&0!==ec&&(this.depthFBO=new Rr(this.context,eh,ec,!1,"texture"),this.depthTexture=new F.T(this.context,{width:eh,height:ec,data:null},el.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(ep),el.bindTexture(el.TEXTURE_2D,e_),this.depthFBO&&(el.bindFramebuffer(el.READ_FRAMEBUFFER,null),el.bindFramebuffer(el.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),el.blitFramebuffer(0,0,eh,ec,0,0,eh,ec,el.DEPTH_BUFFER_BIT,el.NEAREST),el.bindFramebuffer(el.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((F,el)=>F+el/this._fpsHistory.length,0))}render(el,eh){let ec=F.q.now();this._dt=ec-this._timeStamp,this._timeStamp=ec,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=el.map.repaint,this.style=el,this.options=eh;let ep=this.style._mergedLayers,e_=!(!this.terrain||!this.terrain.enabled),n=()=>this.style._getOrder(e_).filter(F=>{let el=ep[F];return!(el.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[el.type]}),eg=n(),ey=!1,eb=!1;for(let F of eg){let el=ep[F];"circle"===el.type&&(ey=!0),"symbol"===el.type&&(el.hasInitialOcclusionOpacityProperties?eb=!0:ey=!0)}let ew=eg.map(F=>ep[F]),eT=this.style._mergedSourceCaches;this.imageManager=el.imageManager,this.modelManager=el.modelManager,this.symbolFadeChange=el.placement.symbolFadeChange(F.q.now()),this.imageManager.beginFrame();let eS=0,eE=!1;for(let F in eT){let el=eT[F];el.used&&(el.prepare(this.context),el.getSource().usedInConflation&&++eS)}let eM=!1;for(let F of ew)F.isHidden(this.transform.zoom)||("clip"===F.type&&(eM=!0),this.prepareLayer(F));let eI={},eA={},eC={},eP={},ez={};for(let F in eT){let el=eT[F];eI[F]=el.getVisibleCoordinates(),eA[F]=eI[F].slice().reverse(),eC[F]=el.getVisibleCoordinates(!0).reverse(),eP[F]=el.getShadowCasterCoordinates(),ez[F]=el.sortCoordinatesByDistance(eI[F])}let x=F=>{let el=this.style.getLayerSourceCache(F);return el&&el.used?el.getSource():null};if(eS||eM||this._clippingActiveLastFrame){let el=[],eh=[],ec=0;for(let F of ew)this.isSourceForClippingOrConflation(F,x(F))&&(el.push(F),eh.push(ec)),ec++;if(el&&(eM||el.length>1)||this._clippingActiveLastFrame){eM=!1;let ec=[];for(let ep=0;ep<el.length;ep++){let e_=el[ep],eg=eh[ep],ey=this.style.getLayerSourceCache(e_);if(!ey||!ey.used||!ey.getSource().usedInConflation&&"clip"!==e_.type)continue;let eb=F.dA,ew=F.by.None,eT=[],eS=!0;if("clip"===e_.type){for(let el of(eb=eg,e_.layout.get("clip-layer-types")))ew|="model"===el?F.by.Model:"symbol"===el?F.by.Symbol:F.by.FillExtrusion;for(let F of e_.layout.get("clip-layer-scope"))eT.push(F);e_.isHidden(this.transform.zoom)?eS=!1:eM=!0}eS&&ec.push({layer:e_.fqid,cache:ey,order:eb,clipMask:ew,clipScope:eT})}this.replacementSource.setSources(ec),eE=!0}}this._clippingActiveLastFrame=eM,eE||this.replacementSource.clear(),this.conflationActive=eE,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let F=0;F<ew.length;F++){let el=ew[F],eh=el.cutoffRange();if(this.longestCutoffRange=Math.max(eh,this.longestCutoffRange),eh>0){let F=x(el);F&&(this.minCutoffZoom=Math.max(F.minzoom,this.minCutoffZoom)),el.minzoom&&(this.minCutoffZoom=Math.max(el.minzoom,this.minCutoffZoom))}el.is3D(e_)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=F),this._lastOcclusionLayer=F)}let eD=this.style&&this.style.fog;eD?(this._fogVisible=0!==eD.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=eD.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(eC),this.opaquePassCutoff=0,ew=(eg=n()).map(F=>ep[F]));let eR=this._shadowRenderer;if(eR)for(let F in eR.updateShadowParameters(this.transform,this.style.directionalLight),eT)for(let el of eI[F]){let F={min:0,max:0};this.terrain&&(F=this.terrain.getMinMaxForTile(el)||F),eR.addShadowReceiver(el.toUnwrapped(),F.min,F.max)}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new F.dz(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new bn(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);let eL=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),eO=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(eL&&!this._snow&&(this._snow=new Kn(this)),!eL&&this._snow&&(this._snow.destroy(),delete this._snow),eO&&!this._rain&&(this._rain=new $n(this)),!eO&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!eB.has(this.context.gl))return;for(let F of(this.renderPass="offscreen",ew)){let eh=el.getLayerSourceCache(F);if(!F.hasOffscreenPass()||F.isHidden(this.transform.zoom))continue;let ec=eh?eA[eh.id]:void 0;("custom"===F.type||"raster"===F.type||"raster-particle"===F.type||F.isSky()||ec&&ec.length)&&this.renderLayer(this,eh,F,ec)}this.depthRangeFor3D=[0,1-(ew.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,eP)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let ek="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),eF=(()=>{if(eh.showOverdrawInspector)return F.al.black;let el=this.style.fog;if(el&&this.transform.projection.supportsFog){let eh=this.style.getLut(el.scope);if(!ek){let ec="none"===el.properties.get("color-use-theme"),ep=el.properties.get("color").toRenderColor(ec?null:eh).toArray01();return new F.al(...ep)}if(ek){let ec="none"===el.properties.get("space-color-use-theme"),ep=el.properties.get("space-color").toRenderColor(ec?null:eh).toArray01();return new F.al(...ep)}}return F.al.transparent})();if(this.context.clear({color:eF,depth:1}),this.clearStencil(),this._showOverdrawInspector=eh.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ek&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=eg.length-1;this.currentLayer>=0;this.currentLayer--){let F=ew[this.currentLayer],eh=el.getLayerSourceCache(F);if(F.isSky())continue;let ec=eh?(F.is3D(e_)?ez:eA)[eh.id]:void 0;this._renderTileClippingMasks(F,eh,ec),this.renderLayer(this,eh,F,ec)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ek&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||F.ag(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<eg.length;this.currentLayer++){let F=ew[this.currentLayer],eh=el.getLayerSourceCache(F);F.isSky()&&this.renderLayer(this,eh,F,eh?eA[eh.id]:void 0)}function I(F,el){let eh;return el&&(eh=("symbol"===F.type?eC:F.is3D(e_)?ez:eA)[el.id]),eh}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<eg.length;){let F=ew[this.currentLayer];if("raster"===F.type||"raster-particle"===F.type){let eh=el.getLayerSourceCache(F);this.renderLayer(this,eh,F,I(F,eh))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let eN=0;eR&&(eN=eR.getShadowCastingLayerCount());let eV=!1,eU=-1;for(let F=0;F<eg.length;++F){let el=ew[F];el.isHidden(this.transform.zoom)||el.is3D(e_)&&(eU=F)}eb&&-1===eU&&(ey=!0);let ej=!1;for(;this.currentLayer<eg.length;){let F=ew[this.currentLayer],eh=el.getLayerSourceCache(F);if(F.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(F)){if(F.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!ej&&F.is3D(e_)&&!e_){let F=this.currentLayer,t=F=>{for(this.currentLayer=0;this.currentLayer<ew.length;this.currentLayer++){let el=ew[this.currentLayer];if(ip[el.type]){let eh=this.style.getLayerSourceCache(el);ip[el.type](this,eh,el,I(el,eh),F)}}};t("initialize"),t("reset"),this.currentLayer=F,ej=!0}if(ey&&!eV&&this.terrain&&!this.transform.isOrthographic&&(eV=!0,this.blitDepth()),eb&&-1!==eU&&this.currentLayer===eU+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(F,eh,eh?eI[eh.id]:void 0),this.renderLayer(this,eh,F,I(F,eh)),!this.terrain&&eR&&eN>0&&F.hasShadowPass()&&0==--eN&&(eR.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){let F=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=F;this.currentLayer++){let F=ew[this.currentLayer];if(!F.hasLightBeamPass())continue;let eh=el.getLayerSourceCache(F);this.renderLayer(this,eh,F,eh?eA[eh.id]:void 0)}this.currentLayer=F,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){let F=this.currentLayer;for(let F of(this.depthOcclusion=!0,this.layersWithOcclusionOpacity)){this.currentLayer=F;let eh=ew[this.currentLayer],ec=el.getLayerSourceCache(eh),ep=ec?eA[ec.id]:void 0;this.terrain||this._renderTileClippingMasks(eh,ec,ec?eI[ec.id]:void 0),this.renderLayer(this,ec,eh,ep)}this.depthOcclusion=!1,this.currentLayer=F,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let eh=null;ew.forEach(F=>{let ec=el.getLayerSourceCache(F);ec&&!F.isHidden(this.transform.zoom)&&ec.getVisibleCoordinates().length&&(!eh||eh.getSource().maxzoom<ec.getSource().maxzoom)&&(eh=ec)}),eh&&this.options.showTileBoundaries&&ic.debug(this,eh,eh.getVisibleCoordinates(),F.al.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&ic.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new F.al(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(F){var el,eh;let ec=F.transform.padding;cn(F,F.transform.height-(ec.top||0),3,tK),cn(F,ec.bottom||0,3,tJ),hn(F,ec.left||0,3,tQ),hn(F,F.transform.width-(ec.right||0),3,t0);let ep=F.transform.centerPoint;el=ep.x,eh=F.transform.height-ep.y,dn(F,el-1,eh-10,2,20,t1),dn(F,el-10,eh-1,20,2,t1)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),eE||(this.conflationActive=!1)}prepareLayer(F){this.gpuTimingStart(F);let{unsupportedLayers:el}=this.transform.projection,eh=!el||!el.includes(F.type);if(id[F.type]&&(eh||this.terrain&&"custom"===F.type)){let el=this.style.getLayerSourceCache(F);id[F.type](F,el,this)}this.gpuTimingEnd()}renderLayer(F,el,eh,ec){eh.isHidden(this.transform.zoom)||("background"===eh.type||"sky"===eh.type||"custom"===eh.type||"model"===eh.type||"raster"===eh.type||"raster-particle"===eh.type||ec&&ec.length)&&(this.id=eh.id,this.gpuTimingStart(eh),F.transform.projection.unsupportedLayers&&F.transform.projection.unsupportedLayers.includes(eh.type)&&(!F.terrain||"custom"!==eh.type)||"clip"===eh.type||ic[eh.type](F,el,eh,ec,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(F){if(!this.options.gpuTiming)return;let el=this.context.extTimerQuery,eh=this.context.gl,ec=this.gpuTimers[F.id];ec||(ec=this.gpuTimers[F.id]={calls:0,cpuTime:0,query:eh.createQuery()}),ec.calls++,eh.beginQuery(el.TIME_ELAPSED_EXT,ec.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){let F=this.context.extTimerQuery,el=this.context.gl,eh=el.createQuery();this.deferredRenderGpuTimeQueries.push(eh),el.beginQuery(F.TIME_ELAPSED_EXT,eh)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){let F=this.gpuTimers;return this.gpuTimers={},F}collectDeferredRenderGpuQueries(){let F=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],F}queryGpuTimers(F){let el={};for(let eh in F){let ec=F[eh],ep=this.context.extTimerQuery,e_=ep.getQueryParameter(ec.query,this.context.gl.QUERY_RESULT)/1e6;ep.deleteQueryEXT(ec.query),el[eh]=e_}return el}queryGpuTimeDeferredRender(F){if(!this.options.gpuTimingDeferredRender)return 0;let el=this.context.gl,eh=0;for(let ec of F)eh+=el.getQueryParameter(ec,el.QUERY_RESULT)/1e6,el.deleteQuery(ec);return eh}translatePosMatrix(el,eh,ec,ep,e_){if(!ec[0]&&!ec[1])return el;let eg=e_?"map"===ep?this.transform.angle:0:"viewport"===ep?-this.transform.angle:0;if(eg){let F=Math.sin(eg),el=Math.cos(eg);ec=[ec[0]*el-ec[1]*F,ec[0]*F+ec[1]*el]}let ey=[e_?ec[0]:F.at(eh,ec[0],this.transform.zoom),e_?ec[1]:F.at(eh,ec[1],this.transform.zoom),0],eb=new Float32Array(16);return F.ad.mat4.translate(eb,el,ey),eb}saveTileTexture(F){let el=F.size[0],eh=this._tileTextures[el];eh?eh.push(F):this._tileTextures[el]=[F]}getTileTexture(F){let el=this._tileTextures[F];return el&&el.length>0?el.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(F,el,eh){let ec=void 0===eh?this.terrain&&this.terrain.renderingToTexture:eh,ep=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===F||"terrainRaster"===F?(ep.push("LIGHTING_3D_MODE"),ep.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):ec||ep.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||ep.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(ep.push("TERRAIN"),this.linearFloatFilteringSupported()&&ep.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&ep.push("GLOBE"),this._fogVisible&&!ec&&(void 0===el||el)&&ep.push("FOG","FOG_DITHERING"),ec&&ep.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&ep.push("OVERDRAW_INSPECTOR"),ep}getOrCreateProgram(F,el){this.cache=this.cache||{};let eh=el&&el.defines||[],ec=el&&el.config,ep=this.currentGlobalDefines(F,el&&el.overrideFog,el&&el.overrideRtt).concat(eh),e_=Ws.cacheKey(tR[F],F,ep,ec);return this.cache[e_]||(this.cache[e_]=new Ws(this.context,F,tR[F],ec,tq[F],ep)),this.cache[e_]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){let F=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(F.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new F.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(el,eh){if(this.style.enable3dLights()){let ec=this.style.directionalLight,ep=this.style.ambientLight;if(ec&&ep){let e_=((el,eh,ec)=>{let ep=el.properties.get("direction"),e_="none"===el.properties.get("color-use-theme"),eg=el.properties.get("color").toRenderColor(e_?null:ec.getLut(el.scope)).toArray01(),ey=el.properties.get("intensity"),eb="none"===eh.properties.get("color-use-theme"),ew=eh.properties.get("color").toRenderColor(eb?null:ec.getLut(eh.scope)).toArray01(),eT=eh.properties.get("intensity"),eS=[ep.x,ep.y,ep.z],eE=F.cN(ew,eT),eM=F.cN(eg,ey);return{u_lighting_ambient_color:eE,u_lighting_directional_dir:eS,u_lighting_directional_color:eM,u_ground_radiance:function(el,eh,ec){let ep=function(el,eh,ec){var ep,e_,eg;let ey=F.ad.vec3.dot(eh,el),eb=F.ad.vec3.dot(ec,[.2126,.7152,.0722]),ew=(ep=1-.3*Math.min(eb,1),(1-(e_=Math.min(ey+1,1)))*ep+1*e_);return((1-(eg=Math.asin(F.ay(eh[2],-1,1))/Math.PI+.5))*.92+1*eg)*ew}(el,[0,0,1],eh),e_=[0,0,0];F.ad.vec3.scale(e_,ec.slice(0,3),ep);let eg=[0,0,0];F.ad.vec3.scale(eg,eh.slice(0,3),el[2]);let ey=[0,0,0];return F.ad.vec3.add(ey,e_,eg),F.cg(ey)}(eS,eM,eE)}})(ec,ep,this.style);eh.setLightsUniformValues(el,e_)}}}uploadCommonUniforms(el,eh,ec,ep,e_){if(this.uploadCommonLightUniforms(el,eh),this.terrain&&this.terrain.renderingToTexture)return;let eg=this.style.fog;if(eg){let e_=eg.getOpacity(this.transform.pitch),ey=((el,eh,ec,ep,e_,eg,ey,eb,ew,eT,eS,eE)=>{let eM=el.transform,eI="none"===eh.properties.get("color-use-theme"),eA=eh.properties.get("color").toRenderColor(eI?null:el.style.getLut(eh.scope)).toArray01();eA[3]=ep;let eC=el.frameCounter/1e3%1,[eP,ez]=eh.properties.get("vertical-range");return{u_fog_matrix:ec?eM.calculateFogTileMatrix(ec):eE||el.identityMat,u_fog_range:eh.getFovAdjustedRange(eM._fov),u_fog_color:eA,u_fog_horizon_blend:eh.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(eP,ez),ez],u_fog_temporal_offset:eC,u_frustum_tl:e_,u_frustum_tr:eg,u_frustum_br:ey,u_frustum_bl:eb,u_globe_pos:ew,u_globe_radius:eT,u_viewport:eS,u_globe_transition:F.ag(eM.zoom),u_is_globe:+("globe"===eM.projection.name)}})(this,eg,ec,e_,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*F.q.devicePixelRatio,this.transform.height*F.q.devicePixelRatio],ep);eh.setFogUniformValues(el,ey)}e_&&eh.setCutoffUniformValues(el,e_.uniformValues)}setTileLoadedFlag(F){this.tileLoaded=F}saveCanvasCopy(){let F=this.canvasCopy();F&&(this.frameCopies.push(F),this.tileLoaded=!1)}canvasCopy(){let F=this.context.gl,el=F.createTexture();return F.bindTexture(F.TEXTURE_2D,el),F.copyTexImage2D(F.TEXTURE_2D,0,F.RGBA,0,0,F.drawingBufferWidth,F.drawingBufferHeight,0),el}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;let F=this.style&&this.style.fog;return!!F&&0!==F.getOpacity(this.transform.pitch)}getBackgroundTiles(){let F=this._backgroundTiles,el=this._backgroundTiles={},eh=this.transform.coveringTiles({tileSize:512});for(let ec of eh)el[ec.key]=F[ec.key]||new bt(ec,512,this.transform.tileZoom,this);return el}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(F,el){return!(!F.is3D(!(!this.terrain||!this.terrain.enabled))||"clip"!==F.type&&(F.minzoom&&F.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==F.sourceLayer)&&(!el||"batched-model"!==el.type)))}isTileAffectedByFog(F){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let el=this._cachedTileFogOpacities[F.key];return el||(this._cachedTileFogOpacities[F.key]=el=this.style.fog.getOpacityForTile(F)),el[0]>=.05||el[1]>=.05}setupDepthForOcclusion(F,el,eh){var ec;let ep=this.context,e_=ep.gl,eg=!!eh;eh||(eh={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-.0001,u_exaggeration:0}),ep.activeTexture.set(e_.TEXTURE3),F&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(e_.NEAREST,e_.CLAMP_TO_EDGE),eh.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],eh.u_depth_range_unpack=[2/((ec=this.depthRangeFor3D)[1]-ec[0]),-1-2*ec[0]/(ec[1]-ec[0])],eh.u_occluder_half_size=.5*this.occlusionParams.occluderSize,eh.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(e_.NEAREST,e_.CLAMP_TO_EDGE),ep.activeTexture.set(e_.TEXTURE0),eg||el.setTerrainUniformValues(ep,eh)}};function ta(F,el){let eh=!1,ec=null,s=()=>{ec=null,eh&&(F(),ec=setTimeout(s,el),eh=!1)};return()=>(eh=!0,ec||s(),ec)}let ia=class ia{constructor(el){this._hashName=el&&encodeURIComponent(el),F.aQ(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=ta(this._updateHashUnthrottled.bind(this),300)}addTo(F){return this._map=F,window.addEventListener("hashchange",this._onHashChange,!1),F.on("moveend",this._updateHash),this}remove(){return this._map&&(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0),this}getHashString(){let F=this._map;if(!F)return"";let el=oa(F);if(this._hashName){let F=this._hashName,eh=!1,ec=location.hash.slice(1).split("&").map(ec=>{let ep=ec.split("=")[0];return ep===F?(eh=!0,`${ep}=${el}`):ec}).filter(F=>F);return eh||ec.push(`${F}=${el}`),`#${ec.join("&")}`}return`#${el}`}_getCurrentHash(){let F=location.hash.replace("#","");if(this._hashName){let el;return F.split("&").map(F=>F.split("=")).forEach(F=>{F[0]===this._hashName&&(el=F)}),(el&&el[1]||"").split("/")}return F.split("/")}_onHashChange(){let F=this._map;if(!F)return!1;let el=this._getCurrentHash();if(el.length>=3&&!el.some(F=>isNaN(F))){let eh=F.dragRotate.isEnabled()&&F.touchZoomRotate.isEnabled()?+(el[3]||0):F.getBearing();return F.jumpTo({center:[+el[2],+el[1]],zoom:+el[0],bearing:eh,pitch:+(el[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}};function oa(F,el){let eh=F.getCenter(),ec=Math.round(100*F.getZoom())/100,ep=Math.ceil((ec*Math.LN2+Math.log(512/360/.5))/Math.LN10),e_=Math.pow(10,ep),eg=Math.round(eh.lng*e_)/e_,ey=Math.round(eh.lat*e_)/e_,eb=F.getBearing(),ew=F.getPitch(),eT=el?`/${eg}/${ey}/${ec}`:`${ec}/${ey}/${eg}`;return(eb||ew)&&(eT+="/"+Math.round(10*eb)/10),ew&&(eT+=`/${Math.round(ew)}`),eT}let im={linearity:.3,easing:F.dB(0,0,.3,1)},i_=F.l({deceleration:2500,maxSpeed:1400},im),ig=F.l({deceleration:20,maxSpeed:1400},im),iv=F.l({deceleration:1e3,maxSpeed:360},im),ib=F.l({deceleration:1e3,maxSpeed:90},im);let ca=class ca{constructor(F){this._map=F,this.clear()}clear(){this._inertiaBuffer=[]}record(el){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:F.q.now(),settings:el})}_drainInertiaBuffer(){let el=this._inertiaBuffer,eh=F.q.now();for(;el.length>0&&eh-el[0].time>160;)el.shift()}_onMoveEnd(el){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;let eh={zoom:0,bearing:0,pitch:0,pan:new F.P(0,0),pinchAround:void 0,around:void 0};for(let{settings:F}of this._inertiaBuffer)eh.zoom+=F.zoomDelta||0,eh.bearing+=F.bearingDelta||0,eh.pitch+=F.pitchDelta||0,F.panDelta&&eh.pan._add(F.panDelta),F.around&&(eh.around=F.around),F.pinchAround&&(eh.pinchAround=F.pinchAround);let ec=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,ep={};if(eh.pan.mag()){let e_=da(eh.pan.mag(),ec,F.l({},i_,el||{}));ep.offset=eh.pan.mult(e_.amount/eh.pan.mag()),ep.center=this._map.transform.center,ha(ep,e_)}if(eh.zoom){let F=da(eh.zoom,ec,ig);ep.zoom=this._map.transform.zoom+F.amount,ha(ep,F)}if(eh.bearing){let el=da(eh.bearing,ec,iv);ep.bearing=this._map.transform.bearing+F.ay(el.amount,-179,179),ha(ep,el)}if(eh.pitch){let F=da(eh.pitch,ec,ib);ep.pitch=this._map.transform.pitch+F.amount,ha(ep,F)}if(ep.zoom||ep.bearing){let F=void 0===eh.pinchAround?eh.around:eh.pinchAround;ep.around=F?this._map.unproject(F):this._map.getCenter()}return this.clear(),ep.noMoveStart=!0,ep}};function ha(F,el){(!F.duration||F.duration<el.duration)&&(F.duration=el.duration,F.easing=el.easing)}function da(el,eh,ec){let{maxSpeed:ep,linearity:e_,deceleration:eg}=ec,ey=F.ay(el*e_/(eh/1e3),-ep,ep),eb=Math.abs(ey)/(eg*e_);return{easing:ec.easing,duration:1e3*eb,amount:ey*(eb/2)}}let ua=class ua extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(el,eh,ec,ep={}){let e_=g(eh.getCanvasContainer(),ec),eg=eh.unproject(e_);super(el,F.l({point:e_,lngLat:eg,originalEvent:ec},ep)),this._defaultPrevented=!1,this.target=eh}};let _a=class _a extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(el,eh,ec){let ep="touchend"===el?ec.changedTouches:ec.touches,e_=v(eh.getCanvasContainer(),ep),eg=e_.map(F=>eh.unproject(F)),ey=e_.reduce((F,el,eh,ec)=>F.add(el.div(ec.length)),new F.P(0,0));super(el,{points:e_,point:ey,lngLats:eg,lngLat:eh.unproject(ey),originalEvent:ec}),this._defaultPrevented=!1}};let pa=class pa extends F.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(F,el){super("wheel",{originalEvent:el}),this._defaultPrevented=!1}};let fa=class fa{constructor(F,el){this._map=F,this._clickTolerance=el.clickTolerance}reset(){this._mousedownPos=void 0}wheel(F){return this._firePreventable(new pa(this._map,F))}mousedown(F,el){return this._mousedownPos=el,this._firePreventable(new ua(F.type,this._map,F))}mouseup(F){this._map.fire(new ua(F.type,this._map,F))}preclick(el){let eh=F.l({},el);eh.type="preclick",this._map.fire(new ua(eh.type,this._map,eh))}click(F,el){this._mousedownPos&&this._mousedownPos.dist(el)>=this._clickTolerance||(this.preclick(F),this._map.fire(new ua(F.type,this._map,F)))}dblclick(F){return this._firePreventable(new ua(F.type,this._map,F))}mouseover(F){this._map.fire(new ua(F.type,this._map,F))}mouseout(F){this._map.fire(new ua(F.type,this._map,F))}touchstart(F){return this._firePreventable(new _a(F.type,this._map,F))}touchmove(F){this._map.fire(new _a(F.type,this._map,F))}touchend(F){this._map.fire(new _a(F.type,this._map,F))}touchcancel(F){this._map.fire(new _a(F.type,this._map,F))}_firePreventable(F){if(this._map.fire(F),F.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}};let ma=class ma{constructor(F){this._map=F}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(F){this._map.fire(new ua(F.type,this._map,F))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ua("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(F){this._delayContextMenu?this._contextMenuEvent=F:this._map.fire(new ua(F.type,this._map,F)),this._map.listens("contextmenu")&&F.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}};let ga=class ga{constructor(F,el){this._map=F,this._el=F.getCanvasContainer(),this._container=F.getContainer(),this._clickTolerance=el.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(F,el){this.isEnabled()&&F.shiftKey&&0===F.button&&(_(),this._startPos=this._lastPos=el,this._active=!0)}mousemoveWindow(F,el){if(!this._active)return;let eh=this._startPos,ec=this._lastPos;if(!eh||!ec||ec.equals(el)||!this._box&&el.dist(eh)<this._clickTolerance)return;this._lastPos=el,this._box||(this._box=l("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",F));let ep=Math.min(eh.x,el.x),e_=Math.max(eh.x,el.x),eg=Math.min(eh.y,el.y),ey=Math.max(eh.y,el.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${ep}px,${eg}px)`,this._box.style.width=e_-ep+"px",this._box.style.height=ey-eg+"px")})}mouseupWindow(el,eh){if(!this._active)return;let ec=this._startPos;if(ec&&0===el.button){if(this.reset(),m(),ec.x!==eh.x||ec.y!==eh.y)return this._map.fire(new F.A("boxzoomend",{originalEvent:el})),{cameraAnimation:F=>F.fitScreenCoordinates(ec,eh,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",el)}}keydown(F){this._active&&27===F.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",F))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),p(),delete this._startPos,delete this._lastPos}_fireEvent(el,eh){return this._map.fire(new F.A(el,{originalEvent:eh}))}};function va(F,el){let eh={};for(let ec=0;ec<F.length;ec++)eh[F[ec].identifier]=el[ec];return eh}let ya=class ya{constructor(F){this.reset(),this.numTouches=F.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(el,eh,ec){(this.centroid||ec.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=el.timeStamp),ec.length===this.numTouches&&(this.centroid=function(el){let eh=new F.P(0,0);for(let F of el)eh._add(F);return eh.div(el.length)}(eh),this.touches=va(ec,eh)))}touchmove(F,el,eh){if(this.aborted||!this.centroid)return;let ec=va(eh,el);for(let F in this.touches){let el=ec[F];(!el||el.dist(this.touches[F])>30)&&(this.aborted=!0)}}touchend(F,el,eh){if((!this.centroid||F.timeStamp-this.startTime>500)&&(this.aborted=!0),0===eh.length){let F=!this.aborted&&this.centroid;if(this.reset(),F)return F}}};let xa=class xa{constructor(F){this.singleTap=new ya(F),this.numTaps=F.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(F,el,eh){this.singleTap.touchstart(F,el,eh)}touchmove(F,el,eh){this.singleTap.touchmove(F,el,eh)}touchend(F,el,eh){let ec=this.singleTap.touchend(F,el,eh);if(ec){let el=F.timeStamp-this.lastTime<500,eh=!this.lastTap||30>this.lastTap.dist(ec);if(el&&eh||this.reset(),this.count++,this.lastTime=F.timeStamp,this.lastTap=ec,this.count===this.numTaps)return this.reset(),ec}}};let ba=class ba{constructor(){this._zoomIn=new xa({numTouches:1,numTaps:2}),this._zoomOut=new xa({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(F,el,eh){this._zoomIn.touchstart(F,el,eh),this._zoomOut.touchstart(F,el,eh)}touchmove(F,el,eh){this._zoomIn.touchmove(F,el,eh),this._zoomOut.touchmove(F,el,eh)}touchend(F,el,eh){let ec=this._zoomIn.touchend(F,el,eh),ep=this._zoomOut.touchend(F,el,eh);return ec?(this._active=!0,F.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:el=>el.easeTo({duration:300,zoom:el.getZoom()+1,around:el.unproject(ec)},{originalEvent:F})}):ep?(this._active=!0,F.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:el=>el.easeTo({duration:300,zoom:el.getZoom()-1,around:el.unproject(ep)},{originalEvent:F})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let iw={0:1,2:2},iT={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};let Ea=class Ea{constructor(F){this.reset(),this._clickTolerance=F.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(F,el){return!1}_move(F,el){return{}}mousedown(F,el){if(this._lastPoint)return;let eh=y(F);this._correctButton(F,eh)&&(this._lastPoint=el,this._eventButton=eh)}mousemoveWindow(F,el){let eh=this._lastPoint;if(eh){if(F.preventDefault(),null!=this._eventButton&&function(F,el){let eh=iw[el];return void 0===F.buttons||(F.buttons&eh)!==eh}(F,this._eventButton))this.reset();else if(this._moved||!(el.dist(eh)<this._clickTolerance))return this._moved=!0,this._lastPoint=el,this._move(eh,el)}}mouseupWindow(F){this._lastPoint&&y(F)===this._eventButton&&(this._moved&&m(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let Sa=class Sa extends Ea{mousedown(F,el){super.mousedown(F,el),this._lastPoint&&(this._active=!0)}_correctButton(F,el){return 0===el&&!F.ctrlKey}_move(F,el){return{around:el,panDelta:el.sub(F)}}};let Ca=class Ca extends Ea{constructor(F){super(F),this._pitchRotateKey=F.pitchRotateKey?iT[F.pitchRotateKey]:void 0}_correctButton(F,el){return this._pitchRotateKey?0===el&&F[this._pitchRotateKey]:0===el&&F.ctrlKey||2===el}_move(F,el){let eh=.8*(el.x-F.x);if(eh)return this._active=!0,{bearingDelta:eh}}contextmenu(F){this._pitchRotateKey||F.preventDefault()}};let Ia=class Ia extends Ea{constructor(F){super(F),this._pitchRotateKey=F.pitchRotateKey?iT[F.pitchRotateKey]:void 0}_correctButton(F,el){return this._pitchRotateKey?0===el&&F[this._pitchRotateKey]:0===el&&F.ctrlKey||2===el}_move(F,el){let eh=-.5*(el.y-F.y);if(eh)return this._active=!0,{pitchDelta:eh}}contextmenu(F){this._pitchRotateKey||F.preventDefault()}};let Ra=class Ra{constructor(el,eh){this._map=el,this._el=el.getCanvasContainer(),this._minTouches=1,this._clickTolerance=eh.clickTolerance||1,this.reset(),F.aQ(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new F.P(0,0)}touchstart(F,el,eh){return this._calculateTransform(F,el,eh)}touchmove(el,eh,ec){if(this._active&&!(ec.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===ec.length&&!F.dC())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return el.cancelable&&el.preventDefault(),this._calculateTransform(el,eh,ec)}}touchend(F,el,eh){this._calculateTransform(F,el,eh),this._active&&eh.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(el,eh,ec){ec.length>0&&(this._active=!0);let ep=va(ec,eh),e_=new F.P(0,0),eg=new F.P(0,0),ey=0;for(let F in ep){let el=ep[F],eh=this._touches[F];eh&&(e_._add(el),eg._add(el.sub(eh)),ey++,ep[F]=el)}if(this._touches=ep,ey<this._minTouches||!eg.mag())return;let eb=eg.div(ey);return this._sum._add(eb),this._sum.mag()<this._clickTolerance?void 0:{around:e_.div(ey),panDelta:eb}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}};let Da=class Da{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(F){}_move(F,el,eh){return{}}touchstart(F,el,eh){this._firstTwoTouches||eh.length<2||(this._firstTwoTouches=[eh[0].identifier,eh[1].identifier],this._start([el[0],el[1]]))}touchmove(F,el,eh){let ec=this._firstTwoTouches;if(!ec)return;F.preventDefault();let[ep,e_]=ec,eg=Aa(eh,el,ep),ey=Aa(eh,el,e_);if(!eg||!ey)return;let eb=this._aroundCenter?null:eg.add(ey).div(2);return this._move([eg,ey],eb,F)}touchend(F,el,eh){if(!this._firstTwoTouches)return;let[ec,ep]=this._firstTwoTouches,e_=Aa(eh,el,ec),eg=Aa(eh,el,ep);e_&&eg||(this._active&&m(),this.reset())}touchcancel(){this.reset()}enable(F){this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};function Aa(F,el,eh){for(let ec=0;ec<F.length;ec++)if(F[ec].identifier===eh)return el[ec]}function La(F,el){return Math.log(F/el)/Math.LN2}let Ma=class Ma extends Da{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(F){this._startDistance=this._distance=F[0].dist(F[1])}_move(F,el){let eh=this._distance;if(this._distance=F[0].dist(F[1]),this._active||!(.1>Math.abs(La(this._distance,this._startDistance))))return this._active=!0,{zoomDelta:La(this._distance,eh),pinchAround:el}}};function Pa(F,el){return 180*F.angleWith(el)/Math.PI}let za=class za extends Da{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(F){this._startVector=this._vector=F[0].sub(F[1]),this._minDiameter=F[0].dist(F[1])}_move(F,el){let eh=this._vector;if(this._vector=F[0].sub(F[1]),eh&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:Pa(this._vector,eh),pinchAround:el}}_isBelowThreshold(F){this._minDiameter=Math.min(this._minDiameter,F.mag());let el=25/(Math.PI*this._minDiameter)*360,eh=this._startVector;if(!eh)return!1;let ec=Pa(F,eh);return Math.abs(ec)<el}};function Oa(F){return Math.abs(F.y)>Math.abs(F.x)}let Fa=class Fa extends Da{constructor(F){super(),this._map=F}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(F){this._lastPoints=F,Oa(F[0].sub(F[1]))&&(this._valid=!1)}_move(el,eh,ec){let ep=this._lastPoints;if(!ep)return;let e_=el[0].sub(ep[0]),eg=el[1].sub(ep[1]);return this._map._cooperativeGestures&&!F.dC()&&ec.touches.length<3||(this._valid=this.gestureBeginsVertically(e_,eg,ec.timeStamp),!this._valid)?void 0:(this._lastPoints=el,this._active=!0,{pitchDelta:-((e_.y+eg.y)/2*.5)})}gestureBeginsVertically(F,el,eh){if(void 0!==this._valid)return this._valid;let ec=F.mag()>=2,ep=el.mag()>=2;if(!ec&&!ep)return;if(!ec||!ep)return null==this._firstMove&&(this._firstMove=eh),eh-this._firstMove<100&&void 0;let e_=F.y>0==el.y>0;return Oa(F)&&Oa(el)&&e_}};let Ba=class Ba{constructor(){this._panStep=100,this._bearingStep=15,this._pitchStep=10,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(F){if(F.altKey||F.ctrlKey||F.metaKey)return;let el=0,eh=0,ec=0,ep=0,e_=0;switch(F.keyCode){case 61:case 107:case 171:case 187:el=1;break;case 189:case 109:case 173:el=-1;break;case 37:F.shiftKey?eh=-1:(F.preventDefault(),ep=-1);break;case 39:F.shiftKey?eh=1:(F.preventDefault(),ep=1);break;case 38:F.shiftKey?ec=1:(F.preventDefault(),e_=-1);break;case 40:F.shiftKey?ec=-1:(F.preventDefault(),e_=1);break;default:return}return this._rotationDisabled&&(eh=0,ec=0),{cameraAnimation:eg=>{let ey=eg.getZoom();eg.easeTo({duration:300,easeId:"keyboardHandler",easing:Na,zoom:el?Math.round(ey)+el*(F.shiftKey?2:1):ey,bearing:eg.getBearing()+eh*this._bearingStep,pitch:eg.getPitch()+ec*this._pitchStep,offset:[-ep*this._panStep,-e_*this._panStep],center:eg.getCenter()},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}};function Na(F){return F*(2-F)}let iS=1/450;let Ga=class Ga{constructor(el,eh){this._map=el,this._el=el.getCanvasContainer(),this._handler=eh,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=iS,F.aQ(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(F){this._defaultZoomRate=F}setWheelZoomRate(F){this._wheelZoomRate=F}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(F){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!F&&"center"===F.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(el){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(el.ctrlKey||el.metaKey||this.isZooming()||F.dC()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let eh=el.deltaMode===WheelEvent.DOM_DELTA_LINE?40*el.deltaY:el.deltaY,ec=F.q.now(),ep=ec-(this._lastWheelEventTime||0);this._lastWheelEventTime=ec,0!==eh&&eh%4.000244140625==0?this._type="wheel":0!==eh&&4>Math.abs(eh)?this._type="trackpad":ep>400?(this._type=null,this._lastValue=eh,this._timeout=window.setTimeout(this._onTimeout,40,el)):this._type||(this._type=200>Math.abs(ep*eh)?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,eh+=this._lastValue)),el.shiftKey&&eh&&(eh/=4),this._type&&(this._lastWheelEvent=el,this._delta-=eh,this._active||this._start(el)),el.preventDefault()}_onTimeout(F){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(F)}_start(F){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);let el=g(this._el,F);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:el,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;let el=this._map.transform;"wheel"===this._type&&el.projection.wrap&&(el._center.lng>=180||el._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);let i=()=>el._terrainEnabled()&&this._aroundCoord?el.computeZoomRelativeTo(this._aroundCoord):el.zoom;if(0!==this._delta){let F="wheel"===this._type&&Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate,eh=2/(1+Math.exp(-Math.abs(this._delta*F)));this._delta<0&&0!==eh&&(eh=1/eh);let ec=i(),ep=Math.pow(2,ec),e_="number"==typeof this._targetZoom?el.zoomScale(this._targetZoom):ep;this._targetZoom=Math.min(el.maxZoom,Math.max(el.minZoom,el.scaleZoom(e_*eh))),"wheel"===this._type&&(this._startZoom=ec,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}let eh="number"==typeof this._targetZoom?this._targetZoom:i(),ec=this._startZoom,ep=this._easing,e_,eg=!1;if("wheel"===this._type&&ec&&ep){let el=Math.min((F.q.now()-this._lastWheelEventTime)/200,1),ey=ep(el);e_=F.ah(ec,eh,ey),el<1?this._frameId||(this._frameId=!0):eg=!0}else e_=eh,eg=!0;this._active=!0,eg&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let ey=e_-i();return ey*this._lastDelta<0&&(ey=0),{noInertia:!0,needsRenderFrame:!eg,zoomDelta:ey,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(el){let eh=F.dD;if(this._prevEase){let el=this._prevEase,ec=(F.q.now()-el.start)/el.duration,ep=el.easing(ec+.01)-el.easing(ec),e_=.27/Math.sqrt(ep*ep+1e-4)*.01,eg=Math.sqrt(.0729-e_*e_);eh=F.dB(e_,eg,.25,1)}return this._prevEase={start:F.q.now(),duration:el,easing:eh},eh}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=l("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}};let ja=class ja{constructor(F,el){this._clickZoom=F,this._tapZoom=el}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}};let qa=class qa{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(F,el){return F.preventDefault(),{cameraAnimation:eh=>{eh.easeTo({duration:300,zoom:eh.getZoom()+(F.shiftKey?-1:1),around:eh.unproject(el)},{originalEvent:F})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let Ha=class Ha{constructor(){this._tap=new xa({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(F,el,eh){this._swipePoint||(this._tapTime&&F.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?eh.length>0&&(this._swipePoint=el[0],this._swipeTouch=eh[0].identifier):this._tap.touchstart(F,el,eh))}touchmove(F,el,eh){if(this._tapTime){if(this._swipePoint){if(eh[0].identifier!==this._swipeTouch)return;let ec=el[0],ep=ec.y-this._swipePoint.y;return this._swipePoint=ec,F.preventDefault(),this._active=!0,{zoomDelta:ep/128}}}else this._tap.touchmove(F,el,eh)}touchend(F,el,eh){this._tapTime?this._swipePoint&&0===eh.length&&this.reset():this._tap.touchend(F,el,eh)&&(this._tapTime=F.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}};let Za=class Za{constructor(F,el,eh){this._el=F,this._mousePan=el,this._touchPan=eh}enable(F){this._inertiaOptions=F||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}};let Wa=class Wa{constructor(F,el,eh){this._pitchWithRotate=F.pitchWithRotate,this._mouseRotate=el,this._mousePitch=eh}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}};let $a=class $a{constructor(F,el,eh,ec){this._el=F,this._touchZoom=el,this._touchRotate=eh,this._tapDragZoom=ec,this._rotationDisabled=!1,this._enabled=!0}enable(F){this._touchZoom.enable(F),this._rotationDisabled||this._touchRotate.enable(F),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}};let Xa=F=>F.zoom||F.drag||F.pitch||F.rotate;let Ka=class Ka extends F.A{};let Ya=class Ya{constructor(){this.constants=[1,1,.01],this.radius=0}setup(el,eh){let ec=F.ad.vec3.sub([],eh,el);this.radius=F.ad.vec3.length(ec[2]<0?F.ad.vec3.div([],ec,this.constants):[ec[0],ec[1],0])}projectRay(el){F.ad.vec3.div(el,el,this.constants),F.ad.vec3.normalize(el,el),F.ad.vec3.mul(el,el,this.constants);let eh=F.ad.vec3.scale([],el,this.radius);if(eh[2]>0){let el=F.ad.vec3.scale([],[0,0,1],F.ad.vec3.dot(eh,[0,0,1])),ec=F.ad.vec3.scale([],F.ad.vec3.normalize([],[eh[0],eh[1],0]),this.radius),ep=F.ad.vec3.add([],eh,F.ad.vec3.scale([],F.ad.vec3.sub([],F.ad.vec3.add([],ec,el),eh),2));eh[0]=ep[0],eh[1]=ep[1]}return eh}};function Ja(F){return F.panDelta&&F.panDelta.mag()||F.zoomDelta||F.bearingDelta||F.pitchDelta}let Qa=class Qa{constructor(el,eh){this._map=el,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ca(el),this._bearingSnap=eh.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new Ya,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(eh),F.aQ(["handleEvent","handleWindowEvent"],this);let ec=this._el;for(let[F,el,eh]of(this._listeners=[[ec,"touchstart",{passive:!0}],[ec,"touchmove",{passive:!1}],[ec,"touchend",void 0],[ec,"touchcancel",void 0],[ec,"mousedown",void 0],[ec,"mousemove",void 0],[ec,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[ec,"mouseover",void 0],[ec,"mouseout",void 0],[ec,"dblclick",void 0],[ec,"click",void 0],[ec,"keydown",{capture:!1}],[ec,"keyup",void 0],[ec,"wheel",{passive:!1}],[ec,"contextmenu",void 0],[window,"blur",void 0]],this._listeners)){let ec=F===document?this.handleWindowEvent:this.handleEvent;F.addEventListener(el,ec,eh)}}destroy(){for(let[F,el,eh]of this._listeners){let ec=F===document?this.handleWindowEvent:this.handleEvent;F.removeEventListener(el,ec,eh)}}_addDefaultHandlers(F){let el=this._map,eh=el.getCanvasContainer();this._add("mapEvent",new fa(el,F));let ec=el.boxZoom=new ga(el,F);this._add("boxZoom",ec);let ep=new ba,e_=new qa;el.doubleClickZoom=new ja(e_,ep),this._add("tapZoom",ep),this._add("clickZoom",e_);let eg=new Ha;this._add("tapDragZoom",eg);let ey=el.touchPitch=new Fa(el);this._add("touchPitch",ey);let eb=new Ca(F),ew=new Ia(F);el.dragRotate=new Wa(F,eb,ew),this._add("mouseRotate",eb,["mousePitch"]),this._add("mousePitch",ew,["mouseRotate"]);let eT=new Sa(F),eS=new Ra(el,F);el.dragPan=new Za(eh,eT,eS),this._add("mousePan",eT),this._add("touchPan",eS,["touchZoom","touchRotate"]);let eE=new za,eM=new Ma;el.touchZoomRotate=new $a(eh,eM,eE,eg),this._add("touchRotate",eE,["touchPan","touchZoom"]),this._add("touchZoom",eM,["touchPan","touchRotate"]),this._add("blockableMapEvent",new ma(el));let eI=el.scrollZoom=new Ga(el,this);this._add("scrollZoom",eI,["mousePan"]);let eA=el.keyboard=new Ba;for(let eh of(this._add("keyboard",eA),["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"]))F.interactive&&F[eh]&&el[eh].enable(F[eh])}_add(F,el,eh){this._handlers.push({handlerName:F,handler:el,allowed:eh}),this._handlersById[F]=el}stop(F){if(!this._updatingCamera){for(let{handler:F}of this._handlers)F.reset();this._inertia.clear(),this._fireEvents({},{},F),this._changes=[],this._originalZoom=void 0}}isActive(){for(let{handler:F}of this._handlers)if(F.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Xa(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(F,el,eh){for(let ec in F)if(ec!==eh&&(!el||0>el.indexOf(ec)))return!0;return!1}handleWindowEvent(F){this.handleEvent(F,`${F.type}Window`)}_getMapTouches(F){let el=[];for(let eh of F)this._el.contains(eh.target)&&el.push(eh);return el}handleEvent(F,el){this._updatingCamera=!0;let eh="renderFrame"===F.type,ec=eh?void 0:F,ep={needsRenderFrame:!1},e_={},eg={},ey=F.touches?this._getMapTouches(F.touches):void 0,eb=ey?v(this._el,ey):eh?void 0:g(this._el,F);for(let{handlerName:eh,handler:ew,allowed:eT}of this._handlers){let eS;ew.isEnabled()&&(this._blockedByActive(eg,eT,eh)?ew.reset():ew[el||F.type]&&(eS=ew[el||F.type](F,eb,ey),this.mergeHandlerResult(ep,e_,eS,eh,ec),eS&&eS.needsRenderFrame&&this._triggerRenderFrame()),(eS||ew.isActive())&&(eg[eh]=ew))}let ew={};for(let F in this._previousActiveHandlers)eg[F]||(ew[F]=ec);this._previousActiveHandlers=eg,(Object.keys(ew).length||Ja(ep))&&(this._changes.push([ep,e_,ew]),this._triggerRenderFrame()),(Object.keys(eg).length||Ja(ep))&&this._map._stop(!0),this._updatingCamera=!1;let{cameraAnimation:eT}=ep;eT&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],eT(this._map))}mergeHandlerResult(el,eh,ec,ep,e_){if(!ec)return;F.l(el,ec);let eg={handlerName:ep,originalEvent:ec.originalEvent||e_};void 0!==ec.zoomDelta&&(eh.zoom=eg),void 0!==ec.panDelta&&(eh.drag=eg),void 0!==ec.pitchDelta&&(eh.pitch=eg),void 0!==ec.bearingDelta&&(eh.rotate=eg)}_applyChanges(){let el={},eh={},ec={};for(let[ep,e_,eg]of this._changes)ep.panDelta&&(el.panDelta=(el.panDelta||new F.P(0,0))._add(ep.panDelta)),ep.zoomDelta&&(el.zoomDelta=(el.zoomDelta||0)+ep.zoomDelta),ep.bearingDelta&&(el.bearingDelta=(el.bearingDelta||0)+ep.bearingDelta),ep.pitchDelta&&(el.pitchDelta=(el.pitchDelta||0)+ep.pitchDelta),void 0!==ep.around&&(el.around=ep.around),void 0!==ep.aroundCoord&&(el.aroundCoord=ep.aroundCoord),void 0!==ep.pinchAround&&(el.pinchAround=ep.pinchAround),ep.noInertia&&(el.noInertia=ep.noInertia),F.l(eh,e_),F.l(ec,eg);this._updateMapTransform(el,eh,ec),this._changes=[]}_updateMapTransform(el,eh,ec){var ep;let e_=this._map,eg=e_.transform,n=F=>[F.x,F.y,F.z];if((F=>{let el=this._eventsInProgress.drag;return el&&!this._handlersById[el.handlerName].isActive()})()&&!Ja(el)){let F=eg.zoom;eg.cameraElevationReference="sea",null!=this._originalZoom&&eg._orthographicProjectionAtLowPitch&&"globe"!==eg.projection.name&&0===eg.pitch?(eg.cameraElevationReference="ground",eg.zoom=this._originalZoom):(eg.recenterOnTerrain(),eg.cameraElevationReference="ground"),F!==eg.zoom&&this._map._update(!0)}if(eg._isCameraConstrained&&e_._stop(!0),!Ja(el))return void this._fireEvents(eh,ec,!0);let{panDelta:ey,zoomDelta:eb,bearingDelta:ew,pitchDelta:eT,around:eS,aroundCoord:eE,pinchAround:eM}=el;eg._isCameraConstrained&&(eb>0&&(eb=0),eg._isCameraConstrained=!1),void 0!==eM&&(eS=eM),(eb||eh[ep="drag"]&&!this._eventsInProgress[ep])&&eS&&(this._dragOrigin=n(eg.pointCoordinate3D(eS)),this._originalZoom=eg.zoom,this._trackingEllipsoid.setup(eg._camera.position,this._dragOrigin)),eg.cameraElevationReference="sea",e_._stop(!0),eS=eS||e_.transform.centerPoint,ew&&(eg.bearing+=ew),eT&&(eg.pitch+=eT),eg._updateCameraState();let eI=[0,0,0];if(ey){if("mercator"===eg.projection.name){let F=this._trackingEllipsoid.projectRay(eg.screenPointToMercatorRay(eS).dir),el=this._trackingEllipsoid.projectRay(eg.screenPointToMercatorRay(eS.sub(ey)).dir);eI[0]=el[0]-F[0],eI[1]=el[1]-F[1]}else{let el=eg.pointCoordinate(eS);if("globe"===eg.projection.name){ey=ey.rotate(-eg.angle);let eh=eg._pixelsPerMercatorPixel/eg.worldSize;eI[0]=-ey.x*F.dE(F.aT(el.y))*eh,eI[1]=-ey.y*F.dE(eg.center.lat)*eh}else{let F=eg.pointCoordinate(eS.sub(ey));el&&F&&(eI[0]=F.x-el.x,eI[1]=F.y-el.y)}}}let eA=eg.zoom,eC=[0,0,0];if(eb){let el=n(eE||eg.pointCoordinate3D(eS)),eh={dir:F.ad.vec3.normalize([],F.ad.vec3.sub([],el,eg._camera.position))};if(eh.dir[2]<0){let ec=eg.zoomDeltaToMovement(el,eb);F.ad.vec3.scale(eC,eh.dir,ec)}}let eP=F.ad.vec3.add(eI,eI,eC);eg._translateCameraConstrained(eP),eb&&Math.abs(eg.zoom-eA)>1e-4&&eg.recenterOnTerrain(),eg.cameraElevationReference="ground",this._map._update(),el.noInertia||this._inertia.record(el),this._fireEvents(eh,ec,!0)}_fireEvents(el,eh,ec){let ep;let e_=Xa(this._eventsInProgress),eg=Xa(el),ey={};for(let F in el){let{originalEvent:eh}=el[F];this._eventsInProgress[F]||(ey[`${F}start`]=eh),this._eventsInProgress[F]=el[F]}for(let F in!e_&&eg&&this._fireEvent("movestart",eg.originalEvent),ey)this._fireEvent(F,ey[F]);for(let F in eg&&this._fireEvent("move",eg.originalEvent),el){let{originalEvent:eh}=el[F];this._fireEvent(F,eh)}let eb={};for(let F in this._eventsInProgress){let{handlerName:el,originalEvent:ec}=this._eventsInProgress[F];this._handlersById[el].isActive()||(delete this._eventsInProgress[F],ep=eh[el]||ec,eb[`${F}end`]=ep)}for(let F in eb)this._fireEvent(F,eb[F]);let ew=Xa(this._eventsInProgress);if(ec&&(e_||eg)&&!ew){var eT,eS;this._updatingCamera=!0;let el=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions);el?(0!==(eT=el.bearing||this._map.getBearing())&&-this._bearingSnap<eT&&eT<this._bearingSnap&&(el.bearing=0),this._map.easeTo(el,{originalEvent:ep})):(this._map.fire(new F.A("moveend",{originalEvent:ep})),0!==(eS=this._map.getBearing())&&-this._bearingSnap<eS&&eS<this._bearingSnap&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(el,eh){this._map.fire(new F.A(el,eh?{originalEvent:eh}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(F=>{this._frameId=void 0,this.handleEvent(new Ka("renderFrame",{timeStamp:F})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}};let iE="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";let tl=class tl extends F.E{constructor(el,eh){super(),this._moving=!1,this._zooming=!1,this.transform=el,this._bearingSnap=eh.bearingSnap,this._respectPrefersReducedMotion=!1!==eh.respectPrefersReducedMotion,F.aQ(["_renderFrameCallback"],this)}getCenter(){return new F.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(F,el){return this.jumpTo({center:F},el)}panBy(el,eh,ec){return el=F.P.convert(el).mult(-1),this.panTo(this.transform.center,F.l({offset:el},eh),ec)}panTo(el,eh,ec){return this.easeTo(F.l({center:el},eh),ec)}getZoom(){return this.transform.zoom}setZoom(F,el){return this.jumpTo({zoom:F},el),this}zoomTo(el,eh,ec){return this.easeTo(F.l({zoom:el},eh),ec)}zoomIn(F,el){return this.zoomTo(this.getZoom()+1,F,el),this}zoomOut(F,el){return this.zoomTo(this.getZoom()-1,F,el),this}getBearing(){return this.transform.bearing}setBearing(F,el){return this.jumpTo({bearing:F},el),this}getPadding(){return this.transform.padding}setPadding(F,el){return this.jumpTo({padding:F},el),this}rotateTo(el,eh,ec){return this.easeTo(F.l({bearing:el},eh),ec)}resetNorth(el,eh){return this.rotateTo(0,F.l({duration:1e3},el),eh),this}resetNorthPitch(el,eh){return this.easeTo(F.l({bearing:0,pitch:0,duration:1e3},el),eh),this}snapToNorth(F,el){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(F,el):this}getPitch(){return this.transform.pitch}setPitch(F,el){return this.jumpTo({pitch:F},el),this}cameraForBounds(el,eh){el=F.aB.convert(el);let ec=eh&&eh.bearing||0,ep=eh&&eh.pitch||0,e_=el.getNorthWest(),eg=el.getSouthEast();return this._cameraForBounds(this.transform,e_,eg,ec,ep,eh)}_extendPadding(el){let eh={top:0,right:0,bottom:0,left:0};return null==el?F.l({},eh,this.transform.padding):"number"==typeof el?{top:el,bottom:el,right:el,left:el}:F.l({},eh,el)}_extendCameraOptions(el){return(el=F.l({offset:[0,0],maxZoom:this.transform.maxZoom},el)).padding=this._extendPadding(el.padding),el}_minimumAABBFrustumDistance(F,el){let eh=el.max[0]-el.min[0],ec=el.max[1]-el.min[1];return eh/ec>F.aspect?eh/(2*Math.tan(.5*F.fovX)*F.aspect):ec/(2*Math.tan(.5*F.fovY)*F.aspect)}_cameraForBoundsOnGlobe(el,eh,ec,ep,e_,eg){let ey=el.clone(),eb=this._extendCameraOptions(eg);ey.bearing=ep,ey.pitch=e_;let ew=F.bO.convert(eh),eT=F.bO.convert(ec),eS=.5*(ew.lat+eT.lat),eE=.5*(ew.lng+eT.lng),eM=F.dF(eS,eE),eI=F.ad.vec3.normalize([],eM),eA=F.ad.vec3.normalize([],F.ad.vec3.cross([],eI,[0,1,0])),eC=F.ad.vec3.cross([],eA,eI),eP=[eA[0],eA[1],eA[2],0,eC[0],eC[1],eC[2],0,eI[0],eI[1],eI[2],0,0,0,0,1],ez=[eM,F.dF(ew.lat,ew.lng),F.dF(eT.lat,ew.lng),F.dF(eT.lat,eT.lng),F.dF(ew.lat,eT.lng),F.dF(eS,ew.lng),F.dF(eS,eT.lng),F.dF(ew.lat,eE),F.dF(eT.lat,eE)],eD=F.ce.fromPoints(ez.map(el=>[F.ad.vec3.dot(eA,el),F.ad.vec3.dot(eC,el),F.ad.vec3.dot(eI,el)])),eR=F.ad.vec3.transformMat4([],eD.center,eP);0===F.ad.vec3.squaredLength(eR)&&F.ad.vec3.set(eR,0,0,1),F.ad.vec3.normalize(eR,eR),F.ad.vec3.scale(eR,eR,F.az),ey.center=F.dG(eR);let eL=ey.getWorldToCameraMatrix(),eO=F.ad.mat4.invert(new Float64Array(16),eL);eD=F.ce.applyTransform(eD,F.ad.mat4.multiply([],eL,eP));let ek=this._extendAABB(eD,ey,eb,ep);if(!ek)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");eD=ek,F.ad.vec3.transformMat4(eR,eR,eL);let eF=.5*(eD.max[2]-eD.min[2]),eB=this._minimumAABBFrustumDistance(ey,eD),eN=F.ad.vec3.scale([],[0,0,1],eF),eV=F.ad.vec3.add(eN,eR,eN),eU=eB+(0===ey.pitch?0:F.ad.vec3.distance(eR,eV)),ej=ey.globeCenterInViewSpace,eG=F.ad.vec3.sub([],eR,[ej[0],ej[1],ej[2]]);F.ad.vec3.normalize(eG,eG),F.ad.vec3.scale(eG,eG,eU);let eq=F.ad.vec3.add([],eR,eG);F.ad.vec3.transformMat4(eq,eq,eO);let e$=F.dv/F.az,eH=F.ad.vec3.length(eq),eZ=F.bH(Math.max(eH*e$-F.dv,Number.EPSILON),0),eW=Math.min(ey.zoomFromMercatorZAdjusted(eZ),eb.maxZoom);return eW>.5*(F.c6+F.bY)?(ey.setProjection({name:"mercator"}),ey.zoom=eW,this._cameraForBounds(ey,eh,ec,ep,e_,eg)):{center:ey.center,zoom:eW,bearing:ep,pitch:e_}}_extendAABB(el,eh,ec,ep){let e_=.5*((ec.padding.left||0)+(ec.padding.right||0)),eg=.5*((ec.padding.top||0)+(ec.padding.bottom||0)),ey=eh.width-(e_+e_),eb=eh.height-(eg+eg),ew=F.ad.vec3.sub([],el.max,el.min),eT=Math.min(ey/ew[0],eb/ew[1]),eS=Math.min(eh.scaleZoom(eh.scale*eT),ec.maxZoom);if(isNaN(eS))return null;let eE=eh.scale/eh.zoomScale(eS),eM=new F.ce([el.min[0]-e_*eE,el.min[1]-eg*eE,el.min[2]],[el.max[0]+e_*eE,el.max[1]+eg*eE,el.max[2]]),eI=("number"==typeof ec.offset.x&&"number"==typeof ec.offset.y?new F.P(ec.offset.x,ec.offset.y):F.P.convert(ec.offset)).rotate(-F.ak(ep));return eM.center[0]-=eI.x*eE,eM.center[1]+=eI.y*eE,eM}queryTerrainElevation(el,eh){let ec=this.transform.elevation;return ec?(eh=F.l({},{exaggerated:!0},eh),ec.getAtPoint(F.ac.fromLngLat(el),null,eh.exaggerated)):null}_cameraForBounds(el,eh,ec,ep,e_,eg){if("globe"===el.projection.name)return this._cameraForBoundsOnGlobe(el,eh,ec,ep,e_,eg);let ey=el.clone(),eb=this._extendCameraOptions(eg);ey.bearing=ep,ey.pitch=e_;let ew=F.bO.convert(eh),eT=F.bO.convert(ec),eS=new F.bO(ew.lng,eT.lat),eE=new F.bO(eT.lng,ew.lat),eM=ey.project(ew),eI=ey.project(eT),eA=this.queryTerrainElevation(ew),eC=this.queryTerrainElevation(eT),eP=this.queryTerrainElevation(eS),ez=this.queryTerrainElevation(eE),eD=[[eM.x,eM.y,Math.min(eA||0,eC||0,eP||0,ez||0)],[eI.x,eI.y,Math.max(eA||0,eC||0,eP||0,ez||0)]],eR=F.ce.fromPoints(eD),eL=ey.getWorldToCameraMatrix(),eO=F.ad.mat4.invert(new Float64Array(16),eL);eR=F.ce.applyTransform(eR,eL);let ek=this._extendAABB(eR,ey,eb,ep);if(!ek)return void F.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");eR=ek;let eF=.5*F.ad.vec3.sub([],eR.max,eR.min)[2],eB=this._minimumAABBFrustumDistance(ey,eR),eN=[0,0,1,0];F.ad.vec4.transformMat4(eN,eN,eL),F.ad.vec4.normalize(eN,eN);let eV=F.ad.vec3.scale([],eN,eB+eF),eU=F.ad.vec3.add([],eR.center,eV);F.ad.vec3.transformMat4(eR.center,eR.center,eO),F.ad.vec3.transformMat4(eU,eU,eO);let ej=ey.unproject(new F.P(eR.center[0],eR.center[1])),eG=F.dH(ey.projection,ej),eq=Math.pow(2,eG),e$=Math.min(ey._zoomFromMercatorZ(eU[2]*ey.pixelsPerMeter*eq/ey.worldSize),eb.maxZoom);return ey.mercatorFromTransition&&e$<.5*(F.c6+F.bY)?(ey.setProjection({name:"globe"}),ey.zoom=e$,this._cameraForBounds(ey,eh,ec,ep,e_,eg)):{center:ej,zoom:e$,bearing:ep,pitch:e_}}fitBounds(F,el,eh){let ec=this.cameraForBounds(F,el);return this._fitInternal(ec,el,eh)}fitScreenCoordinates(el,eh,ec,ep,e_){let eg=F.P.convert(el),ey=F.P.convert(eh),eb=new F.P(Math.min(eg.x,ey.x),Math.min(eg.y,ey.y)),ew=new F.P(Math.max(eg.x,ey.x),Math.max(eg.y,ey.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(eg,ey))return this;let eT=this.transform.pointLocation3D(eb),eS=this.transform.pointLocation3D(ew),eE=this.transform.pointLocation3D(new F.P(eb.x,ew.y)),eM=this.transform.pointLocation3D(new F.P(ew.x,eb.y)),eI=[Math.min(eT.lng,eS.lng,eE.lng,eM.lng),Math.min(eT.lat,eS.lat,eE.lat,eM.lat)],eA=[Math.max(eT.lng,eS.lng,eE.lng,eM.lng),Math.max(eT.lat,eS.lat,eE.lat,eM.lat)],eC=ep&&ep.pitch?ep.pitch:this.getPitch(),eP=this._cameraForBounds(this.transform,eI,eA,ec,eC,ep);return this._fitInternal(eP,ep,e_)}_fitInternal(el,eh,ec){return el?(eh=F.l(el,eh)).linear?this.easeTo(eh,ec):this.flyTo(eh,ec):this}jumpTo(el,eh){this.stop();let ec=el.preloadOnly?this.transform.clone():this.transform,ep=!1,e_=!1,eg=!1;"zoom"in el&&ec.zoom!==+el.zoom&&(ep=!0,ec.zoom=+el.zoom),void 0!==el.center&&(ec.center=F.bO.convert(el.center)),"bearing"in el&&ec.bearing!==+el.bearing&&(e_=!0,ec.bearing=+el.bearing),"pitch"in el&&ec.pitch!==+el.pitch&&(eg=!0,ec.pitch=+el.pitch);let ey="number"==typeof el.padding?this._extendPadding(el.padding):el.padding;if(null!=el.padding&&!ec.isPaddingEqual(ey)){if(!1===el.retainPadding){let F=ec.clone();F.padding=ey,ec.setLocationAtPoint(ec.center,F.centerPoint)}else ec.padding=ey}return el.preloadOnly?(this._preloadTiles(ec),this):(this.fire(new F.A("movestart",eh)).fire(new F.A("move",eh)),ep&&this.fire(new F.A("zoomstart",eh)).fire(new F.A("zoom",eh)).fire(new F.A("zoomend",eh)),e_&&this.fire(new F.A("rotatestart",eh)).fire(new F.A("rotate",eh)).fire(new F.A("rotateend",eh)),eg&&this.fire(new F.A("pitchstart",eh)).fire(new F.A("pitch",eh)).fire(new F.A("pitchend",eh)),this.fire(new F.A("moveend",eh)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||F.w(iE),this.transform.getFreeCameraOptions()}setFreeCameraOptions(el,eh){let ec=this.transform;if(!ec.projection.supportsFreeCamera)return F.w(iE),this;this.stop();let ep=ec.zoom,e_=ec.pitch,eg=ec.bearing;ec.setFreeCameraOptions(el);let ey=ep!==ec.zoom,eb=e_!==ec.pitch,ew=eg!==ec.bearing;return this.fire(new F.A("movestart",eh)).fire(new F.A("move",eh)),ey&&this.fire(new F.A("zoomstart",eh)).fire(new F.A("zoom",eh)).fire(new F.A("zoomend",eh)),ew&&this.fire(new F.A("rotatestart",eh)).fire(new F.A("rotate",eh)).fire(new F.A("rotateend",eh)),eb&&this.fire(new F.A("pitchstart",eh)).fire(new F.A("pitch",eh)).fire(new F.A("pitchend",eh)),this.fire(new F.A("moveend",eh)),this}easeTo(el,eh){let ec,ep,e_,eg,ey;this._stop(!1,el.easeId),(!1===(el=F.l({offset:[0,0],duration:500,easing:F.dD},el)).animate||this._prefersReducedMotion(el))&&(el.duration=0);let eb=this.transform,ew=this.getZoom(),eT=this.getBearing(),eS=this.getPitch(),eE=this.getPadding(),eM="zoom"in el?+el.zoom:ew,eI="bearing"in el?this._normalizeBearing(el.bearing,eT):eT,eA="pitch"in el?+el.pitch:eS,eC=this._extendPadding(el.padding),eP=F.P.convert(el.offset);if("globe"===eb.projection.name){let eh=F.ac.fromLngLat(eb.center),eg=eP.rotate(-eb.angle);eh.x+=eg.x/eb.worldSize,eh.y+=eg.y/eb.worldSize;let ey=eh.toLngLat(),ew=F.bO.convert(el.center||ey);this._normalizeCenter(ew),ec=eb.centerPoint.add(eg),ep=new F.P(eh.x,eh.y).mult(eb.worldSize),e_=new F.P(F.av(ew.lng),F.aC(ew.lat)).mult(eb.worldSize).sub(ep)}else{ec=eb.centerPoint.add(eP);let eh=eb.pointLocation(ec),eg=F.bO.convert(el.center||eh);this._normalizeCenter(eg),ep=eb.project(eh),e_=eb.project(eg).sub(ep)}let ez=eb.zoomScale(eM-ew);el.around&&(eg=F.bO.convert(el.around),ey=eb.locationPoint(eg));let eD=this._zooming||eM!==ew,eR=this._rotating||eT!==eI,eL=this._pitching||eA!==eS,eO=!eb.isPaddingEqual(eC),ek=!1===el.retainPadding?eb.clone():eb,E=eb=>eF=>{if(eD&&(eb.zoom=F.ah(ew,eM,eF)),eR&&(eb.bearing=F.ah(eT,eI,eF)),eL&&(eb.pitch=F.ah(eS,eA,eF)),eO&&(ek.interpolatePadding(eE,eC,eF),ec=ek.centerPoint.add(eP)),eg)eb.setLocationAtPoint(eg,ey);else{let F=eb.zoomScale(eb.zoom-ew),el=eM>ew?Math.min(2,ez):Math.max(.5,ez),eh=Math.pow(el,1-eF),eg=eb.unproject(ep.add(e_.mult(eF*eh)).mult(F));eb.setLocationAtPoint(eb.renderWorldCopies?eg.wrap():eg,ec)}return el.preloadOnly||this._fireMoveEvents(eh),eb};if(el.preloadOnly){let F=this._emulate(E,el.duration,eb);return this._preloadTiles(F),this}let eF={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=eD,this._rotating=eR,this._pitching=eL,this._padding=eO,this._easeId=el.easeId,this._prepareEase(eh,el.noMoveStart,eF),this._ease(E(eb),F=>{"sea"===eb.cameraElevationReference&&eb.recenterOnTerrain(),this._afterEase(eh,F)},el),this}_prepareEase(el,eh,ec={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),eh||ec.moving||this.fire(new F.A("movestart",el)),this._zooming&&!ec.zooming&&this.fire(new F.A("zoomstart",el)),this._rotating&&!ec.rotating&&this.fire(new F.A("rotatestart",el)),this._pitching&&!ec.pitching&&this.fire(new F.A("pitchstart",el))}_fireMoveEvents(el){this.fire(new F.A("move",el)),this._zooming&&this.fire(new F.A("zoom",el)),this._rotating&&this.fire(new F.A("rotate",el)),this._pitching&&this.fire(new F.A("pitch",el))}_afterEase(el,eh){if(this._easeId&&eh&&this._easeId===eh)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";let ec=this._zooming,ep=this._rotating,e_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,ec&&this.fire(new F.A("zoomend",el)),ep&&this.fire(new F.A("rotateend",el)),e_&&this.fire(new F.A("pitchend",el)),this.fire(new F.A("moveend",el))}flyTo(el,eh){if(this._prefersReducedMotion(el)){let ec=F.aA(el,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(ec,eh)}this.stop(),el=F.l({offset:[0,0],speed:1.2,curve:1.42,easing:F.dD},el);let ec=this.transform,ep=this.getZoom(),e_=this.getBearing(),eg=this.getPitch(),ey=this.getPadding(),eb="zoom"in el?F.ay(+el.zoom,ec.minZoom,ec.maxZoom):ep,ew="bearing"in el?this._normalizeBearing(el.bearing,e_):e_,eT="pitch"in el?+el.pitch:eg,eS=this._extendPadding(el.padding),eE=ec.zoomScale(eb-ep),eM=F.P.convert(el.offset),eI=ec.centerPoint.add(eM),eA=ec.pointLocation(eI),eC=F.bO.convert(el.center||eA);this._normalizeCenter(eC);let eP=ec.project(eA),ez=ec.project(eC).sub(eP),eD=el.curve,eR=Math.max(ec.width,ec.height),eL=eR/eE,eO=ez.mag();if("minZoom"in el){let eh=F.ay(Math.min(el.minZoom,ep,eb),ec.minZoom,ec.maxZoom),e_=eR/ec.zoomScale(eh-ep);eD=Math.sqrt(e_/eO*2)}let ek=eD*eD;function E(F){let el=(eL*eL-eR*eR+(F?-1:1)*ek*ek*eO*eO)/(2*(F?eL:eR)*ek*eO);return Math.log(Math.sqrt(el*el+1)-el)}function S(F){return(Math.exp(F)-Math.exp(-F))/2}function C(F){return(Math.exp(F)+Math.exp(-F))/2}let eF=E(0),R=function(F){return C(eF)/C(eF+eD*F)},D=function(F){var el;return eR*((C(eF)*(S(el=eF+eD*F)/C(el))-S(eF))/ek)/eO},eB=(E(1)-eF)/eD;if(1e-6>Math.abs(eO)||!isFinite(eB)){if(1e-6>Math.abs(eR-eL))return this.easeTo(el,eh);let F=eL<eR?-1:1;eB=Math.abs(Math.log(eL/eR))/eD,D=function(){return 0},R=function(el){return Math.exp(F*eD*el)}}el.duration="duration"in el?+el.duration:1e3*eB/("screenSpeed"in el?+el.screenSpeed/eD:+el.speed),el.maxDuration&&el.duration>el.maxDuration&&(el.duration=0);let eN=e_!==ew,eV=eT!==eg,eU=!ec.isPaddingEqual(eS),ej=!1===el.retainPadding?ec.clone():ec,O=ec=>eE=>{let eA=eE*eB,eD=1/R(eA);ec.zoom=1===eE?eb:ep+ec.scaleZoom(eD),eN&&(ec.bearing=F.ah(e_,ew,eE)),eV&&(ec.pitch=F.ah(eg,eT,eE)),eU&&(ej.interpolatePadding(ey,eS,eE),eI=ej.centerPoint.add(eM));let eR=1===eE?eC:ec.unproject(eP.add(ez.mult(D(eA))).mult(eD));return ec.setLocationAtPoint(ec.renderWorldCopies?eR.wrap():eR,eI),ec._updateCameraOnTerrain(),el.preloadOnly||this._fireMoveEvents(eh),ec};if(el.preloadOnly){let F=this._emulate(O,el.duration,ec);return this._preloadTiles(F),this}return this._zooming=!0,this._rotating=eN,this._pitching=eV,this._padding=eU,this._prepareEase(eh,!1),this._ease(O(ec),()=>this._afterEase(eh),el),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(F){}_cancelRenderFrame(F){}_stop(F,el){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){let F=this._onEaseEnd;this._onEaseEnd=void 0,F.call(this,el)}if(!F){let F=this.handlers;F&&F.stop(!1)}return this}_ease(el,eh,ec){!1===ec.animate||0===ec.duration?(el(1),eh()):(this._easeStart=F.q.now(),this._easeOptions=ec,this._onEaseFrame=el,this._onEaseEnd=eh,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){let el=Math.min((F.q.now()-this._easeStart)/this._easeOptions.duration,1),eh=this._onEaseFrame;eh&&eh(this._easeOptions.easing(el)),el<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(el,eh){el=F.bF(el,-180,180);let ec=Math.abs(el-eh);return Math.abs(el-360-eh)<ec&&(el-=360),Math.abs(el+360-eh)<ec&&(el+=360),el}_normalizeCenter(F){let el=this.transform;if(el.maxBounds||"globe"!==el.projection.name&&!el.renderWorldCopies)return;let eh=F.lng-el.center.lng;F.lng+=eh>180?-360:eh<-180?360:0}_prefersReducedMotion(el){return this._respectPrefersReducedMotion&&F.q.prefersReducedMotion&&!(el&&el.essential)}_emulate(F,el,eh){let ec=Math.ceil(15*el/1e3),ep=[],e_=F(eh.clone());for(let F=0;F<=ec;F++){let el=e_(F/ec);ep.push(el.clone())}return ep}_preloadTiles(F,el){}};let il=class il{constructor(el={}){this.options=el,F.aQ(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(F){let el=this.options&&this.options.compact,eh=F._getUIString("AttributionControl.ToggleAttribution");this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=l("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",eh);let ec=l("span","mapboxgl-ctrl-icon",this._compactButton);return ec.setAttribute("aria-hidden","true"),ec.setAttribute("title",eh),this._innerContainer=l("div","mapboxgl-ctrl-attrib-inner",this._container),el&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===el&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let el=this._editLink;el||(el=this._editLink=this._container.querySelector(".mapbox-improve-map"));let eh=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||F.e.ACCESS_TOKEN}];if(el){let ec=eh.reduce((F,el,ec)=>(el.value&&(F+=`${el.key}=${el.value}${ec<eh.length-1?"&":""}`),F),"?");el.href=`${F.e.FEEDBACK_URL}/${ec}#${oa(this._map,!0)}`,el.rel="noopener nofollow"}}_updateData(F){F&&("metadata"===F.sourceDataType||"visibility"===F.sourceDataType||"style"===F.dataType)&&(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let F=[];if(this._map.style.stylesheet){let F=this._map.style.stylesheet;this.styleOwner=F.owner,this.styleId=F.id}let el=this._map.style._mergedSourceCaches;for(let eh in el){let ec=el[eh];if(ec.used){let el=ec.getSource();el.attribution&&0>F.indexOf(el.attribution)&&F.push(el.attribution)}}F.sort((F,el)=>F.length-el.length),F=F.filter((el,eh)=>{for(let ec=eh+1;ec<F.length;ec++)if(F[ec].indexOf(el)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?F=[...this.options.customAttribution,...F]:F.unshift(this.options.customAttribution));let eh=F.join(" | ");eh!==this._attribHTML&&(this._attribHTML=eh,F.length?(this._innerContainer.innerHTML=eh,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}};let ol=class ol{constructor(){F.aQ(["_updateLogo","_updateCompact"],this)}onAdd(F){this._map=F,this._container=l("div","mapboxgl-ctrl");let el=l("a","mapboxgl-ctrl-logo");return el.target="_blank",el.rel="noopener nofollow",el.href="https://www.mapbox.com/",el.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),el.setAttribute("rel","noopener nofollow"),this._container.appendChild(el),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(F){F&&"metadata"!==F.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;let F=this._map.style._sourceCaches;if(0===Object.entries(F).length)return!0;for(let el in F){let eh=F[el].getSource();if(eh.hasOwnProperty("mapbox_logo")&&!eh.mapbox_logo)return!1}return!0}_updateCompact(){let F=this._container.children;if(F.length){let el=F[0];this._map.getCanvasContainer().offsetWidth<250?el.classList.add("mapboxgl-compact"):el.classList.remove("mapboxgl-compact")}}};let sl=class sl{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(F){let el=++this._id;return this._queue.push({callback:F,id:el,cancelled:!1}),el}remove(F){let el=this._currentlyRunning,eh=el?this._queue.concat(el):this._queue;for(let el of eh)if(el.id===F)return void(el.cancelled=!0)}run(F=0){let el=this._currentlyRunning=this._queue;for(let eh of(this._queue=[],el))if(!eh.cancelled&&(eh.callback(F),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}};let rl=class rl{constructor(F){this.jumpTo(F)}getValue(el){if(el<=this._startTime)return this._start;if(el>=this._endTime)return this._end;let eh=F.cC((el-this._startTime)/(this._endTime-this._startTime));return this._start*(1-eh)+this._end*eh}isEasing(F){return F>=this._startTime&&F<=this._endTime}jumpTo(F){this._startTime=-1/0,this._endTime=-1/0,this._start=F,this._end=F}easeTo(F,el,eh){this._start=this.getValue(el),this._end=F,this._startTime=el,this._endTime=el+eh}};let iM={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use  + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};let al=class al extends F.A{constructor(F,el,eh,ec){let{point:ep,lngLat:e_,originalEvent:eg,target:ey}=F;super(F.type,{point:ep,lngLat:e_,originalEvent:eg,target:ey}),this.preventDefault=()=>{F.preventDefault()},this.id=el,this.interaction=eh,this.feature=ec}};let ll=class ll{constructor(F){this.map=F,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(el,eh){if(this.typeById.has(el))throw Error(`Interaction id "${el}" already exists.`);let ec=eh.filter,ep=eh.type;ec&&this.filters.set(el,F.a_(ec)),"mouseover"===ep&&(ep="mouseenter"),"mouseout"===ep&&(ep="mouseleave");let e_=this.interactionsByType.get(ep)||new Map;"mouseenter"===ep||"mouseleave"===ep?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(el,eh)):0===e_.size&&this.map.on(ep,this.handleType),0===e_.size&&this.interactionsByType.set(ep,e_),e_.set(el,eh),this.typeById.set(el,ep)}get(F){let el=this.typeById.get(F);if(!el)return;let eh=this.interactionsByType.get(el);return eh?eh.get(F):void 0}remove(F){let el=this.typeById.get(F);if(!el)return;this.typeById.delete(F),this.filters.delete(F);let eh=this.interactionsByType.get(el);eh&&(eh.delete(F),"mouseenter"===el||"mouseleave"===el?(this.delegatedInteractions.delete(F),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===eh.size&&this.map.off(el,this.handleType))}queryTargets(F,el){let eh=[];for(let[F,ec]of el)ec.target&&eh.push({targetId:F,target:ec.target,filter:this.filters.get(F)});return this.map.style.queryRenderedTargets(F,eh,this.map.transform)}handleMove(F){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;let el=this.queryTargets(F.point,Array.from(this.delegatedInteractions).reverse());el.length&&(F.type="mouseenter",this.handleType(F,el));let eh=new Map;for(let[F,{feature:el}]of this.prevHoveredFeatures)this.hoveredFeatures.has(F)||eh.set(el.id,el);eh.size&&(F.type="mouseleave",this.handleType(F,Array.from(eh.values())))}handleOut(F){let el=Array.from(this.hoveredFeatures.values()).map(({feature:F})=>F);el.length&&(F.type="mouseleave",this.handleType(F,el)),this.hoveredFeatures.clear()}handleType(el,eh){let ec=Array.from(this.interactionsByType.get(el.type)).reverse(),ep=!!eh;eh=eh||this.queryTargets(el.point,ec);let e_="mouseenter"===el.type,eg=!1,ey=new Set;for(let eb of eh){for(let[eh,ew]of ec){if(!ew.target)continue;let ec=eb.variants?eb.variants[eh]:null;if(ec){for(let eT of ec){if(at(eT,eb,ey,eh))continue;let ec=new F.cx(eb,eT),eS=nt(eT,eb,eh);ep&&(ec.state=this.map.getFeatureState(ec));let eE=e_?this.prevHoveredFeatures.get(eS):null,eM=new al(el,eh,ew,ec),eI=eE?eE.stop:ew.handler(eM);if(e_&&this.hoveredFeatures.set(eS,{feature:eb,stop:eI}),!1!==eI){eg=!0;break}}if(eg)break}}if(eg)break}if(!eg)for(let[F,eh]of ec){let{handler:ec,target:ep}=eh;if(!ep&&!1!==ec(new al(el,F,eh,null)))break}}};let iI={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},iA={showCompass:!0,showZoom:!0,visualizePitch:!1};let ul=class ul{constructor(el,eh,ec=!1){this._clickTolerance=10,this.element=eh,this.mouseRotate=new Ca({clickTolerance:el.dragRotate._mouseRotate._clickTolerance}),this.map=el,ec&&(this.mousePitch=new Ia({clickTolerance:el.dragRotate._mousePitch._clickTolerance})),F.aQ(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),eh.addEventListener("mousedown",this.mousedown),eh.addEventListener("touchstart",this.touchstart,{passive:!1}),eh.addEventListener("touchmove",this.touchmove),eh.addEventListener("touchend",this.touchend),eh.addEventListener("touchcancel",this.reset)}down(F,el){this.mouseRotate.mousedown(F,el),this.mousePitch&&this.mousePitch.mousedown(F,el),_()}move(F,el){let eh=this.map,ec=this.mouseRotate.mousemoveWindow(F,el),ep=ec&&ec.bearingDelta;if(ep&&eh.setBearing(eh.getBearing()+ep),this.mousePitch){let ec=this.mousePitch.mousemoveWindow(F,el),ep=ec&&ec.pitchDelta;ep&&eh.setPitch(eh.getPitch()+ep)}}off(){let F=this.element;F.removeEventListener("mousedown",this.mousedown),F.removeEventListener("touchstart",this.touchstart,{passive:!1}),F.removeEventListener("touchmove",this.touchmove),F.removeEventListener("touchend",this.touchend),F.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){p(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(el){this.down(F.l({},el,{ctrlKey:!0,preventDefault:()=>el.preventDefault()}),g(this.element,el)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(F){this.move(F,g(this.element,F))}mouseup(F){this.mouseRotate.mouseupWindow(F),this.mousePitch&&this.mousePitch.mouseupWindow(F),this.offTemp()}touchstart(F){1!==F.targetTouches.length?this.reset():(this._startPos=this._lastPos=v(this.element,F.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>F.preventDefault()},this._startPos))}touchmove(F){1!==F.targetTouches.length?this.reset():(this._lastPos=v(this.element,F.targetTouches)[0],this.move({preventDefault:()=>F.preventDefault()},this._lastPos))}touchend(F){0===F.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}};function _l(el,eh,ec){if(el=new F.bO(el.lng,el.lat),eh){let ep=new F.bO(el.lng-360,el.lat),e_=new F.bO(el.lng+360,el.lat),eg=360*Math.ceil(Math.abs(el.lng-ec.center.lng)/360),ey=ec.locationPoint3D(el).distSqr(eh),eb=eh.x<0||eh.y<0||eh.x>ec.width||eh.y>ec.height;ec.locationPoint3D(ep).distSqr(eh)<ey&&(eb||Math.abs(ep.lng-ec.center.lng)<eg)?el=ep:ec.locationPoint3D(e_).distSqr(eh)<ey&&(eb||Math.abs(e_.lng-ec.center.lng)<eg)&&(el=e_)}for(;Math.abs(el.lng-ec.center.lng)>180;){let F=ec.locationPoint3D(el);if(F.x>=0&&F.y>=0&&F.x<=ec.width&&F.y<=ec.height)break;el.lng>ec.center.lng?el.lng-=360:el.lng+=360}return el}let iC={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},iP={anchor:"center",color:"#3FB1CE",scale:1,draggable:!1,clickTolerance:0,rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};let ml=class ml extends F.E{constructor(el,eh){super(),(el instanceof HTMLElement||eh)&&(el=F.l({element:el},eh)),F.aQ(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),el=F.l({},iP,el),this._anchor=el.anchor,this._color=el.color,this._scale=el.scale,this._draggable=el.draggable,this._clickTolerance=el.clickTolerance,this._rotation=el.rotation,this._rotationAlignment=el.rotationAlignment,this._pitchAlignment=el.pitchAlignment,this._occludedOpacity=el.occludedOpacity,this._altitude=el.altitude,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),el&&el.element?(this._element=el.element,this._offset=F.P.convert(el&&el.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=F.P.convert(el&&el.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",F=>{F.preventDefault()}),this._element.addEventListener("mousedown",F=>{F.preventDefault()});let ec=this._element.classList;for(let F in iC)ec.remove(`mapboxgl-marker-anchor-${F}`);ec.add(`mapboxgl-marker-anchor-${this._anchor}`);let ep=el&&el.className?el.className.trim().split(/\s+/):[];ec.add(...ep),this._popup=null}_createDefaultMarker(){let F=l("div"),el=c("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},F);if(0===this._altitude){let F=c("radialGradient",{id:"shadowGradient"},c("defs",{},el));c("stop",{offset:"10%","stop-opacity":.4},F),c("stop",{offset:"100%","stop-opacity":.05},F),c("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},el)}return c("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},el),c("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},el),c("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},el),F}addTo(F){return F===this._map||(this.remove(),this._map=F,F.getCanvasContainer().appendChild(this._element),F.on("move",this._updateMoving),F.on("moveend",this._update),F.on("remove",this._clearFadeTimer),F._addMarker(this),this.setDraggable(this._draggable),this._update(),F.on("click",this._onMapClick)),this}remove(){let F=this._map;return F&&(F.off("click",this._onMapClick),F.off("move",this._updateMoving),F.off("moveend",this._update),F.off("mousedown",this._addDragHandler),F.off("touchstart",this._addDragHandler),F.off("mouseup",this._onUp),F.off("touchend",this._onUp),F.off("mousemove",this._onMove),F.off("touchmove",this._onMove),F.off("remove",this._clearFadeTimer),F._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(el){return this._lngLat=F.bO.convert(el),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(F){return F===this._altitude||(this._defaultMarker&&(0===this._altitude&&0!==F||0!==this._altitude&&0===F)&&(this._element=this._createDefaultMarker()),this._altitude=F||iP.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(F){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),F){if(!("offset"in F.options)){let el=Math.sqrt(91.125);F.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[el,-1*(24.6+el)],"bottom-right":[-el,-1*(24.6+el)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=F,F._marker=this,F._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(F){let el=F.code,eh=F.charCode||F.keyCode;"Space"!==el&&"Enter"!==el&&32!==eh&&13!==eh||this.togglePopup()}_onMapClick(F){let el=F.originalEvent.target,eh=this._element;this._popup&&(el===eh||eh.contains(el))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){let F=this._popup;return F&&(F.isOpen()?(F.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(F.addTo(this._map),this._element.setAttribute("aria-expanded","true"))),this}_behindTerrain(){let F=this._map,el=this._pos;if(!F||!el)return!1;let eh=F.unproject(el,this._altitude),ec=F.getFreeCameraOptions();if(!ec.position)return!1;let ep=ec.position.toLngLat();return ep.distanceTo(eh)<.9*ep.distanceTo(this._lngLat)}_evaluateOpacity(){let el;let eh=this._map;if(!eh)return;let ec=this._pos;if(!ec||ec.x<0||ec.x>eh.transform.width||ec.y<0||ec.y>eh.transform.height)return void this._clearFadeTimer();let ep=eh.unproject(ec,this._altitude);eh._showingGlobe()&&F.dK(eh.transform,this._lngLat)?el=0:(el=1-eh._queryFogOpacity(ep),eh.transform._terrainEnabled()&&eh.getTerrain()&&this._behindTerrain()&&(el*=this._occludedOpacity)),this._element.style.opacity=`${el}`,this._element.style.pointerEvents=el>0?"auto":"none",this._popup&&this._popup._setOpacity(el),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){let F=this._pos;if(!F||!this._map)return;let el=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${F.x}px,${F.y}px)
            ${iC[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${el.x}px,${el.y}px)
        `}_calculateXYTransform(){let el=this._pos,eh=this._map,ec=this.getPitchAlignment();if(!eh||!el||"map"!==ec)return"";if(!eh._showingGlobe()){let F=eh.getPitch();return F?`rotateX(${F}deg)`:""}let ep=F.c4(F.dL(eh.transform,this._lngLat)),e_=el.sub(F.dM(eh.transform)),eg=Math.abs(e_.x)+Math.abs(e_.y);if(0===eg)return"";let ey=ep/eg;return`rotateX(${-e_.y*ey}deg) rotateY(${e_.x*ey}deg)`}_calculateZTransform(){let el=this._pos,eh=this._map;if(!eh||!el)return"";let ec=0,ep=this.getRotationAlignment();if("map"===ep){if(eh._showingGlobe()){let el=eh.project(new F.bO(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),ep=eh.project(new F.bO(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(el);ec=F.c4(Math.atan2(ep.y,ep.x))-90}else ec=-eh.getBearing()}else if("horizon"===ep){let ep=F.ae(4,6,eh.getZoom()),e_=F.dM(eh.transform);e_.y+=ep*eh.transform.height;let eg=el.sub(e_),ey=F.c4(Math.atan2(eg.y,eg.x));ec=(ey>90?ey-270:ey+90)*(1-ep)}return(ec+=this._rotation)?`rotateZ(${ec}deg)`:""}_update(F){cancelAnimationFrame(this._updateFrameId);let el=this._map;el&&(el.transform.renderWorldCopies&&(this._lngLat=_l(this._lngLat,this._pos,el.transform)),this._pos=el.project(this._lngLat,this._altitude),!0===F?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),el._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(el._showingGlobe()||el.getTerrain()||el.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(el){return this._offset=F.P.convert(el),this._update(),this}addClassName(F){return this._element.classList.add(F),this}removeClassName(F){return this._element.classList.remove(F),this}toggleClassName(F){return this._element.classList.toggle(F)}_onMove(el){let eh=this._map;if(!eh)return;let ec=this._pointerdownPos,ep=this._positionDelta;if(ec&&ep){if(!this._isDragging){let F=this._clickTolerance||eh._clickTolerance;if(el.point.dist(ec)<F)return;this._isDragging=!0}this._pos=el.point.sub(ep),this._lngLat=eh.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new F.A("dragstart"))),this.fire(new F.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;let el=this._map;el&&(el.off("mousemove",this._onMove),el.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new F.A("dragend")),this._state="inactive"}_addDragHandler(F){let el=this._map,eh=this._pos;el&&eh&&this._element.contains(F.originalEvent.target)&&(F.preventDefault(),this._positionDelta=F.point.sub(eh),this._pointerdownPos=F.point,this._state="pending",el.on("mousemove",this._onMove),el.on("touchmove",this._onMove),el.once("mouseup",this._onUp),el.once("touchend",this._onUp))}setDraggable(F){this._draggable=!!F;let el=this._map;return el&&(F?(el.on("mousedown",this._addDragHandler),el.on("touchstart",this._addDragHandler)):(el.off("mousedown",this._addDragHandler),el.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(F){return this._rotation=F||iP.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(F){return this._rotationAlignment=F||iP.rotationAlignment,this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(F){return this._pitchAlignment=F||iP.pitchAlignment,this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(F){return this._occludedOpacity=F||iP.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}};let iz={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},iD={maxWidth:100,unit:"metric"},iR={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},iL={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0};function wl(el=new F.P(0,0),eh="bottom"){if("number"==typeof el){let ec=Math.round(Math.sqrt(.5*Math.pow(el,2)));switch(eh){case"top":return new F.P(0,el);case"top-left":return new F.P(ec,ec);case"top-right":return new F.P(-ec,ec);case"bottom":return new F.P(0,-el);case"bottom-left":return new F.P(ec,-ec);case"bottom-right":return new F.P(-ec,-ec);case"left":return new F.P(el,0);case"right":return new F.P(-el,0)}return new F.P(0,0)}return el instanceof F.P||Array.isArray(el)?F.P.convert(el):F.P.convert(el[eh]||[0,0])}let iO={version:ep,supported:ew.supported,setRTLTextPlugin:F.dN,getRTLTextPluginStatus:F.dO,Map:class extends tl{constructor(el){eg.mark(e_.create);let eh=el;if(null!=(el=F.l({},iI,el)).minZoom&&null!=el.maxZoom&&el.minZoom>el.maxZoom)throw Error("maxZoom must be greater than or equal to minZoom");if(null!=el.minPitch&&null!=el.maxPitch&&el.minPitch>el.maxPitch)throw Error("maxPitch must be greater than or equal to minPitch");if(null!=el.minPitch&&el.minPitch<0)throw Error("minPitch must be greater than or equal to 0");if(null!=el.maxPitch&&el.maxPitch>85)throw Error("maxPitch must be less than or equal to 85");if(el.antialias&&F.dI(window)&&(el.antialias=!1,F.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Ji(el.minZoom,el.maxZoom,el.minPitch,el.maxPitch,el.renderWorldCopies,null,null),el),this._repaint=!!el.repaint,this._interactive=el.interactive,this._minTileCacheSize=el.minTileCacheSize,this._maxTileCacheSize=el.maxTileCacheSize,this._failIfMajorPerformanceCaveat=el.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=el.preserveDrawingBuffer,this._antialias=el.antialias,this._trackResize=el.trackResize,this._bearingSnap=el.bearingSnap,this._refreshExpiredTiles=el.refreshExpiredTiles,this._fadeDuration=el.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=el.crossSourceCollisions,this._collectResourceTiming=el.collectResourceTiming,this._language=this._parseLanguage(el.language),this._worldview=el.worldview,this._renderTaskQueue=new sl,this._domRenderTaskQueue=new sl,this._controls=[],this._markers=[],this._popups=[],this._mapId=F.aW(),this._locale=F.l({},iM,el.locale),this._clickTolerance=el.clickTolerance,this._cooperativeGestures=el.cooperativeGestures,this._performanceMetricsCollection=el.performanceMetricsCollection,this._tessellationStep=el.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=el.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new rl(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=el.scaleFactor,this._requestManager=new T(el.transformRequest,el.accessToken,el.testMode),this._silenceAuthErrors=!!el.testMode,this._contextCreateOptions=el.contextCreateOptions?Object.assign({},el.contextCreateOptions):{},"string"==typeof el.container){let F=document.getElementById(el.container);if(!F)throw Error(`Container '${el.container.toString()}' not found.`);this._container=F}else{if(!(el.container instanceof HTMLElement))throw Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=el.container}if(this._container.childNodes.length>0&&F.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),el.maxBounds&&this.setMaxBounds(el.maxBounds),this._spriteFormat=el.spriteFormat,F.aQ(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Nn),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),void 0===this.painter)throw Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new Qa(this,el),this._localFontFamily=el.localFontFamily,this._localIdeographFontFamily=el.localIdeographFontFamily,(el.style||!el.testMode)&&this.setStyle(el.style||F.e.DEFAULT_STYLE,{config:el.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),el.projection&&this.setProjection(el.projection),this.indoor=new _o(this),el.hash&&(this._hash=new ia("string"==typeof el.hash&&el.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==eh.center&&null==eh.zoom||(this.transform._unmodified=!1),this.jumpTo({center:el.center,zoom:el.zoom,bearing:el.bearing,pitch:el.pitch});let ec=el.bounds;ec&&(this.resize(),this.fitBounds(ec,F.l({},el.fitBoundsOptions,{duration:0})))}this.resize(),el.attributionControl&&this.addControl(new il({customAttribution:el.customAttribution})),this._logoControl=new ol,this.addControl(this._logoControl,el.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",el=>{this._update("style"===el.dataType),this.fire(new F.A(`${el.dataType}data`,el))}),this.on("dataloading",el=>{this.fire(new F.A(`${el.dataType}dataloading`,el))}),this._interactions=new ll(this)}_getMapId(){return this._mapId}addControl(el,eh){if(void 0===eh&&(eh=el.getDefaultPosition?el.getDefaultPosition():"top-right"),!el||!el.onAdd)return this.fire(new F.z(Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));let ec=el.onAdd(this);this._controls.push(el);let ep=this._controlPositions[eh];return -1!==eh.indexOf("bottom")?ep.insertBefore(ec,ep.firstChild):ep.appendChild(ec),this}removeControl(el){if(!el||!el.onRemove)return this.fire(new F.z(Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));let eh=this._controls.indexOf(el);return eh>-1&&this._controls.splice(eh,1),el.onRemove(this),this}hasControl(F){return this._controls.indexOf(F)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(el){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));let eh=!this._moving;return eh&&this.fire(new F.A("movestart",el)).fire(new F.A("move",el)),this.fire(new F.A("resize",el)),eh&&this.fire(new F.A("moveend",el)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(el){return this.transform.setMaxBounds(F.aB.convert(el)),this._update()}setMinZoom(el){if((el=el??-2)>=-2&&el<=this.transform.maxZoom)return this.transform.minZoom=el,this._update(),this.getZoom()<el?this.setZoom(el):this.fire(new F.A("zoomstart")).fire(new F.A("zoom")).fire(new F.A("zoomend")),this;throw Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(el){if((el=el??22)>=this.transform.minZoom)return this.transform.maxZoom=el,this._update(),this.getZoom()>el?this.setZoom(el):this.fire(new F.A("zoomstart")).fire(new F.A("zoom")).fire(new F.A("zoomend")),this;throw Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(el){if((el=el??0)<0)throw Error("minPitch must be greater than or equal to 0");if(el>=0&&el<=this.transform.maxPitch)return this.transform.minPitch=el,this._update(),this.getPitch()<el?this.setPitch(el):this.fire(new F.A("pitchstart")).fire(new F.A("pitch")).fire(new F.A("pitchend")),this;throw Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(el){if((el=el??85)>85)throw Error("maxPitch must be less than or equal to 85");if(el>=this.transform.minPitch)return this.transform.maxPitch=el,this._update(),this.getPitch()>el?this.setPitch(el):this.fire(new F.A("pitchstart")).fire(new F.A("pitch")).fire(new F.A("pitchend")),this;throw Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(F){return this._scaleFactor=F,this.painter.scaleFactor=F,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(F=>"symbol"===F.type),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(F){return this.transform.renderWorldCopies=F,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(F){return"auto"===F?navigator.language:Array.isArray(F)?0===F.length?void 0:F.map(F=>"auto"===F?navigator.language:F):F}setLanguage(F){let el=this._parseLanguage(F);if(!this.style||el===this._language)return this;for(let F of(this._language=el,this.style.reloadSources(),this._controls))F._setLanguage&&F._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(F){return this.style&&F!==this._worldview&&(this._worldview=F,this.style.reloadSources()),this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(F){return this._lazyInitEmptyStyle(),F?"string"==typeof F&&(F={name:F}):F=null,this._useExplicitProjection=!!F,this._prioritizeAndUpdateProjection(F,this.style.projection)}_updateProjectionTransition(){let el;if("globe"!==this.getProjection().name)return;let eh=this.transform,ec=eh.projection.name;"globe"===ec&&eh.zoom>=F.bY?(eh.setMercatorFromTransition(),el=!0):"mercator"===ec&&eh.zoom<F.bY&&(eh.setProjection({name:"globe"}),el=!0),el&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(F,el){return this._updateProjection(F||el||{name:"mercator"})}_updateProjection(el){let eh;return eh="globe"===el.name&&this.transform.zoom>=F.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(el),this.style.applyProjectionUpdate(),eh&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(el,eh){return this.transform.locationPoint3D(F.bO.convert(el),eh)}unproject(el,eh){return this.transform.pointLocation3D(F.P.convert(el),eh)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(F,el,eh){let o=F=>{let eh=[];if(Array.isArray(el)){let ec=el.filter(F=>this.getLayer(F));eh=ec.length?this.queryRenderedFeatures(F,{layers:ec}):[]}else eh=this.queryRenderedFeatures(F,{target:el});return eh};if("mouseenter"===F||"mouseover"===F){let ec=!1;return{listener:eh,targets:el,delegates:{mousemove:el=>{let ep=o(el.point);ep.length?ec||(ec=!0,eh.call(this,new ua(F,this,el.originalEvent,{features:ep}))):ec=!1},mouseout:()=>{ec=!1}}}}if("mouseleave"===F||"mouseout"===F){let ec=!1;return{listener:eh,targets:el,delegates:{mousemove:el=>{o(el.point).length?ec=!0:ec&&(ec=!1,eh.call(this,new ua(F,this,el.originalEvent)))},mouseout:el=>{ec&&(ec=!1,eh.call(this,new ua(F,this,el.originalEvent)))}}}}return{listener:eh,targets:el,delegates:{[F]:F=>{let el=o(F.point);el.length&&(F.features=el,eh.call(this,F),delete F.features)}}}}on(F,el,eh){if("function"==typeof el||void 0===eh)return super.on(F,el);if("string"==typeof el&&(el=[el]),!this._areTargetsValid(el))return this;let ec=this._createDelegatedListener(F,el,eh);for(let el in this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[F]=this._delegatedListeners[F]||[],this._delegatedListeners[F].push(ec),ec.delegates)this.on(el,ec.delegates[el]);return this}once(F,el,eh){if("function"==typeof el||void 0===eh)return super.once(F,el);if("string"==typeof el&&(el=[el]),!this._areTargetsValid(el))return this;let ec=this._createDelegatedListener(F,el,eh);for(let F in ec.delegates)this.once(F,ec.delegates[F]);return this}off(el,eh,ec){if("function"==typeof eh||void 0===ec)return super.off(el,eh);if("string"==typeof eh&&(eh=[eh]),!this._areTargetsValid(eh))return this;let ep=this._delegatedListeners?this._delegatedListeners[el]:void 0;return ep&&(el=>{for(let ep=0;ep<el.length;ep++){let e_=el[ep];if(e_.listener===ec&&function(el,eh){if(Array.isArray(el)&&Array.isArray(eh)){let F=new Set(el),ec=new Set(eh);return F.size===ec.size&&el.every(F=>ec.has(F))}return F.bn(el,eh)}(e_.targets,eh)){for(let F in e_.delegates)this.off(F,e_.delegates[F]);return el.splice(ep,1),this}}})(ep),this}queryRenderedFeatures(el,eh){if(!this.style)return[];if(void 0===el||el instanceof F.P||Array.isArray(el)||void 0!==eh||(eh=el,el=void 0),el=el||[[0,0],[this.transform.width,this.transform.height]],!eh){let F=this.style.queryRenderedFeatures(el,void 0,this.transform),eh=this.style.queryRenderedFeatureset(el,void 0,this.transform);return F.concat(eh)}let ec=!0;if(eh.target&&(ec=this._isTargetValid(eh.target))&&!eh.layers)return this.style.queryRenderedFeatureset(el,eh,this.transform);let ep=!0;if(eh.layers&&Array.isArray(eh.layers)){for(let F of eh.layers)if(!this._isValidId(F)){ep=!1;break}if(ep&&!eh.target)return this.style.queryRenderedFeatures(el,eh,this.transform)}let e_=[];return ep&&(e_=e_.concat(this.style.queryRenderedFeatures(el,eh,this.transform))),ec&&(e_=e_.concat(this.style.queryRenderedFeatureset(el,eh,this.transform))),e_}querySourceFeatures(F,el){return F&&("string"!=typeof F||this._isValidId(F))?this.style.querySourceFeatures(F,el):[]}isPointOnSurface(el){let{name:eh}=this.transform.projection;return"globe"!==eh&&"mercator"!==eh&&F.w(`${eh} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(F.P.convert(el))}addInteraction(F,el){return this._interactions.add(F,el),this}removeInteraction(F){return this._interactions.remove(F),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(F){return this._cooperativeGestures=F,this}setStyle(el,eh){return eh=F.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},eh),this.style&&el&&!1!==eh.diff&&eh.localFontFamily===this._localFontFamily&&eh.localIdeographFontFamily===this._localIdeographFontFamily&&!eh.config?(this.style._diffStyle(el,(ec,ep)=>{ec?(F.w(`Unable to perform style diff: ${String(ec.message||ec.error||ec)}. Rebuilding the style from scratch.`),this._updateStyle(el,eh)):ep&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=eh.localIdeographFontFamily,this._localFontFamily=eh.localFontFamily,this._updateStyle(el,eh))}_getUIString(F){let el=this._locale[F];if(null==el)throw Error(`Missing UI string '${F}'`);return el}_updateStyle(el,eh){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),el){let ec=F.l({},eh);eh&&eh.config&&(ec.initialConfig=eh.config,delete ec.config),this.style=new To(this,ec).load(el),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new To(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(F.w("There is no style added to the map."),!1)}_isValidId(el){return null==el?(this.fire(new F.z(Error("IDs can't be empty."))),!1):!F.cs(el)||(this.fire(new F.z(Error(`IDs can't contain special symbols: "${el}".`))),!1)}_isTargetValid(F){return"featuresetId"in F?this._isValidId("importId"in F?F.importId:F.featuresetId):"layerId"in F&&this._isValidId(F.layerId)}_areTargetsValid(F){if(Array.isArray(F)){for(let el of F)if(!this._isValidId(el))return!1;return!0}return this._isTargetValid(F)}addSource(F,el){return this._isValidId(F)?(this._lazyInitEmptyStyle(),this.style.addSource(F,el),this._update(!0)):this}isSourceLoaded(F){return!!this._isValidId(F)&&!!this.style&&this.style._isSourceCacheLoaded(F)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(F,el,eh){this._lazyInitEmptyStyle(),this.style.addSourceType(F,el,eh)}removeSource(F){return this._isValidId(F)?(this.style.removeSource(F),this._updateTerrain(),this._update(!0)):this}getSource(F){return this._isValidId(F)?this.style.getOwnSource(F):null}addImage(el,eh,{pixelRatio:ec=1,sdf:ep=!1,stretchX:e_,stretchY:eg,content:ey}={}){this._lazyInitEmptyStyle();let eb=F.I.from(el);if(eh instanceof HTMLImageElement||ImageBitmap&&eh instanceof ImageBitmap){let{width:el,height:ew,data:eT}=F.q.getImageData(eh);this.style.addImage(eb,{data:new F.r({width:el,height:ew},eT),pixelRatio:ec,stretchX:e_,stretchY:eg,content:ey,sdf:ep,version:0,usvg:!1})}else if(void 0===eh.width||void 0===eh.height)this.fire(new F.z(Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{let{width:ew,height:eT}=eh;this.style.addImage(eb,{data:new F.r({width:ew,height:eT},new Uint8Array(eh.data)),pixelRatio:ec,stretchX:e_,stretchY:eg,content:ey,sdf:ep,usvg:!1,version:0,userImage:eh}),eh.onAdd&&eh.onAdd(this,el)}}updateImage(el,eh){this._lazyInitEmptyStyle();let ec=F.I.from(el),ep=this.style.getImage(ec);if(!ep)return void this.fire(new F.z(Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));let e_=eh instanceof HTMLImageElement||ImageBitmap&&eh instanceof ImageBitmap?F.q.getImageData(eh):eh,{width:eg,height:ey,data:eb}=e_;if(void 0===eg||void 0===ey)return void this.fire(new F.z(Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(eg!==(ep.usvg?ep.icon.usvg_tree.width:ep.data.width)||ey!==(ep.usvg?ep.icon.usvg_tree.height:ep.data.height))return void this.fire(new F.z(Error(`The width and height of the updated image (${eg}, ${ey})
                must be that same as the previous version of the image
                (${ep.data.width}, ${ep.data.height})`)));let ew=!(eh instanceof HTMLImageElement||ImageBitmap&&eh instanceof ImageBitmap),eT=!1;ep.usvg?(ep.data=new F.r({width:eg,height:ey},new Uint8Array(eb)),ep.usvg=!1,ep.icon=void 0,eT=!0):ep.data.replace(eb,ew),this.style.updateImage(ec,ep,eT)}hasImage(el){return el?!!this.style&&!!this.style.getImage(F.I.from(el)):(this.fire(new F.z(Error("Missing required image id"))),!1)}removeImage(el){this.style.removeImage(F.I.from(el))}loadImage(el,eh){F.o(this._requestManager.transformRequest(el,F.R.Image),(el,ec)=>{eh(el,ec instanceof HTMLImageElement?F.q.getImageData(ec):ec)})}listImages(){return this.style.listImages().map(F=>F.name)}addModel(F,el){this._lazyInitEmptyStyle(),this.style.addModel(F,el)}hasModel(el){return el?this.style.hasModel(el):(this.fire(new F.z(Error("Missing required model id"))),!1)}removeModel(F){this.style.removeModel(F)}listModels(){return this.style.listModels()}addLayer(F,el){return this._isValidId(F.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(F,el),this._update(!0)):this}getSlot(F){let el=this.getLayer(F);return el&&el.slot||null}setSlot(F,el){return this.style.setSlot(F,el),this.style.mergeLayers(),this._update(!0)}addImport(F,el){return this.style.addImport(F,el),this}updateImport(F,el){return"string"!=typeof el&&el.id!==F?(this.removeImport(F),this.addImport(el)):(this.style.updateImport(F,el),this._update(!0))}removeImport(F){return this.style.removeImport(F),this}moveImport(F,el){return this.style.moveImport(F,el),this._update(!0)}moveLayer(F,el){return this._isValidId(F)?(this.style.moveLayer(F,el),this._update(!0)):this}removeLayer(F){return this._isValidId(F)?(this.style.removeLayer(F),this._update(!0)):this}getLayer(F){if(!this._isValidId(F))return null;let el=this.style.getOwnLayer(F);return el?"custom"===el.type?el.implementation:el.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(F,el,eh){return this._isValidId(F)?(this.style.setLayerZoomRange(F,el,eh),this._update(!0)):this}setFilter(F,el,eh={}){return this._isValidId(F)?(this.style.setFilter(F,el,eh),this._update(!0)):this}getFilter(F){return this._isValidId(F)?this.style.getFilter(F):null}setPaintProperty(F,el,eh,ec={}){return this._isValidId(F)?(this.style.setPaintProperty(F,el,eh,ec),this._update(!0)):this}getPaintProperty(F,el){return this._isValidId(F)?this.style.getPaintProperty(F,el):null}setLayoutProperty(F,el,eh,ec={}){return this._isValidId(F)?(this.style.setLayoutProperty(F,el,eh,ec),this._update(!0)):this}getLayoutProperty(F,el){return this._isValidId(F)?this.style.getLayoutProperty(F,el):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(F){return this.style.setGlyphsUrl(F),this._update(!0)}getSchema(F){return this.style.getSchema(F)}setSchema(F,el){return this.style.setSchema(F,el),this._update(!0)}getConfig(F){return this.style.getConfig(F)}setConfig(F,el){return this.style.setConfig(F,el),this._update(!0)}getConfigProperty(F,el){return this.style.getConfigProperty(F,el)}setConfigProperty(F,el,eh){return this.style.setConfigProperty(F,el,eh),this._update(!0)}getFeaturesetDescriptors(F){return this.style.getFeaturesetDescriptors(F)}setLights(F){if(this._lazyInitEmptyStyle(),F&&1===F.length&&"flat"===F[0].type){let el=F[0];el.properties?this.style.setFlatLight(el.properties,el.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(F),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){let F=this.style.getLights()||[];return 0===F.length&&F.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),F}setLight(F,el={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:F}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(F){return this._lazyInitEmptyStyle(),!F&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(F),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(F){return this._lazyInitEmptyStyle(),this.style.setFog(F),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(F){return this._lazyInitEmptyStyle(),this.style.setSnow(F),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(F){return this._lazyInitEmptyStyle(),this.style.setRain(F),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(F){return this._lazyInitEmptyStyle(),this.style.setColorTheme(F),this._update(!0)}setImportColorTheme(F,el){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(F,el),this._update(!0)}setCamera(F){return this.style.setCamera(F),this._triggerCameraUpdate(F)}_triggerCameraUpdate(F){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===F["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(el){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(F.bO.convert(el),this.transform):0}setFeatureState(F,el){return F.source&&!this._isValidId(F.source)?this:(this.style.setFeatureState(F,el),this._update())}removeFeatureState(F,el){return F.source&&!this._isValidId(F.source)?this:(this.style.removeFeatureState(F,el),this._update())}getFeatureState(F){return F.source&&!this._isValidId(F.source)?null:this.style.getFeatureState(F)}_updateContainerDimensions(){if(!this._container)return;let F=this._container.getBoundingClientRect().width||400,el=this._container.getBoundingClientRect().height||300,eh,ec,ep,e_=this._container;for(;e_&&(!ec||!ep);){let F=window.getComputedStyle(e_).transform;F&&"none"!==F&&((eh=F.match(/matrix.*\((.+)\)/)[1].split(", "))[0]&&"0"!==eh[0]&&"1"!==eh[0]&&(ec=eh[0]),eh[3]&&"0"!==eh[3]&&"1"!==eh[3]&&(ep=eh[3])),e_=e_.parentElement}this._containerWidth=ec?Math.abs(F/ec):F,this._containerHeight=ep?Math.abs(el/ep):el}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&F.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){let F=this._container;F.classList.add("mapboxgl-map"),(this._missingCSSCanary=l("div","mapboxgl-canary",F)).style.visibility="hidden",this._detectMissingCSS();let el=this._canvasContainer=l("div","mapboxgl-canvas-container",F);this._canvas=l("canvas","mapboxgl-canvas",el),this._interactive&&(el.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);let eh=this._controlContainer=l("div","mapboxgl-control-container",F),ec=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(F=>{ec[F]=l("div",`mapboxgl-ctrl-${F}`,eh)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(el,eh){let ec=F.q.devicePixelRatio||1;this._canvas.width=ec*Math.ceil(el),this._canvas.height=ec*Math.ceil(eh),this._canvas.style.width=`${el}px`,this._canvas.style.height=`${eh}px`}_addMarker(F){this._markers.push(F)}_removeMarker(F){let el=this._markers.indexOf(F);-1!==el&&this._markers.splice(el,1)}_addPopup(F){this._popups.push(F)}_removePopup(F){let el=this._popups.indexOf(F);-1!==el&&this._popups.splice(el,1)}_setupPainter(){let el=F.l({},ew.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),eh=this._canvas.getContext("webgl2",el);eh?(V(eh,!0),this.painter=new ea(eh,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",F=>{"source"===F.dataType&&this.painter.setTileLoadedFlag(!0)}),F.m.testSupport(eh)):this.fire(new F.z(Error("Failed to initialize WebGL")))}_contextLost(el){el.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new F.A("webglcontextlost",{originalEvent:el}))}_contextRestored(el){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new F.A("webglcontextrestored",{originalEvent:el}))}_onMapScroll(F){if(F.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(F){return this.style&&(this._styleDirty=this._styleDirty||F,this._sourcesDirty=!0,this.triggerRepaint()),this}_requestRenderFrame(F){return this._update(),this._renderTaskQueue.add(F)}_cancelRenderFrame(F){this._renderTaskQueue.remove(F)}_requestDomTask(F){!this.loaded()||this.loaded()&&!this.isMoving()?F():this._domRenderTaskQueue.add(F)}_render(el){let eh;this.fire(new F.A("renderstart")),++this._frameId;let ec=this.painter.context.extTimerQuery,ep=F.q.now(),ey=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(eh=ey.createQuery(),ey.beginQuery(ec.TIME_ELAPSED_EXT,eh)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(el),this._domRenderTaskQueue.run(el),this._removed)return;this._updateProjectionTransition();let eb=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;let el=this.transform.zoom,eh=this.transform.pitch,ec=F.q.now(),ep=new F.aa(el,{now:ec,fadeDuration:eb,pitch:eh,transition:this.style.transition});this.style.update(ep)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let ew=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),ew=this._updateAverageElevation(ep),this.style.updateSources(this.transform),this.isMoving()||this._forceMarkerAndPopupUpdate()):ew=this._updateAverageElevation(ep);let eT=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,eb,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),eT&&(this._placementDirty=eT.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:eb,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new F.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,eg.mark(e_.load),this.fire(new F.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),eh){let el=F.q.now()-ep;ey.endQuery(ec.TIME_ELAPSED_EXT),setTimeout(()=>{let ec=ey.getQueryParameter(eh,ey.QUERY_RESULT)/1e6;ey.deleteQuery(eh),this.fire(new F.A("gpu-timing-frame",{cpuTime:el,gpuTime:ec}))},50)}if(this.listens("gpu-timing-layer")){let el=this.painter.collectGpuTimers();setTimeout(()=>{let eh=this.painter.queryGpuTimers(el);this.fire(new F.A("gpu-timing-layer",{layerTimes:eh}))},50)}if(this.listens("gpu-timing-deferred-render")){let el=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{let eh=this.painter.queryGpuTimeDeferredRender(el);this.fire(new F.A("gpu-timing-deferred-render",{gpuTime:eh}))},50)}let eS=this._sourcesDirty||this._styleDirty||this._placementDirty||ew;if(eS||this._repaint)this.triggerRepaint();else{let el=this.idle();if(el&&(ew=this._updateAverageElevation(ep,!0)),ew)this.triggerRepaint();else if(this._triggerFrame(!1),el&&(this.fire(new F.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){let el=this._calculateSpeedIndex();this.fire(new F.A("speedindexcompleted",{speedIndex:el})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||eS||(this._fullyLoaded=!0,eg.mark(e_.fullLoad),this._performanceMetricsCollection&&eO(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(F){for(let el of this._markers)F&&!this.getRenderWorldCopies()&&(el._lngLat=el._lngLat.wrap()),el._update();for(let el of this._popups)!F||this.getRenderWorldCopies()||el._trackPointer||(el._lngLat=el._lngLat.wrap()),el._update()}_updateAverageElevation(F,el=!1){let i=F=>(this.transform.averageElevation=F,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);let eh=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(eh||(el||F-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(F)){let el=this.transform.averageElevation,ec=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(ec)?ec=0:this._averageElevationLastSampledAt=F;let ep=Math.abs(el-ec);if(ep>1){if(this._isInitialLoad||eh)return this._averageElevation.jumpTo(ec),i(ec);this._averageElevation.easeTo(ec,F,300)}else if(ep>1e-4)return this._averageElevation.jumpTo(ec),i(ec)}return!!this._averageElevation.isEasing(F)&&i(this._averageElevation.getValue(F))}_authenticate(){eF(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,el=>{if(el&&(el.message===eE||401===el.status)){let el=this.painter.context.gl;V(el,!1),this._logoControl instanceof ol&&this._logoControl._updateLogo(),el&&el.clear(el.DEPTH_BUFFER_BIT|el.COLOR_BUFFER_BIT|el.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new F.z(Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),ez(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&eR(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){let F=this._isDragging();this.painter.updateTerrain(this.style,F)}_calculateSpeedIndex(){let F=this.painter.canvasCopy(),el=this.painter.getCanvasCopiesAndTimestamps();el.timeStamps.push(performance.now());let eh=this.painter.context.gl,ec=eh.createFramebuffer();function s(F){eh.framebufferTexture2D(eh.FRAMEBUFFER,eh.COLOR_ATTACHMENT0,eh.TEXTURE_2D,F,0);let el=new Uint8Array(eh.drawingBufferWidth*eh.drawingBufferHeight*4);return eh.readPixels(0,0,eh.drawingBufferWidth,eh.drawingBufferHeight,eh.RGBA,eh.UNSIGNED_BYTE,el),el}return eh.bindFramebuffer(eh.FRAMEBUFFER,ec),this._canvasPixelComparison(s(F),el.canvasCopies.map(s),el.timeStamps)}_canvasPixelComparison(F,el,eh){let ec=eh[1]-eh[0],ep=F.length/4;for(let e_=0;e_<el.length;e_++){let eg=el[e_],ey=0;for(let el=0;el<eg.length;el+=4)eg[el]===F[el]&&eg[el+1]===F[el+1]&&eg[el+2]===F[el+2]&&eg[el+3]===F[el+3]&&(ey+=1);ec+=(eh[e_+2]-eh[e_+1])*(1-ey/ep)}return ec}remove(){for(let F of(this._hash&&this._hash.remove(),this._controls))F.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);let el=this.painter.context.gl.getExtension("WEBGL_lose_context");el&&el.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),eB.delete(this.painter.context.gl),ek.remove(),eP.remove(),this._removed=!0,this.fire(new F.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(el){this._renderNextFrame=this._renderNextFrame||el,this.style&&!this._frame&&(this._frame=F.q.frame(F=>{let el=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,el&&this._render(F)}))}_preloadTiles(el){let eh=this.style?this.style.getSourceCaches():[];return F.bl(eh,(F,eh)=>F._preloadTiles(el,eh),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(F){this._trackResize&&this.resize({originalEvent:F})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(F){this._showTileBoundaries!==F&&(this._showTileBoundaries=F,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(F){this._showParseStatus!==F&&(this._showParseStatus=F,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(F){this._showTerrainWireframe!==F&&(this._showTerrainWireframe=F,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(F){this._showLayers2DWireframe!==F&&(this._showLayers2DWireframe=F,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(F){this._showLayers3DWireframe!==F&&(this._showLayers3DWireframe=F,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(F){this._speedIndexTiming!==F&&(this._speedIndexTiming=F,this._update())}get showPadding(){return!!this._showPadding}set showPadding(F){this._showPadding!==F&&(this._showPadding=F,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(F){this._showCollisionBoxes!==F&&(this._showCollisionBoxes=F,this._tp.refreshUI(),F?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(F){this._showOverdrawInspector!==F&&(this._showOverdrawInspector=F,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(F){this._repaint!==F&&(this._repaint=F,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(F){this._vertices=F,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(F){this._showTileAABBs!==F&&(this._showTileAABBs=F,this._tp.refreshUI(),F&&this._update())}_setCacheLimits(el,eh){F.dJ(el,eh)}get version(){return ep}},NavigationControl:class{constructor(el={}){this.options=F.l({},iA,el),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",F=>F.preventDefault()),this.options.showZoom&&(F.aQ(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",F=>{this._map&&this._map.zoomIn({},{originalEvent:F})}),l("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",F=>{this._map&&this._map.zoomOut({},{originalEvent:F})}),l("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(F.aQ(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",F=>{let el=this._map;el&&(this.options.visualizePitch?el.resetNorthPitch({},{originalEvent:F}):el.resetNorth({},{originalEvent:F}))}),this._compassIcon=l("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){let F=this._map;if(!F)return;let el=F.getZoom(),eh=el===F.getMaxZoom(),ec=el===F.getMinZoom();this._zoomInButton.disabled=eh,this._zoomOutButton.disabled=ec,this._zoomInButton.setAttribute("aria-disabled",eh.toString()),this._zoomOutButton.setAttribute("aria-disabled",ec.toString())}_rotateCompassArrow(){let F=this._map;if(!F)return;let el=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(F.transform.pitch*(Math.PI/180)),.5)}) rotateX(${F.transform.pitch}deg) rotateZ(${F.transform.angle*(180/Math.PI)}deg)`:`rotate(${F.transform.angle*(180/Math.PI)}deg)`;F._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=el)})}onAdd(F){return this._map=F,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),F.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&F.on("pitch",this._rotateCompassArrow),F.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new ul(F,this._compass,this.options.visualizePitch)),this._container}onRemove(){let F=this._map;F&&(this._container.remove(),this.options.showZoom&&F.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&F.off("pitch",this._rotateCompassArrow),F.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(F,el){let eh=l("button",F,this._container);return eh.type="button",eh.addEventListener("click",el),eh}_setButtonTitle(F,el){if(!this._map)return;let eh=this._map._getUIString(`NavigationControl.${el}`);F.setAttribute("aria-label",eh),F.firstElementChild&&F.firstElementChild.setAttribute("title",eh)}},GeolocateControl:class extends F.E{constructor(el={}){super();let eh=navigator.geolocation;this.options=F.l({geolocation:eh},iz,el),F.aQ(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=ta(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(F){return this._map=F,this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(F){let t=(el=!!this.options.geolocation)=>{this._supportsGeolocation=el,F(el)};void 0!==this._supportsGeolocation?F(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then(F=>t("denied"!==F.state)).catch(()=>t()):t()}_isOutOfMapMaxBounds(F){let el=this._map.getMaxBounds(),eh=F.coords;return!!el&&(eh.longitude<el.getWest()||eh.longitude>el.getEast()||eh.latitude<el.getSouth()||eh.latitude>el.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(el){if(this._map){if(this._isOutOfMapMaxBounds(el))return this._setErrorState(),this.fire(new F.A("outofmaxbounds",el)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=el,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(el),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(el),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.A("geolocate",el)),this._finish()}}_updateCamera(el){let eh=new F.bO(el.coords.longitude,el.coords.latitude),ec=el.coords.accuracy,ep=this._map.getBearing(),e_=F.l({bearing:ep},this.options.fitBoundsOptions);this._map.fitBounds(eh.toBounds(ec),e_,{geolocateSource:!0})}_updateMarker(el){if(el){let eh=new F.bO(el.coords.longitude,el.coords.latitude);this._accuracyCircleMarker.setLngLat(eh).addTo(this._map),this._userLocationDotMarker.setLngLat(eh).addTo(this._map),this._accuracy=el.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){let el=this._map.transform,eh=F.bH(1,el._center.lat)*el.worldSize,ec=Math.ceil(2*this._accuracy*eh);this._circleElement.style.width=`${ec}px`,this._circleElement.style.height=`${ec}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(el){if(this._map){if(this.options.trackUserLocation){if(1===el.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;let F=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===el.code&&this._noTimeout)return;this._setErrorState()}}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new F.A("error",el)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(el){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",F=>F.preventDefault()),this._geolocateButton=l("button","mapboxgl-ctrl-geolocate",this._container),l("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===el){F.w("Geolocation support is not available so the GeolocateControl will be disabled.");let el=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",el),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",el)}else{let F=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",F),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",F)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=l("div","mapboxgl-user-location"),this._dotElement.appendChild(l("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(l("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new ml({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=l("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new ml({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",el=>{el.geolocateSource||"ACTIVE_LOCK"!==this._watchState||el.originalEvent&&"resize"===el.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new F.A("trackuserlocationend")))})}}_onDeviceOrientation(F){this._userLocationDotMarker&&(F.webkitCompassHeading?this._heading=F.webkitCompassHeading:!0===F.absolute&&(this._heading=-1*F.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return F.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new F.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new F.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new F.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let F;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(F={maximumAge:6e5,timeout:0},this._noTimeout=!0):(F=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,F),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){let e=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};"undefined"!=typeof DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(F=>{"granted"===F&&e()}).catch(console.error):e()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:il,ScaleControl:class{constructor(el={}){this.options=F.l({},iD,el),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch(F){return!1}}(),F.aQ(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){let F=this.options.maxWidth||100,el=this._map,eh=el._containerHeight/2,ec=el._containerWidth/2-F/2,ep=el.unproject([ec,eh]),e_=el.unproject([ec+F,eh]),eg=ep.distanceTo(e_);if("imperial"===this.options.unit){let el=3.2808*eg;el>5280?this._setScale(F,el/5280,"mile"):this._setScale(F,el,"foot")}else"nautical"===this.options.unit?this._setScale(F,eg/1852,"nautical-mile"):eg>=1e3?this._setScale(F,eg/1e3,"kilometer"):this._setScale(F,eg,"meter")}_setScale(F,el,eh){this._map._requestDomTask(()=>{let ec=function(F){let el=Math.pow(10,`${Math.floor(F)}`.length-1),eh=F/el;return el*(eh=eh>=10?10:eh>=5?5:eh>=3?3:eh>=2?2:eh>=1?1:function(F){let el=Math.pow(10,Math.ceil(-Math.log(F)/Math.LN10));return Math.round(F*el)/el}(eh))}(el),ep=ec/el;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==eh?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:eh}).format(ec):`${ec}&nbsp;${iR[eh]}`,this._container.style.width=F*ep+"px"})}onAdd(F){return this._map=F,this._language=F.getLanguage(),this._container=l("div","mapboxgl-ctrl mapboxgl-ctrl-scale",F.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(F){this._language=F,this._update()}setUnit(F){this.options.unit=F,this._update()}},FullscreenControl:class{constructor(el={}){this._fullscreen=!1,el&&el.container&&(el.container instanceof HTMLElement?this._container=el.container:F.w("Full screen control 'container' must be a DOM element.")),F.aQ(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(el){return this._map=el,this._container||(this._container=this._map.getContainer()),this._controlContainer=l("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",F.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){let F=this._fullscreenButton=l("button","mapboxgl-ctrl-fullscreen",this._controlContainer);l("span","mapboxgl-ctrl-icon",F).setAttribute("aria-hidden","true"),F.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){let F=this._getTitle();this._fullscreenButton.setAttribute("aria-label",F),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",F)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends F.E{constructor(el){super(),this.options=F.l(Object.create(iL),el),this._altitude=this.options.altitude,F.aQ(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(el&&el.className?el.className.trim().split(/\s+/):[])}addTo(el){return this._map&&this.remove(),this._map=el,this.options.closeOnClick&&el.on("preclick",this._onClose),this.options.closeOnMove&&el.on("move",this._onClose),el.on("remove",this.remove),this._update(),el._addPopup(this),this._focusFirstElement(),this._trackPointer?(el.on("mousemove",this._onMouseEvent),el.on("mouseup",this._onMouseEvent),el._canvasContainer.classList.add("mapboxgl-track-pointer")):el.on("move",this._update),this.fire(new F.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);let el=this._map;return el&&(el.off("move",this._update),el.off("move",this._onClose),el.off("preclick",this._onClose),el.off("click",this._onClose),el.off("remove",this.remove),el.off("mousemove",this._onMouseEvent),el.off("mouseup",this._onMouseEvent),el.off("drag",this._onMouseEvent),el._canvasContainer&&el._canvasContainer.classList.remove("mapboxgl-track-pointer"),el._removePopup(this),this._map=void 0),this.fire(new F.A("close")),this}getLngLat(){return this._lngLat}setLngLat(el){this._lngLat=F.bO.convert(el),this._pos=null,this._trackPointer=!1,this._update();let eh=this._map;return eh&&(eh.on("move",this._update),eh.off("mousemove",this._onMouseEvent),eh._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(F){return this._altitude=F,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();let F=this._map;return F&&(F.off("move",this._update),F.on("mousemove",this._onMouseEvent),F.on("drag",this._onMouseEvent),F._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(F){return this.setDOMContent(document.createTextNode(F))}setHTML(F){let el;let eh=document.createDocumentFragment(),ec=document.createElement("body");for(ec.innerHTML=F;el=ec.firstChild;)eh.appendChild(el);return this.setDOMContent(eh)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(F){return this.options.maxWidth=F,this._update(),this}setDOMContent(F){let el=this._content;if(el)for(;el.hasChildNodes();)el.firstChild&&el.removeChild(el.firstChild);else el=this._content=l("div","mapboxgl-popup-content",this._container||void 0);if(el.appendChild(F),this.options.closeButton){let F=this._closeButton=l("button","mapboxgl-popup-close-button",el);F.type="button",F.setAttribute("aria-label","Close popup"),F.innerHTML='<span aria-hidden="true">&#215;</span>',F.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(F){return this._classList.add(F),this._updateClassList(),this}removeClassName(F){return this._classList.delete(F),this._updateClassList(),this}setOffset(F){return this.options.offset=F,this._update(),this}toggleClassName(F){let el;return this._classList.delete(F)?el=!1:(this._classList.add(F),el=!0),this._updateClassList(),el}_onMouseEvent(F){this._update(F.point)}_getAnchor(F){if(this.options.anchor)return this.options.anchor;let el=this._map,eh=this._container,ec=this._pos;if(!el||!eh||!ec)return"bottom";let ep=eh.offsetWidth,e_=eh.offsetHeight,eg=ec.x<ep/2,ey=ec.x>el.transform.width-ep/2;if(ec.y+F<e_)return eg?"top-left":ey?"top-right":"top";if(ec.y>el.transform.height-e_){if(eg)return"bottom-left";if(ey)return"bottom-right"}return eg?"left":ey?"right":"bottom"}_updateClassList(){let F=this._container;if(!F)return;let el=[...this._classList];el.push("mapboxgl-popup"),this._anchor&&el.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&el.push("mapboxgl-popup-track-pointer"),F.className=el.join(" ")}_update(el){let eh=this._map,ec=this._content;if(!eh||!this._lngLat&&!this._trackPointer||!ec)return;let ep=this._container;if(ep||(ep=this._container=l("div","mapboxgl-popup",eh.getContainer()),this._tip=l("div","mapboxgl-popup-tip",ep),ep.appendChild(ec)),this.options.maxWidth&&ep.style.maxWidth!==this.options.maxWidth&&(ep.style.maxWidth=this.options.maxWidth),eh.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=_l(this._lngLat,this._pos,eh.transform)),!this._trackPointer||el){let ec=this._pos=this._trackPointer&&el instanceof F.P?el:eh.project(this._lngLat,this._altitude),ep=wl(this.options.offset),e_=this._anchor=this._getAnchor(ep.y),eg=wl(this.options.offset,e_),ey=ec.add(eg).round();eh._requestDomTask(()=>{this._container&&e_&&(this._container.style.transform=`${iC[e_]} translate(${ey.x}px,${ey.y}px)`)})}if(!this._marker&&eh._showingGlobe()){let el=F.dK(eh.transform,this._lngLat)?0:1;this._setOpacity(el)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;let F=this._container.querySelector("a[href], [tabindex]:not([tabindex='-1']), [contenteditable]:not([contenteditable='false']), button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled])");F&&F.focus()}_onClose(){this.remove()}_setOpacity(F){this._container&&(this._container.style.opacity=`${F}`),this._content&&(this._content.style.pointerEvents=F?"auto":"none")}},Marker:ml,Style:To,LngLat:F.bO,LngLatBounds:F.aB,Point:F.P,MercatorCoordinate:F.ac,FreeCameraOptions:Wi,Evented:F.E,config:F.e,prewarm:F.dP,clearPrewarmedResources:F.dQ,get accessToken(){return F.e.ACCESS_TOKEN},set accessToken(t){F.e.ACCESS_TOKEN=t},get baseApiUrl(){return F.e.API_URL},set baseApiUrl(t){F.e.API_URL=t},get workerCount(){return F.dR.workerCount},set workerCount(t){F.dR.workerCount=t},get maxParallelImageRequests(){return F.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(t){F.e.MAX_PARALLEL_IMAGE_REQUESTS=t},clearStorage(el){F.dS(el)},get workerUrl(){return F.dT.workerUrl},set workerUrl(t){F.dT.workerUrl=t},get workerClass(){return F.dT.workerClass},set workerClass(t){F.dT.workerClass=t},get workerParams(){return F.dT.workerParams},set workerParams(t){F.dT.workerParams=t},get dracoUrl(){return F.dU()},set dracoUrl(t){F.dV(t)},get meshoptUrl(){return F.dW()},set meshoptUrl(t){F.dX(t)},setNow:F.q.setNow,restoreNow:F.q.restoreNow};return iO}),eh}()}}]);